(function(Y,X){typeof exports=="object"&&typeof module<"u"?X(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","react"],X):(Y=typeof globalThis<"u"?globalThis:Y||self,X(Y.__fop__,Y.__foo__,Y.React))})(this,function(plugins,operators,React){"use strict";var Hi=Object.defineProperty;var ui=Y=>{throw TypeError(Y)};var Ui=(Y,X,Z)=>X in Y?Hi(Y,X,{enumerable:!0,configurable:!0,writable:!0,value:Z}):Y[X]=Z;var d=(Y,X,Z)=>Ui(Y,typeof X!="symbol"?X+"":X,Z),Ke=(Y,X,Z)=>X.has(Y)||ui("Cannot "+Z);var I=(Y,X,Z)=>(Ke(Y,X,"read from private field"),Z?Z.call(Y):X.get(Y)),P=(Y,X,Z)=>X.has(Y)?ui("Cannot add the same private member more than once"):X instanceof WeakSet?X.add(Y):X.set(Y,Z),U=(Y,X,Z,kt)=>(Ke(Y,X,"write to private field"),kt?kt.call(Y,Z):X.set(Y,Z),Z),N=(Y,X,Z)=>(Ke(Y,X,"access private method"),Z);var pi=(Y,X,Z,kt)=>({set _(It){U(Y,X,It,Z)},get _(){return I(Y,X,kt)}});var Y,Z,kt,Re,fi,oe,Ht,nt,pt,ut,Tt,qe,re,Dt,Gt,Ze,Ut,ae,$t,Xt,Yt,jt,le,de,Kt,he,Zt,gi,_i,ce,ue,pe,fe,_t,Je,Qe,ti,Ct,At,ge,_e,K,mi,yi,ei,Ne,ii,si,$e,vi,bi,wi,ki,Li,Si,Qt,me,et,ni,oi,gt,Ft,ye,te,ht,ri,Xe,Ii,ai,Ge,Ei,Ae,Fe,xe,Nt,St,Pe,We,Me,xt,F,Ye,Ot,ve,yt,ct,be,Pt,Ti,wt,Bt,Ci,Ni,li,Oi,Ri,Di,Gi,Ai,zt,Vt,Fi,xi,Pi,Wi,Mi,Bi,ne,Oe,Wt,Mt,Be,ze,zi,we,ke,Le,di,Se,He,Ie,Ee,Ue,Vi,Te,Rt,hi,ci;function _interopNamespaceDefault(u){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(u){for(const i in u)if(i!=="default"){const s=Object.getOwnPropertyDescriptor(u,i);Object.defineProperty(t,i,s.get?s:{enumerable:!0,get:()=>u[i]})}}return t.default=u,Object.freeze(t)}const React__namespace=_interopNamespaceDefault(React);class CustomEventTarget extends EventTarget{dispatch(t,i){const s=new CustomEvent(t,{detail:i,cancelable:!0});return super.dispatchEvent(s)}addEventListener(t,i,s){super.addEventListener(t,i,s)}removeEventListener(t,i,s){super.removeEventListener(t,i,s)}dispatchEvent(t){return super.dispatchEvent(t)}}const SUBGRAPH_INPUT_ID=-10,SUBGRAPH_OUTPUT_ID=-20,zeroUuid="00000000-0000-0000-0000-000000000000",randomStorage=new Uint32Array(31);function createUuidv4(){if(typeof(crypto==null?void 0:crypto.randomUUID)=="function")return crypto.randomUUID();if(typeof(crypto==null?void 0:crypto.getRandomValues)=="function"){const u=crypto.getRandomValues(randomStorage);let t=0;return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,i=>(Number(i)^u[t++]*3725290298461914e-24>>Number(i)*.25).toString(16))}return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,u=>(Number(u)^Math.random()*16>>Number(u)*.25).toString(16))}const X=class X{constructor(t,i,s,n,o,r,a){d(this,"id");d(this,"parentId");d(this,"type");d(this,"origin_id");d(this,"origin_slot");d(this,"target_id");d(this,"target_slot");d(this,"data");d(this,"_data");d(this,"_pos");d(this,"_last_time");d(this,"path");d(this,"_centreAngle");d(this,"_dragging");P(this,Y);this.id=t,this.type=i,this.origin_id=s,this.origin_slot=n,this.target_id=o,this.target_slot=r,this.parentId=a,this._data=null,this._pos=new Float32Array(2)}get color(){return I(this,Y)}set color(t){U(this,Y,t===""?null:t)}get isFloatingOutput(){return this.origin_id===-1&&this.origin_slot===-1}get isFloatingInput(){return this.target_id===-1&&this.target_slot===-1}get isFloating(){return this.isFloatingOutput||this.isFloatingInput}get originIsIoNode(){return this.origin_id===SUBGRAPH_INPUT_ID}get targetIsIoNode(){return this.target_id===SUBGRAPH_OUTPUT_ID}static createFromArray(t){return new X(t[0],t[5],t[1],t[2],t[3],t[4])}static create(t){return new X(t.id,t.type,t.origin_id,t.origin_slot,t.target_id,t.target_slot,t.parentId)}static getReroutes(t,i){var s;return i.parentId?((s=t.reroutes.get(i.parentId))==null?void 0:s.getReroutes())??[]:[]}static getFirstReroute(t,i){return X.getReroutes(t,i).at(0)}static findNextReroute(t,i,s){var n;if(i.parentId)return(n=t.reroutes.get(i.parentId))==null?void 0:n.findNextReroute(s)}static getOriginNode(t,i){var n;const s=(n=t.links.get(i))==null?void 0:n.origin_id;return t.getNodeById(s)??void 0}static getTargetNode(t,i){var n;const s=(n=t.links.get(i))==null?void 0:n.target_id;return t.getNodeById(s)??void 0}static resolve(t,i){var s;return(s=i.getLink(t))==null?void 0:s.resolve(i)}static resolveMany(t,i){var n;const s=[];for(const o of t){const r=(n=i.getLink(o))==null?void 0:n.resolve(i);r&&s.push(r)}return s}resolve(t){var l,h;const i=this.target_id===-1?void 0:t.getNodeById(this.target_id)??void 0,s=i==null?void 0:i.inputs[this.target_slot],n=this.originIsIoNode?(l=t.inputNode)==null?void 0:l.slots[this.origin_slot]:void 0;if(n)return{inputNode:i,input:s,subgraphInput:n,link:this};const o=this.origin_id===-1?void 0:t.getNodeById(this.origin_id)??void 0,r=o==null?void 0:o.outputs[this.origin_slot],a=this.targetIsIoNode?(h=t.outputNode)==null?void 0:h.slots[this.target_slot]:void 0;return a?{outputNode:o,output:r,subgraphInput:void 0,subgraphOutput:a,link:this}:{inputNode:i,outputNode:o,input:s,output:r,subgraphInput:n,subgraphOutput:a,link:this}}configure(t){Array.isArray(t)?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot,this.parentId=t.parentId)}hasOrigin(t,i){return this.origin_id===t&&this.origin_slot===i}hasTarget(t,i){return this.target_id===t&&this.target_slot===i}toFloating(t,i){const s=this.asSerialisable();return s.id=-1,s.parentId=i,t==="input"?(s.origin_id=-1,s.origin_slot=-1):(s.target_id=-1,s.target_slot=-1),X.create(s)}disconnect(t,i){const s=X.getReroutes(t,this),n=s.at(-1);if(i==="output"&&(n==null?void 0:n.linkIds.size)===1&&n.floatingLinkIds.size===0||i==="input"&&n){const r=X.create(this);r.id=-1,i==="input"?(r.origin_id=-1,r.origin_slot=-1,n.floating={slotType:"input"}):(r.target_id=-1,r.target_slot=-1,n.floating={slotType:"output"}),t.addFloatingLink(r)}for(const r of s)r.linkIds.delete(this.id),!i&&!r.totalLinks&&t.reroutes.delete(r.id);if(t.links.delete(this.id),this.originIsIoNode&&t instanceof Subgraph){const r=t.inputs.at(this.origin_slot);if(!r)throw new Error("Invalid link - subgraph input not found");r.events.dispatch("input-disconnected",{input:r})}}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}asSerialisable(){const t={id:this.id,origin_id:this.origin_id,origin_slot:this.origin_slot,target_id:this.target_id,target_slot:this.target_slot,type:this.type};return this.parentId&&(t.parentId=this.parentId),t}};Y=new WeakMap,d(X,"_drawDebug",!1);let LLink=X;var NodeSlotType=(u=>(u[u.INPUT=1]="INPUT",u[u.OUTPUT=2]="OUTPUT",u))(NodeSlotType||{}),RenderShape=(u=>(u[u.BOX=1]="BOX",u[u.ROUND=2]="ROUND",u[u.CIRCLE=3]="CIRCLE",u[u.CARD=4]="CARD",u[u.ARROW=5]="ARROW",u[u.GRID=6]="GRID",u[u.HollowCircle=7]="HollowCircle",u))(RenderShape||{}),CanvasItem=(u=>(u[u.Nothing=0]="Nothing",u[u.Node=1]="Node",u[u.Group=2]="Group",u[u.Reroute=4]="Reroute",u[u.Link=8]="Link",u[u.RerouteSlot=32]="RerouteSlot",u[u.SubgraphIoNode=64]="SubgraphIoNode",u[u.SubgraphIoSlot=128]="SubgraphIoSlot",u))(CanvasItem||{}),LinkDirection=(u=>(u[u.NONE=0]="NONE",u[u.UP=1]="UP",u[u.DOWN=2]="DOWN",u[u.LEFT=3]="LEFT",u[u.RIGHT=4]="RIGHT",u[u.CENTER=5]="CENTER",u))(LinkDirection||{}),LinkRenderType=(u=>(u[u.HIDDEN_LINK=-1]="HIDDEN_LINK",u[u.STRAIGHT_LINK=0]="STRAIGHT_LINK",u[u.LINEAR_LINK=1]="LINEAR_LINK",u[u.SPLINE_LINK=2]="SPLINE_LINK",u))(LinkRenderType||{}),LinkMarkerShape=(u=>(u[u.None=0]="None",u[u.Circle=1]="Circle",u[u.Arrow=2]="Arrow",u))(LinkMarkerShape||{}),TitleMode=(u=>(u[u.NORMAL_TITLE=0]="NORMAL_TITLE",u[u.NO_TITLE=1]="NO_TITLE",u[u.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",u[u.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",u))(TitleMode||{}),LGraphEventMode=(u=>(u[u.ALWAYS=0]="ALWAYS",u[u.ON_EVENT=1]="ON_EVENT",u[u.NEVER=2]="NEVER",u[u.ON_TRIGGER=3]="ON_TRIGGER",u[u.BYPASS=4]="BYPASS",u))(LGraphEventMode||{}),EaseFunction=(u=>(u.LINEAR="linear",u.EASE_IN_QUAD="easeInQuad",u.EASE_OUT_QUAD="easeOutQuad",u.EASE_IN_OUT_QUAD="easeInOutQuad",u))(EaseFunction||{}),Alignment=(u=>(u[u.None=0]="None",u[u.Top=1]="Top",u[u.Bottom=2]="Bottom",u[u.Middle=4]="Middle",u[u.Left=8]="Left",u[u.Right=16]="Right",u[u.Centre=32]="Centre",u[u.TopLeft=9]="TopLeft",u[u.TopCentre=33]="TopCentre",u[u.TopRight=17]="TopRight",u[u.MidLeft=12]="MidLeft",u[u.MidCentre=36]="MidCentre",u[u.MidRight=20]="MidRight",u[u.BottomLeft=10]="BottomLeft",u[u.BottomCentre=34]="BottomCentre",u[u.BottomRight=18]="BottomRight",u))(Alignment||{});function hasFlag(u,t){return(u&t)===t}function distance(u,t){return Math.sqrt((t[0]-u[0])*(t[0]-u[0])+(t[1]-u[1])*(t[1]-u[1]))}function dist2(u,t,i,s){return(i-u)*(i-u)+(s-t)*(s-t)}function isInRectangle(u,t,i,s,n,o){return u>=i&&u<i+n&&t>=s&&t<s+o}function isPointInRect(u,t){return u[0]>=t[0]&&u[0]<t[0]+t[2]&&u[1]>=t[1]&&u[1]<t[1]+t[3]}function isInRect(u,t,i){return u>=i[0]&&u<i[0]+i[2]&&t>=i[1]&&t<i[1]+i[3]}function isInsideRectangle(u,t,i,s,n,o){return i<u&&i+n>u&&s<t&&s+o>t}function overlapBounding(u,t){const i=u[0]+u[2],s=u[1]+u[3],n=t[0]+t[2],o=t[1]+t[3];return!(u[0]>n||u[1]>o||i<t[0]||s<t[1])}function getCentre(u){return[u[0]+u[2]*.5,u[1]+u[3]*.5]}function containsCentre(u,t){const i=t[0]+t[2]*.5,s=t[1]+t[3]*.5;return isInRect(i,s,u)}function containsRect(u,t){const i=u[0]+u[2],s=u[1]+u[3],n=t[0]+t[2],o=t[1]+t[3];return!(u[0]===t[0]&&u[1]===t[1]&&i===n&&s===o)&&u[0]<=t[0]&&u[1]<=t[1]&&i>=n&&s>=o}function findPointOnCurve(u,t,i,s,n,o=.5){const r=1-o,a=r*r*r,l=3*(r*r)*o,h=3*r*(o*o),c=o*o*o;u[0]=a*t[0]+l*s[0]+h*n[0]+c*i[0],u[1]=a*t[1]+l*s[1]+h*n[1]+c*i[1]}function createBounds(u,t=10){const i=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const s of u){const n=s.boundingRect;i[0]=Math.min(i[0],n[0]),i[1]=Math.min(i[1],n[1]),i[2]=Math.max(i[2],n[0]+n[2]),i[3]=Math.max(i[3],n[1]+n[3])}return i.every(s=>isFinite(s))?[i[0]-t,i[1]-t,i[2]-i[0]+2*t,i[3]-i[1]+2*t]:null}function snapPoint(u,t){return t?(u[0]=t*Math.round(u[0]/t),u[1]=t*Math.round(u[1]/t),!0):!1}function alignToContainer(u,t,[i,s,n,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?u[0]=i+r:hasFlag(t,Alignment.Right)?u[0]=i+n-r-u[2]:hasFlag(t,Alignment.Centre)&&(u[0]=i+n*.5-u[2]*.5),hasFlag(t,Alignment.Top)?u[1]=s+a:hasFlag(t,Alignment.Bottom)?u[1]=s+o-a-u[3]:hasFlag(t,Alignment.Middle)&&(u[1]=s+o*.5-u[3]*.5),u}function alignOutsideContainer(u,t,[i,s,n,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?u[0]=i-r-u[2]:hasFlag(t,Alignment.Right)?u[0]=i+n+r:hasFlag(t,Alignment.Centre)&&(u[0]=i+n*.5-u[2]*.5),hasFlag(t,Alignment.Top)?u[1]=s-a-u[3]:hasFlag(t,Alignment.Bottom)?u[1]=s+o+a:hasFlag(t,Alignment.Middle)&&(u[1]=s+o*.5-u[3]*.5),u}function clamp(u,t,i){return u<t?t:u>i?i:u}const It=class It extends Float64Array{constructor(i=0,s=0,n=0,o=0){super(4);P(this,Z);P(this,kt);this[0]=i,this[1]=s,this[2]=n,this[3]=o}static from([i,s,n,o]){return new It(i,s,n,o)}static fromCentre([i,s],n,o=n){const r=i-n*.5,a=s-o*.5;return new It(r,a,n,o)}static ensureRect(i){return i instanceof It?i:new It(i[0],i[1],i[2],i[3])}subarray(i=0,s){const n=i<<3,o=s===void 0?s:s-i;return new Float64Array(this.buffer,n,o)}get pos(){return I(this,Z)??U(this,Z,this.subarray(0,2)),I(this,Z)}set pos(i){this[0]=i[0],this[1]=i[1]}get size(){return I(this,kt)??U(this,kt,this.subarray(2,4)),I(this,kt)}set size(i){this[2]=i[0],this[3]=i[1]}get x(){return this[0]}set x(i){this[0]=i}get y(){return this[1]}set y(i){this[1]=i}get width(){return this[2]}set width(i){this[2]=i}get height(){return this[3]}set height(i){this[3]=i}get left(){return this[0]}set left(i){this[0]=i}get top(){return this[1]}set top(i){this[1]=i}get right(){return this[0]+this[2]}set right(i){this[0]=i-this[2]}get bottom(){return this[1]+this[3]}set bottom(i){this[1]=i-this[3]}get centreX(){return this[0]+this[2]*.5}get centreY(){return this[1]+this[3]*.5}updateTo(i){this[0]=i[0],this[1]=i[1],this[2]=i[2],this[3]=i[3]}containsXy(i,s){const[n,o,r,a]=this;return i>=n&&i<n+r&&s>=o&&s<o+a}containsPoint([i,s]){const[n,o,r,a]=this;return i>=n&&i<n+r&&s>=o&&s<o+a}containsRect(i){const{right:s,bottom:n}=this,o=i[0]+i[2],r=i[1]+i[3];return!(this.x===i[0]&&this.y===i[1]&&s===o&&n===r)&&this.x<=i[0]&&this.y<=i[1]&&s>=o&&n>=r}overlaps(i){return this.x<i[0]+i[2]&&this.y<i[1]+i[3]&&this.x+this.width>i[0]&&this.y+this.height>i[1]}findContainingCorner(i,s,n){if(this.isInTopLeftCorner(i,s,n))return"NW";if(this.isInTopRightCorner(i,s,n))return"NE";if(this.isInBottomLeftCorner(i,s,n))return"SW";if(this.isInBottomRightCorner(i,s,n))return"SE"}isInTopLeftCorner(i,s,n){return isInRectangle(i,s,this.x,this.y,n,n)}isInTopRightCorner(i,s,n){return isInRectangle(i,s,this.right-n,this.y,n,n)}isInBottomLeftCorner(i,s,n){return isInRectangle(i,s,this.x,this.bottom-n,n,n)}isInBottomRightCorner(i,s,n){return isInRectangle(i,s,this.right-n,this.bottom-n,n,n)}isInTopEdge(i,s,n){return isInRectangle(i,s,this.x,this.y,this.width,n)}isInBottomEdge(i,s,n){return isInRectangle(i,s,this.x,this.bottom-n,this.width,n)}isInLeftEdge(i,s,n){return isInRectangle(i,s,this.x,this.y,n,this.height)}isInRightEdge(i,s,n){return isInRectangle(i,s,this.right-n,this.y,n,this.height)}getCentre(){return[this.centreX,this.centreY]}getArea(){return this.width*this.height}getPerimeter(){return 2*(this.width+this.height)}getTopLeft(){return[this[0],this[1]]}getBottomRight(){return[this.right,this.bottom]}getSize(){return[this[2],this[3]]}getOffsetTo([i,s]){return[i-this[0],s-this[1]]}getOffsetFrom([i,s]){return[this[0]-i,this[1]-s]}resizeTopLeft(i,s){this[2]+=this[0]-i,this[3]+=this[1]-s,this[0]=i,this[1]=s}resizeBottomLeft(i,s){this[2]+=this[0]-i,this[3]=s-this[1],this[0]=i}resizeTopRight(i,s){this[2]=i-this[0],this[3]+=this[1]-s,this[1]=s}resizeBottomRight(i,s){this[2]=i-this[0],this[3]=s-this[1]}setWidthRightAnchored(i){const s=this[2];this[2]=i,this[0]+=s-i}setHeightBottomAnchored(i){const s=this[3];this[3]=i,this[1]+=s-i}clone(){return new It(this[0],this[1],this[2],this[3])}toArray(){return this.export()}export(){return[this[0],this[1],this[2],this[3]]}_drawDebug(i,s="red"){const{strokeStyle:n,lineWidth:o}=i;try{i.strokeStyle=s,i.lineWidth=.5,i.beginPath(),i.strokeRect(this[0],this[1],this[2],this[3])}finally{i.strokeStyle=n,i.lineWidth=o}}};Z=new WeakMap,kt=new WeakMap;let Rectangle=It;function getNodeInputOnPos(u,t,i){var n,o,r;const{inputs:s}=u;if(s)for(const[a,l]of s.entries()){const h=u.getInputPos(a),p=20+((((n=l.label)==null?void 0:n.length)??((o=l.localized_name)==null?void 0:o.length)??((r=l.name)==null?void 0:r.length))||3)*7;if(isInRectangle(t,i,h[0]-10,h[1]-10,p,20))return{index:a,input:l,pos:h}}}function getNodeOutputOnPos(u,t,i){const{outputs:s}=u;if(s)for(const[n,o]of s.entries()){const r=u.getOutputPos(n);if(isInRectangle(t,i,r[0]-10,r[1]-10,40,20))return{index:n,output:o,pos:r}}}function isOverNodeInput(u,t,i,s){const n=getNodeInputOnPos(u,t,i);return n?(s&&(s[0]=n.pos[0],s[1]=n.pos[1]),n.index):-1}function isOverNodeOutput(u,t,i,s){const n=getNodeOutputOnPos(u,t,i);return n?(s&&(s[0]=n.pos[0],s[1]=n.pos[1]),n.index):-1}class NullGraphError extends Error{constructor(t="Attempted to access LGraph reference that was null or undefined.",i){super(t,{cause:i}),this.name="NullGraphError"}}class LGraphIcon{constructor({unicode:t,fontFamily:i="PrimeIcons",color:s="#e6c200",bgColor:n,fontSize:o=16,circlePadding:r=2,xOffset:a=0,yOffset:l=0}){d(this,"unicode");d(this,"fontFamily");d(this,"color");d(this,"bgColor");d(this,"fontSize");d(this,"circlePadding");d(this,"xOffset");d(this,"yOffset");this.unicode=t,this.fontFamily=i,this.color=s,this.bgColor=n,this.fontSize=o,this.circlePadding=r,this.xOffset=a,this.yOffset=l}draw(t,i,s){i+=this.xOffset,s+=this.yOffset;const{font:n,textBaseline:o,textAlign:r,fillStyle:a}=t;t.font=`${this.fontSize}px '${this.fontFamily}'`,t.textBaseline="middle",t.textAlign="center";const l=this.fontSize/2+this.circlePadding;this.bgColor&&(t.beginPath(),t.arc(i+l,s,l,0,2*Math.PI),t.fillStyle=this.bgColor,t.fill()),t.fillStyle=this.color,t.fillText(this.unicode,i+l,s),t.font=n,t.textBaseline=o,t.textAlign=r,t.fillStyle=a}}var BadgePosition=(u=>(u.TopLeft="top-left",u.TopRight="top-right",u))(BadgePosition||{});class LGraphBadge{constructor({text:t,fgColor:i="white",bgColor:s="#0F1F0F",fontSize:n=12,padding:o=6,height:r=20,cornerRadius:a=5,iconOptions:l,xOffset:h=0,yOffset:c=0}){d(this,"text");d(this,"fgColor");d(this,"bgColor");d(this,"fontSize");d(this,"padding");d(this,"height");d(this,"cornerRadius");d(this,"icon");d(this,"xOffset");d(this,"yOffset");this.text=t,this.fgColor=i,this.bgColor=s,this.fontSize=n,this.padding=o,this.height=r,this.cornerRadius=a,l&&(this.icon=new LGraphIcon(l)),this.xOffset=h,this.yOffset=c}get visible(){var t;return(((t=this.text)==null?void 0:t.length)??0)>0||!!this.icon}getWidth(t){if(!this.visible)return 0;const{font:i}=t;let s=0;this.icon&&(t.font=`${this.icon.fontSize}px '${this.icon.fontFamily}'`,s=t.measureText(this.icon.unicode).width+this.padding),t.font=`${this.fontSize}px sans-serif`;const n=this.text?t.measureText(this.text).width:0;return t.font=i,s+n+this.padding*2}draw(t,i,s){if(!this.visible)return;i+=this.xOffset,s+=this.yOffset;const{font:n,fillStyle:o,textBaseline:r,textAlign:a}=t;t.font=`${this.fontSize}px sans-serif`;const l=this.getWidth(t),h=0;t.fillStyle=this.bgColor,t.beginPath(),t.roundRect?t.roundRect(i+h,s,l,this.height,this.cornerRadius):t.rect(i+h,s,l,this.height),t.fill();let c=i+h+this.padding;const p=s+this.height/2;this.icon&&(this.icon.draw(t,c,p),c+=this.icon.fontSize+this.padding/2+4),this.text&&(t.fillStyle=this.fgColor,t.textBaseline="middle",t.textAlign="left",t.fillText(this.text,c,p+1)),t.font=n,t.fillStyle=o,t.textBaseline=r,t.textAlign=a}}class LGraphButton extends LGraphBadge{constructor(i){super(i);d(this,"name");d(this,"_last_area",new Rectangle);this.name=i.name}getWidth(i){if(!this.visible)return 0;const{font:s}=i;i.font=`${this.fontSize}px 'PrimeIcons'`;const n=this.text?i.measureText(this.text).width:0;return i.font=s,n}draw(i,s,n){if(!this.visible)return;const o=this.getWidth(i);this._last_area[0]=s+this.xOffset,this._last_area[1]=n+this.yOffset,this._last_area[2]=o,this._last_area[3]=this.height;const r=s+this.xOffset,a=n+this.yOffset,{font:l,fillStyle:h,textBaseline:c,textAlign:p}=i,f=i.fillStyle||"white";i.font=`${this.fontSize}px 'PrimeIcons'`,i.fillStyle=f,i.textBaseline="middle",i.textAlign="center";const g=r+o/2,_=a+this.height/2;this.text&&i.fillText(this.text,g,_),i.font=l,i.fillStyle=h,i.textBaseline=c,i.textAlign=p}isPointInside(i,s){return this._last_area.containsPoint([i,s])}}const ELLIPSIS="â€¦",TWO_DOT_LEADER="â€¥",ONE_DOT_LEADER="â€¤";var SlotType=(u=>(u.Array="array",u[u.Event=-1]="Event",u))(SlotType||{}),SlotShape=(u=>(u[u.Box=RenderShape.BOX]="Box",u[u.Arrow=RenderShape.ARROW]="Arrow",u[u.Grid=RenderShape.GRID]="Grid",u[u.Circle=RenderShape.CIRCLE]="Circle",u[u.HollowCircle=RenderShape.HollowCircle]="HollowCircle",u))(SlotShape||{}),SlotDirection=(u=>(u[u.Up=LinkDirection.UP]="Up",u[u.Right=LinkDirection.RIGHT]="Right",u[u.Down=LinkDirection.DOWN]="Down",u[u.Left=LinkDirection.LEFT]="Left",u))(SlotDirection||{}),LabelPosition=(u=>(u.Left="left",u.Right="right",u))(LabelPosition||{});function strokeShape(u,t,{shape:i=RenderShape.BOX,round_radius:s,title_height:n,title_mode:o=TitleMode.NORMAL_TITLE,color:r,padding:a=6,collapsed:l=!1,lineWidth:h=1}={}){if(s??(s=LiteGraph.ROUND_RADIUS),r??(r=LiteGraph.NODE_BOX_OUTLINE_COLOR),o===TitleMode.TRANSPARENT_TITLE){const y=n??LiteGraph.NODE_TITLE_HEIGHT;t[1]-=y,t[3]+=y}const{lineWidth:c,strokeStyle:p}=u;u.lineWidth=h,u.globalAlpha=.8,u.strokeStyle=r,u.beginPath();const[f,g,_,m]=t;switch(i){case RenderShape.BOX:{u.rect(f-a,g-a,_+2*a,m+2*a);break}case RenderShape.ROUND:case RenderShape.CARD:{const y=s+a,k=i===RenderShape.CARD&&l||i===RenderShape.ROUND?[y]:[y,2,y,2];u.roundRect(f-a,g-a,_+2*a,m+2*a,k);break}case RenderShape.CIRCLE:{const y=f+_/2,w=g+m/2,k=Math.max(_,m)/2+a;u.arc(y,w,k,0,Math.PI*2);break}}u.stroke(),u.lineWidth=c,u.strokeStyle=p,u.globalAlpha=1}function truncateTextToWidth(u,t,i){if(!(i>0))return"";if(u.measureText(t).width<=i)return t;const n=u.measureText(ELLIPSIS).width*.75;if(n>i)return u.measureText(TWO_DOT_LEADER).width*.75<i?TWO_DOT_LEADER:u.measureText(ONE_DOT_LEADER).width*.75<i?ONE_DOT_LEADER:"";let o=0,r=t.length,a=0;for(;o<=r;){const l=Math.floor((o+r)*.5);if(l===0){o=l+1;continue}const h=t.substring(0,l);u.measureText(h).width+n<=i?(a=l,o=l+1):r=l-1}return a===0?ELLIPSIS:t.substring(0,a)+ELLIPSIS}function drawTextInArea({ctx:u,text:t,area:i,align:s="left"}){const{left:n,right:o,bottom:r,width:a,centreX:l}=i;if(u.measureText(t).width<=a){u.textAlign=s;const f=s==="left"?n:s==="right"?o:l;u.fillText(t,f,r);return}const c=truncateTextToWidth(u,t,a);if(c.length===0)return;u.textAlign="left",u.fillText(c.slice(0,-1),n,r),u.rect(n,r,a,1),u.textAlign="right";const p=c.at(-1);u.fillText(p,o,r,u.measureText(p).width*.75)}class SlotBase{constructor(t,i,s){d(this,"name");d(this,"localized_name");d(this,"label");d(this,"type");d(this,"dir");d(this,"removable");d(this,"shape");d(this,"color_off");d(this,"color_on");d(this,"locked");d(this,"nameLocked");d(this,"widget");d(this,"_floatingLinks");d(this,"hasErrors");d(this,"boundingRect");this.name=t,this.type=i,this.boundingRect=s??new Rectangle}renderingColor(t){return this.isConnected?this.color_on||t.getConnectedColor(this.type):this.color_off||t.getDisconnectedColor(this.type)}}class NodeSlot extends SlotBase{constructor(i,s){const n=i,{boundingRect:o,name:r,type:a,_listenerController:l,...h}=n,c=o?Rectangle.ensureRect(o):new Rectangle;super(r,a,c);P(this,Re);d(this,"pos");P(this,oe);Object.assign(this,h),U(this,oe,s)}get node(){return I(this,oe)}get highlightColor(){return LiteGraph.NODE_TEXT_HIGHLIGHT_COLOR??LiteGraph.NODE_SELECTED_TITLE_COLOR??LiteGraph.NODE_TEXT_COLOR}get renderingLabel(){return this.label||this.localized_name||this.name||""}draw(i,{colorContext:s,labelPosition:n=LabelPosition.Right,lowQuality:o=!1,highlight:r=!1,doStroke:a=!1}){const l=i.fillStyle,h=i.strokeStyle,c=i.lineWidth,p=r?this.highlightColor:LiteGraph.NODE_TEXT_COLOR,f=I(this,Re,fi),g=this.type,_=g===SlotType.Array?SlotShape.Grid:this.shape;i.beginPath();let m=!0;if(i.fillStyle=this.renderingColor(s),i.lineWidth=1,g===SlotType.Event||_===SlotShape.Box)i.rect(f[0]-6+.5,f[1]-5+.5,14,10);else if(_===SlotShape.Arrow)i.moveTo(f[0]+8,f[1]+.5),i.lineTo(f[0]-4,f[1]+6+.5),i.lineTo(f[0]-4,f[1]-6+.5),i.closePath();else if(_===SlotShape.Grid){for(let E=0;E<3;E++)for(let S=0;S<3;S++)i.rect(f[0]-4+E*3,f[1]-4+S*3,2,2);a=!1}else if(o)i.rect(f[0]-4,f[1]-4,8,8);else{let w;_===SlotShape.HollowCircle?(m=!1,a=!0,i.lineWidth=3,i.strokeStyle=i.fillStyle,w=r?4:3):w=r?5:4,i.arc(f[0],f[1],w,0,Math.PI*2)}if(m&&i.fill(),!o&&a&&i.stroke(),!(o||this.isWidgetInputSlot)){const w=this.renderingLabel;w&&(i.fillStyle=p,n===LabelPosition.Right?this.dir==LinkDirection.UP?i.fillText(w,f[0],f[1]-10):i.fillText(w,f[0]+10,f[1]+5):this.dir==LinkDirection.DOWN?i.fillText(w,f[0],f[1]-8):i.fillText(w,f[0]-10,f[1]+5))}this.hasErrors&&(i.lineWidth=2,i.strokeStyle="red",i.beginPath(),i.arc(f[0],f[1],12,0,Math.PI*2),i.stroke()),i.fillStyle=l,i.strokeStyle=h,i.lineWidth=c}drawCollapsed(i){const[s,n]=this.collapsedPos,{fillStyle:o}=i;i.fillStyle="#686",i.beginPath(),this.type===SlotType.Event||this.shape===RenderShape.BOX?i.rect(s-7+.5,n-4,14,8):this.shape===RenderShape.ARROW?(this instanceof NodeInputSlot?(i.moveTo(s+8,n),i.lineTo(s-4,n-4),i.lineTo(s-4,n+4)):(i.moveTo(s+6,n),i.lineTo(s-6,n-4),i.lineTo(s-6,n+4)),i.closePath()):i.arc(s,n,4,0,Math.PI*2),i.fill(),i.fillStyle=o}}Re=new WeakSet,fi=function(){const i=this.node.pos,{boundingRect:s}=this,n=s[3];return getCentre([s[0]-i[0],s[1]-i[1],n,n])},oe=new WeakMap;const ot=class ot{constructor(t,i){d(this,"id");d(this,"color");d(this,"title");d(this,"font");d(this,"font_size",LiteGraph.DEFAULT_GROUP_FONT||24);d(this,"_bounding",new Float32Array([10,10,ot.minWidth,ot.minHeight]));d(this,"_pos",this._bounding.subarray(0,2));d(this,"_size",this._bounding.subarray(2,4));d(this,"_nodes",[]);d(this,"_children",new Set);d(this,"graph");d(this,"flags",{});d(this,"selected");d(this,"isPointInside",LGraphNode.prototype.isPointInside);d(this,"setDirtyCanvas",LGraphNode.prototype.setDirtyCanvas);this.id=i??-1,this.title=t||"Group";const{pale_blue:s}=LGraphCanvas.node_colors;this.color=s?s.groupcolor:"#AAA"}setColorOption(t){t==null?delete this.color:this.color=t.groupcolor}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.groupcolor===this.color)??null}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=Math.max(ot.minWidth,t[0]),this._size[1]=Math.max(ot.minHeight,t[1]))}get boundingRect(){return this._bounding}get nodes(){return this._nodes}get titleHeight(){return this.font_size*1.4}get children(){return this._children}get pinned(){return!!this.flags.pinned}pin(t){(t===void 0?!this.pinned:t)?this.flags.pinned=!0:delete this.flags.pinned}unpin(){this.pin(!1)}configure(t){this.id=t.id,this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.flags=t.flags||this.flags,t.font_size&&(this.font_size=t.font_size)}serialize(){const t=this._bounding;return{id:this.id,title:this.title,bounding:[...t],color:this.color,font_size:this.font_size,flags:this.flags}}draw(t,i){const{padding:s,resizeLength:n,defaultColour:o}=ot,r=this.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,[a,l]=this._pos,[h,c]=this._size,p=this.color||o;i.globalAlpha=.25*t.editor_alpha,i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,h,r*1.4),i.fill(),i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,h,c),i.fill(),i.globalAlpha=t.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(a+h,l+c),i.lineTo(a+h-n,l+c),i.lineTo(a+h,l+c-n),i.fill(),i.font=`${r}px ${LiteGraph.GROUP_FONT}`,i.textAlign="left",i.fillText(this.title+(this.pinned?"ðŸ“Œ":""),a+s,l+r),LiteGraph.highlight_selected_group&&this.selected&&strokeShape(i,this._bounding,{title_height:this.titleHeight,padding:s})}resize(t,i){return this.pinned?!1:(this._size[0]=Math.max(ot.minWidth,t),this._size[1]=Math.max(ot.minHeight,i),!0)}move(t,i,s=!1){if(!this.pinned&&(this._pos[0]+=t,this._pos[1]+=i,s!==!0))for(const n of this._children)n.move(t,i)}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}recomputeInsideNodes(){if(!this.graph)throw new NullGraphError;const{nodes:t,reroutes:i,groups:s}=this.graph,n=this._children;this._nodes.length=0,n.clear();for(const o of t)containsCentre(this._bounding,o.boundingRect)&&(this._nodes.push(o),n.add(o));for(const o of i.values())isPointInRect(o.pos,this._bounding)&&n.add(o);for(const o of s)containsRect(this._bounding,o._bounding)&&n.add(o);s.sort((o,r)=>o===this?n.has(r)?-1:0:r===this&&n.has(o)?1:0)}resizeTo(t,i=10){const s=createBounds(t,i);s!==null&&(this.pos[0]=s[0],this.pos[1]=s[1]-this.titleHeight,this.size[0]=s[2],this.size[1]=s[3]+this.titleHeight)}addNodes(t,i=10){!this._nodes&&t.length===0||this.resizeTo([...this.children,...this._nodes,...t],i)}getMenuOptions(){return[{content:this.pinned?"Unpin":"Pin",callback:()=>{this.pinned?this.unpin():this.pin(),this.setDirtyCanvas(!1,!0)}},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}isPointInTitlebar(t,i){const s=this.boundingRect;return isInRectangle(t,i,s[0],s[1],s[2],this.titleHeight)}isInResize(t,i){const s=this.boundingRect,n=s[0]+s[2],o=s[1]+s[3];return t<n&&i<o&&t-n+(i-o)>-ot.resizeLength}};d(ot,"minWidth",140),d(ot,"minHeight",80),d(ot,"resizeLength",10),d(ot,"padding",4),d(ot,"defaultColour","#335");let LGraphGroup=ot;const tt=class tt{constructor(t,i,s,n,o,r){P(this,Tt);P(this,Ht,new Float32Array(8));P(this,nt);P(this,pt);d(this,"floating");P(this,ut,I(this,Ht).subarray(0,2));d(this,"selected");d(this,"linkIds");d(this,"floatingLinkIds");d(this,"cos",0);d(this,"sin",0);d(this,"controlPoint",I(this,Ht).subarray(4,6));d(this,"path");d(this,"_centreAngle");d(this,"_pos",I(this,Ht).subarray(6,8));d(this,"_dragging");d(this,"_colour");P(this,re,-1/0);P(this,Dt,new RerouteSlot(this,!0));P(this,Gt,new RerouteSlot(this,!1));this.id=t,U(this,nt,new WeakRef(i)),this.parentId=n,s&&(this.pos=s),this.linkIds=new Set(o),this.floatingLinkIds=new Set(r)}static get slotOffset(){const t=tt.slotRadius*.33;return tt.radius+t+tt.slotRadius}get parentId(){return I(this,pt)}set parentId(t){t!==this.id&&this.getReroutes()!==null&&U(this,pt,t)}get parent(){var t;return(t=I(this,nt).deref())==null?void 0:t.getReroute(I(this,pt))}get pos(){return I(this,ut)}set pos(t){if(!((t==null?void 0:t.length)>=2))throw new TypeError("Reroute.pos is an x,y point, and expects an indexable with at least two values.");I(this,ut)[0]=t[0],I(this,ut)[1]=t[1]}get boundingRect(){const{radius:t}=tt,[i,s]=I(this,ut);return[i-t,s-t,2*t,2*t]}get totalLinks(){return this.linkIds.size+this.floatingLinkIds.size}get colour(){return this._colour??"#18184d"}get isSlotHovered(){return this.isInputHovered||this.isOutputHovered}get isInputHovered(){return I(this,Dt).hovering}get isOutputHovered(){return I(this,Gt).hovering}get firstLink(){var i;const t=this.linkIds.values().next().value;return t===void 0||(i=I(this,nt).deref())==null?void 0:i.links.get(t)}get firstFloatingLink(){var i;const t=this.floatingLinkIds.values().next().value;return t===void 0||(i=I(this,nt).deref())==null?void 0:i.floatingLinks.get(t)}get origin_id(){var t;return(t=this.firstLink)==null?void 0:t.origin_id}get origin_slot(){var t;return(t=this.firstLink)==null?void 0:t.origin_slot}update(t,i,s,n){this.parentId=t,i&&(this.pos=i),s&&(this.linkIds=new Set(s)),this.floating=n}validateLinks(t,i){const{linkIds:s,floatingLinkIds:n}=this;for(const o of s)t.has(o)||s.delete(o);for(const o of n)i.has(o)||n.delete(o);return s.size>0||n.size>0}getReroutes(t=new Set){var n;if(I(this,pt)===void 0)return[this];if(t.has(this))return null;t.add(this);const i=(n=I(this,nt).deref())==null?void 0:n.reroutes.get(I(this,pt));if(!i)return U(this,pt,void 0),[this];const s=i.getReroutes(t);return s==null||s.push(this),s}findNextReroute(t,i=new Set){var s,n;if(I(this,pt)===t)return this;if(i.has(this))return null;if(i.add(this),I(this,pt)!==void 0)return(n=(s=I(this,nt).deref())==null?void 0:s.reroutes.get(I(this,pt)))==null?void 0:n.findNextReroute(t,i)}findSourceOutput(){var s;const t=this.firstLink??this.firstFloatingLink;if(!t)return;const i=(s=I(this,nt).deref())==null?void 0:s.getNodeById(t.origin_id);if(i)return{node:i,output:i.outputs[t.origin_slot]}}findTargetInputs(){const t=I(this,nt).deref();if(!t)return;const i=[];return s(t,this.linkIds,t.links),s(t,this.floatingLinkIds,t.floatingLinks),i;function s(n,o,r){for(const a of o){const l=r.get(a);if(!l)continue;const h=n.getNodeById(l.target_id),c=h==null?void 0:h.inputs[l.target_slot];c&&i.push({node:h,input:c,link:l})}}}getFloatingLinks(t){var o;const i=(o=I(this,nt).deref())==null?void 0:o.floatingLinks;if(!i)return;const s=t==="input"?"origin_id":"target_id",n=[];for(const r of this.floatingLinkIds){const a=i.get(r);(a==null?void 0:a[s])===-1&&n.push(a)}return n}setFloatingLinkOrigin(t,i,s){var r,a,l;const n=I(this,nt).deref(),o=this.getFloatingLinks("output");if(!o)throw new Error("[setFloatingLinkOrigin]: Invalid network.");if(o.length){i._floatingLinks??(i._floatingLinks=new Set);for(const h of o)i._floatingLinks.add(h),(l=(a=(r=n==null?void 0:n.getNodeById(h.origin_id))==null?void 0:r.outputs[h.origin_slot])==null?void 0:a._floatingLinks)==null||l.delete(h),h.origin_id=t.id,h.origin_slot=s}}move(t,i){I(this,ut)[0]+=t,I(this,ut)[1]+=i}snapToGrid(t){if(!t)return!1;const{pos:i}=this;return i[0]=t*Math.round(i[0]/t),i[1]=t*Math.round(i[1]/t),!0}removeAllFloatingLinks(){for(const t of this.floatingLinkIds)this.removeFloatingLink(t)}removeFloatingLink(t){const i=I(this,nt).deref();if(!i)return;const s=i.floatingLinks.get(t);if(!s){console.warn(`[Reroute.removeFloatingLink] Floating link not found: ${t}, ignoring and discarding ID.`),this.floatingLinkIds.delete(t);return}i.removeFloatingLink(s)}removeLink(t){const i=I(this,nt).deref();if(!i)return;const s=i.floatingLinks.get(t.id);t===s?this.floatingLinkIds.delete(t.id):this.linkIds.delete(t.id)}remove(){const t=I(this,nt).deref();t&&t.removeReroute(this.id)}calculateAngle(t,i,s){if(!(t>I(this,re)))return;U(this,re,t);const{id:n,pos:o}=this,r=[];let a=0;if(_(this.linkIds,i.links),_(this.floatingLinkIds,i.floatingLinks),!r.length){this.cos=0,this.sin=0,this.controlPoint[0]=0,this.controlPoint[1]=0;return}a/=r.length;const l=Math.atan2(I(this,ut)[1]-s[1],I(this,ut)[0]-s[0]);let h=(l-a)*.5;Math.abs(h)>Math.PI*.5&&(h+=Math.PI);const c=Math.min(tt.maxSplineOffset,distance(s,I(this,ut))*.25),p=l-h,f=Math.cos(p),g=Math.sin(p);this.cos=f,this.sin=g,this.controlPoint[0]=c*-f,this.controlPoint[1]=c*-g;function _(m,y){for(const w of m){const k=y.get(w),L=getNextPos(i,k,n);if(!L)continue;const E=getDirection(o,L);r.push(E),a+=E}}}draw(t,i){const{globalAlpha:s}=t,{pos:n}=this;if(t.beginPath(),t.arc(n[0],n[1],tt.radius,0,2*Math.PI),this.linkIds.size===0&&(t.fillStyle=i??"#797979",t.fill(),t.globalAlpha=s*.33),t.fillStyle=this.colour,t.lineWidth=tt.radius*.1,t.strokeStyle="rgb(0,0,0,0.5)",t.fill(),t.stroke(),t.fillStyle="#ffffff55",t.strokeStyle="rgb(0,0,0,0.3)",t.beginPath(),t.arc(n[0],n[1],tt.radius*.8,0,2*Math.PI),t.fill(),t.stroke(),this.selected&&(t.strokeStyle="#fff",t.beginPath(),t.arc(n[0],n[1],tt.radius*1.2,0,2*Math.PI),t.stroke()),tt.drawIdBadge){const o=new LGraphBadge({text:this.id.toString()}),r=n[0]-o.getWidth(t)*.5,a=n[1]-o.height-tt.radius-2;o.draw(t,r,a)}t.globalAlpha=s}drawSlots(t){I(this,Dt).draw(t),I(this,Gt).draw(t)}drawHighlight(t,i){const{pos:s}=this,{strokeStyle:n,lineWidth:o}=t;t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(s[0],s[1],tt.radius*1.5,0,2*Math.PI),t.stroke(),t.strokeStyle=n,t.lineWidth=o}updateVisibility(t){const i=I(this,Dt),s=I(this,Gt);i.dirty=!1,s.dirty=!1;const{firstFloatingLink:n}=this,o=!!this.firstLink,r=o||(n==null?void 0:n.isFloatingOutput),a=o||(n==null?void 0:n.isFloatingInput);if((r||a)&&isPointInRect(t,I(this,Tt,qe))){const h=N(this,Tt,Ze).call(this,t);r&&i.update(t,h),a&&s.update(t,h)}else this.hideSlots();return i.dirty||s.dirty}hideSlots(){I(this,Dt).hide(),I(this,Gt).hide()}containsPoint(t){return isPointInRect(t,I(this,Tt,qe))&&N(this,Tt,Ze).call(this,t)}asSerialisable(){const{id:t,parentId:i,pos:s,linkIds:n}=this;return{id:t,parentId:i,pos:[s[0],s[1]],linkIds:[...n],floating:this.floating?{slotType:this.floating.slotType}:void 0}}};Ht=new WeakMap,nt=new WeakMap,pt=new WeakMap,ut=new WeakMap,Tt=new WeakSet,qe=function(){const t=2*tt.slotOffset,i=2*Math.max(tt.radius,tt.slotRadius),[s,n]=I(this,ut);return[s-t,n-i,2*t,2*i]},re=new WeakMap,Dt=new WeakMap,Gt=new WeakMap,Ze=function(t){return distance(this.pos,t)<=tt.radius},d(tt,"radius",10),d(tt,"maxSplineOffset",80),d(tt,"drawIdBadge",!1),d(tt,"slotRadius",5);let Reroute=tt;class RerouteSlot{constructor(t,i){P(this,Ut);P(this,ae);d(this,"dirty",!1);P(this,$t,!1);P(this,Xt,!1);U(this,Ut,t),U(this,ae,i?-1:1)}get pos(){const[t,i]=I(this,Ut).pos;return[t+Reroute.slotOffset*I(this,ae),i]}get hovering(){return I(this,$t)}set hovering(t){Object.is(I(this,$t),t)||(U(this,$t,t),this.dirty=!0)}get showOutline(){return I(this,Xt)}set showOutline(t){Object.is(I(this,Xt),t)||(U(this,Xt,t),this.dirty=!0)}update(t,i){if(i)this.hovering=!1,this.showOutline=!0;else{const s=distance(this.pos,t);this.hovering=s<=2*Reroute.slotRadius,this.showOutline=s<=5*Reroute.slotRadius}}hide(){this.hovering=!1,this.showOutline=!1}draw(t){const{fillStyle:i,strokeStyle:s,lineWidth:n}=t,{showOutline:o,hovering:r,pos:[a,l]}=this;if(o)try{t.fillStyle=r?I(this,Ut).colour:"rgba(127,127,127,0.3)",t.strokeStyle="rgb(0,0,0,0.5)",t.lineWidth=1,t.beginPath(),t.arc(a,l,Reroute.slotRadius,0,2*Math.PI),t.fill(),t.stroke()}finally{t.fillStyle=i,t.strokeStyle=s,t.lineWidth=n}}}Ut=new WeakMap,ae=new WeakMap,$t=new WeakMap,Xt=new WeakMap;function getNextPos(u,t,i){var n,o;if(!t)return;const s=(n=LLink.findNextReroute(u,t,i))==null?void 0:n.pos;if(s)return s;if(!(t.target_id===-1||t.target_slot===-1))return(o=u.getNodeById(t.target_id))==null?void 0:o.getInputPos(t.target_slot)}function getDirection(u,t){return Math.atan2(t[1]-u[1],t[0]-u[0])}function stringOrEmpty(u){return u==null?"":String(u)}function parseSlotTypes(u){return u==""||u=="0"?["*"]:String(u).toLowerCase().split(",")}function nextUniqueName(u,t=[]){let i=1;const s=u;for(;t.includes(u);)u=`${s}_${i++}`;return u}const De=class De{constructor(t,i){P(this,Yt,0);P(this,jt,0);P(this,le,0);P(this,de,0);d(this,"minWidth",0);d(this,"minHeight",0);d(this,"maxWidth",1/0);d(this,"maxHeight",1/0);this.desiredWidth=t,this.desiredHeight=i}get width(){return I(this,Yt)}get height(){return I(this,jt)}get desiredWidth(){return I(this,le)}set desiredWidth(t){U(this,le,t),U(this,Yt,clamp(t,this.minWidth,this.maxWidth))}get desiredHeight(){return I(this,de)}set desiredHeight(t){U(this,de,t),U(this,jt,clamp(t,this.minHeight,this.maxHeight))}static fromSize(t){return new De(t[0],t[1])}static fromRect(t){return new De(t[2],t[3])}setSize(t){this.desiredWidth=t[0],this.desiredHeight=t[1]}setValues(t,i){this.desiredWidth=t,this.desiredHeight=i}toSize(){return[I(this,Yt),I(this,jt)]}};Yt=new WeakMap,jt=new WeakMap,le=new WeakMap,de=new WeakMap;let ConstrainedSize=De;const qt=class qt extends SlotBase{constructor(i,s){super(i.name,i.type);P(this,Kt,new Float32Array(2));d(this,"measurement",new ConstrainedSize(qt.defaultHeight,qt.defaultHeight));d(this,"id");d(this,"parent");d(this,"type");d(this,"linkIds",[]);d(this,"boundingRect",new Rectangle(0,0,0,qt.defaultHeight));d(this,"isPointerOver",!1);Object.assign(this,i),this.id=i.id??createUuidv4(),this.type=i.type,this.parent=s}static get defaultHeight(){return LiteGraph.NODE_SLOT_HEIGHT}get pos(){return I(this,Kt)}set pos(i){!i||i.length<2||(I(this,Kt)[0]=i[0],I(this,Kt)[1]=i[1])}get isConnected(){return this.linkIds.length>0}get displayName(){return this.label??this.localized_name??this.name}containsPoint(i){return this.boundingRect.containsPoint(i)}onPointerMove(i){this.isPointerOver=this.boundingRect.containsXy(i.canvasX,i.canvasY)}getLinks(){const i=[],{subgraph:s}=this.parent;for(const n of this.linkIds){const o=s.getLink(n);o&&i.push(o)}return i}decrementSlots(i){const{links:s}=this.parent.subgraph,n=i==="inputs"?"origin_slot":"target_slot";for(const o of this.linkIds){const r=s.get(o);r?r[n]--:console.warn("decrementSlots: link ID not found",o)}}measure(){var n;const i=((n=LGraphCanvas._measureText)==null?void 0:n.call(LGraphCanvas,this.displayName))??0,{defaultHeight:s}=qt;return this.measurement.setValues(i+s,s),this.measurement.toSize()}disconnect(){const{subgraph:i}=this.parent;for(const s of this.linkIds)i.removeLink(s);this.linkIds.length=0}draw({ctx:i,colorContext:s,lowQuality:n,fromSlot:o,editorAlpha:r=1}){const a=this.shape,{isPointerOver:l,pos:[h,c]}=this,p=o?this.isValidTarget(o):!0,f=!o||p,g=f&&l,_=i.globalAlpha;i.globalAlpha=f?r:.4*r,i.beginPath();const m=this.renderingColor(s);if(n)i.fillStyle=m,i.rect(h-4,c-4,8,8),i.fill();else if(a===SlotShape.HollowCircle){i.lineWidth=3,i.strokeStyle=m;const y=g?4:3;i.arc(h,c,y,0,Math.PI*2),i.stroke()}else{i.fillStyle=m;const y=g?5:4;i.arc(h,c,y,0,Math.PI*2),i.fill()}if(this.displayName){const[y,w]=this.labelPos;i.fillStyle=g?"white":LiteGraph.NODE_TEXT_COLOR||"#AAA",i.fillText(this.displayName,y,w)}i.globalAlpha=_}asSerialisable(){const{id:i,name:s,type:n,linkIds:o,localized_name:r,label:a,dir:l,shape:h,color_off:c,color_on:p,pos:f}=this;return{id:i,name:s,type:n,linkIds:o,localized_name:r,label:a,dir:l,shape:h,color_off:c,color_on:p,pos:f}}};Kt=new WeakMap;let SubgraphSlot=qt;class SubgraphOutput extends SubgraphSlot{connect(t,i,s){var c,p,f;const{subgraph:n}=this.parent;if(!LiteGraph.isValidConnection(t.type,this.type))return;const o=i.outputs.indexOf(t);if(o===-1)throw new Error("Slot is not an output of the given node");if(((c=i.onConnectOutput)==null?void 0:c.call(i,o,this.type,this,this.parent,-1))===!1)return;const r=this.getLinks().at(0);if(r!=null){n.beforeChange(),r.disconnect(n,"input");const _=(p=r.resolve(n).output)==null?void 0:p.links;_&&removeFromArray(_,r.id)}const a=new LLink(++n.state.lastLinkId,t.type,i.id,o,this.parent.id,this.parent.slots.indexOf(this),s);n._links.set(a.id,a),this.linkIds[0]=a.id,t.links??(t.links=[]),t.links.push(a.id);const l=LLink.getReroutes(n,a);for(const g of l)g.linkIds.add(a.id),g.floating&&delete g.floating,g._dragging=void 0;const h=l.at(-1);if(h)for(const g of h.floatingLinkIds){const _=n.floatingLinks.get(g);(_==null?void 0:_.parentId)===h.id&&n.removeFloatingLink(_)}return n._version++,(f=i.onConnectionsChange)==null||f.call(i,NodeSlotType.OUTPUT,o,!0,a,t),n.afterChange(),a}get labelPos(){const[t,i,,s]=this.boundingRect;return[t+s,i+s*.5]}arrange(t){const[i,s,n,o]=t,{boundingRect:r,pos:a}=this;r[0]=i,r[1]=s,r[2]=n,r[3]=o,a[0]=i+o*.5,a[1]=s+o*.5}isValidTarget(t){return isNodeSlot(t)?"links"in t&&LiteGraph.isValidConnection(t.type,this.type):isSubgraphInput(t)?LiteGraph.isValidConnection(t.type,this.type):!1}}class EmptySubgraphOutput extends SubgraphOutput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,s){const{subgraph:n}=this.parent,o=n.outputs.map(l=>l.name),r=nextUniqueName(t.name,o);return n.addOutput(r,String(t.type)).connect(t,i,s)}get labelPos(){const[t,i,,s]=this.boundingRect;return[t,i+s*.5]}}const Jt=class Jt{constructor(t){P(this,Zt);P(this,he,new Rectangle);d(this,"selected",!1);d(this,"pinned",!1);d(this,"removable",!1);d(this,"isPointerOver",!1);this.subgraph=t}get boundingRect(){return I(this,he)}get pos(){return this.boundingRect.pos}set pos(t){this.boundingRect.pos=t}get size(){return this.boundingRect.size}set size(t){this.boundingRect.size=t}get sideLineWidth(){return this.isPointerOver?2.5:2}get sideStrokeStyle(){return this.isPointerOver?"white":"#efefef"}move(t,i){this.pos[0]+=t,this.pos[1]+=i}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}containsPoint(t){return this.boundingRect.containsPoint(t)}onPointerMove(t){const i=this.boundingRect.containsXy(t.canvasX,t.canvasY);let s=i?CanvasItem.SubgraphIoNode:CanvasItem.Nothing;if(i){this.isPointerOver||this.onPointerEnter();for(const n of this.allSlots)n.onPointerMove(t),n.isPointerOver&&(s|=CanvasItem.SubgraphIoSlot)}else this.isPointerOver&&this.onPointerLeave();return s}onPointerEnter(){this.isPointerOver=!0}onPointerLeave(){this.isPointerOver=!1;for(const t of this.slots)t.isPointerOver=!1}getSlotInPosition(t,i){for(const s of this.allSlots)if(s.boundingRect.containsXy(t,i))return s}showSlotContextMenu(t,i){const s=N(this,Zt,gi).call(this,t);s.length>0&&new LiteGraph.ContextMenu(s,{event:i,title:t.name||"Subgraph Output",callback:n=>{N(this,Zt,_i).call(this,n,t,i)}})}arrange(){const{minWidth:t,roundedRadius:i}=Jt,[,s]=this.boundingRect,n=this.slotAnchorX,{size:o}=this;let r=t,a=s+i;for(const l of this.allSlots){const[h,c]=l.measure();l.arrange([n,a,h,c]),a+=c,h>r&&(r=h)}o[0]=r+2*i,o[1]=a-s+i}draw(t,i,s,n){const{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:h}=t;this.drawProtected(t,i,s,n),Object.assign(t,{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:h})}drawSlots(t,i,s,n){t.fillStyle="#AAA",t.font="12px Arial",t.textBaseline="middle";for(const o of this.allSlots)o.draw({ctx:t,colorContext:i,fromSlot:s,editorAlpha:n})}configure(t){I(this,he).set(t.bounding),this.pinned=t.pinned??!1}asSerialisable(){return{id:this.id,bounding:this.boundingRect.export(),pinned:this.pinned?!0:void 0}}};he=new WeakMap,Zt=new WeakSet,gi=function(t){const i=[];return t!==this.emptySlot&&t.linkIds.length>0&&i.push({content:"Disconnect Links",value:"disconnect"}),t!==this.emptySlot&&i.push({content:"Remove Slot",value:"remove"},{content:"Rename Slot",value:"rename"}),i},_i=function(t,i,s){switch(t.value){case"disconnect":i.disconnect();break;case"remove":i!==this.emptySlot&&this.removeSlot(i);break;case"rename":i!==this.emptySlot&&this.subgraph.canvasAction(n=>n.prompt("Slot name",i.name,o=>{o&&this.renameSlot(i,o)},s));break}this.subgraph.setDirtyCanvas(!0)},d(Jt,"margin",10),d(Jt,"minWidth",100),d(Jt,"roundedRadius",10);let SubgraphIONodeBase=Jt;class SubgraphOutputNode extends SubgraphIONodeBase{constructor(){super(...arguments);d(this,"id",SUBGRAPH_OUTPUT_ID);d(this,"emptySlot",new EmptySubgraphOutput(this))}get slots(){return this.subgraph.outputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i]=this.boundingRect;return i+SubgraphIONodeBase.roundedRadius}onPointerDown(i,s,n){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(s.onDragStart=()=>{n.dragNewFromSubgraphOutput(this.subgraph,this,o)},s.onDragEnd=a=>{n.dropLinks(this.subgraph,a)},s.finally=()=>{n.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,s){this.subgraph.renameOutput(i,s)}removeSlot(i){this.subgraph.removeOutput(i)}canConnectTo(i,s,n){return i.canConnectTo(this,s,n)}connectByTypeOutput(i,s,n,o){const r=s.findOutputByType(n);if(r)return this.slots[i].connect(r.slot,s,o==null?void 0:o.afterRerouteId)}findInputByType(i){var s;return(s=findFreeSlotOfType(this.slots,i,n=>n.linkIds.length>0))==null?void 0:s.slot}drawProtected(i,s,n,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,h,,c]=this.boundingRect;i.translate(l,h),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(r,r,r,Math.PI,Math.PI*1.5),i.moveTo(0,r),i.lineTo(0,c-r),i.arc(r,c-r,r,Math.PI,Math.PI*.5,!0),i.stroke(),i.setTransform(a),this.drawSlots(i,s,n,o)}}function splitPositionables(u){const t=new Set,i=new Set,s=new Set,n=new Set,o=new Set,r=new Set;for(const a of u)switch(!0){case a instanceof LGraphNode:t.add(a);break;case a instanceof LGraphGroup:s.add(a);break;case a instanceof Reroute:i.add(a);break;case a instanceof SubgraphInputNode:n.add(a);break;case a instanceof SubgraphOutputNode:o.add(a);break;default:r.add(a);break}return{nodes:t,reroutes:i,groups:s,subgraphInputNodes:n,subgraphOutputNodes:o,unknown:r}}function getBoundaryLinks(u,t){const i=[],s=[],n=[],o=[],r=[],a=new WeakSet;for(const h of t)if(!a.has(h)){if(a.add(h),h instanceof LGraphNode){const c=h;if(c.inputs)for(const p of c.inputs){if(l(p._floatingLinks),p.link==null)continue;const f=LLink.resolve(p.link,u);if(!f){console.debug(`Failed to resolve link ID [${p.link}]`);continue}const{link:g,outputNode:_}=f;_?t.has(_)?i.push(g):n.push(g):g.origin_id===SUBGRAPH_INPUT_ID&&n.push(g)}if(c.outputs)for(const p of c.outputs){if(l(p._floatingLinks),!p.links)continue;const f=LLink.resolveMany(p.links,u);for(const{link:g,inputNode:_}of f)(g.target_id===SUBGRAPH_OUTPUT_ID||_&&!t.has(_))&&o.push(g)}}else if(h instanceof Reroute){const c=h,p=LLink.resolveMany(c.linkIds,u);for(const{link:f}of p){const _=LLink.getReroutes(u,f).filter(w=>!t.has(w)),{inputNode:m,outputNode:y}=f.resolve(u);(_.length||m&&!t.has(m)||y&&!t.has(y))&&s.push(f)}}}return{boundaryLinks:s,boundaryFloatingLinks:r,internalLinks:i,boundaryInputLinks:n,boundaryOutputLinks:o};function l(h){if(h)for(const c of h)LLink.getReroutes(u,c).some(f=>!t.has(f))&&r.push(c)}}function multiClone(u){const t=[];for(const i of u){const s=LiteGraph.createNode(i.type);if(!s){console.warn("Failed to create node",i.type);continue}const n=LiteGraph.cloneObject(i.serialize());s.configure(n),t.push(s.serialize())}return t}function groupResolvedByOutput(u){const t=new Map;for(const i of u){const s=i.subgraphInput??i.output??{},n=t.get(s);n?n.push(i):t.set(s,[i])}return t}function mapSubgraphInputsAndLinks(u,t){const i=groupResolvedByOutput(u),s=[];for(const[,n]of i){const o=[];for(const L of n){const{link:E,input:S}=L;if(!S)continue;const T=E.asSerialisable();T.origin_id=SUBGRAPH_INPUT_ID,T.origin_slot=s.length,t.push(T),o.push(T)}const{input:r}=n[0];if(!r)continue;const{color_off:a,color_on:l,dir:h,hasErrors:c,label:p,localized_name:f,name:g,shape:_,type:m}=r,y=nextUniqueName(g,s.map(L=>L.name)),w=f?nextUniqueName(f,s.map(L=>L.localized_name??"")):void 0,k={id:createUuidv4(),type:String(m),linkIds:o.map(L=>L.id),name:y,color_off:a,color_on:l,dir:h,label:p,localized_name:w,hasErrors:c,shape:_};s.push(k)}return s}function mapSubgraphOutputsAndLinks(u,t){const i=groupResolvedByOutput(u),s=[];for(const[,n]of i){const o=[];for(const L of n){const{link:E,output:S}=L;if(!S)continue;const T=E.asSerialisable();T.target_id=SUBGRAPH_OUTPUT_ID,T.target_slot=s.length,t.push(T),o.push(T)}const{output:r}=n[0];if(!r)continue;const{color_off:a,color_on:l,dir:h,hasErrors:c,label:p,localized_name:f,name:g,shape:_,type:m}=r,y=nextUniqueName(g,s.map(L=>L.name)),w=f?nextUniqueName(f,s.map(L=>L.localized_name??"")):void 0,k={id:createUuidv4(),type:String(m),linkIds:o.map(L=>L.id),name:y,color_off:a,color_on:l,dir:h,label:p,localized_name:w,hasErrors:c,shape:_};s.push(structuredClone(k))}return s}function getDirectSubgraphIds(u){const t=new Set;for(const i of u._nodes)i.isSubgraphNode()&&t.add(i.type);return t}function findUsedSubgraphIds(u,t){const i=new Set,s=[u];for(;s.length>0;){const n=s.shift(),o=getDirectSubgraphIds(n);for(const r of o)if(!i.has(r)){i.add(r);const a=t.get(r);a&&s.push(a)}}return i}function isSubgraphInput(u){return u!=null&&typeof u=="object"&&"parent"in u&&u.parent instanceof SubgraphInputNode}function isSubgraphOutput(u){return u!=null&&typeof u=="object"&&"parent"in u&&u.parent instanceof SubgraphOutputNode}function isNodeSlot(u){return u!=null&&typeof u=="object"&&("link"in u||"links"in u)}class NodeInputSlot extends NodeSlot{constructor(i,s){super(i,s);d(this,"link");P(this,ce);this.link=i.link}get isWidgetInputSlot(){return!!this.widget}get _widget(){var i;return(i=I(this,ce))==null?void 0:i.deref()}set _widget(i){U(this,ce,i?new WeakRef(i):void 0)}get collapsedPos(){return[0,LiteGraph.NODE_TITLE_HEIGHT*-.5]}get isConnected(){return this.link!=null}isValidTarget(i){return"links"in i?LiteGraph.isValidConnection(i.type,this.type):isSubgraphInput(i)?LiteGraph.isValidConnection(i.type,this.type):!1}draw(i,s){const{textAlign:n}=i;i.textAlign="left",super.draw(i,{...s,labelPosition:LabelPosition.Right,doStroke:!1}),i.textAlign=n}}ce=new WeakMap;class NodeOutputSlot extends NodeSlot{constructor(i,s){super(i,s);P(this,ue);d(this,"links");d(this,"_data");d(this,"slot_index");this.links=i.links,this._data=i._data,this.slot_index=i.slot_index,U(this,ue,s)}get isWidgetInputSlot(){return!1}get collapsedPos(){return[I(this,ue)._collapsed_width??LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT*-.5]}isValidTarget(i){return"link"in i?LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}get isConnected(){return this.links!=null&&this.links.length>0}draw(i,s){const{textAlign:n,strokeStyle:o}=i;i.textAlign="right",i.strokeStyle="black",super.draw(i,{...s,labelPosition:LabelPosition.Left,doStroke:!0}),i.textAlign=n,i.strokeStyle=o}}ue=new WeakMap;function shallowCloneCommonProps(u){const{color_off:t,color_on:i,dir:s,label:n,localized_name:o,locked:r,name:a,nameLocked:l,removable:h,shape:c,type:p}=u;return{color_off:t,color_on:i,dir:s,label:n,localized_name:o,locked:r,name:a,nameLocked:l,removable:h,shape:c,type:p}}function inputAsSerialisable(u){const{link:t}=u,i=u.widget?{widget:{name:u.widget.name}}:{pos:u.pos};return{...shallowCloneCommonProps(u),...i,link:t}}function outputAsSerialisable(u){const{pos:t,slot_index:i,links:s,widget:n}=u,o=n?{widget:{name:n.name}}:null;return{...shallowCloneCommonProps(u),...o,pos:t,slot_index:i,links:s}}function isINodeInputSlot(u){return"link"in u}function isWidgetInputSlot(u){return!!u.widget}const UNIQUE_MESSAGE_LIMIT=1e4,sentWarnings=new Set;function warnDeprecated(u,t){if(!LiteGraph.alwaysRepeatWarnings){if(sentWarnings.has(u)||sentWarnings.size>UNIQUE_MESSAGE_LIMIT)return;sentWarnings.add(u)}for(const i of LiteGraph.onDeprecationWarning)i(u,t)}function distributeSpace(u,t){if(t.length===0)return[];const i=t.reduce((o,r)=>o+r.minSize,0);if(u<i)return t.map(o=>o.minSize);let s=t.map(o=>({computedSize:o.minSize,maxSize:o.maxSize??1/0,remaining:(o.maxSize??1/0)-o.minSize})),n=u-i;for(;n>0&&s.some(o=>o.remaining>0);){const o=s.filter(l=>l.remaining>0).length;if(o===0)break;const r=n/o;let a=0;if(s=s.map(l=>{if(l.remaining<=0)return l;const h=Math.min(r,l.remaining);return a+=h,{...l,computedSize:l.computedSize+h,remaining:l.remaining-h}}),n-=a,a===0)break}return s.map(({computedSize:o})=>o)}function truncateText(u,t,i,s="..."){if(u.measureText(t).width<=i||i<=0)return t;const o=u.measureText(s).width,r=i-o;if(r<=0)return s;let a=0,l=t.length,h=0;for(;a<=l;){const c=Math.floor((a+l)/2),p=t.substring(0,c);u.measureText(p).width<=r?(h=c,a=c+1):l=c-1}return t.substring(0,h)+s}function toClass(u,...t){return t[0]instanceof u?t[0]:new u(...t)}const Lt=class Lt{constructor(t,i){P(this,pe);d(this,"linkedWidgets");d(this,"name");d(this,"options");d(this,"label");d(this,"type");d(this,"y",0);d(this,"last_y");d(this,"width");d(this,"disabled");d(this,"computedDisabled");d(this,"hidden");d(this,"advanced");d(this,"tooltip");d(this,"element");P(this,fe);U(this,pe,i??t.node),this.name=t.name,this.options=t.options,this.type=t.type;const{node:s,outline_color:n,background_color:o,height:r,text_color:a,secondary_text_color:l,disabledTextColor:h,displayName:c,displayValue:p,labelBaseline:f,...g}=t;Object.assign(this,g)}get node(){return I(this,pe)}get value(){return I(this,fe)}set value(t){U(this,fe,t)}get outline_color(){return this.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR}get background_color(){return LiteGraph.WIDGET_BGCOLOR}get height(){return LiteGraph.NODE_WIDGET_HEIGHT}get text_color(){return LiteGraph.WIDGET_TEXT_COLOR}get secondary_text_color(){return LiteGraph.WIDGET_SECONDARY_TEXT_COLOR}get disabledTextColor(){return LiteGraph.WIDGET_DISABLED_TEXT_COLOR}get displayName(){return this.label||this.name}get _displayValue(){return this.computedDisabled?"":String(this.value)}get labelBaseline(){return this.y+this.height*.7}drawWidgetShape(t,{width:i,showText:s}){const{height:n,y:o}=this,{margin:r}=Lt;t.textAlign="left",t.strokeStyle=this.outline_color,t.fillStyle=this.background_color,t.beginPath(),s?t.roundRect(r,o,i-r*2,n,[n*.5]):t.rect(r,o,i-r*2,n),t.fill(),s&&!this.computedDisabled&&t.stroke()}drawTruncatingText({ctx:t,width:i,leftPadding:s=5,rightPadding:n=20}){const{height:o,y:r}=this,{margin:a}=Lt,{displayName:l,_displayValue:h}=this,c=t.measureText(l).width,p=t.measureText(h).width,f=Lt.labelValueGap,g=a*2+s,_=i-g-2*a-n,m=c+f+p,y=new Rectangle(g,r,_,o*.7);if(t.fillStyle=this.secondary_text_color,m<=_)drawTextInArea({ctx:t,text:l,area:y,align:"left"});else if(LiteGraph.truncateWidgetTextEvenly){const w=(_-f)/(m-f);y.width=c*w,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+_,y.setWidthRightAnchored(p*w)}else if(LiteGraph.truncateWidgetValuesFirst){const w=Math.min(c,_);y.width=w,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+_,y.setWidthRightAnchored(Math.max(_-f-w,0))}else{const w=Math.min(p,_);y.width=Math.max(_-f-w,0),drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+_,y.setWidthRightAnchored(w)}t.fillStyle=this.text_color,drawTextInArea({ctx:t,text:h,area:y,align:"right"})}setValue(t,{e:i,node:s,canvas:n}){var l,h,c;const o=this.value;if(t===this.value)return;const r=this.type==="number"?Number(t):t;this.value=r,(l=this.options)!=null&&l.property&&s.properties[this.options.property]!==void 0&&s.setProperty(this.options.property,r);const a=n.graph_mouse;(h=this.callback)==null||h.call(this,this.value,n,s,a,i),(c=s.onWidgetChanged)==null||c.call(s,this.name??"",r,o,this),s.graph&&s.graph._version++}createCopyForNode(t){const i=new this.constructor(this,t);return i.value=this.value,i}};pe=new WeakMap,fe=new WeakMap,d(Lt,"margin",15),d(Lt,"arrowMargin",6),d(Lt,"arrowWidth",10),d(Lt,"minValueWidth",42),d(Lt,"labelValueGap",5);let BaseWidget=Lt;class BooleanWidget extends BaseWidget{constructor(){super(...arguments);d(this,"type","toggle")}drawWidget(i,{width:s,showText:n=!0}){const{height:o,y:r}=this,{margin:a}=BaseWidget;this.drawWidgetShape(i,{width:s,showText:n}),i.fillStyle=this.value?"#89A":"#333",i.beginPath(),i.arc(s-a*2,r+o*.5,o*.36,0,Math.PI*2),i.fill(),n&&(this.drawLabel(i,a*2),this.drawValue(i,s-40))}drawLabel(i,s){i.fillStyle=this.secondary_text_color;const{displayName:n}=this;n&&i.fillText(n,s,this.labelBaseline)}drawValue(i,s){i.fillStyle=this.value?this.text_color:this.secondary_text_color,i.textAlign="right";const n=this.value?this.options.on||"true":this.options.off||"false";i.fillText(n,s,this.labelBaseline)}onClick(i){this.setValue(!this.value,i)}}class ButtonWidget extends BaseWidget{constructor(i,s){super(i,s);d(this,"type","button");d(this,"clicked");this.clicked??(this.clicked=!1)}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:h}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,this.clicked&&(i.fillStyle="#AAA",this.clicked=!1),i.fillRect(c,h,s-c*2,l),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,h,s-c*2,l)),n&&this.drawLabel(i,s*.5),Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}drawLabel(i,s){i.textAlign="center",i.fillStyle=this.text_color,i.fillText(this.displayName,s,this.y+this.height*.7)}onClick({e:i,node:s,canvas:n}){var r;const o=n.graph_mouse;this.clicked=!0,n.setDirty(!0),(r=this.callback)==null||r.call(this,this,n,s,o,i)}}class BaseSteppedWidget extends BaseWidget{drawArrowButtons(t,i){const{height:s,text_color:n,disabledTextColor:o,y:r}=this,{arrowMargin:a,arrowWidth:l,margin:h}=BaseWidget,c=h+a,p=c+l;t.fillStyle=this.canDecrement()?n:o,t.beginPath(),t.moveTo(p,r+5),t.lineTo(c,r+s*.5),t.lineTo(p,r+s-5),t.fill(),t.fillStyle=this.canIncrement()?n:o,t.beginPath(),t.moveTo(i-p,r+5),t.lineTo(i-c,r+s*.5),t.lineTo(i-p,r+s-5),t.fill()}drawWidget(t,i){const{fillStyle:s,strokeStyle:n,textAlign:o}=t;this.drawWidgetShape(t,i),i.showText&&(this.computedDisabled||this.drawArrowButtons(t,i.width),this.drawTruncatingText({ctx:t,width:i.width})),Object.assign(t,{textAlign:o,strokeStyle:n,fillStyle:s})}}function toArray(u){return Array.isArray(u)?u:Object.keys(u)}class ComboWidget extends BaseSteppedWidget{constructor(){super(...arguments);P(this,_t);d(this,"type","combo")}get _displayValue(){if(this.computedDisabled)return"";const{values:i}=this.options;if(i){const s=typeof i=="function"?i():i;if(s&&!Array.isArray(s))return s[this.value]}return typeof this.value=="number"?String(this.value):this.value}canIncrement(){return N(this,_t,Qe).call(this,!0)}canDecrement(){return N(this,_t,Qe).call(this,!1)}incrementValue(i){N(this,_t,ti).call(this,1,i)}decrementValue(i){N(this,_t,ti).call(this,-1,i)}onClick({e:i,node:s,canvas:n}){const o=i.canvasX-s.pos[0],r=this.width||s.size[0];if(typeof this.options.values=="function"&&warnDeprecated("Using a function for values is deprecated. Use an array of unique values instead."),o<40)return this.decrementValue({e:i,node:s,canvas:n});if(o>r-40)return this.incrementValue({e:i,node:s,canvas:n});const a=N(this,_t,Je).call(this,s),l=toArray(a),h=a!=l?Object.values(a):a;new LiteGraph.ContextMenu(h,{scale:Math.max(1,n.ds.scale),event:i,className:"dark",callback:c=>{this.setValue(a!=l?h.indexOf(c):c,{e:i,node:s,canvas:n})}})}}_t=new WeakSet,Je=function(i){const{values:s}=this.options;if(s==null)throw new Error("[ComboWidget]: values is required");return typeof s=="function"?s(this,i):s},Qe=function(i){const{values:s}=this.options;if(typeof s=="function")return!1;const n=toArray(s);if(!(n.length>1))return!1;const o=n.at(0),r=n.at(-1);return o===r?!0:this.value!==(i?r:o)},ti=function(i,s){const n=N(this,_t,Je).call(this,s.node),o=toArray(n);s.canvas.last_mouseclick=0;const r=typeof n=="object"?o.indexOf(String(this.value))+i:o.indexOf(this.value)+i,a=clamp(r,0,o.length-1),l=Array.isArray(n)?n[a]:a;this.setValue(l,s)};function getWidgetStep(u){return u.step2||(u.step||10)*.1}class KnobWidget extends BaseWidget{constructor(){super(...arguments);d(this,"type","knob");d(this,"current_drag_offset",0)}computeLayoutSize(){return{minHeight:60,minWidth:20,maxHeight:1e6,maxWidth:1e6}}get height(){return this.computedHeight||super.height}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{y:l}=this,{margin:h}=BaseWidget,{gradient_stops:c="rgb(14, 182, 201); rgb(0, 216, 72)"}=this.options,p=this.computedHeight||this.height,f=Math.min(this.computedHeight||this.height,this.width||20)/20,g={x:s/2,y:p/2+l};i.lineWidth=(Math.min(s,p)-h*f)/6;const _=(Math.min(s,p)-h*f-i.lineWidth)/2;{const S=i.createRadialGradient(g.x,g.y,_+i.lineWidth,0,0,_+i.lineWidth);S.addColorStop(0,"rgb(29, 29, 29)"),S.addColorStop(1,"rgb(116, 116, 116)"),i.fillStyle=S}i.beginPath(),i.arc(g.x,g.y,_+i.lineWidth/2,0,Math.PI*2,!1),i.fill(),i.closePath();const m={start_angle:Math.PI*.6,end_angle:Math.PI*2.4};i.beginPath();{const S=i.createRadialGradient(g.x,g.y,_+i.lineWidth,0,0,_+i.lineWidth);S.addColorStop(0,"rgb(99, 99, 99)"),S.addColorStop(1,"rgb(36, 36, 36)"),i.strokeStyle=S}i.arc(g.x,g.y,_,m.start_angle,m.end_angle,!1),i.stroke(),i.closePath();const y=this.options.max-this.options.min;let w=(this.value-this.options.min)/y;w=clamp(w,0,1),i.beginPath();const k=i.createConicGradient(m.start_angle,g.x,g.y),L=c.split(";");for(const[S,T]of L.entries())k.addColorStop(S,T.trim());i.strokeStyle=k;const E=(m.end_angle-m.start_angle)*w+m.start_angle;if(i.arc(g.x,g.y,_,m.start_angle,E,!1),i.stroke(),i.closePath(),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.beginPath(),i.strokeStyle=this.outline_color,i.arc(g.x,g.y,_+i.lineWidth/2,0,Math.PI*2,!1),i.lineWidth=1,i.stroke(),i.closePath()),n){i.textAlign="center",i.fillStyle=this.text_color;const S=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}
${S}`,s*.5,l+p*.5)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(){this.current_drag_offset=0}onDrag(i){if(this.options.read_only)return;const{e:s}=i,n=getWidgetStep(this.options),o=this.options.max-this.options.min,r=o/10,a=o/100,l={shift:r>n?r-r%n:n,delta_y:a>n?a-a%n:n},h=Math.abs(s.movementY)>Math.abs(s.movementX),c=h?-s.movementY:s.movementX,p=15;this.current_drag_offset+=c;let f=0;this.current_drag_offset>p?(f+=1,this.current_drag_offset-=p):this.current_drag_offset<-15&&(f-=1,this.current_drag_offset+=p);const g=s.shiftKey?l.shift:h?l.delta_y:n,_=f*g,m=clamp(this.value+_,this.options.min,this.options.max);m!==this.value&&this.setValue(m,i)}}class LegacyWidget extends BaseWidget{drawWidget(t,i){var n;const s=LiteGraph.NODE_WIDGET_HEIGHT;(n=this.draw)==null||n.call(this,t,this.node,i.width,this.y,s,!!i.showText)}onClick(){console.warn("Custom widget wrapper onClick was just called. Handling for third party widgets is done via LGraphCanvas - the mouse callback.")}}class NumberWidget extends BaseSteppedWidget{constructor(){super(...arguments);d(this,"type","number")}get _displayValue(){return this.computedDisabled?"":Number(this.value).toFixed(this.options.precision!==void 0?this.options.precision:3)}canIncrement(){const{max:t}=this.options;return t==null||this.value<t}canDecrement(){const{min:t}=this.options;return t==null||this.value>t}incrementValue(t){this.setValue(this.value+getWidgetStep(this.options),t)}decrementValue(t){this.setValue(this.value-getWidgetStep(this.options),t)}setValue(t,i){let s=t;this.options.min!=null&&s<this.options.min&&(s=this.options.min),this.options.max!=null&&s>this.options.max&&(s=this.options.max),super.setValue(s,i)}onClick({e,node,canvas}){const x=e.canvasX-node.pos[0],width=this.width||node.size[0],delta=x<40?-1:x>width-40?1:0;if(delta){this.setValue(this.value+delta*getWidgetStep(this.options),{e,node,canvas});return}canvas.prompt("Value",this.value,v=>{if(/^[\d\s()*+/-]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch{}const newValue=Number(v);isNaN(newValue)||this.setValue(newValue,{e,node,canvas})},e)}onDrag({e:t,node:i,canvas:s}){const n=this.width||i.width,o=t.canvasX-i.pos[0];(o<40||o>n-40)&&o>-3&&o<n+3||this.setValue(this.value+(t.deltaX??0)*getWidgetStep(this.options),{e:t,node:i,canvas:s})}}class SliderWidget extends BaseWidget{constructor(){super(...arguments);d(this,"type","slider");d(this,"marker")}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:h}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,i.fillRect(c,h,s-c*2,l);const p=this.options.max-this.options.min;let f=(this.value-this.options.min)/p;if(f=clamp(f,0,1),i.fillStyle=this.options.slider_color??"#678",i.fillRect(c,h,f*(s-c*2),l),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,h,s-c*2,l)),this.marker!=null){let g=(this.marker-this.options.min)/p;g=clamp(g,0,1),i.fillStyle=this.options.marker_color??"#AA9",i.fillRect(c+g*(s-c*2),h,2,l)}if(n){i.textAlign="center",i.fillStyle=this.text_color;const g=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}  ${g}`,s*.5,h+l*.7)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(i){if(this.options.read_only)return;const{e:s,node:n}=i,o=this.width||n.size[0],r=s.canvasX-n.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}onDrag(i){if(this.options.read_only)return!1;const{e:s,node:n}=i,o=this.width||n.size[0],r=s.canvasX-n.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}}class TextWidget extends BaseWidget{constructor(t,i){var s;super(t,i),this.type??(this.type="string"),this.value=((s=t.value)==null?void 0:s.toString())??""}drawWidget(t,{width:i,showText:s=!0}){const{fillStyle:n,strokeStyle:o,textAlign:r}=t;this.drawWidgetShape(t,{width:i,showText:s}),s&&this.drawTruncatingText({ctx:t,width:i,leftPadding:0,rightPadding:0}),Object.assign(t,{textAlign:r,strokeStyle:o,fillStyle:n})}onClick({e:t,node:i,canvas:s}){var n;s.prompt("Value",this.value,o=>{o!==null&&this.setValue(o,{e:t,node:i,canvas:s})},t,((n=this.options)==null?void 0:n.multiline)??!1)}}function toConcreteWidget(u,t,i=!0){if(u instanceof BaseWidget)return u;const s=u;switch(s.type){case"button":return toClass(ButtonWidget,s,t);case"toggle":return toClass(BooleanWidget,s,t);case"slider":return toClass(SliderWidget,s,t);case"knob":return toClass(KnobWidget,s,t);case"combo":return toClass(ComboWidget,s,t);case"number":return toClass(NumberWidget,s,t);case"string":return toClass(TextWidget,s,t);case"text":return toClass(TextWidget,s,t);default:if(i)return toClass(LegacyWidget,u,t)}}const rt=class rt{constructor(t,i){P(this,K);d(this,"title");d(this,"graph",null);d(this,"id");d(this,"type","");d(this,"inputs",[]);d(this,"outputs",[]);P(this,Ct,[]);P(this,At,[]);d(this,"properties",{});d(this,"properties_info",[]);d(this,"flags",{});d(this,"widgets");d(this,"freeWidgetSpace");d(this,"locked");d(this,"order",0);d(this,"mode",LGraphEventMode.ALWAYS);d(this,"last_serialization");d(this,"serialize_widgets");d(this,"color");d(this,"bgcolor");d(this,"boxcolor");d(this,"strokeStyles");d(this,"progress");d(this,"exec_version");d(this,"action_call");d(this,"execute_triggered");d(this,"action_triggered");d(this,"widgets_up");d(this,"widgets_start_y");d(this,"lostFocusAt");d(this,"gotFocusAt");d(this,"badges",[]);d(this,"title_buttons",[]);d(this,"badgePosition",BadgePosition.TopLeft);d(this,"_collapsed_width");d(this,"console");d(this,"_level");d(this,"_shape");d(this,"mouseOver");d(this,"redraw_on_mouse");d(this,"resizable");d(this,"clonable");d(this,"_relative_id");d(this,"clip_area");d(this,"ignore_remove");d(this,"has_errors");d(this,"removable");d(this,"block_delete");d(this,"selected");d(this,"showAdvanced");P(this,ge,new Float32Array(4));P(this,_e,new Rectangle);d(this,"_posSize",new Float32Array(4));d(this,"_pos",this._posSize.subarray(0,2));d(this,"_size",this._posSize.subarray(2,4));this.id=LiteGraph.use_uuids?LiteGraph.uuidv4():-1,this.title=t||"Unnamed",this.type=i??"",this.size=[LiteGraph.NODE_WIDTH,60],this.pos=[10,10],this.strokeStyles={error:N(this,K,mi),selected:N(this,K,yi)},this.onMouseDown=(s,n,o)=>{var r;if((r=this.title_buttons)!=null&&r.length&&!this.flags.collapsed){const a=n[0],l=n[1];for(let h=0;h<this.title_buttons.length;h++){const c=this.title_buttons[h];if(c.visible&&c.isPointInside(a,l))return this.onTitleButtonClick(c,o),!0}}return!1}}get titleFontStyle(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get innerFontStyle(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get displayType(){return this.type}get renderingColor(){return this.color||this.constructor.color||LiteGraph.NODE_DEFAULT_COLOR}get renderingBgColor(){return this.bgcolor||this.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR}get renderingBoxColor(){if(this.boxcolor)return this.boxcolor;if(LiteGraph.node_box_coloured_when_on){if(this.action_triggered)return"#FFF";if(this.execute_triggered)return"#AAA"}if(LiteGraph.node_box_coloured_by_mode){const t=LiteGraph.NODE_MODES_COLORS[this.mode??LGraphEventMode.ALWAYS];if(t)return t}return LiteGraph.NODE_DEFAULT_BOXCOLOR}setColorOption(t){t==null?(delete this.color,delete this.bgcolor):(this.color=t.color,this.bgcolor=t.bgcolor)}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.color===this.color&&t.bgcolor===this.bgcolor)??null}isSubgraphNode(){return!1}get renderArea(){return I(this,ge)}get boundingRect(){return I(this,_e)}get boundingOffset(){const{pos:[t,i],boundingRect:[s,n]}=this;return[t-s,i-n]}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=t[0],this._size[1]=t[1])}get renderingSize(){return this.flags.collapsed?[this._collapsed_width??0,0]:this._size}get shape(){return this._shape}set shape(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=RenderShape.BOX;break;case"round":this._shape=RenderShape.ROUND;break;case"circle":this._shape=RenderShape.CIRCLE;break;case"card":this._shape=RenderShape.CARD;break;default:this._shape=t}}get renderingShape(){return this._shape||this.constructor.shape||LiteGraph.NODE_DEFAULT_SHAPE}get is_selected(){return this.selected}set is_selected(t){this.selected=t}get title_mode(){return this.constructor.title_mode??TitleMode.NORMAL_TITLE}configure(t){var i,s,n,o,r,a,l,h,c,p;this.graph&&this.graph._version++;for(const f in t){if(f=="properties"){for(const g in t.properties)this.properties[g]=t.properties[g],(i=this.onPropertyChanged)==null||i.call(this,g,t.properties[g]);continue}t[f]!=null&&(typeof t[f]=="object"?(s=this[f])!=null&&s.configure?(n=this[f])==null||n.configure(t[f]):this[f]=LiteGraph.cloneObject(t[f],this[f]):this[f]=t[f])}t.title||(this.title=this.constructor.title),this.inputs??(this.inputs=[]),this.inputs=this.inputs.map(f=>toClass(NodeInputSlot,f,this));for(const[f,g]of this.inputs.entries()){const _=this.graph&&g.link!=null?this.graph._links.get(g.link):null;(o=this.onConnectionsChange)==null||o.call(this,NodeSlotType.INPUT,f,!0,_,g),(r=this.onInputAdded)==null||r.call(this,g)}this.outputs??(this.outputs=[]),this.outputs=this.outputs.map(f=>toClass(NodeOutputSlot,f,this));for(const[f,g]of this.outputs.entries())if(g.links){for(const _ of g.links){const m=this.graph?this.graph._links.get(_):null;(a=this.onConnectionsChange)==null||a.call(this,NodeSlotType.OUTPUT,f,!0,m,g)}(l=this.onOutputAdded)==null||l.call(this,g)}if((h=this._internalConfigureAfterSlots)==null||h.call(this),this.widgets){for(const f of this.widgets)f&&(c=f.options)!=null&&c.property&&this.properties[f.options.property]!=null&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property])));if(t.widgets_values){const f=this.widgets.filter(g=>g.serialize!==!1);for(let g=0;g<t.widgets_values.length;++g){const _=f[g];_&&(_.value=t.widgets_values[g])}}}this.pinned&&(this.resizable=!1),(p=this.onConfigure)==null||p.call(this,t)}serialize(){var s;const t={id:this.id,type:this.type,pos:[this.pos[0],this.pos[1]],size:[this.size[0],this.size[1]],flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode,showAdvanced:this.showAdvanced};if(this.constructor===rt&&this.last_serialization)return this.last_serialization;this.inputs&&(t.inputs=this.inputs.map(n=>inputAsSerialisable(n))),this.outputs&&(t.outputs=this.outputs.map(n=>outputAsSerialisable(n))),this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties));const{widgets:i}=this;if(i&&this.serialize_widgets){t.widgets_values=[];for(const[n,o]of i.entries())o.serialize!==!1&&(t.widgets_values[n]=o?o.value:null)}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),(s=this.onSerialize)!=null&&s.call(this,t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){if(this.type==null)return null;const t=LiteGraph.createNode(this.type);if(!t)return null;const i=LiteGraph.cloneObject(this.serialize()),{inputs:s,outputs:n}=i;if(s)for(const o of s)o.link=null;if(n)for(const{links:o}of n)o&&(o.length=0);return delete i.id,LiteGraph.use_uuids&&(i.id=LiteGraph.uuidv4()),t.configure(i),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,i){var n;if(this.properties||(this.properties={}),i===this.properties[t])return;const s=this.properties[t];if(this.properties[t]=i,((n=this.onPropertyChanged)==null?void 0:n.call(this,t,i,s))===!1&&(this.properties[t]=s),this.widgets){for(const o of this.widgets)if(o&&o.options.property==t){o.value=i;break}}}setOutputData(t,i){const{outputs:s}=this;if(!s||t==-1||t>=s.length)return;const n=s[t];if(!n)return;if(n._data=i,!this.graph)throw new NullGraphError;const{links:o}=s[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.data=i)}}setOutputDataType(t,i){const{outputs:s}=this;if(!s||t==-1||t>=s.length)return;const n=s[t];if(!n)return;if(n.type=i,!this.graph)throw new NullGraphError;const{links:o}=s[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.type=i)}}getInputData(t,i){var r;if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return;if(!this.graph)throw new NullGraphError;const s=this.inputs[t].link,n=this.graph._links.get(s);if(!n)return null;if(!i)return n.data;const o=this.graph.getNodeById(n.origin_id);return o&&(o.updateOutputData?o.updateOutputData(n.origin_slot):(r=o.onExecute)==null||r.call(o)),n.data}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;if(!this.graph)throw new NullGraphError;const i=this.inputs[t].link,s=this.graph._links.get(i);if(!s)return null;const n=this.graph.getNodeById(s.origin_id);if(!n)return s.type;const o=n.outputs[s.origin_slot];return o?o.type:null}getInputDataByName(t,i){const s=this.findInputSlot(t);return s==-1?null:this.getInputData(s,i)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return!this.inputs||!(t<this.inputs.length)?null:this.inputs[t]}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){if(!this.graph)throw new NullGraphError;const i=this.inputs[t];if(i.link!=null)return this.graph._links.get(i.link)??null}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;const i=this.inputs[t];if(!i||i.link===null)return null;if(!this.graph)throw new NullGraphError;const s=this.graph._links.get(i.link);return s?this.graph.getNodeById(s.origin_id):null}getInputOrProperty(t){const{inputs:i}=this;if(!(i!=null&&i.length))return this.properties?this.properties[t]:null;if(!this.graph)throw new NullGraphError;for(const s of i)if(t==s.name&&s.link!=null){const n=this.graph._links.get(s.link);if(n)return n.data}return this.properties[t]}getOutputData(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data}getOutputInfo(t){return!this.outputs||!(t<this.outputs.length)?null:this.outputs[t]}isOutputConnected(t){var i;return this.outputs?t<this.outputs.length&&Number((i=this.outputs[t].links)==null?void 0:i.length)>0:!1}isAnyOutputConnected(){var i;const{outputs:t}=this;if(!t)return!1;for(const s of t)if((i=s.links)!=null&&i.length)return!0;return!1}getOutputNodes(t){const{outputs:i}=this;if(!i||i.length==0||t>=i.length)return null;const{links:s}=i[t];if(!s||s.length==0)return null;if(!this.graph)throw new NullGraphError;const n=[];for(const o of s){const r=this.graph._links.get(o);if(r){const a=this.graph.getNodeById(r.target_id);a&&n.push(a)}}return n}addOnTriggerInput(){const t=this.findInputSlot("onTrigger");return t==-1?(this.addInput("onTrigger",LiteGraph.EVENT,{nameLocked:!0}),this.findInputSlot("onTrigger")):t}addOnExecutedOutput(){const t=this.findOutputSlot("onExecuted");return t==-1?(this.addOutput("onExecuted",LiteGraph.ACTION,{nameLocked:!0}),this.findOutputSlot("onExecuted")):t}onAfterExecuteNode(t,i){const s=this.findOutputSlot("onExecuted");s!=-1&&this.triggerSlot(s,t,null,i)}changeMode(t){switch(t){case LGraphEventMode.ON_EVENT:break;case LGraphEventMode.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LGraphEventMode.NEVER:break;case LGraphEventMode.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,i){var s;if(i=i||{},this.onExecute){if(i.action_call||(i.action_call=`${this.id}_exec_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_executing[this.id]=!0,this.onExecute(t,i),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,i!=null&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call)}this.execute_triggered=2,(s=this.onAfterExecuteNode)==null||s.call(this,t,i)}actionDo(t,i,s){var n;if(s=s||{},this.onAction){if(s.action_call||(s.action_call=`${this.id}_${t||"action"}_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,i,s),this.graph.nodes_actioning[this.id]=!1,s!=null&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)}this.action_triggered=2,(n=this.onAfterExecuteNode)==null||n.call(this,i,s)}trigger(t,i,s){const{outputs:n}=this;if(!(!n||!n.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(const[o,r]of n.entries())!r||r.type!==LiteGraph.EVENT||t&&r.name!=t||this.triggerSlot(o,i,null,s)}}triggerSlot(t,i,s,n){var a;if(n=n||{},!this.outputs)return;if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const o=this.outputs[t];if(!o)return;const r=o.links;if(!(!r||!r.length)){if(!this.graph)throw new NullGraphError;this.graph._last_trigger_time=LiteGraph.getTime();for(const l of r){if(s!=null&&s!=l)continue;const h=this.graph._links.get(l);if(!h)continue;h._last_time=LiteGraph.getTime();const c=this.graph.getNodeById(h.target_id);if(c){if(c.mode===LGraphEventMode.ON_TRIGGER)n.action_call||(n.action_call=`${this.id}_trigg_${Math.floor(Math.random()*9999)}`),(a=c.doExecute)==null||a.call(c,i,n);else if(c.onAction){n.action_call||(n.action_call=`${this.id}_act_${Math.floor(Math.random()*9999)}`);const p=c.inputs[h.target_slot];c.actionDo(p.name,i,n)}}}}}clearTriggeredSlot(t,i){if(!this.outputs)return;const s=this.outputs[t];if(!s)return;const n=s.links;if(!(!n||!n.length)){if(!this.graph)throw new NullGraphError;for(const o of n){if(i!=null&&i!=o)continue;const r=this.graph._links.get(o);r&&(r._last_time=0)}}}setSize(t){var i;this.size=t,(i=this.onResize)==null||i.call(this,this.size)}expandToFitContent(){const t=this.computeSize();this.setSize([Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])])}addProperty(t,i,s,n){const o={name:t,type:s,default_value:i};return n&&Object.assign(o,n),this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=i,o}addOutput(t,i,s){var o;const n=Object.assign(new NodeOutputSlot({name:t,type:i,links:null},this),s);return this.outputs||(this.outputs=[]),this.outputs.push(n),(o=this.onOutputAdded)==null||o.call(this,n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i,!0),this.expandToFitContent(),this.setDirtyCanvas(!0,!0),n}removeOutput(t){var s;this.disconnectOutput(t);const{outputs:i}=this;i.splice(t,1);for(let n=t;n<i.length;++n){const o=i[n];if(!(!o||!o.links))for(const r of o.links){if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r);a&&a.origin_slot--}}(s=this.onOutputRemoved)==null||s.call(this,t),this.setDirtyCanvas(!0,!0)}addInput(t,i,s){var o;i||(i=0);const n=Object.assign(new NodeInputSlot({name:t,type:i,link:null},this),s);return this.inputs||(this.inputs=[]),this.inputs.push(n),this.expandToFitContent(),(o=this.onInputAdded)==null||o.call(this,n),LiteGraph.registerNodeAndSlotType(this,i),this.setDirtyCanvas(!0,!0),n}removeInput(t){var n;this.disconnectInput(t,!0);const{inputs:i}=this,s=i.splice(t,1);for(let o=t;o<i.length;++o){const r=i[o];if(!(r!=null&&r.link))continue;if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r.link);a&&a.target_slot--}(n=this.onInputRemoved)==null||n.call(this,t,s[0]),this.setDirtyCanvas(!0,!0)}computeSize(t){const i=this.constructor.size;if(i)return[i[0],i[1]];const{inputs:s,outputs:n,widgets:o}=this;let r=Math.max(s?s.filter(T=>!isWidgetInputSlot(T)).length:1,n?n.length:1);const a=t||new Float32Array([0,0]);r=Math.max(r,1);const l=LiteGraph.NODE_TEXT_SIZE,h=LiteGraph.NODE_TITLE_HEIGHT,c=h*.33,p=h+S(this.title,this.titleFontStyle)+c;let f=0,g=0,_=0;if(s)for(const T of s){const G=T.label||T.localized_name||T.name||"",D=S(G,this.innerFontStyle);if(isWidgetInputSlot(T)){const C=this.getWidgetFromSlot(T);if(C&&!this.isWidgetVisible(C))continue;D>g&&(g=D)}else D>f&&(f=D)}if(n)for(const T of n){const G=T.label||T.localized_name||T.name||"",D=S(G,this.innerFontStyle);_<D&&(_=D)}const m=LiteGraph.NODE_WIDTH*(o!=null&&o.length?1.5:1),y=f&&_?5:0,w=f+_+2*LiteGraph.NODE_SLOT_HEIGHT+y,k=BaseWidget.margin+BaseWidget.arrowMargin+BaseWidget.arrowWidth,L=BaseWidget.minValueWidth+2*k;g&&(g+=L),a[0]=Math.max(w,g,p,m),a[1]=(this.constructor.slot_start_y||0)+r*LiteGraph.NODE_SLOT_HEIGHT;let E=0;if(o!=null&&o.length){for(const T of o){if(!this.isWidgetVisible(T))continue;let G=0;if(T.computeSize)G+=T.computeSize(a[0])[1];else if(T.computeLayoutSize){const{minHeight:D,minWidth:C}=T.computeLayoutSize(this),R=C+L;R>a[0]&&(a[0]=R),G+=D}else G+=LiteGraph.NODE_WIDGET_HEIGHT;E+=G+4}E+=8}this.widgets_up?a[1]=Math.max(a[1],E):this.widgets_start_y!=null?a[1]=Math.max(a[1],E+this.widgets_start_y):a[1]+=E;function S(T,G){var D;return((D=LGraphCanvas._measureText)==null?void 0:D.call(LGraphCanvas,T,G))??l*((T==null?void 0:T.length)??0)*.6}return this.constructor.min_height&&a[1]<this.constructor.min_height&&(a[1]=this.constructor.min_height),a[1]+=6,a}inResizeCorner(t,i){const s=this.outputs?this.outputs.length:1,n=(this.constructor.slot_start_y||0)+s*LiteGraph.NODE_SLOT_HEIGHT;return isInRectangle(t,i,this.pos[0]+this.size[0]-15,this.pos[1]+Math.max(this.size[1]-15,n),20,20)}findResizeDirection(t,i){if(this.resizable===!1)return;const{boundingRect:s}=this;if(s.containsXy(t,i))return s.findContainingCorner(t,i,rt.resizeHandleSize)}getPropertyInfo(t){var n;let i=null;const{properties_info:s}=this;if(s){for(const o of s)if(o.name==t){i=o;break}}return this.constructor[`@${t}`]&&(i=this.constructor[`@${t}`]),(n=this.constructor.widgets_info)!=null&&n[t]&&(i=this.constructor.widgets_info[t]),!i&&this.onGetPropertyInfo&&(i=this.onGetPropertyInfo(t)),i||(i={}),i.type||(i.type=typeof this.properties[t]),i.widget=="combo"&&(i.type="enum"),i}addWidget(t,i,s,n,o){this.widgets||(this.widgets=[]),!o&&n&&typeof n=="object"&&(o=n,n=null),o||(o={}),typeof o=="string"&&(o={property:o}),n&&typeof n=="string"&&(o.property=n,n=null);const r={type:t.toLowerCase(),name:i,value:s,callback:typeof n!="function"?void 0:n,options:o,y:0};if(r.options.y!==void 0&&(r.y=r.options.y),!n&&!r.options.callback&&!r.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";const a=this.addCustomWidget(r);return this.expandToFitContent(),a}addCustomWidget(t){this.widgets||(this.widgets=[]);const i=toConcreteWidget(t,this,!1)??t;return this.widgets.push(i),i}addTitleButton(t){this.title_buttons||(this.title_buttons=[]);const i=new LGraphButton(t);return this.title_buttons.push(i),i}onTitleButtonClick(t,i){i.dispatch("litegraph:node-title-button-clicked",{node:this,button:t})}removeWidgetByName(t){var s;const i=(s=this.widgets)==null?void 0:s.find(n=>n.name===t);i&&this.removeWidget(i)}removeWidget(t){if(!this.widgets)throw new Error("removeWidget called on node without widgets");const i=this.widgets.indexOf(t);if(i===-1)throw new Error("Widget not found on this node");if(this.inputs)for(const s of this.inputs)s._widget===t&&(s._widget=void 0,delete s.widget);this.widgets.splice(i,1)}ensureWidgetRemoved(t){try{this.removeWidget(t)}catch(i){console.debug("Failed to remove widget",i)}}move(t,i){this.pinned||(this.pos[0]+=t,this.pos[1]+=i)}measure(t,i){var r;const s=this.title_mode,o=s!=TitleMode.TRANSPARENT_TITLE&&s!=TitleMode.NO_TITLE?LiteGraph.NODE_TITLE_HEIGHT:0;t[0]=this.pos[0],t[1]=this.pos[1]+-o,(r=this.flags)!=null&&r.collapsed?(i.font=this.innerFontStyle,this._collapsed_width=Math.min(this.size[0],i.measureText(this.getTitle()??"").width+LiteGraph.NODE_TITLE_HEIGHT*2),t[2]=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,t[3]=LiteGraph.NODE_TITLE_HEIGHT):(t[2]=this.size[0],t[3]=this.size[1]+o)}getBounding(t,i){t||(t=new Float32Array(4));const s=i?this.renderArea:this.boundingRect;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t}updateArea(t){var n;const i=I(this,_e);this.measure(i,t),(n=this.onBounding)==null||n.call(this,i);const s=I(this,ge);s.set(i),s[0]-=4,s[1]-=4,s[2]+=10,s[3]+=9}isPointInside(t,i){return isInRect(t,i,this.boundingRect)}isPointInCollapse(t,i){const s=LiteGraph.NODE_TITLE_HEIGHT;return isInRectangle(t,i,this.pos[0],this.pos[1]-s,s,s)}getInputOnPos(t){var i;return(i=getNodeInputOnPos(this,t[0],t[1]))==null?void 0:i.input}getOutputOnPos(t){var i;return(i=getNodeOutputOnPos(this,t[0],t[1]))==null?void 0:i.output}getSlotOnPos(t){if(isPointInRect(t,this.boundingRect))return this.getInputOnPos(t)??this.getOutputOnPos(t)}getSlotInPosition(t,i){const{inputs:s,outputs:n}=this;if(s)for(const[o,r]of s.entries()){const a=this.getInputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{input:r,slot:o,link_pos:a}}if(n)for(const[o,r]of n.entries()){const a=this.getOutputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{output:r,slot:o,link_pos:a}}return null}getWidgetOnPos(t,i,s=!1){var c;const{widgets:n,pos:o,size:r}=this;if(!(n!=null&&n.length))return;const a=t-o[0],l=i-o[1],h=r[0];for(const p of n){if(p.computedDisabled&&!s||!this.isWidgetVisible(p))continue;const f=p.computedHeight??((c=p.computeSize)==null?void 0:c.call(p,h)[1])??LiteGraph.NODE_WIDGET_HEIGHT,g=p.width||h;if(p.last_y!==void 0&&isInRectangle(a,l,6,p.last_y,g-12,f))return p}}findInputSlot(t,i=!1){const{inputs:s}=this;if(!s)return-1;for(const[n,o]of s.entries())if(t==o.name)return i?o:n;return-1}findOutputSlot(t,i=!1){const{outputs:s}=this;if(!s)return-1;for(const[n,o]of s.entries())if(t==o.name)return i?o:n;return-1}findInputSlotFree(t){return N(this,K,ei).call(this,this.inputs,t)}findOutputSlotFree(t){return N(this,K,ei).call(this,this.outputs,t)}findInputSlotByType(t,i,s,n){return N(this,K,Ne).call(this,this.inputs,t,i,s,n)}findOutputSlotByType(t,i,s,n){return N(this,K,Ne).call(this,this.outputs,t,i,s,n)}findSlotByType(t,i,s,n,o){return t?N(this,K,Ne).call(this,this.inputs,i,s,n,o):N(this,K,Ne).call(this,this.outputs,i,s,n,o)}findConnectByTypeSlot(t,i,s,n){n&&typeof n=="object"&&("firstFreeIfInputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfInputGeneralInCase),"firstFreeIfOutputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfOutputGeneralInCase),"generalTypeInCase"in n&&(n.typedToWildcard=!!n.generalTypeInCase));const r=Object.assign({createEventInCase:!0,wildcardToTyped:!0,typedToWildcard:!0},n);if(!this.graph)throw new NullGraphError;if(i&&typeof i=="number"){const l=this.graph.getNodeById(i);if(!l)return;i=l}const a=i.findSlotByType(t,s,!1,!0);if(a>=0&&a!==null)return a;if(r.createEventInCase&&s==LiteGraph.EVENT){if(t)return-1;if(LiteGraph.do_add_triggers_slots)return i.addOnExecutedOutput()}if(r.typedToWildcard){const l=i.findSlotByType(t,0,!1,!0,!0);if(l>=0)return l}if(r.wildcardToTyped&&(s==0||s=="*"||s=="")){const l={typesNotAccepted:[LiteGraph.EVENT]},h=t?i.findInputSlotFree(l):i.findOutputSlotFree(l);if(h>=0)return h}}findOutputByType(t){return findFreeSlotOfType(this.outputs,t,i=>{var s;return!((s=i.links)!=null&&s.length)})}findInputByType(t){return findFreeSlotOfType(this.inputs,t,i=>i.link==null)}connectByType(t,i,s,n){const o=this.findConnectByTypeSlot(!0,i,s,n);return o!==void 0?this.connect(t,i,o,n==null?void 0:n.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",s,"to node:",i),null)}connectByTypeOutput(t,i,s,n){typeof n=="object"&&("firstFreeIfInputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfInputGeneralInCase),"generalTypeInCase"in n&&(n.typedToWildcard=!!n.generalTypeInCase));const o=this.findConnectByTypeSlot(!1,i,s,n);return o!==void 0?i.connect(o,this,t,n==null?void 0:n.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",s,"to node:",i),null)}canConnectTo(t,i,s){return this.id!==t.id&&LiteGraph.isValidConnection(s.type,i.type)}connect(t,i,s,n){var p;let o;const{graph:r,outputs:a}=this;if(!r)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),null}else if(!a||t>=a.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&typeof i=="number"){const f=r.getNodeById(i);if(!f)throw"target node is null";i=f}if(!i)throw"target node is null";if(i==this)return null;if(typeof s=="string"){if(o=i.findInputSlot(s),o==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${o}`),null}else if(s===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)i.changeMode(LGraphEventMode.ON_TRIGGER),o=i.findInputSlot("onTrigger");else return null;else typeof s=="number"?o=s:o=0;if(i.onBeforeConnectInput){const f=i.onBeforeConnectInput(o,s);o=typeof f=="number"?f:null}if(o===null||!i.inputs||o>=i.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;const l=i.inputs[o],h=a[t];return h?((p=h.links)!=null&&p.length&&h.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(r.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1})),this.connectSlots(h,i,l,n)??null):null}connectSlots(t,i,s,n){var p,f,g,_,m;const{graph:o}=this;if(!o)throw new NullGraphError;const r=this.outputs.indexOf(t);if(r===-1){console.warn("connectSlots: output not found");return}const a=i.inputs.indexOf(s);if(a===-1){console.warn("connectSlots: input not found");return}if(!LiteGraph.isValidConnection(t.type,s.type))return this.setDirtyCanvas(!1,!0),null;if(((p=i.onConnectInput)==null?void 0:p.call(i,a,t.type,t,this,r))===!1||((f=this.onConnectOutput)==null?void 0:f.call(this,r,s.type,s,i,a))===!1)return null;((g=i.inputs[a])==null?void 0:g.link)!=null&&(o.beforeChange(),i.disconnectInput(a,!0));const l=new LLink(++o.state.lastLinkId,s.type||t.type,this.id,r,i.id,a,n);o._links.set(l.id,l),t.links??(t.links=[]),t.links.push(l.id),i.inputs[a].link=l.id;const h=LLink.getReroutes(o,l);for(const y of h)y.linkIds.add(l.id),y.floating&&delete y.floating,y._dragging=void 0;const c=h.at(-1);if(c)for(const y of c.floatingLinkIds){const w=o.floatingLinks.get(y);(w==null?void 0:w.parentId)===c.id&&o.removeFloatingLink(w)}return o._version++,(_=this.onConnectionsChange)==null||_.call(this,NodeSlotType.OUTPUT,r,!0,l,t),(m=i.onConnectionsChange)==null||m.call(i,NodeSlotType.INPUT,a,!0,l,s),this.setDirtyCanvas(!1,!0),o.afterChange(),l}connectFloatingReroute(t,i,s){var g,_;const{graph:n,id:o}=this;if(!n)throw new NullGraphError;const r=this.inputs.indexOf(i),a=this.outputs.indexOf(i);if(r===-1&&a===-1)throw new Error("Invalid slot");const l=a===-1?"input":"output",h=n.setReroute({pos:t,parentId:s,linkIds:[],floating:{slotType:l}}),c=n.getReroute(s),p=((g=c==null?void 0:c.floating)==null?void 0:g.slotType)==="output";if(s==null||!p){const m=new LLink(-1,i.type,a===-1?-1:o,a,r===-1?-1:o,r);return m.parentId=h.id,n.addFloatingLink(m),h}if(!c)throw new Error("[connectFloatingReroute] Parent reroute not found");const f=(_=c.getFloatingLinks("output"))==null?void 0:_[0];if(!f)throw new Error("[connectFloatingReroute] Floating link not found");return h.floatingLinkIds.add(f.id),f.parentId=h.id,delete c.floating,h}disconnectOutput(t,i){var r,a,l,h,c;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const s=this.outputs[t];if(!s)return!1;if(s._floatingLinks)for(const p of s._floatingLinks)p.hasOrigin(this.id,t)&&((r=this.graph)==null||r.removeFloatingLink(p));if(!s.links||s.links.length==0)return!1;const{links:n}=s,o=this.graph;if(!o)throw new NullGraphError;if(i){const p=typeof i=="number"?o.getNodeById(i):i;if(!p)throw"Target Node not found";for(const[f,g]of n.entries()){const _=o._links.get(g);if((_==null?void 0:_.target_id)!=p.id)continue;n.splice(f,1);const m=p.inputs[_.target_slot];m.link=null,_.disconnect(o,"input"),o._version++,(a=p.onConnectionsChange)==null||a.call(p,NodeSlotType.INPUT,_.target_slot,!1,_,m),(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.OUTPUT,t,!1,_,s);break}}else{for(const p of n){const f=o._links.get(p);if(!f)continue;const g=o.getNodeById(f.target_id);if(o._version++,g){const _=g.inputs[f.target_slot];_.link=null,(h=g.onConnectionsChange)==null||h.call(g,NodeSlotType.INPUT,f.target_slot,!1,f,_)}f.disconnect(o,"input"),(c=this.onConnectionsChange)==null||c.call(this,NodeSlotType.OUTPUT,t,!1,f,s)}s.links=null}return this.setDirtyCanvas(!1,!0),!0}disconnectInput(t,i){var r,a,l,h;if(typeof t=="string"){if(t=this.findInputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const s=this.inputs[t];if(!s)return console.debug("disconnectInput: input not found",t,this.inputs),!1;const{graph:n}=this;if(!n)throw new NullGraphError;if((r=s._floatingLinks)!=null&&r.size)for(const c of s._floatingLinks)n.removeFloatingLink(c);const o=this.inputs[t].link;if(o!=null){this.inputs[t].link=null;const c=n._links.get(o);if(c){if(c.origin_id===-10&&"inputNode"in n)return n.inputNode._disconnectNodeInput(this,s,c),!0;const p=n.getNodeById(c.origin_id);if(!p)return console.debug("disconnectInput: target node not found",c.origin_id),!1;const f=p.outputs[c.origin_slot];if(!((a=f==null?void 0:f.links)!=null&&a.length))return console.debug("disconnectInput: output not found",c.origin_slot),!1;let g=0;for(const _=f.links.length;g<_;g++)if(f.links[g]==o){f.links.splice(g,1);break}c.disconnect(n,i?"output":void 0),n&&n._version++,(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.INPUT,t,!1,c,s),(h=p.onConnectionsChange)==null||h.call(p,NodeSlotType.OUTPUT,g,!1,c,f)}}return this.setDirtyCanvas(!1,!0),!0}getConnectionPos(t,i,s){var f,g;s||(s=new Float32Array(2));const{pos:[n,o],inputs:r,outputs:a}=this;if(this.flags.collapsed){const _=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return s[0]=t?n:n+_,s[1]=o-LiteGraph.NODE_TITLE_HEIGHT*.5,s}if(t&&i==-1)return s[0]=n+LiteGraph.NODE_TITLE_HEIGHT*.5,s[1]=o+LiteGraph.NODE_TITLE_HEIGHT*.5,s;const l=(f=r==null?void 0:r[i])==null?void 0:f.pos,h=(g=a==null?void 0:a[i])==null?void 0:g.pos;if(t&&l)return s[0]=n+l[0],s[1]=o+l[1],s;if(!t&&h)return s[0]=n+h[0],s[1]=o+h[1],s;const c=LiteGraph.NODE_SLOT_HEIGHT*.5,p=t?I(this,K,ii).indexOf(this.inputs[i]):I(this,K,si).indexOf(this.outputs[i]);return s[0]=t?n+c:n+this.size[0]+1-c,s[1]=o+(p+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s}getInputPos(t){return this.getInputSlotPos(this.inputs[t])}getInputSlotPos(t){const{pos:[i,s]}=this;if(this.flags.collapsed){const h=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i,s-h]}const{pos:n}=t;if(n)return[i+n[0],s+n[1]];const o=LiteGraph.NODE_SLOT_HEIGHT*.5,r=this.constructor.slot_start_y||0,l=(I(this,K,ii).indexOf(t)+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o,s+l+r]}getOutputPos(t){var p;const{pos:[i,s],outputs:n,size:[o]}=this;if(this.flags.collapsed){const f=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,g=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i+f,s-g]}const r=(p=n==null?void 0:n[t])==null?void 0:p.pos;if(r)return[i+r[0],s+r[1]];const a=LiteGraph.NODE_SLOT_HEIGHT*.5,l=this.constructor.slot_start_y||0,c=(I(this,K,si).indexOf(this.outputs[t])+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o+1-a,s+c+l]}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}alignToGrid(){this.snapToGrid(LiteGraph.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>rt.MAX_CONSOLE&&this.console.shift()}setDirtyCanvas(t,i){var s;(s=this.graph)==null||s.canvasAction(n=>n.setDirty(t,i))}loadImage(t){const i=new Image;i.src=LiteGraph.node_images_path+t,i.ready=!1;const s=()=>this.setDirtyCanvas(!0);return i.addEventListener("load",function(){this.ready=!0,s()}),i}captureInput(t){if(warnDeprecated("[DEPRECATED] captureInput will be removed in a future version. Please use LGraphCanvas.pointer (CanvasPointer) instead."),!this.graph||!this.graph.list_of_graphcanvas)return;const i=this.graph.list_of_graphcanvas;for(const s of i)!t&&s.node_capturing_input!=this||(s.node_capturing_input=t?this:null)}get collapsed(){return!!this.flags.collapsed}get collapsible(){return!this.pinned&&this.constructor.collapsable!==!1}collapse(t){if(!(!this.collapsible&&!t)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0)}}toggleAdvanced(){var t;if((t=this.widgets)!=null&&t.some(i=>i.advanced)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.showAdvanced=!this.showAdvanced,this.expandToFitContent(),this.setDirtyCanvas(!0,!0)}}get pinned(){return!!this.flags.pinned}pin(t){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.pinned=t??!this.flags.pinned,this.resizable=!this.pinned,this.pinned||delete this.flags.pinned}unpin(){this.pin(!1)}localToScreen(t,i,s){return[(t+this.pos[0])*s.scale+s.offset[0],(i+this.pos[1])*s.scale+s.offset[1]]}get width(){return this.collapsed?this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH:this.size[0]}get height(){return LiteGraph.NODE_TITLE_HEIGHT+this.bodyHeight}get bodyHeight(){return this.collapsed?0:this.size[1]}drawBadges(t,{gap:i=2}={}){const s=this.badges.map(a=>a instanceof LGraphBadge?a:a());let o=this.badgePosition===BadgePosition.TopLeft?0:this.width-s.reduce((a,l)=>a+l.getWidth(t)+i,0);const r=-(LiteGraph.NODE_TITLE_HEIGHT+i);for(const a of s)a.draw(t,o,r-a.height),o+=a.getWidth(t)+i}drawTitleBarBackground(t,{scale:i,title_height:s=LiteGraph.NODE_TITLE_HEIGHT,low_quality:n=!1}){const o=this.renderingColor,r=this.renderingShape,a=this.renderingSize;if(this.onDrawTitleBar){this.onDrawTitleBar(t,s,a,i,o);return}this.title_mode!==TitleMode.TRANSPARENT_TITLE&&(this.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),t.fillStyle=this.constructor.title_color||o,t.beginPath(),r==RenderShape.BOX||n?t.rect(0,-s,a[0],s):(r==RenderShape.ROUND||r==RenderShape.CARD)&&t.roundRect(0,-s,a[0],s,this.collapsed?[LiteGraph.ROUND_RADIUS]:[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]),t.fill(),t.shadowColor="transparent")}drawTitleBox(t,{scale:i,low_quality:s=!1,title_height:n=LiteGraph.NODE_TITLE_HEIGHT,box_size:o=10}){const r=this.renderingSize,a=this.renderingShape;if(this.onDrawTitleBox){this.onDrawTitleBox(t,n,r,i);return}[RenderShape.ROUND,RenderShape.CIRCLE,RenderShape.CARD].includes(a)?(s&&(t.fillStyle="black",t.beginPath(),t.arc(n*.5,n*-.5,o*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=this.renderingBoxColor,s?t.fillRect(n*.5-o*.5,n*-.5-o*.5,o,o):(t.beginPath(),t.arc(n*.5,n*-.5,o*.5,0,Math.PI*2),t.fill())):(s&&(t.fillStyle="black",t.fillRect((n-o)*.5-1,(n+o)*-.5-1,o+2,o+2)),t.fillStyle=this.renderingBoxColor,t.fillRect((n-o)*.5,(n+o)*-.5,o,o))}drawTitleText(t,{scale:i,default_title_color:s,low_quality:n=!1,title_height:o=LiteGraph.NODE_TITLE_HEIGHT}){var c;const r=this.renderingSize,a=this.selected;if(this.onDrawTitleText){this.onDrawTitleText(t,o,r,i,this.titleFontStyle,a);return}if(n)return;t.font=this.titleFontStyle;const l=this.getTitle()??`âŒ ${this.type}`,h=String(l)+(this.pinned?"ðŸ“Œ":"");if(h){a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=this.constructor.title_text_color||s;let p=r[0]-o*2;if(((c=this.title_buttons)==null?void 0:c.length)>0){let g=0;const _=t.font;for(const m of this.title_buttons)m.visible&&(g+=m.getWidth(t)+2);t.font=_,g>0&&(g+=10,p-=g)}let f=h;this.collapsed?f=h.substr(0,20):p>0&&(f=truncateText(t,h,p)),t.textAlign="left",t.fillText(f,o,LiteGraph.NODE_TITLE_TEXT_Y-o)}}connectInputToOutput(){const{inputs:t,outputs:i,graph:s}=this;if(!t||!i)return;if(!s)throw new NullGraphError;const{_links:n}=s;let o=!1;for(const[a,l]of t.entries()){if(l.link==null)continue;const h=i[a];if(!h||!LiteGraph.isValidConnection(l.type,h.type))continue;const c=n.get(l.link);if(!c)continue;const p=s.getNodeById(c==null?void 0:c.origin_id);p&&r(h,p,c,s)}if(!(this.flags.keepAllLinksOnBypass??rt.keepAllLinksOnBypass))return o;for(const a of t){if(a.link==null)continue;const l=n.get(a.link);if(!l)continue;const h=s.getNodeById(l==null?void 0:l.origin_id);if(h){for(const c of i)if(LiteGraph.isValidConnection(a.type,c.type)){r(c,h,l,s);break}}}return o;function r(a,l,h,c){var f;const p=(f=a.links)==null?void 0:f.map(g=>n.get(g)).filter(g=>!!g);if(p!=null&&p.length)for(const g of p){const _=c.getNodeById(g.target_id);if(!_)continue;const m=l.connect(h.origin_slot,_,g.target_slot,h.parentId);o||(o=!!m)}}}isWidgetVisible(t){return!(this.collapsed||t.hidden||t.advanced&&!this.showAdvanced)}drawWidgets(t,{lowQuality:i=!1,editorAlpha:s=1}){var l,h;if(!this.widgets)return;const n=this.size[0],{widgets:o}=this,r=LiteGraph.NODE_WIDGET_HEIGHT,a=!i;t.save(),t.globalAlpha=s;for(const c of o){if(!this.isWidgetVisible(c))continue;const{y:p}=c,f=c.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR;c.last_y=p,c.computedDisabled=c.disabled||((l=this.getSlotFromWidget(c))==null?void 0:l.link)!=null,t.strokeStyle=f,t.fillStyle="#222",t.textAlign="left",c.computedDisabled&&(t.globalAlpha*=.5);const g=c.width||n;typeof c.draw=="function"?c.draw(t,this,g,p,r,i):(h=toConcreteWidget(c,this,!1))==null||h.drawWidget(t,{width:g,showText:a}),t.globalAlpha=s}t.restore()}drawCollapsedSlots(t){var i;for(const s of I(this,Ct))if(s.link!=null){s.drawCollapsed(t);break}for(const s of I(this,At))if((i=s.links)!=null&&i.length){s.drawCollapsed(t);break}}get slots(){return[...this.inputs,...this.outputs]}getSlotFromWidget(t){if(t)return this.inputs.find(i=>isWidgetInputSlot(i)&&i.widget.name===t.name)}getWidgetFromSlot(t){var i;if(isWidgetInputSlot(t))return(i=this.widgets)==null?void 0:i.find(s=>s.name===t.widget.name)}drawSlots(t,{fromSlot:i,colorContext:s,editorAlpha:n,lowQuality:o}){for(const r of[...I(this,Ct),...I(this,At)]){const a=i&&r.isValidTarget(i),l=N(this,K,wi).call(this,r),h=!i||a,c=h&&l;(l||a||!r.isWidgetInputSlot||N(this,K,ki).call(this,this.getWidgetFromSlot(r))||r.isConnected)&&(t.globalAlpha=h?n:.4*n,r.draw(t,{colorContext:s,lowQuality:o,highlight:c}))}}_setConcreteSlots(){U(this,Ct,this.inputs.map(t=>toClass(NodeInputSlot,t,this))),U(this,At,this.outputs.map(t=>toClass(NodeOutputSlot,t,this)))}arrange(){const t=N(this,K,vi).call(this),i=t?t[1]+t[3]-this.pos[1]:0;N(this,K,Li).call(this,i),N(this,K,Si).call(this)}drawProgressBar(t){if(!this.progress)return;const i=t.fillStyle;t.fillStyle="green",t.fillRect(0,0,this.width*this.progress,6),t.fillStyle=i}};Ct=new WeakMap,At=new WeakMap,ge=new WeakMap,_e=new WeakMap,K=new WeakSet,mi=function(){if(this.has_errors)return{padding:12,lineWidth:10,color:LiteGraph.NODE_ERROR_COLOUR}},yi=function(){if(this.selected)return{padding:this.has_errors?20:void 0}},ei=function(t,i){var r,a,l;const n=Object.assign({returnObj:!1,typesNotAccepted:[]},i||{}),o=t==null?void 0:t.length;if(!(o>0))return-1;for(let h=0;h<o;++h){const c=t[h];if(!(!c||c.link||(r=c.links)!=null&&r.length)&&!((l=(a=n.typesNotAccepted)==null?void 0:a.includes)!=null&&l.call(a,c.type)))return n.returnObj?c:h}return-1},Ne=function(t,i,s,n,o){var h;const r=t==null?void 0:t.length;if(!r)return-1;(i==""||i=="*")&&(i=0);const a=String(i).toLowerCase().split(",");let l=null;for(let c=0;c<r;++c){const p=t[c],f=p.type=="0"||p.type=="*"?["0"]:String(p.type).toLowerCase().split(",");for(const g of a){const _=g=="_event_"?LiteGraph.EVENT:g;for(const m of f){const y=m=="_event_"?LiteGraph.EVENT:m;if(_==y||_==="*"||y==="*"){if(n&&((h=p.links)!=null&&h.length||p.link!=null)){l??(l=s?p:c);continue}return s?p:c}}}}return o?-1:l??-1},ii=function(){return this.inputs.filter(t=>{var i;return!t.pos&&!((i=this.widgets)!=null&&i.length&&isWidgetInputSlot(t))})},si=function(){return this.outputs.filter(t=>!t.pos)},$e=function(t,i,s){const n=s?this.getInputPos(i):this.getOutputPos(i);t.boundingRect[0]=n[0]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[1]=n[1]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[2]=t.isWidgetInputSlot?BaseWidget.margin:LiteGraph.NODE_SLOT_HEIGHT,t.boundingRect[3]=LiteGraph.NODE_SLOT_HEIGHT},vi=function(){var i;const t=[];for(const[s,n]of I(this,Ct).entries())(i=this.widgets)!=null&&i.length&&isWidgetInputSlot(n)||(N(this,K,$e).call(this,n,s,!0),t.push(n));for(const[s,n]of I(this,At).entries())N(this,K,$e).call(this,n,s,!1),t.push(n);return t.length?createBounds(t,0):null},bi=function(t){var n;const i=isINodeInputSlot(t),s=((n=this.mouseOver)==null?void 0:n[i?"inputId":"outputId"])??-1;return s===-1?null:i?this.inputs[s]:this.outputs[s]},wi=function(t){return N(this,K,bi).call(this,t)===t},ki=function(t){var i;return t?((i=this.mouseOver)==null?void 0:i.overWidget)===t:!1},Li=function(t){if(!this.widgets||!this.widgets.length)return;const i=this.bodyHeight,s=this.widgets_start_y??(this.widgets_up?0:t)+2;let n=i-s,o=0;const r=[];for(const c of this.widgets)if(c.computeSize){const p=c.computeSize()[1]+4;c.computedHeight=p,o+=p}else if(c.computeLayoutSize){const{minHeight:p,maxHeight:f}=c.computeLayoutSize(this);r.push({minHeight:p,prefHeight:f,w:c})}else{const p=LiteGraph.NODE_WIDGET_HEIGHT+4;c.computedHeight=p,o+=p}n-=o,this.freeWidgetSpace=n;const a=r.map(c=>({minSize:c.minHeight,maxSize:c.prefHeight})),l=distributeSpace(Math.max(0,n),a);for(const[c,p]of r.entries())p.w.computedHeight=l[c];let h=s;for(const c of this.widgets)c.y=h,h+=c.computedHeight??0;if(!this.graph)throw new NullGraphError;h>i&&(this.setSize([this.size[0],h]),this.graph.setDirtyCanvas(!1,!0))},Si=function(){if(!this.widgets)return;const t=new Map;for(const[i,s]of this.inputs.entries())isWidgetInputSlot(s)&&t.set(s.widget.name,{...s,index:i});if(t.size)for(const i of this.widgets){const s=t.get(i.name);if(!s)continue;const n=I(this,Ct)[s.index],o=LiteGraph.NODE_SLOT_HEIGHT*.5;n.pos=[o,i.y+o],N(this,K,$e).call(this,n,s.index,!0)}},d(rt,"title"),d(rt,"MAX_CONSOLE"),d(rt,"type"),d(rt,"category"),d(rt,"filter"),d(rt,"skip_list"),d(rt,"resizeHandleSize",15),d(rt,"resizeEdgeSize",5),d(rt,"keepAllLinksOnBypass",!1);let LGraphNode=rt;function getAllNestedItems(u){const t=new Set;if(u)for(const s of u)i(s,t);return t;function i(s,n){if(!(n.has(s)||s.pinned)&&(n.add(s),s.children))for(const o of s.children)i(o,n)}}function findFirstNode(u){for(const t of u)if(t instanceof LGraphNode)return t}function findFreeSlotOfType(u,t,i){if(!(u!=null&&u.length))return;let s,n,o;const r=parseSlotTypes(t);for(const[a,l]of u.entries()){const h=parseSlotTypes(l.type);for(const c of r)for(const p of h)if(p===c){if(i(l))return{index:a,slot:l};s??(s={index:a,slot:l})}else!n&&(c==="*"||p==="*")&&(i(l)?n={index:a,slot:l}:o??(o={index:a,slot:l}))}return n??s??o}function removeFromArray(u,t){const i=u.indexOf(t),s=i!==-1;return s&&u.splice(i,1),s}class SubgraphInput extends SubgraphSlot{constructor(){super(...arguments);d(this,"events",new CustomEventTarget);P(this,Qt)}get _widget(){var i;return(i=I(this,Qt))==null?void 0:i.deref()}set _widget(i){U(this,Qt,i?new WeakRef(i):void 0)}connect(i,s,n){var p,f;const{subgraph:o}=this.parent,r=s.inputs.indexOf(i);if(((p=s.onConnectInput)==null?void 0:p.call(s,r,this.type,this,this.parent,-1))===!1)return;if(i.link!=null){o.beforeChange();const g=o.getLink(i.link);this.parent._disconnectNodeInput(s,i,g)}const a=s.getWidgetFromSlot(i);if(a){if(!this.matchesWidget(a)){console.warn("Target input has invalid widget.",i,s);return}this._widget??(this._widget=a),this.events.dispatch("input-connected",{input:i,widget:a})}const l=new LLink(++o.state.lastLinkId,i.type,this.parent.id,this.parent.slots.indexOf(this),s.id,r,n);o._links.set(l.id,l),this.linkIds.push(l.id),i.link=l.id;const h=LLink.getReroutes(o,l);for(const g of h)g.linkIds.add(l.id),g.floating&&delete g.floating,g._dragging=void 0;const c=h.at(-1);if(c)for(const g of c.floatingLinkIds){const _=o.floatingLinks.get(g);(_==null?void 0:_.parentId)===c.id&&o.removeFloatingLink(_)}return o._version++,(f=s.onConnectionsChange)==null||f.call(s,NodeSlotType.INPUT,r,!0,l,i),o.afterChange(),l}get labelPos(){const[i,s,,n]=this.boundingRect;return[i,s+n*.5]}getConnectedWidgets(){var n;const{subgraph:i}=this.parent,s=[];for(const o of this.linkIds){const r=i.getLink(o);if(!r){console.error("Link not found",o);continue}const a=r.resolve(i);if(a.input&&((n=a.inputNode)!=null&&n.widgets)){const l=a.input.widget;if(!l)continue;if(!l.name){console.warn("Invalid widget name",l);continue}const h=a.inputNode.widgets.find(c=>c.name===l.name);if(!h){console.warn("Widget not found",l);continue}s.push(h)}else console.debug("No input found on link id",o,r)}return s}matchesWidget(i){var n;const s=(n=I(this,Qt))==null?void 0:n.deref();return s?!(i.type!==s.type||i.options.min!==s.options.min||i.options.max!==s.options.max||i.options.step!==s.options.step||i.options.step2!==s.options.step2||i.options.precision!==s.options.precision):!0}disconnect(){super.disconnect(),this.events.dispatch("input-disconnected",{input:this})}arrange(i){const[s,n,o,r]=i,{boundingRect:a,pos:l}=this;a[0]=s-o,a[1]=n,a[2]=o,a[3]=r,l[0]=s-r*.5,l[1]=n+r*.5}isValidTarget(i){return isNodeSlot(i)?"link"in i&&LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}}Qt=new WeakMap;class EmptySubgraphInput extends SubgraphInput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,s){const{subgraph:n}=this.parent,o=n.inputs.map(l=>l.name),r=nextUniqueName(t.name,o);return n.addInput(r,String(t.type)).connect(t,i,s)}get labelPos(){const[t,i,,s]=this.boundingRect;return[t,i+s*.5]}}class SubgraphInputNode extends SubgraphIONodeBase{constructor(){super(...arguments);d(this,"id",SUBGRAPH_INPUT_ID);d(this,"emptySlot",new EmptySubgraphInput(this))}get slots(){return this.subgraph.inputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i,,s]=this.boundingRect;return i+s-SubgraphIONodeBase.roundedRadius}onPointerDown(i,s,n){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(s.onDragStart=()=>{n.dragNewFromSubgraphInput(this.subgraph,this,o)},s.onDragEnd=a=>{n.dropLinks(this.subgraph,a)},s.finally=()=>{n.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,s){this.subgraph.renameInput(i,s)}removeSlot(i){this.subgraph.removeInput(i)}canConnectTo(i,s,n){return i.canConnectTo(this,s,n)}connectSlots(i,s,n,o){const{subgraph:r}=this,a=this.slots.indexOf(i),l=s.inputs.indexOf(n);if(a===-1||l===-1)throw new Error("Invalid slot indices.");return new LLink(++r.state.lastLinkId,n.type||i.type,this.id,a,s.id,l,o)}connectByType(i,s,n,o){const r=s.findInputByType(n);if(r){if(i===-1){const a=this.subgraph.addInput(r.slot.name,String(r.slot.type??"")),l=this.slots.indexOf(a);if(l===-1){console.error("Could not find newly created subgraph input slot.");return}i=l}return this.slots[i].connect(r.slot,s,o==null?void 0:o.afterRerouteId)}}findOutputSlot(i){return this.slots.find(s=>s.name===i)}findOutputByType(i){var s;return(s=findFreeSlotOfType(this.slots,i,n=>n.linkIds.length>0))==null?void 0:s.slot}_disconnectNodeInput(i,s,n){var h,c;const{subgraph:o}=this;if((h=s._floatingLinks)!=null&&h.size)for(const p of s._floatingLinks)o.removeFloatingLink(p);if(s.link=null,o.setDirtyCanvas(!1,!0),!n)return;const r=n.origin_slot;n.disconnect(o,"output"),o._version++;const a=this.slots.at(r);if(!a){console.debug("disconnectNodeInput: subgraphInput not found",this,r);return}const l=a.linkIds.indexOf(n.id);l!==-1?a.linkIds.splice(l,1):console.debug("disconnectNodeInput: link ID not found in subgraphInput linkIds",n.id),(c=i.onConnectionsChange)==null||c.call(i,NodeSlotType.OUTPUT,l,!1,n,a)}drawProtected(i,s,n,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,h,c,p]=this.boundingRect;i.translate(l,h),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(c-r,r,r,Math.PI*1.5,0),i.moveTo(c,r),i.lineTo(c,p-r),i.arc(c-r,p-r,r,0,Math.PI*.5),i.stroke(),i.setTransform(a),this.drawSlots(i,s,n,o)}}class FloatingRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){d(this,"node");d(this,"fromSlot");d(this,"fromPos");d(this,"fromDirection");d(this,"fromSlotIndex");d(this,"outputNodeId",-1);d(this,"outputNode");d(this,"outputSlot");d(this,"outputIndex",-1);d(this,"outputPos");d(this,"inputNodeId",-1);d(this,"inputNode");d(this,"inputSlot");d(this,"inputIndex",-1);d(this,"inputPos");this.network=t,this.link=i,this.toType=s,this.fromReroute=n,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:h}=i;if(r!==-1){const c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=c==null?void 0:c.outputs.at(l);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=p,this.outputIndex=l,this.outputPos=c.getOutputPos(l),this.node=c,this.fromSlot=p,this.fromPos=(n==null?void 0:n.pos)??this.outputPos,this.fromDirection=LinkDirection.LEFT,this.dragDirection=LinkDirection.RIGHT,this.fromSlotIndex=l}else{const c=t.getNodeById(a)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const p=c==null?void 0:c.inputs.at(h);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${h}] not found.`);this.inputNodeId=a,this.inputNode=c,this.inputSlot=p,this.inputIndex=h,this.inputPos=c.getInputPos(h),this.node=c,this.fromSlot=p,this.fromDirection=LinkDirection.RIGHT,this.fromSlotIndex=h}this.fromPos=n.pos}canConnectToInput(){return this.toType==="input"}canConnectToOutput(){return this.toType==="output"}canConnectToReroute(t){var i,s;if(this.toType==="input"){if(t.origin_id===((i=this.inputNode)==null?void 0:i.id))return!1}else if(t.origin_id===((s=this.outputNode)==null?void 0:s.id))return!1;return!0}connectToInput(t,i,s){var o;const n=this.link;n.target_id=t.id,n.target_slot=t.inputs.indexOf(i),t.disconnectInput(t.inputs.indexOf(i)),(o=this.fromSlot._floatingLinks)==null||o.delete(n),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(n)}connectToOutput(t,i,s){var o;const n=this.link;n.origin_id=t.id,n.origin_slot=t.outputs.indexOf(i),(o=this.fromSlot._floatingLinks)==null||o.delete(n),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(n)}connectToSubgraphInput(t,i){var n;const s=this.link;s.origin_id=SUBGRAPH_INPUT_ID,s.origin_slot=t.parent.slots.indexOf(t),(n=this.fromSlot._floatingLinks)==null||n.delete(s),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(s)}connectToSubgraphOutput(t,i){var n;const s=this.link;s.origin_id=SUBGRAPH_OUTPUT_ID,s.origin_slot=t.parent.slots.indexOf(t),(n=this.fromSlot._floatingLinks)==null||n.delete(s),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(s)}connectToRerouteInput(t,{node:i,input:s},n){var r;const o=this.link;o.target_id=i.id,o.target_slot=i.inputs.indexOf(s),(r=this.fromSlot._floatingLinks)==null||r.delete(o),s._floatingLinks??(s._floatingLinks=new Set),s._floatingLinks.add(o),n.dispatch("input-moved",this)}connectToRerouteOutput(t,i,s,n){var r;const o=this.link;o.origin_id=i.id,o.origin_slot=i.outputs.indexOf(s),(r=this.fromSlot._floatingLinks)==null||r.delete(o),s._floatingLinks??(s._floatingLinks=new Set),s._floatingLinks.add(o),n.dispatch("output-moved",this)}}class MovingLinkBase{constructor(t,i,s,n,o=LinkDirection.CENTER){d(this,"outputNodeId");d(this,"outputNode");d(this,"outputSlot");d(this,"outputIndex");d(this,"outputPos");d(this,"inputNodeId");d(this,"inputNode");d(this,"inputSlot");d(this,"inputIndex");d(this,"inputPos");this.network=t,this.link=i,this.toType=s,this.fromReroute=n,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:h}=i,c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=c.outputs.at(l);if(!p)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=p,this.outputIndex=l,this.outputPos=c.getOutputPos(l);const f=t.getNodeById(a)??void 0;if(!f)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const g=f.inputs.at(h);if(!g)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${h}] not found.`);this.inputNodeId=a,this.inputNode=f,this.inputSlot=g,this.inputIndex=h,this.inputPos=f.getInputPos(h)}}class MovingInputLink extends MovingLinkBase{constructor(i,s,n,o=LinkDirection.CENTER){super(i,s,"input",n,o);d(this,"toType","input");d(this,"node");d(this,"fromSlot");d(this,"fromPos");d(this,"fromDirection");d(this,"fromSlotIndex");this.node=this.outputNode,this.fromSlot=this.outputSlot,this.fromPos=(n==null?void 0:n.pos)??this.outputPos,this.fromDirection=LinkDirection.NONE,this.fromSlotIndex=this.outputIndex}canConnectToInput(i,s){return this.node.canConnectTo(i,s,this.outputSlot)}canConnectToOutput(){return!1}canConnectToReroute(i){return i.origin_id!==this.inputNode.id}connectToInput(i,s,n){var r;if(s===this.inputSlot)return;this.inputNode.disconnectInput(this.inputIndex,!0);const o=this.outputNode.connectSlots(this.outputSlot,i,s,(r=this.fromReroute)==null?void 0:r.id);return o&&n.dispatch("input-moved",this),o}connectToOutput(){throw new Error("MovingInputLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("MovingInputLink cannot connect to a subgraph input.")}connectToSubgraphOutput(i,s){var o;const n=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);s==null||s.dispatch("link-created",n)}connectToRerouteInput(i,{node:s,input:n,link:o},r,a){const{outputNode:l,outputSlot:h,fromReroute:c}=this;for(const f of a){if(f.id===this.link.parentId)break;f.totalLinks===1&&f.remove()}i.parentId=c==null?void 0:c.id,l.connectSlots(h,s,n,o.parentId)&&r.dispatch("input-moved",this)}connectToRerouteOutput(){throw new Error("MovingInputLink cannot connect to an output.")}disconnect(){return this.inputNode.disconnectInput(this.inputIndex,!0)}}class MovingOutputLink extends MovingLinkBase{constructor(i,s,n,o=LinkDirection.CENTER){super(i,s,"output",n,o);d(this,"toType","output");d(this,"node");d(this,"fromSlot");d(this,"fromPos");d(this,"fromDirection");d(this,"fromSlotIndex");this.node=this.inputNode,this.fromSlot=this.inputSlot,this.fromPos=(n==null?void 0:n.pos)??this.inputPos,this.fromDirection=LinkDirection.LEFT,this.fromSlotIndex=this.inputIndex}canConnectToInput(){return!1}canConnectToOutput(i,s){return i.canConnectTo(this.node,this.inputSlot,s)}canConnectToReroute(i){return i.origin_id!==this.outputNode.id}connectToInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToOutput(i,s,n){if(s===this.outputSlot)return;const o=i.connectSlots(s,this.inputNode,this.inputSlot,this.link.parentId);return o&&n.dispatch("output-moved",this),o}connectToSubgraphInput(i,s){var o;const n=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);s==null||s.dispatch("link-created",n)}connectToSubgraphOutput(){throw new Error("MovingOutputLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToRerouteOutput(i,s,n,o){var c;const{inputNode:r,inputSlot:a,fromReroute:l}=this,h=((c=i==null?void 0:i.floating)==null?void 0:c.slotType)==="output";l?l.parentId=i.id:this.link.parentId=i.id,s.connectSlots(n,r,a,this.link.parentId),h&&i.removeAllFloatingLinks(),o.dispatch("output-moved",this)}disconnect(){return this.outputNode.disconnectOutput(this.outputIndex,this.inputNode)}}class ToInputFromIoNodeLink{constructor(t,i,s,n,o=LinkDirection.CENTER,r){d(this,"toType","input");d(this,"fromSlotIndex");d(this,"fromPos");d(this,"fromDirection",LinkDirection.RIGHT);d(this,"existingLink");this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const a=i.slots.indexOf(s);if(a===-1&&s!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=a,this.fromPos=n?n.pos:s.pos,this.existingLink=r}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,s){const{fromSlot:n,fromReroute:o,existingLink:r}=this,a=n.connect(i,t,o==null?void 0:o.id);r?s.dispatch("input-moved",this):s.dispatch("link-created",a)}connectToSubgraphOutput(){throw new Error("Not implemented")}connectToRerouteInput(t,{node:i,input:s,link:n},o,r){var p;const{fromSlot:a,fromReroute:l}=this,h=((p=l==null?void 0:l.floating)==null?void 0:p.slotType)==="output";t.parentId=l==null?void 0:l.id;const c=a.connect(s,i,n.parentId);h&&l.removeAllFloatingLinks();for(const f of r){if(f.id===(l==null?void 0:l.id))break;if(f.removeLink(n),f.totalLinks===0)if(n.isFloating)f.remove();else{const g=n.toFloating("output",f.id);this.network.addFloatingLink(g),f.floating={slotType:"output"}}}this.existingLink?o.dispatch("input-moved",this):o.dispatch("link-created",c)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToInputRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){d(this,"toType","input");d(this,"fromPos");d(this,"fromSlotIndex");d(this,"fromDirection",LinkDirection.RIGHT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.outputs.indexOf(s);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:this.node.getOutputPos(r)}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,s){const{node:n,fromSlot:o,fromReroute:r}=this;if(t===n)return;const a=n.connectSlots(o,t,i,r==null?void 0:r.id);s.dispatch("link-created",a)}connectToSubgraphOutput(t,i){var n;const s=t.connect(this.fromSlot,this.node,(n=this.fromReroute)==null?void 0:n.id);i.dispatch("link-created",s)}connectToRerouteInput(t,{node:i,input:s,link:n},o,r){var f;const{node:a,fromSlot:l,fromReroute:h}=this,c=((f=h==null?void 0:h.floating)==null?void 0:f.slotType)==="output";t.parentId=h==null?void 0:h.id;const p=a.connectSlots(l,i,s,n.parentId);c&&h.removeAllFloatingLinks();for(const g of r){if(g.id===(h==null?void 0:h.id))break;if(g.removeLink(n),g.totalLinks===0)if(n.isFloating)g.remove();else{const _=n.toFloating("output",g.id);this.network.addFloatingLink(_),g.floating={slotType:"output"}}}o.dispatch("link-created",p)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToOutputFromIoNodeLink{constructor(t,i,s,n,o=LinkDirection.CENTER){d(this,"toType","output");d(this,"fromPos");d(this,"fromSlotIndex");d(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.slots.indexOf(s);if(r===-1&&s!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:s.pos}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,s){const{fromSlot:n,fromReroute:o}=this,r=n.connect(i,t,o==null?void 0:o.id);s.dispatch("link-created",r)}connectToSubgraphInput(){throw new Error("Not implemented")}connectToRerouteOutput(t,i,s,n){const{fromSlot:o}=this,r=o.connect(s,i,t==null?void 0:t.id);n.dispatch("link-created",r)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){d(this,"toType","output");d(this,"fromPos");d(this,"fromSlotIndex");d(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.inputs.indexOf(s);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:this.node.getInputPos(r)}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,s){const{node:n,fromSlot:o,fromReroute:r}=this;if(!n)return;const a=t.connectSlots(i,n,o,r==null?void 0:r.id);s.dispatch("link-created",a)}connectToSubgraphInput(t,i){var n;const s=t.connect(this.fromSlot,this.node,(n=this.fromReroute)==null?void 0:n.id);i==null||i.dispatch("link-created",s)}connectToRerouteOutput(t,i,s,n){const{node:o,fromSlot:r}=this,a=i.connectSlots(s,o,r,t==null?void 0:t.id);n.dispatch("link-created",a)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputFromRerouteLink extends ToOutputRenderLink{constructor(t,i,s,n,o){super(t,i,s,n),this.fromReroute=n,this.linkConnector=o}canConnectToReroute(){return!1}connectToOutput(t,i){const s=new ToInputRenderLink(this.network,t,i);this.linkConnector._connectOutputToReroute(this.fromReroute,s)}}class LinkConnector{constructor(t){P(this,et);d(this,"state",{connectingTo:void 0,multi:!1,draggingExistingLinks:!1,snapLinksPos:void 0});d(this,"events",new CustomEventTarget);d(this,"renderLinks",[]);d(this,"inputLinks",[]);d(this,"outputLinks",[]);d(this,"floatingLinks",[]);d(this,"hiddenReroutes",new Set);d(this,"overWidget");d(this,"overWidgetType");d(this,"overReroute");P(this,me);U(this,me,t)}get isConnecting(){return this.state.connectingTo!==void 0}get draggingExistingLinks(){return this.state.draggingExistingLinks}moveInputLink(t,i){var a,l;if(this.isConnecting)throw new Error("Already dragging links.");const{state:s,inputLinks:n,renderLinks:o}=this,r=i.link;if(r==null){const h=(a=i._floatingLinks)==null?void 0:a.values().next().value;if((h==null?void 0:h.parentId)==null)return;try{const c=t.reroutes.get(h.parentId);if(!c)throw new Error(`Invalid reroute id: [${h.parentId}] for floating link id: [${h.id}].`);const p=new FloatingRenderLink(t,h,"input",c);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p)}catch(c){console.warn(`Could not create render link for link id: [${h.id}].`,h,c)}h._dragging=!0,this.floatingLinks.push(h)}else{const h=t.links.get(r);if(!h)return;if(h.origin_id===SUBGRAPH_INPUT_ID){const c=(l=t.inputNode)==null?void 0:l.slots[h.origin_slot];if(!c){console.warn(`Could not find subgraph input for slot [${h.origin_slot}]`);return}try{const p=t.getReroute(h.parentId),f=new ToInputFromIoNodeLink(t,t.inputNode,c,p,LinkDirection.CENTER,h);o.push(f),this.listenUntilReset("input-moved",()=>{h.disconnect(t,"input")})}catch(p){console.warn(`Could not create render link for subgraph input link id: [${h.id}].`,h,p);return}h._dragging=!0,n.push(h)}else{try{const c=t.getReroute(h.parentId),p=new MovingInputLink(t,h,c);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p),this.listenUntilReset("input-moved",g=>{"link"in g.detail&&g.detail.link&&g.detail.link.disconnect(t,"output")})}catch(c){console.warn(`Could not create render link for link id: [${h.id}].`,h,c);return}h._dragging=!0,n.push(h)}}s.connectingTo="input",s.draggingExistingLinks=!0,N(this,et,gt).call(this,!1)}moveOutputLink(t,i){var o,r;if(this.isConnecting)throw new Error("Already dragging links.");const{state:s,renderLinks:n}=this;if((o=i._floatingLinks)!=null&&o.size)for(const a of i._floatingLinks.values())try{const l=LLink.getFirstReroute(t,a);if(!l)throw new Error(`Invalid reroute id: [${a.parentId}] for floating link id: [${a.id}].`);const h=new FloatingRenderLink(t,a,"output",l);if(this.events.dispatch("before-move-output",h)===!1)continue;n.push(h),this.floatingLinks.push(a)}catch(l){console.warn(`Could not create render link for link id: [${a.id}].`,a,l)}if((r=i.links)!=null&&r.length)for(const a of i.links){const l=t.links.get(a);if(!l)continue;const h=LLink.getFirstReroute(t,l);h?(h._dragging=!0,this.hiddenReroutes.add(h)):l._dragging=!0,this.outputLinks.push(l);try{const c=new MovingOutputLink(t,l,h,LinkDirection.RIGHT);if(this.events.dispatch("before-move-output",c)===!1)continue;n.push(c)}catch(c){console.warn(`Could not create render link for link id: [${l.id}].`,l,c);continue}}n.length!==0&&(s.draggingExistingLinks=!0,s.multi=!0,s.connectingTo="output",N(this,et,gt).call(this,!0))}dragNewFromOutput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToInputRenderLink(t,i,s,n);this.renderLinks.push(r),o.connectingTo="input",N(this,et,gt).call(this,!1)}dragNewFromInput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToOutputRenderLink(t,i,s,n);this.renderLinks.push(r),o.connectingTo="output",N(this,et,gt).call(this,!0)}dragNewFromSubgraphInput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToInputFromIoNodeLink(t,i,s,n);this.renderLinks.push(o),this.state.connectingTo="input",N(this,et,gt).call(this,!1)}dragNewFromSubgraphOutput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToOutputFromIoNodeLink(t,i,s,n);this.renderLinks.push(o),this.state.connectingTo="output",N(this,et,gt).call(this,!0)}dragFromReroute(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const s=i.firstLink??i.firstFloatingLink;if(!s){console.warn("No link found for reroute.");return}if(s.origin_id===SUBGRAPH_INPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph input link found in non-subgraph network.");return}const a=t.inputs.at(s.origin_slot);if(!a)throw new Error("No subgraph input found for link.");const l=new ToInputFromIoNodeLink(t,t.inputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="input",N(this,et,gt).call(this,!1);return}const n=t.getNodeById(s.origin_id);if(!n){console.warn("No output node found for link.",s);return}const o=n.outputs.at(s.origin_slot);if(!o){console.warn("No output slot found for link.",s);return}const r=new ToInputRenderLink(t,n,o,i);r.fromDirection=LinkDirection.NONE,this.renderLinks.push(r),this.state.connectingTo="input",N(this,et,gt).call(this,!1)}dragFromRerouteToOutput(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const s=i.firstLink??i.firstFloatingLink;if(!s){console.warn("No link found for reroute.");return}if(s.target_id===SUBGRAPH_OUTPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph output link found in non-subgraph network.");return}const a=t.outputs.at(s.target_slot);if(!a)throw new Error("No subgraph output found for link.");const l=new ToOutputFromIoNodeLink(t,t.outputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="output",N(this,et,gt).call(this,!1);return}const n=t.getNodeById(s.target_id);if(!n){console.warn("No input node found for link.",s);return}const o=n.inputs.at(s.target_slot);if(!o){console.warn("No input slot found for link.",s);return}const r=new ToOutputFromRerouteLink(t,n,o,i,this);r.fromDirection=LinkDirection.LEFT,this.renderLinks.push(r),this.state.connectingTo="output",N(this,et,gt).call(this,!0)}dragFromLinkSegment(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const{state:s}=this;if(i.origin_id==null||i.origin_slot==null)return;const n=t.getNodeById(i.origin_id);if(!n)return;const o=n.outputs.at(i.origin_slot);if(!o)return;const r=t.getReroute(i.parentId),a=new ToInputRenderLink(t,n,o,r);a.fromDirection=LinkDirection.NONE,this.renderLinks.push(a),s.connectingTo="input",N(this,et,gt).call(this,!1)}dropLinks(t,i){var s;if(!(!this.isConnecting&&this.events.dispatch("before-drop-links",{renderLinks:this.renderLinks,event:i})===!1))try{const{canvasX:n,canvasY:o}=i,r=(s=t.getIoNodeOnPos)==null?void 0:s.call(t,n,o);if(r){this.dropOnIoNode(r,i);return}const a=t.getNodeOnPos(n,o)??void 0;if(a)this.dropOnNode(a,i);else{const l=t.getRerouteOnPos(n,o);l&&this.isRerouteValidDrop(l)?this.dropOnReroute(l,i):this.dropOnNothing(i)}}finally{this.events.dispatch("after-drop-links",{renderLinks:this.renderLinks,event:i})}}dropOnIoNode(t,i){const{renderLinks:s,state:n}=this,{connectingTo:o}=n,{canvasX:r,canvasY:a}=i;if(o==="input"&&t instanceof SubgraphOutputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No output slot found for link.");for(const h of s)h.connectToSubgraphOutput(l,this.events)}else if(o==="output"&&t instanceof SubgraphInputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No input slot found for link.");for(const h of s)h.connectToSubgraphInput(l,this.events)}else console.error("Invalid connectingTo state &/ ioNode",o,t)}dropOnNode(t,i){const{renderLinks:s,state:n}=this,{connectingTo:o}=n,{canvasX:r,canvasY:a}=i;if(!s.every(l=>l.node===t)){if(o==="output"){const l=t.getOutputOnPos([r,a]);l?N(this,et,oi).call(this,t,l):this.connectToNode(t,i)}else if(o==="input"){const h=t.getInputOnPos([r,a])??t.getSlotFromWidget(this.overWidget);h?N(this,et,ni).call(this,t,h):this.connectToNode(t,i)}}}dropOnReroute(t,i){if(this.events.dispatch("dropped-on-reroute",{reroute:t,event:i})!==!1){if(this.state.connectingTo==="input"){if(this.renderLinks.length!==1)throw new Error(`Attempted to connect ${this.renderLinks.length} input links to a reroute.`);const n=this.renderLinks[0];this._connectOutputToReroute(t,n);return}for(const n of this.renderLinks){if(n.toType!=="output")continue;const o=t.findSourceOutput();if(!o)continue;const{node:r,output:a}=o;n.canConnectToOutput(r,a)&&n.connectToRerouteOutput(t,r,a,this.events)}}}_connectOutputToReroute(t,i){const s=t.findTargetInputs();if(!(s!=null&&s.length))return;const n=t.getReroutes();if(n===null)throw new Error("Reroute loop detected.");const o=n.slice(0,-1).reverse();if(i instanceof ToInputRenderLink){const{node:a,fromSlot:l,fromSlotIndex:h,fromReroute:c}=i;if(t.setFloatingLinkOrigin(a,l,h),c!=null)for(const p of o){if(p.id===c.id)break;for(const f of t.floatingLinkIds)p.floatingLinkIds.delete(f)}}const r=s.filter(a=>i.toType==="input"&&canConnectInputLinkToReroute(i,a.node,a.input,t));for(const a of r)i.connectToRerouteInput(t,a,this.events,o)}dropOnNothing(t){this.events.dispatch("dropped-on-canvas",t)!==!1&&this.disconnectLinks()}disconnectLinks(){for(const t of this.renderLinks)t instanceof MovingLinkBase&&t.disconnect()}connectToNode(t,i){var r,a;const{state:{connectingTo:s}}=this;if(this.events.dispatch("dropped-on-node",{node:t,event:i})===!1)return;const o=this.renderLinks[0];if(o){if(s==="output"){const l=(r=t.findOutputByType(o.fromSlot.type))==null?void 0:r.slot;if(console.debug("out",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}N(this,et,oi).call(this,t,l)}else if(s==="input"){const l=(a=t.findInputByType(o.fromSlot.type))==null?void 0:a.slot;if(console.debug("in",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}N(this,et,ni).call(this,t,l)}}}isInputValidDrop(t,i){return this.renderLinks.some(s=>s.canConnectToInput(t,i))}isNodeValidDrop(t){return this.state.connectingTo==="output"?t.outputs.some(i=>this.renderLinks.some(s=>s.canConnectToOutput(t,i))):t.inputs.some(i=>this.renderLinks.some(s=>s.canConnectToInput(t,i)))}isRerouteValidDrop(t){if(this.state.connectingTo==="input"){const i=t.findTargetInputs();if(!(i!=null&&i.length))return!1;for(const{node:s,input:n}of i)for(const o of this.renderLinks)if(o.toType==="input"&&canConnectInputLinkToReroute(o,s,n,t))return!0}else{const i=t.findSourceOutput();if(!i)return!1;const{node:s,output:n}=i;for(const o of this.renderLinks)if(o.toType==="output"&&o.canConnectToReroute(t)&&o.canConnectToOutput(s,n))return!0}return!1}export(t){return{renderLinks:[...this.renderLinks],inputLinks:[...this.inputLinks],outputLinks:[...this.outputLinks],floatingLinks:[...this.floatingLinks],state:{...this.state},network:t}}listenUntilReset(t,i,s){this.events.addEventListener(t,i,s),this.events.addEventListener("reset",()=>this.events.removeEventListener(t,i),{once:!0})}reset(t=!1){if(this.events.dispatch("reset",t)===!1)return;const{state:s,outputLinks:n,inputLinks:o,hiddenReroutes:r,renderLinks:a,floatingLinks:l}=this;if(!(!t&&s.connectingTo===void 0)){s.connectingTo=void 0;for(const h of n)delete h._dragging;for(const h of o)delete h._dragging;for(const h of l)delete h._dragging;for(const h of r)delete h._dragging;a.length=0,o.length=0,n.length=0,l.length=0,r.clear(),s.multi=!1,s.draggingExistingLinks=!1,s.snapLinksPos=void 0}}}me=new WeakMap,et=new WeakSet,ni=function(t,i){for(const s of this.renderLinks)s.canConnectToInput(t,i)&&s.connectToInput(t,i,this.events)},oi=function(t,i){for(const s of this.renderLinks){if(!s.canConnectToOutput(t,i)){s instanceof MovingOutputLink&&s.link.parentId!==void 0&&s.outputNode.connectSlots(s.outputSlot,s.inputNode,s.inputSlot,void 0);continue}s.connectToOutput(t,i,this.events)}},gt=function(t){const i=this.renderLinks.map(s=>{var a,l;const n=t?s.fromSlot:null,o=t?null:s.fromSlot,r=s instanceof MovingLinkBase?(a=s.link)==null?void 0:a.parentId:(l=s.fromReroute)==null?void 0:l.id;return{node:s.node,slot:s.fromSlotIndex,input:n,output:o,pos:s.fromPos,afterRerouteId:r}});I(this,me).call(this,i)};function canConnectInputLinkToReroute(u,t,i,s){var o,r,a;const{fromReroute:n}=u;if(!u.canConnectToInput(t,i)||(n==null?void 0:n.id)===s.id||(o=n==null?void 0:n.getReroutes())!=null&&o.includes(s))return!1;if(u instanceof ToInputRenderLink){if(s.parentId==null){if((r=s.firstLink)!=null&&r.hasOrigin(u.node.id,u.fromSlotIndex))return!1}else if(((a=u.fromReroute)==null?void 0:a.id)===s.parentId)return!1}return!0}const mt=class mt{constructor(t){P(this,ht);d(this,"element");d(this,"pointerId");d(this,"dragStarted",!1);d(this,"eLastDown");d(this,"isDouble",!1);d(this,"isDown",!1);d(this,"resizeDirection");d(this,"clearEventsOnReset",!0);d(this,"eDown");d(this,"eMove");d(this,"eUp");P(this,te);this.element=t}static get maxClickDrift(){return I(this,Ft)}static set maxClickDrift(t){U(this,Ft,t),U(this,ye,t*t)}get finally(){return I(this,te)}set finally(t){var i;try{(i=I(this,te))==null||i.call(this)}finally{U(this,te,t)}}down(t){this.reset(),this.eDown=t,this.pointerId=t.pointerId,this.element.setPointerCapture(t.pointerId)}move(t){var n;const{eDown:i}=this;if(!i)return;if(!t.buttons){this.reset();return}if(!(t.buttons&i.buttons)){N(this,ht,ri).call(this,t),this.reset();return}if(this.eMove=t,(n=this.onDrag)==null||n.call(this,t),this.dragStarted)return;(t.timeStamp-i.timeStamp>mt.bufferTime||!N(this,ht,Xe).call(this,t,i))&&N(this,ht,ai).call(this,t)}up(t){var s;if(t.button!==((s=this.eDown)==null?void 0:s.button))return!1;N(this,ht,ri).call(this,t);const{dragStarted:i}=this;return this.reset(),!i}reset(){this.finally=void 0,delete this.onClick,delete this.onDoubleClick,delete this.onDragStart,delete this.onDrag,delete this.onDragEnd,this.isDown=!1,this.isDouble=!1,this.dragStarted=!1,this.resizeDirection=void 0,this.clearEventsOnReset&&(this.eDown=void 0,this.eMove=void 0,this.eUp=void 0);const{element:t,pointerId:i}=this;this.pointerId=void 0,typeof i=="number"&&t.hasPointerCapture(i)&&t.releasePointerCapture(i)}};Ft=new WeakMap,ye=new WeakMap,te=new WeakMap,ht=new WeakSet,ri=function(t){var s,n,o;const{eDown:i}=this;i&&(this.eUp=t,this.dragStarted?(s=this.onDragEnd)==null||s.call(this,t):N(this,ht,Xe).call(this,t,i)?this.onDoubleClick&&N(this,ht,Ii).call(this)?(this.onDoubleClick(t),this.eLastDown=void 0):((o=this.onClick)==null||o.call(this,t),this.eLastDown=i):(N(this,ht,ai).call(this),(n=this.onDragEnd)==null||n.call(this,t)))},Xe=function(t,i,s=I(mt,ye)){return dist2(t.clientX,t.clientY,i.clientX,i.clientY)<=s},Ii=function(){const{eDown:t,eLastDown:i}=this;if(!t||!i)return!1;const s=(3*I(mt,Ft))**2,n=t.timeStamp-i.timeStamp;return n>0&&n<mt.doubleClickTime&&N(this,ht,Xe).call(this,t,i,s)},ai=function(t){var i;this.dragStarted=!0,(i=this.onDragStart)==null||i.call(this,this,t),delete this.onDragStart},d(mt,"bufferTime",150),d(mt,"doubleClickTime",300),P(mt,Ft,6),P(mt,ye,I(mt,Ft)**2);let CanvasPointer=mt;class DragAndScale{constructor(t){P(this,Ge);d(this,"state");d(this,"lastState",{offset:[0,0],scale:0});d(this,"max_scale");d(this,"min_scale");d(this,"enabled");d(this,"last_mouse");d(this,"element");d(this,"visible_area");d(this,"dragging");d(this,"viewport");this.state={offset:[0,0],scale:1},this.max_scale=10,this.min_scale=.1,this.enabled=!0,this.last_mouse=[0,0],this.visible_area=new Rectangle,this.element=t}get offset(){return this.state.offset}set offset(t){this.state.offset[0]=t[0],this.state.offset[1]=t[1]}get scale(){return this.state.scale}set scale(t){this.state.scale=t}computeVisibleArea(t){var p;const{scale:i,offset:s,visible_area:n}=this;if(N(this,Ge,Ei).call(this)&&((p=this.onChanged)==null||p.call(this,i,s),copyState(this.state,this.lastState)),!this.element){n[0]=n[1]=n[2]=n[3]=0;return}let{width:o,height:r}=this.element,a=-s[0],l=-s[1];t&&(a+=t[0]/i,l+=t[1]/i,o=t[2],r=t[3]);const h=a+o/i,c=l+r/i;n[0]=a,n[1]=l,n.resizeBottomRight(h,c)}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,i){return i=i||[0,0],i[0]=t[0]/this.scale-this.offset[0],i[1]=t[1]/this.scale-this.offset[1],i}mouseDrag(t,i){var s;this.offset[0]+=t/this.scale,this.offset[1]+=i/this.scale,(s=this.onredraw)==null||s.call(this,this)}changeScale(t,i,s=!0){var h;if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t==this.scale)return;const n=this.element.getBoundingClientRect();if(!n)return;i=i??[n.width*.5,n.height*.5];const o=[i[0]-n.x,i[1]-n.y],r=this.convertCanvasToOffset(o);this.scale=t,s&&Math.abs(this.scale-1)<.01&&(this.scale=1);const a=this.convertCanvasToOffset(o),l=[a[0]-r[0],a[1]-r[1]];this.offset[0]+=l[0],this.offset[1]+=l[1],(h=this.onredraw)==null||h.call(this,this)}changeDeltaScale(t,i){this.changeScale(this.scale*t,i)}fitToBounds(t,{zoom:i=.75}={}){const s=this.element.width/window.devicePixelRatio,n=this.element.height/window.devicePixelRatio;let o=this.scale;if(i>0){const c=i*s/Math.max(t[2],300),p=i*n/Math.max(t[3],300);o=Math.min(c,p,this.max_scale)}const r=s/o,a=n/o,l=-t[0]-t[2]*.5+r*.5,h=-t[1]-t[3]*.5+a*.5;this.offset[0]=l,this.offset[1]=h,this.scale=o}animateToBounds(t,i,{duration:s=350,zoom:n=.75,easing:o=EaseFunction.EASE_IN_OUT_QUAD}={}){if(!(s>0))throw new RangeError("Duration must be greater than 0");const r={linear:C=>C,easeInQuad:C=>C*C,easeOutQuad:C=>C*(2-C),easeInOutQuad:C=>C<.5?2*C*C:-1+(4-2*C)*C},a=r[o]??r.linear,l=performance.now(),h=this.element.width/window.devicePixelRatio,c=this.element.height/window.devicePixelRatio,p=this.offset[0],f=this.offset[1],g=p-h/this.scale,_=f-c/this.scale;let y=this.scale;if(n>0){const C=n*h/Math.max(t[2],300),R=n*c/Math.max(t[3],300);y=Math.min(C,R,this.max_scale)}const w=h/y,k=c/y,L=-t[0]-t[2]*.5+w*.5,E=-t[1]-t[3]*.5+k*.5,S=L-w,T=E-k,G=C=>{const R=C-l,A=Math.min(R/s,1),V=a(A),j=p+(L-p)*V,M=f+(E-f)*V;if(this.offset[0]=j,this.offset[1]=M,n>0){const W=g+(S-g)*V,B=_+(T-_)*V,$=Math.abs(W-j),z=Math.abs(B-M);this.scale=Math.min(h/$,c/z)}i(),A<1?D=requestAnimationFrame(G):cancelAnimationFrame(D)};let D=requestAnimationFrame(G)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}Ge=new WeakSet,Ei=function(){const t=this.state,i=this.lastState;return t.scale!==i.scale||t.offset[0]!==i.offset[0]||t.offset[1]!==i.offset[1]};function copyState(u,t){t.scale=u.scale,t.offset[0]=u.offset[0],t.offset[1]=u.offset[1]}function getBoundaryNodes(u){const t=u==null?void 0:u.find(r=>r);if(!t)return null;let i=t,s=t,n=t,o=t;for(const r of u){if(!r)continue;const[a,l]=r.pos,[h,c]=r.size;l<i.pos[1]&&(i=r),a+h>s.pos[0]+s.size[0]&&(s=r),l+c>n.pos[1]+n.size[1]&&(n=r),a<o.pos[0]&&(o=r)}return{top:i,right:s,bottom:n,left:o}}function distributeNodes(u,t){const i=u==null?void 0:u.length;if(!(i>1))return;const s=t?0:1;let n=0,o=-1/0;for(const c of u){n+=c.size[s];const p=c.pos[s]+c.size[s];p>o&&(o=p)}const r=[...u].sort((c,p)=>c.pos[s]-p.pos[s]),a=r[0].pos[s],l=(o-a-n)/(i-1);let h=a;for(let c=0;c<i;c++){const p=r[c];p.pos[s]=h+l*c,h+=p.size[s]}}function alignNodes(u,t,i){if(!u)return;const s=i===void 0?getBoundaryNodes(u):{top:i,right:i,bottom:i,left:i};if(s!==null)for(const n of u)switch(t){case"right":n.pos[0]=s.right.pos[0]+s.right.size[0]-n.size[0];break;case"left":n.pos[0]=s.left.pos[0];break;case"top":n.pos[1]=s.top.pos[1];break;case"bottom":n.pos[1]=s.bottom.pos[1]+s.bottom.size[1]-n.size[1];break}}const cursors={NE:"nesw-resize",SE:"nwse-resize",SW:"nesw-resize",NW:"nwse-resize"},O=class O{constructor(t,i,s){P(this,F);d(this,"state",{draggingItems:!1,draggingCanvas:!1,readOnly:!1,hoveringOver:CanvasItem.Nothing,shouldSetCursor:!0,selectionChanged:!1});P(this,xt);d(this,"_previously_dragging_canvas",null);P(this,Ot,0);d(this,"options");d(this,"background_image");d(this,"ds");d(this,"pointer");d(this,"zoom_modify_alpha");d(this,"zoom_speed");d(this,"node_title_color");d(this,"default_link_color");d(this,"default_connection_color");d(this,"default_connection_color_byType");d(this,"default_connection_color_byTypeOff");d(this,"colourGetter",{getConnectedColor:t=>this.default_connection_color_byType[t]||this.default_connection_color.output_on,getDisconnectedColor:t=>this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.output_off});d(this,"highquality_render");d(this,"use_gradients");d(this,"editor_alpha");d(this,"pause_rendering");d(this,"clear_background");d(this,"clear_background_color");d(this,"render_only_selected");d(this,"show_info");d(this,"allow_dragcanvas");d(this,"allow_dragnodes");d(this,"allow_interaction");d(this,"multi_select");d(this,"allow_searchbox");d(this,"allow_reconnect_links");d(this,"align_to_grid");d(this,"drag_mode");d(this,"dragging_rectangle");d(this,"filter");d(this,"set_canvas_dirty_on_mouse_event");d(this,"always_render_background");d(this,"render_shadows");d(this,"render_canvas_border");d(this,"render_connections_shadows");d(this,"render_connections_border");d(this,"render_curved_connections");d(this,"render_connection_arrows");d(this,"render_collapsed_slots");d(this,"render_execution_order");d(this,"render_link_tooltip");d(this,"linkMarkerShape",LinkMarkerShape.Circle);d(this,"links_render_mode");d(this,"low_quality_zoom_threshold",.6);d(this,"mouse");d(this,"graph_mouse");d(this,"canvas_mouse");d(this,"onSearchBox");d(this,"onSearchBoxSelection");d(this,"onMouse");d(this,"onDrawBackground");d(this,"onDrawForeground");d(this,"connections_width");d(this,"current_node");d(this,"node_widget");d(this,"over_link_center");d(this,"last_mouse_position");d(this,"visible_area");d(this,"renderedPaths",new Set);d(this,"visible_links",[]);d(this,"connecting_links");d(this,"linkConnector",new LinkConnector(t=>this.connecting_links=t));d(this,"viewport");d(this,"autoresize");d(this,"frame",0);d(this,"last_draw_time",0);d(this,"render_time",0);d(this,"fps",0);d(this,"selected_nodes",{});d(this,"selectedItems",new Set);d(this,"resizingGroup",null);d(this,"selected_group",null);d(this,"visible_nodes",[]);P(this,ve,new Set);d(this,"node_over");d(this,"node_capturing_input");d(this,"highlighted_links",{});P(this,yt,new Set);d(this,"dirty_canvas",!0);d(this,"dirty_bgcanvas",!0);d(this,"dirty_nodes",new Map);d(this,"dirty_area");d(this,"node_in_panel");d(this,"last_mouse",[0,0]);d(this,"last_mouseclick",0);d(this,"graph");d(this,"canvas");d(this,"bgcanvas");d(this,"ctx");d(this,"_events_binded");d(this,"bgctx");d(this,"is_rendering");d(this,"block_click");d(this,"last_click_position");d(this,"resizing_node");d(this,"selected_group_resizing");d(this,"last_mouse_dragging");d(this,"onMouseDown");d(this,"_highlight_pos");d(this,"_highlight_input");d(this,"node_panel");d(this,"options_panel");d(this,"_bg_img");d(this,"_pattern");d(this,"_pattern_img");d(this,"prompt_box");d(this,"search_box");d(this,"SELECTED_NODE");d(this,"NODEPANEL_IS_OPEN");P(this,ct);P(this,be,!1);d(this,"dragZoomEnabled",!1);P(this,Pt,null);d(this,"onClear");d(this,"onNodeMoved");d(this,"onSelectionChange");d(this,"onDrawLinkTooltip");d(this,"onDrawOverlay");d(this,"onRenderBackground");d(this,"onNodeDblClicked");d(this,"onShowNodePanel");d(this,"onNodeSelected");d(this,"onNodeDeselected");d(this,"onRender");s||(s={}),this.options=s,this.background_image=O.DEFAULT_BACKGROUND_IMAGE,this.ds=new DragAndScale(t),this.pointer=new CanvasPointer(t),this.linkConnector.events.addEventListener("link-created",()=>N(this,F,wt).call(this)),this.linkConnector.events.addEventListener("reset",()=>{this.connecting_links=null,this.dirty_bgcanvas=!0}),this.linkConnector.events.addEventListener("dropped-on-canvas",n=>{var a;if(!this.connecting_links)return;const o=n.detail;this.emitEvent({subType:"empty-release",originalEvent:o,linkReleaseContext:{links:this.connecting_links}});const r=this.linkConnector.renderLinks[0];if(LiteGraph.release_link_on_empty_shows_menu){const l=this.linkConnector.state.connectingTo==="input"?{node_from:r.node,slot_from:r.fromSlot,type_filter_in:r.fromSlot.type}:{node_to:r.node,slot_to:r.fromSlot,type_filter_out:r.fromSlot.type},h=(a=r.fromReroute)==null?void 0:a.id;"shiftKey"in o&&o.shiftKey?this.allow_searchbox&&this.showSearchBox(o,l):this.linkConnector.state.connectingTo==="input"?this.showConnectionMenu({nodeFrom:r.node,slotFrom:r.fromSlot,e:o,afterRerouteId:h}):this.showConnectionMenu({nodeTo:r.node,slotTo:r.fromSlot,e:o,afterRerouteId:h})}}),this.zoom_modify_alpha=!0,this.zoom_speed=1.1,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.render_only_selected=!0,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_link_tooltip=!0,this.links_render_mode=LinkRenderType.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.connections_width=3,this.current_node=null,this.node_widget=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.connecting_links=null,this.viewport=s.viewport||null,this.graph=i,i==null||i.attachCanvas(this),this.canvas=void 0,this.bgcanvas=void 0,this.ctx=void 0,this.setCanvas(t,s.skip_events),this.clear(),O._measureText=(n,o=this.inner_text_font)=>{const{ctx:r}=this,{font:a}=r;try{return r.font=o,r.measureText(n).width}finally{r.font=a}},s.skip_render||this.startRendering(),this.autoresize=s.autoresize}get subgraph(){return I(this,xt)}set subgraph(t){t!==I(this,xt)&&(U(this,xt,t),t&&this.dispatch("litegraph:set-graph",{oldGraph:I(this,xt),newGraph:t}))}dispatch(t,i){const s=new CustomEvent(t,{detail:i,bubbles:!0});return this.canvas.dispatchEvent(s)}dispatchEvent(t,i){this.canvas.dispatchEvent(new CustomEvent(t,{detail:i}))}get read_only(){return this.state.readOnly}set read_only(t){this.state.readOnly=t,N(this,F,Ye).call(this)}get isDragging(){return this.state.draggingItems}set isDragging(t){this.state.draggingItems=t}get hoveringOver(){return this.state.hoveringOver}set hoveringOver(t){this.state.hoveringOver=t,N(this,F,Ye).call(this)}get pointer_is_down(){return this.pointer.isDown}get pointer_is_double(){return this.pointer.isDouble}get dragging_canvas(){return this.state.draggingCanvas}set dragging_canvas(t){this.state.draggingCanvas=t,N(this,F,Ye).call(this)}get title_text_font(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get inner_text_font(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get maximumFps(){return I(this,Ot)>Number.EPSILON?I(this,Ot)/1e3:0}set maximumFps(t){U(this,Ot,t>Number.EPSILON?1e3/t:0)}get round_radius(){return LiteGraph.ROUND_RADIUS}set round_radius(t){LiteGraph.ROUND_RADIUS=t}get low_quality(){return this.ds.scale<this.low_quality_zoom_threshold}get _graph(){if(!this.graph)throw new NullGraphError;return this.graph}static onGroupAdd(t,i,s){const n=O.active_canvas,o=new LiteGraph.LGraphGroup;if(o.pos=n.convertEventToCanvasOffset(s),!n.graph)throw new NullGraphError;n.graph.add(o)}static getBoundaryNodes(t){const i=Array.isArray(t)?t:Object.values(t);return getBoundaryNodes(i)??{top:null,right:null,bottom:null,left:null}}static alignNodes(t,i,s){alignNodes(Object.values(t),i,s),O.active_canvas.setDirty(!0,!0)}static onNodeAlign(t,i,s,n,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:r,parentMenu:n});function r(a){alignNodes(Object.values(O.active_canvas.selected_nodes),a.toLowerCase(),o),O.active_canvas.setDirty(!0,!0)}}static onGroupAlign(t,i,s,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:o,parentMenu:n});function o(r){alignNodes(Object.values(O.active_canvas.selected_nodes),r.toLowerCase()),O.active_canvas.setDirty(!0,!0)}}static createDistributeMenu(t,i,s,n){new LiteGraph.ContextMenu(["Vertically","Horizontally"],{event:s,callback:o,parentMenu:n});function o(r){const a=O.active_canvas;distributeNodes(Object.values(a.selected_nodes),r==="Horizontally"),a.setDirty(!0,!0)}}static onMenuAdd(t,i,s,n,o){const r=O.active_canvas,a=r.getCanvasWindow(),{graph:l}=r;if(!l)return;return h("",n),!1;function h(c,p){if(!l)return;const f=LiteGraph.getNodeTypesCategories(r.filter||l.filter).filter(m=>m.startsWith(c)),g=[];for(const m of f){if(!m)continue;const y=new RegExp(`^(${c})`),w=m.replace(y,"").split("/",1)[0],k=c===""?`${w}/`:`${c}${w}/`;let L=w;L.includes("::")&&(L=L.split("::",2)[1]),g.findIndex(S=>S.value===k)===-1&&g.push({value:k,content:L,has_submenu:!0,callback:function(S,T,G,D){h(S.value,D)}})}const _=LiteGraph.getNodeTypesInCategory(c.slice(0,-1),r.filter||l.filter);for(const m of _){if(m.skip_list)continue;const y={value:m.type,content:m.title,has_submenu:!1,callback:function(w,k,L,E){if(!r.graph)throw new NullGraphError;const S=E.getFirstEvent();r.graph.beforeChange();const T=LiteGraph.createNode(w.value);if(T){if(!S)throw new TypeError("Context menu event was null. This should not occur in normal usage.");T.pos=r.convertEventToCanvasOffset(S),r.graph.add(T)}else console.warn("Failed to create node of type:",w.value);o==null||o(T),r.graph.afterChange()}};g.push(y)}new LiteGraph.ContextMenu(g,{event:s,parentMenu:p},a)}}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalOutputs(t,i,s,n,o){var c;if(!o)return;const r=O.active_canvas;let a=[];LiteGraph.do_add_triggers_slots&&o.findOutputSlot("onExecuted")==-1&&a.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"});const l=(c=o.onMenuNodeOutputs)==null?void 0:c.call(o,a);if(l&&(a=l),!a.length)return;new LiteGraph.ContextMenu(a,{event:s,callback:h,parentMenu:n,node:o});function h(p,f,g){var y;if(!o||(p.callback&&p.callback.call(this,o,p,f,g),!p.value))return;const _=p.value[1];if(_&&(typeof _=="object"||Array.isArray(_))){const w=[];for(const k in _)w.push({content:k,value:_[k]});return new LiteGraph.ContextMenu(w,{event:f,callback:h,parentMenu:n,node:o}),!1}const{graph:m}=o;if(!m)throw new NullGraphError;m.beforeChange(),o.addOutput(p.value[0],p.value[1],p.value[2]),(y=o.onNodeOutputAdd)==null||y.call(o,p.value),r.setDirty(!0,!0),m.afterChange()}return!1}static onShowMenuNodeProperties(t,i,s,n,o){if(!o||!o.properties)return;const r=O.active_canvas,a=r.getCanvasWindow(),l=[];for(const c in o.properties){t=o.properties[c]!==void 0?o.properties[c]:" ",typeof t=="object"&&(t=JSON.stringify(t));const p=o.getPropertyInfo(c);(p.type=="enum"||p.type=="combo")&&(t=O.getPropertyPrintableValue(t,p.values)),t=O.decodeHTML(stringOrEmpty(t)),l.push({content:`<span class='property_name'>${p.label||c}</span><span class='property_value'>${t}</span>`,value:c})}if(!l.length)return;new LiteGraph.ContextMenu(l,{event:s,callback:h,parentMenu:n,allow_html:!0,node:o},a);function h(c){if(!o)return;const p=this.getBoundingClientRect();r.showEditPropertyValue(o,c.value,{position:[p.left,p.top]})}return!1}static decodeHTML(t){const i=document.createElement("div");return i.textContent=t,i.innerHTML}static onMenuResizeNode(t,i,s,n,o){if(!o)return;const r=function(l){l.setSize(l.computeSize())},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);a.setDirty(!0,!0)}static onShowPropertyEditor(t,i,s,n,o){const r=t.property||"title",a=o[r],l=document.createElement("span");l.className="name",l.textContent=r;const h=document.createElement("input");Object.assign(h,{type:"text",className:"value",autofocus:!0});const c=document.createElement("button");c.textContent="OK";const p=Object.assign(document.createElement("div"),{is_modified:!1,className:"graphdialog",close:()=>p.remove()});p.append(l,h,c),h.value=String(a),h.addEventListener("blur",function(){this.focus()}),h.addEventListener("keydown",E=>{if(p.is_modified=!0,E.key=="Escape")p.close();else if(E.key=="Enter")k();else if(!E.target||!("localName"in E.target)||E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()});const f=O.active_canvas,g=f.canvas,_=g.getBoundingClientRect(),m=_?-20-_.left:-20,y=_?-20-_.top:-20;if(s?(p.style.left=`${s.clientX+m}px`,p.style.top=`${s.clientY+y}px`):(p.style.left=`${g.width*.5+m}px`,p.style.top=`${g.height*.5+y}px`),c.addEventListener("click",k),g.parentNode==null)throw new TypeError("canvasEl.parentNode was null");g.parentNode.append(p),h.focus();let w;p.addEventListener("mouseleave",function(){LiteGraph.dialog_close_on_mouse_leave&&!p.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(w=setTimeout(p.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),p.addEventListener("mouseenter",function(){LiteGraph.dialog_close_on_mouse_leave&&w&&clearTimeout(w)});function k(){h&&L(h.value)}function L(E){t.type=="Number"?E=Number(E):t.type=="Boolean"&&(E=!!E),o[r]=E,p.remove(),f.setDirty(!0,!0)}}static getPropertyPrintableValue(t,i){if(!i||Array.isArray(i))return String(t);if(typeof i=="object"){let s="";for(const n in i)if(i[n]==t){s=n;break}return`${String(t)} (${s})`}}static onMenuNodeCollapse(t,i,s,n,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.collapse()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuToggleAdvanced(t,i,s,n,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.toggleAdvanced()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuNodeMode(t,i,s,n,o){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:s,callback:r,parentMenu:n,node:o});function r(a){if(!o)return;const l=Object.values(LiteGraph.NODE_MODES).indexOf(a),h=function(p){l!==-1&&LiteGraph.NODE_MODES[l]?p.changeMode(l):(console.warn(`unexpected mode: ${a}`),p.changeMode(LGraphEventMode.ALWAYS))},c=O.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)h(o);else for(const p in c.selected_nodes)h(c.selected_nodes[p])}return!1}static onMenuNodeColors(t,i,s,n,o){if(!o)throw"no node for color";const r=[];r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const l in O.node_colors){const h=O.node_colors[l];t={value:l,content:`<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid ${h.color}; background-color:${h.bgcolor}'>${l}</span>`},r.push(t)}new LiteGraph.ContextMenu(r,{event:s,callback:a,parentMenu:n,node:o});function a(l){if(!o)return;const h=function(p){const f=l.value?O.node_colors[l.value]:null;p.setColorOption(f)},c=O.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)h(o);else for(const p in c.selected_nodes)h(c.selected_nodes[p]);c.setDirty(!0,!0)}return!1}static onMenuNodeShapes(t,i,s,n,o){if(!o)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:s,callback:r,parentMenu:n,node:o});function r(a){if(!o)return;if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const l=function(c){c.shape=a},h=O.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(o);else for(const c in h.selected_nodes)l(h.selected_nodes[c]);o.graph.afterChange(),h.setDirty(!0)}return!1}static onMenuNodeRemove(){O.active_canvas.deleteSelected()}static onMenuNodeClone(t,i,s,n,o){const{graph:r}=o;if(!r)throw new NullGraphError;r.beforeChange();const a=new Set,l=function(c,p){if(c.clonable===!1)return;const f=c.clone();if(f){if(f.pos=[c.pos[0]+5,c.pos[1]+5],!c.graph)throw new NullGraphError;c.graph.add(f),p.add(f)}},h=O.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(o,a);else for(const c in h.selected_nodes)l(h.selected_nodes[c],a);a.size&&h.selectNodes([...a]),r.afterChange(),h.setDirty(!0,!0)}clear(){var t,i;this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.selectedItems.clear(),this.state.selectionChanged=!0,(t=this.onSelectionChange)==null||t.call(this,this.selected_nodes),this.visible_nodes=[],this.node_over=void 0,this.node_capturing_input=null,this.connecting_links=null,this.highlighted_links={},this.dragging_canvas=!1,N(this,F,wt).call(this),this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer.reset(),this.visible_area.set([0,0,0,0]),(i=this.onClear)==null||i.call(this)}setGraph(t){const{graph:i}=this;t!==i&&(this.clear(),t.attachCanvas(this),this.dispatch("litegraph:set-graph",{newGraph:t,oldGraph:i}),N(this,F,wt).call(this))}openSubgraph(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s={bubbles:!0,detail:{subgraph:t,closingGraph:i},cancelable:!0};this.canvas.dispatchEvent(new CustomEvent("subgraph-opening",s))&&(this.clear(),this.subgraph=t,this.setGraph(t),this.canvas.dispatchEvent(new CustomEvent("subgraph-opened",s)))}getCurrentGraph(){return this.graph}setCanvas(t,i){var o;const s=N(this,F,Ti).call(this,t);if(s===this.canvas||(!s&&this.canvas&&!i&&this.unbindEvents(),this.canvas=s,this.ds.element=s,this.pointer.element=s,!s))return;s.className+=" lgraphcanvas",s.data=this,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height;const n=(o=s.getContext)==null?void 0:o.call(s,"2d");if(n==null)throw s.localName!="canvas"?`Element supplied for LGraphCanvas must be a <canvas> element, you passed a ${s.localName}`:"This browser doesn't support Canvas";this.ctx=n,i||this.bindEvents()}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already bound");return}const{canvas:t}=this,{document:i}=this.getCanvasWindow();this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),this._mouseout_callback=this.processMouseOut.bind(this),this._mousecancel_callback=this.processMouseCancel.bind(this),t.addEventListener("pointerdown",this._mousedown_callback,!0),t.addEventListener("wheel",this._mousewheel_callback,!1),t.addEventListener("pointerup",this._mouseup_callback,!0),t.addEventListener("pointermove",this._mousemove_callback),t.addEventListener("pointerout",this._mouseout_callback),t.addEventListener("pointercancel",this._mousecancel_callback,!0),t.addEventListener("contextmenu",this._doNothing),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),i.addEventListener("keyup",this._key_callback,!0),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events bound");return}const{document:t}=this.getCanvasWindow(),{canvas:i}=this;i.removeEventListener("pointercancel",this._mousecancel_callback),i.removeEventListener("pointerout",this._mouseout_callback),i.removeEventListener("pointermove",this._mousemove_callback),i.removeEventListener("pointerup",this._mouseup_callback),i.removeEventListener("pointerdown",this._mousedown_callback),i.removeEventListener("wheel",this._mousewheel_callback),i.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),i.removeEventListener("contextmenu",this._doNothing),i.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=void 0,this._mousewheel_callback=void 0,this._key_callback=void 0,this._events_binded=!1}setDirty(t,i){t&&(this.dirty_canvas=!0),i&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();const i=this.getCanvasWindow();if(this.is_rendering)if(I(this,Ot)>0){const s=I(this,Ot)-(LiteGraph.getTime()-this.last_draw_time);setTimeout(t.bind(this),Math.max(1,s))}else i.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}getWidgetAtCursor(t){return t??(t=this.node_over),t==null?void 0:t.getWidgetOnPos(this.graph_mouse[0],this.graph_mouse[1],!0)}updateMouseOverNodes(t,i){var o,r;if(!this.graph)throw new NullGraphError;const{pointer:s}=this,n=this.graph._nodes;for(const a of n)a.mouseOver&&t!=a&&(s.eDown||(s.resizeDirection=void 0),a.mouseOver=void 0,this._highlight_input=void 0,this._highlight_pos=void 0,this.linkConnector.overWidget=void 0,a.lostFocusAt=LiteGraph.getTime(),(r=(o=this.node_over)==null?void 0:o.onMouseLeave)==null||r.call(o,i),this.node_over=void 0,this.dirty_canvas=!0)}processMouseDown(t){var h,c;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&!t.altKey&&t.buttons){U(this,Pt,{pos:[t.x,t.y],scale:this.ds.scale});return}const{graph:i,pointer:s}=this;if(this.adjustMouseEvent(t),t.isPrimary&&s.down(t),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!i)return;const n=this.getCanvasWindow();O.active_canvas=this;const o=t.clientX,r=t.clientY;if(this.ds.viewport=this.viewport,!(!this.viewport||isInRect(o,r,this.viewport)))return;const l=i.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes)??void 0;if(this.mouse[0]=o,this.mouse[1]=r,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],s.isDouble=s.isDown&&t.isPrimary,s.isDown=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(n),((h=this.onMouse)==null?void 0:h.call(this,t))!=!0){if(t.button===0&&!s.isDouble)N(this,F,Ni).call(this,t,l);else if(t.button===1)N(this,F,Di).call(this,t,l);else if((t.button===2||s.isDouble)&&this.allow_interaction&&!this.read_only){const{linkConnector:p,subgraph:f}=this;if(f!=null&&f.inputNode.containsPoint(this.graph_mouse))this.processSelect(f.inputNode,t,!0),f.inputNode.onPointerDown(t,s,p);else if(f!=null&&f.outputNode.containsPoint(this.graph_mouse))this.processSelect(f.outputNode,t,!0),f.outputNode.onPointerDown(t,s,p);else{if(l)this.processSelect(l,t,!0);else if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const g=i.getRerouteOnPos(t.canvasX,t.canvasY,I(this,yt));g&&(t.altKey?s.onClick=_=>{var m;_.altKey&&(g.selected&&(this.deselect(g),(m=this.onSelectionChange)==null||m.call(this,this.selected_nodes)),g.remove())}:this.processSelect(g,t,!0))}s.onClick??(s.onClick=()=>this.processContextMenu(l,t))}}this.last_mouse=[o,r],this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,i.change(),(!n.document.activeElement||n.document.activeElement.nodeName.toLowerCase()!="input"&&n.document.activeElement.nodeName.toLowerCase()!="textarea")&&t.preventDefault(),t.stopPropagation(),(c=this.onMouseDown)==null||c.call(this,t)}}processMouseMove(t){var _,m,y,w;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&I(this,Pt)){N(this,F,Gi).call(this,t);return}this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0);const{graph:i,resizingGroup:s,linkConnector:n,pointer:o,subgraph:r}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const a=[t.clientX,t.clientY];this.mouse[0]=a[0],this.mouse[1]=a[1];const l=[a[0]-this.last_mouse[0],a[1]-this.last_mouse[1]];this.last_mouse=a;const{canvasX:h,canvasY:c}=t;this.graph_mouse[0]=h,this.graph_mouse[1]=c,t.isPrimary&&o.move(t);let p=CanvasItem.Nothing;if(r&&(p|=r.inputNode.onPointerMove(t),p|=r.outputNode.onPointerMove(t)),this.block_click){t.preventDefault();return}if(t.dragging=this.last_mouse_dragging,this.node_widget){const[k,L]=this.node_widget;if(L!=null&&L.mouse){const E=h-k.pos[0],S=c-k.pos[1],T=L.mouse(t,[E,S],k);T!=null&&(this.dirty_canvas=T)}}const f=i.getNodeOnPos(h,c,this.visible_nodes),g=this.dragging_rectangle;if(g)g[2]=h-g[0],g[3]=c-g[1],this.dirty_canvas=!0;else if(s)p|=CanvasItem.Group,o.resizeDirection="SE";else if(this.dragging_canvas)this.ds.offset[0]+=l[0]/this.ds.scale,this.ds.offset[1]+=l[1]/this.ds.scale,N(this,F,wt).call(this);else if((this.allow_interaction||f!=null&&f.flags.allow_interaction)&&!this.read_only){if(n.isConnecting&&(this.dirty_canvas=!0),this.updateMouseOverNodes(f,t),f){p|=CanvasItem.Node,f.redraw_on_mouse&&(this.dirty_canvas=!0);const k=[0,0],L=isOverNodeInput(f,h,c,k),E=isOverNodeOutput(f,h,c,k),S=f.getWidgetOnPos(h,c,!0)??void 0;if(!f.mouseOver){f.mouseOver={},this.node_over=f,this.dirty_canvas=!0;for(const G of I(this,yt))G.hideSlots(),this.dirty_bgcanvas=!0;(_=f.onMouseEnter)==null||_.call(f,t)}(m=f.onMouseMove)==null||m.call(f,t,[h-f.pos[0],c-f.pos[1]],this);const{mouseOver:T}=f;if(T.inputId!==L||T.outputId!==E||T.overWidget!==S){if(T.inputId=L,T.outputId=E,T.overWidget=S,n.overWidget=void 0,n.isConnecting){const G=n.renderLinks.at(0);let D,C;if(!(!G||!n.isNodeValidDrop(f))){if(n.state.connectingTo==="input"){if(S){const R=f.getSlotFromWidget(S);R&&n.isInputValidDrop(f,R)&&(C=R,D=f.getInputSlotPos(R),n.overWidget=S)}if(!n.overWidget){if(L===-1&&E===-1){const R=f.findInputByType(G.fromSlot.type);R&&(C=R.slot,D=f.getInputSlotPos(R.slot))}else L!=-1&&f.inputs[L]&&LiteGraph.isValidConnection(G.fromSlot.type,f.inputs[L].type)&&(D=k,C=f.inputs[L]);if(C){const R=f.getWidgetFromSlot(C);R&&(n.overWidget=R)}}}else if(n.state.connectingTo==="output")if(L===-1&&E===-1){const R=f.findOutputByType(G.fromSlot.type);R&&(D=f.getOutputPos(R.index))}else E!=-1&&f.outputs[E]&&LiteGraph.isValidConnection(G.fromSlot.type,f.outputs[E].type)&&(D=k)}this._highlight_pos=D,this._highlight_input=C}this.dirty_canvas=!0}o.eDown||(L===-1&&E===-1&&!S?o.resizeDirection=f.findResizeDirection(h,c):o.resizeDirection&&(o.resizeDirection=void 0))}else{p=N(this,F,Ai).call(this,p);const k=N(this,F,Pi).call(this,t);if(this.over_link_center!==k&&(p|=CanvasItem.Link,this.over_link_center=k,this.dirty_bgcanvas=!0),this.canvas){const L=i.getGroupOnPos(h,c);L&&!t.ctrlKey&&!this.read_only&&L.isInResize(h,c)?o.resizeDirection="SE":o.resizeDirection&&(o.resizeDirection=void 0)}}if(this.node_capturing_input&&this.node_capturing_input!=f&&((w=(y=this.node_capturing_input).onMouseMove)==null||w.call(y,t,[h-this.node_capturing_input.pos[0],c-this.node_capturing_input.pos[1]],this)),this.isDragging){const k=this.selectedItems,L=t.ctrlKey?k:getAllNestedItems(k),E=l[0]/this.ds.scale,S=l[1]/this.ds.scale;for(const T of L)T.move(E,S,!0);N(this,F,wt).call(this)}}this.hoveringOver=p,t.preventDefault()}processMouseUp(t){var r,a,l,h;if(t.isPrimary===!1)return;const{graph:i,pointer:s}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const n=LiteGraph.getTime();if(t.click_time=n-this.last_mouseclick,s.up(t)===!0){s.isDown=!1,s.isDouble=!1,this.connecting_links=null,this.dragging_canvas=!1,i.change(),t.stopPropagation(),t.preventDefault();return}if(this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),t.button===0){this.selected_group=null,this.isDragging=!1;const c=t.canvasX,p=t.canvasY;this.linkConnector.isConnecting||(this.dirty_canvas=!0,(a=(r=this.node_over)==null?void 0:r.onMouseUp)==null||a.call(r,t,[c-this.node_over.pos[0],p-this.node_over.pos[1]],this),(h=(l=this.node_capturing_input)==null?void 0:l.onMouseUp)==null||h.call(l,t,[c-this.node_capturing_input.pos[0],p-this.node_capturing_input.pos[1]]))}else t.button===1?(this.dirty_canvas=!0,this.dragging_canvas=!1):t.button===2&&(this.dirty_canvas=!0);s.isDown=!1,s.isDouble=!1,i.change(),t.stopPropagation(),t.preventDefault()}processMouseOut(t){this.adjustMouseEvent(t),this.updateMouseOverNodes(null,t)}processMouseCancel(){console.warn("Pointer cancel!"),this.pointer.reset()}processMouseWheel(t){if(!this.graph||!this.allow_dragcanvas)return;const i=t.wheelDeltaY??t.detail*-60;this.adjustMouseEvent(t);const s=[t.clientX,t.clientY];if(this.viewport&&!isPointInRect(s,this.viewport))return;let{scale:n}=this.ds;LiteGraph.canvasNavigationMode==="legacy"||LiteGraph.canvasNavigationMode==="standard"&&t.ctrlKey?(i>0?n*=this.zoom_speed:i<0&&(n*=1/this.zoom_speed),this.ds.changeScale(n,[t.clientX,t.clientY])):LiteGraph.macTrackpadGestures&&(!LiteGraph.macGesturesRequireMac||navigator.userAgent.includes("Mac"))&&(t.metaKey&&!t.ctrlKey&&!t.shiftKey&&!t.altKey?(t.deltaY>0?n*=1/this.zoom_speed:t.deltaY<0&&(n*=this.zoom_speed),this.ds.changeScale(n,[t.clientX,t.clientY])):t.ctrlKey?(n*=1+t.deltaY*(1-this.zoom_speed)*.18,this.ds.changeScale(n,[t.clientX,t.clientY],!1)):t.shiftKey?this.ds.offset[0]-=t.deltaY*1.18*(1/n):(this.ds.offset[0]-=t.deltaX*1.18*(1/n),this.ds.offset[1]-=t.deltaY*1.18*(1/n))),this.graph.change(),t.preventDefault()}processKey(t){var n,o,r,a;U(this,be,t.shiftKey);const{graph:i}=this;if(!i)return;let s=!1;if(t.target.localName!="input"){if(t.type=="keydown"){if(t.key===" ")this.read_only=!0,this._previously_dragging_canvas===null&&(this._previously_dragging_canvas=this.dragging_canvas),this.dragging_canvas=this.pointer.isDown,s=!0;else if(t.key==="Escape"){if(this.linkConnector.isConnecting){this.linkConnector.reset(),t.preventDefault();return}(n=this.node_panel)==null||n.close(),(o=this.options_panel)==null||o.close(),(this.node_panel||this.options_panel)&&(s=!0)}else if(t.keyCode===65&&t.ctrlKey)this.selectItems(),s=!0;else if(t.keyCode===67&&(t.metaKey||t.ctrlKey)&&!t.shiftKey)this.selected_nodes&&(this.copyToClipboard(),s=!0);else if(t.keyCode===86&&(t.metaKey||t.ctrlKey))this.pasteFromClipboard({connectInputs:t.shiftKey});else if((t.key==="Delete"||t.key==="Backspace")&&t.target.localName!="input"&&t.target.localName!="textarea"){if(this.selectedItems.size===0){N(this,F,Fi).call(this);return}this.deleteSelected(),s=!0}for(const l of Object.values(this.selected_nodes))(r=l.onKeyDown)==null||r.call(l,t)}else if(t.type=="keyup"){t.key===" "&&(this.read_only=!1,this.dragging_canvas=(this._previously_dragging_canvas??!1)&&this.pointer.isDown,this._previously_dragging_canvas=null);for(const l of Object.values(this.selected_nodes))(a=l.onKeyUp)==null||a.call(l,t)}i.change(),s&&(t.preventDefault(),t.stopImmediatePropagation())}}copyToClipboard(t){var n,o,r;const i={nodes:[],groups:[],reroutes:[],links:[],subgraphs:[]},s=new Set;for(const a of t??this.selectedItems)if(a instanceof LGraphNode){if(a.clonable===!1)continue;const l=(n=a.clone())==null?void 0:n.serialize();if(!l)continue;if(l.id=a.id,i.nodes.push(l),a.inputs)for(const{link:h}of a.inputs){if(h==null)continue;const c=(r=(o=this.graph)==null?void 0:o._links.get(h))==null?void 0:r.asSerialisable();c&&i.links.push(c)}a instanceof SubgraphNode&&s.add(a.subgraph)}else a instanceof LGraphGroup?i.groups.push(a.serialize()):a instanceof Reroute&&i.reroutes.push(a.asSerialisable());for(const a of s){const l=a.clone(!0).asSerialisable();i.subgraphs.push(l)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(i))}emitEvent(t){this.canvas.dispatchEvent(new CustomEvent("litegraph:canvas",{bubbles:!0,detail:t}))}emitBeforeChange(){this.emitEvent({subType:"before-change"})}emitAfterChange(){this.emitEvent({subType:"after-change"})}_pasteFromClipboard(t={}){var _;const{connectInputs:i=!1,position:s=this.graph_mouse}=t;if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&i)return;const n=localStorage.getItem("litegrapheditor_clipboard");if(!n)return;const{graph:o}=this;if(!o)throw new NullGraphError;o.beforeChange();const r=JSON.parse(n);r.nodes??(r.nodes=[]),r.groups??(r.groups=[]),r.reroutes??(r.reroutes=[]),r.links??(r.links=[]),r.subgraphs??(r.subgraphs=[]);let a=1/0,l=1/0;for(const m of[...r.nodes,...r.reroutes]){if(m.pos==null)throw new TypeError("Invalid node encounterd on paste.  `pos` was null.");m.pos[0]<a&&(a=m.pos[0]),m.pos[1]<l&&(l=m.pos[1])}if(r.groups)for(const m of r.groups)m.bounding[0]<a&&(a=m.bounding[0]),m.bounding[1]<l&&(l=m.bounding[1]);const h={created:[],nodes:new Map,links:new Map,reroutes:new Map,subgraphs:new Map},{created:c,nodes:p,links:f,reroutes:g}=h;for(const m of r.subgraphs){const y=m.id;m.id=createUuidv4();const w=o.createSubgraph(m);w.configure(m),h.subgraphs.set(y,w)}for(const m of r.groups){m.id=-1;const y=new LGraphGroup;y.configure(m),o.add(y),c.push(y)}for(const m of r.nodes){const y=h.subgraphs.get(m.type);y&&(m.type=y.id);const w=m.type==null?null:LiteGraph.createNode(m.type);w&&(p.set(m.id,w),m.id=-1,w.configure(m),o.add(w),c.push(w))}for(const m of r.reroutes){const{id:y,...w}=m,k=o.setReroute(w);c.push(k),g.set(y,k)}for(const m of g.values()){if(m.parentId==null)continue;const y=g.get(m.parentId);y&&(m.parentId=y.id)}for(const m of r.links){let y=p.get(m.origin_id),w;m.parentId!=null&&(w=(_=g.get(m.parentId))==null?void 0:_.id),i&&LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&(y??(y=o.getNodeById(m.origin_id)),w??(w=m.parentId));const k=p.get(m.target_id);if(k){const L=y==null?void 0:y.connect(m.origin_slot,k,m.target_slot,w);L&&f.set(m.id,L)}}for(const m of g.values()){const y=[...m.linkIds].map(w=>{var k;return((k=f.get(w))==null?void 0:k.id)??w});m.update(m.parentId,void 0,y,m.floating),m.validateLinks(o.links,o.floatingLinks)||o.removeReroute(m.id)}for(const m of c)m.pos[0]+=s[0]-a,m.pos[1]+=s[1]-l;return this.selectItems(c),o.afterChange(),h}pasteFromClipboard(t={}){this.emitBeforeChange();try{this._pasteFromClipboard(t)}finally{this.emitAfterChange()}}processNodeDblClicked(t){var i,s;(i=this.onShowNodePanel)==null||i.call(this,t),(s=this.onNodeDblClicked)==null||s.call(this,t),this.setDirty(!0)}processSelect(t,i,s=!1){var l;const n=i==null?void 0:i.shiftKey,o=i!=null&&(i.metaKey||i.ctrlKey),r=n||o,a=r||this.multi_select;if(!t)(!r||this.multi_select)&&this.deselectAll();else if(!t.selected||!this.selectedItems.has(t))a||this.deselectAll(t),this.select(t);else if(a&&!s)this.deselect(t);else if(!s)this.deselectAll(t);else return;(l=this.onSelectionChange)==null||l.call(this,this.selected_nodes),this.setDirty(!0)}select(t){var i,s;if(!(t.selected&&this.selectedItems.has(t))&&(t.selected=!0,this.selectedItems.add(t),this.state.selectionChanged=!0,t instanceof LGraphNode)){if((i=t.onSelected)==null||i.call(t),this.selected_nodes[t.id]=t,(s=this.onNodeSelected)==null||s.call(this,t),t.inputs)for(const n of t.inputs)n.link!=null&&(this.highlighted_links[n.link]=!0);if(t.outputs)for(const n of t.outputs.flatMap(o=>o.links))n!=null&&(this.highlighted_links[n]=!0)}}deselect(t){var s,n;if(!t.selected&&!this.selectedItems.has(t)||(t.selected=!1,this.selectedItems.delete(t),this.state.selectionChanged=!0,!(t instanceof LGraphNode)))return;(s=t.onDeselected)==null||s.call(t),delete this.selected_nodes[t.id],(n=this.onNodeDeselected)==null||n.call(this,t);const{graph:i}=this;if(i){if(t.inputs)for(const o of t.inputs){if(o.link==null)continue;const r=LLink.getOriginNode(i,o.link);r&&this.selectedItems.has(r)||delete this.highlighted_links[o.link]}if(t.outputs)for(const o of t.outputs.flatMap(r=>r.links)){if(o==null)continue;const r=LLink.getTargetNode(i,o);r&&this.selectedItems.has(r)||delete this.highlighted_links[o]}}}processNodeSelected(t,i){this.processSelect(t,i,i&&(i.shiftKey||i.metaKey||i.ctrlKey||this.multi_select))}selectNode(t,i){t==null?this.deselectAll():this.selectNodes([t],i)}get empty(){if(!this.graph)throw new NullGraphError;return this.graph.empty}get positionableItems(){if(!this.graph)throw new NullGraphError;return this.graph.positionableItems()}selectItems(t,i){var n;const s=t??this.positionableItems;i||this.deselectAll();for(const o of s)this.select(o);(n=this.onSelectionChange)==null||n.call(this,this.selected_nodes),this.setDirty(!0)}selectNodes(t,i){this.selectItems(t,i)}deselectNode(t){this.deselect(t)}deselectAll(t){var o,r;if(!this.graph)return;const i=this.selectedItems;if(!i.size)return;let s;for(const a of i){if(a===t){s=a;continue}(o=a.onDeselected)==null||o.call(a),a.selected=!1}i.clear(),s&&i.add(s),this.setDirty(!0);const n=(t==null?void 0:t.id)==null?null:this.selected_nodes[t.id];if(this.selected_nodes={},this.current_node=null,this.highlighted_links={},t instanceof LGraphNode){if(n&&(this.selected_nodes[n.id]=n),t.inputs)for(const a of t.inputs)a.link!=null&&(this.highlighted_links[a.link]=!0);if(t.outputs)for(const a of t.outputs.flatMap(l=>l.links))a!=null&&(this.highlighted_links[a]=!0)}this.state.selectionChanged=!0,(r=this.onSelectionChange)==null||r.call(this,this.selected_nodes)}deselectAllNodes(){this.deselectAll()}deleteSelected(){var i,s;const{graph:t}=this;if(!t)throw new NullGraphError;this.emitBeforeChange(),t.beforeChange();for(const n of this.selectedItems)if(n instanceof LGraphNode){const o=n;if(o.block_delete)continue;o.connectInputToOutput(),t.remove(o),(i=this.onNodeDeselected)==null||i.call(this,o)}else n instanceof LGraphGroup?t.remove(n):n instanceof Reroute&&t.removeReroute(n.id);this.selected_nodes={},this.selectedItems.clear(),this.current_node=null,this.highlighted_links={},this.state.selectionChanged=!0,(s=this.onSelectionChange)==null||s.call(this,this.selected_nodes),this.setDirty(!0),t.afterChange(),this.emitAfterChange()}deleteSelectedNodes(){this.deleteSelected()}centerOnNode(t){const i=(window==null?void 0:window.devicePixelRatio)||1;this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/(this.ds.scale*i),this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/(this.ds.scale*i),this.setDirty(!0,!0)}adjustMouseEvent(t){let i=t.clientX,s=t.clientY;if(this.canvas){const n=this.canvas.getBoundingClientRect();i-=n.left,s-=n.top}t.safeOffsetX=i,t.safeOffsetY=s,t.deltaX===void 0&&(t.deltaX=i-this.last_mouse_position[0]),t.deltaY===void 0&&(t.deltaY=s-this.last_mouse_position[1]),this.last_mouse_position[0]=i,this.last_mouse_position[1]=s,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=s/this.ds.scale-this.ds.offset[1]}setZoom(t,i){this.ds.changeScale(t,i),N(this,F,wt).call(this)}convertOffsetToCanvas(t,i){return this.ds.convertOffsetToCanvas(t,i)}convertCanvasToOffset(t,i){return this.ds.convertCanvasToOffset(t,i)}convertEventToCanvasOffset(t){const i=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-i.left,t.clientY-i.top])}bringToFront(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s=i._nodes.indexOf(t);s!=-1&&(i._nodes.splice(s,1),i._nodes.push(t))}sendToBack(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s=i._nodes.indexOf(t);s!=-1&&(i._nodes.splice(s,1),i._nodes.unshift(t))}computeVisibleNodes(t,i){const s=i||[];if(s.length=0,!this.graph)throw new NullGraphError;const n=t||this.graph._nodes;for(const o of n)o.updateArea(this.ctx),overlapBounding(this.visible_area,o.renderArea)&&s.push(o);return s}isNodeVisible(t){return I(this,ve).has(t.id)}draw(t,i){var n;if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const s=LiteGraph.getTime();if(this.render_time=(s-this.last_draw_time)*.001,this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(this.viewport),this.dirty_canvas||t){this.computeVisibleNodes(void 0,this.visible_nodes),U(this,ve,new Set(this.visible_nodes.map(r=>r.id)));const{subgraph:o}=this;o&&(o.inputNode.arrange(),o.outputNode.arrange())}(this.dirty_bgcanvas||i||this.always_render_background||(n=this.graph)!=null&&n._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame++}drawFrontCanvas(){var r,a,l,h,c,p,f;this.dirty_canvas=!1;const{ctx:t,canvas:i,graph:s,linkConnector:n}=this;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));const o=this.viewport||this.dirty_area;if(o&&(t.save(),t.beginPath(),t.rect(o[0],o[1],o[2],o[3]),t.clip()),U(this,ct,I(this,be)||LiteGraph.alwaysSnapToGrid?(r=this.graph)==null?void 0:r.getSnapToGridSize():void 0),this.clear_background&&(o?t.clearRect(o[0],o[1],o[2],o[3]):t.clearRect(0,0,i.width,i.height)),this.bgcanvas==this.canvas)this.drawBackCanvas();else{const g=window.devicePixelRatio;t.drawImage(this.bgcanvas,0,0,this.bgcanvas.width/g,this.bgcanvas.height/g)}if((a=this.onRender)==null||a.call(this,i,t),this.show_info&&this.renderInfo(t,o?o[0]:0,o?o[1]:0),s){t.save(),this.ds.toCanvasContext(t);const{visible_nodes:g}=this,_=I(this,ct)&&this.isDragging;for(const m of g)t.save(),_&&this.selectedItems.has(m)&&this.drawSnapGuide(t,m),t.translate(m.pos[0],m.pos[1]),this.drawNode(m,t),t.restore();if((h=this.subgraph)==null||h.draw(t,this.colourGetter,(l=this.linkConnector.renderLinks[0])==null?void 0:l.fromSlot,this.editor_alpha),this.render_execution_order&&this.drawExecutionOrder(t),s.config.links_ontop&&this.drawConnections(t),n.isConnecting){const{renderLinks:m}=n,y=N(this,F,Wi).call(this);t.lineWidth=this.connections_width;for(const w of m){const{fromSlot:k,fromPos:L,fromDirection:E,dragDirection:S}=w,T=k.shape,G=k.type,D=G===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR;this.renderLink(t,L,y,null,!1,null,D,E,S),t.beginPath(),G===LiteGraph.EVENT||T===RenderShape.BOX?(t.rect(L[0]-6+.5,L[1]-5+.5,14,10),t.rect(y[0]-6+.5,y[1]-5+.5,14,10)):T===RenderShape.ARROW?(t.moveTo(L[0]+8,L[1]+.5),t.lineTo(L[0]-4,L[1]+6+.5),t.lineTo(L[0]-4,L[1]-6+.5),t.closePath()):(t.arc(L[0],L[1],4,0,Math.PI*2),t.arc(y[0],y[1],4,0,Math.PI*2)),t.fill()}N(this,F,Mi).call(this,t,y)}if(this.dragging_rectangle){const{eDown:m,eMove:y}=this.pointer;if(t.strokeStyle="#FFF",m&&y){const w=t.getTransform(),k=Math.max(1,window.devicePixelRatio);t.setTransform(k,0,0,k,0,0);const L=m.safeOffsetX,E=m.safeOffsetY;t.strokeRect(L,E,y.safeOffsetX-L,y.safeOffsetY-E),t.setTransform(w)}else{const[w,k,L,E]=this.dragging_rectangle;t.strokeRect(w,k,L,E)}}!this.isDragging&&this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):(c=this.onDrawLinkTooltip)==null||c.call(this,t,null),(p=this.onDrawForeground)==null||p.call(this,t,this.visible_area),t.restore()}(f=this.onDrawOverlay)==null||f.call(this,t),o&&t.restore()}renderInfo(t,i,s){i=i||10,s=s||this.canvas.offsetHeight-80,t.save(),t.translate(i,s),t.font=`10px ${LiteGraph.DEFAULT_FONT}`,t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText(`T: ${this.graph.globaltime.toFixed(2)}s`,5,13*1),t.fillText(`I: ${this.graph.iteration}`,5,13*2),t.fillText(`N: ${this.graph._nodes.length} [${this.visible_nodes.length}]`,5,13*3),t.fillText(`V: ${this.graph._version}`,5,13*4),t.fillText(`FPS:${this.fps.toFixed(2)}`,5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var o;const t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const i=this.bgctx;if(!i)throw new TypeError("Background canvas context was null.");const s=this.viewport||[0,0,i.canvas.width,i.canvas.height];this.clear_background&&i.clearRect(s[0],s[1],s[2],s[3]);const n=this.onRenderBackground?this.onRenderBackground(t,i):!1;if(!this.viewport){const r=window.devicePixelRatio;i.restore(),i.setTransform(r,0,0,r,0,0)}if(this.graph){if(i.save(),this.ds.toCanvasContext(i),this.ds.scale<1.5&&!n&&this.clear_background_color&&(i.fillStyle=this.clear_background_color,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!n){if(this.zoom_modify_alpha?i.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:i.globalAlpha=this.editor_alpha,i.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const a=this;this._bg_img.addEventListener("load",function(){a.draw(!0,!0)})}let r=this._pattern;r==null&&this._bg_img.width>0&&(r=i.createPattern(this._bg_img,"repeat")??void 0,this._pattern_img=this._bg_img,this._pattern=r),r&&(i.fillStyle=r,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),i.fillStyle="transparent"),i.globalAlpha=1,i.imageSmoothingEnabled=!0}this.graph._groups.length&&this.drawGroups(t,i),(o=this.onDrawBackground)==null||o.call(this,i,this.visible_area),this.render_canvas_border&&(i.strokeStyle="#235",i.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(i.shadowColor="#000",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=6):i.shadowColor="rgba(0,0,0,0)",this.drawConnections(i),i.shadowColor="rgba(0,0,0,0)",i.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,i){var h,c,p;this.current_node=t;const s=t.renderingColor,n=t.renderingBgColor,{low_quality:o,editor_alpha:r}=this;if(i.globalAlpha=r,this.render_shadows&&!o?(i.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",t.flags.collapsed&&((h=t.onDrawCollapsed)==null?void 0:h.call(t,i,this))==!0)return;const a=t._shape||RenderShape.BOX,l=I(O,Fe);if(l.set(t.renderingSize),t.collapsed&&(i.font=this.inner_text_font),t.clip_area&&(i.save(),i.beginPath(),a==RenderShape.BOX?i.rect(0,0,l[0],l[1]):a==RenderShape.ROUND?i.roundRect(0,0,l[0],l[1],[10]):a==RenderShape.CIRCLE&&i.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),i.clip()),this.drawNodeShape(t,i,l,s,n,!!t.selected),t.title_buttons&&!t.flags.collapsed){const f=LiteGraph.NODE_TITLE_HEIGHT;let g=l[0];for(let _=0;_<t.title_buttons.length;_++){const m=t.title_buttons[_];if(!m.visible)continue;const y=m.getWidth(i);g-=y;const w=-f+(f-m.height)/2;m.draw(i,g,w),g-=2}}o||t.drawBadges(i),i.shadowColor="transparent",i.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,(c=t.onDrawForeground)==null||c.call(t,i,this,this.canvas),i.font=this.inner_text_font,t._setConcreteSlots(),t.collapsed?this.render_collapsed_slots&&t.drawCollapsedSlots(i):(t.arrange(),t.drawSlots(i,{fromSlot:(p=this.linkConnector.renderLinks[0])==null?void 0:p.fromSlot,colorContext:this.colourGetter,editorAlpha:this.editor_alpha,lowQuality:this.low_quality}),i.textAlign="left",i.globalAlpha=1,this.drawNodeWidgets(t,null,i)),t.clip_area&&i.restore(),i.globalAlpha=1}drawLinkTooltip(t,i){var h;const s=i._pos;if(t.fillStyle="black",t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const c=t.getTransform();t.translate(s[0],s[1]),Number.isFinite(i._centreAngle)&&t.rotate(i._centreAngle),t.moveTo(-2,-3),t.lineTo(4,0),t.lineTo(-2,3),t.setTransform(c)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(s[0],s[1],3,0,Math.PI*2);t.fill();const{data:n}=i;if(n==null||((h=this.onDrawLinkTooltip)==null?void 0:h.call(this,t,i,this))==!0)return;let o=null;if(typeof n=="number"?o=n.toFixed(2):typeof n=="string"?o=`"${n}"`:typeof n=="boolean"?o=String(n):n.toToolTip?o=n.toToolTip():o=`[${n.constructor.name}]`,o==null)return;o=o.substring(0,30),t.font="14px Courier New";const a=t.measureText(o).width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(s[0]-a*.5,s[1]-15-l,a,l,[3]),t.moveTo(s[0]-10,s[1]-15),t.lineTo(s[0]+10,s[1]-15),t.lineTo(s[0],s[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(o,s[0],s[1]-15-l*.3)}drawNodeShape(t,i,s,n,o,r){var m,y;i.strokeStyle=n,i.fillStyle=o;const a=LiteGraph.NODE_TITLE_HEIGHT,{low_quality:l}=this,{collapsed:h}=t.flags,c=t.renderingShape,{title_mode:p}=t,f=!(p==TitleMode.TRANSPARENT_TITLE||p==TitleMode.NO_TITLE),g=I(O,xe);g.set(t.boundingRect),g[0]-=t.pos[0],g[1]-=t.pos[1];const _=i.globalAlpha;i.beginPath(),c==RenderShape.BOX||l?i.rect(g[0],g[1],g[2],g[3]):c==RenderShape.ROUND||c==RenderShape.CARD?i.roundRect(g[0],g[1],g[2],g[3],c==RenderShape.CARD?[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]:[LiteGraph.ROUND_RADIUS]):c==RenderShape.CIRCLE&&i.arc(s[0]*.5,s[1]*.5,s[0]*.5,0,Math.PI*2),i.fill(),!h&&f&&(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,g[2],2)),i.shadowColor="transparent",(m=t.onDrawBackground)==null||m.call(t,i),(f||p==TitleMode.TRANSPARENT_TITLE)&&(t.drawTitleBarBackground(i,{scale:this.ds.scale,low_quality:l}),t.drawTitleBox(i,{scale:this.ds.scale,low_quality:l,box_size:10}),i.globalAlpha=_,t.drawTitleText(i,{scale:this.ds.scale,default_title_color:this.node_title_color,low_quality:l}),(y=t.onDrawTitle)==null||y.call(t,i));for(const w of Object.values(t.strokeStyles)){const k=w.call(t);k&&strokeShape(i,g,{shape:c,title_height:a,title_mode:p,collapsed:h,...k})}t.drawProgressBar(i),t.execute_triggered!=null&&t.execute_triggered>0&&t.execute_triggered--,t.action_triggered!=null&&t.action_triggered>0&&t.action_triggered--}drawSnapGuide(t,i,s=RenderShape.ROUND){const n=I(O,Ae);n.set(i.boundingRect);const{pos:o}=i,r=o[0]-n[0],a=o[1]-n[1];n[0]+=r,n[1]+=a,I(this,ct)&&snapPoint(n,I(this,ct)),n[0]-=r,n[1]-=a;const{globalAlpha:l}=t;t.globalAlpha=1,t.beginPath();const[h,c,p,f]=n;if(s===RenderShape.CIRCLE){const g=h+p*.5,_=c+f*.5,m=Math.min(p*.5,f*.5);t.arc(g,_,m,0,Math.PI*2)}else t.rect(h,c,p,f);t.lineWidth=.5,t.strokeStyle="#FFFFFF66",t.fillStyle="#FFFFFF22",t.fill(),t.stroke(),t.globalAlpha=l}drawConnections(t){if(this.renderedPaths.clear(),this.links_render_mode===LinkRenderType.HIDDEN_LINK)return;const{graph:i,subgraph:s}=this;if(!i)throw new NullGraphError;const n=[],o=LiteGraph.getTime(),{visible_area:r}=this;I(O,Nt)[0]=r[0]-20,I(O,Nt)[1]=r[1]-20,I(O,Nt)[2]=r[2]+40,I(O,Nt)[3]=r[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;const a=i._nodes;for(const h of a){const{inputs:c}=h;if(c!=null&&c.length)for(const[p,f]of c.entries()){if(!f||f.link==null)continue;const g=f.link,_=i._links.get(g);if(!_)continue;const m=h.getInputPos(p),y=i.getNodeById(_.origin_id);if(y==null)continue;const w=_.origin_slot,k=w===-1?[y.pos[0]+10,y.pos[1]+10]:y.getOutputPos(w),L=y.outputs[w];L&&N(this,F,ne).call(this,t,_,k,m,n,o,L.dir,f.dir)}}if(s){for(const h of s.inputNode.slots)if(h.linkIds.length)for(const c of h.linkIds){const p=LLink.resolve(c,i);if(!p)continue;const{link:f,inputNode:g,input:_}=p;if(!g||!_)continue;const m=g.getInputPos(f.target_slot);N(this,F,ne).call(this,t,f,h.pos,m,n,o,_.dir,_.dir)}for(const h of s.outputNode.slots){if(!h.linkIds.length)continue;const c=LLink.resolve(h.linkIds[0],i);if(!c)continue;const{link:p,outputNode:f,output:g}=c;if(!f||!g)continue;const _=f.getOutputPos(p.origin_slot);N(this,F,ne).call(this,t,p,_,h.pos,n,o,g.dir,h.dir)}}i.floatingLinks.size>0&&N(this,F,Bi).call(this,t,i,n,o);const l=I(this,yt);l.clear(),n.sort((h,c)=>h.linkIds.size-c.linkIds.size);for(const h of n)l.add(h),I(this,ct)&&this.isDragging&&this.selectedItems.has(h)&&this.drawSnapGuide(t,h,RenderShape.CIRCLE),h.draw(t,this._pattern),this.pointer.isDown||h.drawSlots(t);t.globalAlpha=1}renderLink(t,i,s,n,o,r,a,l,h,{startControl:c,endControl:p,reroute:f,num_sublines:g=1,disabled:_=!1}={}){const m=n!=null&&this.highlighted_links[n.id]?"#FFF":a||(n==null?void 0:n.color)||(n==null?void 0:n.type)!=null&&O.link_type_colors[n.type]||this.default_link_color,y=l||LinkDirection.RIGHT,w=h||LinkDirection.LEFT,k=this.links_render_mode==LinkRenderType.SPLINE_LINK&&(!p||!c)?distance(i,s):0;this.render_connections_border&&!this.low_quality&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",g||(g=1),g>1&&(t.lineWidth=.5);const L=new Path2D,E=f??n;E&&(E.path=L);const S=I(O,Pe),T=I(O,We),G=(E==null?void 0:E._pos)??[0,0];for(let D=0;D<g;D++){const C=(D-(g-1)*.5)*5;if(S[0]=i[0],S[1]=i[1],T[0]=s[0],T[1]=s[1],this.links_render_mode==LinkRenderType.SPLINE_LINK){if(p?(T[0]=s[0]+p[0],T[1]=s[1]+p[1]):N(this,F,Oe).call(this,T,w,k),c?(S[0]=i[0]+c[0],S[1]=i[1]+c[1]):N(this,F,Oe).call(this,S,y,k),L.moveTo(i[0],i[1]+C),L.bezierCurveTo(S[0],S[1]+C,T[0],T[1]+C,s[0],s[1]+C),findPointOnCurve(G,i,s,S,T,.5),E&&this.linkMarkerShape===LinkMarkerShape.Arrow){const R=I(O,Me);findPointOnCurve(R,i,s,S,T,.51),E._centreAngle=Math.atan2(R[1]-G[1],R[0]-G[0])}}else{const R=this.links_render_mode==LinkRenderType.LINEAR_LINK?15:10;switch(y){case LinkDirection.LEFT:S[0]+=-R;break;case LinkDirection.RIGHT:S[0]+=R;break;case LinkDirection.UP:S[1]+=-R;break;case LinkDirection.DOWN:S[1]+=R;break}switch(w){case LinkDirection.LEFT:T[0]+=-R;break;case LinkDirection.RIGHT:T[0]+=R;break;case LinkDirection.UP:T[1]+=-R;break;case LinkDirection.DOWN:T[1]+=R;break}if(this.links_render_mode==LinkRenderType.LINEAR_LINK)L.moveTo(i[0],i[1]+C),L.lineTo(S[0],S[1]+C),L.lineTo(T[0],T[1]+C),L.lineTo(s[0],s[1]+C),G[0]=(S[0]+T[0])*.5,G[1]=(S[1]+T[1])*.5,E&&this.linkMarkerShape===LinkMarkerShape.Arrow&&(E._centreAngle=Math.atan2(T[1]-S[1],T[0]-S[0]));else if(this.links_render_mode==LinkRenderType.STRAIGHT_LINK){const A=(S[0]+T[0])*.5;if(L.moveTo(i[0],i[1]),L.lineTo(S[0],S[1]),L.lineTo(A,S[1]),L.lineTo(A,T[1]),L.lineTo(T[0],T[1]),L.lineTo(s[0],s[1]),G[0]=A,G[1]=(S[1]+T[1])*.5,E&&this.linkMarkerShape===LinkMarkerShape.Arrow){const V=T[1]-S[1];Math.abs(V)<4?E._centreAngle=0:V>0?E._centreAngle=Math.PI*.5:E._centreAngle=-(Math.PI*.5)}}else return}}if(this.render_connections_border&&!this.low_quality&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke(L)),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=m,t.stroke(L),this.ds.scale>=.6&&this.highquality_render&&E){if(this.render_connection_arrows){const D=this.computeConnectionPoint(i,s,.25,y,w),C=this.computeConnectionPoint(i,s,.26,y,w),R=this.computeConnectionPoint(i,s,.75,y,w),A=this.computeConnectionPoint(i,s,.76,y,w);let V=0,j=0;this.render_curved_connections?(V=-Math.atan2(C[0]-D[0],C[1]-D[1]),j=-Math.atan2(A[0]-R[0],A[1]-R[1])):j=V=s[1]>i[1]?0:Math.PI;const M=t.getTransform();t.translate(D[0],D[1]),t.rotate(V),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(M),t.translate(R[0],R[1]),t.rotate(j),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(M)}if(t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const D=t.getTransform();t.translate(G[0],G[1]),E._centreAngle&&t.rotate(E._centreAngle),t.moveTo(-3.2,-5),t.lineTo(7,0),t.lineTo(-3.2,5),t.setTransform(D)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(G[0],G[1],5,0,Math.PI*2);if(_){const{fillStyle:D,globalAlpha:C}=t;t.fillStyle=this._pattern??"#797979",t.globalAlpha=.75,t.fill(),t.globalAlpha=C,t.fillStyle=D}if(t.fill(),LLink._drawDebug){const{fillStyle:D,font:C,globalAlpha:R,lineWidth:A,strokeStyle:V}=t;t.globalAlpha=1,t.lineWidth=4,t.fillStyle="white",t.strokeStyle="black",t.font="16px Arial";const j=String(E.id),{width:M,actualBoundingBoxAscent:W}=t.measureText(j),B=G[0]-M*.5,$=G[1]+W*.5;t.strokeText(j,B,$),t.fillText(j,B,$),t.font=C,t.globalAlpha=R,t.lineWidth=A,t.fillStyle=D,t.strokeStyle=V}}if(r){t.fillStyle=m;for(let D=0;D<5;++D){const C=(LiteGraph.getTime()*.001+D*.2)%1,R=this.computeConnectionPoint(i,s,C,y,w);t.beginPath(),t.arc(R[0],R[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,i,s,n,o){n||(n=LinkDirection.RIGHT),o||(o=LinkDirection.LEFT);const r=distance(t,i),a=[t[0],t[1]],l=[i[0],i[1]];N(this,F,Oe).call(this,a,n,r),N(this,F,Oe).call(this,l,o,r);const h=(1-s)*(1-s)*(1-s),c=3*((1-s)*(1-s))*s,p=3*(1-s)*(s*s),f=s*s*s,g=h*t[0]+c*a[0]+p*l[0]+f*i[0],_=h*t[1]+c*a[1]+p*l[1]+f*i[1];return[g,_]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;const{visible_nodes:i}=this;for(const s of i)t.fillStyle="black",t.fillRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),s.order==0&&t.strokeRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(stringOrEmpty(s.order),s.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,s.pos[1]-6);t.globalAlpha=1}drawNodeWidgets(t,i,s){t.drawWidgets(s,{lowQuality:this.low_quality,editorAlpha:this.editor_alpha})}drawGroups(t,i){if(!this.graph)return;const s=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;const n=I(this,ct)&&this.isDragging;for(const o of s)overlapBounding(this.visible_area,o._bounding)&&(n&&this.selectedItems.has(o)&&this.drawSnapGuide(i,o),o.draw(this,i));i.restore()}resize(t,i){if(!t&&!i){const s=this.canvas.parentElement;if(!s)throw new TypeError("Attempted to resize canvas, but parent element was null.");t=s.offsetWidth,i=s.offsetHeight}this.canvas.width==t&&this.canvas.height==i||(this.canvas.width=t??0,this.canvas.height=i??0,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}onNodeSelectionChange(){}boundaryNodesForSelection(){return O.getBoundaryNodes(this.selected_nodes)}showLinkMenu(t,i){var f,g;const{graph:s}=this;if(!s)throw new NullGraphError;const n="data"in t&&t.data!=null?t.data.constructor.name:void 0,{origin_id:o,origin_slot:r}=t;if(o==null||r==null)return new LiteGraph.ContextMenu(["Link has no origin"],{event:i,title:n}),!1;const a=s.getNodeById(o),l=(g=(f=a==null?void 0:a.outputs)==null?void 0:f[r])==null?void 0:g.type,h=["Add Node","Add Reroute",null,"Delete",null],c=new LiteGraph.ContextMenu(h,{event:i,title:n,callback:p.bind(this)});return!1;function p(_,m,y){if(!s)throw new NullGraphError;switch(_){case"Add Node":O.onMenuAdd(null,null,y,c,w=>{var L,E;if(!((L=w==null?void 0:w.inputs)!=null&&L.length)||!((E=w==null?void 0:w.outputs)!=null&&E.length)||r==null)return;const k={afterRerouteId:t.parentId};a!=null&&a.connectByType(r,w,l??"*",k)&&(w.pos[0]-=w.size[0]*.5)});break;case"Add Reroute":{try{this.emitBeforeChange(),this.adjustMouseEvent(y),s.createReroute(t._pos,t),this.setDirty(!1,!0)}catch(w){console.error(w)}finally{this.emitAfterChange()}break}case"Delete":s.removeLink(t.id);break}}}createDefaultNodeForSlot(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[0,0],nodeType:void 0,posAdd:[0,0],posSizeFix:[0,0]},t),{afterRerouteId:s}=i,n=i.nodeFrom&&i.slotFrom!==null,o=!n&&i.nodeTo&&i.slotTo!==null;if(!n&&!o)return console.warn("No data passed to createDefaultNodeForSlot",i.nodeFrom,i.slotFrom,i.nodeTo,i.slotTo),!1;if(!i.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const r=n?i.nodeFrom:i.nodeTo;if(!r)throw new TypeError("nodeX was null when creating default node for slot.");let a=n?i.slotFrom:i.slotTo,l=!1;if(r instanceof SubgraphIONodeBase){if(typeof a!="object"||!a)return console.warn("Cant get slot information",a),!1;const{name:p}=a;if(l=r.slots.findIndex(f=>f.name===p),a=r.slots[l],!a)return console.warn("Cant get slot information",a),!1}else switch(typeof a){case"string":l=n?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=n?r.outputs[a]:r.inputs[a];break;case"object":if(a===null)return console.warn("Cant get slot information",a),!1;l=n?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":l=a,a=n?r.outputs[a]:r.inputs[a];break;case"undefined":default:return console.warn("Cant get slot information",a),!1}const h=a.type==LiteGraph.EVENT?"_event_":a.type,c=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(c!=null&&c[h]){let p=!1;if(typeof c[h]=="object"){for(const f in c[h])if(i.nodeType==c[h][f]||i.nodeType=="AUTO"){p=c[h][f];break}}else(i.nodeType==c[h]||i.nodeType=="AUTO")&&(p=c[h]);if(p){let f=!1;typeof p=="object"&&p.node&&(f=p,p=p.node);const g=LiteGraph.createNode(p);if(g){if(f){if(f.properties)for(const y in f.properties)g.addProperty(y,f.properties[y]);if(f.inputs){g.inputs=[];for(const y in f.inputs)g.addOutput(f.inputs[y][0],f.inputs[y][1])}if(f.outputs){g.outputs=[];for(const y in f.outputs)g.addOutput(f.outputs[y][0],f.outputs[y][1])}f.title&&(g.title=f.title),f.json&&g.configure(f.json)}if(!this.graph)throw new NullGraphError;this.graph.add(g),g.pos=[i.position[0]+i.posAdd[0]+(i.posSizeFix[0]?i.posSizeFix[0]*g.size[0]:0),i.position[1]+i.posAdd[1]+(i.posSizeFix[1]?i.posSizeFix[1]*g.size[1]:0)];const _={node:g,opts:i};if(!this.canvas.dispatchEvent(new CustomEvent("connect-new-default-node",{detail:_,cancelable:!0})))return!0;if(n){if(!i.nodeFrom)throw new TypeError("createDefaultNodeForSlot - nodeFrom was null");i.nodeFrom.connectByType(l,g,h,{afterRerouteId:s})}else{if(!i.nodeTo)throw new TypeError("createDefaultNodeForSlot - nodeTo was null");i.nodeTo.connectByTypeOutput(l,g,h,{afterRerouteId:s})}return!0}console.log(`failed creating ${p}`)}}return!1}showConnectionMenu(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:void 0,allow_searchbox:this.allow_searchbox,showSearchBox:this.showSearchBox},t||{}),s=()=>N(this,F,wt).call(this),n=this,{graph:o}=this,{afterRerouteId:r}=i,a=i.nodeFrom&&i.slotFrom,l=!a&&i.nodeTo&&i.slotTo;if(!a&&!l){console.warn("No data passed to showConnectionMenu");return}const h=a?i.nodeFrom:i.nodeTo;if(!h)throw new TypeError("nodeX was null when creating default node for slot.");let c=a?i.slotFrom:i.slotTo,p;if(h instanceof SubgraphIONodeBase){if(typeof c!="object"||!c){console.warn("Cant get slot information",c);return}const{name:w}=c;if(p=h.slots.findIndex(k=>k.name===w),p!==-1&&(c=h.slots[p]),!c){console.warn("Cant get slot information",c);return}}else switch(typeof c){case"string":p=a?h.findOutputSlot(c,!1):h.findInputSlot(c,!1),c=a?h.outputs[c]:h.inputs[c];break;case"object":if(c===null){console.warn("Cant get slot information",c);return}p=a?h.findOutputSlot(c.name):h.findInputSlot(c.name);break;case"number":p=c,c=a?h.outputs[c]:h.inputs[c];break;default:console.warn("Cant get slot information",c);return}const f=["Add Node","Add Reroute",null];i.allow_searchbox&&f.push("Search",null);const g=c.type==LiteGraph.EVENT?"_event_":c.type,_=a?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(_!=null&&_[g])if(typeof _[g]=="object")for(const w in _[g])f.push(_[g][w]);else f.push(_[g]);const m=new LiteGraph.ContextMenu(f,{event:i.e,extra:c,title:(c&&c.name!=""?c.name+(g?" | ":""):"")+(c&&g?g:""),callback:y});return m;function y(w,k,L){var E,S;switch(w){case"Add Node":O.onMenuAdd(null,null,L,m,function(T){if(T)if(a){if(!i.nodeFrom)throw new TypeError("Cannot add node to SubgraphInputNode: nodeFrom was null");i.nodeFrom.connectByType(p,T,g,{afterRerouteId:r})||console.warn("Failed to make new connection.")}else{if(!i.nodeTo)throw new TypeError("Cannot add node to SubgraphInputNode: nodeTo was null");i.nodeTo.connectByTypeOutput(p,T,g,{afterRerouteId:r})}});break;case"Add Reroute":{const T=a?i.nodeFrom:i.nodeTo,G=k.extra;if(!o)throw new NullGraphError;if(!T)throw new TypeError("Cannot add reroute: node was null");if(!G)throw new TypeError("Cannot add reroute: slot was null");if(!i.e)throw new TypeError("Cannot add reroute: CanvasPointerEvent was null");if(T instanceof SubgraphIONodeBase)throw new TypeError("Cannot add floating reroute to Subgraph IO Nodes");if(!T.connectFloatingReroute([i.e.canvasX,i.e.canvasY],G,r))throw new Error("Failed to create reroute");s();break}case"Search":a?i.showSearchBox(L,{node_from:i.nodeFrom,slot_from:c,type_filter_in:g}):i.showSearchBox(L,{node_to:i.nodeTo,slot_from:c,type_filter_out:g});break;default:{const T={position:[((E=i.e)==null?void 0:E.canvasX)??0,((S=i.e)==null?void 0:S.canvasY)??0],nodeType:w,afterRerouteId:r},G=Object.assign(i,T);if(!n.createDefaultNodeForSlot(G))break}}}}prompt(t,i,s,n,o){var T;const r=this;t=t||"";const a={is_modified:!1,className:"graphdialog rounded",innerHTML:o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",close(){r.prompt_box=null,h.parentNode&&h.remove()}},l=document.createElement("div"),h=Object.assign(l,a),c=O.active_canvas,{canvas:p}=c;if(!p.parentNode)throw new TypeError("canvas element parentNode was null when opening a prompt.");p.parentNode.append(h),this.ds.scale>1&&(h.style.transform=`scale(${this.ds.scale})`);let f,g=0;LiteGraph.pointerListenerAdd(h,"leave",function(){g||LiteGraph.dialog_close_on_mouse_leave&&!h.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(h.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(h,"enter",function(){LiteGraph.dialog_close_on_mouse_leave&&f&&clearTimeout(f)});const _=h.querySelectorAll("select");if(_)for(const G of _)G.addEventListener("click",function(){g++}),G.addEventListener("blur",function(){g=0}),G.addEventListener("change",function(){g=-1});(T=this.prompt_box)==null||T.close(),this.prompt_box=h;const m=h.querySelector(".name");if(!m)throw new TypeError("name_element was null");m.textContent=t;const y=h.querySelector(".value");if(!y)throw new TypeError("value_element was null");y.value=i,y.select();const w=y;w.addEventListener("keydown",function(G){if(h.is_modified=!0,G.key=="Escape")h.close();else if(G.key=="Enter"&&G.target.localName!="textarea")s&&s(this.value),h.close();else return;G.preventDefault(),G.stopPropagation()});const k=h.querySelector("button");if(!k)throw new TypeError("button was null when opening prompt");k.addEventListener("click",function(){s==null||s(w.value),r.setDirty(!0),h.close()});const L=p.getBoundingClientRect();let E=-20,S=-20;return L&&(E-=L.left,S-=L.top),n?(h.style.left=`${n.clientX+E}px`,h.style.top=`${n.clientY+S}px`):(h.style.left=`${p.width*.5+E}px`,h.style.top=`${p.height*.5+S}px`),setTimeout(function(){var C,R;w.focus();const G=Date.now();function D(A){var V,j;A.target===p&&Date.now()-G>256&&(h.close(),(V=p.parentElement)==null||V.removeEventListener("click",D),(j=p.parentElement)==null||j.removeEventListener("touchend",D))}(C=p.parentElement)==null||C.addEventListener("click",D),(R=p.parentElement)==null||R.addEventListener("touchend",D)},10),h}showSearchBox(t,i){var D;const s={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};Object.assign(s,i);const n=this,o=O.active_canvas,{canvas:r}=o,a=r.ownerDocument||document,l=document.createElement("div"),h=Object.assign(l,{close(){n.search_box=void 0,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(()=>r.focus(),20),h.remove()}});h.className="litegraph litesearchbox graphdialog rounded",h.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",s.do_type_filter&&(h.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",h.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>");const c=document.createElement("div");c.className="helper",h.append(c),a.fullscreenElement?a.fullscreenElement.append(h):(a.body.append(h),a.body.style.overflow="hidden");let p,f;if(s.do_type_filter&&(p=h.querySelector(".slot_in_type_filter"),f=h.querySelector(".slot_out_type_filter")),this.ds.scale>1&&(h.style.transform=`scale(${this.ds.scale})`),s.hide_on_mouse_leave){let C=!1,R=null;if(LiteGraph.pointerListenerAdd(h,"enter",function(){R&&(clearTimeout(R),R=null)}),h.addEventListener("pointerleave",function(){if(C)return;const A=s.hide_on_mouse_leave,V=typeof A=="number"?A:500;R=setTimeout(h.close,V)}),s.do_type_filter){if(!p)throw new TypeError("selIn was null when showing search box");if(!f)throw new TypeError("selOut was null when showing search box");p.addEventListener("click",function(){C++}),p.addEventListener("blur",function(){C=0}),p.addEventListener("change",function(){C=-1}),f.addEventListener("click",function(){C++}),f.addEventListener("blur",function(){C=0}),f.addEventListener("change",function(){C=-1})}}(D=n.search_box)==null||D.close(),n.search_box=h;let g=null,_=null,m=null;const y=h.querySelector("input");if(!y)throw new TypeError("Could not create search input box.");const w=y;if(w&&(w.addEventListener("blur",function(){this.focus()}),w.addEventListener("keydown",function(C){if(C.key=="ArrowUp")T(!1);else if(C.key=="ArrowDown")T(!0);else if(C.key=="Escape")h.close();else if(C.key=="Enter")m instanceof HTMLElement?S(unescape(String(m.dataset.type))):g?S(g):h.close();else{_&&clearInterval(_),_=setTimeout(G,10);return}return C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation(),!0})),s.do_type_filter){if(p){const C=LiteGraph.slot_types_in,R=C.length;(s.type_filter_in==LiteGraph.EVENT||s.type_filter_in==LiteGraph.ACTION)&&(s.type_filter_in="_event_");for(let A=0;A<R;A++){const V=document.createElement("option");V.value=C[A],V.innerHTML=C[A],p.append(V),s.type_filter_in!==!1&&String(s.type_filter_in).toLowerCase()==String(C[A]).toLowerCase()&&(V.selected=!0)}p.addEventListener("change",function(){G()})}if(f){const C=LiteGraph.slot_types_out;(s.type_filter_out==LiteGraph.EVENT||s.type_filter_out==LiteGraph.ACTION)&&(s.type_filter_out="_event_");for(const R of C){const A=document.createElement("option");A.value=R,A.innerHTML=R,f.append(A),s.type_filter_out!==!1&&String(s.type_filter_out).toLowerCase()==String(R).toLowerCase()&&(A.selected=!0)}f.addEventListener("change",function(){G()})}}const k=r.getBoundingClientRect(),L=(t?t.clientX:k.left+k.width*.5)-80,E=(t?t.clientY:k.top+k.height*.5)-20;h.style.left=`${L}px`,h.style.top=`${E}px`,t.layerY>k.height-200&&(c.style.maxHeight=`${k.height-t.layerY-20}px`),requestAnimationFrame(function(){w.focus()}),s.show_all_on_open&&G();function S(C){if(C)if(n.onSearchBoxSelection)n.onSearchBoxSelection(C,t,o);else{if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const R=LiteGraph.createNode(C);if(R&&(R.pos=o.convertEventToCanvasOffset(t),o.graph.add(R,!1)),s.node_from){let A=!1;switch(typeof s.slot_from){case"string":A=s.node_from.findOutputSlot(s.slot_from);break;case"object":if(s.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");A=s.slot_from.name?s.node_from.findOutputSlot(s.slot_from.name):-1,A==-1&&s.slot_from.slot_index!==void 0&&(A=s.slot_from.slot_index);break;case"number":A=s.slot_from;break;default:A=0}if(s.node_from.outputs[A]!==void 0&&A!==!1&&A>-1){if(R==null)throw new TypeError("options.slot_from was null when showing search box");s.node_from.connectByType(A,R,s.node_from.outputs[A].type)}}if(s.node_to){let A=!1;switch(typeof s.slot_from){case"string":A=s.node_to.findInputSlot(s.slot_from);break;case"object":if(s.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");A=s.slot_from.name?s.node_to.findInputSlot(s.slot_from.name):-1,A==-1&&s.slot_from.slot_index!==void 0&&(A=s.slot_from.slot_index);break;case"number":A=s.slot_from;break;default:A=0}if(s.node_to.inputs[A]!==void 0&&A!==!1&&A>-1){if(R==null)throw new TypeError("options.slot_from was null when showing search box");s.node_to.connectByTypeOutput(A,R,s.node_to.inputs[A].type)}}o.graph.afterChange()}h.close()}function T(C){const R=m;m?m instanceof Element&&(m.classList.remove("selected"),m=C?m.nextSibling:m.previousSibling,m||(m=R)):m=C?c.childNodes[0]:c.childNodes[c.childNodes.length],m instanceof Element&&(m.classList.add("selected"),m.scrollIntoView({block:"end",behavior:"smooth"}))}function G(){_=null;let C=w.value;if(g=null,c.innerHTML="",!C&&!s.show_all_if_empty)return;if(n.onSearchBox){const A=n.onSearchBox(c,C,o);if(A)for(const V of A)R(V)}else{let A=function(z,q){var ee,ie;q=q||{};const vt=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},q),Et=LiteGraph.registered_node_types[z];if(j&&Et.filter!=j||(!s.show_all_if_empty||C)&&!z.toLowerCase().includes(C)&&(!Et.title||!Et.title.toLowerCase().includes(C)))return!1;if(s.do_type_filter&&!vt.skipFilter){const se=z;let ft=vt.inTypeOverride!==!1?vt.inTypeOverride:M.value;if(M&&ft&&((ee=LiteGraph.registered_slot_in_types[ft])!=null&&ee.nodes)&&LiteGraph.registered_slot_in_types[ft].nodes.includes(se)===!1||(ft=W.value,vt.outTypeOverride!==!1&&(ft=vt.outTypeOverride),W&&ft&&((ie=LiteGraph.registered_slot_out_types[ft])!=null&&ie.nodes)&&LiteGraph.registered_slot_out_types[ft].nodes.includes(se)===!1))return!1}return!0},V=0;if(C=C.toLowerCase(),!o.graph)throw new NullGraphError;const j=o.filter||o.graph.filter;let M=!1,W=!1;s.do_type_filter&&n.search_box&&(M=n.search_box.querySelector(".slot_in_type_filter"),W=n.search_box.querySelector(".slot_out_type_filter"));const $=Object.keys(LiteGraph.registered_node_types).filter(z=>A(z));for(const z of $)if(R(z),O.search_limit!==-1&&V++>O.search_limit)break;if(s.show_general_after_typefiltered&&(M.value||W.value)){filtered_extra=[];for(const z in LiteGraph.registered_node_types)A(z,{inTypeOverride:M&&M.value?"*":!1,outTypeOverride:W&&W.value?"*":!1})&&filtered_extra.push(z);for(const z of filtered_extra)if(R(z,"generic_type"),O.search_limit!==-1&&V++>O.search_limit)break}if((M.value||W.value)&&c.childNodes.length==0&&s.show_general_if_none_on_typefilter){filtered_extra=[];for(const z in LiteGraph.registered_node_types)A(z,{skipFilter:!0})&&filtered_extra.push(z);for(const z of filtered_extra)if(R(z,"not_in_filter"),O.search_limit!==-1&&V++>O.search_limit)break}}function R(A,V){const j=document.createElement("div");g||(g=A);const M=LiteGraph.registered_node_types[A];if(M!=null&&M.title){j.textContent=M==null?void 0:M.title;const W=document.createElement("span");W.className="litegraph lite-search-item-type",W.textContent=A,j.append(W)}else j.textContent=A;j.dataset.type=escape(A),j.className="litegraph lite-search-item",V&&(j.className+=` ${V}`),j.addEventListener("click",function(){S(unescape(String(this.dataset.type)))}),c.append(j)}}return h}showEditPropertyValue(t,i,s){if(!t||t.properties[i]===void 0)return;s=s||{};const n=t.getPropertyInfo(i),{type:o}=n;let r="";if(o=="string"||o=="number"||o=="array"||o=="object")r="<input autofocus type='text' class='value'/>";else if((o=="enum"||o=="combo")&&n.values){r="<select autofocus type='text' class='value'>";for(const g in n.values){const _=Array.isArray(n.values)?n.values[g]:g,m=_==t.properties[i]?"selected":"";r+=`<option value='${_}' ${m}>${n.values[g]}</option>`}r+="</select>"}else if(o=="boolean"||o=="toggle")r=`<input autofocus type='checkbox' class='value' ${t.properties[i]?"checked":""}/>`;else{console.warn(`unknown type: ${o}`);return}const a=this.createDialog(`<span class='name'>${n.label||i}</span>${r}<button>OK</button>`,s);let l;if((o=="enum"||o=="combo")&&n.values)l=a.querySelector("select"),l==null||l.addEventListener("change",function(g){var _;a.modified(),f((_=g.target)==null?void 0:_.value)});else if(o=="boolean"||o=="toggle")l=a.querySelector("input"),l==null||l.addEventListener("click",function(){a.modified(),f(!!l.checked)});else if(l=a.querySelector("input"),l){l.addEventListener("blur",function(){this.focus()});let g=t.properties[i]!==void 0?t.properties[i]:"";o!=="string"&&(g=JSON.stringify(g)),l.value=g,l.addEventListener("keydown",function(_){if(_.key=="Escape")a.close();else if(_.key=="Enter")c();else{a.modified();return}_.preventDefault(),_.stopPropagation()})}l==null||l.focus();const h=a.querySelector("button");if(!h)throw new TypeError("Show edit property value button was null.");h.addEventListener("click",c);function c(){f(l==null?void 0:l.value)}const p=()=>N(this,F,wt).call(this);function f(g){var _,m;n!=null&&n.values&&typeof n.values=="object"&&n.values[g]!=null&&(g=n.values[g]),typeof t.properties[i]=="number"&&(g=Number(g)),(o=="array"||o=="object")&&(g=JSON.parse(g)),t.properties[i]=g,t.graph&&t.graph._version++,(_=t.onPropertyChanged)==null||_.call(t,i,g),(m=s.onclose)==null||m.call(s),a.close(),p()}return a}createDialog(t,i){i=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},i||{});const n={className:"graphdialog",innerHTML:t,is_modified:!1,modified(){this.is_modified=!0},close(){this.remove()}},o=document.createElement("div"),r=Object.assign(o,n),a=this.canvas.getBoundingClientRect();let l=-20,h=-20;if(a&&(l-=a.left,h-=a.top),i.position?(l+=i.position[0],h+=i.position[1]):i.event?(l+=i.event.clientX,h+=i.event.clientY):(l+=this.canvas.width*.5,h+=this.canvas.height*.5),r.style.left=`${l}px`,r.style.top=`${h}px`,!this.canvas.parentNode)throw new TypeError("Canvas parent element was null.");if(this.canvas.parentNode.append(r),i.checkForInput){const g=r.querySelectorAll("input");if(g)for(const _ of g)_.addEventListener("keydown",function(m){if(r.modified(),m.key=="Escape")r.close();else if(m.key!="Enter")return;m.preventDefault(),m.stopPropagation()}),_.focus()}let c,p=0;r.addEventListener("mouseleave",function(){p||!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(){(i.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&c&&clearTimeout(c)});const f=r.querySelectorAll("select");if(f)for(const g of f)g.addEventListener("click",function(){p++}),g.addEventListener("blur",function(){p=0}),g.addEventListener("change",function(){p=-1});return r}createPanel(t,i){i=i||{};const s=i.window||window,n=document.createElement("div");if(n.className="litegraph dialog",n.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",n.header=n.querySelector(".dialog-header"),i.width&&(n.style.width=i.width+(typeof i.width=="number"?"px":"")),i.height&&(n.style.height=i.height+(typeof i.height=="number"?"px":"")),i.closable){const o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",function(){n.close()}),n.header.append(o)}return n.title_element=n.querySelector(".dialog-title"),n.title_element.textContent=t,n.content=n.querySelector(".dialog-content"),n.alt_content=n.querySelector(".dialog-alt-content"),n.footer=n.querySelector(".dialog-footer"),n.close=function(){typeof n.onClose=="function"&&n.onClose(),n.remove(),this.remove()},n.toggleAltContent=function(o){let r,a;o!==void 0?(r=o?"block":"none",a=o?"none":"block"):(r=n.alt_content.style.display!="block"?"block":"none",a=n.alt_content.style.display!="block"?"none":"block"),n.alt_content.style.display=r,n.content.style.display=a},n.toggleFooterVisibility=function(o){let r;o!==void 0?r=o?"block":"none":r=n.footer.style.display!="block"?"block":"none",n.footer.style.display=r},n.clear=function(){this.content.innerHTML=""},n.addHTML=function(o,r,a){const l=document.createElement("div");return r&&(l.className=r),l.innerHTML=o,a?n.footer.append(l):n.content.append(l),l},n.addButton=function(o,r,a){const l=document.createElement("button");return l.textContent=o,l.options=a,l.classList.add("btn"),l.addEventListener("click",r),n.footer.append(l),l},n.addSeparator=function(){const o=document.createElement("div");o.className="separator",n.content.append(o)},n.addWidget=function(o,r,a,l,h){l=l||{};let c=String(a);o=o.toLowerCase(),o=="number"&&typeof a=="number"&&(c=a.toFixed(3));const p=document.createElement("div");p.className="property",p.innerHTML="<span class='property_name'></span><span class='property_value'></span>";const f=p.querySelector(".property_name");if(!f)throw new TypeError("Property name element was null.");f.textContent=l.label||r;const g=p.querySelector(".property_value");if(!g)throw new TypeError("Property name element was null.");if(g.textContent=c,p.dataset.property=r,p.dataset.type=l.type||o,p.options=l,p.value=a,o=="code")p.addEventListener("click",function(){n.inner_showCodePad(this.dataset.property)});else if(o=="boolean")p.classList.add("boolean"),a&&p.classList.add("bool-on"),p.addEventListener("click",()=>{const m=p.dataset.property;if(p.value=!p.value,p.classList.toggle("bool-on"),!g)throw new TypeError("Property name element was null.");g.textContent=p.value?"true":"false",_(m,p.value)});else if(o=="string"||o=="number"){if(!g)throw new TypeError("Property name element was null.");g.setAttribute("contenteditable","true"),g.addEventListener("keydown",function(m){m.code=="Enter"&&(o!="string"||!m.shiftKey)&&(m.preventDefault(),this.blur())}),g.addEventListener("blur",function(){var k,L;let m=this.textContent;const y=(k=this.parentElement)==null?void 0:k.dataset.property;((L=this.parentElement)==null?void 0:L.dataset.type)=="number"&&(m=Number(m)),_(y,m)})}else if(o=="enum"||o=="combo"){const m=O.getPropertyPrintableValue(a,l.values);if(!g)throw new TypeError("Property name element was null.");g.textContent=m??"",g.addEventListener("click",function(y){var E;const w=l.values||[],k=(E=this.parentElement)==null?void 0:E.dataset.property,L=S=>(this.textContent=S,_(k,S),!1);new LiteGraph.ContextMenu(w,{event:y,className:"dark",callback:L},s)})}n.content.append(p);function _(m,y){var w;(w=l.callback)==null||w.call(l,m,y,l),h==null||h(m,y,l)}return p},typeof n.onOpen=="function"&&n.onOpen(),n}closePanels(){var t,i,s,n;(i=(t=document.querySelector("#node-panel"))==null?void 0:t.close)==null||i.call(t),(n=(s=document.querySelector("#option-panel"))==null?void 0:s.close)==null||n.call(s)}showShowNodePanel(t){this.SELECTED_NODE=t,this.closePanels();const i=this.getCanvasWindow(),s=this.createPanel(t.title||"",{closable:!0,window:i,onOpen:()=>{this.NODEPANEL_IS_OPEN=!0},onClose:()=>{this.NODEPANEL_IS_OPEN=!1,this.node_panel=null}});this.node_panel=s,s.id="node-panel",s.node=t,s.classList.add("settings");const n=()=>{var l,h;s.content.innerHTML="",s.addHTML(`<span class='node_type'>${t.type}</span><span class='node_desc'>${t.constructor.desc||""}</span><span class='separator'></span>`),s.addHTML("<h3>Properties</h3>");const o=(c,p)=>{if(!this.graph)throw new NullGraphError;switch(this.graph.beforeChange(t),c){case"Title":if(typeof p!="string")throw new TypeError("Attempting to set title to non-string value.");t.title=p;break;case"Mode":{if(typeof p!="string")throw new TypeError("Attempting to set mode to non-string value.");const f=Object.values(LiteGraph.NODE_MODES).indexOf(p);f!==-1&&LiteGraph.NODE_MODES[f]?t.changeMode(f):console.warn(`unexpected mode: ${p}`);break}case"Color":if(typeof p!="string")throw new TypeError("Attempting to set colour to non-string value.");O.node_colors[p]?(t.color=O.node_colors[p].color,t.bgcolor=O.node_colors[p].bgcolor):console.warn(`unexpected color: ${p}`);break;default:t.setProperty(c,p);break}this.graph.afterChange(),this.dirty_canvas=!0};s.addWidget("string","Title",t.title,{},o);const r=t.mode==null?void 0:LiteGraph.NODE_MODES[t.mode];s.addWidget("combo","Mode",r,{values:LiteGraph.NODE_MODES},o);const a=t.color!==void 0?Object.keys(O.node_colors).filter(function(c){return O.node_colors[c].color==t.color}):"";s.addWidget("combo","Color",a,{values:Object.keys(O.node_colors)},o);for(const c in t.properties){const p=t.properties[c],f=t.getPropertyInfo(c);(l=t.onAddPropertyToPanel)!=null&&l.call(t,c,s)||s.addWidget(f.widget||f.type,c,p,f,o)}s.addSeparator(),(h=t.onShowCustomPanelInfo)==null||h.call(t,s),s.footer.innerHTML="",s.addButton("Delete",function(){if(!t.block_delete){if(!t.graph)throw new NullGraphError;t.graph.remove(t),s.close()}}).classList.add("delete")};if(s.inner_showCodePad=function(o){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";const r=s.alt_content.querySelector("textarea"),a=function(){s.toggleAltContent(!1),s.toggleFooterVisibility(!0),r.remove(),s.classList.add("settings"),s.classList.remove("centered"),n()};r.value=String(t.properties[o]),r.addEventListener("keydown",function(c){c.code=="Enter"&&c.ctrlKey&&(t.setProperty(o,r.value),a())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),r.style.height="calc(100% - 40px)";const l=s.addButton("Assign",function(){t.setProperty(o,r.value),a()});s.alt_content.append(l);const h=s.addButton("Close",a);h.style.float="right",s.alt_content.append(h)},n(),!this.canvas.parentNode)throw new TypeError("showNodePanel - this.canvas.parentNode was null");this.canvas.parentNode.append(s)}checkPanels(){if(!this.canvas)return;if(!this.canvas.parentNode)throw new TypeError("checkPanels - this.canvas.parentNode was null");const t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(const i of t)i.node&&(!i.node.graph||i.graph!=this.graph)&&i.close()}getCanvasMenuOptions(){var s;let t;this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:O.onMenuAdd},{content:"Add Group",callback:O.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&t.push({content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Align",has_submenu:!0,callback:O.onGroupAlign}));const i=(s=this.getExtraMenuOptions)==null?void 0:s.call(this,this,t);return Array.isArray(i)?t.concat(i):t}getNodeMenuOptions(t){var n,o,r,a;let i;t.getMenuOptions?i=t.getMenuOptions(this):(i=[{content:"Inputs",has_submenu:!0,disabled:!0},{content:"Outputs",has_submenu:!0,disabled:!0,callback:O.showMenuNodeOptionalOutputs},null,{content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Properties",has_submenu:!0,callback:O.onShowMenuNodeProperties},{content:"Properties Panel",callback:function(l,h,c,p,f){O.active_canvas.showShowNodePanel(f)}},null,{content:"Title",callback:O.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:O.onMenuNodeMode}],t.resizable!==!1&&i.push({content:"Resize",callback:O.onMenuResizeNode}),t.collapsible&&i.push({content:t.collapsed?"Expand":"Collapse",callback:O.onMenuNodeCollapse}),(n=t.widgets)!=null&&n.some(l=>l.advanced)&&i.push({content:t.showAdvanced?"Hide Advanced":"Show Advanced",callback:O.onMenuToggleAdvanced}),i.push({content:t.pinned?"Unpin":"Pin",callback:()=>{for(const l in this.selected_nodes)this.selected_nodes[l].pin();this.setDirty(!0,!0)}},{content:"Colors",has_submenu:!0,callback:O.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:O.onMenuNodeShapes},null));const s=(o=t.getExtraMenuOptions)==null?void 0:o.call(t,this,i);return Array.isArray(s)&&s.length>0&&(s.push(null),i=s.concat(i)),t.clonable!==!1&&i.push({content:"Clone",callback:O.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&i.push({content:"Align Selected To",has_submenu:!0,callback:O.onNodeAlign},{content:"Distribute Nodes",has_submenu:!0,callback:O.createDistributeMenu}),i.push(null,{content:"Remove",disabled:!(t.removable!==!1&&!t.block_delete),callback:O.onMenuNodeRemove}),(a=(r=t.graph)==null?void 0:r.onGetNodeMenuOptions)==null||a.call(r,i,t),i}getGroupMenuOptions(t){return console.warn("LGraphCanvas.getGroupMenuOptions is deprecated, use LGraphGroup.getMenuOptions instead"),t.getMenuOptions()}processContextMenu(t,i){var c,p,f;const n=O.active_canvas.getCanvasWindow();let o;const r={event:i,callback:h,extra:t};if(t){r.title=t.displayType??t.type??void 0,O.active_node=t;const g=t.getSlotInPosition(i.canvasX,i.canvasY);if(g){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(g);else{((p=(c=g.output)==null?void 0:c.links)!=null&&p.length||((f=g.input)==null?void 0:f.link)!=null)&&o.push({content:"Disconnect Links",slot:g});const _=g.input||g.output;if(!_)throw new TypeError("Both in put and output slots were null when processing context menu.");_.removable&&o.push(_.locked?"Cannot remove":{content:"Remove Slot",slot:g}),!_.nameLocked&&!("link"in _&&_.widget)&&o.push({content:"Rename Slot",slot:g}),t.getExtraSlotMenuOptions&&o.push(...t.getExtraSlotMenuOptions(g))}r.title=(g.input?g.input.type:g.output.type)||"*",g.input&&g.input.type==LiteGraph.ACTION&&(r.title="Action"),g.output&&g.output.type==LiteGraph.EVENT&&(r.title="Event")}else o=this.getNodeMenuOptions(t)}else{if(o=this.getCanvasMenuOptions(),!this.graph)throw new NullGraphError;if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const _=this.graph.getRerouteOnPos(i.canvasX,i.canvasY,I(this,yt));_&&o.unshift({content:"Delete Reroute",callback:()=>{if(!this.graph)throw new NullGraphError;this.graph.removeReroute(_.id)}},null)}const g=this.graph.getGroupOnPos(i.canvasX,i.canvasY);g&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:g,options:g.getMenuOptions()}})}if(!o)return;new LiteGraph.ContextMenu(o,r,n);const a=g=>this.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",g),l=()=>this.setDirty(!0);function h(g,_){var m;if(g){if(g.content=="Remove Slot"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.input?t.removeInput(y.slot):y.output&&t.removeOutput(y.slot),t.graph.afterChange();return}else if(g.content=="Disconnect Links"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.output?t.disconnectOutput(y.slot):y.input&&t.disconnectInput(y.slot,!0),t.graph.afterChange();return}else if(g.content=="Rename Slot"){if(!t)throw new TypeError("`node` was null when processing the context menu.");const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");const w=y.input?t.getInputInfo(y.slot):t.getOutputInfo(y.slot),k=a(_),L=k.querySelector("input");L&&w&&(L.value=w.label||"");const E=function(){if(!t.graph)throw new NullGraphError;t.graph.beforeChange(),L!=null&&L.value&&(w&&(w.label=L.value),l()),k.close(),t.graph.afterChange()};if((m=k.querySelector("button"))==null||m.addEventListener("click",E),!L)throw new TypeError("Input element was null when processing context menu.");L.addEventListener("keydown",function(S){if(k.is_modified=!0,S.key=="Escape")k.close();else if(S.key=="Enter")E();else if(S.target.localName!="textarea")return;S.preventDefault(),S.stopPropagation()}),L.focus()}}}}animateToBounds(t,i={}){const s=()=>this.setDirty(!0,!0);this.ds.animateToBounds(t,s,i)}fitViewToSelectionAnimated(t={}){const i=this.selectedItems.size?Array.from(this.selectedItems):this.positionableItems,s=createBounds(i);if(!s)throw new TypeError("Attempted to fit to view but could not calculate bounds.");const n=()=>this.setDirty(!0,!0);this.ds.animateToBounds(s,n,t)}};Ae=new WeakMap,Fe=new WeakMap,xe=new WeakMap,Nt=new WeakMap,St=new WeakMap,Pe=new WeakMap,We=new WeakMap,Me=new WeakMap,xt=new WeakMap,F=new WeakSet,Ye=function(){if(!this.state.shouldSetCursor)return;const t=CanvasItem.Node|CanvasItem.RerouteSlot|CanvasItem.SubgraphIoNode|CanvasItem.SubgraphIoSlot;let i="default";this.state.draggingCanvas?i="grabbing":this.state.readOnly?i="grab":this.pointer.resizeDirection?i=cursors[this.pointer.resizeDirection]??cursors.SE:this.state.hoveringOver&t?i="crosshair":this.state.hoveringOver&CanvasItem.Reroute&&(i="grab"),this.canvas.style.cursor=i},Ot=new WeakMap,ve=new WeakMap,yt=new WeakMap,ct=new WeakMap,be=new WeakMap,Pt=new WeakMap,Ti=function(t){if(typeof t=="string"){const i=document.getElementById(t);if(!(i instanceof HTMLCanvasElement))throw"Error validating LiteGraph canvas: Canvas element not found";return i}return t},wt=function(){this.dirty_canvas=!0,this.dirty_bgcanvas=!0},Bt=function(){const{graph:t,linkConnector:i,pointer:s}=this;if(!t)throw new NullGraphError;s.onDragEnd=n=>i.dropLinks(t,n),s.finally=()=>this.linkConnector.reset(!0)},Ci=function(t,i){var n,o;const s=(n=this.subgraph)==null?void 0:n.getIoNodeOnPos(t,i);if(s)return s;for(const r of I(this,yt))if(r.containsPoint([t,i]))return r;return(o=this.graph)==null?void 0:o.getGroupTitlebarOnPos(t,i)},Ni=function(t,i){var c;const{pointer:s,graph:n,linkConnector:o,subgraph:r}=this;if(!n)throw new NullGraphError;const a=t.canvasX,l=t.canvasY,h=t.ctrlKey||t.metaKey;if(h&&!t.altKey&&LiteGraph.canvasNavigationMode==="legacy"){N(this,F,li).call(this,t,s,i);return}if(this.read_only){s.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0;return}if(LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&!t.ctrlKey&&i&&this.allow_interaction){let p=i.type;if(i instanceof SubgraphNode){const g=i.subgraph.clone().asSerialisable(),_=n.createSubgraph(g);_.configure(g),p=_.id}const f=(c=i.clone())==null?void 0:c.serialize();if((f==null?void 0:f.type)!=null){const g=LiteGraph.createNode(p);if(g){g.configure(f),g.pos[0]+=5,g.pos[1]+=5,this.allow_dragnodes?(s.onDragStart=_=>{n.add(g,!1),N(this,F,zt).call(this,g,_)},s.onDragEnd=_=>N(this,F,Vt).call(this,_)):(n.beforeChange(),n.add(g,!1),n.afterChange());return}}}if(i&&(this.allow_interaction||i.flags.allow_interaction))N(this,F,Oi).call(this,t,h,i);else{if(r){let _=function(w,k){return k.containsPoint([a,l])?(k.onPointerDown(t,s,o),s.onClick??(s.onClick=()=>w.processSelect(k,t)),s.onDragStart??(s.onDragStart=()=>{var L;return N(L=w,F,zt).call(L,k,s,!0)}),s.onDragEnd??(s.onDragEnd=L=>{var E;return N(E=w,F,Vt).call(E,L)}),!0):!1};const{inputNode:m,outputNode:y}=r;if(_(this,m)||_(this,y))return}if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK)for(const _ of I(this,yt)){const m=_.containsPoint([a,l]);if(!(!_.isSlotHovered&&!m)){m&&(s.onClick=()=>this.processSelect(_,t),t.shiftKey||(s.onDragStart=y=>N(this,F,zt).call(this,_,y,!0),s.onDragEnd=y=>N(this,F,Vt).call(this,y))),(_.isOutputHovered||m&&t.shiftKey)&&(o.dragFromReroute(n,_),N(this,F,Bt).call(this)),_.isInputHovered&&(o.dragFromRerouteToOutput(n,_),N(this,F,Bt).call(this)),_.hideSlots(),this.dirty_bgcanvas=!0;return}}const{lineWidth:p}=this.ctx;this.ctx.lineWidth=this.connections_width+7;const f=(window==null?void 0:window.devicePixelRatio)||1;for(const _ of this.renderedPaths){const m=_._pos;if(m){if((t.shiftKey||t.altKey)&&_.path&&this.ctx.isPointInStroke(_.path,a*f,l*f)){if(this.ctx.lineWidth=p,t.shiftKey&&!t.altKey){o.dragFromLinkSegment(n,_),N(this,F,Bt).call(this);return}else if(t.altKey&&!t.shiftKey){const y=n.createReroute([a,l],_);s.onDragStart=w=>N(this,F,zt).call(this,y,w),s.onDragEnd=w=>N(this,F,Vt).call(this,w);return}}else if(isInRectangle(a,l,m[0]-4,m[1]-4,8,8)){this.ctx.lineWidth=p,s.onClick=()=>this.showLinkMenu(_,t),s.onDragStart=()=>this.dragging_canvas=!0,s.finally=()=>this.dragging_canvas=!1,this.over_link_center=void 0;return}}}this.ctx.lineWidth=p;const g=n.getGroupOnPos(a,l);if(this.selected_group=g??null,g){if(g.isInResize(a,l)){const _=g.boundingRect,m=a-(_[0]+_[2]),y=l-(_[1]+_[3]);s.onDragStart=()=>this.resizingGroup=g,s.onDrag=w=>{if(this.read_only)return;const k=[w.canvasX-g.pos[0]-m,w.canvasY-g.pos[1]-y];I(this,ct)&&snapPoint(k,I(this,ct)),g.resize(k[0],k[1])&&(this.dirty_bgcanvas=!0)},s.finally=()=>this.resizingGroup=null}else{const m=(g.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE)*1.4;isInRectangle(a,l,g.pos[0],g.pos[1],g.size[0],m)&&(s.onClick=()=>this.processSelect(g,t),s.onDragStart=y=>{g.recomputeInsideNodes(),N(this,F,zt).call(this,g,y,!0)},s.onDragEnd=y=>N(this,F,Vt).call(this,y))}s.onDoubleClick=()=>{this.emitEvent({subType:"group-double-click",originalEvent:t,group:g})}}else s.onDoubleClick=()=>{this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault()),this.emitEvent({subType:"empty-double-click",originalEvent:t})}}!s.onDragStart&&!s.onClick&&!s.onDrag&&this.allow_dragcanvas&&(LiteGraph.canvasNavigationMode!=="standard"||this.read_only?(s.onClick=()=>this.processSelect(null,t),s.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0):N(this,F,li).call(this,t,s))},li=function(t,i,s){const n=new Float32Array(4);n[0]=t.canvasX,n[1]=t.canvasY,n[2]=1,n[3]=1,i.onClick=o=>{const r=s??N(this,F,Ci).call(this,o.canvasX,o.canvasY);this.processSelect(r,o)},i.onDragStart=()=>this.dragging_rectangle=n,i.onDragEnd=o=>N(this,F,xi).call(this,o,n),i.finally=()=>this.dragging_rectangle=null},Oi=function(t,i,s){var f,g,_,m;const{pointer:n,graph:o,linkConnector:r}=this;if(!o)throw new NullGraphError;const a=t.canvasX,l=t.canvasY;n.onClick=()=>this.processSelect(s,t),s.flags.pinned||this.bringToFront(s);const h=s.isPointInCollapse(a,l);if(h)n.onClick=()=>{s.collapse(),this.setDirty(!0,!0)};else if(!s.flags.collapsed){const{inputs:y,outputs:w}=s;if(w)for(const[k,L]of w.entries()){const E=s.getOutputPos(k);if(isInRectangle(a,l,E[0]-15,E[1]-10,30,20)){if(t.shiftKey&&((f=L.links)!=null&&f.length||(g=L._floatingLinks)!=null&&g.size)){r.moveOutputLink(o,L),N(this,F,Bt).call(this);return}r.dragNewFromOutput(o,s,L),N(this,F,Bt).call(this),LiteGraph.shift_click_do_break_link_from?t.shiftKey&&s.disconnectOutput(k):LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey&&s.disconnectOutput(k),n.onDoubleClick=()=>{var S;return(S=s.onOutputDblClick)==null?void 0:S.call(s,k,t)},n.onClick=()=>{var S;return(S=s.onOutputClick)==null?void 0:S.call(s,k,t)};return}}if(y)for(const[k,L]of y.entries()){const E=s.getInputPos(k);if(L instanceof NodeInputSlot?isInRect(a,l,L.boundingRect):isInRectangle(a,l,E[0]-15,E[1]-10,30,20)){n.onDoubleClick=()=>{var G;return(G=s.onInputDblClick)==null?void 0:G.call(s,k,t)},n.onClick=()=>{var G;return(G=s.onInputClick)==null?void 0:G.call(s,k,t)};const T=LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey;(L.link!==null||(_=L._floatingLinks)!=null&&_.size)&&(T||LiteGraph.click_do_break_link_to?s.disconnectInput(k,!0):(t.shiftKey||this.allow_reconnect_links)&&r.moveInputLink(o,L)),r.isConnecting||r.dragNewFromInput(o,s,L),N(this,F,Bt).call(this),this.dirty_bgcanvas=!0;return}}}const c=[a-s.pos[0],l-s.pos[1]],p=s.getWidgetOnPos(a,l);if(p)N(this,F,Ri).call(this,t,s,p),this.node_widget=[s,p];else{if(n.onDoubleClick=()=>{var y,w;c[1]<0&&!h?(y=s.onNodeTitleDblClick)==null||y.call(s,t,c,this):s instanceof SubgraphNode&&this.openSubgraph(s.subgraph),(w=s.onDblClick)==null||w.call(s,t,c,this),this.emitEvent({subType:"node-double-click",originalEvent:t,node:s}),this.processNodeDblClicked(s)},(m=s.onMouseDown)!=null&&m.call(s,t,c,this)){n.onClick=()=>{};return}if(!this.allow_dragnodes)return;if(!s.flags.collapsed){const y=s.findResizeDirection(a,l);if(y){n.resizeDirection=y;const w=new Rectangle(s.pos[0],s.pos[1],s.size[0],s.size[1]);n.onDragStart=()=>{o.beforeChange(),this.resizing_node=s},n.onDrag=k=>{if(this.read_only)return;const L=k.canvasX-a,E=k.canvasY-l,S=new Rectangle(w.x,w.y,w.width,w.height);switch(y){case"NE":S.y=w.y+E,S.width=w.width+L,S.height=w.height-E;break;case"SE":S.width=w.width+L,S.height=w.height+E;break;case"SW":S.x=w.x+L,S.width=w.width-L,S.height=w.height+E;break;case"NW":S.x=w.x+L,S.y=w.y+E,S.width=w.width-L,S.height=w.height-E;break}if(I(this,ct)){if(y.includes("N")||y.includes("W")){const G=S.x,D=S.y;snapPoint(S.pos,I(this,ct)),y.includes("N")&&(S.height+=D-S.y),y.includes("W")&&(S.width+=G-S.x)}snapPoint(S.size,I(this,ct))}const T=s.computeSize();S.width<T[0]&&(y.includes("W")&&(S.x=w.x+w.width-T[0]),S.width=T[0]),S.height<T[1]&&(y.includes("N")&&(S.y=w.y+w.height-T[1]),S.height=T[1]),s.pos=S.pos,s.setSize(S.size),N(this,F,wt).call(this)},n.onDragEnd=()=>{N(this,F,wt).call(this),o.afterChange(s)},n.finally=()=>{this.resizing_node=null,n.resizeDirection=void 0},this.canvas.style.cursor=cursors[y];return}}n.onDragStart=y=>N(this,F,zt).call(this,s,y,!0),n.onDragEnd=y=>N(this,F,Vt).call(this,y)}this.dirty_canvas=!0},Ri=function(t,i,s){var c;const{pointer:n}=this;if(typeof s.onPointerDown=="function"&&s.onPointerDown(n,i,this))return;const o=s.value,r=this.graph_mouse,a=r[0]-i.pos[0],l=r[1]-i.pos[1],h=toConcreteWidget(s,i,!1);if(h)n.onClick=()=>h.onClick({e:t,node:i,canvas:this}),n.onDrag=p=>{var f;return(f=h.onDrag)==null?void 0:f.call(h,{e:p,node:i,canvas:this})};else if(s.mouse){const p=s.mouse(t,[a,l],i);p!=null&&(this.dirty_canvas=p)}if(o!=s.value){if((c=i.onWidgetChanged)==null||c.call(i,s.name,s.value,o,s),!i.graph)throw new NullGraphError;i.graph._version++}n.finally=()=>{if(s.mouse){const{eUp:p}=n;if(!p)return;const{canvasX:f,canvasY:g}=p;s.mouse(p,[f-i.pos[0],g-i.pos[1]],i)}this.node_widget=null}},Di=function(t,i){const{pointer:s}=this;if(LiteGraph.middle_click_slot_add_default_node&&i&&this.allow_interaction&&!this.read_only&&!this.connecting_links&&!i.flags.collapsed){let n=!1,o=!1,r=!1;const{inputs:a,outputs:l}=i;if(l)for(const[h,c]of l.entries()){const p=i.getOutputPos(h);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){n=c,o=h,r=!0;break}}if(a)for(const[h,c]of a.entries()){const p=i.getInputPos(h);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){n=c,o=h,r=!1;break}}if(n&&o!==!1){const h=.5-(o+1)/(r?l.length:a.length),c=i.getBounding(),p=[r?c[0]+c[2]:c[0],t.canvasY-80];s.onClick=()=>this.createDefaultNodeForSlot({nodeFrom:r?i:null,slotFrom:r?o:null,nodeTo:r?null:i,slotTo:r?null:o,position:p,nodeType:"AUTO",posAdd:[r?30:-30,-h*130],posSizeFix:[r?0:-1,0]})}}this.allow_dragcanvas&&(s.onDragStart=()=>this.dragging_canvas=!0,s.finally=()=>this.dragging_canvas=!1)},Gi=function(t){if(!t.buttons){U(this,Pt,null);return}const i=I(this,Pt);if(!i)throw new TypeError("Drag-zoom state object was null");if(!this.graph)throw new NullGraphError;const s=t.y-i.pos[1],o=i.scale-s/100;this.ds.changeScale(o,i.pos),this.graph.change()},Ai=function(t){const{graph:i,pointer:s,linkConnector:n}=this;if(!i)throw new NullGraphError;if(s.isDown){if(n.isConnecting){for(const o of I(this,yt))if(o.containsPoint(this.graph_mouse))return n.isRerouteValidDrop(o)&&(n.overReroute=o,this._highlight_pos=o.pos),t|=CanvasItem.RerouteSlot}}else{let o=!1;for(const r of I(this,yt))o||(o=r.updateVisibility(this.graph_mouse)),r.isSlotHovered&&(t|=CanvasItem.RerouteSlot);o&&(this.dirty_bgcanvas=!0)}return this._highlight_pos&&(this._highlight_pos=void 0),n.overReroute&&(n.overReroute=void 0),t},zt=function(t,i,s=!1){var n;this.emitBeforeChange(),(n=this.graph)==null||n.beforeChange(),i.finally=()=>{var o;this.isDragging=!1,(o=this.graph)==null||o.afterChange(),this.emitAfterChange()},this.processSelect(t,i.eDown,s),this.isDragging=!0},Vt=function(t){var s;const{graph:i}=this;(t.shiftKey||LiteGraph.alwaysSnapToGrid)&&(i==null||i.snapToGrid(this.selectedItems)),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,(s=this.onNodeMoved)==null||s.call(this,findFirstNode(this.selectedItems))},Fi=function(){const t=new CustomEvent("litegraph:no-items-selected",{bubbles:!0});this.canvas.dispatchEvent(t)},xi=function(t,i){var p;const{graph:s,selectedItems:n,subgraph:o}=this;if(!s)throw new NullGraphError;const r=Math.abs(i[2]),a=Math.abs(i[3]);i[2]<0&&(i[0]-=r),i[3]<0&&(i[1]-=a),i[2]=r,i[3]=a;const l=new Set,h=[];if(o){const{inputNode:f,outputNode:g}=o;overlapBounding(i,f.boundingRect)&&c(f),overlapBounding(i,g.boundingRect)&&c(g)}for(const f of s._nodes)overlapBounding(i,f.boundingRect)&&c(f);for(const f of s.groups)containsRect(i,f._bounding)&&(f.recomputeInsideNodes(),c(f));for(const f of s.reroutes.values())isPointInRect(f.pos,i)&&(n.add(f),f.selected=!0,c(f));if(t.shiftKey)for(const f of h)this.select(f);else if(t.altKey)for(const f of l)this.deselect(f);else{for(const f of n.values())l.has(f)||this.deselect(f);for(const f of h)this.select(f)}(p=this.onSelectionChange)==null||p.call(this,this.selected_nodes);function c(f){!f.selected||!n.has(f)?h.push(f):l.add(f)}},Pi=function(t){for(const i of this.renderedPaths){const s=i._pos;if(s&&isInRectangle(t.canvasX,t.canvasY,s[0]-4,s[1]-4,8,8))return i}},Wi=function(){return LiteGraph.snaps_for_comfy?this.linkConnector.state.snapLinksPos??this._highlight_pos??this.graph_mouse:this.graph_mouse},Mi=function(t,i){var C;const s=!!this.linkConnector.state.snapLinksPos;if(!this._highlight_pos&&!s)return;t.fillStyle="#ffcc00",t.beginPath(),((C=this._highlight_input)==null?void 0:C.shape)===RenderShape.ARROW?(t.moveTo(i[0]+8,i[1]+.5),t.lineTo(i[0]-4,i[1]+6+.5),t.lineTo(i[0]-4,i[1]-6+.5),t.closePath()):t.arc(i[0],i[1],6,0,Math.PI*2),t.fill();const{linkConnector:o}=this,{overReroute:r,overWidget:a}=o;if(!LiteGraph.snap_highlights_node||!o.isConnecting||s)return;r==null||r.drawHighlight(t,"#ffcc00aa");const l=this.node_over;if(!l)return;const{strokeStyle:h,lineWidth:c}=t,p=l.boundingRect,f=3,g=LiteGraph.ROUND_RADIUS+f,_=p[0]-f,m=p[1]-f,y=p[2]+f*2,w=p[3]+f*2;t.beginPath(),t.roundRect(_,m,y,w,g);const k=o.state.connectingTo==="output"?0:1,L=k?-1:1,E=i[0],S=i[1],T=y<w?y:y*Math.max(w/y,.5),G=t.createRadialGradient(E,S,0,E,S,T);G.addColorStop(1,"#00000000"),G.addColorStop(0,"#ffcc00aa");const D=t.createLinearGradient(_,m,_+y,m);if(D.addColorStop(.5,"#00000000"),D.addColorStop(k+.67*L,"#ddeeff33"),D.addColorStop(k+L,"#ffcc0055"),t.setLineDash([g,g*.001]),t.lineWidth=1,t.strokeStyle=D,t.stroke(),a){const{computedHeight:R}=a;t.beginPath();const{pos:[A,V]}=l,j=LiteGraph.NODE_WIDGET_HEIGHT;a.type.startsWith("custom")&&R!=null&&R>j*2?t.rect(A+9,V+a.y+9,(a.width??p[2])-18,R-18):t.roundRect(A+BaseWidget.margin,V+a.y,a.width??p[2],j,j*.5),t.stroke()}t.strokeStyle=G,t.stroke(),t.setLineDash([]),t.lineWidth=c,t.strokeStyle=h},Bi=function(t,i,s,n){var r,a;const{globalAlpha:o}=t;t.globalAlpha=o*.33;for(const l of i.floatingLinks.values()){const h=LLink.getReroutes(i,l),c=h[0],p=h.at(-1);if(!(!c||!(p!=null&&p.floating)))if(p.floating.slotType==="input"){const f=i.getNodeById(l.target_id);if(!f)continue;const g=c.pos,_=f.getInputPos(l.target_slot),m=(r=f.inputs[l.target_slot])==null?void 0:r.dir;c._dragging=!0,N(this,F,ne).call(this,t,l,g,_,s,n,LinkDirection.CENTER,m,!0)}else{const f=i.getNodeById(l.origin_id);if(!f)continue;const g=f.getOutputPos(l.origin_slot),_=p.pos,m=(a=f.outputs[l.origin_slot])==null?void 0:a.dir;l._dragging=!0,N(this,F,ne).call(this,t,l,g,_,s,n,m,LinkDirection.CENTER,!0)}}t.globalAlpha=o},ne=function(t,i,s,n,o,r,a,l,h=!1){var k,L,E;const{graph:c,renderedPaths:p}=this;if(!c)return;const f=LLink.getReroutes(c,i),g=[s,...f.map(S=>S.pos),n],_=g.map(S=>S[0]),m=g.map(S=>S[1]);if(I(O,St)[0]=Math.min(..._),I(O,St)[1]=Math.min(...m),I(O,St)[2]=Math.max(..._)-I(O,St)[0],I(O,St)[3]=Math.max(...m)-I(O,St)[1],!overlapBounding(I(O,St),I(O,Nt)))return;const y=a||LinkDirection.RIGHT,w=l||LinkDirection.LEFT;if(f.length){let S;const T=f.length;for(let D=0;D<T;D++){const C=f[D];if(!p.has(C)){p.add(C),o.push(C),C._colour=i.color||O.link_type_colors[i.type]||this.default_link_color;const R=c.getReroute(C.parentId),A=(R==null?void 0:R.pos)??s;C.calculateAngle(this.last_draw_time,c,A),C._dragging||this.renderLink(t,A,C.pos,i,!1,0,null,S===void 0?y:LinkDirection.CENTER,LinkDirection.CENTER,{startControl:S,endControl:C.controlPoint,reroute:C,disabled:h})}if(!S&&((L=(k=f.at(-1))==null?void 0:k.floating)==null?void 0:L.slotType)==="input")S=[0,0];else{const R=((E=f[D+1])==null?void 0:E.pos)??n,A=Math.min(Reroute.maxSplineOffset,distance(C.pos,R)*.25);S=[A*C.cos,A*C.sin]}}if(i._dragging)return;const G=g.at(-2)??s;this.renderLink(t,G,n,i,!1,0,null,LinkDirection.CENTER,w,{startControl:S,disabled:h})}else i._dragging||this.renderLink(t,s,n,i,!1,0,null,y,w);if(p.add(i),i!=null&&i._last_time&&r-i._last_time<1e3){const S=2-(r-i._last_time)*.002,T=t.globalAlpha;t.globalAlpha=T*S,this.renderLink(t,s,n,i,!0,S,"white",y,w),t.globalAlpha=T}},Oe=function(t,i,s,n=.25){switch(i){case LinkDirection.LEFT:t[0]+=s*-n;break;case LinkDirection.RIGHT:t[0]+=s*n;break;case LinkDirection.UP:t[1]+=s*-n;break;case LinkDirection.DOWN:t[1]+=s*n;break}},P(O,Ae,new Float32Array(4)),P(O,Fe,new Float32Array(2)),P(O,xe,new Float32Array(4)),P(O,Nt,new Float32Array(4)),P(O,St,new Float32Array(4)),P(O,Pe,new Float32Array(2)),P(O,We,new Float32Array(2)),P(O,Me,new Float32Array(2)),d(O,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),d(O,"DEFAULT_EVENT_LINK_COLOR","#A86"),d(O,"link_type_colors",{"-1":O.DEFAULT_EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),d(O,"gradients",{}),d(O,"search_limit",-1),d(O,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}}),d(O,"_measureText"),d(O,"active_canvas"),d(O,"active_node");let LGraphCanvas=O;class MapProxyHandler{getOwnPropertyDescriptor(t,i){const s=this.get(t,i);if(s)return{configurable:!0,enumerable:!0,value:s}}has(t,i){if(typeof i=="symbol")return!1;const s=parseInt(i,10);return t.has(isNaN(s)?i:s)}ownKeys(t){return[...t.keys()].map(String)}get(t,i){if(i in t)return Reflect.get(t,i,t);if(typeof i=="symbol")return;const s=parseInt(i,10);return t.get(isNaN(s)?i:s)}set(t,i,s){if(typeof i=="symbol")return!1;const n=parseInt(i,10);return t.set(isNaN(n)?i:n,s),!0}deleteProperty(t,i){return t.delete(i)}static bindAllMethods(t){t.clear=t.clear.bind(t),t.delete=t.delete.bind(t),t.forEach=t.forEach.bind(t),t.get=t.get.bind(t),t.has=t.has.bind(t),t.set=t.set.bind(t),t.entries=t.entries.bind(t),t.keys=t.keys.bind(t),t.values=t.values.bind(t),t[Symbol.iterator]=t[Symbol.iterator].bind(t)}}const at=class at{constructor(t){P(this,ze);d(this,"id",zeroUuid);d(this,"revision",0);d(this,"_version",-1);d(this,"_links",new Map);d(this,"links");d(this,"list_of_graphcanvas");d(this,"status",at.STATUS_STOPPED);d(this,"state",{lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0});d(this,"events",new CustomEventTarget);d(this,"_subgraphs",new Map);d(this,"_nodes",[]);d(this,"_nodes_by_id",{});d(this,"_nodes_in_order",[]);d(this,"_nodes_executable",null);d(this,"_groups",[]);d(this,"iteration",0);d(this,"globaltime",0);d(this,"runningtime",0);d(this,"fixedtime",0);d(this,"fixedtime_lapse",.01);d(this,"elapsed_time",.01);d(this,"last_update_time",0);d(this,"starttime",0);d(this,"catch_errors",!0);d(this,"execution_timer_id");d(this,"errors_in_execution");d(this,"execution_time");d(this,"_last_trigger_time");d(this,"filter");d(this,"config",{});d(this,"vars",{});d(this,"nodes_executing",[]);d(this,"nodes_actioning",[]);d(this,"nodes_executedAction",[]);d(this,"extra",{});d(this,"version");P(this,Wt,0);P(this,Mt,new Map);P(this,Be,new Map);d(this,"_input_nodes");P(this,we);LiteGraph.debug&&console.log("Graph created");const i=this._links;MapProxyHandler.bindAllMethods(i);const s=new MapProxyHandler;this.links=new Proxy(i,s),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}get empty(){return this._nodes.length+this._groups.length+this.reroutes.size===0}*positionableItems(){for(const t of this._nodes)yield t;for(const t of this._groups)yield t;for(const t of this.reroutes.values())yield t}get floatingLinks(){return I(this,Mt)}get reroutes(){return I(this,Be)}get rootGraph(){return this}get isRootGraph(){return this.rootGraph===this}get last_node_id(){return this.state.lastNodeId}set last_node_id(t){this.state.lastNodeId=t}get last_link_id(){return this.state.lastLinkId}set last_link_id(t){this.state.lastLinkId=t}clear(){var t;if(this.stop(),this.status=at.STATUS_STOPPED,this.id=zeroUuid,this.revision=0,this.state={lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0},this._version=-1,this._subgraphs.clear(),this._nodes)for(const i of this._nodes)(t=i.onRemoved)==null||t.call(i);this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._links.clear(),this.reroutes.clear(),I(this,Mt).clear(),U(this,Wt,0),this._groups=[],this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.change(),this.canvasAction(i=>i.clear())}get subgraphs(){return this.rootGraph._subgraphs}get nodes(){return this._nodes}get groups(){return this._groups}attachCanvas(t){var i;if(!(t instanceof LGraphCanvas))throw new TypeError("attachCanvas expects an LGraphCanvas instance");this.primaryCanvas=t,this.list_of_graphcanvas??(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.includes(t)||this.list_of_graphcanvas.push(t),t.graph!==this&&((i=t.graph)==null||i.detachCanvas(t),t.graph=this,t.subgraph=void 0)}detachCanvas(t){t.graph=null;const i=this.list_of_graphcanvas;if(i){const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}start(t){var i;if(this.status!=at.STATUS_RUNNING)if(this.status=at.STATUS_RUNNING,(i=this.onPlayEvent)==null||i.call(this),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,t||(t=0),t==0&&typeof window<"u"&&window.requestAnimationFrame){const s=()=>{var n,o;this.execution_timer_id==-1&&(window.requestAnimationFrame(s),(n=this.onBeforeStep)==null||n.call(this),this.runStep(1,!this.catch_errors),(o=this.onAfterStep)==null||o.call(this))};this.execution_timer_id=-1,s()}else this.execution_timer_id=setInterval(()=>{var s,n;(s=this.onBeforeStep)==null||s.call(this),this.runStep(1,!this.catch_errors),(n=this.onAfterStep)==null||n.call(this)},t)}stop(){var t;this.status!=at.STATUS_STOPPED&&(this.status=at.STATUS_STOPPED,(t=this.onStopEvent)==null||t.call(this),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t,i,s){var l,h,c,p,f,g;t=t||1;const n=LiteGraph.getTime();this.globaltime=.001*(n-this.starttime);const o=this._nodes_executable||this._nodes;if(!o)return;if(s=s||o.length,i){for(let _=0;_<t;_++){for(let m=0;m<s;++m){const y=o[m];y.mode==LGraphEventMode.ALWAYS&&y.onExecute&&((l=y.doExecute)==null||l.call(y))}this.fixedtime+=this.fixedtime_lapse,(h=this.onExecuteStep)==null||h.call(this)}(c=this.onAfterExecute)==null||c.call(this)}else try{for(let _=0;_<t;_++){for(let m=0;m<s;++m){const y=o[m];y.mode==LGraphEventMode.ALWAYS&&((p=y.onExecute)==null||p.call(y))}this.fixedtime+=this.fixedtime_lapse,(f=this.onExecuteStep)==null||f.call(this)}(g=this.onAfterExecute)==null||g.call(this),this.errors_in_execution=!1}catch(_){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw _;LiteGraph.debug&&console.log("Error during execution:",_),this.stop()}const r=LiteGraph.getTime();let a=r-n;a==0&&(a=1),this.execution_time=.001*a,this.globaltime+=.001*a,this.iteration+=1,this.elapsed_time=(r-this.last_update_time)*.001,this.last_update_time=r,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(const t of this._nodes_in_order)t.onExecute&&this._nodes_executable.push(t)}computeExecutionOrder(t,i){const s=[],n=[],o={},r={},a={};for(const h of this._nodes){if(t&&!h.onExecute)continue;o[h.id]=h;let c=0;if(h.inputs)for(const p of h.inputs)(p==null?void 0:p.link)!=null&&(c+=1);c==0?(n.push(h),i&&(h._level=1)):(i&&(h._level=0),a[h.id]=c)}for(;;){const h=n.shift();if(h===void 0)break;if(s.push(h),delete o[h.id],!!h.outputs){for(const c of h.outputs)if(!((c==null?void 0:c.links)==null||c.links.length==0))for(const p of c.links){const f=this._links.get(p);if(!f||r[f.id])continue;const g=this.getNodeById(f.target_id);if(g==null){r[f.id]=!0;continue}i&&(h._level??(h._level=0),(!g._level||g._level<=h._level)&&(g._level=h._level+1)),r[f.id]=!0,a[g.id]-=1,a[g.id]==0&&n.push(g)}}}for(const h in o)s.push(o[h]);s.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");function l(h){const c=h.length;for(let p=0;p<c;++p)h[p].order=p}return l(s),s.sort(function(h,c){const p=h.constructor.priority||h.priority||0,f=c.constructor.priority||c.priority||0;return p==f?h.order-c.order:p-f}),l(s),s}arrange(t,i){t=t||100;const s=this.computeExecutionOrder(!1,!0),n=[];for(const r of s){const a=r._level||1;n[a]||(n[a]=[]),n[a].push(r)}let o=t;for(const r of n){if(!r)continue;let a=100,l=t+LiteGraph.NODE_TITLE_HEIGHT;for(const h of r){h.pos[0]=i==LiteGraph.VERTICAL_LAYOUT?l:o,h.pos[1]=i==LiteGraph.VERTICAL_LAYOUT?o:l;const c=i==LiteGraph.VERTICAL_LAYOUT?1:0;h.size[c]>a&&(a=h.size[c]);const p=i==LiteGraph.VERTICAL_LAYOUT?0:1;l+=h.size[p]+t+LiteGraph.NODE_TITLE_HEIGHT}o+=a+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,i,s){s=s||LGraphEventMode.ALWAYS;const n=this._nodes_in_order||this._nodes;if(n)for(const o of n)!o[t]||o.mode!=s||(i===void 0?o[t]():i&&i.constructor===Array?o[t].apply(o,i):o[t](i))}canvasAction(t){const i=this.list_of_graphcanvas;if(i)for(const s of i)t(s)}sendActionToCanvas(t,i){var n;const{list_of_graphcanvas:s}=this;if(s)for(const o of s)(n=o[t])==null||n.apply(o,i)}add(t,i){var n,o;if(!t)return;const{state:s}=this;if(LiteGraph.alwaysSnapToGrid){const r=this.getSnapToGridSize();r&&t.snapToGrid(r)}if(t instanceof LGraphGroup){(t.id==null||t.id===-1)&&(t.id=++s.lastGroupId),t.id>s.lastGroupId&&(s.lastGroupId=t.id),this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=LiteGraph.use_uuids?LiteGraph.uuidv4():++s.lastNodeId),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++s.lastNodeId:typeof t.id=="number"&&s.lastNodeId<t.id&&(s.lastNodeId=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,(n=t.onAdded)==null||n.call(t,this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),(o=this.onNodeAdded)==null||o.call(this,t),this.setDirtyCanvas(!0),this.change(),t}remove(t){var r,a,l;if(t instanceof LGraphGroup){this.canvasAction(c=>c.deselect(t));const h=this._groups.indexOf(t);h!=-1&&this._groups.splice(h,1),t.graph=void 0,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]==null){console.warn("LiteGraph: node not found",t);return}if(t.ignore_remove){console.warn("LiteGraph: node cannot be removed",t);return}this.beforeChange();const{inputs:i,outputs:s}=t;if(i)for(const[h,c]of i.entries())c.link!=null&&t.disconnectInput(h,!0);if(s)for(const[h,c]of s.entries())(r=c.links)!=null&&r.length&&t.disconnectOutput(h);for(const h of this.floatingLinks.values())(h.origin_id===t.id||h.target_id===t.id)&&this.removeFloatingLink(h);(a=t.onRemoved)==null||a.call(t),t.graph=null,this._version++;const{list_of_graphcanvas:n}=this;if(n)for(const h of n)h.selected_nodes[t.id]&&delete h.selected_nodes[t.id],h.deselect(t);const o=this._nodes.indexOf(t);o!=-1&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],(l=this.onNodeRemoved)==null||l.call(this,t),this.canvasAction(h=>h.checkPanels()),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}getNodeById(t){return t!=null?this._nodes_by_id[t]:null}findNodesByClass(t,i){i=i||[],i.length=0;const{_nodes:s}=this;for(const n of s)n.constructor===t&&i.push(n);return i}findNodesByType(t,i){var o;const s=t.toLowerCase();i=i||[],i.length=0;const{_nodes:n}=this;for(const r of n)((o=r.type)==null?void 0:o.toLowerCase())==s&&i.push(r);return i}findNodeByTitle(t){const{_nodes:i}=this;for(const s of i)if(s.title==t)return s;return null}findNodesByTitle(t){const i=[],{_nodes:s}=this;for(const n of s)n.title==t&&i.push(n);return i}getNodeOnPos(t,i,s){const n=s||this._nodes;let o=n.length;for(;--o>=0;){const r=n[o];if(r.isPointInside(t,i))return r}return null}getGroupOnPos(t,i){return this._groups.toReversed().find(s=>s.isPointInside(t,i))}getGroupTitlebarOnPos(t,i){return this._groups.toReversed().find(s=>s.isPointInTitlebar(t,i))}getRerouteOnPos(t,i,s){for(const n of s??this.reroutes.values())if(n.containsPoint([t,i]))return n}snapToGrid(t){const i=this.getSnapToGridSize();if(i)for(const s of getAllNestedItems(t))s.pinned||s.snapToGrid(i)}getSnapToGridSize(){return LiteGraph.alwaysSnapToGrid?LiteGraph.CANVAS_GRID_SIZE||1:LiteGraph.CANVAS_GRID_SIZE}checkNodeTypes(){const{_nodes:t}=this;for(const[i,s]of t.entries()){const n=LiteGraph.registered_node_types[s.type];if(s.constructor==n)continue;console.log("node being replaced by newer version:",s.type);const o=LiteGraph.createNode(s.type);o&&(t[i]=o,o.configure(s.serialize()),o.graph=this,this._nodes_by_id[o.id]=o,s.inputs&&(o.inputs=[...s.inputs]),s.outputs&&(o.outputs=[...s.outputs]))}this.updateExecutionOrder()}trigger(t,i){var s;(s=this.onTrigger)==null||s.call(this,t,i)}triggerInput(t,i){const s=this.findNodesByTitle(t);for(const n of s)n.onTrigger(i)}setCallback(t,i){const s=this.findNodesByTitle(t);for(const n of s)n.setTrigger(i)}beforeChange(t){var i;(i=this.onBeforeChange)==null||i.call(this,this,t),this.canvasAction(s=>{var n;return(n=s.onBeforeChange)==null?void 0:n.call(s,this)})}afterChange(t){var i;(i=this.onAfterChange)==null||i.call(this,this,t),this.canvasAction(s=>{var n;return(n=s.onAfterChange)==null?void 0:n.call(s,this)})}clearTriggeredSlots(){for(const t of this._links.values())t&&t._last_time&&(t._last_time=0)}change(){var t;LiteGraph.debug&&console.log("Graph changed"),this.canvasAction(i=>i.setDirty(!0,!0)),(t=this.on_change)==null||t.call(this,this)}setDirtyCanvas(t,i){this.canvasAction(s=>s.setDirty(t,i))}addFloatingLink(t){var n,o,r,a;t.id===-1&&(t.id=++pi(this,Wt)._),I(this,Mt).set(t.id,t);const i=t.target_id!==-1?(o=(n=this.getNodeById(t.target_id))==null?void 0:n.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i?(i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(t)):console.warn(`Adding invalid floating link: target/slot: [${t.target_id}/${t.target_slot}] origin/slot: [${t.origin_id}/${t.origin_slot}]`);const s=LLink.getReroutes(this,t);for(const l of s)l.floatingLinkIds.add(t.id);return t}removeFloatingLink(t){var n,o,r,a,l;I(this,Mt).delete(t.id);const i=t.target_id!==-1?(o=(n=this.getNodeById(t.target_id))==null?void 0:n.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i&&((l=i._floatingLinks)==null||l.delete(t));const s=LLink.getReroutes(this,t);for(const h of s)h.floatingLinkIds.delete(t.id),h.floatingLinkIds.size===0&&delete h.floating,h.totalLinks===0&&this.removeReroute(h.id)}getLink(t){return t==null?void 0:this._links.get(t)}getReroute(t){return t==null?void 0:this.reroutes.get(t)}setReroute({id:t,parentId:i,pos:s,linkIds:n,floating:o}){t??(t=++this.state.lastRerouteId),t>this.state.lastRerouteId&&(this.state.lastRerouteId=t);const r=this.reroutes.get(t)??new Reroute(t,this);return r.update(i,s,n,o),this.reroutes.set(t,r),r}createReroute(t,i){const s=++this.state.lastRerouteId,n=i instanceof Reroute?i.linkIds:[i.id],o=i instanceof Reroute?i.floatingLinkIds:[i.id],r=new Reroute(s,this,t,i.parentId,n,o);this.reroutes.set(s,r);for(const a of n){const l=this._links.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=s);const h=LLink.getReroutes(this,l);for(const c of h.filter(p=>p.parentId===i.parentId))c.parentId=s}for(const a of o){const l=this.floatingLinks.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=s);const h=LLink.getReroutes(this,l);for(const c of h.filter(p=>p.parentId===i.parentId))c.parentId=s}return r}removeReroute(t){const{reroutes:i}=this,s=i.get(t);if(!s)return;this.canvasAction(a=>a.deselect(s));const{parentId:n,linkIds:o,floatingLinkIds:r}=s;for(const a of i.values())a.parentId===t&&(a.parentId=n);for(const a of o){const l=this._links.get(a);l&&l.parentId===t&&(l.parentId=n)}for(const a of r){const l=this.floatingLinks.get(a);if(!l){console.warn(`Removed reroute had floating link ID that did not exist [${a}]`);continue}const h=LLink.getReroutes(this,l),c=h.at(-1),p=h.at(-2);s===c&&((p==null?void 0:p.totalLinks)!==1?this.removeFloatingLink(l):l.parentId===t&&(l.parentId=n,p.floating=s.floating))}i.delete(t),this.setDirtyCanvas(!1,!0)}removeLink(t){const i=this._links.get(t);if(!i)return;const s=this.getNodeById(i.target_id);s==null||s.disconnectInput(i.target_slot,!1),i.disconnect(this)}createSubgraph(t){const{id:i}=t,s=new Subgraph(this.rootGraph,t);return this.subgraphs.set(i,s),this.rootGraph.events.dispatch("subgraph-created",{subgraph:s,data:t}),s}convertToSubgraph(t){var V,j;if(t.size===0)throw new Error("Cannot convert to subgraph: nothing to convert");const{state:i,revision:s,config:n}=this,{boundaryLinks:o,boundaryFloatingLinks:r,internalLinks:a,boundaryInputLinks:l,boundaryOutputLinks:h}=getBoundaryLinks(this,t),{nodes:c,reroutes:p,groups:f}=splitPositionables(t),g=createBounds(t);if(!g)throw new Error("Failed to create bounding rect for subgraph");const _=l.map(M=>M.resolve(this)),m=h.map(M=>M.resolve(this)),y=multiClone(c),w=a.map(M=>M.asSerialisable()),k=mapSubgraphInputsAndLinks(_,w),L=mapSubgraphOutputsAndLinks(m,w),E={id:createUuidv4(),name:"New Subgraph",inputNode:{id:SUBGRAPH_INPUT_ID,bounding:[0,0,75,100]},outputNode:{id:SUBGRAPH_OUTPUT_ID,bounding:[0,0,75,100]},inputs:k,outputs:L,widgets:[],version:at.serialisedSchemaVersion,state:i,revision:s,config:n,links:w,nodes:y,reroutes:structuredClone([...p].map(M=>M.asSerialisable())),groups:structuredClone([...f].map(M=>M.serialize()))},S=this.createSubgraph(E);S.configure(E),S.inputNode.arrange(),S.outputNode.arrange();const{boundingRect:T}=S.inputNode,{boundingRect:G}=S.outputNode;alignOutsideContainer(T,Alignment.MidLeft,g,[50,0]),alignOutsideContainer(G,Alignment.MidRight,g,[50,0]);for(const M of _)(V=M.inputNode)==null||V.disconnectInput(M.inputNode.inputs.indexOf(M.input),!0);for(const M of m)(j=M.outputNode)==null||j.disconnectOutput(M.outputNode.outputs.indexOf(M.output),M.inputNode);for(const M of c)this.remove(M);for(const M of p)this.removeReroute(M.id);for(const M of f)this.remove(M);this.rootGraph.events.dispatch("convert-to-subgraph",{subgraph:S,bounds:g,exportedSubgraph:E,boundaryLinks:o,resolvedInputLinks:_,resolvedOutputLinks:m,boundaryFloatingLinks:r,internalLinks:a});const D=LiteGraph.createNode(S.id,S.name,{inputs:structuredClone(k),outputs:structuredClone(L)});if(!D)throw new Error("Failed to create subgraph node");D.setSize(D.computeSize()),alignToContainer(D._posSize,Alignment.Centre|Alignment.Middle,g),this.add(D);const C=groupResolvedByOutput(_);let R=0;for(const[,M]of C.entries()){const[W,...B]=M,{output:$,outputNode:z,link:q,subgraphInput:lt}=W;if(R++,q.origin_id===SUBGRAPH_INPUT_ID){if(q.target_id=D.id,q.target_slot=R-1,lt instanceof SubgraphInput)lt.connect(D.findInputSlotByType(q.type,!0,!0),D,q.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");console.debug("Reconnect input links in parent graph",{...q},this.links.get(q.id),this.links.get(q.id)===q);for(const Et of B)Et.link.disconnect(this);continue}if(!$||!z){console.warn("Convert to Subgraph reconnect: Failed to resolve input link",M[0]);continue}const vt=D.findInputSlotByType(q.type,!0,!0);z.connectSlots($,D,vt,q.parentId)}const A=groupResolvedByOutput(m);R=0;for(const[,M]of A.entries()){R++;for(const W of M){const{input:B,inputNode:$,link:z,subgraphOutput:q}=W;if(z.target_id===SUBGRAPH_OUTPUT_ID){if(z.origin_id=D.id,z.origin_slot=R-1,this.links.set(z.id,z),q instanceof SubgraphOutput)q.connect(D.findOutputSlotByType(z.type,!0,!0),D,z.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");continue}if(!B||!$){console.warn("Convert to Subgraph reconnect: Failed to resolve output link",W);continue}const lt=D.outputs[R-1];D.connectSlots(lt,$,B,z.parentId)}}return{subgraph:S,node:D}}resolveSubgraphIdPath(t){const i=[];let s=this.rootGraph;for(const n of t){const o=s.getNodeById(n);if(!o)throw new Error(`Node [${n}] not found.  ID Path: ${t.join(":")}`);if(!o.isSubgraphNode())throw new Error(`Node [${n}] is not a SubgraphNode.  ID Path: ${t.join(":")}`);i.push(o),s=o.subgraph}return i}serialize(t){const{config:i,state:s,groups:n,nodes:o,reroutes:r,extra:a,floatingLinks:l,definitions:h}=this.asSerialisable(t),c=[...this._links.values()],p=c.map(f=>f.serialize());return r!=null&&r.length&&(a.linkExtensions=c.filter(f=>f.parentId!==void 0).map(f=>({id:f.id,parentId:f.parentId}))),a.reroutes=r!=null&&r.length?r:void 0,{id:this.id,revision:this.revision,last_node_id:s.lastNodeId,last_link_id:s.lastLinkId,nodes:o,links:p,floatingLinks:l,groups:n,definitions:h,config:i,extra:a,version:LiteGraph.VERSION}}asSerialisable(t){var _;const{id:i,revision:s,config:n,state:o}=this,a=(!LiteGraph.use_uuids&&(t!=null&&t.sortNodes)?[...this._nodes].sort((m,y)=>m.id-y.id):this._nodes).map(m=>m.serialize()),l=this._groups.map(m=>m.serialize()),h=this._links.size?[...this._links.values()].map(m=>m.asSerialisable()):void 0,c=this.floatingLinks.size?[...this.floatingLinks.values()].map(m=>m.asSerialisable()):void 0,p=this.reroutes.size?[...this.reroutes.values()].map(m=>m.asSerialisable()):void 0,f={...this.extra};LiteGraph.saveViewportWithGraph&&(f.ds=N(this,ze,zi).call(this)),f.ds||delete f.ds;const g={id:i,revision:s,version:at.serialisedSchemaVersion,config:n,state:o,groups:l,nodes:a,links:h,floatingLinks:c,reroutes:p,extra:f};if(this.isRootGraph&&this._subgraphs.size){const m=findUsedSubgraphIds(this,this._subgraphs),y=[...this._subgraphs.values()].filter(w=>m.has(w.id)).map(w=>w.asSerialisable());y.length>0&&(g.definitions={subgraphs:y})}return(_=this.onSerialize)==null||_.call(this,g),g}_configureBase(t){const{id:i,extra:s}=t;i?this.id=i:this.id===zeroUuid&&(this.id=createUuidv4()),this.extra=s?structuredClone(s):{},delete this.extra.linkExtensions}configure(t,i){var o,r,a,l,h;const s={data:t,clearGraph:!i};if(this.events.dispatch("configuring",s))try{if(!t)return;s.clearGraph&&this.clear(),this._configureBase(t);let c;if(t.version===.4){const{extra:k}=t;if(Array.isArray(t.links))for(const L of t.links){const E=LLink.createFromArray(L);this._links.set(E.id,E)}if(Array.isArray(k==null?void 0:k.linkExtensions))for(const L of k.linkExtensions){const E=this._links.get(L.id);E&&(E.parentId=L.parentId)}c=k==null?void 0:k.reroutes}else{if(t.state){const{lastGroupId:k,lastLinkId:L,lastNodeId:E,lastRerouteId:S}=t.state,{state:T}=this;k!=null&&(T.lastGroupId=k),L!=null&&(T.lastLinkId=L),E!=null&&(T.lastNodeId=E),S!=null&&(T.lastRerouteId=S)}if(Array.isArray(t.links))for(const k of t.links){const L=LLink.create(k);this._links.set(L.id,L)}c=t.reroutes}if(Array.isArray(c))for(const k of c)this.setReroute(k);const p=t.nodes;for(const k in t)at.ConfigureProperties.has(k)||(this[k]=t[k]);const f=(o=t.definitions)==null?void 0:o.subgraphs;if(f){for(const k of f)this.createSubgraph(k);for(const k of f)(r=this.subgraphs.get(k.id))==null||r.configure(k)}let g=!1;const _=new Map;if(this._nodes=[],p){for(const k of p){let L=LiteGraph.createNode(String(k.type),k.title);L||(LiteGraph.debug&&console.log("Node not found or has errors:",k.type),L=new LGraphNode(""),L.last_serialization=k,L.has_errors=!0,g=!0),L.id=k.id,this.add(L,!0),_.set(L.id,k)}for(const[k,L]of _)(a=this.getNodeById(k))==null||a.configure(L)}if(Array.isArray(t.floatingLinks))for(const k of t.floatingLinks){const L=LLink.create(k);this.addFloatingLink(L),L.id>I(this,Wt)&&U(this,Wt,L.id)}for(const k of this.reroutes.values())k.validateLinks(this._links,this.floatingLinks)||this.reroutes.delete(k.id);this._groups.length=0;const m=t.groups;if(m)for(const k of m){const L=new LiteGraph.LGraphGroup;L.configure(k),this.add(L)}this.updateExecutionOrder(),(l=this.onConfigure)==null||l.call(this,t),this._version++;const{primaryCanvas:y}=this,w=(h=y==null?void 0:y.subgraph)==null?void 0:h.id;if(w){const k=this.subgraphs.get(w);k?y.setGraph(k):y.setGraph(this)}return this.setDirtyCanvas(!0,!0),g}finally{this.events.dispatch("configured")}}get primaryCanvas(){return I(this.rootGraph,we)}set primaryCanvas(t){U(this.rootGraph,we,t)}load(t,i){const s=this;if(t instanceof Blob||t instanceof File){const o=new FileReader;o.addEventListener("load",function(r){var h;const a=stringOrEmpty((h=r.target)==null?void 0:h.result),l=JSON.parse(a);s.configure(l),i==null||i()}),o.readAsText(t);return}const n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.addEventListener("load",function(){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}const o=JSON.parse(n.response);s.configure(o),i==null||i()}),n.addEventListener("error",o=>{console.error("Error loading graph:",o)})}};Wt=new WeakMap,Mt=new WeakMap,Be=new WeakMap,ze=new WeakSet,zi=function(){var i,s;const t=(s=(i=this.list_of_graphcanvas)==null?void 0:i.at(0))==null?void 0:s.ds;if(t)return{scale:t.scale,offset:t.offset}},we=new WeakMap,d(at,"serialisedSchemaVersion",1),d(at,"STATUS_STOPPED",1),d(at,"STATUS_RUNNING",2),d(at,"ConfigureProperties",new Set(["nodes","groups","links","state","reroutes","floatingLinks","id","subgraphs","definitions","inputs","outputs","widgets","inputNode","outputNode","extra"]));let LGraph=at;const Ve=class Ve extends LGraph{constructor(i,s){if(!i)throw new Error("Root graph is required");super();P(this,Le);d(this,"name","Unnamed Subgraph");d(this,"inputNode",new SubgraphInputNode(this));d(this,"outputNode",new SubgraphOutputNode(this));d(this,"inputs",[]);d(this,"outputs",[]);d(this,"widgets",[]);P(this,ke);U(this,ke,i);const n=structuredClone(s);this._configureBase(n),N(this,Le,di).call(this,n)}get rootGraph(){return I(this,ke)}getIoNodeOnPos(i,s){const{inputNode:n,outputNode:o}=this;if(n.containsPoint([i,s]))return n;if(o.containsPoint([i,s]))return o}configure(i,s){const n=super.configure(i,s);return N(this,Le,di).call(this,i),n}attachCanvas(i){super.attachCanvas(i),i.subgraph=this}addInput(i,s){this.events.dispatch("adding-input",{name:i,type:s});const n=new SubgraphInput({id:createUuidv4(),name:i,type:s},this.inputNode);return this.inputs.push(n),this.events.dispatch("input-added",{input:n}),n}addOutput(i,s){this.events.dispatch("adding-output",{name:i,type:s});const n=new SubgraphOutput({id:createUuidv4(),name:i,type:s},this.outputNode);return this.outputs.push(n),this.events.dispatch("output-added",{output:n}),n}renameInput(i,s){const n=this.inputs.indexOf(i);if(n===-1)throw new Error("Input not found");const o=i.displayName;this.events.dispatch("renaming-input",{input:i,index:n,oldName:o,newName:s}),i.label=s}renameOutput(i,s){const n=this.outputs.indexOf(i);if(n===-1)throw new Error("Output not found");const o=i.displayName;this.events.dispatch("renaming-output",{output:i,index:n,oldName:o,newName:s}),i.label=s}removeInput(i){i.disconnect();const s=this.inputs.indexOf(i);if(s===-1)throw new Error("Input not found");if(!this.events.dispatch("removing-input",{input:i,index:s}))return;this.inputs.splice(s,1);const{length:o}=this.inputs;for(let r=s;r<o;r++)this.inputs[r].decrementSlots("inputs")}removeOutput(i){i.disconnect();const s=this.outputs.indexOf(i);if(s===-1)throw new Error("Output not found");if(!this.events.dispatch("removing-output",{output:i,index:s}))return;this.outputs.splice(s,1);const{length:o}=this.outputs;for(let r=s;r<o;r++)this.outputs[r].decrementSlots("outputs")}draw(i,s,n,o){this.inputNode.draw(i,s,n,o),this.outputNode.draw(i,s,n,o)}clone(i=!1){const s=this.asSerialisable();i||(s.id=createUuidv4());const n=new Ve(this.rootGraph,s);return n.configure(s),n}asSerialisable(){return{id:this.id,version:LGraph.serialisedSchemaVersion,state:this.state,revision:this.revision,config:this.config,name:this.name,inputNode:this.inputNode.asSerialisable(),outputNode:this.outputNode.asSerialisable(),inputs:this.inputs.map(i=>i.asSerialisable()),outputs:this.outputs.map(i=>i.asSerialisable()),widgets:[...this.widgets],nodes:this.nodes.map(i=>i.serialize()),groups:this.groups.map(i=>i.serialize()),links:[...this.links.values()].map(i=>i.asSerialisable()),extra:this.extra}}};ke=new WeakMap,Le=new WeakSet,di=function(i){const{name:s,inputs:n,outputs:o,widgets:r}=i;if(this.name=s,n){this.inputs.length=0;for(const a of n){const l=new SubgraphInput(a,this.inputNode);this.inputs.push(l),this.events.dispatch("input-added",{input:l})}}if(o){this.outputs.length=0;for(const a of o)this.outputs.push(new SubgraphOutput(a,this.outputNode))}if(r){this.widgets.length=0;for(const a of r)this.widgets.push(a)}this.inputNode.configure(i.inputNode),this.outputNode.configure(i.outputNode)},d(Ve,"MAX_NESTED_SUBGRAPHS",1e3);let Subgraph=Ve;class InputIndicators{constructor(t){d(this,"radius",8);d(this,"startAngle",0);d(this,"endAngle",Math.PI*2);d(this,"inactiveColour","#ffffff10");d(this,"colour1","#ff5f00");d(this,"colour2","#00ff7c");d(this,"colour3","#dea7ff");d(this,"fontString","bold 12px Arial");d(this,"enabled",!0);d(this,"shiftDown",!1);d(this,"undoDown",!1);d(this,"redoDown",!1);d(this,"ctrlDown",!1);d(this,"altDown",!1);d(this,"mouse0Down",!1);d(this,"mouse1Down",!1);d(this,"mouse2Down",!1);d(this,"x",0);d(this,"y",0);d(this,"controller");P(this,Se,this.onPointerDownOrMove.bind(this));P(this,He,this.onPointerUp.bind(this));P(this,Ie,this.onKeyDownOrUp.bind(this));this.canvas=t,this.controller=new AbortController;const{signal:i}=this.controller,s=t.canvas,n={capture:!0,signal:i};s.addEventListener("pointerdown",I(this,Se),n),s.addEventListener("pointermove",I(this,Se),n),s.addEventListener("pointerup",I(this,He),n),s.addEventListener("keydown",I(this,Ie),n),document.addEventListener("keyup",I(this,Ie),n);const o=t.drawFrontCanvas.bind(t);i.addEventListener("abort",()=>{t.drawFrontCanvas=o}),t.drawFrontCanvas=()=>{o(),this.draw()}}onPointerDownOrMove(t){this.mouse0Down=(t.buttons&1)===1,this.mouse1Down=(t.buttons&4)===4,this.mouse2Down=(t.buttons&2)===2,this.x=t.clientX,this.y=t.clientY,this.canvas.setDirty(!0)}onPointerUp(){this.mouse0Down=!1,this.mouse1Down=!1,this.mouse2Down=!1}onKeyDownOrUp(t){this.ctrlDown=t.ctrlKey,this.altDown=t.altKey,this.shiftDown=t.shiftKey,this.undoDown=t.ctrlKey&&t.code==="KeyZ"&&t.type==="keydown",this.redoDown=t.ctrlKey&&t.code==="KeyY"&&t.type==="keydown"}draw(){const{canvas:{ctx:t},radius:i,startAngle:s,endAngle:n,x:o,y:r,inactiveColour:a,colour1:l,colour2:h,colour3:c,fontString:p}=this,{fillStyle:f,font:g}=t,_=o,m=r-80,y=_,w=m-15;t.font=p,S(y+0,w,"Shift",this.shiftDown?l:a),S(y+45,w+20,"Alt",this.altDown?h:a),S(y+30,w,"Control",this.ctrlDown?c:a),S(y-30,w,"â†©ï¸",this.undoDown?"#000":"transparent"),S(y+45,w,"â†ªï¸",this.redoDown?"#000":"transparent"),t.beginPath(),G(_,m),G(_+15,m),G(_+30,m),t.fillStyle=a,t.fill();const k=this.mouse0Down?l:a,L=this.mouse1Down?h:a,E=this.mouse2Down?c:a;this.mouse0Down&&T(_,m,k),this.mouse1Down&&T(_+15,m,L),this.mouse2Down&&T(_+30,m,E),t.fillStyle=f,t.font=g;function S(D,C,R,A){t.fillStyle=A,t.fillText(R,D,C)}function T(D,C,R){t.beginPath(),t.fillStyle=R,G(D,C),t.fill()}function G(D,C){t.arc(D,C,i,s,n)}}dispose(){var t;(t=this.controller)==null||t.abort(),this.controller=void 0}[Symbol.dispose](){this.dispose()}}Se=new WeakMap,He=new WeakMap,Ie=new WeakMap;class ContextMenu{constructor(t,i){d(this,"options");d(this,"parentMenu");d(this,"root");d(this,"current_submenu");d(this,"lock");d(this,"controller",new AbortController);var g,_,m;i||(i={}),this.options=i;const s=i.parentMenu;s&&(s instanceof ContextMenu?(this.parentMenu=s,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this):(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=void 0),((g=s.options)==null?void 0:g.className)==="dark"&&(i.className="dark"));const n=i.event?i.event.constructor.name:null;n!=="MouseEvent"&&n!=="CustomEvent"&&n!=="PointerEvent"&&(console.error(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${n})`),i.event=void 0);const o=document.createElement("div");let r="litegraph litecontextmenu litemenubar-panel";i.className&&(r+=` ${i.className}`),o.className=r,o.style.minWidth="100",o.style.minHeight="100";const{signal:a}=this.controller,l={capture:!0,signal:a};if(this.parentMenu||document.addEventListener("pointerdown",y=>{y.target instanceof Node&&!this.containsNode(y.target)&&this.close()},l),o.addEventListener("pointerup",y=>y.preventDefault(),l),o.addEventListener("contextmenu",y=>{y.button===2&&y.preventDefault()},l),o.addEventListener("pointerdown",y=>{y.button==2&&(this.close(),y.preventDefault())},l),this.root=o,i.title){const y=document.createElement("div");y.className="litemenu-title",y.innerHTML=i.title,o.append(y)}for(let y=0;y<t.length;y++){const w=t[y];let k=Array.isArray(t)?w:String(y);typeof k!="string"&&(k=k!=null?k.content===void 0?String(k):k.content:k),this.addItem(k,w,i)}const c=((m=(_=i.event)==null?void 0:_.target)==null?void 0:m.ownerDocument)||document;c.fullscreenElement?c.fullscreenElement.append(o):c.body.append(o);let p=i.left||0,f=i.top||0;if(i.event){if(p=i.event.clientX-10,f=i.event.clientY-10,i.title&&(f-=20),s){const k=s.root.getBoundingClientRect();p=k.left+k.width}const y=document.body.getBoundingClientRect(),w=o.getBoundingClientRect();y.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),y.width&&p>y.width-w.width-10&&(p=y.width-w.width-10),y.height&&f>y.height-w.height-10&&(f=y.height-w.height-10)}o.style.left=`${p}px`,o.style.top=`${f}px`,LiteGraph.context_menu_scaling&&i.scale&&(o.style.transform=`scale(${Math.round(i.scale*4)*.25})`)}containsNode(t,i=new Set){var s;return i.has(this)?!1:(i.add(this),((s=this.current_submenu)==null?void 0:s.containsNode(t,i))||this.root.contains(t))}addItem(t,i,s){s||(s={});const n=document.createElement("div");n.className="litemenu-entry submenu";let o=!1;if(i===null)n.classList.add("separator");else{const c=t===null?"":String(t);typeof i=="string"?n.innerHTML=c:(n.innerHTML=(i==null?void 0:i.title)??c,i.disabled&&(o=!0,n.classList.add("disabled"),n.setAttribute("aria-disabled","true")),(i.submenu||i.has_submenu)&&(n.classList.add("has_submenu"),n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false")),i.className&&(n.className+=` ${i.className}`)),n.value=i,n.setAttribute("role","menuitem"),typeof i=="function"?(n.dataset.value=String(t),n.onclick_callback=i):n.dataset.value=String(i)}this.root.append(n),o||n.addEventListener("click",h),!o&&s.autoopen&&n.addEventListener("pointerenter",a);const r=()=>{const c=this.root.querySelectorAll("div.litemenu-entry.has_submenu");if(c)for(const p of c)p.setAttribute("aria-expanded","false");n.setAttribute("aria-expanded","true")};function a(c){const p=this.value;!p||!p.has_submenu||(h.call(this,c),r())}const l=this;function h(c){var g;const p=this.value;let f=!0;if((g=l.current_submenu)==null||g.close(c),(p!=null&&p.has_submenu||p!=null&&p.submenu)&&r(),s.callback&&s.callback.call(this,p,s,c,l,s.node)===!0&&(f=!1),typeof p=="object"&&(p.callback&&!s.ignore_item_callbacks&&p.disabled!==!0&&p.callback.call(this,p,s,c,l,s.extra)===!0&&(f=!1),p.submenu)){if(!p.submenu.options)throw"ContextMenu submenu needs options";new l.constructor(p.submenu.options,{callback:p.submenu.callback,event:c,parentMenu:l,ignore_item_callbacks:p.submenu.ignore_item_callbacks,title:p.submenu.title,extra:p.submenu.extra,autoopen:s.autoopen}),f=!1}f&&!l.lock&&l.close()}return n}close(t,i){var s;this.controller.abort(),this.root.remove(),this.parentMenu&&!i&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=void 0,t===void 0?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,`${LiteGraph.pointerevents_method}leave`,t)),(s=this.current_submenu)==null||s.close(t,!0)}static trigger(t,i,s){const n=document.createEvent("CustomEvent");return n.initCustomEvent(i,!0,!0,s),t.dispatchEvent&&t.dispatchEvent(n),n}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(t,i){const s=t.clientX,n=t.clientY,o=i.getBoundingClientRect();return o?n>o.top&&n<o.top+o.height&&s>o.left&&s<o.left+o.width:!1}}class CurveEditor{constructor(t){d(this,"points");d(this,"selected");d(this,"nearest");d(this,"size");d(this,"must_update");d(this,"margin");d(this,"_nearest");this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}static sampleCurve(t,i){if(i){for(let s=0;s<i.length-1;++s){const n=i[s],o=i[s+1];if(o[0]<t)continue;const r=o[0]-n[0];if(Math.abs(r)<1e-5)return n[1];const a=(t-n[0])/r;return n[1]*(1-a)+o[1]*a}return 0}}draw(t,i,s,n,o,r=!1){const a=this.points;if(!a)return;this.size=i;const l=i[0]-this.margin*2,h=i[1]-this.margin*2;o=o||"#666",t.save(),t.translate(this.margin,this.margin),n&&(t.fillStyle="#111",t.fillRect(0,0,l,h),t.fillStyle="#222",t.fillRect(l*.5,0,1,h),t.strokeStyle="#333",t.strokeRect(0,0,l,h)),t.strokeStyle=o,r&&(t.globalAlpha=.5),t.beginPath();for(const c of a)t.lineTo(c[0]*l,(1-c[1])*h);if(t.stroke(),t.globalAlpha=1,!r)for(const[c,p]of a.entries())t.fillStyle=this.selected==c?"#FFF":this.nearest==c?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*l,(1-p[1])*h,2,0,Math.PI*2),t.fill();t.restore()}onMouseDown(t,i){const s=this.points;if(!s||t[1]<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const n=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=t[0]-this.margin,a=t[1]-this.margin,l=[r,a],h=30/i.ds.scale;if(this.selected=this.getCloserPoint(l,h),this.selected==-1){const c=[r/n,1-a/o];s.push(c),s.sort(function(p,f){return p[0]-f[0]}),this.selected=s.indexOf(c),this.must_update=!0}if(this.selected!=-1)return!0}onMouseMove(t,i){const s=this.points;if(!s)return;const n=this.selected;if(n<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const o=(t[0]-this.margin)/(this.size[0]-this.margin*2),r=(t[1]-this.margin)/(this.size[1]-this.margin*2),a=[t[0]-this.margin,t[1]-this.margin],l=30/i.ds.scale;this._nearest=this.getCloserPoint(a,l);const h=s[n];if(h){const c=n==0||n==s.length-1;if(!c&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)){s.splice(n,1),this.selected=-1;return}c?h[0]=n==0?0:1:h[0]=clamp(o,0,1),h[1]=1-clamp(r,0,1),s.sort(function(p,f){return p[0]-f[0]}),this.selected=s.indexOf(h),this.must_update=!0}}onMouseUp(){return this.selected=-1,!1}getCloserPoint(t,i){const s=this.points;if(!s)return-1;if(i=i||30,this.size==null)throw new Error("CurveEditor.size was null or undefined.");const n=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=s.length,a=[0,0];let l=1e6,h=-1;for(let c=0;c<r;++c){const p=s[c];a[0]=p[0]*n,a[1]=(1-p[1])*o;const f=distance(t,a);f>l||f>i||(h=c,l=f)}return h}}class LiteGraphGlobal{constructor(){d(this,"SlotShape",SlotShape);d(this,"SlotDirection",SlotDirection);d(this,"SlotType",SlotType);d(this,"LabelPosition",LabelPosition);d(this,"VERSION",.4);d(this,"CANVAS_GRID_SIZE",10);d(this,"NODE_TITLE_HEIGHT",30);d(this,"NODE_TITLE_TEXT_Y",20);d(this,"NODE_SLOT_HEIGHT",20);d(this,"NODE_WIDGET_HEIGHT",20);d(this,"NODE_WIDTH",140);d(this,"NODE_MIN_WIDTH",50);d(this,"NODE_COLLAPSED_RADIUS",10);d(this,"NODE_COLLAPSED_WIDTH",80);d(this,"NODE_TITLE_COLOR","#999");d(this,"NODE_SELECTED_TITLE_COLOR","#FFF");d(this,"NODE_TEXT_SIZE",14);d(this,"NODE_TEXT_COLOR","#AAA");d(this,"NODE_TEXT_HIGHLIGHT_COLOR","#EEE");d(this,"NODE_SUBTEXT_SIZE",12);d(this,"NODE_DEFAULT_COLOR","#333");d(this,"NODE_DEFAULT_BGCOLOR","#353535");d(this,"NODE_DEFAULT_BOXCOLOR","#666");d(this,"NODE_DEFAULT_SHAPE",RenderShape.ROUND);d(this,"NODE_BOX_OUTLINE_COLOR","#FFF");d(this,"NODE_ERROR_COLOUR","#E00");d(this,"NODE_FONT","Arial");d(this,"DEFAULT_FONT","Arial");d(this,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)");d(this,"DEFAULT_GROUP_FONT",24);d(this,"DEFAULT_GROUP_FONT_SIZE");d(this,"GROUP_FONT","Arial");d(this,"WIDGET_BGCOLOR","#222");d(this,"WIDGET_OUTLINE_COLOR","#666");d(this,"WIDGET_ADVANCED_OUTLINE_COLOR","rgba(56, 139, 253, 0.8)");d(this,"WIDGET_TEXT_COLOR","#DDD");d(this,"WIDGET_SECONDARY_TEXT_COLOR","#999");d(this,"WIDGET_DISABLED_TEXT_COLOR","#666");d(this,"LINK_COLOR","#9A9");d(this,"EVENT_LINK_COLOR","#A86");d(this,"CONNECTING_LINK_COLOR","#AFA");d(this,"MAX_NUMBER_OF_NODES",1e4);d(this,"DEFAULT_POSITION",[100,100]);d(this,"VALID_SHAPES",["default","box","round","card"]);d(this,"ROUND_RADIUS",8);d(this,"BOX_SHAPE",RenderShape.BOX);d(this,"ROUND_SHAPE",RenderShape.ROUND);d(this,"CIRCLE_SHAPE",RenderShape.CIRCLE);d(this,"CARD_SHAPE",RenderShape.CARD);d(this,"ARROW_SHAPE",RenderShape.ARROW);d(this,"GRID_SHAPE",RenderShape.GRID);d(this,"INPUT",NodeSlotType.INPUT);d(this,"OUTPUT",NodeSlotType.OUTPUT);d(this,"EVENT",-1);d(this,"ACTION",-1);d(this,"NODE_MODES",["Always","On Event","Never","On Trigger"]);d(this,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]);d(this,"ALWAYS",LGraphEventMode.ALWAYS);d(this,"ON_EVENT",LGraphEventMode.ON_EVENT);d(this,"NEVER",LGraphEventMode.NEVER);d(this,"ON_TRIGGER",LGraphEventMode.ON_TRIGGER);d(this,"UP",LinkDirection.UP);d(this,"DOWN",LinkDirection.DOWN);d(this,"LEFT",LinkDirection.LEFT);d(this,"RIGHT",LinkDirection.RIGHT);d(this,"CENTER",LinkDirection.CENTER);d(this,"LINK_RENDER_MODES",["Straight","Linear","Spline"]);d(this,"HIDDEN_LINK",LinkRenderType.HIDDEN_LINK);d(this,"STRAIGHT_LINK",LinkRenderType.STRAIGHT_LINK);d(this,"LINEAR_LINK",LinkRenderType.LINEAR_LINK);d(this,"SPLINE_LINK",LinkRenderType.SPLINE_LINK);d(this,"NORMAL_TITLE",TitleMode.NORMAL_TITLE);d(this,"NO_TITLE",TitleMode.NO_TITLE);d(this,"TRANSPARENT_TITLE",TitleMode.TRANSPARENT_TITLE);d(this,"AUTOHIDE_TITLE",TitleMode.AUTOHIDE_TITLE);d(this,"VERTICAL_LAYOUT","vertical");d(this,"proxy",null);d(this,"node_images_path","");d(this,"debug",!1);d(this,"catch_exceptions",!0);d(this,"throw_errors",!0);d(this,"allow_scripts",!1);d(this,"registered_node_types",{});d(this,"node_types_by_file_extension",{});d(this,"Nodes",{});d(this,"Globals",{});d(this,"searchbox_extras",{});d(this,"node_box_coloured_when_on",!1);d(this,"node_box_coloured_by_mode",!1);d(this,"dialog_close_on_mouse_leave",!1);d(this,"dialog_close_on_mouse_leave_delay",500);d(this,"shift_click_do_break_link_from",!1);d(this,"click_do_break_link_to",!1);d(this,"ctrl_alt_click_do_break_link",!0);d(this,"snaps_for_comfy",!0);d(this,"snap_highlights_node",!0);d(this,"alwaysSnapToGrid");d(this,"snapToGrid");d(this,"search_hide_on_mouse_leave",!0);d(this,"search_filter_enabled",!1);d(this,"search_show_all_on_open",!0);d(this,"auto_load_slot_types",!1);d(this,"registered_slot_in_types",{});d(this,"registered_slot_out_types",{});d(this,"slot_types_in",[]);d(this,"slot_types_out",[]);d(this,"slot_types_default_in",{});d(this,"slot_types_default_out",{});d(this,"alt_drag_do_clone_nodes",!1);d(this,"do_add_triggers_slots",!1);d(this,"allow_multi_output_for_events",!0);d(this,"middle_click_slot_add_default_node",!1);d(this,"release_link_on_empty_shows_menu",!1);d(this,"pointerevents_method","pointer");d(this,"ctrl_shift_v_paste_connect_unselected_outputs",!0);d(this,"use_uuids",!1);d(this,"highlight_selected_group",!0);d(this,"context_menu_scaling",!1);d(this,"alwaysRepeatWarnings",!1);d(this,"onDeprecationWarning",[console.warn]);d(this,"macTrackpadGestures",!1);d(this,"macGesturesRequireMac",!0);d(this,"canvasNavigationMode","legacy");d(this,"truncateWidgetTextEvenly",!1);d(this,"truncateWidgetValuesFirst",!1);d(this,"saveViewportWithGraph",!0);d(this,"LGraph",LGraph);d(this,"LLink",LLink);d(this,"LGraphNode",LGraphNode);d(this,"LGraphGroup",LGraphGroup);d(this,"DragAndScale",DragAndScale);d(this,"LGraphCanvas",LGraphCanvas);d(this,"ContextMenu",ContextMenu);d(this,"CurveEditor",CurveEditor);d(this,"Reroute",Reroute);d(this,"Classes",{get SubgraphSlot(){return SubgraphSlot},get SubgraphIONodeBase(){return SubgraphIONodeBase},get Rectangle(){return Rectangle},get InputIndicators(){return InputIndicators}});d(this,"uuidv4",createUuidv4);d(this,"distance",distance);d(this,"isInsideRectangle",isInsideRectangle);d(this,"overlapBounding",overlapBounding);Object.defineProperty(this,"Classes",{writable:!1})}registerNodeType(t,i){var r,a,l;if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,this.debug&&console.log("Node registered:",t);const s=i.name,n=t.lastIndexOf("/");i.category=t.substring(0,n),i.title||(i.title=s);for(const h in LGraphNode.prototype)(r=i.prototype)[h]||(r[h]=LGraphNode.prototype[h]);const o=this.registered_node_types[t];o&&this.debug&&console.log("replacing node type:",t),this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[s]=i),(a=this.onNodeTypeRegistered)==null||a.call(this,t,i),o&&((l=this.onNodeTypeReplaced)==null||l.call(this,t,i,o)),i.prototype.onPropertyChange&&console.warn(`LiteGraph node class ${t} has onPropertyChange method, it must be called onPropertyChanged with d at the end`),this.auto_load_slot_types&&new i(i.title||"tmpnode")}unregisterNodeType(t){const i=typeof t=="string"?this.registered_node_types[t]:t;if(!i)throw`node type not found: ${String(t)}`;delete this.registered_node_types[String(i.type)];const s=i.constructor.name;s&&delete this.Nodes[s]}registerNodeAndSlotType(t,i,s){s||(s=!1);const o=(typeof t=="string"&&this.registered_node_types[t]!=="anonymous"?this.registered_node_types[t]:t).constructor.type;let r=[];typeof i=="string"?r=i.split(","):i==this.EVENT||i==this.ACTION?r=["_event_"]:r=["*"];for(let a of r){a===""&&(a="*");const l=s?this.registered_slot_out_types:this.registered_slot_in_types;l[a]??(l[a]={nodes:[]});const{nodes:h}=l[a];h.includes(o)||h.push(o);const c=s?this.slot_types_out:this.slot_types_in,p=a.toLowerCase();c.includes(p)||(c.push(p),c.sort())}}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}createNode(t,i,s){var r;const n=this.registered_node_types[t];if(!n)return this.debug&&console.log(`GraphNode type "${t}" not registered.`),null;i=i||n.title||t;let o=null;if(this.catch_exceptions)try{o=new n(i)}catch(a){return console.error(a),null}else o=new n(i);if(o.type=t,!o.title&&i&&(o.title=i),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=[this.DEFAULT_POSITION[0],this.DEFAULT_POSITION[1]]),o.mode||(o.mode=LGraphEventMode.ALWAYS),s)for(const a in s)o[a]=s[a];return(r=o.onNodeCreated)==null||r.call(o),o}getNodeType(t){return this.registered_node_types[t]}getNodeTypesInCategory(t,i){const s=[];for(const n in this.registered_node_types){const o=this.registered_node_types[n];o.filter==i&&(t==""?o.category==null&&s.push(o):o.category==t&&s.push(o))}return s}getNodeTypesCategories(t){const i={"":1};for(const n in this.registered_node_types){const o=this.registered_node_types[n];if(o.category&&!o.skip_list){if(o.filter!=t)continue;i[o.category]=1}}const s=[];for(const n in i)s.push(n);return s}reloadNodes(t){const i=document.getElementsByTagName("script"),s=[];for(const o of i)s.push(o);const n=document.getElementsByTagName("head")[0];t=document.location.href+t;for(const o of s){const r=o.src;if(!(!r||r.substr(0,t.length)!=t))try{this.debug&&console.log("Reloading:",r);const a=document.createElement("script");a.type="text/javascript",a.src=r,n.append(a),o.remove()}catch(a){if(this.throw_errors)throw a;this.debug&&console.log("Error while reloading",r)}}this.debug&&console.log("Nodes reloaded")}cloneObject(t,i){if(t==null)return null;const s=JSON.parse(JSON.stringify(t));if(!i)return s;for(const n in s)i[n]=s[n];return i}isValidConnection(t,i){if((t==""||t==="*")&&(t=0),(i==""||i==="*")&&(i=0),!t||!i||t==i||t==this.EVENT&&i==this.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),!t.includes(",")&&!i.includes(","))return t==i;const s=t.split(","),n=i.split(",");for(const o of s)for(const r of n)if(this.isValidConnection(o,r))return!0;return!1}getParameterNames(t){return String(t).replaceAll(/\/\/.*$/gm,"").replaceAll(/\s+/g,"").replaceAll(/\/\*[^*/]*\*\//g,"").split("){",1)[0].replace(/^[^(]*\(/,"").replaceAll(/=[^,]+/g,"").split(",").filter(Boolean)}pointerListenerAdd(t,i,s,n=!1){if(!t||!t.addEventListener||!i||typeof s!="function")return;let o=this.pointerevents_method,r=i;if(o=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log(`Converting pointer[${r}] : down move up cancel enter TO touchstart touchmove touchend, etc ..`),r){case"down":{o="touch",r="start";break}case"move":{o="touch";break}case"up":{o="touch",r="end";break}case"cancel":{o="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn(`PointerEvent not available in this browser ? The event ${r} would not be called`)}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+r,s,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(o!="mouse")return t.addEventListener(o+r,s,n);default:return t.addEventListener(r,s,n)}}pointerListenerRemove(t,i,s,n=!1){if(!(!t||!t.removeEventListener||!i||typeof s!="function"))switch(i){case"down":case"up":case"move":case"over":case"out":case"enter":(this.pointerevents_method=="pointer"||this.pointerevents_method=="mouse")&&t.removeEventListener(this.pointerevents_method+i,s,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(this.pointerevents_method=="pointer")return t.removeEventListener(this.pointerevents_method+i,s,n);default:return t.removeEventListener(i,s,n)}}getTime(){return performance.now()}colorToString(t){return`rgba(${Math.round(t[0]*255).toFixed()},${Math.round(t[1]*255).toFixed()},${Math.round(t[2]*255).toFixed()},${t.length==4?t[3].toFixed(2):"1.0"})`}growBounding(t,i,s){i<t[0]?t[0]=i:i>t[2]&&(t[2]=i),s<t[1]?t[1]=s:s>t[3]&&(t[3]=s)}isInsideBounding(t,i){return!(t[0]<i[0][0]||t[1]<i[0][1]||t[0]>i[1][0]||t[1]>i[1][1])}hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();const i="0123456789ABCDEF",s=new Array(3);let n=0,o,r;for(let a=0;a<6;a+=2)o=i.indexOf(t.charAt(a)),r=i.indexOf(t.charAt(a+1)),s[n]=o*16+r,n++;return s}num2hex(t){const i="0123456789ABCDEF";let s="#",n,o;for(let r=0;r<3;r++)n=t[r]/16,o=t[r]%16,s+=i.charAt(n)+i.charAt(o);return s}closeAllContextMenus(t=window){const i=[...t.document.querySelectorAll(".litecontextmenu")];if(i.length)for(const s of i)"close"in s&&typeof s.close=="function"?s.close():s.remove()}extendClass(t,i){for(const s in i)t.hasOwnProperty(s)||(t[s]=i[s]);if(i.prototype)for(const s in i.prototype)i.prototype.hasOwnProperty(s)&&(t.prototype.hasOwnProperty(s)||(i.prototype.__lookupGetter__(s)?t.prototype.__defineGetter__(s,i.prototype.__lookupGetter__(s)):t.prototype[s]=i.prototype[s],i.prototype.__lookupSetter__(s)&&t.prototype.__defineSetter__(s,i.prototype.__lookupSetter__(s))))}}Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("Symbol.asyncDispose"));function loadPolyfills(){typeof window<"u"&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(u,t,i,s,n,o){let r=0,a=0,l=0,h=0;if(n===0){this.rect(u,t,i,s);return}if(o===void 0&&(o=n),Array.isArray(n))if(n.length==1)r=a=l=h=n[0];else if(n.length==2)r=h=n[0],a=l=n[1];else if(n.length==4)r=n[0],a=n[1],l=n[2],h=n[3];else return;else{r=n||0,a=n||0;const c=!Array.isArray(o)&&o?o:0;l=c,h=c}this.moveTo(u+r,t),this.lineTo(u+i-a,t),this.quadraticCurveTo(u+i,t,u+i,t+a),this.lineTo(u+i,t+s-h),this.quadraticCurveTo(u+i,t+s,u+i-h,t+s),this.lineTo(u+h,t+s),this.quadraticCurveTo(u,t+s,u,t+s-l),this.lineTo(u,t+l),this.quadraticCurveTo(u,t,u+r,t)}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setTimeout(u,1e3/60)})}class InvalidLinkError extends Error{constructor(t="Attempted to access a link that was invalid.",i){super(t,{cause:i}),this.name="InvalidLinkError"}}class RecursionError extends Error{constructor(t){super(t),this.name="RecursionError"}}class SlotIndexError extends Error{constructor(t="Attempted to access a slot that was out of bounds.",i){super(t,{cause:i}),this.name="SlotIndexError"}}class ExecutableNodeDTO{constructor(t,i,s,n){P(this,Ue);d(this,"graph");d(this,"inputs");P(this,Ee);if(this.node=t,this.subgraphNodePath=i,this.nodesByExecutionId=s,this.subgraphNode=n,!t.graph)throw new NullGraphError;U(this,Ee,[...this.subgraphNodePath,this.node.id].join(":")),this.graph=t.graph,this.inputs=this.node.inputs.map(o=>({linkId:o.link,name:o.name,type:o.type})),this.node.applyToGraph&&(this.applyToGraph=(...o)=>{var r,a;return(a=(r=this.node).applyToGraph)==null?void 0:a.call(r,...o)})}get id(){return I(this,Ee)}get type(){return this.node.type}get title(){return this.node.title}get mode(){return this.node.mode}get comfyClass(){return this.node.comfyClass}get isVirtualNode(){return this.node.isVirtualNode}get widgets(){return this.node.widgets}get subgraphId(){var t;return(t=this.subgraphNode)==null?void 0:t.subgraph.id}getInnerNodes(){return this.node.isSubgraphNode()?this.node.getInnerNodes(this.nodesByExecutionId,this.subgraphNodePath):[this]}resolveInput(t,i=new Set){var c;const s=`${(c=this.subgraphNode)==null?void 0:c.subgraph.id}:${this.node.id}[I]${t}`;if(i.has(s)){const p=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,f=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving input ${t} of node ${p}${f}. This creates an infinite loop in link resolution. UniqueID: [${s}]`)}i.add(s);const n=this.inputs.at(t);if(!n)throw new SlotIndexError(`No input found for flattened id [${this.id}] slot [${t}]`);if(n.linkId==null)return;const o=this.graph.getLink(n.linkId);if(!o)throw new InvalidLinkError(`No link found in parent graph for id [${this.id}] slot [${t}] ${n.name}`);const{subgraphNode:r}=this;if(r&&o.originIsIoNode){const p=r.inputs.at(o.origin_slot);if(!p)throw new SlotIndexError(`No input found for slot [${o.origin_slot}] ${n.name}`);const f=p.link;if(f==null){const y=r.getWidgetFromSlot(p);return y?{node:this,origin_id:this.id,origin_slot:-1,widgetInfo:{value:y.value}}:void 0}const g=r.graph.getLink(f);if(!g)throw new InvalidLinkError(`No outer link found for slot [${o.origin_slot}] ${n.name}`);const _=this.subgraphNodePath.join(":"),m=this.nodesByExecutionId.get(_);if(!m)throw new Error(`No subgraph node DTO found for id [${_}]`);return m.resolveInput(g.target_slot,i)}const a=this.graph.getNodeById(o.origin_id);if(!a)throw new InvalidLinkError(`No input node found for id [${this.id}] slot [${t}] ${n.name}`);const l=[...this.subgraphNodePath,a.id].join(":"),h=this.nodesByExecutionId.get(l);if(!h)throw new Error(`No output node DTO found for id [${l}]`);return h.resolveOutput(o.origin_slot,n.type,i)}resolveOutput(t,i,s){var r;const n=`${(r=this.subgraphNode)==null?void 0:r.subgraph.id}:${this.node.id}[O]${t}`;if(s.has(n)){const a=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,l=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving output ${t} of node ${a}${l}. This creates an infinite loop in link resolution. UniqueID: [${n}]`)}if(s.add(n),this.mode===LGraphEventMode.BYPASS){const{inputs:a}=this,l=Object.keys(a).map(Number),c=[t,...l].find(p=>{var f;return((f=a[p])==null?void 0:f.type)===i});if(c===void 0){console.debug(`[ExecutableNodeDTO.resolveOutput] No input types match type [${i}] for id [${this.id}] slot [${t}]`,this);return}return this.resolveInput(c,s)}const{node:o}=this;if(o.isSubgraphNode())return N(this,Ue,Vi).call(this,t,i,s);if(o.isVirtualNode){if(this.inputs.at(t))return this.resolveInput(t,s);const a=this.node.getInputLink(t);if(a){const l=this.graph.getNodeById(a.origin_id);if(!l)throw new InvalidLinkError(`Virtual node failed to resolve parent [${this.id}] slot [${t}]`);const h=[...this.subgraphNodePath,l.id].join(":"),c=this.nodesByExecutionId.get(h);if(!c)throw new Error(`No output node DTO found for id [${l.id}]`);return c.resolveOutput(a.origin_slot,i,s)}return}return{node:this,origin_id:this.id,origin_slot:t}}}Ee=new WeakMap,Ue=new WeakSet,Vi=function(t,i,s){const{node:n}=this,o=n.outputs.at(t);if(!o)throw new SlotIndexError(`No output found for flattened id [${this.id}] slot [${t}]`);if(!n.isSubgraphNode())throw new TypeError(`Node is not a subgraph node: ${n.id}`);const r=n.resolveSubgraphOutputLink(t);if(!r)return;const a=r.outputNode;if(!a)throw new Error(`No output node found for id [${this.id}] slot [${t}] ${o.name}`);const l=[...this.subgraphNodePath,n.id,a.id].join(":"),h=this.nodesByExecutionId.get(l);if(!h)throw new Error(`No inner node DTO found for id [${l}]`);return h.resolveOutput(r.link.origin_slot,i,s)};class SubgraphNode extends LGraphNode{constructor(i,s,n){super(s.name,s.id);P(this,Rt);d(this,"type");d(this,"isVirtualNode",!0);d(this,"widgets",[]);P(this,Te,new AbortController);this.graph=i,this.subgraph=s;const o=this.subgraph.events,{signal:r}=I(this,Te);o.addEventListener("input-added",a=>{const l=a.detail.input,{name:h,type:c}=l;if(this.inputs.some(f=>f.name==h))return;const p=this.addInput(h,c);N(this,Rt,hi).call(this,l,p)},{signal:r}),o.addEventListener("removing-input",a=>{const l=a.detail.input._widget;l&&this.ensureWidgetRemoved(l),this.removeInput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("output-added",a=>{const{name:l,type:h}=a.detail.output;this.addOutput(l,h)},{signal:r}),o.addEventListener("removing-output",a=>{this.removeOutput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("renaming-input",a=>{const{index:l,newName:h}=a.detail,c=this.inputs.at(l);if(!c)throw new Error("Subgraph input not found");c.label=h},{signal:r}),o.addEventListener("renaming-output",a=>{const{index:l,newName:h}=a.detail,c=this.outputs.at(l);if(!c)throw new Error("Subgraph output not found");c.label=h},{signal:r}),this.type=s.id,this.configure(n),this.addTitleButton({name:"enter_subgraph",text:"î¤»",yOffset:0,xOffset:-10,fontSize:16})}get rootGraph(){return this.graph.rootGraph}get displayType(){return"Subgraph node"}isSubgraphNode(){return!0}onTitleButtonClick(i,s){i.name==="enter_subgraph"?s.openSubgraph(this.subgraph):super.onTitleButtonClick(i,s)}configure(i){var s;for(const n of this.inputs)(s=n._listenerController)==null||s.abort();this.inputs.length=0,this.inputs.push(...this.subgraph.inputNode.slots.map(n=>new NodeInputSlot({name:n.name,localized_name:n.localized_name,label:n.label,type:n.type,link:null},this))),this.outputs.length=0,this.outputs.push(...this.subgraph.outputNode.slots.map(n=>new NodeOutputSlot({name:n.name,localized_name:n.localized_name,label:n.label,type:n.type,links:null},this))),super.configure(i)}_internalConfigureAfterSlots(){this.widgets.length=0;for(const i of this.inputs){const s=this.subgraph.inputNode.slots.find(n=>n.name===i.name);if(!s)throw new Error(`[SubgraphNode.configure] No subgraph input found for input ${i.name}`);N(this,Rt,hi).call(this,s,i);for(const n of s.linkIds){const o=this.subgraph.getLink(n);if(!o){console.warn(`[SubgraphNode.configure] No link found for link ID ${n}`,this);continue}const r=o.resolve(this.subgraph);if(!r.input||!r.inputNode){console.warn("Invalid resolved link",r,this);continue}const a=r.inputNode.getWidgetFromSlot(r.input);if(a){N(this,Rt,ci).call(this,s,i,a);break}}}}addInput(i,s,n={}){return super.addInput(i,s,n)}getInputLink(i){const s=this.subgraph.outputNode.slots[i].getLinks().at(0);if(!s)return console.warn(`SubgraphNode.getInputLink: no inner link found for slot ${i}`),null;const n=LLink.create(s);return n.origin_id=`${this.id}:${s.origin_id}`,n.origin_slot=s.origin_slot,n}resolveSubgraphInputLinks(i){const s=this.subgraph.inputNode.slots[i],n=s.getLinks();return n.length===0?(console.debug(`[SubgraphNode.resolveSubgraphInputLinks] No inner links found for input slot [${i}] ${s.name}`,this),[]):n.map(o=>o.resolve(this.subgraph))}resolveSubgraphOutputLink(i){const s=this.subgraph.outputNode.slots[i],n=s.getLinks().at(0);if(n)return n.resolve(this.subgraph);console.debug(`[SubgraphNode.resolveSubgraphOutputLink] No inner link found for output slot [${i}] ${s.name}`,this)}getInnerNodes(i,s=[],n=[],o=new Set){if(o.has(this)){const h=`${this.id}${this.title?` (${this.title})`:""}`,c=`'${this.subgraph.name||"Unnamed Subgraph"}'`,p=s.length;throw new RecursionError(`Circular reference detected at depth ${p} in node ${h} of subgraph ${c}. This creates an infinite loop in the subgraph hierarchy.`)}o.add(this);const r=[...s,this.id],a=this.graph.rootGraph.resolveSubgraphIdPath(s).at(-1),l=new ExecutableNodeDTO(this,s,i,a);i.set(l.id,l);for(const h of this.subgraph.nodes)if("getInnerNodes"in h)h.getInnerNodes(i,r,n,new Set(o));else{const c=new ExecutableNodeDTO(h,r,i,this);i.set(c.id,c),n.push(c)}return n}removeWidgetByName(i){const s=this.widgets.find(n=>n.name===i);s&&this.subgraph.events.dispatch("widget-demoted",{widget:s,subgraphNode:this}),super.removeWidgetByName(i)}ensureWidgetRemoved(i){this.widgets.includes(i)&&this.subgraph.events.dispatch("widget-demoted",{widget:i,subgraphNode:this}),super.ensureWidgetRemoved(i)}onRemoved(){var i;I(this,Te).abort();for(const s of this.widgets)this.subgraph.events.dispatch("widget-demoted",{widget:s,subgraphNode:this});for(const s of this.inputs)(i=s._listenerController)==null||i.abort()}}Te=new WeakMap,Rt=new WeakSet,hi=function(i,s){var o;(o=s._listenerController)==null||o.abort(),s._listenerController=new AbortController;const{signal:n}=s._listenerController;i.events.addEventListener("input-connected",()=>{if(s._widget)return;const r=i._widget;r&&N(this,Rt,ci).call(this,i,s,r)},{signal:n}),i.events.addEventListener("input-disconnected",()=>{i.getConnectedWidgets().length>0||(this.removeWidgetByName(s.name),delete s.pos,delete s.widget,s._widget=void 0)},{signal:n})},ci=function(i,s,n){const o=toConcreteWidget(n,this).createCopyForNode(this);Object.assign(o,{get name(){return i.name},set name(r){console.warn("Promoted widget: setting name is not allowed",this,r)},get localized_name(){return i.localized_name},set localized_name(r){console.warn("Promoted widget: setting localized_name is not allowed",this,r)},get label(){return i.label},set label(r){console.warn("Promoted widget: setting label is not allowed",this,r)},get tooltip(){return n.tooltip},set tooltip(r){console.warn("Promoted widget: setting tooltip is not allowed",this,r)}}),this.widgets.push(o),this.subgraph.events.dispatch("widget-promoted",{widget:o,subgraphNode:this}),s.widget={name:i.name},s._widget=o};const LiteGraph=new LiteGraphGlobal;loadPolyfills();const litegraphCss=".lgraphcanvas{user-select:none;-moz-user-select:none;-webkit-user-select:none;outline:none;font-family:Tahoma,sans-serif}.lgraphcanvas *{box-sizing:border-box}.litegraph.litecontextmenu{font-family:Tahoma,sans-serif;position:fixed;top:100px;left:100px;min-width:100px;color:#aaf;padding:0;box-shadow:0 0 10px #000!important;background-color:#2e2e2e!important;z-index:10;max-height:-webkit-fill-available;overflow-y:auto}@supports not (max-height: -webkit-fill-available){.litegraph.litecontextmenu{max-height:80vh;overflow-y:scroll}}.litegraph.litecontextmenu.dark{background-color:#000!important}.litegraph.litecontextmenu .litemenu-title img{margin-top:2px;margin-left:2px;margin-right:4px}.litegraph.litecontextmenu .litemenu-entry{margin:2px;padding:2px}.litegraph.litecontextmenu .litemenu-entry.submenu{background-color:#2e2e2e!important}.litegraph.litecontextmenu.dark .litemenu-entry.submenu{background-color:#000!important}.litegraph .litemenubar ul{font-family:Tahoma,sans-serif;margin:0;padding:0}.litegraph .litemenubar li{font-size:14px;color:#999;display:inline-block;min-width:50px;padding-left:10px;padding-right:10px;user-select:none;-moz-user-select:none;-webkit-user-select:none;cursor:pointer}.litegraph .litemenubar li:hover{background-color:#777;color:#eee}.litegraph .litegraph .litemenubar-panel{position:absolute;top:5px;left:5px;min-width:100px;background-color:#444;box-shadow:0 0 3px #000;padding:4px;border-bottom:2px solid #aaf;z-index:10}.litegraph .litemenu-entry,.litemenu-title{font-size:12px;color:#aaa;margin:2px;padding:0 0 0 2px;-moz-user-select:none;-webkit-user-select:none;user-select:none;cursor:pointer}.litegraph .litemenu-entry .icon{display:inline-block;width:12px;height:12px;margin:2px;vertical-align:top}.litegraph .litemenu-entry.checked .icon{background-color:#aaf}.litegraph .litemenu-entry .more{float:right;padding-right:5px}.litegraph .litemenu-entry.disabled{opacity:.5;cursor:default}.litegraph .litemenu-entry.separator{display:block;border-top:1px solid #333;border-bottom:1px solid #666;width:100%;height:0px;margin:3px 0 2px;background-color:transparent;padding:0!important;cursor:default!important}.litegraph .litemenu-entry.has_submenu{border-right:2px solid cyan}.litegraph .litemenu-title{color:#dde;background-color:#111;margin:0;padding:2px;cursor:default}.litegraph .litemenu-entry:hover:not(.disabled):not(.separator){background-color:#444!important;color:#eee;transition:all .2s}.litegraph .litemenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.litegraph .litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.litegraph.litesearchbox{font-family:Tahoma,sans-serif;position:absolute;background-color:#00000080;padding-top:4px}.litegraph.litesearchbox input,.litegraph.litesearchbox select{margin-top:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;margin-right:5px;max-width:300px}.litegraph.litesearchbox .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.litegraph.litesearchbox .helper{overflow:auto;max-height:200px;margin-top:2px}.litegraph.lite-search-item{font-family:Tahoma,sans-serif;background-color:#00000080;color:#fff;padding-top:2px}.litegraph.lite-search-item.not_in_filter{color:#b99;font-style:italic}.litegraph.lite-search-item.generic_type{color:#999;font-style:italic}.litegraph.lite-search-item:hover,.litegraph.lite-search-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph.lite-search-item-type{display:inline-block;background:#0003;margin-left:5px;font-size:14px;padding:2px 5px;position:relative;top:-2px;opacity:.8;border-radius:4px}.litegraph .dialog{position:absolute;top:50%;left:50%;margin-top:-150px;margin-left:-200px;background-color:#2a2a2a;min-width:400px;min-height:200px;box-shadow:0 0 4px #111;border-radius:6px}.litegraph .dialog.settings{left:10px;top:10px;height:calc(100% - 20px);margin:auto;max-width:50%}.litegraph .dialog.centered{top:50px;left:50%;position:absolute;transform:translate(-50%);min-width:600px;min-height:300px;height:calc(100% - 100px);margin:auto}.litegraph .dialog .close{float:right;margin:4px 10px 4px 4px;cursor:pointer;font-size:1.4em}.litegraph .dialog .close:hover{color:#fff}.litegraph .dialog .dialog-header{color:#aaa;border-bottom:1px solid #161616}.litegraph .dialog .dialog-header{height:40px}.litegraph .dialog .dialog-footer{height:50px;padding:10px;margin:0;border-top:1px solid #1a1a1a}.litegraph .dialog .dialog-header .dialog-title{font:20px Arial;margin:4px;padding:4px 10px;display:inline-block}.litegraph .dialog .dialog-content,.litegraph .dialog .dialog-alt-content{height:calc(100% - 90px);width:100%;min-height:100px;display:inline-block;color:#aaa;overflow:auto}.litegraph .dialog .dialog-content h3{margin:10px}.litegraph .dialog .dialog-content .connections{flex-direction:row}.litegraph .dialog .dialog-content .connections .connections_side{width:calc(50% - 5px);min-height:100px;background-color:#000;display:flex}.litegraph .dialog .node_type{font-size:1.2em;display:block;margin:10px}.litegraph .dialog .node_desc{opacity:.5;display:block;margin:10px}.litegraph .dialog .separator{display:block;width:calc(100% - 4px);height:1px;border-top:1px solid #000;border-bottom:1px solid #333;margin:10px 2px;padding:0}.litegraph .dialog .property{margin-bottom:2px;padding:4px}.litegraph .dialog .property:hover{background:#545454}.litegraph .dialog .property_name{color:#737373;display:inline-block;text-align:left;vertical-align:top;width:160px;padding-left:4px;overflow:hidden;margin-right:6px}.litegraph .dialog .property:hover .property_name{color:#fff}.litegraph .dialog .property_value{display:inline-block;text-align:right;color:#aaa;background-color:#1a1a1a;max-width:calc(100% - 162px);min-width:200px;max-height:300px;min-height:20px;padding:4px 12px 4px 4px;overflow:hidden;cursor:pointer;border-radius:3px}.litegraph .dialog .property_value:hover{color:#fff}.litegraph .dialog .property.boolean .property_value{padding-right:30px;color:#a88}.litegraph .dialog .property.boolean.bool-on .property_name,.litegraph .dialog .property.boolean.bool-on .property_value{color:#8a8}.litegraph .dialog .btn{border:0;border-radius:4px;padding:4px 20px;margin-left:0;background-color:#060606;color:#8e8e8e}.litegraph .dialog .btn:hover{background-color:#111;color:#fff}.litegraph .dialog .btn.delete:hover{background-color:#f33;color:#000}.litegraph .bullet_icon{margin-left:10px;border-radius:10px;width:12px;height:12px;background-color:#666;display:inline-block;margin-top:2px;margin-right:4px;transition:background-color .1s ease 0s;-moz-transition:background-color .1s ease 0s}.litegraph .bullet_icon:hover{background-color:#698;cursor:pointer}.graphcontextmenu{padding:4px;min-width:100px}.graphcontextmenu-title{color:#dde;background-color:#222;margin:0;padding:2px;cursor:default}.graphmenu-entry{box-sizing:border-box;margin:2px;padding-left:20px;user-select:none;-moz-user-select:none;-webkit-user-select:none;transition:all linear .3s}.graphmenu-entry.event,.litemenu-entry.event{border-left:8px solid orange;padding-left:12px}.graphmenu-entry.disabled{opacity:.3}.graphmenu-entry.submenu{border-right:2px solid #eee}.graphmenu-entry:hover{background-color:#555}.graphmenu-entry.separator{background-color:#111;border-bottom:1px solid #666;height:1px;width:calc(100% - 20px);-moz-width:calc(100% - 20px);-webkit-width:calc(100% - 20px)}.graphmenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.graphmenu-entry .property_value,.litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.graphdialog{position:absolute;top:10px;left:10px;min-height:2em;background-color:#333;font-size:1.2em;box-shadow:0 0 10px #000!important;z-index:10}.graphdialog.rounded{border-radius:12px;padding-right:2px}.graphdialog .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.graphdialog input,.graphdialog textarea,.graphdialog select{margin:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;outline:none}.graphdialog textarea{min-height:150px}.graphdialog button{margin-top:3px;vertical-align:top;background-color:#999;border:0}.graphdialog button.rounded,.graphdialog input.rounded{border-radius:0 12px 12px 0}.graphdialog .helper{overflow:auto;max-height:200px}.graphdialog .help-item{padding-left:10px}.graphdialog .help-item:hover,.graphdialog .help-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph .dialog{min-height:0}.litegraph .dialog .dialog-content{display:block}.litegraph .graphdialog{display:flex;align-items:center;border-radius:20px;padding:4px 10px;position:fixed}.litegraph .graphdialog .name{padding:0;min-height:0;font-size:16px;vertical-align:middle}.litegraph .graphdialog .value{font-size:16px;min-height:0;margin:0 10px;padding:2px 5px}.litegraph .graphdialog input[type=checkbox]{width:16px;height:16px}.litegraph .graphdialog button{padding:4px 18px;border-radius:20px;cursor:pointer}";let registered=!1,_datasetInfo={dataset_name:"",fields:[],label_fields:[],patches_fields:[],detection_fields:[],classification_fields:[],segmentation_fields:[],regression_fields:[],saved_views:[],tags:[],label_classes:{},brain_runs:[],evaluations:[],zoo_models:[]};function setDatasetInfo(u){_datasetInfo=u,updateNodeVisibility()}function populateNodeCombos(u){var i;if(!u.widgets)return;const t=u.type||"";for(const s of u.widgets){if(s.type!=="combo")continue;const n=s.name||"";n==="view_name"&&t.includes("Source/")?s.options.values=_datasetInfo.saved_views.length>0?_datasetInfo.saved_views:["(no saved views)"]:n==="field"&&t.includes("To Patches")?s.options.values=_datasetInfo.patches_fields.length>0?_datasetInfo.patches_fields:["(no patchable fields)"]:n==="field"&&(t.includes("Filter Labels")||t.includes("Match Labels")||t.includes("Map Labels"))?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:(n==="pred_field"||n==="label_field"||n==="predictions_field")&&t.includes("Brain/")?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:n==="model"&&t.includes("Model/")?s.options.values=_datasetInfo.zoo_models.length>0?_datasetInfo.zoo_models:["(no models available)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Detections")?s.options.values=_datasetInfo.detection_fields.length>0?_datasetInfo.detection_fields:["(no detection fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Classifications")?s.options.values=_datasetInfo.classification_fields.length>0?_datasetInfo.classification_fields:["(no classification fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Segmentations")?s.options.values=_datasetInfo.segmentation_fields.length>0?_datasetInfo.segmentation_fields:["(no segmentation fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Regressions")?s.options.values=_datasetInfo.regression_fields.length>0?_datasetInfo.regression_fields:["(no regression fields)"]:n==="eval_key"&&(t.includes("Manage Evaluation")||t.includes("To Evaluation Patches"))?s.options.values=_datasetInfo.evaluations.length>0?_datasetInfo.evaluations:["(no evaluations)"]:n==="brain_key"&&t.includes("Manage Brain Run")?s.options.values=_datasetInfo.brain_runs.length>0?_datasetInfo.brain_runs:["(no brain runs)"]:n==="field"&&t.includes("Compute BBox Area")?s.options.values=_datasetInfo.detection_fields.length>0?_datasetInfo.detection_fields:["(no detection fields)"]:n==="field"&&t.includes("Filter Keypoints")?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:n==="field"&&(s.options.values=_datasetInfo.fields.length>0?_datasetInfo.fields:["(no fields)"])}if(t.includes("Filter Labels")||t.includes("Match Labels")){const s=((i=u.properties)==null?void 0:i.field)||"",n=_datasetInfo.label_classes[s];n&&n.length>0&&(u.properties._available_classes=n)}}function updateAllComboWidgets(u){const t=u._nodes;if(t)for(const i of t)populateNodeCombos(i)}const NODE_VISIBILITY_RULES={"FiftyComfy/Source/Load Saved View":u=>u.saved_views.length===0,"FiftyComfy/View Stages/To Patches":u=>u.patches_fields.length===0,"FiftyComfy/View Stages/Filter Labels":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Match Labels":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Map Labels":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Filter Keypoints":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Select Labels":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Exclude Labels":u=>u.label_fields.length===0,"FiftyComfy/View Stages/Compute BBox Area":u=>u.detection_fields.length===0,"FiftyComfy/Brain/Compute Mistakenness":u=>u.label_fields.length===0,"FiftyComfy/Brain/Compute Hardness":u=>u.label_fields.length===0,"FiftyComfy/Brain/Manage Brain Run":u=>u.brain_runs.length===0,"FiftyComfy/View Stages/Sort By Similarity":u=>u.brain_runs.length===0,"FiftyComfy/Evaluation/Evaluate Detections":u=>u.detection_fields.length===0,"FiftyComfy/Evaluation/Evaluate Classifications":u=>u.classification_fields.length===0,"FiftyComfy/Evaluation/Evaluate Segmentations":u=>u.segmentation_fields.length===0,"FiftyComfy/Evaluation/Evaluate Regressions":u=>u.regression_fields.length===0,"FiftyComfy/Evaluation/Manage Evaluation":u=>u.evaluations.length===0,"FiftyComfy/Evaluation/To Evaluation Patches":u=>u.evaluations.length===0};let _hiddenNodeTypes=new Set;function updateNodeVisibility(){_hiddenNodeTypes.clear();for(const[u,t]of Object.entries(NODE_VISIBILITY_RULES)){const i=LiteGraph.registered_node_types[u];if(!i)continue;const s=t(_datasetInfo);i.skip_list=s,s&&_hiddenNodeTypes.add(u)}}function installSearchFilter(u){u.onSearchBox=function(t,i,s){const n=(i||"").toLowerCase(),o=[],r=LiteGraph.registered_node_types;for(const a in r){if(_hiddenNodeTypes.has(a))continue;const h=r[a].title||"";n&&!a.toLowerCase().includes(n)&&!h.toLowerCase().includes(n)||o.push(a)}return o.sort((a,l)=>{var p,f;const h=(((p=r[a])==null?void 0:p.title)||a).toLowerCase(),c=(((f=r[l])==null?void 0:f.title)||l).toLowerCase();return h.localeCompare(c)}),o}}function hookNodeAdded(u){const t=u.onNodeAdded;u.onNodeAdded=function(i){populateNodeCombos(i),t&&t.call(this,i)}}function registerAllNodes(){if(registered)return;registered=!0;class u extends LGraphNode{constructor(){super(),this.title="Current Dataset",this.addOutput("view","FO_VIEW"),this.properties={},this.size=[240,60],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(b){var J;if((J=this.flags)!=null&&J.collapsed)return;const it=_datasetInfo.dataset_name;if(it){b.font="bold 13px monospace",b.fillStyle="#FFFFFF",b.textAlign="center";const st=this.size[0]-20;let Q=it;for(;b.measureText(Q).width>st&&Q.length>4;)Q=Q.slice(0,-2);Q!==it&&(Q+="â€¦"),b.fillText(Q,this.size[0]/2,this.size[1]-12)}}}d(u,"title","Current Dataset"),d(u,"desc","Use the dataset currently loaded in the App"),LiteGraph.registerNodeType("FiftyComfy/Source/Current Dataset",u);class t extends LGraphNode{constructor(){super(),this.title="Load Saved View",this.addOutput("view","FO_VIEW"),this.addWidget("combo","view_name","",b=>{this.properties.view_name=b},{values:[]}),this.properties={view_name:""},this.size=[280,80],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(b){var J;if((J=this.flags)!=null&&J.collapsed)return;const it=_datasetInfo.dataset_name;if(it){b.font="11px sans-serif",b.fillStyle="rgba(255,255,255,0.45)",b.textAlign="left";const st=this.size[0]-20,Q="dataset: ";let bt=Q+it;for(;b.measureText(bt).width>st&&bt.length>Q.length+4;)bt=Q+it.slice(0,bt.length-Q.length-2);bt!==Q+it&&(bt+="â€¦"),b.fillText(bt,10,this.size[1]-8)}}}d(t,"title","Load Saved View"),d(t,"desc","Load a saved view from the dataset"),LiteGraph.registerNodeType("FiftyComfy/Source/Load Saved View",t);class i extends LGraphNode{constructor(){super(),this.title="Match",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","expression","F('confidence') > 0.5",b=>{this.properties.expression=b}),this.properties={expression:"F('confidence') > 0.5"},this.size=[320,80],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(i,"title","Match"),d(i,"desc","Filter samples by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match",i);class s extends LGraphNode{constructor(){super(),this.title="Filter Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","expression","F('label') == 'car'",b=>{this.properties.expression=b}),this.addWidget("toggle","only_matches",!0,b=>{this.properties.only_matches=b}),this.properties={field:"",expression:"F('label') == 'car'",only_matches:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(b){var st;if((st=this.flags)!=null&&st.collapsed)return;const it=this.properties.field,J=it?_datasetInfo.label_classes[it]||[]:[];if(J.length>0){b.font="10px sans-serif",b.fillStyle="rgba(255,255,255,0.4)",b.textAlign="left";const Q=J.slice(0,6).join(", ")+(J.length>6?", ...":"");b.fillText("classes: "+Q,8,this.size[1]-6)}}}d(s,"title","Filter Labels"),d(s,"desc","Filter detections/classifications within a label field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Labels",s);class n extends LGraphNode{constructor(){super(),this.title="Match Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","filter","F('label') == 'car'",b=>{this.properties.filter=b}),this.addWidget("toggle","bool",!0,b=>{this.properties.bool=b}),this.properties={field:"",filter:"F('label') == 'car'",bool:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(b){var st;if((st=this.flags)!=null&&st.collapsed)return;const it=this.properties.field,J=it?_datasetInfo.label_classes[it]||[]:[];if(J.length>0){b.font="10px sans-serif",b.fillStyle="rgba(255,255,255,0.4)",b.textAlign="left";const Q=J.slice(0,6).join(", ")+(J.length>6?", ...":"");b.fillText("classes: "+Q,8,this.size[1]-6)}}}d(n,"title","Match Labels"),d(n,"desc","Match samples containing labels that satisfy a condition"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Labels",n);class o extends LGraphNode{constructor(){super(),this.title="Sort By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("toggle","reverse",!1,b=>{this.properties.reverse=b}),this.properties={field:"",reverse:!1},this.size=[280,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(o,"title","Sort By"),d(o,"desc","Sort samples by a field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By",o);class r extends LGraphNode{constructor(){super(),this.title="Sort By Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","query","",b=>{this.properties.query=b}),this.addWidget("text","brain_key","similarity",b=>{this.properties.brain_key=b}),this.addWidget("number","k",25,b=>{this.properties.k=b},{min:1,max:1e5,step:1,precision:0}),this.addWidget("toggle","reverse",!1,b=>{this.properties.reverse=b}),this.properties={query:"",brain_key:"similarity",k:25,reverse:!1},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(r,"title","Sort By Similarity"),d(r,"desc","Sort samples by similarity to a reference (requires similarity index)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By Similarity",r);class a extends LGraphNode{constructor(){super(),this.title="Limit",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,b=>{this.properties.count=b},{min:1,max:1e5,step:10,precision:0}),this.properties={count:100},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(a,"title","Limit"),d(a,"desc","Limit number of samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Limit",a);class l extends LGraphNode{constructor(){super(),this.title="Match Tags",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",b=>{this.properties.tags=b}),this.properties={tags:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(l,"title","Match Tags"),d(l,"desc","Filter samples by tags (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Tags",l);class h extends LGraphNode{constructor(){super(),this.title="Take",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,b=>{this.properties.count=b},{min:1,max:1e5,step:10,precision:0}),this.addWidget("number","seed",0,b=>{this.properties.seed=b||null},{min:0,max:99999,step:1,precision:0}),this.properties={count:100,seed:null},this.size=[240,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(h,"title","Take"),d(h,"desc","Randomly sample N samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Take",h);class c extends LGraphNode{constructor(){super(),this.title="Shuffle",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","seed",0,b=>{this.properties.seed=b||null},{min:0,max:99999,step:1,precision:0}),this.properties={seed:null},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(c,"title","Shuffle"),d(c,"desc","Randomly shuffle samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Shuffle",c);class p extends LGraphNode{constructor(){super(),this.title="To Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.properties={field:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(p,"title","To Patches"),d(p,"desc","Create a patches view from a label list field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/To Patches",p);class f extends LGraphNode{constructor(){super(),this.title="Map Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","map",'{"old_label": "new_label"}',b=>{this.properties.map=b}),this.properties={field:"",map:'{"old_label": "new_label"}'},this.size=[340,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(f,"title","Map Labels"),d(f,"desc","Remap label values using a mapping dict"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Map Labels",f);class g extends LGraphNode{constructor(){super(),this.title="Exists",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("toggle","bool",!0,b=>{this.properties.bool=b}),this.properties={field:"",bool:!0},this.size=[260,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(g,"title","Exists"),d(g,"desc","Filter samples where a field exists (is not None)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exists",g);class _ extends LGraphNode{constructor(){super(),this.title="Select Fields",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","fields","",b=>{this.properties.fields=b}),this.properties={fields:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(_,"title","Select Fields"),d(_,"desc","Select only specified fields (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Select Fields",_);class m extends LGraphNode{constructor(){super(),this.title="Exclude Fields",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","fields","",b=>{this.properties.fields=b}),this.properties={fields:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(m,"title","Exclude Fields"),d(m,"desc","Exclude specified fields (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exclude Fields",m);class y extends LGraphNode{constructor(){super(),this.title="Skip",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",0,b=>{this.properties.count=b},{min:0,max:1e5,step:10,precision:0}),this.properties={count:0},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(y,"title","Skip"),d(y,"desc","Omit the first N samples from the view"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Skip",y);class w extends LGraphNode{constructor(){super(),this.title="Filter Field",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","expression","F() > 0",b=>{this.properties.expression=b}),this.addWidget("toggle","only_matches",!0,b=>{this.properties.only_matches=b}),this.properties={field:"",expression:"F() > 0",only_matches:!0},this.size=[320,130],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(w,"title","Filter Field"),d(w,"desc","Filter values of a field by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Field",w);class k extends LGraphNode{constructor(){super(),this.title="Filter Keypoints",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","filter","F('confidence') > 0.5",b=>{this.properties.filter=b}),this.addWidget("toggle","only_matches",!0,b=>{this.properties.only_matches=b}),this.properties={field:"",filter:"F('confidence') > 0.5",only_matches:!0},this.size=[340,130],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(k,"title","Filter Keypoints"),d(k,"desc","Filter individual keypoint elements by expression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Keypoints",k);class L extends LGraphNode{constructor(){super(),this.title="Select Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",b=>{this.properties.tags=b}),this.addWidget("text","fields","",b=>{this.properties.fields=b}),this.properties={tags:"",fields:""},this.size=[300,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(L,"title","Select Labels"),d(L,"desc","Select labels matching tags or fields"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Select Labels",L);class E extends LGraphNode{constructor(){super(),this.title="Exclude Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",b=>{this.properties.tags=b}),this.addWidget("text","fields","",b=>{this.properties.fields=b}),this.properties={tags:"",fields:""},this.size=[300,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(E,"title","Exclude Labels"),d(E,"desc","Exclude labels matching tags or fields"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exclude Labels",E);class S extends LGraphNode{constructor(){super(),this.title="Set Field",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","field","",b=>{this.properties.field=b}),this.addWidget("text","expression","F('confidence') > 0.5",b=>{this.properties.expression=b}),this.properties={field:"",expression:"F('confidence') > 0.5"},this.size=[340,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(S,"title","Set Field"),d(S,"desc","Set a field value using a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Set Field",S);class T extends LGraphNode{constructor(){super(),this.title="Group By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("toggle","reverse",!1,b=>{this.properties.reverse=b}),this.addWidget("toggle","flat",!1,b=>{this.properties.flat=b}),this.properties={field:"",reverse:!1,flat:!1},this.size=[280,120],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(T,"title","Group By"),d(T,"desc","Group samples by a field value"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Group By",T);class G extends LGraphNode{constructor(){super(),this.title="Compute Metadata",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("toggle","overwrite",!1,b=>{this.properties.overwrite=b}),this.properties={overwrite:!1},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}d(G,"title","Compute Metadata"),d(G,"desc","Populate width, height, and other metadata for all samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Compute Metadata",G);class D extends LGraphNode{constructor(){super(),this.title="Compute BBox Area",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",b=>{this.properties.field=b},{values:[]}),this.addWidget("text","output_field","bbox_area",b=>{this.properties.output_field=b}),this.addWidget("combo","area_mode","relative",b=>{this.properties.area_mode=b},{values:["relative","pixel"]}),this.properties={field:"",output_field:"bbox_area",area_mode:"relative"},this.size=[340,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(b){var st;if((st=this.flags)!=null&&st.collapsed)return;const it=this.properties.area_mode||"relative";b.font="10px sans-serif",b.fillStyle="rgba(255,255,255,0.4)",b.textAlign="left";const J=it==="pixel"?"pixel: wÃ—h in pixels (needs Compute Metadata)":"relative: wÃ—h in [0,1] normalized coords";b.fillText(J,8,this.size[1]-6)}}d(D,"title","Compute BBox Area"),d(D,"desc","Compute bounding box area for each detection"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Compute BBox Area",D);class C extends LGraphNode{constructor(){super(),this.title="Compute Embeddings",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","clip-vit-base32-torch",b=>{this.properties.model=b},{values:["clip-vit-base32-torch","clip-vit-large14-torch","open-clip-vit-b-32","dinov2-vits14-torch"]}),this.addWidget("text","embeddings_field","embeddings",b=>{this.properties.embeddings_field=b}),this.properties={model:"clip-vit-base32-torch",embeddings_field:"embeddings"},this.size=[340,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(C,"title","Compute Embeddings"),d(C,"desc","Compute embeddings using a zoo model"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Embeddings",C);class R extends LGraphNode{constructor(){super(),this.title="Compute Visualization",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","visualization",b=>{this.properties.brain_key=b}),this.addWidget("combo","method","umap",b=>{this.properties.method=b},{values:["umap","tsne","pca"]}),this.addWidget("combo","num_dims","2",b=>{this.properties.num_dims=parseInt(b)},{values:["2","3"]}),this.addWidget("text","embeddings","embeddings",b=>{this.properties.embeddings=b}),this.properties={brain_key:"visualization",method:"umap",num_dims:2,embeddings:"embeddings"},this.size=[340,150],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(R,"title","Compute Visualization"),d(R,"desc","Compute UMAP/t-SNE/PCA embedding visualization"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Visualization",R);class A extends LGraphNode{constructor(){super(),this.title="Compute Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",b=>{this.properties.brain_key=b}),this.addWidget("combo","backend","sklearn",b=>{this.properties.backend=b},{values:["sklearn","qdrant","pinecone","milvus","lancedb"]}),this.addWidget("text","embeddings","embeddings",b=>{this.properties.embeddings=b}),this.properties={brain_key:"similarity",backend:"sklearn",embeddings:"embeddings"},this.size=[340,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(A,"title","Compute Similarity"),d(A,"desc","Create a similarity index"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Similarity",A);class V extends LGraphNode{constructor(){super(),this.title="Compute Uniqueness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","uniqueness_field","uniqueness",b=>{this.properties.uniqueness_field=b}),this.addWidget("text","embeddings","embeddings",b=>{this.properties.embeddings=b}),this.properties={uniqueness_field:"uniqueness",embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(V,"title","Compute Uniqueness"),d(V,"desc","Compute uniqueness score per sample"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Uniqueness",V);class j extends LGraphNode{constructor(){super(),this.title="Find Exact Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.properties={},this.size=[280,50],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(j,"title","Find Exact Duplicates"),d(j,"desc","Find samples with identical media files"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Exact Duplicates",j);class M extends LGraphNode{constructor(){super(),this.title="Find Near Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","threshold",.1,b=>{this.properties.threshold=b},{min:.001,max:1,step:.01,precision:3}),this.addWidget("text","embeddings","embeddings",b=>{this.properties.embeddings=b}),this.properties={threshold:.1,embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(M,"title","Find Near Duplicates"),d(M,"desc","Find near-duplicate samples using embeddings"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Near Duplicates",M);class W extends LGraphNode{constructor(){super(),this.title="Compute Representativeness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","representativeness_field","representativeness",b=>{this.properties.representativeness_field=b}),this.addWidget("combo","method","cluster-center",b=>{this.properties.method=b},{values:["cluster-center","cluster-center-downweight"]}),this.addWidget("text","embeddings","embeddings",b=>{this.properties.embeddings=b}),this.properties={representativeness_field:"representativeness",method:"cluster-center",embeddings:"embeddings"},this.size=[360,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(W,"title","Compute Representativeness"),d(W,"desc","Score how representative each sample is of its neighborhood"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Representativeness",W);class B extends LGraphNode{constructor(){super(),this.title="Compute Mistakenness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",b=>{this.properties.pred_field=b},{values:[]}),this.addWidget("combo","label_field","",b=>{this.properties.label_field=b},{values:[]}),this.addWidget("text","mistakenness_field","mistakenness",b=>{this.properties.mistakenness_field=b}),this.properties={pred_field:"",label_field:"",mistakenness_field:"mistakenness"},this.size=[320,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(B,"title","Compute Mistakenness"),d(B,"desc","Estimate likelihood of annotation mistakes"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Mistakenness",B);class $ extends LGraphNode{constructor(){super(),this.title="Compute Hardness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","predictions_field","",b=>{this.properties.predictions_field=b},{values:[]}),this.addWidget("text","hardness_field","hardness",b=>{this.properties.hardness_field=b}),this.properties={predictions_field:"",hardness_field:"hardness"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d($,"title","Compute Hardness"),d($,"desc","Compute sample hardness (how difficult to classify)"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Hardness",$);class z extends LGraphNode{constructor(){super(),this.title="Detect Leaky Splits",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","splits","train,test",b=>{this.properties.splits=b}),this.addWidget("number","threshold",.1,b=>{this.properties.threshold=b},{min:.001,max:1,step:.01,precision:3}),this.properties={splits:"train,test",threshold:.1},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}d(z,"title","Detect Leaky Splits"),d(z,"desc","Find data leaks across train/test/val splits"),LiteGraph.registerNodeType("FiftyComfy/Brain/Detect Leaky Splits",z);class q extends LGraphNode{constructor(){super(),this.title="Manage Brain Run",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","brain_key","",b=>{this.properties.brain_key=b},{values:[]}),this.addWidget("combo","action","delete",b=>{this.properties.action=b},{values:["delete","rename"]}),this.addWidget("text","new_name","",b=>{this.properties.new_name=b}),this.properties={brain_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}onDrawForeground(b){var st;if((st=this.flags)!=null&&st.collapsed)return;const it=this.properties.action||"delete",J=this.properties.brain_key||"";if(J){b.font="10px sans-serif",b.fillStyle="rgba(255,255,255,0.4)",b.textAlign="left";const Q=it==="rename"?`will rename "${J}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${J}"`,bt=this.size[0]-16;let dt=Q;for(;b.measureText(dt).width>bt&&dt.length>10;)dt=dt.slice(0,-2);dt!==Q&&(dt+="â€¦"),b.fillText(dt,8,this.size[1]-6)}}}d(q,"title","Manage Brain Run"),d(q,"desc","Rename or delete a brain run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Brain/Manage Brain Run",q);class lt extends LGraphNode{constructor(){super(),this.title="Apply Zoo Model",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","",b=>{this.properties.model=b},{values:[]}),this.addWidget("text","label_field","predictions",b=>{this.properties.label_field=b}),this.addWidget("number","confidence_thresh",0,b=>{this.properties.confidence_thresh=b},{min:0,max:1,step:.05,precision:2}),this.addWidget("toggle","store_logits",!1,b=>{this.properties.store_logits=b}),this.properties={model:"",label_field:"predictions",confidence_thresh:0,store_logits:!1},this.size=[360,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(lt,"title","Apply Zoo Model"),d(lt,"desc","Apply a model from the FiftyOne Model Zoo"),LiteGraph.registerNodeType("FiftyComfy/Model/Apply Zoo Model",lt);class vt extends LGraphNode{constructor(){super(),this.title="Evaluate Detections",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",b=>{this.properties.pred_field=b},{values:[]}),this.addWidget("combo","gt_field","",b=>{this.properties.gt_field=b},{values:[]}),this.addWidget("text","eval_key","eval",b=>{this.properties.eval_key=b}),this.addWidget("combo","method","coco",b=>{this.properties.method=b},{values:["coco","open-images"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"coco"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(vt,"title","Evaluate Detections"),d(vt,"desc","Evaluate detection predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Detections",vt);class Et extends LGraphNode{constructor(){super(),this.title="Evaluate Classifications",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",b=>{this.properties.pred_field=b},{values:[]}),this.addWidget("combo","gt_field","",b=>{this.properties.gt_field=b},{values:[]}),this.addWidget("text","eval_key","eval",b=>{this.properties.eval_key=b}),this.properties={pred_field:"",gt_field:"",eval_key:"eval"},this.size=[340,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(Et,"title","Evaluate Classifications"),d(Et,"desc","Evaluate classification predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Classifications",Et);class ee extends LGraphNode{constructor(){super(),this.title="Manage Evaluation",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","eval_key","",b=>{this.properties.eval_key=b},{values:[]}),this.addWidget("combo","action","delete",b=>{this.properties.action=b},{values:["delete","rename"]}),this.addWidget("text","new_name","",b=>{this.properties.new_name=b}),this.properties={eval_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}onDrawForeground(b){var st;if((st=this.flags)!=null&&st.collapsed)return;const it=this.properties.action||"delete",J=this.properties.eval_key||"";if(J){b.font="10px sans-serif",b.fillStyle="rgba(255,255,255,0.4)",b.textAlign="left";const Q=it==="rename"?`will rename "${J}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${J}"`,bt=this.size[0]-16;let dt=Q;for(;b.measureText(dt).width>bt&&dt.length>10;)dt=dt.slice(0,-2);dt!==Q&&(dt+="â€¦"),b.fillText(dt,8,this.size[1]-6)}}}d(ee,"title","Manage Evaluation"),d(ee,"desc","Rename or delete an evaluation run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Manage Evaluation",ee);class ie extends LGraphNode{constructor(){super(),this.title="Evaluate Segmentations",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",b=>{this.properties.pred_field=b},{values:[]}),this.addWidget("combo","gt_field","",b=>{this.properties.gt_field=b},{values:[]}),this.addWidget("text","eval_key","eval",b=>{this.properties.eval_key=b}),this.addWidget("combo","method","simple",b=>{this.properties.method=b},{values:["simple"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"simple"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(ie,"title","Evaluate Segmentations"),d(ie,"desc","Evaluate semantic segmentation masks against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Segmentations",ie);class se extends LGraphNode{constructor(){super(),this.title="Evaluate Regressions",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",b=>{this.properties.pred_field=b},{values:[]}),this.addWidget("combo","gt_field","",b=>{this.properties.gt_field=b},{values:[]}),this.addWidget("text","eval_key","eval",b=>{this.properties.eval_key=b}),this.addWidget("combo","method","simple",b=>{this.properties.method=b},{values:["simple"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"simple"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(se,"title","Evaluate Regressions"),d(se,"desc","Evaluate regression predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Regressions",se);class ft extends LGraphNode{constructor(){super(),this.title="To Evaluation Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","eval_key","",b=>{this.properties.eval_key=b},{values:[]}),this.properties={eval_key:""},this.size=[320,70],this.color="#6AAF6C",this.bgcolor="#3F6840"}}d(ft,"title","To Evaluation Patches"),d(ft,"desc","Convert to TP/FP/FN patches from an evaluation run"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/To Evaluation Patches",ft);class Ce extends LGraphNode{constructor(){super(),this.title="Set App View",this.addInput("view","FO_VIEW"),this.properties={},this.size=[220,50],this.color="#998E3B",this.bgcolor="#FFED63"}}d(Ce,"title","Set App View"),d(Ce,"desc","Push the resulting view into the FiftyOne App"),LiteGraph.registerNodeType("FiftyComfy/Output/Set App View",Ce);class je extends LGraphNode{constructor(){super(),this.title="Save View",this.addInput("view","FO_VIEW"),this.addWidget("text","name","my_view",b=>{this.properties.name=b}),this.addWidget("text","description","",b=>{this.properties.description=b}),this.addWidget("toggle","overwrite",!1,b=>{this.properties.overwrite=b}),this.properties={name:"my_view",description:"",overwrite:!1},this.size=[300,120],this.color="#998E3B",this.bgcolor="#FFED63"}}d(je,"title","Save View"),d(je,"desc","Save the view as a named saved view"),LiteGraph.registerNodeType("FiftyComfy/Output/Save View",je),console.log("[FiftyComfy] Registered all node types")}const listeners={};function onEvent(u,t){return listeners[u]||(listeners[u]=[]),listeners[u].push(t),()=>{listeners[u]=listeners[u].filter(i=>i!==t)}}function emit(u,t){(listeners[u]||[]).forEach(i=>{try{i(t)}catch(s){console.error(`[FiftyComfy] Event listener error (${u}):`,s)}})}class NodeStatusUpdateOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"node_status_update",label:"Node Status Update",unlisted:!0})}async execute({params:t}){emit("node_status",t)}}class ExecutionCompleteOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"execution_complete",label:"Execution Complete",unlisted:!0})}async execute({params:t}){emit("execution_complete",t)}}class DatasetInfoLoadedOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"dataset_info_loaded",label:"Dataset Info Loaded",unlisted:!0})}async execute({params:t}){console.log("[FiftyComfy] dataset_info_loaded received:",t),emit("dataset_info",t)}}function buildLinearGraph(u){const n=[];let o=1,r=1,a=50;for(let c=0;c<u.length;c++){const p=u[c],f=p.hasInput&&c>0?r:null,g=p.hasOutput&&c<u.length-1&&u[c+1].hasInput,_={id:o,type:p.type,pos:[a,200],size:[p.w,p.h],flags:{},order:c,mode:0,properties:{...p.properties},inputs:p.hasInput?[{name:"view",type:"FO_VIEW",link:f}]:[],outputs:p.hasOutput?[{name:"view",type:"FO_VIEW",links:g?[r+(f?0:1)]:[],slot_index:0}]:[]};n.push(_),f&&r++,a+=p.w+60,o++}const l=[];let h=1;for(let c=0;c<n.length-1;c++){const p=n[c],f=n[c+1];p.outputs.length>0&&f.inputs.length>0&&(l.push([h,p.id,0,f.id,0,"FO_VIEW"]),p.outputs[0].links=[h],f.inputs[0].link=h,h++)}return{version:.4,last_node_id:n.length,last_link_id:h-1,nodes:n,links:l,groups:[],config:{},extra:{}}}const SRC=(u,t={})=>({type:"FiftyComfy/Source/Current Dataset",title:u,w:240,h:60,properties:t,hasInput:!1,hasOutput:!0}),VS=(u,t,i,s,n)=>({type:`FiftyComfy/View Stages/${u}`,title:t,w:i,h:s,properties:n,hasInput:!0,hasOutput:!0}),BR=(u,t,i,s,n)=>({type:`FiftyComfy/Brain/${u}`,title:t,w:i,h:s,properties:n,hasInput:!0,hasOutput:!0}),EV=(u,t,i,s,n)=>({type:`FiftyComfy/Evaluation/${u}`,title:t,w:i,h:s,properties:n,hasInput:!0,hasOutput:!0}),OUT=()=>({type:"FiftyComfy/Output/Set App View",title:"Set App View",w:220,h:50,properties:{},hasInput:!0,hasOutput:!1}),BUILTIN_TEMPLATES=[{id:"compute-visualize-embeddings",name:"Compute & Visualize Embeddings",category:"Data Curation",description:"Compute CLIP embeddings and create a UMAP visualization",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Embeddings","Compute Embeddings",340,100,{model:"clip-vit-base32-torch",embeddings_field:"embeddings"}),BR("Compute Visualization","Compute Visualization",340,150,{brain_key:"visualization",method:"umap",num_dims:2,embeddings:"embeddings"}),OUT()])},{id:"find-near-duplicates",name:"Find Near Duplicates",category:"Data Curation",description:"Compute embeddings and detect near-duplicate samples",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Embeddings","Compute Embeddings",340,100,{model:"clip-vit-base32-torch",embeddings_field:"embeddings"}),BR("Find Near Duplicates","Find Near Duplicates",320,100,{threshold:.1,embeddings:"embeddings"}),OUT()])},{id:"find-exact-duplicates",name:"Find Exact Duplicates",category:"Data Curation",description:"Find samples with identical media files",graph:buildLinearGraph([SRC("Current Dataset"),BR("Find Exact Duplicates","Find Exact Duplicates",280,50,{}),OUT()])},{id:"curate-by-uniqueness",name:"Curate by Uniqueness",category:"Data Curation",description:"Compute embeddings, uniqueness scores, and view the most unique samples",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Embeddings","Compute Embeddings",340,100,{model:"clip-vit-base32-torch",embeddings_field:"embeddings"}),BR("Compute Uniqueness","Compute Uniqueness",320,100,{uniqueness_field:"uniqueness",embeddings:"embeddings"}),VS("Sort By","Sort By",280,90,{field:"uniqueness",reverse:!0}),VS("Limit","Limit",220,70,{count:100}),OUT()])},{id:"curate-by-representativeness",name:"Curate by Representativeness",category:"Data Curation",description:"Compute embeddings, representativeness scores, and view top results",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Embeddings","Compute Embeddings",340,100,{model:"clip-vit-base32-torch",embeddings_field:"embeddings"}),BR("Compute Representativeness","Compute Representativeness",360,130,{representativeness_field:"representativeness",method:"cluster-center",embeddings:"embeddings"}),VS("Sort By","Sort By",280,90,{field:"representativeness",reverse:!0}),VS("Limit","Limit",220,70,{count:100}),OUT()])},{id:"find-annotation-mistakes",name:"Find Annotation Mistakes",category:"Quality",description:"Estimate mistakenness and surface likely annotation errors",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Mistakenness","Compute Mistakenness",320,130,{pred_field:"",label_field:"",mistakenness_field:"mistakenness"}),VS("Sort By","Sort By",280,90,{field:"mistakenness",reverse:!0}),OUT()])},{id:"sample-hardness",name:"Sample Hardness",category:"Quality",description:"Compute sample hardness and view hardest-to-classify samples",graph:buildLinearGraph([SRC("Current Dataset"),BR("Compute Hardness","Compute Hardness",320,100,{predictions_field:"",hardness_field:"hardness"}),VS("Sort By","Sort By",280,90,{field:"hardness",reverse:!0}),OUT()])},{id:"filter-high-confidence",name:"Filter High-Confidence Predictions",category:"Filtering",description:"Keep only predictions with confidence > 0.9",graph:buildLinearGraph([SRC("Current Dataset"),VS("Filter Labels","Filter Labels",320,150,{field:"",expression:'F("confidence") > 0.90',only_matches:!0}),OUT()])},{id:"filter-by-bbox-area",name:"Filter by BBox Area",category:"Filtering",description:"Compute metadata, bbox areas, and filter detections by size",graph:buildLinearGraph([SRC("Current Dataset"),VS("Compute Metadata","Compute Metadata",280,70,{overwrite:!1}),VS("Compute BBox Area","Compute BBox Area",340,150,{field:"",output_field:"bbox_area",area_mode:"pixel"}),VS("Filter Labels","Filter Labels",320,150,{field:"",expression:'F("bbox_area") > 3200',only_matches:!0}),OUT()])},{id:"evaluate-detections",name:"Evaluate Detections",category:"Evaluation",description:"Run COCO evaluation and view TP/FP/FN patches",graph:buildLinearGraph([SRC("Current Dataset"),EV("Evaluate Detections","Evaluate Detections",340,150,{pred_field:"",gt_field:"",eval_key:"eval",method:"coco"}),EV("To Evaluation Patches","To Evaluation Patches",320,70,{eval_key:"eval"}),OUT()])},{id:"evaluate-classifications",name:"Evaluate Classifications",category:"Evaluation",description:"Evaluate classification predictions against ground truth",graph:buildLinearGraph([SRC("Current Dataset"),EV("Evaluate Classifications","Evaluate Classifications",340,130,{pred_field:"",gt_field:"",eval_key:"eval"}),OUT()])}],NS$1="@harpreetsahota/FiftyComfy";let _graph=null,_lgCanvas=null,_initialized=!1,_cssInjected=!1,_currentDatasetName="";const TH=36,toolbarCss={position:"absolute",top:0,left:0,right:0,height:TH,zIndex:10,display:"flex",alignItems:"center",gap:6,padding:"0 8px",background:"rgba(20,20,20,0.85)",backdropFilter:"blur(4px)",borderBottom:"1px solid rgba(255,255,255,0.08)",fontFamily:"'Inter','Segoe UI',sans-serif"},btnCss={padding:"4px 10px",border:"1px solid rgba(255,255,255,0.15)",borderRadius:4,background:"rgba(255,255,255,0.08)",color:"#ccc",cursor:"pointer",fontSize:12,fontWeight:500,lineHeight:"20px"},btnRunCss={...btnCss,background:"#2d6a4f",borderColor:"#40916c",color:"#fff",fontWeight:600},sepCss={width:1,height:20,background:"rgba(255,255,255,0.1)",margin:"0 2px"},panelCss={position:"absolute",top:TH+4,left:50,zIndex:20,background:"#2a2a2a",border:"1px solid #555",borderRadius:6,padding:10,minWidth:320,maxWidth:420,maxHeight:480,overflowY:"auto",boxShadow:"0 4px 16px rgba(0,0,0,0.5)"},sectionHeaderCss={fontSize:10,fontWeight:600,color:"#888",textTransform:"uppercase",letterSpacing:"0.5px",margin:"10px 0 4px 0",padding:"0 4px"},itemCss={padding:"5px 8px",cursor:"pointer",borderRadius:4,fontSize:12,color:"#ddd",display:"flex",justifyContent:"space-between",alignItems:"center"},descCss={fontSize:10,color:"#777",marginTop:1},deleteBtnCss={fontSize:10,color:"#888",cursor:"pointer",padding:"2px 6px",borderRadius:3,border:"none",background:"transparent"},savePanelCss={...panelCss,minWidth:280,maxWidth:320,maxHeight:"none"};let _datasetInfoListenerSet=!1;function setupDatasetInfoListener(){_datasetInfoListenerSet||(_datasetInfoListenerSet=!0,onEvent("dataset_info",u=>{var t,i;if(u&&u.fields){const s=u.dataset_name||"";_currentDatasetName&&s&&s!==_currentDatasetName&&(console.log(`[FiftyComfy] Dataset changed: ${_currentDatasetName} -> ${s}, clearing canvas`),_graph&&_graph.clear()),_currentDatasetName=s,setDatasetInfo(u),_graph&&updateAllComboWidgets(_graph),console.log("[FiftyComfy] Dataset info received:",s+",",(t=u.fields)==null?void 0:t.length,"fields,",(i=u.label_fields)==null?void 0:i.length,"label fields")}}))}function fetchDatasetInfo(){setupDatasetInfoListener(),operators.executeOperator(`${NS$1}/get_dataset_info`,{}).catch(u=>{console.warn("[FiftyComfy] Could not fetch dataset info:",u)})}function FiftyComfyView(){const u=React.useRef(null),t=React.useRef(null),[i,s]=React.useState("Ready"),[n,o]=React.useState(!1),[r,a]=React.useState(!1),[l,h]=React.useState(!1),[c,p]=React.useState([]),[f,g]=React.useState([]),[_,m]=React.useState(!1),[y,w]=React.useState(""),[k,L]=React.useState("dataset");React.useEffect(()=>{const W=u.current,B=t.current;if(!W||!B)return;if(!_cssInjected){const q=document.createElement("style");q.id="fiftycomfy-lg-css",q.textContent=litegraphCss,document.head.appendChild(q),_cssInjected=!0}if(_initialized||(registerAllNodes(),LiteGraph.allow_edit_node_title=!1,LiteGraph.NODE_TEXT_COLOR="#FFFFFF",LiteGraph.NODE_TITLE_COLOR="#FFFFFF",LiteGraph.WIDGET_TEXT_COLOR="#FFFFFF",LiteGraph.DEFAULT_LINK_COLOR="#99ccff",LiteGraph.LINK_COLOR="#99ccff",LiteGraph.EVENT_LINK_COLOR="#ff9966",LiteGraph.registered_link_types=LiteGraph.registered_link_types||{},LiteGraph.registered_link_types.FO_VIEW={color:"#4FC3F7"},_initialized=!0),_graph||(_graph=new LGraph,hookNodeAdded(_graph)),_lgCanvas){try{_lgCanvas.setGraph(null)}catch{}_lgCanvas=null}_lgCanvas=new LGraphCanvas(W,_graph),_lgCanvas.render_shadows=!1,_lgCanvas.max_zoom=4,_lgCanvas.min_zoom=.1,_lgCanvas.allow_searchbox=!0,_lgCanvas.show_searchbox_on_double_click=!0,_lgCanvas.render_curved_connections=!0,_lgCanvas.render_connection_arrows=!1,_lgCanvas.connections_width=3,_lgCanvas.default_connection_color={input_off:"#888",input_on:"#4FC3F7",output_off:"#888",output_on:"#4FC3F7"},_lgCanvas.autoresize=!0,installSearchFilter(_lgCanvas),_graph.start(),fetchDatasetInfo();const $=()=>{_lgCanvas&&_lgCanvas.resize()};$(),requestAnimationFrame($),setTimeout($,100);const z=new ResizeObserver($);return z.observe(B),()=>{z.disconnect()}},[]);const E=React.useCallback((W,B)=>{!_graph||!W||(_graph.configure(W),updateAllComboWidgets(_graph),s("Loaded: "+B),a(!1),h(!1))},[]),S=React.useCallback(async()=>{if(_graph){for(const W of _graph._nodes||[])W.boxcolor=null,W.setDirtyCanvas(!0,!0);o(!0),s("Running...");try{await operators.executeOperator(`${NS$1}/execute_graph`,{graph_json:JSON.stringify(_graph.serialize())})}catch(W){console.error("[FiftyComfy] Execution error:",W)}o(!1),s("Done")}},[]),T=React.useCallback(()=>{w(""),L("dataset"),m(!0),a(!1),h(!1)},[]),G=React.useCallback(async()=>{if(!_graph||!y.trim())return;const W=JSON.stringify(_graph.serialize()),B=k==="shared"?"save_shared_graph":"save_graph";try{await operators.executeOperator(`${NS$1}/${B}`,{name:y.trim(),graph_json:W}),s(`Saved: ${y.trim()} (${k})`)}catch($){console.error("[FiftyComfy] Save error:",$),s("Save failed")}m(!1)},[y,k]),D=React.useCallback(()=>{a(!0),h(!1),m(!1)},[]),C=React.useCallback(async()=>{var W,B;h(!0),a(!1),m(!1);try{const $=await operators.executeOperator(`${NS$1}/load_graphs`,{});p(((W=$==null?void 0:$.result)==null?void 0:W.graphs)||[])}catch{p([])}try{const $=await operators.executeOperator(`${NS$1}/load_shared_graphs`,{});g(((B=$==null?void 0:$.result)==null?void 0:B.graphs)||[])}catch{g([])}},[]),R=React.useCallback(async(W,B)=>{var z;const $=B==="shared"?"load_shared_graph":"load_graph";try{const q=await operators.executeOperator(`${NS$1}/${$}`,{graph_id:W}),lt=(z=q==null?void 0:q.result)==null?void 0:z.data;lt!=null&&lt.graph&&E(lt.graph,lt.name||W)}catch(q){console.error("[FiftyComfy] Load error:",q),s("Load failed")}},[E]),A=React.useCallback(async(W,B)=>{const $=B==="shared"?"delete_shared_graph":"delete_graph";try{await operators.executeOperator(`${NS$1}/${$}`,{graph_id:W}),B==="dataset"?p(z=>z.filter(q=>q.id!==W)):g(z=>z.filter(q=>q.id!==W)),s("Deleted")}catch(z){console.error("[FiftyComfy] Delete error:",z)}},[]),V=React.useCallback(W=>{E(W.graph,W.name)},[E]),j=React.useCallback(()=>{_graph&&_graph.clear(),s("Ready")},[]),M={};for(const W of BUILTIN_TEMPLATES)M[W.category]||(M[W.category]=[]),M[W.category].push(W);return React__namespace.createElement("div",{ref:t,style:{width:"100%",height:"100%",position:"relative",overflow:"hidden"}},React__namespace.createElement("canvas",{ref:u,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"}}),React__namespace.createElement("div",{style:toolbarCss},React__namespace.createElement("button",{style:btnRunCss,onClick:S,disabled:n},n?"Running...":"â–¶ Run Workflow"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:D},"Templates"),React__namespace.createElement("button",{style:btnCss,onClick:C},"Saved"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:T},"Save"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:j},"Clear"),React__namespace.createElement("span",{style:{marginLeft:"auto",fontSize:11,color:"rgba(255,255,255,0.4)"}},i)),_&&React__namespace.createElement("div",{style:savePanelCss},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:8,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Save Workflow"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>m(!1)},"âœ•")),React__namespace.createElement("input",{type:"text",placeholder:"Workflow name...",value:y,onChange:W=>w(W.target.value),onKeyDown:W=>{W.key==="Enter"&&G()},style:{width:"100%",padding:"6px 8px",fontSize:12,background:"#1e1e1e",border:"1px solid #555",borderRadius:4,color:"#ddd",outline:"none",boxSizing:"border-box",marginBottom:8}}),React__namespace.createElement("div",{style:{display:"flex",gap:8,marginBottom:10}},React__namespace.createElement("label",{style:{fontSize:11,color:"#aaa",cursor:"pointer",display:"flex",alignItems:"center",gap:4}},React__namespace.createElement("input",{type:"radio",name:"scope",value:"dataset",checked:k==="dataset",onChange:()=>L("dataset")}),"This Dataset"),React__namespace.createElement("label",{style:{fontSize:11,color:"#aaa",cursor:"pointer",display:"flex",alignItems:"center",gap:4}},React__namespace.createElement("input",{type:"radio",name:"scope",value:"shared",checked:k==="shared",onChange:()=>L("shared")}),"Shared (all datasets)")),React__namespace.createElement("button",{style:{...btnCss,width:"100%",textAlign:"center",background:"#2d6a4f",borderColor:"#40916c",color:"#fff"},onClick:G,disabled:!y.trim()},"Save")),r&&React__namespace.createElement("div",{style:panelCss},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:6,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Built-in Templates"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>a(!1)},"âœ•")),...Object.entries(M).flatMap(([W,B])=>[React__namespace.createElement("div",{key:`cat-${W}`,style:sectionHeaderCss},W),...B.map($=>React__namespace.createElement("div",{key:$.id,style:itemCss,onClick:()=>V($),onMouseOver:z=>{z.currentTarget.style.background="#3a3a3a"},onMouseOut:z=>{z.currentTarget.style.background="transparent"}},React__namespace.createElement("div",null,React__namespace.createElement("div",null,$.name),React__namespace.createElement("div",{style:descCss},$.description)),React__namespace.createElement("span",{style:{fontSize:10,color:"#555"}},"â–¶")))])),l&&React__namespace.createElement("div",{style:panelCss},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:6,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Saved Workflows"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>h(!1)},"âœ•")),React__namespace.createElement("div",{style:sectionHeaderCss},"Shared (all datasets)"),f.length===0?React__namespace.createElement("div",{style:{fontSize:11,color:"#555",padding:"4px 8px"}},"No shared workflows"):f.map(W=>React__namespace.createElement("div",{key:W.id,style:itemCss,onMouseOver:B=>{B.currentTarget.style.background="#3a3a3a"},onMouseOut:B=>{B.currentTarget.style.background="transparent"}},React__namespace.createElement("span",{style:{cursor:"pointer",flex:1},onClick:()=>R(W.id,"shared")},W.name),React__namespace.createElement("button",{style:deleteBtnCss,onClick:B=>{B.stopPropagation(),A(W.id,"shared")},onMouseOver:B=>{B.currentTarget.style.color="#f66"},onMouseOut:B=>{B.currentTarget.style.color="#888"}},"âœ•"))),React__namespace.createElement("div",{style:sectionHeaderCss},`This Dataset${_currentDatasetName?` (${_currentDatasetName})`:""}`),c.length===0?React__namespace.createElement("div",{style:{fontSize:11,color:"#555",padding:"4px 8px"}},"No saved workflows for this dataset"):c.map(W=>React__namespace.createElement("div",{key:W.id,style:itemCss,onMouseOver:B=>{B.currentTarget.style.background="#3a3a3a"},onMouseOut:B=>{B.currentTarget.style.background="transparent"}},React__namespace.createElement("span",{style:{cursor:"pointer",flex:1},onClick:()=>R(W.id,"dataset")},W.name),React__namespace.createElement("button",{style:deleteBtnCss,onClick:B=>{B.stopPropagation(),A(W.id,"dataset")},onMouseOver:B=>{B.currentTarget.style.color="#f66"},onMouseOut:B=>{B.currentTarget.style.color="#888"}},"âœ•")))))}plugins.registerComponent({name:"FiftyComfyView",component:FiftyComfyView,type:plugins.PluginComponentType.Component,activator:()=>!0});const NS="@harpreetsahota/FiftyComfy";operators.registerOperator(NodeStatusUpdateOperator,NS),operators.registerOperator(ExecutionCompleteOperator,NS),operators.registerOperator(DatasetInfoLoadedOperator,NS),console.log("[FiftyComfy] Component (type=3) and operators registered")});
//# sourceMappingURL=index.umd.js.map
