(function(z,B){typeof exports=="object"&&typeof module<"u"?B(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","react"],B):(z=typeof globalThis<"u"?globalThis:z||self,B(z.__fop__,z.__foo__,z.React))})(this,function(plugins,operators,React){"use strict";var Gi=Object.defineProperty;var ii=z=>{throw TypeError(z)};var Pi=(z,B,$)=>B in z?Gi(z,B,{enumerable:!0,configurable:!0,writable:!0,value:$}):z[B]=$;var u=(z,B,$)=>Pi(z,typeof B!="symbol"?B+"":B,$),xe=(z,B,$)=>B.has(z)||ii("Cannot "+$);var I=(z,B,$)=>(xe(z,B,"read from private field"),$?$.call(z):B.get(z)),P=(z,B,$)=>B.has(z)?ii("Cannot add the same private member more than once"):B instanceof WeakSet?B.add(z):B.set(z,$),W=(z,B,$,ut)=>(xe(z,B,"write to private field"),ut?ut.call(z,$):B.set(z,$),$),O=(z,B,$)=>(xe(z,B,"access private method"),$);var ni=(z,B,$,ut)=>({set _(ft){W(z,B,ft,$)},get _(){return I(z,B,ut)}});var z,$,ut,be,si,Xt,At,q,nt,it,gt,Fe,Yt,vt,kt,Me,Gt,jt,Pt,xt,Ft,Mt,Kt,qt,Wt,Zt,zt,oi,ri,Jt,Qt,te,ee,rt,We,Be,ze,_t,Lt,ie,ne,H,ai,li,He,me,Ue,Ve,Ae,hi,ui,ci,di,pi,fi,Ut,se,Y,$e,Xe,ot,St,oe,Vt,tt,Ye,Ge,gi,je,ve,_i,ke,Le,Se,mt,dt,Ie,Te,Ee,It,G,Pe,yt,re,lt,et,ae,Tt,mi,ht,Ct,yi,bi,Ke,wi,vi,ki,Li,Si,Dt,Rt,Ii,Ti,Ei,Ni,Oi,Ci,$t,ye,Et,Nt,Ne,Oe,Di,le,he,ue,qe,ce,De,de,pe,Re,Ri,fe,bt,Ze,Je;function _interopNamespaceDefault(p){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(p){for(const i in p)if(i!=="default"){const n=Object.getOwnPropertyDescriptor(p,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:()=>p[i]})}}return t.default=p,Object.freeze(t)}const React__namespace=_interopNamespaceDefault(React);class CustomEventTarget extends EventTarget{dispatch(t,i){const n=new CustomEvent(t,{detail:i,cancelable:!0});return super.dispatchEvent(n)}addEventListener(t,i,n){super.addEventListener(t,i,n)}removeEventListener(t,i,n){super.removeEventListener(t,i,n)}dispatchEvent(t){return super.dispatchEvent(t)}}const SUBGRAPH_INPUT_ID=-10,SUBGRAPH_OUTPUT_ID=-20,zeroUuid="00000000-0000-0000-0000-000000000000",randomStorage=new Uint32Array(31);function createUuidv4(){if(typeof(crypto==null?void 0:crypto.randomUUID)=="function")return crypto.randomUUID();if(typeof(crypto==null?void 0:crypto.getRandomValues)=="function"){const p=crypto.getRandomValues(randomStorage);let t=0;return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,i=>(Number(i)^p[t++]*3725290298461914e-24>>Number(i)*.25).toString(16))}return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,p=>(Number(p)^Math.random()*16>>Number(p)*.25).toString(16))}const B=class B{constructor(t,i,n,s,o,r,a){u(this,"id");u(this,"parentId");u(this,"type");u(this,"origin_id");u(this,"origin_slot");u(this,"target_id");u(this,"target_slot");u(this,"data");u(this,"_data");u(this,"_pos");u(this,"_last_time");u(this,"path");u(this,"_centreAngle");u(this,"_dragging");P(this,z);this.id=t,this.type=i,this.origin_id=n,this.origin_slot=s,this.target_id=o,this.target_slot=r,this.parentId=a,this._data=null,this._pos=new Float32Array(2)}get color(){return I(this,z)}set color(t){W(this,z,t===""?null:t)}get isFloatingOutput(){return this.origin_id===-1&&this.origin_slot===-1}get isFloatingInput(){return this.target_id===-1&&this.target_slot===-1}get isFloating(){return this.isFloatingOutput||this.isFloatingInput}get originIsIoNode(){return this.origin_id===SUBGRAPH_INPUT_ID}get targetIsIoNode(){return this.target_id===SUBGRAPH_OUTPUT_ID}static createFromArray(t){return new B(t[0],t[5],t[1],t[2],t[3],t[4])}static create(t){return new B(t.id,t.type,t.origin_id,t.origin_slot,t.target_id,t.target_slot,t.parentId)}static getReroutes(t,i){var n;return i.parentId?((n=t.reroutes.get(i.parentId))==null?void 0:n.getReroutes())??[]:[]}static getFirstReroute(t,i){return B.getReroutes(t,i).at(0)}static findNextReroute(t,i,n){var s;if(i.parentId)return(s=t.reroutes.get(i.parentId))==null?void 0:s.findNextReroute(n)}static getOriginNode(t,i){var s;const n=(s=t.links.get(i))==null?void 0:s.origin_id;return t.getNodeById(n)??void 0}static getTargetNode(t,i){var s;const n=(s=t.links.get(i))==null?void 0:s.target_id;return t.getNodeById(n)??void 0}static resolve(t,i){var n;return(n=i.getLink(t))==null?void 0:n.resolve(i)}static resolveMany(t,i){var s;const n=[];for(const o of t){const r=(s=i.getLink(o))==null?void 0:s.resolve(i);r&&n.push(r)}return n}resolve(t){var l,h;const i=this.target_id===-1?void 0:t.getNodeById(this.target_id)??void 0,n=i==null?void 0:i.inputs[this.target_slot],s=this.originIsIoNode?(l=t.inputNode)==null?void 0:l.slots[this.origin_slot]:void 0;if(s)return{inputNode:i,input:n,subgraphInput:s,link:this};const o=this.origin_id===-1?void 0:t.getNodeById(this.origin_id)??void 0,r=o==null?void 0:o.outputs[this.origin_slot],a=this.targetIsIoNode?(h=t.outputNode)==null?void 0:h.slots[this.target_slot]:void 0;return a?{outputNode:o,output:r,subgraphInput:void 0,subgraphOutput:a,link:this}:{inputNode:i,outputNode:o,input:n,output:r,subgraphInput:s,subgraphOutput:a,link:this}}configure(t){Array.isArray(t)?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot,this.parentId=t.parentId)}hasOrigin(t,i){return this.origin_id===t&&this.origin_slot===i}hasTarget(t,i){return this.target_id===t&&this.target_slot===i}toFloating(t,i){const n=this.asSerialisable();return n.id=-1,n.parentId=i,t==="input"?(n.origin_id=-1,n.origin_slot=-1):(n.target_id=-1,n.target_slot=-1),B.create(n)}disconnect(t,i){const n=B.getReroutes(t,this),s=n.at(-1);if(i==="output"&&(s==null?void 0:s.linkIds.size)===1&&s.floatingLinkIds.size===0||i==="input"&&s){const r=B.create(this);r.id=-1,i==="input"?(r.origin_id=-1,r.origin_slot=-1,s.floating={slotType:"input"}):(r.target_id=-1,r.target_slot=-1,s.floating={slotType:"output"}),t.addFloatingLink(r)}for(const r of n)r.linkIds.delete(this.id),!i&&!r.totalLinks&&t.reroutes.delete(r.id);if(t.links.delete(this.id),this.originIsIoNode&&t instanceof Subgraph){const r=t.inputs.at(this.origin_slot);if(!r)throw new Error("Invalid link - subgraph input not found");r.events.dispatch("input-disconnected",{input:r})}}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}asSerialisable(){const t={id:this.id,origin_id:this.origin_id,origin_slot:this.origin_slot,target_id:this.target_id,target_slot:this.target_slot,type:this.type};return this.parentId&&(t.parentId=this.parentId),t}};z=new WeakMap,u(B,"_drawDebug",!1);let LLink=B;var NodeSlotType=(p=>(p[p.INPUT=1]="INPUT",p[p.OUTPUT=2]="OUTPUT",p))(NodeSlotType||{}),RenderShape=(p=>(p[p.BOX=1]="BOX",p[p.ROUND=2]="ROUND",p[p.CIRCLE=3]="CIRCLE",p[p.CARD=4]="CARD",p[p.ARROW=5]="ARROW",p[p.GRID=6]="GRID",p[p.HollowCircle=7]="HollowCircle",p))(RenderShape||{}),CanvasItem=(p=>(p[p.Nothing=0]="Nothing",p[p.Node=1]="Node",p[p.Group=2]="Group",p[p.Reroute=4]="Reroute",p[p.Link=8]="Link",p[p.RerouteSlot=32]="RerouteSlot",p[p.SubgraphIoNode=64]="SubgraphIoNode",p[p.SubgraphIoSlot=128]="SubgraphIoSlot",p))(CanvasItem||{}),LinkDirection=(p=>(p[p.NONE=0]="NONE",p[p.UP=1]="UP",p[p.DOWN=2]="DOWN",p[p.LEFT=3]="LEFT",p[p.RIGHT=4]="RIGHT",p[p.CENTER=5]="CENTER",p))(LinkDirection||{}),LinkRenderType=(p=>(p[p.HIDDEN_LINK=-1]="HIDDEN_LINK",p[p.STRAIGHT_LINK=0]="STRAIGHT_LINK",p[p.LINEAR_LINK=1]="LINEAR_LINK",p[p.SPLINE_LINK=2]="SPLINE_LINK",p))(LinkRenderType||{}),LinkMarkerShape=(p=>(p[p.None=0]="None",p[p.Circle=1]="Circle",p[p.Arrow=2]="Arrow",p))(LinkMarkerShape||{}),TitleMode=(p=>(p[p.NORMAL_TITLE=0]="NORMAL_TITLE",p[p.NO_TITLE=1]="NO_TITLE",p[p.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",p[p.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",p))(TitleMode||{}),LGraphEventMode=(p=>(p[p.ALWAYS=0]="ALWAYS",p[p.ON_EVENT=1]="ON_EVENT",p[p.NEVER=2]="NEVER",p[p.ON_TRIGGER=3]="ON_TRIGGER",p[p.BYPASS=4]="BYPASS",p))(LGraphEventMode||{}),EaseFunction=(p=>(p.LINEAR="linear",p.EASE_IN_QUAD="easeInQuad",p.EASE_OUT_QUAD="easeOutQuad",p.EASE_IN_OUT_QUAD="easeInOutQuad",p))(EaseFunction||{}),Alignment=(p=>(p[p.None=0]="None",p[p.Top=1]="Top",p[p.Bottom=2]="Bottom",p[p.Middle=4]="Middle",p[p.Left=8]="Left",p[p.Right=16]="Right",p[p.Centre=32]="Centre",p[p.TopLeft=9]="TopLeft",p[p.TopCentre=33]="TopCentre",p[p.TopRight=17]="TopRight",p[p.MidLeft=12]="MidLeft",p[p.MidCentre=36]="MidCentre",p[p.MidRight=20]="MidRight",p[p.BottomLeft=10]="BottomLeft",p[p.BottomCentre=34]="BottomCentre",p[p.BottomRight=18]="BottomRight",p))(Alignment||{});function hasFlag(p,t){return(p&t)===t}function distance(p,t){return Math.sqrt((t[0]-p[0])*(t[0]-p[0])+(t[1]-p[1])*(t[1]-p[1]))}function dist2(p,t,i,n){return(i-p)*(i-p)+(n-t)*(n-t)}function isInRectangle(p,t,i,n,s,o){return p>=i&&p<i+s&&t>=n&&t<n+o}function isPointInRect(p,t){return p[0]>=t[0]&&p[0]<t[0]+t[2]&&p[1]>=t[1]&&p[1]<t[1]+t[3]}function isInRect(p,t,i){return p>=i[0]&&p<i[0]+i[2]&&t>=i[1]&&t<i[1]+i[3]}function isInsideRectangle(p,t,i,n,s,o){return i<p&&i+s>p&&n<t&&n+o>t}function overlapBounding(p,t){const i=p[0]+p[2],n=p[1]+p[3],s=t[0]+t[2],o=t[1]+t[3];return!(p[0]>s||p[1]>o||i<t[0]||n<t[1])}function getCentre(p){return[p[0]+p[2]*.5,p[1]+p[3]*.5]}function containsCentre(p,t){const i=t[0]+t[2]*.5,n=t[1]+t[3]*.5;return isInRect(i,n,p)}function containsRect(p,t){const i=p[0]+p[2],n=p[1]+p[3],s=t[0]+t[2],o=t[1]+t[3];return!(p[0]===t[0]&&p[1]===t[1]&&i===s&&n===o)&&p[0]<=t[0]&&p[1]<=t[1]&&i>=s&&n>=o}function findPointOnCurve(p,t,i,n,s,o=.5){const r=1-o,a=r*r*r,l=3*(r*r)*o,h=3*r*(o*o),c=o*o*o;p[0]=a*t[0]+l*n[0]+h*s[0]+c*i[0],p[1]=a*t[1]+l*n[1]+h*s[1]+c*i[1]}function createBounds(p,t=10){const i=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const n of p){const s=n.boundingRect;i[0]=Math.min(i[0],s[0]),i[1]=Math.min(i[1],s[1]),i[2]=Math.max(i[2],s[0]+s[2]),i[3]=Math.max(i[3],s[1]+s[3])}return i.every(n=>isFinite(n))?[i[0]-t,i[1]-t,i[2]-i[0]+2*t,i[3]-i[1]+2*t]:null}function snapPoint(p,t){return t?(p[0]=t*Math.round(p[0]/t),p[1]=t*Math.round(p[1]/t),!0):!1}function alignToContainer(p,t,[i,n,s,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?p[0]=i+r:hasFlag(t,Alignment.Right)?p[0]=i+s-r-p[2]:hasFlag(t,Alignment.Centre)&&(p[0]=i+s*.5-p[2]*.5),hasFlag(t,Alignment.Top)?p[1]=n+a:hasFlag(t,Alignment.Bottom)?p[1]=n+o-a-p[3]:hasFlag(t,Alignment.Middle)&&(p[1]=n+o*.5-p[3]*.5),p}function alignOutsideContainer(p,t,[i,n,s,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?p[0]=i-r-p[2]:hasFlag(t,Alignment.Right)?p[0]=i+s+r:hasFlag(t,Alignment.Centre)&&(p[0]=i+s*.5-p[2]*.5),hasFlag(t,Alignment.Top)?p[1]=n-a-p[3]:hasFlag(t,Alignment.Bottom)?p[1]=n+o+a:hasFlag(t,Alignment.Middle)&&(p[1]=n+o*.5-p[3]*.5),p}function clamp(p,t,i){return p<t?t:p>i?i:p}const ft=class ft extends Float64Array{constructor(i=0,n=0,s=0,o=0){super(4);P(this,$);P(this,ut);this[0]=i,this[1]=n,this[2]=s,this[3]=o}static from([i,n,s,o]){return new ft(i,n,s,o)}static fromCentre([i,n],s,o=s){const r=i-s*.5,a=n-o*.5;return new ft(r,a,s,o)}static ensureRect(i){return i instanceof ft?i:new ft(i[0],i[1],i[2],i[3])}subarray(i=0,n){const s=i<<3,o=n===void 0?n:n-i;return new Float64Array(this.buffer,s,o)}get pos(){return I(this,$)??W(this,$,this.subarray(0,2)),I(this,$)}set pos(i){this[0]=i[0],this[1]=i[1]}get size(){return I(this,ut)??W(this,ut,this.subarray(2,4)),I(this,ut)}set size(i){this[2]=i[0],this[3]=i[1]}get x(){return this[0]}set x(i){this[0]=i}get y(){return this[1]}set y(i){this[1]=i}get width(){return this[2]}set width(i){this[2]=i}get height(){return this[3]}set height(i){this[3]=i}get left(){return this[0]}set left(i){this[0]=i}get top(){return this[1]}set top(i){this[1]=i}get right(){return this[0]+this[2]}set right(i){this[0]=i-this[2]}get bottom(){return this[1]+this[3]}set bottom(i){this[1]=i-this[3]}get centreX(){return this[0]+this[2]*.5}get centreY(){return this[1]+this[3]*.5}updateTo(i){this[0]=i[0],this[1]=i[1],this[2]=i[2],this[3]=i[3]}containsXy(i,n){const[s,o,r,a]=this;return i>=s&&i<s+r&&n>=o&&n<o+a}containsPoint([i,n]){const[s,o,r,a]=this;return i>=s&&i<s+r&&n>=o&&n<o+a}containsRect(i){const{right:n,bottom:s}=this,o=i[0]+i[2],r=i[1]+i[3];return!(this.x===i[0]&&this.y===i[1]&&n===o&&s===r)&&this.x<=i[0]&&this.y<=i[1]&&n>=o&&s>=r}overlaps(i){return this.x<i[0]+i[2]&&this.y<i[1]+i[3]&&this.x+this.width>i[0]&&this.y+this.height>i[1]}findContainingCorner(i,n,s){if(this.isInTopLeftCorner(i,n,s))return"NW";if(this.isInTopRightCorner(i,n,s))return"NE";if(this.isInBottomLeftCorner(i,n,s))return"SW";if(this.isInBottomRightCorner(i,n,s))return"SE"}isInTopLeftCorner(i,n,s){return isInRectangle(i,n,this.x,this.y,s,s)}isInTopRightCorner(i,n,s){return isInRectangle(i,n,this.right-s,this.y,s,s)}isInBottomLeftCorner(i,n,s){return isInRectangle(i,n,this.x,this.bottom-s,s,s)}isInBottomRightCorner(i,n,s){return isInRectangle(i,n,this.right-s,this.bottom-s,s,s)}isInTopEdge(i,n,s){return isInRectangle(i,n,this.x,this.y,this.width,s)}isInBottomEdge(i,n,s){return isInRectangle(i,n,this.x,this.bottom-s,this.width,s)}isInLeftEdge(i,n,s){return isInRectangle(i,n,this.x,this.y,s,this.height)}isInRightEdge(i,n,s){return isInRectangle(i,n,this.right-s,this.y,s,this.height)}getCentre(){return[this.centreX,this.centreY]}getArea(){return this.width*this.height}getPerimeter(){return 2*(this.width+this.height)}getTopLeft(){return[this[0],this[1]]}getBottomRight(){return[this.right,this.bottom]}getSize(){return[this[2],this[3]]}getOffsetTo([i,n]){return[i-this[0],n-this[1]]}getOffsetFrom([i,n]){return[this[0]-i,this[1]-n]}resizeTopLeft(i,n){this[2]+=this[0]-i,this[3]+=this[1]-n,this[0]=i,this[1]=n}resizeBottomLeft(i,n){this[2]+=this[0]-i,this[3]=n-this[1],this[0]=i}resizeTopRight(i,n){this[2]=i-this[0],this[3]+=this[1]-n,this[1]=n}resizeBottomRight(i,n){this[2]=i-this[0],this[3]=n-this[1]}setWidthRightAnchored(i){const n=this[2];this[2]=i,this[0]+=n-i}setHeightBottomAnchored(i){const n=this[3];this[3]=i,this[1]+=n-i}clone(){return new ft(this[0],this[1],this[2],this[3])}toArray(){return this.export()}export(){return[this[0],this[1],this[2],this[3]]}_drawDebug(i,n="red"){const{strokeStyle:s,lineWidth:o}=i;try{i.strokeStyle=n,i.lineWidth=.5,i.beginPath(),i.strokeRect(this[0],this[1],this[2],this[3])}finally{i.strokeStyle=s,i.lineWidth=o}}};$=new WeakMap,ut=new WeakMap;let Rectangle=ft;function getNodeInputOnPos(p,t,i){var s,o,r;const{inputs:n}=p;if(n)for(const[a,l]of n.entries()){const h=p.getInputPos(a),d=20+((((s=l.label)==null?void 0:s.length)??((o=l.localized_name)==null?void 0:o.length)??((r=l.name)==null?void 0:r.length))||3)*7;if(isInRectangle(t,i,h[0]-10,h[1]-10,d,20))return{index:a,input:l,pos:h}}}function getNodeOutputOnPos(p,t,i){const{outputs:n}=p;if(n)for(const[s,o]of n.entries()){const r=p.getOutputPos(s);if(isInRectangle(t,i,r[0]-10,r[1]-10,40,20))return{index:s,output:o,pos:r}}}function isOverNodeInput(p,t,i,n){const s=getNodeInputOnPos(p,t,i);return s?(n&&(n[0]=s.pos[0],n[1]=s.pos[1]),s.index):-1}function isOverNodeOutput(p,t,i,n){const s=getNodeOutputOnPos(p,t,i);return s?(n&&(n[0]=s.pos[0],n[1]=s.pos[1]),s.index):-1}class NullGraphError extends Error{constructor(t="Attempted to access LGraph reference that was null or undefined.",i){super(t,{cause:i}),this.name="NullGraphError"}}class LGraphIcon{constructor({unicode:t,fontFamily:i="PrimeIcons",color:n="#e6c200",bgColor:s,fontSize:o=16,circlePadding:r=2,xOffset:a=0,yOffset:l=0}){u(this,"unicode");u(this,"fontFamily");u(this,"color");u(this,"bgColor");u(this,"fontSize");u(this,"circlePadding");u(this,"xOffset");u(this,"yOffset");this.unicode=t,this.fontFamily=i,this.color=n,this.bgColor=s,this.fontSize=o,this.circlePadding=r,this.xOffset=a,this.yOffset=l}draw(t,i,n){i+=this.xOffset,n+=this.yOffset;const{font:s,textBaseline:o,textAlign:r,fillStyle:a}=t;t.font=`${this.fontSize}px '${this.fontFamily}'`,t.textBaseline="middle",t.textAlign="center";const l=this.fontSize/2+this.circlePadding;this.bgColor&&(t.beginPath(),t.arc(i+l,n,l,0,2*Math.PI),t.fillStyle=this.bgColor,t.fill()),t.fillStyle=this.color,t.fillText(this.unicode,i+l,n),t.font=s,t.textBaseline=o,t.textAlign=r,t.fillStyle=a}}var BadgePosition=(p=>(p.TopLeft="top-left",p.TopRight="top-right",p))(BadgePosition||{});class LGraphBadge{constructor({text:t,fgColor:i="white",bgColor:n="#0F1F0F",fontSize:s=12,padding:o=6,height:r=20,cornerRadius:a=5,iconOptions:l,xOffset:h=0,yOffset:c=0}){u(this,"text");u(this,"fgColor");u(this,"bgColor");u(this,"fontSize");u(this,"padding");u(this,"height");u(this,"cornerRadius");u(this,"icon");u(this,"xOffset");u(this,"yOffset");this.text=t,this.fgColor=i,this.bgColor=n,this.fontSize=s,this.padding=o,this.height=r,this.cornerRadius=a,l&&(this.icon=new LGraphIcon(l)),this.xOffset=h,this.yOffset=c}get visible(){var t;return(((t=this.text)==null?void 0:t.length)??0)>0||!!this.icon}getWidth(t){if(!this.visible)return 0;const{font:i}=t;let n=0;this.icon&&(t.font=`${this.icon.fontSize}px '${this.icon.fontFamily}'`,n=t.measureText(this.icon.unicode).width+this.padding),t.font=`${this.fontSize}px sans-serif`;const s=this.text?t.measureText(this.text).width:0;return t.font=i,n+s+this.padding*2}draw(t,i,n){if(!this.visible)return;i+=this.xOffset,n+=this.yOffset;const{font:s,fillStyle:o,textBaseline:r,textAlign:a}=t;t.font=`${this.fontSize}px sans-serif`;const l=this.getWidth(t),h=0;t.fillStyle=this.bgColor,t.beginPath(),t.roundRect?t.roundRect(i+h,n,l,this.height,this.cornerRadius):t.rect(i+h,n,l,this.height),t.fill();let c=i+h+this.padding;const d=n+this.height/2;this.icon&&(this.icon.draw(t,c,d),c+=this.icon.fontSize+this.padding/2+4),this.text&&(t.fillStyle=this.fgColor,t.textBaseline="middle",t.textAlign="left",t.fillText(this.text,c,d+1)),t.font=s,t.fillStyle=o,t.textBaseline=r,t.textAlign=a}}class LGraphButton extends LGraphBadge{constructor(i){super(i);u(this,"name");u(this,"_last_area",new Rectangle);this.name=i.name}getWidth(i){if(!this.visible)return 0;const{font:n}=i;i.font=`${this.fontSize}px 'PrimeIcons'`;const s=this.text?i.measureText(this.text).width:0;return i.font=n,s}draw(i,n,s){if(!this.visible)return;const o=this.getWidth(i);this._last_area[0]=n+this.xOffset,this._last_area[1]=s+this.yOffset,this._last_area[2]=o,this._last_area[3]=this.height;const r=n+this.xOffset,a=s+this.yOffset,{font:l,fillStyle:h,textBaseline:c,textAlign:d}=i,f=i.fillStyle||"white";i.font=`${this.fontSize}px 'PrimeIcons'`,i.fillStyle=f,i.textBaseline="middle",i.textAlign="center";const g=r+o/2,m=a+this.height/2;this.text&&i.fillText(this.text,g,m),i.font=l,i.fillStyle=h,i.textBaseline=c,i.textAlign=d}isPointInside(i,n){return this._last_area.containsPoint([i,n])}}const ELLIPSIS="â€¦",TWO_DOT_LEADER="â€¥",ONE_DOT_LEADER="â€¤";var SlotType=(p=>(p.Array="array",p[p.Event=-1]="Event",p))(SlotType||{}),SlotShape=(p=>(p[p.Box=RenderShape.BOX]="Box",p[p.Arrow=RenderShape.ARROW]="Arrow",p[p.Grid=RenderShape.GRID]="Grid",p[p.Circle=RenderShape.CIRCLE]="Circle",p[p.HollowCircle=RenderShape.HollowCircle]="HollowCircle",p))(SlotShape||{}),SlotDirection=(p=>(p[p.Up=LinkDirection.UP]="Up",p[p.Right=LinkDirection.RIGHT]="Right",p[p.Down=LinkDirection.DOWN]="Down",p[p.Left=LinkDirection.LEFT]="Left",p))(SlotDirection||{}),LabelPosition=(p=>(p.Left="left",p.Right="right",p))(LabelPosition||{});function strokeShape(p,t,{shape:i=RenderShape.BOX,round_radius:n,title_height:s,title_mode:o=TitleMode.NORMAL_TITLE,color:r,padding:a=6,collapsed:l=!1,lineWidth:h=1}={}){if(n??(n=LiteGraph.ROUND_RADIUS),r??(r=LiteGraph.NODE_BOX_OUTLINE_COLOR),o===TitleMode.TRANSPARENT_TITLE){const y=s??LiteGraph.NODE_TITLE_HEIGHT;t[1]-=y,t[3]+=y}const{lineWidth:c,strokeStyle:d}=p;p.lineWidth=h,p.globalAlpha=.8,p.strokeStyle=r,p.beginPath();const[f,g,m,_]=t;switch(i){case RenderShape.BOX:{p.rect(f-a,g-a,m+2*a,_+2*a);break}case RenderShape.ROUND:case RenderShape.CARD:{const y=n+a,L=i===RenderShape.CARD&&l||i===RenderShape.ROUND?[y]:[y,2,y,2];p.roundRect(f-a,g-a,m+2*a,_+2*a,L);break}case RenderShape.CIRCLE:{const y=f+m/2,b=g+_/2,L=Math.max(m,_)/2+a;p.arc(y,b,L,0,Math.PI*2);break}}p.stroke(),p.lineWidth=c,p.strokeStyle=d,p.globalAlpha=1}function truncateTextToWidth(p,t,i){if(!(i>0))return"";if(p.measureText(t).width<=i)return t;const s=p.measureText(ELLIPSIS).width*.75;if(s>i)return p.measureText(TWO_DOT_LEADER).width*.75<i?TWO_DOT_LEADER:p.measureText(ONE_DOT_LEADER).width*.75<i?ONE_DOT_LEADER:"";let o=0,r=t.length,a=0;for(;o<=r;){const l=Math.floor((o+r)*.5);if(l===0){o=l+1;continue}const h=t.substring(0,l);p.measureText(h).width+s<=i?(a=l,o=l+1):r=l-1}return a===0?ELLIPSIS:t.substring(0,a)+ELLIPSIS}function drawTextInArea({ctx:p,text:t,area:i,align:n="left"}){const{left:s,right:o,bottom:r,width:a,centreX:l}=i;if(p.measureText(t).width<=a){p.textAlign=n;const f=n==="left"?s:n==="right"?o:l;p.fillText(t,f,r);return}const c=truncateTextToWidth(p,t,a);if(c.length===0)return;p.textAlign="left",p.fillText(c.slice(0,-1),s,r),p.rect(s,r,a,1),p.textAlign="right";const d=c.at(-1);p.fillText(d,o,r,p.measureText(d).width*.75)}class SlotBase{constructor(t,i,n){u(this,"name");u(this,"localized_name");u(this,"label");u(this,"type");u(this,"dir");u(this,"removable");u(this,"shape");u(this,"color_off");u(this,"color_on");u(this,"locked");u(this,"nameLocked");u(this,"widget");u(this,"_floatingLinks");u(this,"hasErrors");u(this,"boundingRect");this.name=t,this.type=i,this.boundingRect=n??new Rectangle}renderingColor(t){return this.isConnected?this.color_on||t.getConnectedColor(this.type):this.color_off||t.getDisconnectedColor(this.type)}}class NodeSlot extends SlotBase{constructor(i,n){const s=i,{boundingRect:o,name:r,type:a,_listenerController:l,...h}=s,c=o?Rectangle.ensureRect(o):new Rectangle;super(r,a,c);P(this,be);u(this,"pos");P(this,Xt);Object.assign(this,h),W(this,Xt,n)}get node(){return I(this,Xt)}get highlightColor(){return LiteGraph.NODE_TEXT_HIGHLIGHT_COLOR??LiteGraph.NODE_SELECTED_TITLE_COLOR??LiteGraph.NODE_TEXT_COLOR}get renderingLabel(){return this.label||this.localized_name||this.name||""}draw(i,{colorContext:n,labelPosition:s=LabelPosition.Right,lowQuality:o=!1,highlight:r=!1,doStroke:a=!1}){const l=i.fillStyle,h=i.strokeStyle,c=i.lineWidth,d=r?this.highlightColor:LiteGraph.NODE_TEXT_COLOR,f=I(this,be,si),g=this.type,m=g===SlotType.Array?SlotShape.Grid:this.shape;i.beginPath();let _=!0;if(i.fillStyle=this.renderingColor(n),i.lineWidth=1,g===SlotType.Event||m===SlotShape.Box)i.rect(f[0]-6+.5,f[1]-5+.5,14,10);else if(m===SlotShape.Arrow)i.moveTo(f[0]+8,f[1]+.5),i.lineTo(f[0]-4,f[1]+6+.5),i.lineTo(f[0]-4,f[1]-6+.5),i.closePath();else if(m===SlotShape.Grid){for(let T=0;T<3;T++)for(let S=0;S<3;S++)i.rect(f[0]-4+T*3,f[1]-4+S*3,2,2);a=!1}else if(o)i.rect(f[0]-4,f[1]-4,8,8);else{let b;m===SlotShape.HollowCircle?(_=!1,a=!0,i.lineWidth=3,i.strokeStyle=i.fillStyle,b=r?4:3):b=r?5:4,i.arc(f[0],f[1],b,0,Math.PI*2)}if(_&&i.fill(),!o&&a&&i.stroke(),!(o||this.isWidgetInputSlot)){const b=this.renderingLabel;b&&(i.fillStyle=d,s===LabelPosition.Right?this.dir==LinkDirection.UP?i.fillText(b,f[0],f[1]-10):i.fillText(b,f[0]+10,f[1]+5):this.dir==LinkDirection.DOWN?i.fillText(b,f[0],f[1]-8):i.fillText(b,f[0]-10,f[1]+5))}this.hasErrors&&(i.lineWidth=2,i.strokeStyle="red",i.beginPath(),i.arc(f[0],f[1],12,0,Math.PI*2),i.stroke()),i.fillStyle=l,i.strokeStyle=h,i.lineWidth=c}drawCollapsed(i){const[n,s]=this.collapsedPos,{fillStyle:o}=i;i.fillStyle="#686",i.beginPath(),this.type===SlotType.Event||this.shape===RenderShape.BOX?i.rect(n-7+.5,s-4,14,8):this.shape===RenderShape.ARROW?(this instanceof NodeInputSlot?(i.moveTo(n+8,s),i.lineTo(n-4,s-4),i.lineTo(n-4,s+4)):(i.moveTo(n+6,s),i.lineTo(n-6,s-4),i.lineTo(n-6,s+4)),i.closePath()):i.arc(n,s,4,0,Math.PI*2),i.fill(),i.fillStyle=o}}be=new WeakSet,si=function(){const i=this.node.pos,{boundingRect:n}=this,s=n[3];return getCentre([n[0]-i[0],n[1]-i[1],s,s])},Xt=new WeakMap;const Z=class Z{constructor(t,i){u(this,"id");u(this,"color");u(this,"title");u(this,"font");u(this,"font_size",LiteGraph.DEFAULT_GROUP_FONT||24);u(this,"_bounding",new Float32Array([10,10,Z.minWidth,Z.minHeight]));u(this,"_pos",this._bounding.subarray(0,2));u(this,"_size",this._bounding.subarray(2,4));u(this,"_nodes",[]);u(this,"_children",new Set);u(this,"graph");u(this,"flags",{});u(this,"selected");u(this,"isPointInside",LGraphNode.prototype.isPointInside);u(this,"setDirtyCanvas",LGraphNode.prototype.setDirtyCanvas);this.id=i??-1,this.title=t||"Group";const{pale_blue:n}=LGraphCanvas.node_colors;this.color=n?n.groupcolor:"#AAA"}setColorOption(t){t==null?delete this.color:this.color=t.groupcolor}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.groupcolor===this.color)??null}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=Math.max(Z.minWidth,t[0]),this._size[1]=Math.max(Z.minHeight,t[1]))}get boundingRect(){return this._bounding}get nodes(){return this._nodes}get titleHeight(){return this.font_size*1.4}get children(){return this._children}get pinned(){return!!this.flags.pinned}pin(t){(t===void 0?!this.pinned:t)?this.flags.pinned=!0:delete this.flags.pinned}unpin(){this.pin(!1)}configure(t){this.id=t.id,this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.flags=t.flags||this.flags,t.font_size&&(this.font_size=t.font_size)}serialize(){const t=this._bounding;return{id:this.id,title:this.title,bounding:[...t],color:this.color,font_size:this.font_size,flags:this.flags}}draw(t,i){const{padding:n,resizeLength:s,defaultColour:o}=Z,r=this.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,[a,l]=this._pos,[h,c]=this._size,d=this.color||o;i.globalAlpha=.25*t.editor_alpha,i.fillStyle=d,i.strokeStyle=d,i.beginPath(),i.rect(a+.5,l+.5,h,r*1.4),i.fill(),i.fillStyle=d,i.strokeStyle=d,i.beginPath(),i.rect(a+.5,l+.5,h,c),i.fill(),i.globalAlpha=t.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(a+h,l+c),i.lineTo(a+h-s,l+c),i.lineTo(a+h,l+c-s),i.fill(),i.font=`${r}px ${LiteGraph.GROUP_FONT}`,i.textAlign="left",i.fillText(this.title+(this.pinned?"ðŸ“Œ":""),a+n,l+r),LiteGraph.highlight_selected_group&&this.selected&&strokeShape(i,this._bounding,{title_height:this.titleHeight,padding:n})}resize(t,i){return this.pinned?!1:(this._size[0]=Math.max(Z.minWidth,t),this._size[1]=Math.max(Z.minHeight,i),!0)}move(t,i,n=!1){if(!this.pinned&&(this._pos[0]+=t,this._pos[1]+=i,n!==!0))for(const s of this._children)s.move(t,i)}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}recomputeInsideNodes(){if(!this.graph)throw new NullGraphError;const{nodes:t,reroutes:i,groups:n}=this.graph,s=this._children;this._nodes.length=0,s.clear();for(const o of t)containsCentre(this._bounding,o.boundingRect)&&(this._nodes.push(o),s.add(o));for(const o of i.values())isPointInRect(o.pos,this._bounding)&&s.add(o);for(const o of n)containsRect(this._bounding,o._bounding)&&s.add(o);n.sort((o,r)=>o===this?s.has(r)?-1:0:r===this&&s.has(o)?1:0)}resizeTo(t,i=10){const n=createBounds(t,i);n!==null&&(this.pos[0]=n[0],this.pos[1]=n[1]-this.titleHeight,this.size[0]=n[2],this.size[1]=n[3]+this.titleHeight)}addNodes(t,i=10){!this._nodes&&t.length===0||this.resizeTo([...this.children,...this._nodes,...t],i)}getMenuOptions(){return[{content:this.pinned?"Unpin":"Pin",callback:()=>{this.pinned?this.unpin():this.pin(),this.setDirtyCanvas(!1,!0)}},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}isPointInTitlebar(t,i){const n=this.boundingRect;return isInRectangle(t,i,n[0],n[1],n[2],this.titleHeight)}isInResize(t,i){const n=this.boundingRect,s=n[0]+n[2],o=n[1]+n[3];return t<s&&i<o&&t-s+(i-o)>-Z.resizeLength}};u(Z,"minWidth",140),u(Z,"minHeight",80),u(Z,"resizeLength",10),u(Z,"padding",4),u(Z,"defaultColour","#335");let LGraphGroup=Z;const X=class X{constructor(t,i,n,s,o,r){P(this,gt);P(this,At,new Float32Array(8));P(this,q);P(this,nt);u(this,"floating");P(this,it,I(this,At).subarray(0,2));u(this,"selected");u(this,"linkIds");u(this,"floatingLinkIds");u(this,"cos",0);u(this,"sin",0);u(this,"controlPoint",I(this,At).subarray(4,6));u(this,"path");u(this,"_centreAngle");u(this,"_pos",I(this,At).subarray(6,8));u(this,"_dragging");u(this,"_colour");P(this,Yt,-1/0);P(this,vt,new RerouteSlot(this,!0));P(this,kt,new RerouteSlot(this,!1));this.id=t,W(this,q,new WeakRef(i)),this.parentId=s,n&&(this.pos=n),this.linkIds=new Set(o),this.floatingLinkIds=new Set(r)}static get slotOffset(){const t=X.slotRadius*.33;return X.radius+t+X.slotRadius}get parentId(){return I(this,nt)}set parentId(t){t!==this.id&&this.getReroutes()!==null&&W(this,nt,t)}get parent(){var t;return(t=I(this,q).deref())==null?void 0:t.getReroute(I(this,nt))}get pos(){return I(this,it)}set pos(t){if(!((t==null?void 0:t.length)>=2))throw new TypeError("Reroute.pos is an x,y point, and expects an indexable with at least two values.");I(this,it)[0]=t[0],I(this,it)[1]=t[1]}get boundingRect(){const{radius:t}=X,[i,n]=I(this,it);return[i-t,n-t,2*t,2*t]}get totalLinks(){return this.linkIds.size+this.floatingLinkIds.size}get colour(){return this._colour??"#18184d"}get isSlotHovered(){return this.isInputHovered||this.isOutputHovered}get isInputHovered(){return I(this,vt).hovering}get isOutputHovered(){return I(this,kt).hovering}get firstLink(){var i;const t=this.linkIds.values().next().value;return t===void 0||(i=I(this,q).deref())==null?void 0:i.links.get(t)}get firstFloatingLink(){var i;const t=this.floatingLinkIds.values().next().value;return t===void 0||(i=I(this,q).deref())==null?void 0:i.floatingLinks.get(t)}get origin_id(){var t;return(t=this.firstLink)==null?void 0:t.origin_id}get origin_slot(){var t;return(t=this.firstLink)==null?void 0:t.origin_slot}update(t,i,n,s){this.parentId=t,i&&(this.pos=i),n&&(this.linkIds=new Set(n)),this.floating=s}validateLinks(t,i){const{linkIds:n,floatingLinkIds:s}=this;for(const o of n)t.has(o)||n.delete(o);for(const o of s)i.has(o)||s.delete(o);return n.size>0||s.size>0}getReroutes(t=new Set){var s;if(I(this,nt)===void 0)return[this];if(t.has(this))return null;t.add(this);const i=(s=I(this,q).deref())==null?void 0:s.reroutes.get(I(this,nt));if(!i)return W(this,nt,void 0),[this];const n=i.getReroutes(t);return n==null||n.push(this),n}findNextReroute(t,i=new Set){var n,s;if(I(this,nt)===t)return this;if(i.has(this))return null;if(i.add(this),I(this,nt)!==void 0)return(s=(n=I(this,q).deref())==null?void 0:n.reroutes.get(I(this,nt)))==null?void 0:s.findNextReroute(t,i)}findSourceOutput(){var n;const t=this.firstLink??this.firstFloatingLink;if(!t)return;const i=(n=I(this,q).deref())==null?void 0:n.getNodeById(t.origin_id);if(i)return{node:i,output:i.outputs[t.origin_slot]}}findTargetInputs(){const t=I(this,q).deref();if(!t)return;const i=[];return n(t,this.linkIds,t.links),n(t,this.floatingLinkIds,t.floatingLinks),i;function n(s,o,r){for(const a of o){const l=r.get(a);if(!l)continue;const h=s.getNodeById(l.target_id),c=h==null?void 0:h.inputs[l.target_slot];c&&i.push({node:h,input:c,link:l})}}}getFloatingLinks(t){var o;const i=(o=I(this,q).deref())==null?void 0:o.floatingLinks;if(!i)return;const n=t==="input"?"origin_id":"target_id",s=[];for(const r of this.floatingLinkIds){const a=i.get(r);(a==null?void 0:a[n])===-1&&s.push(a)}return s}setFloatingLinkOrigin(t,i,n){var r,a,l;const s=I(this,q).deref(),o=this.getFloatingLinks("output");if(!o)throw new Error("[setFloatingLinkOrigin]: Invalid network.");if(o.length){i._floatingLinks??(i._floatingLinks=new Set);for(const h of o)i._floatingLinks.add(h),(l=(a=(r=s==null?void 0:s.getNodeById(h.origin_id))==null?void 0:r.outputs[h.origin_slot])==null?void 0:a._floatingLinks)==null||l.delete(h),h.origin_id=t.id,h.origin_slot=n}}move(t,i){I(this,it)[0]+=t,I(this,it)[1]+=i}snapToGrid(t){if(!t)return!1;const{pos:i}=this;return i[0]=t*Math.round(i[0]/t),i[1]=t*Math.round(i[1]/t),!0}removeAllFloatingLinks(){for(const t of this.floatingLinkIds)this.removeFloatingLink(t)}removeFloatingLink(t){const i=I(this,q).deref();if(!i)return;const n=i.floatingLinks.get(t);if(!n){console.warn(`[Reroute.removeFloatingLink] Floating link not found: ${t}, ignoring and discarding ID.`),this.floatingLinkIds.delete(t);return}i.removeFloatingLink(n)}removeLink(t){const i=I(this,q).deref();if(!i)return;const n=i.floatingLinks.get(t.id);t===n?this.floatingLinkIds.delete(t.id):this.linkIds.delete(t.id)}remove(){const t=I(this,q).deref();t&&t.removeReroute(this.id)}calculateAngle(t,i,n){if(!(t>I(this,Yt)))return;W(this,Yt,t);const{id:s,pos:o}=this,r=[];let a=0;if(m(this.linkIds,i.links),m(this.floatingLinkIds,i.floatingLinks),!r.length){this.cos=0,this.sin=0,this.controlPoint[0]=0,this.controlPoint[1]=0;return}a/=r.length;const l=Math.atan2(I(this,it)[1]-n[1],I(this,it)[0]-n[0]);let h=(l-a)*.5;Math.abs(h)>Math.PI*.5&&(h+=Math.PI);const c=Math.min(X.maxSplineOffset,distance(n,I(this,it))*.25),d=l-h,f=Math.cos(d),g=Math.sin(d);this.cos=f,this.sin=g,this.controlPoint[0]=c*-f,this.controlPoint[1]=c*-g;function m(_,y){for(const b of _){const L=y.get(b),k=getNextPos(i,L,s);if(!k)continue;const T=getDirection(o,k);r.push(T),a+=T}}}draw(t,i){const{globalAlpha:n}=t,{pos:s}=this;if(t.beginPath(),t.arc(s[0],s[1],X.radius,0,2*Math.PI),this.linkIds.size===0&&(t.fillStyle=i??"#797979",t.fill(),t.globalAlpha=n*.33),t.fillStyle=this.colour,t.lineWidth=X.radius*.1,t.strokeStyle="rgb(0,0,0,0.5)",t.fill(),t.stroke(),t.fillStyle="#ffffff55",t.strokeStyle="rgb(0,0,0,0.3)",t.beginPath(),t.arc(s[0],s[1],X.radius*.8,0,2*Math.PI),t.fill(),t.stroke(),this.selected&&(t.strokeStyle="#fff",t.beginPath(),t.arc(s[0],s[1],X.radius*1.2,0,2*Math.PI),t.stroke()),X.drawIdBadge){const o=new LGraphBadge({text:this.id.toString()}),r=s[0]-o.getWidth(t)*.5,a=s[1]-o.height-X.radius-2;o.draw(t,r,a)}t.globalAlpha=n}drawSlots(t){I(this,vt).draw(t),I(this,kt).draw(t)}drawHighlight(t,i){const{pos:n}=this,{strokeStyle:s,lineWidth:o}=t;t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(n[0],n[1],X.radius*1.5,0,2*Math.PI),t.stroke(),t.strokeStyle=s,t.lineWidth=o}updateVisibility(t){const i=I(this,vt),n=I(this,kt);i.dirty=!1,n.dirty=!1;const{firstFloatingLink:s}=this,o=!!this.firstLink,r=o||(s==null?void 0:s.isFloatingOutput),a=o||(s==null?void 0:s.isFloatingInput);if((r||a)&&isPointInRect(t,I(this,gt,Fe))){const h=O(this,gt,Me).call(this,t);r&&i.update(t,h),a&&n.update(t,h)}else this.hideSlots();return i.dirty||n.dirty}hideSlots(){I(this,vt).hide(),I(this,kt).hide()}containsPoint(t){return isPointInRect(t,I(this,gt,Fe))&&O(this,gt,Me).call(this,t)}asSerialisable(){const{id:t,parentId:i,pos:n,linkIds:s}=this;return{id:t,parentId:i,pos:[n[0],n[1]],linkIds:[...s],floating:this.floating?{slotType:this.floating.slotType}:void 0}}};At=new WeakMap,q=new WeakMap,nt=new WeakMap,it=new WeakMap,gt=new WeakSet,Fe=function(){const t=2*X.slotOffset,i=2*Math.max(X.radius,X.slotRadius),[n,s]=I(this,it);return[n-t,s-i,2*t,2*i]},Yt=new WeakMap,vt=new WeakMap,kt=new WeakMap,Me=function(t){return distance(this.pos,t)<=X.radius},u(X,"radius",10),u(X,"maxSplineOffset",80),u(X,"drawIdBadge",!1),u(X,"slotRadius",5);let Reroute=X;class RerouteSlot{constructor(t,i){P(this,Gt);P(this,jt);u(this,"dirty",!1);P(this,Pt,!1);P(this,xt,!1);W(this,Gt,t),W(this,jt,i?-1:1)}get pos(){const[t,i]=I(this,Gt).pos;return[t+Reroute.slotOffset*I(this,jt),i]}get hovering(){return I(this,Pt)}set hovering(t){Object.is(I(this,Pt),t)||(W(this,Pt,t),this.dirty=!0)}get showOutline(){return I(this,xt)}set showOutline(t){Object.is(I(this,xt),t)||(W(this,xt,t),this.dirty=!0)}update(t,i){if(i)this.hovering=!1,this.showOutline=!0;else{const n=distance(this.pos,t);this.hovering=n<=2*Reroute.slotRadius,this.showOutline=n<=5*Reroute.slotRadius}}hide(){this.hovering=!1,this.showOutline=!1}draw(t){const{fillStyle:i,strokeStyle:n,lineWidth:s}=t,{showOutline:o,hovering:r,pos:[a,l]}=this;if(o)try{t.fillStyle=r?I(this,Gt).colour:"rgba(127,127,127,0.3)",t.strokeStyle="rgb(0,0,0,0.5)",t.lineWidth=1,t.beginPath(),t.arc(a,l,Reroute.slotRadius,0,2*Math.PI),t.fill(),t.stroke()}finally{t.fillStyle=i,t.strokeStyle=n,t.lineWidth=s}}}Gt=new WeakMap,jt=new WeakMap,Pt=new WeakMap,xt=new WeakMap;function getNextPos(p,t,i){var s,o;if(!t)return;const n=(s=LLink.findNextReroute(p,t,i))==null?void 0:s.pos;if(n)return n;if(!(t.target_id===-1||t.target_slot===-1))return(o=p.getNodeById(t.target_id))==null?void 0:o.getInputPos(t.target_slot)}function getDirection(p,t){return Math.atan2(t[1]-p[1],t[0]-p[0])}function stringOrEmpty(p){return p==null?"":String(p)}function parseSlotTypes(p){return p==""||p=="0"?["*"]:String(p).toLowerCase().split(",")}function nextUniqueName(p,t=[]){let i=1;const n=p;for(;t.includes(p);)p=`${n}_${i++}`;return p}const we=class we{constructor(t,i){P(this,Ft,0);P(this,Mt,0);P(this,Kt,0);P(this,qt,0);u(this,"minWidth",0);u(this,"minHeight",0);u(this,"maxWidth",1/0);u(this,"maxHeight",1/0);this.desiredWidth=t,this.desiredHeight=i}get width(){return I(this,Ft)}get height(){return I(this,Mt)}get desiredWidth(){return I(this,Kt)}set desiredWidth(t){W(this,Kt,t),W(this,Ft,clamp(t,this.minWidth,this.maxWidth))}get desiredHeight(){return I(this,qt)}set desiredHeight(t){W(this,qt,t),W(this,Mt,clamp(t,this.minHeight,this.maxHeight))}static fromSize(t){return new we(t[0],t[1])}static fromRect(t){return new we(t[2],t[3])}setSize(t){this.desiredWidth=t[0],this.desiredHeight=t[1]}setValues(t,i){this.desiredWidth=t,this.desiredHeight=i}toSize(){return[I(this,Ft),I(this,Mt)]}};Ft=new WeakMap,Mt=new WeakMap,Kt=new WeakMap,qt=new WeakMap;let ConstrainedSize=we;const Bt=class Bt extends SlotBase{constructor(i,n){super(i.name,i.type);P(this,Wt,new Float32Array(2));u(this,"measurement",new ConstrainedSize(Bt.defaultHeight,Bt.defaultHeight));u(this,"id");u(this,"parent");u(this,"type");u(this,"linkIds",[]);u(this,"boundingRect",new Rectangle(0,0,0,Bt.defaultHeight));u(this,"isPointerOver",!1);Object.assign(this,i),this.id=i.id??createUuidv4(),this.type=i.type,this.parent=n}static get defaultHeight(){return LiteGraph.NODE_SLOT_HEIGHT}get pos(){return I(this,Wt)}set pos(i){!i||i.length<2||(I(this,Wt)[0]=i[0],I(this,Wt)[1]=i[1])}get isConnected(){return this.linkIds.length>0}get displayName(){return this.label??this.localized_name??this.name}containsPoint(i){return this.boundingRect.containsPoint(i)}onPointerMove(i){this.isPointerOver=this.boundingRect.containsXy(i.canvasX,i.canvasY)}getLinks(){const i=[],{subgraph:n}=this.parent;for(const s of this.linkIds){const o=n.getLink(s);o&&i.push(o)}return i}decrementSlots(i){const{links:n}=this.parent.subgraph,s=i==="inputs"?"origin_slot":"target_slot";for(const o of this.linkIds){const r=n.get(o);r?r[s]--:console.warn("decrementSlots: link ID not found",o)}}measure(){var s;const i=((s=LGraphCanvas._measureText)==null?void 0:s.call(LGraphCanvas,this.displayName))??0,{defaultHeight:n}=Bt;return this.measurement.setValues(i+n,n),this.measurement.toSize()}disconnect(){const{subgraph:i}=this.parent;for(const n of this.linkIds)i.removeLink(n);this.linkIds.length=0}draw({ctx:i,colorContext:n,lowQuality:s,fromSlot:o,editorAlpha:r=1}){const a=this.shape,{isPointerOver:l,pos:[h,c]}=this,d=o?this.isValidTarget(o):!0,f=!o||d,g=f&&l,m=i.globalAlpha;i.globalAlpha=f?r:.4*r,i.beginPath();const _=this.renderingColor(n);if(s)i.fillStyle=_,i.rect(h-4,c-4,8,8),i.fill();else if(a===SlotShape.HollowCircle){i.lineWidth=3,i.strokeStyle=_;const y=g?4:3;i.arc(h,c,y,0,Math.PI*2),i.stroke()}else{i.fillStyle=_;const y=g?5:4;i.arc(h,c,y,0,Math.PI*2),i.fill()}if(this.displayName){const[y,b]=this.labelPos;i.fillStyle=g?"white":LiteGraph.NODE_TEXT_COLOR||"#AAA",i.fillText(this.displayName,y,b)}i.globalAlpha=m}asSerialisable(){const{id:i,name:n,type:s,linkIds:o,localized_name:r,label:a,dir:l,shape:h,color_off:c,color_on:d,pos:f}=this;return{id:i,name:n,type:s,linkIds:o,localized_name:r,label:a,dir:l,shape:h,color_off:c,color_on:d,pos:f}}};Wt=new WeakMap;let SubgraphSlot=Bt;class SubgraphOutput extends SubgraphSlot{connect(t,i,n){var c,d,f;const{subgraph:s}=this.parent;if(!LiteGraph.isValidConnection(t.type,this.type))return;const o=i.outputs.indexOf(t);if(o===-1)throw new Error("Slot is not an output of the given node");if(((c=i.onConnectOutput)==null?void 0:c.call(i,o,this.type,this,this.parent,-1))===!1)return;const r=this.getLinks().at(0);if(r!=null){s.beforeChange(),r.disconnect(s,"input");const m=(d=r.resolve(s).output)==null?void 0:d.links;m&&removeFromArray(m,r.id)}const a=new LLink(++s.state.lastLinkId,t.type,i.id,o,this.parent.id,this.parent.slots.indexOf(this),n);s._links.set(a.id,a),this.linkIds[0]=a.id,t.links??(t.links=[]),t.links.push(a.id);const l=LLink.getReroutes(s,a);for(const g of l)g.linkIds.add(a.id),g.floating&&delete g.floating,g._dragging=void 0;const h=l.at(-1);if(h)for(const g of h.floatingLinkIds){const m=s.floatingLinks.get(g);(m==null?void 0:m.parentId)===h.id&&s.removeFloatingLink(m)}return s._version++,(f=i.onConnectionsChange)==null||f.call(i,NodeSlotType.OUTPUT,o,!0,a,t),s.afterChange(),a}get labelPos(){const[t,i,,n]=this.boundingRect;return[t+n,i+n*.5]}arrange(t){const[i,n,s,o]=t,{boundingRect:r,pos:a}=this;r[0]=i,r[1]=n,r[2]=s,r[3]=o,a[0]=i+o*.5,a[1]=n+o*.5}isValidTarget(t){return isNodeSlot(t)?"links"in t&&LiteGraph.isValidConnection(t.type,this.type):isSubgraphInput(t)?LiteGraph.isValidConnection(t.type,this.type):!1}}class EmptySubgraphOutput extends SubgraphOutput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,n){const{subgraph:s}=this.parent,o=s.outputs.map(l=>l.name),r=nextUniqueName(t.name,o);return s.addOutput(r,String(t.type)).connect(t,i,n)}get labelPos(){const[t,i,,n]=this.boundingRect;return[t,i+n*.5]}}const Ht=class Ht{constructor(t){P(this,zt);P(this,Zt,new Rectangle);u(this,"selected",!1);u(this,"pinned",!1);u(this,"removable",!1);u(this,"isPointerOver",!1);this.subgraph=t}get boundingRect(){return I(this,Zt)}get pos(){return this.boundingRect.pos}set pos(t){this.boundingRect.pos=t}get size(){return this.boundingRect.size}set size(t){this.boundingRect.size=t}get sideLineWidth(){return this.isPointerOver?2.5:2}get sideStrokeStyle(){return this.isPointerOver?"white":"#efefef"}move(t,i){this.pos[0]+=t,this.pos[1]+=i}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}containsPoint(t){return this.boundingRect.containsPoint(t)}onPointerMove(t){const i=this.boundingRect.containsXy(t.canvasX,t.canvasY);let n=i?CanvasItem.SubgraphIoNode:CanvasItem.Nothing;if(i){this.isPointerOver||this.onPointerEnter();for(const s of this.allSlots)s.onPointerMove(t),s.isPointerOver&&(n|=CanvasItem.SubgraphIoSlot)}else this.isPointerOver&&this.onPointerLeave();return n}onPointerEnter(){this.isPointerOver=!0}onPointerLeave(){this.isPointerOver=!1;for(const t of this.slots)t.isPointerOver=!1}getSlotInPosition(t,i){for(const n of this.allSlots)if(n.boundingRect.containsXy(t,i))return n}showSlotContextMenu(t,i){const n=O(this,zt,oi).call(this,t);n.length>0&&new LiteGraph.ContextMenu(n,{event:i,title:t.name||"Subgraph Output",callback:s=>{O(this,zt,ri).call(this,s,t,i)}})}arrange(){const{minWidth:t,roundedRadius:i}=Ht,[,n]=this.boundingRect,s=this.slotAnchorX,{size:o}=this;let r=t,a=n+i;for(const l of this.allSlots){const[h,c]=l.measure();l.arrange([s,a,h,c]),a+=c,h>r&&(r=h)}o[0]=r+2*i,o[1]=a-n+i}draw(t,i,n,s){const{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:h}=t;this.drawProtected(t,i,n,s),Object.assign(t,{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:h})}drawSlots(t,i,n,s){t.fillStyle="#AAA",t.font="12px Arial",t.textBaseline="middle";for(const o of this.allSlots)o.draw({ctx:t,colorContext:i,fromSlot:n,editorAlpha:s})}configure(t){I(this,Zt).set(t.bounding),this.pinned=t.pinned??!1}asSerialisable(){return{id:this.id,bounding:this.boundingRect.export(),pinned:this.pinned?!0:void 0}}};Zt=new WeakMap,zt=new WeakSet,oi=function(t){const i=[];return t!==this.emptySlot&&t.linkIds.length>0&&i.push({content:"Disconnect Links",value:"disconnect"}),t!==this.emptySlot&&i.push({content:"Remove Slot",value:"remove"},{content:"Rename Slot",value:"rename"}),i},ri=function(t,i,n){switch(t.value){case"disconnect":i.disconnect();break;case"remove":i!==this.emptySlot&&this.removeSlot(i);break;case"rename":i!==this.emptySlot&&this.subgraph.canvasAction(s=>s.prompt("Slot name",i.name,o=>{o&&this.renameSlot(i,o)},n));break}this.subgraph.setDirtyCanvas(!0)},u(Ht,"margin",10),u(Ht,"minWidth",100),u(Ht,"roundedRadius",10);let SubgraphIONodeBase=Ht;class SubgraphOutputNode extends SubgraphIONodeBase{constructor(){super(...arguments);u(this,"id",SUBGRAPH_OUTPUT_ID);u(this,"emptySlot",new EmptySubgraphOutput(this))}get slots(){return this.subgraph.outputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i]=this.boundingRect;return i+SubgraphIONodeBase.roundedRadius}onPointerDown(i,n,s){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(n.onDragStart=()=>{s.dragNewFromSubgraphOutput(this.subgraph,this,o)},n.onDragEnd=a=>{s.dropLinks(this.subgraph,a)},n.finally=()=>{s.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,n){this.subgraph.renameOutput(i,n)}removeSlot(i){this.subgraph.removeOutput(i)}canConnectTo(i,n,s){return i.canConnectTo(this,n,s)}connectByTypeOutput(i,n,s,o){const r=n.findOutputByType(s);if(r)return this.slots[i].connect(r.slot,n,o==null?void 0:o.afterRerouteId)}findInputByType(i){var n;return(n=findFreeSlotOfType(this.slots,i,s=>s.linkIds.length>0))==null?void 0:n.slot}drawProtected(i,n,s,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,h,,c]=this.boundingRect;i.translate(l,h),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(r,r,r,Math.PI,Math.PI*1.5),i.moveTo(0,r),i.lineTo(0,c-r),i.arc(r,c-r,r,Math.PI,Math.PI*.5,!0),i.stroke(),i.setTransform(a),this.drawSlots(i,n,s,o)}}function splitPositionables(p){const t=new Set,i=new Set,n=new Set,s=new Set,o=new Set,r=new Set;for(const a of p)switch(!0){case a instanceof LGraphNode:t.add(a);break;case a instanceof LGraphGroup:n.add(a);break;case a instanceof Reroute:i.add(a);break;case a instanceof SubgraphInputNode:s.add(a);break;case a instanceof SubgraphOutputNode:o.add(a);break;default:r.add(a);break}return{nodes:t,reroutes:i,groups:n,subgraphInputNodes:s,subgraphOutputNodes:o,unknown:r}}function getBoundaryLinks(p,t){const i=[],n=[],s=[],o=[],r=[],a=new WeakSet;for(const h of t)if(!a.has(h)){if(a.add(h),h instanceof LGraphNode){const c=h;if(c.inputs)for(const d of c.inputs){if(l(d._floatingLinks),d.link==null)continue;const f=LLink.resolve(d.link,p);if(!f){console.debug(`Failed to resolve link ID [${d.link}]`);continue}const{link:g,outputNode:m}=f;m?t.has(m)?i.push(g):s.push(g):g.origin_id===SUBGRAPH_INPUT_ID&&s.push(g)}if(c.outputs)for(const d of c.outputs){if(l(d._floatingLinks),!d.links)continue;const f=LLink.resolveMany(d.links,p);for(const{link:g,inputNode:m}of f)(g.target_id===SUBGRAPH_OUTPUT_ID||m&&!t.has(m))&&o.push(g)}}else if(h instanceof Reroute){const c=h,d=LLink.resolveMany(c.linkIds,p);for(const{link:f}of d){const m=LLink.getReroutes(p,f).filter(b=>!t.has(b)),{inputNode:_,outputNode:y}=f.resolve(p);(m.length||_&&!t.has(_)||y&&!t.has(y))&&n.push(f)}}}return{boundaryLinks:n,boundaryFloatingLinks:r,internalLinks:i,boundaryInputLinks:s,boundaryOutputLinks:o};function l(h){if(h)for(const c of h)LLink.getReroutes(p,c).some(f=>!t.has(f))&&r.push(c)}}function multiClone(p){const t=[];for(const i of p){const n=LiteGraph.createNode(i.type);if(!n){console.warn("Failed to create node",i.type);continue}const s=LiteGraph.cloneObject(i.serialize());n.configure(s),t.push(n.serialize())}return t}function groupResolvedByOutput(p){const t=new Map;for(const i of p){const n=i.subgraphInput??i.output??{},s=t.get(n);s?s.push(i):t.set(n,[i])}return t}function mapSubgraphInputsAndLinks(p,t){const i=groupResolvedByOutput(p),n=[];for(const[,s]of i){const o=[];for(const k of s){const{link:T,input:S}=k;if(!S)continue;const N=T.asSerialisable();N.origin_id=SUBGRAPH_INPUT_ID,N.origin_slot=n.length,t.push(N),o.push(N)}const{input:r}=s[0];if(!r)continue;const{color_off:a,color_on:l,dir:h,hasErrors:c,label:d,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,n.map(k=>k.name)),b=f?nextUniqueName(f,n.map(k=>k.localized_name??"")):void 0,L={id:createUuidv4(),type:String(_),linkIds:o.map(k=>k.id),name:y,color_off:a,color_on:l,dir:h,label:d,localized_name:b,hasErrors:c,shape:m};n.push(L)}return n}function mapSubgraphOutputsAndLinks(p,t){const i=groupResolvedByOutput(p),n=[];for(const[,s]of i){const o=[];for(const k of s){const{link:T,output:S}=k;if(!S)continue;const N=T.asSerialisable();N.target_id=SUBGRAPH_OUTPUT_ID,N.target_slot=n.length,t.push(N),o.push(N)}const{output:r}=s[0];if(!r)continue;const{color_off:a,color_on:l,dir:h,hasErrors:c,label:d,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,n.map(k=>k.name)),b=f?nextUniqueName(f,n.map(k=>k.localized_name??"")):void 0,L={id:createUuidv4(),type:String(_),linkIds:o.map(k=>k.id),name:y,color_off:a,color_on:l,dir:h,label:d,localized_name:b,hasErrors:c,shape:m};n.push(structuredClone(L))}return n}function getDirectSubgraphIds(p){const t=new Set;for(const i of p._nodes)i.isSubgraphNode()&&t.add(i.type);return t}function findUsedSubgraphIds(p,t){const i=new Set,n=[p];for(;n.length>0;){const s=n.shift(),o=getDirectSubgraphIds(s);for(const r of o)if(!i.has(r)){i.add(r);const a=t.get(r);a&&n.push(a)}}return i}function isSubgraphInput(p){return p!=null&&typeof p=="object"&&"parent"in p&&p.parent instanceof SubgraphInputNode}function isSubgraphOutput(p){return p!=null&&typeof p=="object"&&"parent"in p&&p.parent instanceof SubgraphOutputNode}function isNodeSlot(p){return p!=null&&typeof p=="object"&&("link"in p||"links"in p)}class NodeInputSlot extends NodeSlot{constructor(i,n){super(i,n);u(this,"link");P(this,Jt);this.link=i.link}get isWidgetInputSlot(){return!!this.widget}get _widget(){var i;return(i=I(this,Jt))==null?void 0:i.deref()}set _widget(i){W(this,Jt,i?new WeakRef(i):void 0)}get collapsedPos(){return[0,LiteGraph.NODE_TITLE_HEIGHT*-.5]}get isConnected(){return this.link!=null}isValidTarget(i){return"links"in i?LiteGraph.isValidConnection(i.type,this.type):isSubgraphInput(i)?LiteGraph.isValidConnection(i.type,this.type):!1}draw(i,n){const{textAlign:s}=i;i.textAlign="left",super.draw(i,{...n,labelPosition:LabelPosition.Right,doStroke:!1}),i.textAlign=s}}Jt=new WeakMap;class NodeOutputSlot extends NodeSlot{constructor(i,n){super(i,n);P(this,Qt);u(this,"links");u(this,"_data");u(this,"slot_index");this.links=i.links,this._data=i._data,this.slot_index=i.slot_index,W(this,Qt,n)}get isWidgetInputSlot(){return!1}get collapsedPos(){return[I(this,Qt)._collapsed_width??LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT*-.5]}isValidTarget(i){return"link"in i?LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}get isConnected(){return this.links!=null&&this.links.length>0}draw(i,n){const{textAlign:s,strokeStyle:o}=i;i.textAlign="right",i.strokeStyle="black",super.draw(i,{...n,labelPosition:LabelPosition.Left,doStroke:!0}),i.textAlign=s,i.strokeStyle=o}}Qt=new WeakMap;function shallowCloneCommonProps(p){const{color_off:t,color_on:i,dir:n,label:s,localized_name:o,locked:r,name:a,nameLocked:l,removable:h,shape:c,type:d}=p;return{color_off:t,color_on:i,dir:n,label:s,localized_name:o,locked:r,name:a,nameLocked:l,removable:h,shape:c,type:d}}function inputAsSerialisable(p){const{link:t}=p,i=p.widget?{widget:{name:p.widget.name}}:{pos:p.pos};return{...shallowCloneCommonProps(p),...i,link:t}}function outputAsSerialisable(p){const{pos:t,slot_index:i,links:n,widget:s}=p,o=s?{widget:{name:s.name}}:null;return{...shallowCloneCommonProps(p),...o,pos:t,slot_index:i,links:n}}function isINodeInputSlot(p){return"link"in p}function isWidgetInputSlot(p){return!!p.widget}const UNIQUE_MESSAGE_LIMIT=1e4,sentWarnings=new Set;function warnDeprecated(p,t){if(!LiteGraph.alwaysRepeatWarnings){if(sentWarnings.has(p)||sentWarnings.size>UNIQUE_MESSAGE_LIMIT)return;sentWarnings.add(p)}for(const i of LiteGraph.onDeprecationWarning)i(p,t)}function distributeSpace(p,t){if(t.length===0)return[];const i=t.reduce((o,r)=>o+r.minSize,0);if(p<i)return t.map(o=>o.minSize);let n=t.map(o=>({computedSize:o.minSize,maxSize:o.maxSize??1/0,remaining:(o.maxSize??1/0)-o.minSize})),s=p-i;for(;s>0&&n.some(o=>o.remaining>0);){const o=n.filter(l=>l.remaining>0).length;if(o===0)break;const r=s/o;let a=0;if(n=n.map(l=>{if(l.remaining<=0)return l;const h=Math.min(r,l.remaining);return a+=h,{...l,computedSize:l.computedSize+h,remaining:l.remaining-h}}),s-=a,a===0)break}return n.map(({computedSize:o})=>o)}function truncateText(p,t,i,n="..."){if(p.measureText(t).width<=i||i<=0)return t;const o=p.measureText(n).width,r=i-o;if(r<=0)return n;let a=0,l=t.length,h=0;for(;a<=l;){const c=Math.floor((a+l)/2),d=t.substring(0,c);p.measureText(d).width<=r?(h=c,a=c+1):l=c-1}return t.substring(0,h)+n}function toClass(p,...t){return t[0]instanceof p?t[0]:new p(...t)}const ct=class ct{constructor(t,i){P(this,te);u(this,"linkedWidgets");u(this,"name");u(this,"options");u(this,"label");u(this,"type");u(this,"y",0);u(this,"last_y");u(this,"width");u(this,"disabled");u(this,"computedDisabled");u(this,"hidden");u(this,"advanced");u(this,"tooltip");u(this,"element");P(this,ee);W(this,te,i??t.node),this.name=t.name,this.options=t.options,this.type=t.type;const{node:n,outline_color:s,background_color:o,height:r,text_color:a,secondary_text_color:l,disabledTextColor:h,displayName:c,displayValue:d,labelBaseline:f,...g}=t;Object.assign(this,g)}get node(){return I(this,te)}get value(){return I(this,ee)}set value(t){W(this,ee,t)}get outline_color(){return this.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR}get background_color(){return LiteGraph.WIDGET_BGCOLOR}get height(){return LiteGraph.NODE_WIDGET_HEIGHT}get text_color(){return LiteGraph.WIDGET_TEXT_COLOR}get secondary_text_color(){return LiteGraph.WIDGET_SECONDARY_TEXT_COLOR}get disabledTextColor(){return LiteGraph.WIDGET_DISABLED_TEXT_COLOR}get displayName(){return this.label||this.name}get _displayValue(){return this.computedDisabled?"":String(this.value)}get labelBaseline(){return this.y+this.height*.7}drawWidgetShape(t,{width:i,showText:n}){const{height:s,y:o}=this,{margin:r}=ct;t.textAlign="left",t.strokeStyle=this.outline_color,t.fillStyle=this.background_color,t.beginPath(),n?t.roundRect(r,o,i-r*2,s,[s*.5]):t.rect(r,o,i-r*2,s),t.fill(),n&&!this.computedDisabled&&t.stroke()}drawTruncatingText({ctx:t,width:i,leftPadding:n=5,rightPadding:s=20}){const{height:o,y:r}=this,{margin:a}=ct,{displayName:l,_displayValue:h}=this,c=t.measureText(l).width,d=t.measureText(h).width,f=ct.labelValueGap,g=a*2+n,m=i-g-2*a-s,_=c+f+d,y=new Rectangle(g,r,m,o*.7);if(t.fillStyle=this.secondary_text_color,_<=m)drawTextInArea({ctx:t,text:l,area:y,align:"left"});else if(LiteGraph.truncateWidgetTextEvenly){const b=(m-f)/(_-f);y.width=c*b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(d*b)}else if(LiteGraph.truncateWidgetValuesFirst){const b=Math.min(c,m);y.width=b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(Math.max(m-f-b,0))}else{const b=Math.min(d,m);y.width=Math.max(m-f-b,0),drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(b)}t.fillStyle=this.text_color,drawTextInArea({ctx:t,text:h,area:y,align:"right"})}setValue(t,{e:i,node:n,canvas:s}){var l,h,c;const o=this.value;if(t===this.value)return;const r=this.type==="number"?Number(t):t;this.value=r,(l=this.options)!=null&&l.property&&n.properties[this.options.property]!==void 0&&n.setProperty(this.options.property,r);const a=s.graph_mouse;(h=this.callback)==null||h.call(this,this.value,s,n,a,i),(c=n.onWidgetChanged)==null||c.call(n,this.name??"",r,o,this),n.graph&&n.graph._version++}createCopyForNode(t){const i=new this.constructor(this,t);return i.value=this.value,i}};te=new WeakMap,ee=new WeakMap,u(ct,"margin",15),u(ct,"arrowMargin",6),u(ct,"arrowWidth",10),u(ct,"minValueWidth",42),u(ct,"labelValueGap",5);let BaseWidget=ct;class BooleanWidget extends BaseWidget{constructor(){super(...arguments);u(this,"type","toggle")}drawWidget(i,{width:n,showText:s=!0}){const{height:o,y:r}=this,{margin:a}=BaseWidget;this.drawWidgetShape(i,{width:n,showText:s}),i.fillStyle=this.value?"#89A":"#333",i.beginPath(),i.arc(n-a*2,r+o*.5,o*.36,0,Math.PI*2),i.fill(),s&&(this.drawLabel(i,a*2),this.drawValue(i,n-40))}drawLabel(i,n){i.fillStyle=this.secondary_text_color;const{displayName:s}=this;s&&i.fillText(s,n,this.labelBaseline)}drawValue(i,n){i.fillStyle=this.value?this.text_color:this.secondary_text_color,i.textAlign="right";const s=this.value?this.options.on||"true":this.options.off||"false";i.fillText(s,n,this.labelBaseline)}onClick(i){this.setValue(!this.value,i)}}class ButtonWidget extends BaseWidget{constructor(i,n){super(i,n);u(this,"type","button");u(this,"clicked");this.clicked??(this.clicked=!1)}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:h}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,this.clicked&&(i.fillStyle="#AAA",this.clicked=!1),i.fillRect(c,h,n-c*2,l),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,h,n-c*2,l)),s&&this.drawLabel(i,n*.5),Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}drawLabel(i,n){i.textAlign="center",i.fillStyle=this.text_color,i.fillText(this.displayName,n,this.y+this.height*.7)}onClick({e:i,node:n,canvas:s}){var r;const o=s.graph_mouse;this.clicked=!0,s.setDirty(!0),(r=this.callback)==null||r.call(this,this,s,n,o,i)}}class BaseSteppedWidget extends BaseWidget{drawArrowButtons(t,i){const{height:n,text_color:s,disabledTextColor:o,y:r}=this,{arrowMargin:a,arrowWidth:l,margin:h}=BaseWidget,c=h+a,d=c+l;t.fillStyle=this.canDecrement()?s:o,t.beginPath(),t.moveTo(d,r+5),t.lineTo(c,r+n*.5),t.lineTo(d,r+n-5),t.fill(),t.fillStyle=this.canIncrement()?s:o,t.beginPath(),t.moveTo(i-d,r+5),t.lineTo(i-c,r+n*.5),t.lineTo(i-d,r+n-5),t.fill()}drawWidget(t,i){const{fillStyle:n,strokeStyle:s,textAlign:o}=t;this.drawWidgetShape(t,i),i.showText&&(this.computedDisabled||this.drawArrowButtons(t,i.width),this.drawTruncatingText({ctx:t,width:i.width})),Object.assign(t,{textAlign:o,strokeStyle:s,fillStyle:n})}}function toArray(p){return Array.isArray(p)?p:Object.keys(p)}class ComboWidget extends BaseSteppedWidget{constructor(){super(...arguments);P(this,rt);u(this,"type","combo")}get _displayValue(){if(this.computedDisabled)return"";const{values:i}=this.options;if(i){const n=typeof i=="function"?i():i;if(n&&!Array.isArray(n))return n[this.value]}return typeof this.value=="number"?String(this.value):this.value}canIncrement(){return O(this,rt,Be).call(this,!0)}canDecrement(){return O(this,rt,Be).call(this,!1)}incrementValue(i){O(this,rt,ze).call(this,1,i)}decrementValue(i){O(this,rt,ze).call(this,-1,i)}onClick({e:i,node:n,canvas:s}){const o=i.canvasX-n.pos[0],r=this.width||n.size[0];if(typeof this.options.values=="function"&&warnDeprecated("Using a function for values is deprecated. Use an array of unique values instead."),o<40)return this.decrementValue({e:i,node:n,canvas:s});if(o>r-40)return this.incrementValue({e:i,node:n,canvas:s});const a=O(this,rt,We).call(this,n),l=toArray(a),h=a!=l?Object.values(a):a;new LiteGraph.ContextMenu(h,{scale:Math.max(1,s.ds.scale),event:i,className:"dark",callback:c=>{this.setValue(a!=l?h.indexOf(c):c,{e:i,node:n,canvas:s})}})}}rt=new WeakSet,We=function(i){const{values:n}=this.options;if(n==null)throw new Error("[ComboWidget]: values is required");return typeof n=="function"?n(this,i):n},Be=function(i){const{values:n}=this.options;if(typeof n=="function")return!1;const s=toArray(n);if(!(s.length>1))return!1;const o=s.at(0),r=s.at(-1);return o===r?!0:this.value!==(i?r:o)},ze=function(i,n){const s=O(this,rt,We).call(this,n.node),o=toArray(s);n.canvas.last_mouseclick=0;const r=typeof s=="object"?o.indexOf(String(this.value))+i:o.indexOf(this.value)+i,a=clamp(r,0,o.length-1),l=Array.isArray(s)?s[a]:a;this.setValue(l,n)};function getWidgetStep(p){return p.step2||(p.step||10)*.1}class KnobWidget extends BaseWidget{constructor(){super(...arguments);u(this,"type","knob");u(this,"current_drag_offset",0)}computeLayoutSize(){return{minHeight:60,minWidth:20,maxHeight:1e6,maxWidth:1e6}}get height(){return this.computedHeight||super.height}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{y:l}=this,{margin:h}=BaseWidget,{gradient_stops:c="rgb(14, 182, 201); rgb(0, 216, 72)"}=this.options,d=this.computedHeight||this.height,f=Math.min(this.computedHeight||this.height,this.width||20)/20,g={x:n/2,y:d/2+l};i.lineWidth=(Math.min(n,d)-h*f)/6;const m=(Math.min(n,d)-h*f-i.lineWidth)/2;{const S=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);S.addColorStop(0,"rgb(29, 29, 29)"),S.addColorStop(1,"rgb(116, 116, 116)"),i.fillStyle=S}i.beginPath(),i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.fill(),i.closePath();const _={start_angle:Math.PI*.6,end_angle:Math.PI*2.4};i.beginPath();{const S=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);S.addColorStop(0,"rgb(99, 99, 99)"),S.addColorStop(1,"rgb(36, 36, 36)"),i.strokeStyle=S}i.arc(g.x,g.y,m,_.start_angle,_.end_angle,!1),i.stroke(),i.closePath();const y=this.options.max-this.options.min;let b=(this.value-this.options.min)/y;b=clamp(b,0,1),i.beginPath();const L=i.createConicGradient(_.start_angle,g.x,g.y),k=c.split(";");for(const[S,N]of k.entries())L.addColorStop(S,N.trim());i.strokeStyle=L;const T=(_.end_angle-_.start_angle)*b+_.start_angle;if(i.arc(g.x,g.y,m,_.start_angle,T,!1),i.stroke(),i.closePath(),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.beginPath(),i.strokeStyle=this.outline_color,i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.lineWidth=1,i.stroke(),i.closePath()),s){i.textAlign="center",i.fillStyle=this.text_color;const S=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}
${S}`,n*.5,l+d*.5)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(){this.current_drag_offset=0}onDrag(i){if(this.options.read_only)return;const{e:n}=i,s=getWidgetStep(this.options),o=this.options.max-this.options.min,r=o/10,a=o/100,l={shift:r>s?r-r%s:s,delta_y:a>s?a-a%s:s},h=Math.abs(n.movementY)>Math.abs(n.movementX),c=h?-n.movementY:n.movementX,d=15;this.current_drag_offset+=c;let f=0;this.current_drag_offset>d?(f+=1,this.current_drag_offset-=d):this.current_drag_offset<-15&&(f-=1,this.current_drag_offset+=d);const g=n.shiftKey?l.shift:h?l.delta_y:s,m=f*g,_=clamp(this.value+m,this.options.min,this.options.max);_!==this.value&&this.setValue(_,i)}}class LegacyWidget extends BaseWidget{drawWidget(t,i){var s;const n=LiteGraph.NODE_WIDGET_HEIGHT;(s=this.draw)==null||s.call(this,t,this.node,i.width,this.y,n,!!i.showText)}onClick(){console.warn("Custom widget wrapper onClick was just called. Handling for third party widgets is done via LGraphCanvas - the mouse callback.")}}class NumberWidget extends BaseSteppedWidget{constructor(){super(...arguments);u(this,"type","number")}get _displayValue(){return this.computedDisabled?"":Number(this.value).toFixed(this.options.precision!==void 0?this.options.precision:3)}canIncrement(){const{max:t}=this.options;return t==null||this.value<t}canDecrement(){const{min:t}=this.options;return t==null||this.value>t}incrementValue(t){this.setValue(this.value+getWidgetStep(this.options),t)}decrementValue(t){this.setValue(this.value-getWidgetStep(this.options),t)}setValue(t,i){let n=t;this.options.min!=null&&n<this.options.min&&(n=this.options.min),this.options.max!=null&&n>this.options.max&&(n=this.options.max),super.setValue(n,i)}onClick({e,node,canvas}){const x=e.canvasX-node.pos[0],width=this.width||node.size[0],delta=x<40?-1:x>width-40?1:0;if(delta){this.setValue(this.value+delta*getWidgetStep(this.options),{e,node,canvas});return}canvas.prompt("Value",this.value,v=>{if(/^[\d\s()*+/-]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch{}const newValue=Number(v);isNaN(newValue)||this.setValue(newValue,{e,node,canvas})},e)}onDrag({e:t,node:i,canvas:n}){const s=this.width||i.width,o=t.canvasX-i.pos[0];(o<40||o>s-40)&&o>-3&&o<s+3||this.setValue(this.value+(t.deltaX??0)*getWidgetStep(this.options),{e:t,node:i,canvas:n})}}class SliderWidget extends BaseWidget{constructor(){super(...arguments);u(this,"type","slider");u(this,"marker")}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:h}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,i.fillRect(c,h,n-c*2,l);const d=this.options.max-this.options.min;let f=(this.value-this.options.min)/d;if(f=clamp(f,0,1),i.fillStyle=this.options.slider_color??"#678",i.fillRect(c,h,f*(n-c*2),l),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,h,n-c*2,l)),this.marker!=null){let g=(this.marker-this.options.min)/d;g=clamp(g,0,1),i.fillStyle=this.options.marker_color??"#AA9",i.fillRect(c+g*(n-c*2),h,2,l)}if(s){i.textAlign="center",i.fillStyle=this.text_color;const g=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}  ${g}`,n*.5,h+l*.7)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(i){if(this.options.read_only)return;const{e:n,node:s}=i,o=this.width||s.size[0],r=n.canvasX-s.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}onDrag(i){if(this.options.read_only)return!1;const{e:n,node:s}=i,o=this.width||s.size[0],r=n.canvasX-s.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}}class TextWidget extends BaseWidget{constructor(t,i){var n;super(t,i),this.type??(this.type="string"),this.value=((n=t.value)==null?void 0:n.toString())??""}drawWidget(t,{width:i,showText:n=!0}){const{fillStyle:s,strokeStyle:o,textAlign:r}=t;this.drawWidgetShape(t,{width:i,showText:n}),n&&this.drawTruncatingText({ctx:t,width:i,leftPadding:0,rightPadding:0}),Object.assign(t,{textAlign:r,strokeStyle:o,fillStyle:s})}onClick({e:t,node:i,canvas:n}){var s;n.prompt("Value",this.value,o=>{o!==null&&this.setValue(o,{e:t,node:i,canvas:n})},t,((s=this.options)==null?void 0:s.multiline)??!1)}}function toConcreteWidget(p,t,i=!0){if(p instanceof BaseWidget)return p;const n=p;switch(n.type){case"button":return toClass(ButtonWidget,n,t);case"toggle":return toClass(BooleanWidget,n,t);case"slider":return toClass(SliderWidget,n,t);case"knob":return toClass(KnobWidget,n,t);case"combo":return toClass(ComboWidget,n,t);case"number":return toClass(NumberWidget,n,t);case"string":return toClass(TextWidget,n,t);case"text":return toClass(TextWidget,n,t);default:if(i)return toClass(LegacyWidget,p,t)}}const J=class J{constructor(t,i){P(this,H);u(this,"title");u(this,"graph",null);u(this,"id");u(this,"type","");u(this,"inputs",[]);u(this,"outputs",[]);P(this,_t,[]);P(this,Lt,[]);u(this,"properties",{});u(this,"properties_info",[]);u(this,"flags",{});u(this,"widgets");u(this,"freeWidgetSpace");u(this,"locked");u(this,"order",0);u(this,"mode",LGraphEventMode.ALWAYS);u(this,"last_serialization");u(this,"serialize_widgets");u(this,"color");u(this,"bgcolor");u(this,"boxcolor");u(this,"strokeStyles");u(this,"progress");u(this,"exec_version");u(this,"action_call");u(this,"execute_triggered");u(this,"action_triggered");u(this,"widgets_up");u(this,"widgets_start_y");u(this,"lostFocusAt");u(this,"gotFocusAt");u(this,"badges",[]);u(this,"title_buttons",[]);u(this,"badgePosition",BadgePosition.TopLeft);u(this,"_collapsed_width");u(this,"console");u(this,"_level");u(this,"_shape");u(this,"mouseOver");u(this,"redraw_on_mouse");u(this,"resizable");u(this,"clonable");u(this,"_relative_id");u(this,"clip_area");u(this,"ignore_remove");u(this,"has_errors");u(this,"removable");u(this,"block_delete");u(this,"selected");u(this,"showAdvanced");P(this,ie,new Float32Array(4));P(this,ne,new Rectangle);u(this,"_posSize",new Float32Array(4));u(this,"_pos",this._posSize.subarray(0,2));u(this,"_size",this._posSize.subarray(2,4));this.id=LiteGraph.use_uuids?LiteGraph.uuidv4():-1,this.title=t||"Unnamed",this.type=i??"",this.size=[LiteGraph.NODE_WIDTH,60],this.pos=[10,10],this.strokeStyles={error:O(this,H,ai),selected:O(this,H,li)},this.onMouseDown=(n,s,o)=>{var r;if((r=this.title_buttons)!=null&&r.length&&!this.flags.collapsed){const a=s[0],l=s[1];for(let h=0;h<this.title_buttons.length;h++){const c=this.title_buttons[h];if(c.visible&&c.isPointInside(a,l))return this.onTitleButtonClick(c,o),!0}}return!1}}get titleFontStyle(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get innerFontStyle(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get displayType(){return this.type}get renderingColor(){return this.color||this.constructor.color||LiteGraph.NODE_DEFAULT_COLOR}get renderingBgColor(){return this.bgcolor||this.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR}get renderingBoxColor(){if(this.boxcolor)return this.boxcolor;if(LiteGraph.node_box_coloured_when_on){if(this.action_triggered)return"#FFF";if(this.execute_triggered)return"#AAA"}if(LiteGraph.node_box_coloured_by_mode){const t=LiteGraph.NODE_MODES_COLORS[this.mode??LGraphEventMode.ALWAYS];if(t)return t}return LiteGraph.NODE_DEFAULT_BOXCOLOR}setColorOption(t){t==null?(delete this.color,delete this.bgcolor):(this.color=t.color,this.bgcolor=t.bgcolor)}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.color===this.color&&t.bgcolor===this.bgcolor)??null}isSubgraphNode(){return!1}get renderArea(){return I(this,ie)}get boundingRect(){return I(this,ne)}get boundingOffset(){const{pos:[t,i],boundingRect:[n,s]}=this;return[t-n,i-s]}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=t[0],this._size[1]=t[1])}get renderingSize(){return this.flags.collapsed?[this._collapsed_width??0,0]:this._size}get shape(){return this._shape}set shape(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=RenderShape.BOX;break;case"round":this._shape=RenderShape.ROUND;break;case"circle":this._shape=RenderShape.CIRCLE;break;case"card":this._shape=RenderShape.CARD;break;default:this._shape=t}}get renderingShape(){return this._shape||this.constructor.shape||LiteGraph.NODE_DEFAULT_SHAPE}get is_selected(){return this.selected}set is_selected(t){this.selected=t}get title_mode(){return this.constructor.title_mode??TitleMode.NORMAL_TITLE}configure(t){var i,n,s,o,r,a,l,h,c,d;this.graph&&this.graph._version++;for(const f in t){if(f=="properties"){for(const g in t.properties)this.properties[g]=t.properties[g],(i=this.onPropertyChanged)==null||i.call(this,g,t.properties[g]);continue}t[f]!=null&&(typeof t[f]=="object"?(n=this[f])!=null&&n.configure?(s=this[f])==null||s.configure(t[f]):this[f]=LiteGraph.cloneObject(t[f],this[f]):this[f]=t[f])}t.title||(this.title=this.constructor.title),this.inputs??(this.inputs=[]),this.inputs=this.inputs.map(f=>toClass(NodeInputSlot,f,this));for(const[f,g]of this.inputs.entries()){const m=this.graph&&g.link!=null?this.graph._links.get(g.link):null;(o=this.onConnectionsChange)==null||o.call(this,NodeSlotType.INPUT,f,!0,m,g),(r=this.onInputAdded)==null||r.call(this,g)}this.outputs??(this.outputs=[]),this.outputs=this.outputs.map(f=>toClass(NodeOutputSlot,f,this));for(const[f,g]of this.outputs.entries())if(g.links){for(const m of g.links){const _=this.graph?this.graph._links.get(m):null;(a=this.onConnectionsChange)==null||a.call(this,NodeSlotType.OUTPUT,f,!0,_,g)}(l=this.onOutputAdded)==null||l.call(this,g)}if((h=this._internalConfigureAfterSlots)==null||h.call(this),this.widgets){for(const f of this.widgets)f&&(c=f.options)!=null&&c.property&&this.properties[f.options.property]!=null&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property])));if(t.widgets_values){const f=this.widgets.filter(g=>g.serialize!==!1);for(let g=0;g<t.widgets_values.length;++g){const m=f[g];m&&(m.value=t.widgets_values[g])}}}this.pinned&&(this.resizable=!1),(d=this.onConfigure)==null||d.call(this,t)}serialize(){var n;const t={id:this.id,type:this.type,pos:[this.pos[0],this.pos[1]],size:[this.size[0],this.size[1]],flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode,showAdvanced:this.showAdvanced};if(this.constructor===J&&this.last_serialization)return this.last_serialization;this.inputs&&(t.inputs=this.inputs.map(s=>inputAsSerialisable(s))),this.outputs&&(t.outputs=this.outputs.map(s=>outputAsSerialisable(s))),this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties));const{widgets:i}=this;if(i&&this.serialize_widgets){t.widgets_values=[];for(const[s,o]of i.entries())o.serialize!==!1&&(t.widgets_values[s]=o?o.value:null)}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),(n=this.onSerialize)!=null&&n.call(this,t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){if(this.type==null)return null;const t=LiteGraph.createNode(this.type);if(!t)return null;const i=LiteGraph.cloneObject(this.serialize()),{inputs:n,outputs:s}=i;if(n)for(const o of n)o.link=null;if(s)for(const{links:o}of s)o&&(o.length=0);return delete i.id,LiteGraph.use_uuids&&(i.id=LiteGraph.uuidv4()),t.configure(i),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,i){var s;if(this.properties||(this.properties={}),i===this.properties[t])return;const n=this.properties[t];if(this.properties[t]=i,((s=this.onPropertyChanged)==null?void 0:s.call(this,t,i,n))===!1&&(this.properties[t]=n),this.widgets){for(const o of this.widgets)if(o&&o.options.property==t){o.value=i;break}}}setOutputData(t,i){const{outputs:n}=this;if(!n||t==-1||t>=n.length)return;const s=n[t];if(!s)return;if(s._data=i,!this.graph)throw new NullGraphError;const{links:o}=n[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.data=i)}}setOutputDataType(t,i){const{outputs:n}=this;if(!n||t==-1||t>=n.length)return;const s=n[t];if(!s)return;if(s.type=i,!this.graph)throw new NullGraphError;const{links:o}=n[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.type=i)}}getInputData(t,i){var r;if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return;if(!this.graph)throw new NullGraphError;const n=this.inputs[t].link,s=this.graph._links.get(n);if(!s)return null;if(!i)return s.data;const o=this.graph.getNodeById(s.origin_id);return o&&(o.updateOutputData?o.updateOutputData(s.origin_slot):(r=o.onExecute)==null||r.call(o)),s.data}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;if(!this.graph)throw new NullGraphError;const i=this.inputs[t].link,n=this.graph._links.get(i);if(!n)return null;const s=this.graph.getNodeById(n.origin_id);if(!s)return n.type;const o=s.outputs[n.origin_slot];return o?o.type:null}getInputDataByName(t,i){const n=this.findInputSlot(t);return n==-1?null:this.getInputData(n,i)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return!this.inputs||!(t<this.inputs.length)?null:this.inputs[t]}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){if(!this.graph)throw new NullGraphError;const i=this.inputs[t];if(i.link!=null)return this.graph._links.get(i.link)??null}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;const i=this.inputs[t];if(!i||i.link===null)return null;if(!this.graph)throw new NullGraphError;const n=this.graph._links.get(i.link);return n?this.graph.getNodeById(n.origin_id):null}getInputOrProperty(t){const{inputs:i}=this;if(!(i!=null&&i.length))return this.properties?this.properties[t]:null;if(!this.graph)throw new NullGraphError;for(const n of i)if(t==n.name&&n.link!=null){const s=this.graph._links.get(n.link);if(s)return s.data}return this.properties[t]}getOutputData(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data}getOutputInfo(t){return!this.outputs||!(t<this.outputs.length)?null:this.outputs[t]}isOutputConnected(t){var i;return this.outputs?t<this.outputs.length&&Number((i=this.outputs[t].links)==null?void 0:i.length)>0:!1}isAnyOutputConnected(){var i;const{outputs:t}=this;if(!t)return!1;for(const n of t)if((i=n.links)!=null&&i.length)return!0;return!1}getOutputNodes(t){const{outputs:i}=this;if(!i||i.length==0||t>=i.length)return null;const{links:n}=i[t];if(!n||n.length==0)return null;if(!this.graph)throw new NullGraphError;const s=[];for(const o of n){const r=this.graph._links.get(o);if(r){const a=this.graph.getNodeById(r.target_id);a&&s.push(a)}}return s}addOnTriggerInput(){const t=this.findInputSlot("onTrigger");return t==-1?(this.addInput("onTrigger",LiteGraph.EVENT,{nameLocked:!0}),this.findInputSlot("onTrigger")):t}addOnExecutedOutput(){const t=this.findOutputSlot("onExecuted");return t==-1?(this.addOutput("onExecuted",LiteGraph.ACTION,{nameLocked:!0}),this.findOutputSlot("onExecuted")):t}onAfterExecuteNode(t,i){const n=this.findOutputSlot("onExecuted");n!=-1&&this.triggerSlot(n,t,null,i)}changeMode(t){switch(t){case LGraphEventMode.ON_EVENT:break;case LGraphEventMode.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LGraphEventMode.NEVER:break;case LGraphEventMode.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,i){var n;if(i=i||{},this.onExecute){if(i.action_call||(i.action_call=`${this.id}_exec_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_executing[this.id]=!0,this.onExecute(t,i),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,i!=null&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call)}this.execute_triggered=2,(n=this.onAfterExecuteNode)==null||n.call(this,t,i)}actionDo(t,i,n){var s;if(n=n||{},this.onAction){if(n.action_call||(n.action_call=`${this.id}_${t||"action"}_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,i,n),this.graph.nodes_actioning[this.id]=!1,n!=null&&n.action_call&&(this.action_call=n.action_call,this.graph.nodes_executedAction[this.id]=n.action_call)}this.action_triggered=2,(s=this.onAfterExecuteNode)==null||s.call(this,i,n)}trigger(t,i,n){const{outputs:s}=this;if(!(!s||!s.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(const[o,r]of s.entries())!r||r.type!==LiteGraph.EVENT||t&&r.name!=t||this.triggerSlot(o,i,null,n)}}triggerSlot(t,i,n,s){var a;if(s=s||{},!this.outputs)return;if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const o=this.outputs[t];if(!o)return;const r=o.links;if(!(!r||!r.length)){if(!this.graph)throw new NullGraphError;this.graph._last_trigger_time=LiteGraph.getTime();for(const l of r){if(n!=null&&n!=l)continue;const h=this.graph._links.get(l);if(!h)continue;h._last_time=LiteGraph.getTime();const c=this.graph.getNodeById(h.target_id);if(c){if(c.mode===LGraphEventMode.ON_TRIGGER)s.action_call||(s.action_call=`${this.id}_trigg_${Math.floor(Math.random()*9999)}`),(a=c.doExecute)==null||a.call(c,i,s);else if(c.onAction){s.action_call||(s.action_call=`${this.id}_act_${Math.floor(Math.random()*9999)}`);const d=c.inputs[h.target_slot];c.actionDo(d.name,i,s)}}}}}clearTriggeredSlot(t,i){if(!this.outputs)return;const n=this.outputs[t];if(!n)return;const s=n.links;if(!(!s||!s.length)){if(!this.graph)throw new NullGraphError;for(const o of s){if(i!=null&&i!=o)continue;const r=this.graph._links.get(o);r&&(r._last_time=0)}}}setSize(t){var i;this.size=t,(i=this.onResize)==null||i.call(this,this.size)}expandToFitContent(){const t=this.computeSize();this.setSize([Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])])}addProperty(t,i,n,s){const o={name:t,type:n,default_value:i};return s&&Object.assign(o,s),this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=i,o}addOutput(t,i,n){var o;const s=Object.assign(new NodeOutputSlot({name:t,type:i,links:null},this),n);return this.outputs||(this.outputs=[]),this.outputs.push(s),(o=this.onOutputAdded)==null||o.call(this,s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i,!0),this.expandToFitContent(),this.setDirtyCanvas(!0,!0),s}removeOutput(t){var n;this.disconnectOutput(t);const{outputs:i}=this;i.splice(t,1);for(let s=t;s<i.length;++s){const o=i[s];if(!(!o||!o.links))for(const r of o.links){if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r);a&&a.origin_slot--}}(n=this.onOutputRemoved)==null||n.call(this,t),this.setDirtyCanvas(!0,!0)}addInput(t,i,n){var o;i||(i=0);const s=Object.assign(new NodeInputSlot({name:t,type:i,link:null},this),n);return this.inputs||(this.inputs=[]),this.inputs.push(s),this.expandToFitContent(),(o=this.onInputAdded)==null||o.call(this,s),LiteGraph.registerNodeAndSlotType(this,i),this.setDirtyCanvas(!0,!0),s}removeInput(t){var s;this.disconnectInput(t,!0);const{inputs:i}=this,n=i.splice(t,1);for(let o=t;o<i.length;++o){const r=i[o];if(!(r!=null&&r.link))continue;if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r.link);a&&a.target_slot--}(s=this.onInputRemoved)==null||s.call(this,t,n[0]),this.setDirtyCanvas(!0,!0)}computeSize(t){const i=this.constructor.size;if(i)return[i[0],i[1]];const{inputs:n,outputs:s,widgets:o}=this;let r=Math.max(n?n.filter(N=>!isWidgetInputSlot(N)).length:1,s?s.length:1);const a=t||new Float32Array([0,0]);r=Math.max(r,1);const l=LiteGraph.NODE_TEXT_SIZE,h=LiteGraph.NODE_TITLE_HEIGHT,c=h*.33,d=h+S(this.title,this.titleFontStyle)+c;let f=0,g=0,m=0;if(n)for(const N of n){const A=N.label||N.localized_name||N.name||"",D=S(A,this.innerFontStyle);if(isWidgetInputSlot(N)){const E=this.getWidgetFromSlot(N);if(E&&!this.isWidgetVisible(E))continue;D>g&&(g=D)}else D>f&&(f=D)}if(s)for(const N of s){const A=N.label||N.localized_name||N.name||"",D=S(A,this.innerFontStyle);m<D&&(m=D)}const _=LiteGraph.NODE_WIDTH*(o!=null&&o.length?1.5:1),y=f&&m?5:0,b=f+m+2*LiteGraph.NODE_SLOT_HEIGHT+y,L=BaseWidget.margin+BaseWidget.arrowMargin+BaseWidget.arrowWidth,k=BaseWidget.minValueWidth+2*L;g&&(g+=k),a[0]=Math.max(b,g,d,_),a[1]=(this.constructor.slot_start_y||0)+r*LiteGraph.NODE_SLOT_HEIGHT;let T=0;if(o!=null&&o.length){for(const N of o){if(!this.isWidgetVisible(N))continue;let A=0;if(N.computeSize)A+=N.computeSize(a[0])[1];else if(N.computeLayoutSize){const{minHeight:D,minWidth:E}=N.computeLayoutSize(this),w=E+k;w>a[0]&&(a[0]=w),A+=D}else A+=LiteGraph.NODE_WIDGET_HEIGHT;T+=A+4}T+=8}this.widgets_up?a[1]=Math.max(a[1],T):this.widgets_start_y!=null?a[1]=Math.max(a[1],T+this.widgets_start_y):a[1]+=T;function S(N,A){var D;return((D=LGraphCanvas._measureText)==null?void 0:D.call(LGraphCanvas,N,A))??l*((N==null?void 0:N.length)??0)*.6}return this.constructor.min_height&&a[1]<this.constructor.min_height&&(a[1]=this.constructor.min_height),a[1]+=6,a}inResizeCorner(t,i){const n=this.outputs?this.outputs.length:1,s=(this.constructor.slot_start_y||0)+n*LiteGraph.NODE_SLOT_HEIGHT;return isInRectangle(t,i,this.pos[0]+this.size[0]-15,this.pos[1]+Math.max(this.size[1]-15,s),20,20)}findResizeDirection(t,i){if(this.resizable===!1)return;const{boundingRect:n}=this;if(n.containsXy(t,i))return n.findContainingCorner(t,i,J.resizeHandleSize)}getPropertyInfo(t){var s;let i=null;const{properties_info:n}=this;if(n){for(const o of n)if(o.name==t){i=o;break}}return this.constructor[`@${t}`]&&(i=this.constructor[`@${t}`]),(s=this.constructor.widgets_info)!=null&&s[t]&&(i=this.constructor.widgets_info[t]),!i&&this.onGetPropertyInfo&&(i=this.onGetPropertyInfo(t)),i||(i={}),i.type||(i.type=typeof this.properties[t]),i.widget=="combo"&&(i.type="enum"),i}addWidget(t,i,n,s,o){this.widgets||(this.widgets=[]),!o&&s&&typeof s=="object"&&(o=s,s=null),o||(o={}),typeof o=="string"&&(o={property:o}),s&&typeof s=="string"&&(o.property=s,s=null);const r={type:t.toLowerCase(),name:i,value:n,callback:typeof s!="function"?void 0:s,options:o,y:0};if(r.options.y!==void 0&&(r.y=r.options.y),!s&&!r.options.callback&&!r.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";const a=this.addCustomWidget(r);return this.expandToFitContent(),a}addCustomWidget(t){this.widgets||(this.widgets=[]);const i=toConcreteWidget(t,this,!1)??t;return this.widgets.push(i),i}addTitleButton(t){this.title_buttons||(this.title_buttons=[]);const i=new LGraphButton(t);return this.title_buttons.push(i),i}onTitleButtonClick(t,i){i.dispatch("litegraph:node-title-button-clicked",{node:this,button:t})}removeWidgetByName(t){var n;const i=(n=this.widgets)==null?void 0:n.find(s=>s.name===t);i&&this.removeWidget(i)}removeWidget(t){if(!this.widgets)throw new Error("removeWidget called on node without widgets");const i=this.widgets.indexOf(t);if(i===-1)throw new Error("Widget not found on this node");if(this.inputs)for(const n of this.inputs)n._widget===t&&(n._widget=void 0,delete n.widget);this.widgets.splice(i,1)}ensureWidgetRemoved(t){try{this.removeWidget(t)}catch(i){console.debug("Failed to remove widget",i)}}move(t,i){this.pinned||(this.pos[0]+=t,this.pos[1]+=i)}measure(t,i){var r;const n=this.title_mode,o=n!=TitleMode.TRANSPARENT_TITLE&&n!=TitleMode.NO_TITLE?LiteGraph.NODE_TITLE_HEIGHT:0;t[0]=this.pos[0],t[1]=this.pos[1]+-o,(r=this.flags)!=null&&r.collapsed?(i.font=this.innerFontStyle,this._collapsed_width=Math.min(this.size[0],i.measureText(this.getTitle()??"").width+LiteGraph.NODE_TITLE_HEIGHT*2),t[2]=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,t[3]=LiteGraph.NODE_TITLE_HEIGHT):(t[2]=this.size[0],t[3]=this.size[1]+o)}getBounding(t,i){t||(t=new Float32Array(4));const n=i?this.renderArea:this.boundingRect;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}updateArea(t){var s;const i=I(this,ne);this.measure(i,t),(s=this.onBounding)==null||s.call(this,i);const n=I(this,ie);n.set(i),n[0]-=4,n[1]-=4,n[2]+=10,n[3]+=9}isPointInside(t,i){return isInRect(t,i,this.boundingRect)}isPointInCollapse(t,i){const n=LiteGraph.NODE_TITLE_HEIGHT;return isInRectangle(t,i,this.pos[0],this.pos[1]-n,n,n)}getInputOnPos(t){var i;return(i=getNodeInputOnPos(this,t[0],t[1]))==null?void 0:i.input}getOutputOnPos(t){var i;return(i=getNodeOutputOnPos(this,t[0],t[1]))==null?void 0:i.output}getSlotOnPos(t){if(isPointInRect(t,this.boundingRect))return this.getInputOnPos(t)??this.getOutputOnPos(t)}getSlotInPosition(t,i){const{inputs:n,outputs:s}=this;if(n)for(const[o,r]of n.entries()){const a=this.getInputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{input:r,slot:o,link_pos:a}}if(s)for(const[o,r]of s.entries()){const a=this.getOutputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{output:r,slot:o,link_pos:a}}return null}getWidgetOnPos(t,i,n=!1){var c;const{widgets:s,pos:o,size:r}=this;if(!(s!=null&&s.length))return;const a=t-o[0],l=i-o[1],h=r[0];for(const d of s){if(d.computedDisabled&&!n||!this.isWidgetVisible(d))continue;const f=d.computedHeight??((c=d.computeSize)==null?void 0:c.call(d,h)[1])??LiteGraph.NODE_WIDGET_HEIGHT,g=d.width||h;if(d.last_y!==void 0&&isInRectangle(a,l,6,d.last_y,g-12,f))return d}}findInputSlot(t,i=!1){const{inputs:n}=this;if(!n)return-1;for(const[s,o]of n.entries())if(t==o.name)return i?o:s;return-1}findOutputSlot(t,i=!1){const{outputs:n}=this;if(!n)return-1;for(const[s,o]of n.entries())if(t==o.name)return i?o:s;return-1}findInputSlotFree(t){return O(this,H,He).call(this,this.inputs,t)}findOutputSlotFree(t){return O(this,H,He).call(this,this.outputs,t)}findInputSlotByType(t,i,n,s){return O(this,H,me).call(this,this.inputs,t,i,n,s)}findOutputSlotByType(t,i,n,s){return O(this,H,me).call(this,this.outputs,t,i,n,s)}findSlotByType(t,i,n,s,o){return t?O(this,H,me).call(this,this.inputs,i,n,s,o):O(this,H,me).call(this,this.outputs,i,n,s,o)}findConnectByTypeSlot(t,i,n,s){s&&typeof s=="object"&&("firstFreeIfInputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfInputGeneralInCase),"firstFreeIfOutputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfOutputGeneralInCase),"generalTypeInCase"in s&&(s.typedToWildcard=!!s.generalTypeInCase));const r=Object.assign({createEventInCase:!0,wildcardToTyped:!0,typedToWildcard:!0},s);if(!this.graph)throw new NullGraphError;if(i&&typeof i=="number"){const l=this.graph.getNodeById(i);if(!l)return;i=l}const a=i.findSlotByType(t,n,!1,!0);if(a>=0&&a!==null)return a;if(r.createEventInCase&&n==LiteGraph.EVENT){if(t)return-1;if(LiteGraph.do_add_triggers_slots)return i.addOnExecutedOutput()}if(r.typedToWildcard){const l=i.findSlotByType(t,0,!1,!0,!0);if(l>=0)return l}if(r.wildcardToTyped&&(n==0||n=="*"||n=="")){const l={typesNotAccepted:[LiteGraph.EVENT]},h=t?i.findInputSlotFree(l):i.findOutputSlotFree(l);if(h>=0)return h}}findOutputByType(t){return findFreeSlotOfType(this.outputs,t,i=>{var n;return!((n=i.links)!=null&&n.length)})}findInputByType(t){return findFreeSlotOfType(this.inputs,t,i=>i.link==null)}connectByType(t,i,n,s){const o=this.findConnectByTypeSlot(!0,i,n,s);return o!==void 0?this.connect(t,i,o,s==null?void 0:s.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",n,"to node:",i),null)}connectByTypeOutput(t,i,n,s){typeof s=="object"&&("firstFreeIfInputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfInputGeneralInCase),"generalTypeInCase"in s&&(s.typedToWildcard=!!s.generalTypeInCase));const o=this.findConnectByTypeSlot(!1,i,n,s);return o!==void 0?i.connect(o,this,t,s==null?void 0:s.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",n,"to node:",i),null)}canConnectTo(t,i,n){return this.id!==t.id&&LiteGraph.isValidConnection(n.type,i.type)}connect(t,i,n,s){var d;let o;const{graph:r,outputs:a}=this;if(!r)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),null}else if(!a||t>=a.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&typeof i=="number"){const f=r.getNodeById(i);if(!f)throw"target node is null";i=f}if(!i)throw"target node is null";if(i==this)return null;if(typeof n=="string"){if(o=i.findInputSlot(n),o==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${o}`),null}else if(n===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)i.changeMode(LGraphEventMode.ON_TRIGGER),o=i.findInputSlot("onTrigger");else return null;else typeof n=="number"?o=n:o=0;if(i.onBeforeConnectInput){const f=i.onBeforeConnectInput(o,n);o=typeof f=="number"?f:null}if(o===null||!i.inputs||o>=i.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;const l=i.inputs[o],h=a[t];return h?((d=h.links)!=null&&d.length&&h.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(r.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1})),this.connectSlots(h,i,l,s)??null):null}connectSlots(t,i,n,s){var d,f,g,m,_;const{graph:o}=this;if(!o)throw new NullGraphError;const r=this.outputs.indexOf(t);if(r===-1){console.warn("connectSlots: output not found");return}const a=i.inputs.indexOf(n);if(a===-1){console.warn("connectSlots: input not found");return}if(!LiteGraph.isValidConnection(t.type,n.type))return this.setDirtyCanvas(!1,!0),null;if(((d=i.onConnectInput)==null?void 0:d.call(i,a,t.type,t,this,r))===!1||((f=this.onConnectOutput)==null?void 0:f.call(this,r,n.type,n,i,a))===!1)return null;((g=i.inputs[a])==null?void 0:g.link)!=null&&(o.beforeChange(),i.disconnectInput(a,!0));const l=new LLink(++o.state.lastLinkId,n.type||t.type,this.id,r,i.id,a,s);o._links.set(l.id,l),t.links??(t.links=[]),t.links.push(l.id),i.inputs[a].link=l.id;const h=LLink.getReroutes(o,l);for(const y of h)y.linkIds.add(l.id),y.floating&&delete y.floating,y._dragging=void 0;const c=h.at(-1);if(c)for(const y of c.floatingLinkIds){const b=o.floatingLinks.get(y);(b==null?void 0:b.parentId)===c.id&&o.removeFloatingLink(b)}return o._version++,(m=this.onConnectionsChange)==null||m.call(this,NodeSlotType.OUTPUT,r,!0,l,t),(_=i.onConnectionsChange)==null||_.call(i,NodeSlotType.INPUT,a,!0,l,n),this.setDirtyCanvas(!1,!0),o.afterChange(),l}connectFloatingReroute(t,i,n){var g,m;const{graph:s,id:o}=this;if(!s)throw new NullGraphError;const r=this.inputs.indexOf(i),a=this.outputs.indexOf(i);if(r===-1&&a===-1)throw new Error("Invalid slot");const l=a===-1?"input":"output",h=s.setReroute({pos:t,parentId:n,linkIds:[],floating:{slotType:l}}),c=s.getReroute(n),d=((g=c==null?void 0:c.floating)==null?void 0:g.slotType)==="output";if(n==null||!d){const _=new LLink(-1,i.type,a===-1?-1:o,a,r===-1?-1:o,r);return _.parentId=h.id,s.addFloatingLink(_),h}if(!c)throw new Error("[connectFloatingReroute] Parent reroute not found");const f=(m=c.getFloatingLinks("output"))==null?void 0:m[0];if(!f)throw new Error("[connectFloatingReroute] Floating link not found");return h.floatingLinkIds.add(f.id),f.parentId=h.id,delete c.floating,h}disconnectOutput(t,i){var r,a,l,h,c;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const n=this.outputs[t];if(!n)return!1;if(n._floatingLinks)for(const d of n._floatingLinks)d.hasOrigin(this.id,t)&&((r=this.graph)==null||r.removeFloatingLink(d));if(!n.links||n.links.length==0)return!1;const{links:s}=n,o=this.graph;if(!o)throw new NullGraphError;if(i){const d=typeof i=="number"?o.getNodeById(i):i;if(!d)throw"Target Node not found";for(const[f,g]of s.entries()){const m=o._links.get(g);if((m==null?void 0:m.target_id)!=d.id)continue;s.splice(f,1);const _=d.inputs[m.target_slot];_.link=null,m.disconnect(o,"input"),o._version++,(a=d.onConnectionsChange)==null||a.call(d,NodeSlotType.INPUT,m.target_slot,!1,m,_),(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.OUTPUT,t,!1,m,n);break}}else{for(const d of s){const f=o._links.get(d);if(!f)continue;const g=o.getNodeById(f.target_id);if(o._version++,g){const m=g.inputs[f.target_slot];m.link=null,(h=g.onConnectionsChange)==null||h.call(g,NodeSlotType.INPUT,f.target_slot,!1,f,m)}f.disconnect(o,"input"),(c=this.onConnectionsChange)==null||c.call(this,NodeSlotType.OUTPUT,t,!1,f,n)}n.links=null}return this.setDirtyCanvas(!1,!0),!0}disconnectInput(t,i){var r,a,l,h;if(typeof t=="string"){if(t=this.findInputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const n=this.inputs[t];if(!n)return console.debug("disconnectInput: input not found",t,this.inputs),!1;const{graph:s}=this;if(!s)throw new NullGraphError;if((r=n._floatingLinks)!=null&&r.size)for(const c of n._floatingLinks)s.removeFloatingLink(c);const o=this.inputs[t].link;if(o!=null){this.inputs[t].link=null;const c=s._links.get(o);if(c){if(c.origin_id===-10&&"inputNode"in s)return s.inputNode._disconnectNodeInput(this,n,c),!0;const d=s.getNodeById(c.origin_id);if(!d)return console.debug("disconnectInput: target node not found",c.origin_id),!1;const f=d.outputs[c.origin_slot];if(!((a=f==null?void 0:f.links)!=null&&a.length))return console.debug("disconnectInput: output not found",c.origin_slot),!1;let g=0;for(const m=f.links.length;g<m;g++)if(f.links[g]==o){f.links.splice(g,1);break}c.disconnect(s,i?"output":void 0),s&&s._version++,(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.INPUT,t,!1,c,n),(h=d.onConnectionsChange)==null||h.call(d,NodeSlotType.OUTPUT,g,!1,c,f)}}return this.setDirtyCanvas(!1,!0),!0}getConnectionPos(t,i,n){var f,g;n||(n=new Float32Array(2));const{pos:[s,o],inputs:r,outputs:a}=this;if(this.flags.collapsed){const m=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return n[0]=t?s:s+m,n[1]=o-LiteGraph.NODE_TITLE_HEIGHT*.5,n}if(t&&i==-1)return n[0]=s+LiteGraph.NODE_TITLE_HEIGHT*.5,n[1]=o+LiteGraph.NODE_TITLE_HEIGHT*.5,n;const l=(f=r==null?void 0:r[i])==null?void 0:f.pos,h=(g=a==null?void 0:a[i])==null?void 0:g.pos;if(t&&l)return n[0]=s+l[0],n[1]=o+l[1],n;if(!t&&h)return n[0]=s+h[0],n[1]=o+h[1],n;const c=LiteGraph.NODE_SLOT_HEIGHT*.5,d=t?I(this,H,Ue).indexOf(this.inputs[i]):I(this,H,Ve).indexOf(this.outputs[i]);return n[0]=t?s+c:s+this.size[0]+1-c,n[1]=o+(d+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n}getInputPos(t){return this.getInputSlotPos(this.inputs[t])}getInputSlotPos(t){const{pos:[i,n]}=this;if(this.flags.collapsed){const h=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i,n-h]}const{pos:s}=t;if(s)return[i+s[0],n+s[1]];const o=LiteGraph.NODE_SLOT_HEIGHT*.5,r=this.constructor.slot_start_y||0,l=(I(this,H,Ue).indexOf(t)+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o,n+l+r]}getOutputPos(t){var d;const{pos:[i,n],outputs:s,size:[o]}=this;if(this.flags.collapsed){const f=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,g=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i+f,n-g]}const r=(d=s==null?void 0:s[t])==null?void 0:d.pos;if(r)return[i+r[0],n+r[1]];const a=LiteGraph.NODE_SLOT_HEIGHT*.5,l=this.constructor.slot_start_y||0,c=(I(this,H,Ve).indexOf(this.outputs[t])+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o+1-a,n+c+l]}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}alignToGrid(){this.snapToGrid(LiteGraph.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>J.MAX_CONSOLE&&this.console.shift()}setDirtyCanvas(t,i){var n;(n=this.graph)==null||n.canvasAction(s=>s.setDirty(t,i))}loadImage(t){const i=new Image;i.src=LiteGraph.node_images_path+t,i.ready=!1;const n=()=>this.setDirtyCanvas(!0);return i.addEventListener("load",function(){this.ready=!0,n()}),i}captureInput(t){if(warnDeprecated("[DEPRECATED] captureInput will be removed in a future version. Please use LGraphCanvas.pointer (CanvasPointer) instead."),!this.graph||!this.graph.list_of_graphcanvas)return;const i=this.graph.list_of_graphcanvas;for(const n of i)!t&&n.node_capturing_input!=this||(n.node_capturing_input=t?this:null)}get collapsed(){return!!this.flags.collapsed}get collapsible(){return!this.pinned&&this.constructor.collapsable!==!1}collapse(t){if(!(!this.collapsible&&!t)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0)}}toggleAdvanced(){var t;if((t=this.widgets)!=null&&t.some(i=>i.advanced)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.showAdvanced=!this.showAdvanced,this.expandToFitContent(),this.setDirtyCanvas(!0,!0)}}get pinned(){return!!this.flags.pinned}pin(t){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.pinned=t??!this.flags.pinned,this.resizable=!this.pinned,this.pinned||delete this.flags.pinned}unpin(){this.pin(!1)}localToScreen(t,i,n){return[(t+this.pos[0])*n.scale+n.offset[0],(i+this.pos[1])*n.scale+n.offset[1]]}get width(){return this.collapsed?this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH:this.size[0]}get height(){return LiteGraph.NODE_TITLE_HEIGHT+this.bodyHeight}get bodyHeight(){return this.collapsed?0:this.size[1]}drawBadges(t,{gap:i=2}={}){const n=this.badges.map(a=>a instanceof LGraphBadge?a:a());let o=this.badgePosition===BadgePosition.TopLeft?0:this.width-n.reduce((a,l)=>a+l.getWidth(t)+i,0);const r=-(LiteGraph.NODE_TITLE_HEIGHT+i);for(const a of n)a.draw(t,o,r-a.height),o+=a.getWidth(t)+i}drawTitleBarBackground(t,{scale:i,title_height:n=LiteGraph.NODE_TITLE_HEIGHT,low_quality:s=!1}){const o=this.renderingColor,r=this.renderingShape,a=this.renderingSize;if(this.onDrawTitleBar){this.onDrawTitleBar(t,n,a,i,o);return}this.title_mode!==TitleMode.TRANSPARENT_TITLE&&(this.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),t.fillStyle=this.constructor.title_color||o,t.beginPath(),r==RenderShape.BOX||s?t.rect(0,-n,a[0],n):(r==RenderShape.ROUND||r==RenderShape.CARD)&&t.roundRect(0,-n,a[0],n,this.collapsed?[LiteGraph.ROUND_RADIUS]:[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]),t.fill(),t.shadowColor="transparent")}drawTitleBox(t,{scale:i,low_quality:n=!1,title_height:s=LiteGraph.NODE_TITLE_HEIGHT,box_size:o=10}){const r=this.renderingSize,a=this.renderingShape;if(this.onDrawTitleBox){this.onDrawTitleBox(t,s,r,i);return}[RenderShape.ROUND,RenderShape.CIRCLE,RenderShape.CARD].includes(a)?(n&&(t.fillStyle="black",t.beginPath(),t.arc(s*.5,s*-.5,o*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=this.renderingBoxColor,n?t.fillRect(s*.5-o*.5,s*-.5-o*.5,o,o):(t.beginPath(),t.arc(s*.5,s*-.5,o*.5,0,Math.PI*2),t.fill())):(n&&(t.fillStyle="black",t.fillRect((s-o)*.5-1,(s+o)*-.5-1,o+2,o+2)),t.fillStyle=this.renderingBoxColor,t.fillRect((s-o)*.5,(s+o)*-.5,o,o))}drawTitleText(t,{scale:i,default_title_color:n,low_quality:s=!1,title_height:o=LiteGraph.NODE_TITLE_HEIGHT}){var c;const r=this.renderingSize,a=this.selected;if(this.onDrawTitleText){this.onDrawTitleText(t,o,r,i,this.titleFontStyle,a);return}if(s)return;t.font=this.titleFontStyle;const l=this.getTitle()??`âŒ ${this.type}`,h=String(l)+(this.pinned?"ðŸ“Œ":"");if(h){a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=this.constructor.title_text_color||n;let d=r[0]-o*2;if(((c=this.title_buttons)==null?void 0:c.length)>0){let g=0;const m=t.font;for(const _ of this.title_buttons)_.visible&&(g+=_.getWidth(t)+2);t.font=m,g>0&&(g+=10,d-=g)}let f=h;this.collapsed?f=h.substr(0,20):d>0&&(f=truncateText(t,h,d)),t.textAlign="left",t.fillText(f,o,LiteGraph.NODE_TITLE_TEXT_Y-o)}}connectInputToOutput(){const{inputs:t,outputs:i,graph:n}=this;if(!t||!i)return;if(!n)throw new NullGraphError;const{_links:s}=n;let o=!1;for(const[a,l]of t.entries()){if(l.link==null)continue;const h=i[a];if(!h||!LiteGraph.isValidConnection(l.type,h.type))continue;const c=s.get(l.link);if(!c)continue;const d=n.getNodeById(c==null?void 0:c.origin_id);d&&r(h,d,c,n)}if(!(this.flags.keepAllLinksOnBypass??J.keepAllLinksOnBypass))return o;for(const a of t){if(a.link==null)continue;const l=s.get(a.link);if(!l)continue;const h=n.getNodeById(l==null?void 0:l.origin_id);if(h){for(const c of i)if(LiteGraph.isValidConnection(a.type,c.type)){r(c,h,l,n);break}}}return o;function r(a,l,h,c){var f;const d=(f=a.links)==null?void 0:f.map(g=>s.get(g)).filter(g=>!!g);if(d!=null&&d.length)for(const g of d){const m=c.getNodeById(g.target_id);if(!m)continue;const _=l.connect(h.origin_slot,m,g.target_slot,h.parentId);o||(o=!!_)}}}isWidgetVisible(t){return!(this.collapsed||t.hidden||t.advanced&&!this.showAdvanced)}drawWidgets(t,{lowQuality:i=!1,editorAlpha:n=1}){var l,h;if(!this.widgets)return;const s=this.size[0],{widgets:o}=this,r=LiteGraph.NODE_WIDGET_HEIGHT,a=!i;t.save(),t.globalAlpha=n;for(const c of o){if(!this.isWidgetVisible(c))continue;const{y:d}=c,f=c.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR;c.last_y=d,c.computedDisabled=c.disabled||((l=this.getSlotFromWidget(c))==null?void 0:l.link)!=null,t.strokeStyle=f,t.fillStyle="#222",t.textAlign="left",c.computedDisabled&&(t.globalAlpha*=.5);const g=c.width||s;typeof c.draw=="function"?c.draw(t,this,g,d,r,i):(h=toConcreteWidget(c,this,!1))==null||h.drawWidget(t,{width:g,showText:a}),t.globalAlpha=n}t.restore()}drawCollapsedSlots(t){var i;for(const n of I(this,_t))if(n.link!=null){n.drawCollapsed(t);break}for(const n of I(this,Lt))if((i=n.links)!=null&&i.length){n.drawCollapsed(t);break}}get slots(){return[...this.inputs,...this.outputs]}getSlotFromWidget(t){if(t)return this.inputs.find(i=>isWidgetInputSlot(i)&&i.widget.name===t.name)}getWidgetFromSlot(t){var i;if(isWidgetInputSlot(t))return(i=this.widgets)==null?void 0:i.find(n=>n.name===t.widget.name)}drawSlots(t,{fromSlot:i,colorContext:n,editorAlpha:s,lowQuality:o}){for(const r of[...I(this,_t),...I(this,Lt)]){const a=i&&r.isValidTarget(i),l=O(this,H,ci).call(this,r),h=!i||a,c=h&&l;(l||a||!r.isWidgetInputSlot||O(this,H,di).call(this,this.getWidgetFromSlot(r))||r.isConnected)&&(t.globalAlpha=h?s:.4*s,r.draw(t,{colorContext:n,lowQuality:o,highlight:c}))}}_setConcreteSlots(){W(this,_t,this.inputs.map(t=>toClass(NodeInputSlot,t,this))),W(this,Lt,this.outputs.map(t=>toClass(NodeOutputSlot,t,this)))}arrange(){const t=O(this,H,hi).call(this),i=t?t[1]+t[3]-this.pos[1]:0;O(this,H,pi).call(this,i),O(this,H,fi).call(this)}drawProgressBar(t){if(!this.progress)return;const i=t.fillStyle;t.fillStyle="green",t.fillRect(0,0,this.width*this.progress,6),t.fillStyle=i}};_t=new WeakMap,Lt=new WeakMap,ie=new WeakMap,ne=new WeakMap,H=new WeakSet,ai=function(){if(this.has_errors)return{padding:12,lineWidth:10,color:LiteGraph.NODE_ERROR_COLOUR}},li=function(){if(this.selected)return{padding:this.has_errors?20:void 0}},He=function(t,i){var r,a,l;const s=Object.assign({returnObj:!1,typesNotAccepted:[]},i||{}),o=t==null?void 0:t.length;if(!(o>0))return-1;for(let h=0;h<o;++h){const c=t[h];if(!(!c||c.link||(r=c.links)!=null&&r.length)&&!((l=(a=s.typesNotAccepted)==null?void 0:a.includes)!=null&&l.call(a,c.type)))return s.returnObj?c:h}return-1},me=function(t,i,n,s,o){var h;const r=t==null?void 0:t.length;if(!r)return-1;(i==""||i=="*")&&(i=0);const a=String(i).toLowerCase().split(",");let l=null;for(let c=0;c<r;++c){const d=t[c],f=d.type=="0"||d.type=="*"?["0"]:String(d.type).toLowerCase().split(",");for(const g of a){const m=g=="_event_"?LiteGraph.EVENT:g;for(const _ of f){const y=_=="_event_"?LiteGraph.EVENT:_;if(m==y||m==="*"||y==="*"){if(s&&((h=d.links)!=null&&h.length||d.link!=null)){l??(l=n?d:c);continue}return n?d:c}}}}return o?-1:l??-1},Ue=function(){return this.inputs.filter(t=>{var i;return!t.pos&&!((i=this.widgets)!=null&&i.length&&isWidgetInputSlot(t))})},Ve=function(){return this.outputs.filter(t=>!t.pos)},Ae=function(t,i,n){const s=n?this.getInputPos(i):this.getOutputPos(i);t.boundingRect[0]=s[0]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[1]=s[1]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[2]=t.isWidgetInputSlot?BaseWidget.margin:LiteGraph.NODE_SLOT_HEIGHT,t.boundingRect[3]=LiteGraph.NODE_SLOT_HEIGHT},hi=function(){var i;const t=[];for(const[n,s]of I(this,_t).entries())(i=this.widgets)!=null&&i.length&&isWidgetInputSlot(s)||(O(this,H,Ae).call(this,s,n,!0),t.push(s));for(const[n,s]of I(this,Lt).entries())O(this,H,Ae).call(this,s,n,!1),t.push(s);return t.length?createBounds(t,0):null},ui=function(t){var s;const i=isINodeInputSlot(t),n=((s=this.mouseOver)==null?void 0:s[i?"inputId":"outputId"])??-1;return n===-1?null:i?this.inputs[n]:this.outputs[n]},ci=function(t){return O(this,H,ui).call(this,t)===t},di=function(t){var i;return t?((i=this.mouseOver)==null?void 0:i.overWidget)===t:!1},pi=function(t){if(!this.widgets||!this.widgets.length)return;const i=this.bodyHeight,n=this.widgets_start_y??(this.widgets_up?0:t)+2;let s=i-n,o=0;const r=[];for(const c of this.widgets)if(c.computeSize){const d=c.computeSize()[1]+4;c.computedHeight=d,o+=d}else if(c.computeLayoutSize){const{minHeight:d,maxHeight:f}=c.computeLayoutSize(this);r.push({minHeight:d,prefHeight:f,w:c})}else{const d=LiteGraph.NODE_WIDGET_HEIGHT+4;c.computedHeight=d,o+=d}s-=o,this.freeWidgetSpace=s;const a=r.map(c=>({minSize:c.minHeight,maxSize:c.prefHeight})),l=distributeSpace(Math.max(0,s),a);for(const[c,d]of r.entries())d.w.computedHeight=l[c];let h=n;for(const c of this.widgets)c.y=h,h+=c.computedHeight??0;if(!this.graph)throw new NullGraphError;h>i&&(this.setSize([this.size[0],h]),this.graph.setDirtyCanvas(!1,!0))},fi=function(){if(!this.widgets)return;const t=new Map;for(const[i,n]of this.inputs.entries())isWidgetInputSlot(n)&&t.set(n.widget.name,{...n,index:i});if(t.size)for(const i of this.widgets){const n=t.get(i.name);if(!n)continue;const s=I(this,_t)[n.index],o=LiteGraph.NODE_SLOT_HEIGHT*.5;s.pos=[o,i.y+o],O(this,H,Ae).call(this,s,n.index,!0)}},u(J,"title"),u(J,"MAX_CONSOLE"),u(J,"type"),u(J,"category"),u(J,"filter"),u(J,"skip_list"),u(J,"resizeHandleSize",15),u(J,"resizeEdgeSize",5),u(J,"keepAllLinksOnBypass",!1);let LGraphNode=J;function getAllNestedItems(p){const t=new Set;if(p)for(const n of p)i(n,t);return t;function i(n,s){if(!(s.has(n)||n.pinned)&&(s.add(n),n.children))for(const o of n.children)i(o,s)}}function findFirstNode(p){for(const t of p)if(t instanceof LGraphNode)return t}function findFreeSlotOfType(p,t,i){if(!(p!=null&&p.length))return;let n,s,o;const r=parseSlotTypes(t);for(const[a,l]of p.entries()){const h=parseSlotTypes(l.type);for(const c of r)for(const d of h)if(d===c){if(i(l))return{index:a,slot:l};n??(n={index:a,slot:l})}else!s&&(c==="*"||d==="*")&&(i(l)?s={index:a,slot:l}:o??(o={index:a,slot:l}))}return s??n??o}function removeFromArray(p,t){const i=p.indexOf(t),n=i!==-1;return n&&p.splice(i,1),n}class SubgraphInput extends SubgraphSlot{constructor(){super(...arguments);u(this,"events",new CustomEventTarget);P(this,Ut)}get _widget(){var i;return(i=I(this,Ut))==null?void 0:i.deref()}set _widget(i){W(this,Ut,i?new WeakRef(i):void 0)}connect(i,n,s){var d,f;const{subgraph:o}=this.parent,r=n.inputs.indexOf(i);if(((d=n.onConnectInput)==null?void 0:d.call(n,r,this.type,this,this.parent,-1))===!1)return;if(i.link!=null){o.beforeChange();const g=o.getLink(i.link);this.parent._disconnectNodeInput(n,i,g)}const a=n.getWidgetFromSlot(i);if(a){if(!this.matchesWidget(a)){console.warn("Target input has invalid widget.",i,n);return}this._widget??(this._widget=a),this.events.dispatch("input-connected",{input:i,widget:a})}const l=new LLink(++o.state.lastLinkId,i.type,this.parent.id,this.parent.slots.indexOf(this),n.id,r,s);o._links.set(l.id,l),this.linkIds.push(l.id),i.link=l.id;const h=LLink.getReroutes(o,l);for(const g of h)g.linkIds.add(l.id),g.floating&&delete g.floating,g._dragging=void 0;const c=h.at(-1);if(c)for(const g of c.floatingLinkIds){const m=o.floatingLinks.get(g);(m==null?void 0:m.parentId)===c.id&&o.removeFloatingLink(m)}return o._version++,(f=n.onConnectionsChange)==null||f.call(n,NodeSlotType.INPUT,r,!0,l,i),o.afterChange(),l}get labelPos(){const[i,n,,s]=this.boundingRect;return[i,n+s*.5]}getConnectedWidgets(){var s;const{subgraph:i}=this.parent,n=[];for(const o of this.linkIds){const r=i.getLink(o);if(!r){console.error("Link not found",o);continue}const a=r.resolve(i);if(a.input&&((s=a.inputNode)!=null&&s.widgets)){const l=a.input.widget;if(!l)continue;if(!l.name){console.warn("Invalid widget name",l);continue}const h=a.inputNode.widgets.find(c=>c.name===l.name);if(!h){console.warn("Widget not found",l);continue}n.push(h)}else console.debug("No input found on link id",o,r)}return n}matchesWidget(i){var s;const n=(s=I(this,Ut))==null?void 0:s.deref();return n?!(i.type!==n.type||i.options.min!==n.options.min||i.options.max!==n.options.max||i.options.step!==n.options.step||i.options.step2!==n.options.step2||i.options.precision!==n.options.precision):!0}disconnect(){super.disconnect(),this.events.dispatch("input-disconnected",{input:this})}arrange(i){const[n,s,o,r]=i,{boundingRect:a,pos:l}=this;a[0]=n-o,a[1]=s,a[2]=o,a[3]=r,l[0]=n-r*.5,l[1]=s+r*.5}isValidTarget(i){return isNodeSlot(i)?"link"in i&&LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}}Ut=new WeakMap;class EmptySubgraphInput extends SubgraphInput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,n){const{subgraph:s}=this.parent,o=s.inputs.map(l=>l.name),r=nextUniqueName(t.name,o);return s.addInput(r,String(t.type)).connect(t,i,n)}get labelPos(){const[t,i,,n]=this.boundingRect;return[t,i+n*.5]}}class SubgraphInputNode extends SubgraphIONodeBase{constructor(){super(...arguments);u(this,"id",SUBGRAPH_INPUT_ID);u(this,"emptySlot",new EmptySubgraphInput(this))}get slots(){return this.subgraph.inputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i,,n]=this.boundingRect;return i+n-SubgraphIONodeBase.roundedRadius}onPointerDown(i,n,s){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(n.onDragStart=()=>{s.dragNewFromSubgraphInput(this.subgraph,this,o)},n.onDragEnd=a=>{s.dropLinks(this.subgraph,a)},n.finally=()=>{s.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,n){this.subgraph.renameInput(i,n)}removeSlot(i){this.subgraph.removeInput(i)}canConnectTo(i,n,s){return i.canConnectTo(this,n,s)}connectSlots(i,n,s,o){const{subgraph:r}=this,a=this.slots.indexOf(i),l=n.inputs.indexOf(s);if(a===-1||l===-1)throw new Error("Invalid slot indices.");return new LLink(++r.state.lastLinkId,s.type||i.type,this.id,a,n.id,l,o)}connectByType(i,n,s,o){const r=n.findInputByType(s);if(r){if(i===-1){const a=this.subgraph.addInput(r.slot.name,String(r.slot.type??"")),l=this.slots.indexOf(a);if(l===-1){console.error("Could not find newly created subgraph input slot.");return}i=l}return this.slots[i].connect(r.slot,n,o==null?void 0:o.afterRerouteId)}}findOutputSlot(i){return this.slots.find(n=>n.name===i)}findOutputByType(i){var n;return(n=findFreeSlotOfType(this.slots,i,s=>s.linkIds.length>0))==null?void 0:n.slot}_disconnectNodeInput(i,n,s){var h,c;const{subgraph:o}=this;if((h=n._floatingLinks)!=null&&h.size)for(const d of n._floatingLinks)o.removeFloatingLink(d);if(n.link=null,o.setDirtyCanvas(!1,!0),!s)return;const r=s.origin_slot;s.disconnect(o,"output"),o._version++;const a=this.slots.at(r);if(!a){console.debug("disconnectNodeInput: subgraphInput not found",this,r);return}const l=a.linkIds.indexOf(s.id);l!==-1?a.linkIds.splice(l,1):console.debug("disconnectNodeInput: link ID not found in subgraphInput linkIds",s.id),(c=i.onConnectionsChange)==null||c.call(i,NodeSlotType.OUTPUT,l,!1,s,a)}drawProtected(i,n,s,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,h,c,d]=this.boundingRect;i.translate(l,h),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(c-r,r,r,Math.PI*1.5,0),i.moveTo(c,r),i.lineTo(c,d-r),i.arc(c-r,d-r,r,0,Math.PI*.5),i.stroke(),i.setTransform(a),this.drawSlots(i,n,s,o)}}class FloatingRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){u(this,"node");u(this,"fromSlot");u(this,"fromPos");u(this,"fromDirection");u(this,"fromSlotIndex");u(this,"outputNodeId",-1);u(this,"outputNode");u(this,"outputSlot");u(this,"outputIndex",-1);u(this,"outputPos");u(this,"inputNodeId",-1);u(this,"inputNode");u(this,"inputSlot");u(this,"inputIndex",-1);u(this,"inputPos");this.network=t,this.link=i,this.toType=n,this.fromReroute=s,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:h}=i;if(r!==-1){const c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const d=c==null?void 0:c.outputs.at(l);if(!d)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=d,this.outputIndex=l,this.outputPos=c.getOutputPos(l),this.node=c,this.fromSlot=d,this.fromPos=(s==null?void 0:s.pos)??this.outputPos,this.fromDirection=LinkDirection.LEFT,this.dragDirection=LinkDirection.RIGHT,this.fromSlotIndex=l}else{const c=t.getNodeById(a)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const d=c==null?void 0:c.inputs.at(h);if(!d)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${h}] not found.`);this.inputNodeId=a,this.inputNode=c,this.inputSlot=d,this.inputIndex=h,this.inputPos=c.getInputPos(h),this.node=c,this.fromSlot=d,this.fromDirection=LinkDirection.RIGHT,this.fromSlotIndex=h}this.fromPos=s.pos}canConnectToInput(){return this.toType==="input"}canConnectToOutput(){return this.toType==="output"}canConnectToReroute(t){var i,n;if(this.toType==="input"){if(t.origin_id===((i=this.inputNode)==null?void 0:i.id))return!1}else if(t.origin_id===((n=this.outputNode)==null?void 0:n.id))return!1;return!0}connectToInput(t,i,n){var o;const s=this.link;s.target_id=t.id,s.target_slot=t.inputs.indexOf(i),t.disconnectInput(t.inputs.indexOf(i)),(o=this.fromSlot._floatingLinks)==null||o.delete(s),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(s)}connectToOutput(t,i,n){var o;const s=this.link;s.origin_id=t.id,s.origin_slot=t.outputs.indexOf(i),(o=this.fromSlot._floatingLinks)==null||o.delete(s),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(s)}connectToSubgraphInput(t,i){var s;const n=this.link;n.origin_id=SUBGRAPH_INPUT_ID,n.origin_slot=t.parent.slots.indexOf(t),(s=this.fromSlot._floatingLinks)==null||s.delete(n),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(n)}connectToSubgraphOutput(t,i){var s;const n=this.link;n.origin_id=SUBGRAPH_OUTPUT_ID,n.origin_slot=t.parent.slots.indexOf(t),(s=this.fromSlot._floatingLinks)==null||s.delete(n),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(n)}connectToRerouteInput(t,{node:i,input:n},s){var r;const o=this.link;o.target_id=i.id,o.target_slot=i.inputs.indexOf(n),(r=this.fromSlot._floatingLinks)==null||r.delete(o),n._floatingLinks??(n._floatingLinks=new Set),n._floatingLinks.add(o),s.dispatch("input-moved",this)}connectToRerouteOutput(t,i,n,s){var r;const o=this.link;o.origin_id=i.id,o.origin_slot=i.outputs.indexOf(n),(r=this.fromSlot._floatingLinks)==null||r.delete(o),n._floatingLinks??(n._floatingLinks=new Set),n._floatingLinks.add(o),s.dispatch("output-moved",this)}}class MovingLinkBase{constructor(t,i,n,s,o=LinkDirection.CENTER){u(this,"outputNodeId");u(this,"outputNode");u(this,"outputSlot");u(this,"outputIndex");u(this,"outputPos");u(this,"inputNodeId");u(this,"inputNode");u(this,"inputSlot");u(this,"inputIndex");u(this,"inputPos");this.network=t,this.link=i,this.toType=n,this.fromReroute=s,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:h}=i,c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const d=c.outputs.at(l);if(!d)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=d,this.outputIndex=l,this.outputPos=c.getOutputPos(l);const f=t.getNodeById(a)??void 0;if(!f)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const g=f.inputs.at(h);if(!g)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${h}] not found.`);this.inputNodeId=a,this.inputNode=f,this.inputSlot=g,this.inputIndex=h,this.inputPos=f.getInputPos(h)}}class MovingInputLink extends MovingLinkBase{constructor(i,n,s,o=LinkDirection.CENTER){super(i,n,"input",s,o);u(this,"toType","input");u(this,"node");u(this,"fromSlot");u(this,"fromPos");u(this,"fromDirection");u(this,"fromSlotIndex");this.node=this.outputNode,this.fromSlot=this.outputSlot,this.fromPos=(s==null?void 0:s.pos)??this.outputPos,this.fromDirection=LinkDirection.NONE,this.fromSlotIndex=this.outputIndex}canConnectToInput(i,n){return this.node.canConnectTo(i,n,this.outputSlot)}canConnectToOutput(){return!1}canConnectToReroute(i){return i.origin_id!==this.inputNode.id}connectToInput(i,n,s){var r;if(n===this.inputSlot)return;this.inputNode.disconnectInput(this.inputIndex,!0);const o=this.outputNode.connectSlots(this.outputSlot,i,n,(r=this.fromReroute)==null?void 0:r.id);return o&&s.dispatch("input-moved",this),o}connectToOutput(){throw new Error("MovingInputLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("MovingInputLink cannot connect to a subgraph input.")}connectToSubgraphOutput(i,n){var o;const s=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);n==null||n.dispatch("link-created",s)}connectToRerouteInput(i,{node:n,input:s,link:o},r,a){const{outputNode:l,outputSlot:h,fromReroute:c}=this;for(const f of a){if(f.id===this.link.parentId)break;f.totalLinks===1&&f.remove()}i.parentId=c==null?void 0:c.id,l.connectSlots(h,n,s,o.parentId)&&r.dispatch("input-moved",this)}connectToRerouteOutput(){throw new Error("MovingInputLink cannot connect to an output.")}disconnect(){return this.inputNode.disconnectInput(this.inputIndex,!0)}}class MovingOutputLink extends MovingLinkBase{constructor(i,n,s,o=LinkDirection.CENTER){super(i,n,"output",s,o);u(this,"toType","output");u(this,"node");u(this,"fromSlot");u(this,"fromPos");u(this,"fromDirection");u(this,"fromSlotIndex");this.node=this.inputNode,this.fromSlot=this.inputSlot,this.fromPos=(s==null?void 0:s.pos)??this.inputPos,this.fromDirection=LinkDirection.LEFT,this.fromSlotIndex=this.inputIndex}canConnectToInput(){return!1}canConnectToOutput(i,n){return i.canConnectTo(this.node,this.inputSlot,n)}canConnectToReroute(i){return i.origin_id!==this.outputNode.id}connectToInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToOutput(i,n,s){if(n===this.outputSlot)return;const o=i.connectSlots(n,this.inputNode,this.inputSlot,this.link.parentId);return o&&s.dispatch("output-moved",this),o}connectToSubgraphInput(i,n){var o;const s=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);n==null||n.dispatch("link-created",s)}connectToSubgraphOutput(){throw new Error("MovingOutputLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToRerouteOutput(i,n,s,o){var c;const{inputNode:r,inputSlot:a,fromReroute:l}=this,h=((c=i==null?void 0:i.floating)==null?void 0:c.slotType)==="output";l?l.parentId=i.id:this.link.parentId=i.id,n.connectSlots(s,r,a,this.link.parentId),h&&i.removeAllFloatingLinks(),o.dispatch("output-moved",this)}disconnect(){return this.outputNode.disconnectOutput(this.outputIndex,this.inputNode)}}class ToInputFromIoNodeLink{constructor(t,i,n,s,o=LinkDirection.CENTER,r){u(this,"toType","input");u(this,"fromSlotIndex");u(this,"fromPos");u(this,"fromDirection",LinkDirection.RIGHT);u(this,"existingLink");this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const a=i.slots.indexOf(n);if(a===-1&&n!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=a,this.fromPos=s?s.pos:n.pos,this.existingLink=r}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,n){const{fromSlot:s,fromReroute:o,existingLink:r}=this,a=s.connect(i,t,o==null?void 0:o.id);r?n.dispatch("input-moved",this):n.dispatch("link-created",a)}connectToSubgraphOutput(){throw new Error("Not implemented")}connectToRerouteInput(t,{node:i,input:n,link:s},o,r){var d;const{fromSlot:a,fromReroute:l}=this,h=((d=l==null?void 0:l.floating)==null?void 0:d.slotType)==="output";t.parentId=l==null?void 0:l.id;const c=a.connect(n,i,s.parentId);h&&l.removeAllFloatingLinks();for(const f of r){if(f.id===(l==null?void 0:l.id))break;if(f.removeLink(s),f.totalLinks===0)if(s.isFloating)f.remove();else{const g=s.toFloating("output",f.id);this.network.addFloatingLink(g),f.floating={slotType:"output"}}}this.existingLink?o.dispatch("input-moved",this):o.dispatch("link-created",c)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToInputRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){u(this,"toType","input");u(this,"fromPos");u(this,"fromSlotIndex");u(this,"fromDirection",LinkDirection.RIGHT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.outputs.indexOf(n);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:this.node.getOutputPos(r)}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,n){const{node:s,fromSlot:o,fromReroute:r}=this;if(t===s)return;const a=s.connectSlots(o,t,i,r==null?void 0:r.id);n.dispatch("link-created",a)}connectToSubgraphOutput(t,i){var s;const n=t.connect(this.fromSlot,this.node,(s=this.fromReroute)==null?void 0:s.id);i.dispatch("link-created",n)}connectToRerouteInput(t,{node:i,input:n,link:s},o,r){var f;const{node:a,fromSlot:l,fromReroute:h}=this,c=((f=h==null?void 0:h.floating)==null?void 0:f.slotType)==="output";t.parentId=h==null?void 0:h.id;const d=a.connectSlots(l,i,n,s.parentId);c&&h.removeAllFloatingLinks();for(const g of r){if(g.id===(h==null?void 0:h.id))break;if(g.removeLink(s),g.totalLinks===0)if(s.isFloating)g.remove();else{const m=s.toFloating("output",g.id);this.network.addFloatingLink(m),g.floating={slotType:"output"}}}o.dispatch("link-created",d)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToOutputFromIoNodeLink{constructor(t,i,n,s,o=LinkDirection.CENTER){u(this,"toType","output");u(this,"fromPos");u(this,"fromSlotIndex");u(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.slots.indexOf(n);if(r===-1&&n!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:n.pos}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,n){const{fromSlot:s,fromReroute:o}=this,r=s.connect(i,t,o==null?void 0:o.id);n.dispatch("link-created",r)}connectToSubgraphInput(){throw new Error("Not implemented")}connectToRerouteOutput(t,i,n,s){const{fromSlot:o}=this,r=o.connect(n,i,t==null?void 0:t.id);s.dispatch("link-created",r)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){u(this,"toType","output");u(this,"fromPos");u(this,"fromSlotIndex");u(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.inputs.indexOf(n);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:this.node.getInputPos(r)}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,n){const{node:s,fromSlot:o,fromReroute:r}=this;if(!s)return;const a=t.connectSlots(i,s,o,r==null?void 0:r.id);n.dispatch("link-created",a)}connectToSubgraphInput(t,i){var s;const n=t.connect(this.fromSlot,this.node,(s=this.fromReroute)==null?void 0:s.id);i==null||i.dispatch("link-created",n)}connectToRerouteOutput(t,i,n,s){const{node:o,fromSlot:r}=this,a=i.connectSlots(n,o,r,t==null?void 0:t.id);s.dispatch("link-created",a)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputFromRerouteLink extends ToOutputRenderLink{constructor(t,i,n,s,o){super(t,i,n,s),this.fromReroute=s,this.linkConnector=o}canConnectToReroute(){return!1}connectToOutput(t,i){const n=new ToInputRenderLink(this.network,t,i);this.linkConnector._connectOutputToReroute(this.fromReroute,n)}}class LinkConnector{constructor(t){P(this,Y);u(this,"state",{connectingTo:void 0,multi:!1,draggingExistingLinks:!1,snapLinksPos:void 0});u(this,"events",new CustomEventTarget);u(this,"renderLinks",[]);u(this,"inputLinks",[]);u(this,"outputLinks",[]);u(this,"floatingLinks",[]);u(this,"hiddenReroutes",new Set);u(this,"overWidget");u(this,"overWidgetType");u(this,"overReroute");P(this,se);W(this,se,t)}get isConnecting(){return this.state.connectingTo!==void 0}get draggingExistingLinks(){return this.state.draggingExistingLinks}moveInputLink(t,i){var a,l;if(this.isConnecting)throw new Error("Already dragging links.");const{state:n,inputLinks:s,renderLinks:o}=this,r=i.link;if(r==null){const h=(a=i._floatingLinks)==null?void 0:a.values().next().value;if((h==null?void 0:h.parentId)==null)return;try{const c=t.reroutes.get(h.parentId);if(!c)throw new Error(`Invalid reroute id: [${h.parentId}] for floating link id: [${h.id}].`);const d=new FloatingRenderLink(t,h,"input",c);if(this.events.dispatch("before-move-input",d)===!1)return;o.push(d)}catch(c){console.warn(`Could not create render link for link id: [${h.id}].`,h,c)}h._dragging=!0,this.floatingLinks.push(h)}else{const h=t.links.get(r);if(!h)return;if(h.origin_id===SUBGRAPH_INPUT_ID){const c=(l=t.inputNode)==null?void 0:l.slots[h.origin_slot];if(!c){console.warn(`Could not find subgraph input for slot [${h.origin_slot}]`);return}try{const d=t.getReroute(h.parentId),f=new ToInputFromIoNodeLink(t,t.inputNode,c,d,LinkDirection.CENTER,h);o.push(f),this.listenUntilReset("input-moved",()=>{h.disconnect(t,"input")})}catch(d){console.warn(`Could not create render link for subgraph input link id: [${h.id}].`,h,d);return}h._dragging=!0,s.push(h)}else{try{const c=t.getReroute(h.parentId),d=new MovingInputLink(t,h,c);if(this.events.dispatch("before-move-input",d)===!1)return;o.push(d),this.listenUntilReset("input-moved",g=>{"link"in g.detail&&g.detail.link&&g.detail.link.disconnect(t,"output")})}catch(c){console.warn(`Could not create render link for link id: [${h.id}].`,h,c);return}h._dragging=!0,s.push(h)}}n.connectingTo="input",n.draggingExistingLinks=!0,O(this,Y,ot).call(this,!1)}moveOutputLink(t,i){var o,r;if(this.isConnecting)throw new Error("Already dragging links.");const{state:n,renderLinks:s}=this;if((o=i._floatingLinks)!=null&&o.size)for(const a of i._floatingLinks.values())try{const l=LLink.getFirstReroute(t,a);if(!l)throw new Error(`Invalid reroute id: [${a.parentId}] for floating link id: [${a.id}].`);const h=new FloatingRenderLink(t,a,"output",l);if(this.events.dispatch("before-move-output",h)===!1)continue;s.push(h),this.floatingLinks.push(a)}catch(l){console.warn(`Could not create render link for link id: [${a.id}].`,a,l)}if((r=i.links)!=null&&r.length)for(const a of i.links){const l=t.links.get(a);if(!l)continue;const h=LLink.getFirstReroute(t,l);h?(h._dragging=!0,this.hiddenReroutes.add(h)):l._dragging=!0,this.outputLinks.push(l);try{const c=new MovingOutputLink(t,l,h,LinkDirection.RIGHT);if(this.events.dispatch("before-move-output",c)===!1)continue;s.push(c)}catch(c){console.warn(`Could not create render link for link id: [${l.id}].`,l,c);continue}}s.length!==0&&(n.draggingExistingLinks=!0,n.multi=!0,n.connectingTo="output",O(this,Y,ot).call(this,!0))}dragNewFromOutput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToInputRenderLink(t,i,n,s);this.renderLinks.push(r),o.connectingTo="input",O(this,Y,ot).call(this,!1)}dragNewFromInput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToOutputRenderLink(t,i,n,s);this.renderLinks.push(r),o.connectingTo="output",O(this,Y,ot).call(this,!0)}dragNewFromSubgraphInput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToInputFromIoNodeLink(t,i,n,s);this.renderLinks.push(o),this.state.connectingTo="input",O(this,Y,ot).call(this,!1)}dragNewFromSubgraphOutput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToOutputFromIoNodeLink(t,i,n,s);this.renderLinks.push(o),this.state.connectingTo="output",O(this,Y,ot).call(this,!0)}dragFromReroute(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const n=i.firstLink??i.firstFloatingLink;if(!n){console.warn("No link found for reroute.");return}if(n.origin_id===SUBGRAPH_INPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph input link found in non-subgraph network.");return}const a=t.inputs.at(n.origin_slot);if(!a)throw new Error("No subgraph input found for link.");const l=new ToInputFromIoNodeLink(t,t.inputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="input",O(this,Y,ot).call(this,!1);return}const s=t.getNodeById(n.origin_id);if(!s){console.warn("No output node found for link.",n);return}const o=s.outputs.at(n.origin_slot);if(!o){console.warn("No output slot found for link.",n);return}const r=new ToInputRenderLink(t,s,o,i);r.fromDirection=LinkDirection.NONE,this.renderLinks.push(r),this.state.connectingTo="input",O(this,Y,ot).call(this,!1)}dragFromRerouteToOutput(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const n=i.firstLink??i.firstFloatingLink;if(!n){console.warn("No link found for reroute.");return}if(n.target_id===SUBGRAPH_OUTPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph output link found in non-subgraph network.");return}const a=t.outputs.at(n.target_slot);if(!a)throw new Error("No subgraph output found for link.");const l=new ToOutputFromIoNodeLink(t,t.outputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="output",O(this,Y,ot).call(this,!1);return}const s=t.getNodeById(n.target_id);if(!s){console.warn("No input node found for link.",n);return}const o=s.inputs.at(n.target_slot);if(!o){console.warn("No input slot found for link.",n);return}const r=new ToOutputFromRerouteLink(t,s,o,i,this);r.fromDirection=LinkDirection.LEFT,this.renderLinks.push(r),this.state.connectingTo="output",O(this,Y,ot).call(this,!0)}dragFromLinkSegment(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const{state:n}=this;if(i.origin_id==null||i.origin_slot==null)return;const s=t.getNodeById(i.origin_id);if(!s)return;const o=s.outputs.at(i.origin_slot);if(!o)return;const r=t.getReroute(i.parentId),a=new ToInputRenderLink(t,s,o,r);a.fromDirection=LinkDirection.NONE,this.renderLinks.push(a),n.connectingTo="input",O(this,Y,ot).call(this,!1)}dropLinks(t,i){var n;if(!(!this.isConnecting&&this.events.dispatch("before-drop-links",{renderLinks:this.renderLinks,event:i})===!1))try{const{canvasX:s,canvasY:o}=i,r=(n=t.getIoNodeOnPos)==null?void 0:n.call(t,s,o);if(r){this.dropOnIoNode(r,i);return}const a=t.getNodeOnPos(s,o)??void 0;if(a)this.dropOnNode(a,i);else{const l=t.getRerouteOnPos(s,o);l&&this.isRerouteValidDrop(l)?this.dropOnReroute(l,i):this.dropOnNothing(i)}}finally{this.events.dispatch("after-drop-links",{renderLinks:this.renderLinks,event:i})}}dropOnIoNode(t,i){const{renderLinks:n,state:s}=this,{connectingTo:o}=s,{canvasX:r,canvasY:a}=i;if(o==="input"&&t instanceof SubgraphOutputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No output slot found for link.");for(const h of n)h.connectToSubgraphOutput(l,this.events)}else if(o==="output"&&t instanceof SubgraphInputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No input slot found for link.");for(const h of n)h.connectToSubgraphInput(l,this.events)}else console.error("Invalid connectingTo state &/ ioNode",o,t)}dropOnNode(t,i){const{renderLinks:n,state:s}=this,{connectingTo:o}=s,{canvasX:r,canvasY:a}=i;if(!n.every(l=>l.node===t)){if(o==="output"){const l=t.getOutputOnPos([r,a]);l?O(this,Y,Xe).call(this,t,l):this.connectToNode(t,i)}else if(o==="input"){const h=t.getInputOnPos([r,a])??t.getSlotFromWidget(this.overWidget);h?O(this,Y,$e).call(this,t,h):this.connectToNode(t,i)}}}dropOnReroute(t,i){if(this.events.dispatch("dropped-on-reroute",{reroute:t,event:i})!==!1){if(this.state.connectingTo==="input"){if(this.renderLinks.length!==1)throw new Error(`Attempted to connect ${this.renderLinks.length} input links to a reroute.`);const s=this.renderLinks[0];this._connectOutputToReroute(t,s);return}for(const s of this.renderLinks){if(s.toType!=="output")continue;const o=t.findSourceOutput();if(!o)continue;const{node:r,output:a}=o;s.canConnectToOutput(r,a)&&s.connectToRerouteOutput(t,r,a,this.events)}}}_connectOutputToReroute(t,i){const n=t.findTargetInputs();if(!(n!=null&&n.length))return;const s=t.getReroutes();if(s===null)throw new Error("Reroute loop detected.");const o=s.slice(0,-1).reverse();if(i instanceof ToInputRenderLink){const{node:a,fromSlot:l,fromSlotIndex:h,fromReroute:c}=i;if(t.setFloatingLinkOrigin(a,l,h),c!=null)for(const d of o){if(d.id===c.id)break;for(const f of t.floatingLinkIds)d.floatingLinkIds.delete(f)}}const r=n.filter(a=>i.toType==="input"&&canConnectInputLinkToReroute(i,a.node,a.input,t));for(const a of r)i.connectToRerouteInput(t,a,this.events,o)}dropOnNothing(t){this.events.dispatch("dropped-on-canvas",t)!==!1&&this.disconnectLinks()}disconnectLinks(){for(const t of this.renderLinks)t instanceof MovingLinkBase&&t.disconnect()}connectToNode(t,i){var r,a;const{state:{connectingTo:n}}=this;if(this.events.dispatch("dropped-on-node",{node:t,event:i})===!1)return;const o=this.renderLinks[0];if(o){if(n==="output"){const l=(r=t.findOutputByType(o.fromSlot.type))==null?void 0:r.slot;if(console.debug("out",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}O(this,Y,Xe).call(this,t,l)}else if(n==="input"){const l=(a=t.findInputByType(o.fromSlot.type))==null?void 0:a.slot;if(console.debug("in",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}O(this,Y,$e).call(this,t,l)}}}isInputValidDrop(t,i){return this.renderLinks.some(n=>n.canConnectToInput(t,i))}isNodeValidDrop(t){return this.state.connectingTo==="output"?t.outputs.some(i=>this.renderLinks.some(n=>n.canConnectToOutput(t,i))):t.inputs.some(i=>this.renderLinks.some(n=>n.canConnectToInput(t,i)))}isRerouteValidDrop(t){if(this.state.connectingTo==="input"){const i=t.findTargetInputs();if(!(i!=null&&i.length))return!1;for(const{node:n,input:s}of i)for(const o of this.renderLinks)if(o.toType==="input"&&canConnectInputLinkToReroute(o,n,s,t))return!0}else{const i=t.findSourceOutput();if(!i)return!1;const{node:n,output:s}=i;for(const o of this.renderLinks)if(o.toType==="output"&&o.canConnectToReroute(t)&&o.canConnectToOutput(n,s))return!0}return!1}export(t){return{renderLinks:[...this.renderLinks],inputLinks:[...this.inputLinks],outputLinks:[...this.outputLinks],floatingLinks:[...this.floatingLinks],state:{...this.state},network:t}}listenUntilReset(t,i,n){this.events.addEventListener(t,i,n),this.events.addEventListener("reset",()=>this.events.removeEventListener(t,i),{once:!0})}reset(t=!1){if(this.events.dispatch("reset",t)===!1)return;const{state:n,outputLinks:s,inputLinks:o,hiddenReroutes:r,renderLinks:a,floatingLinks:l}=this;if(!(!t&&n.connectingTo===void 0)){n.connectingTo=void 0;for(const h of s)delete h._dragging;for(const h of o)delete h._dragging;for(const h of l)delete h._dragging;for(const h of r)delete h._dragging;a.length=0,o.length=0,s.length=0,l.length=0,r.clear(),n.multi=!1,n.draggingExistingLinks=!1,n.snapLinksPos=void 0}}}se=new WeakMap,Y=new WeakSet,$e=function(t,i){for(const n of this.renderLinks)n.canConnectToInput(t,i)&&n.connectToInput(t,i,this.events)},Xe=function(t,i){for(const n of this.renderLinks){if(!n.canConnectToOutput(t,i)){n instanceof MovingOutputLink&&n.link.parentId!==void 0&&n.outputNode.connectSlots(n.outputSlot,n.inputNode,n.inputSlot,void 0);continue}n.connectToOutput(t,i,this.events)}},ot=function(t){const i=this.renderLinks.map(n=>{var a,l;const s=t?n.fromSlot:null,o=t?null:n.fromSlot,r=n instanceof MovingLinkBase?(a=n.link)==null?void 0:a.parentId:(l=n.fromReroute)==null?void 0:l.id;return{node:n.node,slot:n.fromSlotIndex,input:s,output:o,pos:n.fromPos,afterRerouteId:r}});I(this,se).call(this,i)};function canConnectInputLinkToReroute(p,t,i,n){var o,r,a;const{fromReroute:s}=p;if(!p.canConnectToInput(t,i)||(s==null?void 0:s.id)===n.id||(o=s==null?void 0:s.getReroutes())!=null&&o.includes(n))return!1;if(p instanceof ToInputRenderLink){if(n.parentId==null){if((r=n.firstLink)!=null&&r.hasOrigin(p.node.id,p.fromSlotIndex))return!1}else if(((a=p.fromReroute)==null?void 0:a.id)===n.parentId)return!1}return!0}const at=class at{constructor(t){P(this,tt);u(this,"element");u(this,"pointerId");u(this,"dragStarted",!1);u(this,"eLastDown");u(this,"isDouble",!1);u(this,"isDown",!1);u(this,"resizeDirection");u(this,"clearEventsOnReset",!0);u(this,"eDown");u(this,"eMove");u(this,"eUp");P(this,Vt);this.element=t}static get maxClickDrift(){return I(this,St)}static set maxClickDrift(t){W(this,St,t),W(this,oe,t*t)}get finally(){return I(this,Vt)}set finally(t){var i;try{(i=I(this,Vt))==null||i.call(this)}finally{W(this,Vt,t)}}down(t){this.reset(),this.eDown=t,this.pointerId=t.pointerId,this.element.setPointerCapture(t.pointerId)}move(t){var s;const{eDown:i}=this;if(!i)return;if(!t.buttons){this.reset();return}if(!(t.buttons&i.buttons)){O(this,tt,Ye).call(this,t),this.reset();return}if(this.eMove=t,(s=this.onDrag)==null||s.call(this,t),this.dragStarted)return;(t.timeStamp-i.timeStamp>at.bufferTime||!O(this,tt,Ge).call(this,t,i))&&O(this,tt,je).call(this,t)}up(t){var n;if(t.button!==((n=this.eDown)==null?void 0:n.button))return!1;O(this,tt,Ye).call(this,t);const{dragStarted:i}=this;return this.reset(),!i}reset(){this.finally=void 0,delete this.onClick,delete this.onDoubleClick,delete this.onDragStart,delete this.onDrag,delete this.onDragEnd,this.isDown=!1,this.isDouble=!1,this.dragStarted=!1,this.resizeDirection=void 0,this.clearEventsOnReset&&(this.eDown=void 0,this.eMove=void 0,this.eUp=void 0);const{element:t,pointerId:i}=this;this.pointerId=void 0,typeof i=="number"&&t.hasPointerCapture(i)&&t.releasePointerCapture(i)}};St=new WeakMap,oe=new WeakMap,Vt=new WeakMap,tt=new WeakSet,Ye=function(t){var n,s,o;const{eDown:i}=this;i&&(this.eUp=t,this.dragStarted?(n=this.onDragEnd)==null||n.call(this,t):O(this,tt,Ge).call(this,t,i)?this.onDoubleClick&&O(this,tt,gi).call(this)?(this.onDoubleClick(t),this.eLastDown=void 0):((o=this.onClick)==null||o.call(this,t),this.eLastDown=i):(O(this,tt,je).call(this),(s=this.onDragEnd)==null||s.call(this,t)))},Ge=function(t,i,n=I(at,oe)){return dist2(t.clientX,t.clientY,i.clientX,i.clientY)<=n},gi=function(){const{eDown:t,eLastDown:i}=this;if(!t||!i)return!1;const n=(3*I(at,St))**2,s=t.timeStamp-i.timeStamp;return s>0&&s<at.doubleClickTime&&O(this,tt,Ge).call(this,t,i,n)},je=function(t){var i;this.dragStarted=!0,(i=this.onDragStart)==null||i.call(this,this,t),delete this.onDragStart},u(at,"bufferTime",150),u(at,"doubleClickTime",300),P(at,St,6),P(at,oe,I(at,St)**2);let CanvasPointer=at;class DragAndScale{constructor(t){P(this,ve);u(this,"state");u(this,"lastState",{offset:[0,0],scale:0});u(this,"max_scale");u(this,"min_scale");u(this,"enabled");u(this,"last_mouse");u(this,"element");u(this,"visible_area");u(this,"dragging");u(this,"viewport");this.state={offset:[0,0],scale:1},this.max_scale=10,this.min_scale=.1,this.enabled=!0,this.last_mouse=[0,0],this.visible_area=new Rectangle,this.element=t}get offset(){return this.state.offset}set offset(t){this.state.offset[0]=t[0],this.state.offset[1]=t[1]}get scale(){return this.state.scale}set scale(t){this.state.scale=t}computeVisibleArea(t){var d;const{scale:i,offset:n,visible_area:s}=this;if(O(this,ve,_i).call(this)&&((d=this.onChanged)==null||d.call(this,i,n),copyState(this.state,this.lastState)),!this.element){s[0]=s[1]=s[2]=s[3]=0;return}let{width:o,height:r}=this.element,a=-n[0],l=-n[1];t&&(a+=t[0]/i,l+=t[1]/i,o=t[2],r=t[3]);const h=a+o/i,c=l+r/i;s[0]=a,s[1]=l,s.resizeBottomRight(h,c)}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,i){return i=i||[0,0],i[0]=t[0]/this.scale-this.offset[0],i[1]=t[1]/this.scale-this.offset[1],i}mouseDrag(t,i){var n;this.offset[0]+=t/this.scale,this.offset[1]+=i/this.scale,(n=this.onredraw)==null||n.call(this,this)}changeScale(t,i,n=!0){var h;if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t==this.scale)return;const s=this.element.getBoundingClientRect();if(!s)return;i=i??[s.width*.5,s.height*.5];const o=[i[0]-s.x,i[1]-s.y],r=this.convertCanvasToOffset(o);this.scale=t,n&&Math.abs(this.scale-1)<.01&&(this.scale=1);const a=this.convertCanvasToOffset(o),l=[a[0]-r[0],a[1]-r[1]];this.offset[0]+=l[0],this.offset[1]+=l[1],(h=this.onredraw)==null||h.call(this,this)}changeDeltaScale(t,i){this.changeScale(this.scale*t,i)}fitToBounds(t,{zoom:i=.75}={}){const n=this.element.width/window.devicePixelRatio,s=this.element.height/window.devicePixelRatio;let o=this.scale;if(i>0){const c=i*n/Math.max(t[2],300),d=i*s/Math.max(t[3],300);o=Math.min(c,d,this.max_scale)}const r=n/o,a=s/o,l=-t[0]-t[2]*.5+r*.5,h=-t[1]-t[3]*.5+a*.5;this.offset[0]=l,this.offset[1]=h,this.scale=o}animateToBounds(t,i,{duration:n=350,zoom:s=.75,easing:o=EaseFunction.EASE_IN_OUT_QUAD}={}){if(!(n>0))throw new RangeError("Duration must be greater than 0");const r={linear:E=>E,easeInQuad:E=>E*E,easeOutQuad:E=>E*(2-E),easeInOutQuad:E=>E<.5?2*E*E:-1+(4-2*E)*E},a=r[o]??r.linear,l=performance.now(),h=this.element.width/window.devicePixelRatio,c=this.element.height/window.devicePixelRatio,d=this.offset[0],f=this.offset[1],g=d-h/this.scale,m=f-c/this.scale;let y=this.scale;if(s>0){const E=s*h/Math.max(t[2],300),w=s*c/Math.max(t[3],300);y=Math.min(E,w,this.max_scale)}const b=h/y,L=c/y,k=-t[0]-t[2]*.5+b*.5,T=-t[1]-t[3]*.5+L*.5,S=k-b,N=T-L,A=E=>{const w=E-l,R=Math.min(w/n,1),M=a(R),U=d+(k-d)*M,F=f+(T-f)*M;if(this.offset[0]=U,this.offset[1]=F,s>0){const j=g+(S-g)*M,pt=m+(N-m)*M,st=Math.abs(j-U),V=Math.abs(pt-F);this.scale=Math.min(h/st,c/V)}i(),R<1?D=requestAnimationFrame(A):cancelAnimationFrame(D)};let D=requestAnimationFrame(A)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}ve=new WeakSet,_i=function(){const t=this.state,i=this.lastState;return t.scale!==i.scale||t.offset[0]!==i.offset[0]||t.offset[1]!==i.offset[1]};function copyState(p,t){t.scale=p.scale,t.offset[0]=p.offset[0],t.offset[1]=p.offset[1]}function getBoundaryNodes(p){const t=p==null?void 0:p.find(r=>r);if(!t)return null;let i=t,n=t,s=t,o=t;for(const r of p){if(!r)continue;const[a,l]=r.pos,[h,c]=r.size;l<i.pos[1]&&(i=r),a+h>n.pos[0]+n.size[0]&&(n=r),l+c>s.pos[1]+s.size[1]&&(s=r),a<o.pos[0]&&(o=r)}return{top:i,right:n,bottom:s,left:o}}function distributeNodes(p,t){const i=p==null?void 0:p.length;if(!(i>1))return;const n=t?0:1;let s=0,o=-1/0;for(const c of p){s+=c.size[n];const d=c.pos[n]+c.size[n];d>o&&(o=d)}const r=[...p].sort((c,d)=>c.pos[n]-d.pos[n]),a=r[0].pos[n],l=(o-a-s)/(i-1);let h=a;for(let c=0;c<i;c++){const d=r[c];d.pos[n]=h+l*c,h+=d.size[n]}}function alignNodes(p,t,i){if(!p)return;const n=i===void 0?getBoundaryNodes(p):{top:i,right:i,bottom:i,left:i};if(n!==null)for(const s of p)switch(t){case"right":s.pos[0]=n.right.pos[0]+n.right.size[0]-s.size[0];break;case"left":s.pos[0]=n.left.pos[0];break;case"top":s.pos[1]=n.top.pos[1];break;case"bottom":s.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-s.size[1];break}}const cursors={NE:"nesw-resize",SE:"nwse-resize",SW:"nesw-resize",NW:"nwse-resize"},C=class C{constructor(t,i,n){P(this,G);u(this,"state",{draggingItems:!1,draggingCanvas:!1,readOnly:!1,hoveringOver:CanvasItem.Nothing,shouldSetCursor:!0,selectionChanged:!1});P(this,It);u(this,"_previously_dragging_canvas",null);P(this,yt,0);u(this,"options");u(this,"background_image");u(this,"ds");u(this,"pointer");u(this,"zoom_modify_alpha");u(this,"zoom_speed");u(this,"node_title_color");u(this,"default_link_color");u(this,"default_connection_color");u(this,"default_connection_color_byType");u(this,"default_connection_color_byTypeOff");u(this,"colourGetter",{getConnectedColor:t=>this.default_connection_color_byType[t]||this.default_connection_color.output_on,getDisconnectedColor:t=>this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.output_off});u(this,"highquality_render");u(this,"use_gradients");u(this,"editor_alpha");u(this,"pause_rendering");u(this,"clear_background");u(this,"clear_background_color");u(this,"render_only_selected");u(this,"show_info");u(this,"allow_dragcanvas");u(this,"allow_dragnodes");u(this,"allow_interaction");u(this,"multi_select");u(this,"allow_searchbox");u(this,"allow_reconnect_links");u(this,"align_to_grid");u(this,"drag_mode");u(this,"dragging_rectangle");u(this,"filter");u(this,"set_canvas_dirty_on_mouse_event");u(this,"always_render_background");u(this,"render_shadows");u(this,"render_canvas_border");u(this,"render_connections_shadows");u(this,"render_connections_border");u(this,"render_curved_connections");u(this,"render_connection_arrows");u(this,"render_collapsed_slots");u(this,"render_execution_order");u(this,"render_link_tooltip");u(this,"linkMarkerShape",LinkMarkerShape.Circle);u(this,"links_render_mode");u(this,"low_quality_zoom_threshold",.6);u(this,"mouse");u(this,"graph_mouse");u(this,"canvas_mouse");u(this,"onSearchBox");u(this,"onSearchBoxSelection");u(this,"onMouse");u(this,"onDrawBackground");u(this,"onDrawForeground");u(this,"connections_width");u(this,"current_node");u(this,"node_widget");u(this,"over_link_center");u(this,"last_mouse_position");u(this,"visible_area");u(this,"renderedPaths",new Set);u(this,"visible_links",[]);u(this,"connecting_links");u(this,"linkConnector",new LinkConnector(t=>this.connecting_links=t));u(this,"viewport");u(this,"autoresize");u(this,"frame",0);u(this,"last_draw_time",0);u(this,"render_time",0);u(this,"fps",0);u(this,"selected_nodes",{});u(this,"selectedItems",new Set);u(this,"resizingGroup",null);u(this,"selected_group",null);u(this,"visible_nodes",[]);P(this,re,new Set);u(this,"node_over");u(this,"node_capturing_input");u(this,"highlighted_links",{});P(this,lt,new Set);u(this,"dirty_canvas",!0);u(this,"dirty_bgcanvas",!0);u(this,"dirty_nodes",new Map);u(this,"dirty_area");u(this,"node_in_panel");u(this,"last_mouse",[0,0]);u(this,"last_mouseclick",0);u(this,"graph");u(this,"canvas");u(this,"bgcanvas");u(this,"ctx");u(this,"_events_binded");u(this,"bgctx");u(this,"is_rendering");u(this,"block_click");u(this,"last_click_position");u(this,"resizing_node");u(this,"selected_group_resizing");u(this,"last_mouse_dragging");u(this,"onMouseDown");u(this,"_highlight_pos");u(this,"_highlight_input");u(this,"node_panel");u(this,"options_panel");u(this,"_bg_img");u(this,"_pattern");u(this,"_pattern_img");u(this,"prompt_box");u(this,"search_box");u(this,"SELECTED_NODE");u(this,"NODEPANEL_IS_OPEN");P(this,et);P(this,ae,!1);u(this,"dragZoomEnabled",!1);P(this,Tt,null);u(this,"onClear");u(this,"onNodeMoved");u(this,"onSelectionChange");u(this,"onDrawLinkTooltip");u(this,"onDrawOverlay");u(this,"onRenderBackground");u(this,"onNodeDblClicked");u(this,"onShowNodePanel");u(this,"onNodeSelected");u(this,"onNodeDeselected");u(this,"onRender");n||(n={}),this.options=n,this.background_image=C.DEFAULT_BACKGROUND_IMAGE,this.ds=new DragAndScale(t),this.pointer=new CanvasPointer(t),this.linkConnector.events.addEventListener("link-created",()=>O(this,G,ht).call(this)),this.linkConnector.events.addEventListener("reset",()=>{this.connecting_links=null,this.dirty_bgcanvas=!0}),this.linkConnector.events.addEventListener("dropped-on-canvas",s=>{var a;if(!this.connecting_links)return;const o=s.detail;this.emitEvent({subType:"empty-release",originalEvent:o,linkReleaseContext:{links:this.connecting_links}});const r=this.linkConnector.renderLinks[0];if(LiteGraph.release_link_on_empty_shows_menu){const l=this.linkConnector.state.connectingTo==="input"?{node_from:r.node,slot_from:r.fromSlot,type_filter_in:r.fromSlot.type}:{node_to:r.node,slot_to:r.fromSlot,type_filter_out:r.fromSlot.type},h=(a=r.fromReroute)==null?void 0:a.id;"shiftKey"in o&&o.shiftKey?this.allow_searchbox&&this.showSearchBox(o,l):this.linkConnector.state.connectingTo==="input"?this.showConnectionMenu({nodeFrom:r.node,slotFrom:r.fromSlot,e:o,afterRerouteId:h}):this.showConnectionMenu({nodeTo:r.node,slotTo:r.fromSlot,e:o,afterRerouteId:h})}}),this.zoom_modify_alpha=!0,this.zoom_speed=1.1,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.render_only_selected=!0,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_link_tooltip=!0,this.links_render_mode=LinkRenderType.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.connections_width=3,this.current_node=null,this.node_widget=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.connecting_links=null,this.viewport=n.viewport||null,this.graph=i,i==null||i.attachCanvas(this),this.canvas=void 0,this.bgcanvas=void 0,this.ctx=void 0,this.setCanvas(t,n.skip_events),this.clear(),C._measureText=(s,o=this.inner_text_font)=>{const{ctx:r}=this,{font:a}=r;try{return r.font=o,r.measureText(s).width}finally{r.font=a}},n.skip_render||this.startRendering(),this.autoresize=n.autoresize}get subgraph(){return I(this,It)}set subgraph(t){t!==I(this,It)&&(W(this,It,t),t&&this.dispatch("litegraph:set-graph",{oldGraph:I(this,It),newGraph:t}))}dispatch(t,i){const n=new CustomEvent(t,{detail:i,bubbles:!0});return this.canvas.dispatchEvent(n)}dispatchEvent(t,i){this.canvas.dispatchEvent(new CustomEvent(t,{detail:i}))}get read_only(){return this.state.readOnly}set read_only(t){this.state.readOnly=t,O(this,G,Pe).call(this)}get isDragging(){return this.state.draggingItems}set isDragging(t){this.state.draggingItems=t}get hoveringOver(){return this.state.hoveringOver}set hoveringOver(t){this.state.hoveringOver=t,O(this,G,Pe).call(this)}get pointer_is_down(){return this.pointer.isDown}get pointer_is_double(){return this.pointer.isDouble}get dragging_canvas(){return this.state.draggingCanvas}set dragging_canvas(t){this.state.draggingCanvas=t,O(this,G,Pe).call(this)}get title_text_font(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get inner_text_font(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get maximumFps(){return I(this,yt)>Number.EPSILON?I(this,yt)/1e3:0}set maximumFps(t){W(this,yt,t>Number.EPSILON?1e3/t:0)}get round_radius(){return LiteGraph.ROUND_RADIUS}set round_radius(t){LiteGraph.ROUND_RADIUS=t}get low_quality(){return this.ds.scale<this.low_quality_zoom_threshold}get _graph(){if(!this.graph)throw new NullGraphError;return this.graph}static onGroupAdd(t,i,n){const s=C.active_canvas,o=new LiteGraph.LGraphGroup;if(o.pos=s.convertEventToCanvasOffset(n),!s.graph)throw new NullGraphError;s.graph.add(o)}static getBoundaryNodes(t){const i=Array.isArray(t)?t:Object.values(t);return getBoundaryNodes(i)??{top:null,right:null,bottom:null,left:null}}static alignNodes(t,i,n){alignNodes(Object.values(t),i,n),C.active_canvas.setDirty(!0,!0)}static onNodeAlign(t,i,n,s,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:r,parentMenu:s});function r(a){alignNodes(Object.values(C.active_canvas.selected_nodes),a.toLowerCase(),o),C.active_canvas.setDirty(!0,!0)}}static onGroupAlign(t,i,n,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:o,parentMenu:s});function o(r){alignNodes(Object.values(C.active_canvas.selected_nodes),r.toLowerCase()),C.active_canvas.setDirty(!0,!0)}}static createDistributeMenu(t,i,n,s){new LiteGraph.ContextMenu(["Vertically","Horizontally"],{event:n,callback:o,parentMenu:s});function o(r){const a=C.active_canvas;distributeNodes(Object.values(a.selected_nodes),r==="Horizontally"),a.setDirty(!0,!0)}}static onMenuAdd(t,i,n,s,o){const r=C.active_canvas,a=r.getCanvasWindow(),{graph:l}=r;if(!l)return;return h("",s),!1;function h(c,d){if(!l)return;const f=LiteGraph.getNodeTypesCategories(r.filter||l.filter).filter(_=>_.startsWith(c)),g=[];for(const _ of f){if(!_)continue;const y=new RegExp(`^(${c})`),b=_.replace(y,"").split("/",1)[0],L=c===""?`${b}/`:`${c}${b}/`;let k=b;k.includes("::")&&(k=k.split("::",2)[1]),g.findIndex(S=>S.value===L)===-1&&g.push({value:L,content:k,has_submenu:!0,callback:function(S,N,A,D){h(S.value,D)}})}const m=LiteGraph.getNodeTypesInCategory(c.slice(0,-1),r.filter||l.filter);for(const _ of m){if(_.skip_list)continue;const y={value:_.type,content:_.title,has_submenu:!1,callback:function(b,L,k,T){if(!r.graph)throw new NullGraphError;const S=T.getFirstEvent();r.graph.beforeChange();const N=LiteGraph.createNode(b.value);if(N){if(!S)throw new TypeError("Context menu event was null. This should not occur in normal usage.");N.pos=r.convertEventToCanvasOffset(S),r.graph.add(N)}else console.warn("Failed to create node of type:",b.value);o==null||o(N),r.graph.afterChange()}};g.push(y)}new LiteGraph.ContextMenu(g,{event:n,parentMenu:d},a)}}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalOutputs(t,i,n,s,o){var c;if(!o)return;const r=C.active_canvas;let a=[];LiteGraph.do_add_triggers_slots&&o.findOutputSlot("onExecuted")==-1&&a.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"});const l=(c=o.onMenuNodeOutputs)==null?void 0:c.call(o,a);if(l&&(a=l),!a.length)return;new LiteGraph.ContextMenu(a,{event:n,callback:h,parentMenu:s,node:o});function h(d,f,g){var y;if(!o||(d.callback&&d.callback.call(this,o,d,f,g),!d.value))return;const m=d.value[1];if(m&&(typeof m=="object"||Array.isArray(m))){const b=[];for(const L in m)b.push({content:L,value:m[L]});return new LiteGraph.ContextMenu(b,{event:f,callback:h,parentMenu:s,node:o}),!1}const{graph:_}=o;if(!_)throw new NullGraphError;_.beforeChange(),o.addOutput(d.value[0],d.value[1],d.value[2]),(y=o.onNodeOutputAdd)==null||y.call(o,d.value),r.setDirty(!0,!0),_.afterChange()}return!1}static onShowMenuNodeProperties(t,i,n,s,o){if(!o||!o.properties)return;const r=C.active_canvas,a=r.getCanvasWindow(),l=[];for(const c in o.properties){t=o.properties[c]!==void 0?o.properties[c]:" ",typeof t=="object"&&(t=JSON.stringify(t));const d=o.getPropertyInfo(c);(d.type=="enum"||d.type=="combo")&&(t=C.getPropertyPrintableValue(t,d.values)),t=C.decodeHTML(stringOrEmpty(t)),l.push({content:`<span class='property_name'>${d.label||c}</span><span class='property_value'>${t}</span>`,value:c})}if(!l.length)return;new LiteGraph.ContextMenu(l,{event:n,callback:h,parentMenu:s,allow_html:!0,node:o},a);function h(c){if(!o)return;const d=this.getBoundingClientRect();r.showEditPropertyValue(o,c.value,{position:[d.left,d.top]})}return!1}static decodeHTML(t){const i=document.createElement("div");return i.textContent=t,i.innerHTML}static onMenuResizeNode(t,i,n,s,o){if(!o)return;const r=function(l){l.setSize(l.computeSize())},a=C.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);a.setDirty(!0,!0)}static onShowPropertyEditor(t,i,n,s,o){const r=t.property||"title",a=o[r],l=document.createElement("span");l.className="name",l.textContent=r;const h=document.createElement("input");Object.assign(h,{type:"text",className:"value",autofocus:!0});const c=document.createElement("button");c.textContent="OK";const d=Object.assign(document.createElement("div"),{is_modified:!1,className:"graphdialog",close:()=>d.remove()});d.append(l,h,c),h.value=String(a),h.addEventListener("blur",function(){this.focus()}),h.addEventListener("keydown",T=>{if(d.is_modified=!0,T.key=="Escape")d.close();else if(T.key=="Enter")L();else if(!T.target||!("localName"in T.target)||T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()});const f=C.active_canvas,g=f.canvas,m=g.getBoundingClientRect(),_=m?-20-m.left:-20,y=m?-20-m.top:-20;if(n?(d.style.left=`${n.clientX+_}px`,d.style.top=`${n.clientY+y}px`):(d.style.left=`${g.width*.5+_}px`,d.style.top=`${g.height*.5+y}px`),c.addEventListener("click",L),g.parentNode==null)throw new TypeError("canvasEl.parentNode was null");g.parentNode.append(d),h.focus();let b;d.addEventListener("mouseleave",function(){LiteGraph.dialog_close_on_mouse_leave&&!d.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(d.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),d.addEventListener("mouseenter",function(){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});function L(){h&&k(h.value)}function k(T){t.type=="Number"?T=Number(T):t.type=="Boolean"&&(T=!!T),o[r]=T,d.remove(),f.setDirty(!0,!0)}}static getPropertyPrintableValue(t,i){if(!i||Array.isArray(i))return String(t);if(typeof i=="object"){let n="";for(const s in i)if(i[s]==t){n=s;break}return`${String(t)} (${n})`}}static onMenuNodeCollapse(t,i,n,s,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.collapse()},a=C.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuToggleAdvanced(t,i,n,s,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.toggleAdvanced()},a=C.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuNodeMode(t,i,n,s,o){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:r,parentMenu:s,node:o});function r(a){if(!o)return;const l=Object.values(LiteGraph.NODE_MODES).indexOf(a),h=function(d){l!==-1&&LiteGraph.NODE_MODES[l]?d.changeMode(l):(console.warn(`unexpected mode: ${a}`),d.changeMode(LGraphEventMode.ALWAYS))},c=C.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)h(o);else for(const d in c.selected_nodes)h(c.selected_nodes[d])}return!1}static onMenuNodeColors(t,i,n,s,o){if(!o)throw"no node for color";const r=[];r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const l in C.node_colors){const h=C.node_colors[l];t={value:l,content:`<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid ${h.color}; background-color:${h.bgcolor}'>${l}</span>`},r.push(t)}new LiteGraph.ContextMenu(r,{event:n,callback:a,parentMenu:s,node:o});function a(l){if(!o)return;const h=function(d){const f=l.value?C.node_colors[l.value]:null;d.setColorOption(f)},c=C.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)h(o);else for(const d in c.selected_nodes)h(c.selected_nodes[d]);c.setDirty(!0,!0)}return!1}static onMenuNodeShapes(t,i,n,s,o){if(!o)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:r,parentMenu:s,node:o});function r(a){if(!o)return;if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const l=function(c){c.shape=a},h=C.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(o);else for(const c in h.selected_nodes)l(h.selected_nodes[c]);o.graph.afterChange(),h.setDirty(!0)}return!1}static onMenuNodeRemove(){C.active_canvas.deleteSelected()}static onMenuNodeClone(t,i,n,s,o){const{graph:r}=o;if(!r)throw new NullGraphError;r.beforeChange();const a=new Set,l=function(c,d){if(c.clonable===!1)return;const f=c.clone();if(f){if(f.pos=[c.pos[0]+5,c.pos[1]+5],!c.graph)throw new NullGraphError;c.graph.add(f),d.add(f)}},h=C.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(o,a);else for(const c in h.selected_nodes)l(h.selected_nodes[c],a);a.size&&h.selectNodes([...a]),r.afterChange(),h.setDirty(!0,!0)}clear(){var t,i;this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.selectedItems.clear(),this.state.selectionChanged=!0,(t=this.onSelectionChange)==null||t.call(this,this.selected_nodes),this.visible_nodes=[],this.node_over=void 0,this.node_capturing_input=null,this.connecting_links=null,this.highlighted_links={},this.dragging_canvas=!1,O(this,G,ht).call(this),this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer.reset(),this.visible_area.set([0,0,0,0]),(i=this.onClear)==null||i.call(this)}setGraph(t){const{graph:i}=this;t!==i&&(this.clear(),t.attachCanvas(this),this.dispatch("litegraph:set-graph",{newGraph:t,oldGraph:i}),O(this,G,ht).call(this))}openSubgraph(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n={bubbles:!0,detail:{subgraph:t,closingGraph:i},cancelable:!0};this.canvas.dispatchEvent(new CustomEvent("subgraph-opening",n))&&(this.clear(),this.subgraph=t,this.setGraph(t),this.canvas.dispatchEvent(new CustomEvent("subgraph-opened",n)))}getCurrentGraph(){return this.graph}setCanvas(t,i){var o;const n=O(this,G,mi).call(this,t);if(n===this.canvas||(!n&&this.canvas&&!i&&this.unbindEvents(),this.canvas=n,this.ds.element=n,this.pointer.element=n,!n))return;n.className+=" lgraphcanvas",n.data=this,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height;const s=(o=n.getContext)==null?void 0:o.call(n,"2d");if(s==null)throw n.localName!="canvas"?`Element supplied for LGraphCanvas must be a <canvas> element, you passed a ${n.localName}`:"This browser doesn't support Canvas";this.ctx=s,i||this.bindEvents()}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already bound");return}const{canvas:t}=this,{document:i}=this.getCanvasWindow();this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),this._mouseout_callback=this.processMouseOut.bind(this),this._mousecancel_callback=this.processMouseCancel.bind(this),t.addEventListener("pointerdown",this._mousedown_callback,!0),t.addEventListener("wheel",this._mousewheel_callback,!1),t.addEventListener("pointerup",this._mouseup_callback,!0),t.addEventListener("pointermove",this._mousemove_callback),t.addEventListener("pointerout",this._mouseout_callback),t.addEventListener("pointercancel",this._mousecancel_callback,!0),t.addEventListener("contextmenu",this._doNothing),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),i.addEventListener("keyup",this._key_callback,!0),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events bound");return}const{document:t}=this.getCanvasWindow(),{canvas:i}=this;i.removeEventListener("pointercancel",this._mousecancel_callback),i.removeEventListener("pointerout",this._mouseout_callback),i.removeEventListener("pointermove",this._mousemove_callback),i.removeEventListener("pointerup",this._mouseup_callback),i.removeEventListener("pointerdown",this._mousedown_callback),i.removeEventListener("wheel",this._mousewheel_callback),i.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),i.removeEventListener("contextmenu",this._doNothing),i.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=void 0,this._mousewheel_callback=void 0,this._key_callback=void 0,this._events_binded=!1}setDirty(t,i){t&&(this.dirty_canvas=!0),i&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();const i=this.getCanvasWindow();if(this.is_rendering)if(I(this,yt)>0){const n=I(this,yt)-(LiteGraph.getTime()-this.last_draw_time);setTimeout(t.bind(this),Math.max(1,n))}else i.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}getWidgetAtCursor(t){return t??(t=this.node_over),t==null?void 0:t.getWidgetOnPos(this.graph_mouse[0],this.graph_mouse[1],!0)}updateMouseOverNodes(t,i){var o,r;if(!this.graph)throw new NullGraphError;const{pointer:n}=this,s=this.graph._nodes;for(const a of s)a.mouseOver&&t!=a&&(n.eDown||(n.resizeDirection=void 0),a.mouseOver=void 0,this._highlight_input=void 0,this._highlight_pos=void 0,this.linkConnector.overWidget=void 0,a.lostFocusAt=LiteGraph.getTime(),(r=(o=this.node_over)==null?void 0:o.onMouseLeave)==null||r.call(o,i),this.node_over=void 0,this.dirty_canvas=!0)}processMouseDown(t){var h,c;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&!t.altKey&&t.buttons){W(this,Tt,{pos:[t.x,t.y],scale:this.ds.scale});return}const{graph:i,pointer:n}=this;if(this.adjustMouseEvent(t),t.isPrimary&&n.down(t),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!i)return;const s=this.getCanvasWindow();C.active_canvas=this;const o=t.clientX,r=t.clientY;if(this.ds.viewport=this.viewport,!(!this.viewport||isInRect(o,r,this.viewport)))return;const l=i.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes)??void 0;if(this.mouse[0]=o,this.mouse[1]=r,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],n.isDouble=n.isDown&&t.isPrimary,n.isDown=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(s),((h=this.onMouse)==null?void 0:h.call(this,t))!=!0){if(t.button===0&&!n.isDouble)O(this,G,bi).call(this,t,l);else if(t.button===1)O(this,G,ki).call(this,t,l);else if((t.button===2||n.isDouble)&&this.allow_interaction&&!this.read_only){const{linkConnector:d,subgraph:f}=this;if(f!=null&&f.inputNode.containsPoint(this.graph_mouse))this.processSelect(f.inputNode,t,!0),f.inputNode.onPointerDown(t,n,d);else if(f!=null&&f.outputNode.containsPoint(this.graph_mouse))this.processSelect(f.outputNode,t,!0),f.outputNode.onPointerDown(t,n,d);else{if(l)this.processSelect(l,t,!0);else if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const g=i.getRerouteOnPos(t.canvasX,t.canvasY,I(this,lt));g&&(t.altKey?n.onClick=m=>{var _;m.altKey&&(g.selected&&(this.deselect(g),(_=this.onSelectionChange)==null||_.call(this,this.selected_nodes)),g.remove())}:this.processSelect(g,t,!0))}n.onClick??(n.onClick=()=>this.processContextMenu(l,t))}}this.last_mouse=[o,r],this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,i.change(),(!s.document.activeElement||s.document.activeElement.nodeName.toLowerCase()!="input"&&s.document.activeElement.nodeName.toLowerCase()!="textarea")&&t.preventDefault(),t.stopPropagation(),(c=this.onMouseDown)==null||c.call(this,t)}}processMouseMove(t){var m,_,y,b;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&I(this,Tt)){O(this,G,Li).call(this,t);return}this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0);const{graph:i,resizingGroup:n,linkConnector:s,pointer:o,subgraph:r}=this;if(!i)return;C.active_canvas=this,this.adjustMouseEvent(t);const a=[t.clientX,t.clientY];this.mouse[0]=a[0],this.mouse[1]=a[1];const l=[a[0]-this.last_mouse[0],a[1]-this.last_mouse[1]];this.last_mouse=a;const{canvasX:h,canvasY:c}=t;this.graph_mouse[0]=h,this.graph_mouse[1]=c,t.isPrimary&&o.move(t);let d=CanvasItem.Nothing;if(r&&(d|=r.inputNode.onPointerMove(t),d|=r.outputNode.onPointerMove(t)),this.block_click){t.preventDefault();return}if(t.dragging=this.last_mouse_dragging,this.node_widget){const[L,k]=this.node_widget;if(k!=null&&k.mouse){const T=h-L.pos[0],S=c-L.pos[1],N=k.mouse(t,[T,S],L);N!=null&&(this.dirty_canvas=N)}}const f=i.getNodeOnPos(h,c,this.visible_nodes),g=this.dragging_rectangle;if(g)g[2]=h-g[0],g[3]=c-g[1],this.dirty_canvas=!0;else if(n)d|=CanvasItem.Group,o.resizeDirection="SE";else if(this.dragging_canvas)this.ds.offset[0]+=l[0]/this.ds.scale,this.ds.offset[1]+=l[1]/this.ds.scale,O(this,G,ht).call(this);else if((this.allow_interaction||f!=null&&f.flags.allow_interaction)&&!this.read_only){if(s.isConnecting&&(this.dirty_canvas=!0),this.updateMouseOverNodes(f,t),f){d|=CanvasItem.Node,f.redraw_on_mouse&&(this.dirty_canvas=!0);const L=[0,0],k=isOverNodeInput(f,h,c,L),T=isOverNodeOutput(f,h,c,L),S=f.getWidgetOnPos(h,c,!0)??void 0;if(!f.mouseOver){f.mouseOver={},this.node_over=f,this.dirty_canvas=!0;for(const A of I(this,lt))A.hideSlots(),this.dirty_bgcanvas=!0;(m=f.onMouseEnter)==null||m.call(f,t)}(_=f.onMouseMove)==null||_.call(f,t,[h-f.pos[0],c-f.pos[1]],this);const{mouseOver:N}=f;if(N.inputId!==k||N.outputId!==T||N.overWidget!==S){if(N.inputId=k,N.outputId=T,N.overWidget=S,s.overWidget=void 0,s.isConnecting){const A=s.renderLinks.at(0);let D,E;if(!(!A||!s.isNodeValidDrop(f))){if(s.state.connectingTo==="input"){if(S){const w=f.getSlotFromWidget(S);w&&s.isInputValidDrop(f,w)&&(E=w,D=f.getInputSlotPos(w),s.overWidget=S)}if(!s.overWidget){if(k===-1&&T===-1){const w=f.findInputByType(A.fromSlot.type);w&&(E=w.slot,D=f.getInputSlotPos(w.slot))}else k!=-1&&f.inputs[k]&&LiteGraph.isValidConnection(A.fromSlot.type,f.inputs[k].type)&&(D=L,E=f.inputs[k]);if(E){const w=f.getWidgetFromSlot(E);w&&(s.overWidget=w)}}}else if(s.state.connectingTo==="output")if(k===-1&&T===-1){const w=f.findOutputByType(A.fromSlot.type);w&&(D=f.getOutputPos(w.index))}else T!=-1&&f.outputs[T]&&LiteGraph.isValidConnection(A.fromSlot.type,f.outputs[T].type)&&(D=L)}this._highlight_pos=D,this._highlight_input=E}this.dirty_canvas=!0}o.eDown||(k===-1&&T===-1&&!S?o.resizeDirection=f.findResizeDirection(h,c):o.resizeDirection&&(o.resizeDirection=void 0))}else{d=O(this,G,Si).call(this,d);const L=O(this,G,Ei).call(this,t);if(this.over_link_center!==L&&(d|=CanvasItem.Link,this.over_link_center=L,this.dirty_bgcanvas=!0),this.canvas){const k=i.getGroupOnPos(h,c);k&&!t.ctrlKey&&!this.read_only&&k.isInResize(h,c)?o.resizeDirection="SE":o.resizeDirection&&(o.resizeDirection=void 0)}}if(this.node_capturing_input&&this.node_capturing_input!=f&&((b=(y=this.node_capturing_input).onMouseMove)==null||b.call(y,t,[h-this.node_capturing_input.pos[0],c-this.node_capturing_input.pos[1]],this)),this.isDragging){const L=this.selectedItems,k=t.ctrlKey?L:getAllNestedItems(L),T=l[0]/this.ds.scale,S=l[1]/this.ds.scale;for(const N of k)N.move(T,S,!0);O(this,G,ht).call(this)}}this.hoveringOver=d,t.preventDefault()}processMouseUp(t){var r,a,l,h;if(t.isPrimary===!1)return;const{graph:i,pointer:n}=this;if(!i)return;C.active_canvas=this,this.adjustMouseEvent(t);const s=LiteGraph.getTime();if(t.click_time=s-this.last_mouseclick,n.up(t)===!0){n.isDown=!1,n.isDouble=!1,this.connecting_links=null,this.dragging_canvas=!1,i.change(),t.stopPropagation(),t.preventDefault();return}if(this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),t.button===0){this.selected_group=null,this.isDragging=!1;const c=t.canvasX,d=t.canvasY;this.linkConnector.isConnecting||(this.dirty_canvas=!0,(a=(r=this.node_over)==null?void 0:r.onMouseUp)==null||a.call(r,t,[c-this.node_over.pos[0],d-this.node_over.pos[1]],this),(h=(l=this.node_capturing_input)==null?void 0:l.onMouseUp)==null||h.call(l,t,[c-this.node_capturing_input.pos[0],d-this.node_capturing_input.pos[1]]))}else t.button===1?(this.dirty_canvas=!0,this.dragging_canvas=!1):t.button===2&&(this.dirty_canvas=!0);n.isDown=!1,n.isDouble=!1,i.change(),t.stopPropagation(),t.preventDefault()}processMouseOut(t){this.adjustMouseEvent(t),this.updateMouseOverNodes(null,t)}processMouseCancel(){console.warn("Pointer cancel!"),this.pointer.reset()}processMouseWheel(t){if(!this.graph||!this.allow_dragcanvas)return;const i=t.wheelDeltaY??t.detail*-60;this.adjustMouseEvent(t);const n=[t.clientX,t.clientY];if(this.viewport&&!isPointInRect(n,this.viewport))return;let{scale:s}=this.ds;LiteGraph.canvasNavigationMode==="legacy"||LiteGraph.canvasNavigationMode==="standard"&&t.ctrlKey?(i>0?s*=this.zoom_speed:i<0&&(s*=1/this.zoom_speed),this.ds.changeScale(s,[t.clientX,t.clientY])):LiteGraph.macTrackpadGestures&&(!LiteGraph.macGesturesRequireMac||navigator.userAgent.includes("Mac"))&&(t.metaKey&&!t.ctrlKey&&!t.shiftKey&&!t.altKey?(t.deltaY>0?s*=1/this.zoom_speed:t.deltaY<0&&(s*=this.zoom_speed),this.ds.changeScale(s,[t.clientX,t.clientY])):t.ctrlKey?(s*=1+t.deltaY*(1-this.zoom_speed)*.18,this.ds.changeScale(s,[t.clientX,t.clientY],!1)):t.shiftKey?this.ds.offset[0]-=t.deltaY*1.18*(1/s):(this.ds.offset[0]-=t.deltaX*1.18*(1/s),this.ds.offset[1]-=t.deltaY*1.18*(1/s))),this.graph.change(),t.preventDefault()}processKey(t){var s,o,r,a;W(this,ae,t.shiftKey);const{graph:i}=this;if(!i)return;let n=!1;if(t.target.localName!="input"){if(t.type=="keydown"){if(t.key===" ")this.read_only=!0,this._previously_dragging_canvas===null&&(this._previously_dragging_canvas=this.dragging_canvas),this.dragging_canvas=this.pointer.isDown,n=!0;else if(t.key==="Escape"){if(this.linkConnector.isConnecting){this.linkConnector.reset(),t.preventDefault();return}(s=this.node_panel)==null||s.close(),(o=this.options_panel)==null||o.close(),(this.node_panel||this.options_panel)&&(n=!0)}else if(t.keyCode===65&&t.ctrlKey)this.selectItems(),n=!0;else if(t.keyCode===67&&(t.metaKey||t.ctrlKey)&&!t.shiftKey)this.selected_nodes&&(this.copyToClipboard(),n=!0);else if(t.keyCode===86&&(t.metaKey||t.ctrlKey))this.pasteFromClipboard({connectInputs:t.shiftKey});else if((t.key==="Delete"||t.key==="Backspace")&&t.target.localName!="input"&&t.target.localName!="textarea"){if(this.selectedItems.size===0){O(this,G,Ii).call(this);return}this.deleteSelected(),n=!0}for(const l of Object.values(this.selected_nodes))(r=l.onKeyDown)==null||r.call(l,t)}else if(t.type=="keyup"){t.key===" "&&(this.read_only=!1,this.dragging_canvas=(this._previously_dragging_canvas??!1)&&this.pointer.isDown,this._previously_dragging_canvas=null);for(const l of Object.values(this.selected_nodes))(a=l.onKeyUp)==null||a.call(l,t)}i.change(),n&&(t.preventDefault(),t.stopImmediatePropagation())}}copyToClipboard(t){var s,o,r;const i={nodes:[],groups:[],reroutes:[],links:[],subgraphs:[]},n=new Set;for(const a of t??this.selectedItems)if(a instanceof LGraphNode){if(a.clonable===!1)continue;const l=(s=a.clone())==null?void 0:s.serialize();if(!l)continue;if(l.id=a.id,i.nodes.push(l),a.inputs)for(const{link:h}of a.inputs){if(h==null)continue;const c=(r=(o=this.graph)==null?void 0:o._links.get(h))==null?void 0:r.asSerialisable();c&&i.links.push(c)}a instanceof SubgraphNode&&n.add(a.subgraph)}else a instanceof LGraphGroup?i.groups.push(a.serialize()):a instanceof Reroute&&i.reroutes.push(a.asSerialisable());for(const a of n){const l=a.clone(!0).asSerialisable();i.subgraphs.push(l)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(i))}emitEvent(t){this.canvas.dispatchEvent(new CustomEvent("litegraph:canvas",{bubbles:!0,detail:t}))}emitBeforeChange(){this.emitEvent({subType:"before-change"})}emitAfterChange(){this.emitEvent({subType:"after-change"})}_pasteFromClipboard(t={}){var m;const{connectInputs:i=!1,position:n=this.graph_mouse}=t;if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&i)return;const s=localStorage.getItem("litegrapheditor_clipboard");if(!s)return;const{graph:o}=this;if(!o)throw new NullGraphError;o.beforeChange();const r=JSON.parse(s);r.nodes??(r.nodes=[]),r.groups??(r.groups=[]),r.reroutes??(r.reroutes=[]),r.links??(r.links=[]),r.subgraphs??(r.subgraphs=[]);let a=1/0,l=1/0;for(const _ of[...r.nodes,...r.reroutes]){if(_.pos==null)throw new TypeError("Invalid node encounterd on paste.  `pos` was null.");_.pos[0]<a&&(a=_.pos[0]),_.pos[1]<l&&(l=_.pos[1])}if(r.groups)for(const _ of r.groups)_.bounding[0]<a&&(a=_.bounding[0]),_.bounding[1]<l&&(l=_.bounding[1]);const h={created:[],nodes:new Map,links:new Map,reroutes:new Map,subgraphs:new Map},{created:c,nodes:d,links:f,reroutes:g}=h;for(const _ of r.subgraphs){const y=_.id;_.id=createUuidv4();const b=o.createSubgraph(_);b.configure(_),h.subgraphs.set(y,b)}for(const _ of r.groups){_.id=-1;const y=new LGraphGroup;y.configure(_),o.add(y),c.push(y)}for(const _ of r.nodes){const y=h.subgraphs.get(_.type);y&&(_.type=y.id);const b=_.type==null?null:LiteGraph.createNode(_.type);b&&(d.set(_.id,b),_.id=-1,b.configure(_),o.add(b),c.push(b))}for(const _ of r.reroutes){const{id:y,...b}=_,L=o.setReroute(b);c.push(L),g.set(y,L)}for(const _ of g.values()){if(_.parentId==null)continue;const y=g.get(_.parentId);y&&(_.parentId=y.id)}for(const _ of r.links){let y=d.get(_.origin_id),b;_.parentId!=null&&(b=(m=g.get(_.parentId))==null?void 0:m.id),i&&LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&(y??(y=o.getNodeById(_.origin_id)),b??(b=_.parentId));const L=d.get(_.target_id);if(L){const k=y==null?void 0:y.connect(_.origin_slot,L,_.target_slot,b);k&&f.set(_.id,k)}}for(const _ of g.values()){const y=[..._.linkIds].map(b=>{var L;return((L=f.get(b))==null?void 0:L.id)??b});_.update(_.parentId,void 0,y,_.floating),_.validateLinks(o.links,o.floatingLinks)||o.removeReroute(_.id)}for(const _ of c)_.pos[0]+=n[0]-a,_.pos[1]+=n[1]-l;return this.selectItems(c),o.afterChange(),h}pasteFromClipboard(t={}){this.emitBeforeChange();try{this._pasteFromClipboard(t)}finally{this.emitAfterChange()}}processNodeDblClicked(t){var i,n;(i=this.onShowNodePanel)==null||i.call(this,t),(n=this.onNodeDblClicked)==null||n.call(this,t),this.setDirty(!0)}processSelect(t,i,n=!1){var l;const s=i==null?void 0:i.shiftKey,o=i!=null&&(i.metaKey||i.ctrlKey),r=s||o,a=r||this.multi_select;if(!t)(!r||this.multi_select)&&this.deselectAll();else if(!t.selected||!this.selectedItems.has(t))a||this.deselectAll(t),this.select(t);else if(a&&!n)this.deselect(t);else if(!n)this.deselectAll(t);else return;(l=this.onSelectionChange)==null||l.call(this,this.selected_nodes),this.setDirty(!0)}select(t){var i,n;if(!(t.selected&&this.selectedItems.has(t))&&(t.selected=!0,this.selectedItems.add(t),this.state.selectionChanged=!0,t instanceof LGraphNode)){if((i=t.onSelected)==null||i.call(t),this.selected_nodes[t.id]=t,(n=this.onNodeSelected)==null||n.call(this,t),t.inputs)for(const s of t.inputs)s.link!=null&&(this.highlighted_links[s.link]=!0);if(t.outputs)for(const s of t.outputs.flatMap(o=>o.links))s!=null&&(this.highlighted_links[s]=!0)}}deselect(t){var n,s;if(!t.selected&&!this.selectedItems.has(t)||(t.selected=!1,this.selectedItems.delete(t),this.state.selectionChanged=!0,!(t instanceof LGraphNode)))return;(n=t.onDeselected)==null||n.call(t),delete this.selected_nodes[t.id],(s=this.onNodeDeselected)==null||s.call(this,t);const{graph:i}=this;if(i){if(t.inputs)for(const o of t.inputs){if(o.link==null)continue;const r=LLink.getOriginNode(i,o.link);r&&this.selectedItems.has(r)||delete this.highlighted_links[o.link]}if(t.outputs)for(const o of t.outputs.flatMap(r=>r.links)){if(o==null)continue;const r=LLink.getTargetNode(i,o);r&&this.selectedItems.has(r)||delete this.highlighted_links[o]}}}processNodeSelected(t,i){this.processSelect(t,i,i&&(i.shiftKey||i.metaKey||i.ctrlKey||this.multi_select))}selectNode(t,i){t==null?this.deselectAll():this.selectNodes([t],i)}get empty(){if(!this.graph)throw new NullGraphError;return this.graph.empty}get positionableItems(){if(!this.graph)throw new NullGraphError;return this.graph.positionableItems()}selectItems(t,i){var s;const n=t??this.positionableItems;i||this.deselectAll();for(const o of n)this.select(o);(s=this.onSelectionChange)==null||s.call(this,this.selected_nodes),this.setDirty(!0)}selectNodes(t,i){this.selectItems(t,i)}deselectNode(t){this.deselect(t)}deselectAll(t){var o,r;if(!this.graph)return;const i=this.selectedItems;if(!i.size)return;let n;for(const a of i){if(a===t){n=a;continue}(o=a.onDeselected)==null||o.call(a),a.selected=!1}i.clear(),n&&i.add(n),this.setDirty(!0);const s=(t==null?void 0:t.id)==null?null:this.selected_nodes[t.id];if(this.selected_nodes={},this.current_node=null,this.highlighted_links={},t instanceof LGraphNode){if(s&&(this.selected_nodes[s.id]=s),t.inputs)for(const a of t.inputs)a.link!=null&&(this.highlighted_links[a.link]=!0);if(t.outputs)for(const a of t.outputs.flatMap(l=>l.links))a!=null&&(this.highlighted_links[a]=!0)}this.state.selectionChanged=!0,(r=this.onSelectionChange)==null||r.call(this,this.selected_nodes)}deselectAllNodes(){this.deselectAll()}deleteSelected(){var i,n;const{graph:t}=this;if(!t)throw new NullGraphError;this.emitBeforeChange(),t.beforeChange();for(const s of this.selectedItems)if(s instanceof LGraphNode){const o=s;if(o.block_delete)continue;o.connectInputToOutput(),t.remove(o),(i=this.onNodeDeselected)==null||i.call(this,o)}else s instanceof LGraphGroup?t.remove(s):s instanceof Reroute&&t.removeReroute(s.id);this.selected_nodes={},this.selectedItems.clear(),this.current_node=null,this.highlighted_links={},this.state.selectionChanged=!0,(n=this.onSelectionChange)==null||n.call(this,this.selected_nodes),this.setDirty(!0),t.afterChange(),this.emitAfterChange()}deleteSelectedNodes(){this.deleteSelected()}centerOnNode(t){const i=(window==null?void 0:window.devicePixelRatio)||1;this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/(this.ds.scale*i),this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/(this.ds.scale*i),this.setDirty(!0,!0)}adjustMouseEvent(t){let i=t.clientX,n=t.clientY;if(this.canvas){const s=this.canvas.getBoundingClientRect();i-=s.left,n-=s.top}t.safeOffsetX=i,t.safeOffsetY=n,t.deltaX===void 0&&(t.deltaX=i-this.last_mouse_position[0]),t.deltaY===void 0&&(t.deltaY=n-this.last_mouse_position[1]),this.last_mouse_position[0]=i,this.last_mouse_position[1]=n,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=n/this.ds.scale-this.ds.offset[1]}setZoom(t,i){this.ds.changeScale(t,i),O(this,G,ht).call(this)}convertOffsetToCanvas(t,i){return this.ds.convertOffsetToCanvas(t,i)}convertCanvasToOffset(t,i){return this.ds.convertCanvasToOffset(t,i)}convertEventToCanvasOffset(t){const i=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-i.left,t.clientY-i.top])}bringToFront(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n=i._nodes.indexOf(t);n!=-1&&(i._nodes.splice(n,1),i._nodes.push(t))}sendToBack(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n=i._nodes.indexOf(t);n!=-1&&(i._nodes.splice(n,1),i._nodes.unshift(t))}computeVisibleNodes(t,i){const n=i||[];if(n.length=0,!this.graph)throw new NullGraphError;const s=t||this.graph._nodes;for(const o of s)o.updateArea(this.ctx),overlapBounding(this.visible_area,o.renderArea)&&n.push(o);return n}isNodeVisible(t){return I(this,re).has(t.id)}draw(t,i){var s;if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const n=LiteGraph.getTime();if(this.render_time=(n-this.last_draw_time)*.001,this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),this.dirty_canvas||t){this.computeVisibleNodes(void 0,this.visible_nodes),W(this,re,new Set(this.visible_nodes.map(r=>r.id)));const{subgraph:o}=this;o&&(o.inputNode.arrange(),o.outputNode.arrange())}(this.dirty_bgcanvas||i||this.always_render_background||(s=this.graph)!=null&&s._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame++}drawFrontCanvas(){var r,a,l,h,c,d,f;this.dirty_canvas=!1;const{ctx:t,canvas:i,graph:n,linkConnector:s}=this;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));const o=this.viewport||this.dirty_area;if(o&&(t.save(),t.beginPath(),t.rect(o[0],o[1],o[2],o[3]),t.clip()),W(this,et,I(this,ae)||LiteGraph.alwaysSnapToGrid?(r=this.graph)==null?void 0:r.getSnapToGridSize():void 0),this.clear_background&&(o?t.clearRect(o[0],o[1],o[2],o[3]):t.clearRect(0,0,i.width,i.height)),this.bgcanvas==this.canvas)this.drawBackCanvas();else{const g=window.devicePixelRatio;t.drawImage(this.bgcanvas,0,0,this.bgcanvas.width/g,this.bgcanvas.height/g)}if((a=this.onRender)==null||a.call(this,i,t),this.show_info&&this.renderInfo(t,o?o[0]:0,o?o[1]:0),n){t.save(),this.ds.toCanvasContext(t);const{visible_nodes:g}=this,m=I(this,et)&&this.isDragging;for(const _ of g)t.save(),m&&this.selectedItems.has(_)&&this.drawSnapGuide(t,_),t.translate(_.pos[0],_.pos[1]),this.drawNode(_,t),t.restore();if((h=this.subgraph)==null||h.draw(t,this.colourGetter,(l=this.linkConnector.renderLinks[0])==null?void 0:l.fromSlot,this.editor_alpha),this.render_execution_order&&this.drawExecutionOrder(t),n.config.links_ontop&&this.drawConnections(t),s.isConnecting){const{renderLinks:_}=s,y=O(this,G,Ni).call(this);t.lineWidth=this.connections_width;for(const b of _){const{fromSlot:L,fromPos:k,fromDirection:T,dragDirection:S}=b,N=L.shape,A=L.type,D=A===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR;this.renderLink(t,k,y,null,!1,null,D,T,S),t.beginPath(),A===LiteGraph.EVENT||N===RenderShape.BOX?(t.rect(k[0]-6+.5,k[1]-5+.5,14,10),t.rect(y[0]-6+.5,y[1]-5+.5,14,10)):N===RenderShape.ARROW?(t.moveTo(k[0]+8,k[1]+.5),t.lineTo(k[0]-4,k[1]+6+.5),t.lineTo(k[0]-4,k[1]-6+.5),t.closePath()):(t.arc(k[0],k[1],4,0,Math.PI*2),t.arc(y[0],y[1],4,0,Math.PI*2)),t.fill()}O(this,G,Oi).call(this,t,y)}if(this.dragging_rectangle){const{eDown:_,eMove:y}=this.pointer;if(t.strokeStyle="#FFF",_&&y){const b=t.getTransform(),L=Math.max(1,window.devicePixelRatio);t.setTransform(L,0,0,L,0,0);const k=_.safeOffsetX,T=_.safeOffsetY;t.strokeRect(k,T,y.safeOffsetX-k,y.safeOffsetY-T),t.setTransform(b)}else{const[b,L,k,T]=this.dragging_rectangle;t.strokeRect(b,L,k,T)}}!this.isDragging&&this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):(c=this.onDrawLinkTooltip)==null||c.call(this,t,null),(d=this.onDrawForeground)==null||d.call(this,t,this.visible_area),t.restore()}(f=this.onDrawOverlay)==null||f.call(this,t),o&&t.restore()}renderInfo(t,i,n){i=i||10,n=n||this.canvas.offsetHeight-80,t.save(),t.translate(i,n),t.font=`10px ${LiteGraph.DEFAULT_FONT}`,t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText(`T: ${this.graph.globaltime.toFixed(2)}s`,5,13*1),t.fillText(`I: ${this.graph.iteration}`,5,13*2),t.fillText(`N: ${this.graph._nodes.length} [${this.visible_nodes.length}]`,5,13*3),t.fillText(`V: ${this.graph._version}`,5,13*4),t.fillText(`FPS:${this.fps.toFixed(2)}`,5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var o;const t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const i=this.bgctx;if(!i)throw new TypeError("Background canvas context was null.");const n=this.viewport||[0,0,i.canvas.width,i.canvas.height];this.clear_background&&i.clearRect(n[0],n[1],n[2],n[3]);const s=this.onRenderBackground?this.onRenderBackground(t,i):!1;if(!this.viewport){const r=window.devicePixelRatio;i.restore(),i.setTransform(r,0,0,r,0,0)}if(this.graph){if(i.save(),this.ds.toCanvasContext(i),this.ds.scale<1.5&&!s&&this.clear_background_color&&(i.fillStyle=this.clear_background_color,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!s){if(this.zoom_modify_alpha?i.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:i.globalAlpha=this.editor_alpha,i.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const a=this;this._bg_img.addEventListener("load",function(){a.draw(!0,!0)})}let r=this._pattern;r==null&&this._bg_img.width>0&&(r=i.createPattern(this._bg_img,"repeat")??void 0,this._pattern_img=this._bg_img,this._pattern=r),r&&(i.fillStyle=r,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),i.fillStyle="transparent"),i.globalAlpha=1,i.imageSmoothingEnabled=!0}this.graph._groups.length&&this.drawGroups(t,i),(o=this.onDrawBackground)==null||o.call(this,i,this.visible_area),this.render_canvas_border&&(i.strokeStyle="#235",i.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(i.shadowColor="#000",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=6):i.shadowColor="rgba(0,0,0,0)",this.drawConnections(i),i.shadowColor="rgba(0,0,0,0)",i.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,i){var h,c,d;this.current_node=t;const n=t.renderingColor,s=t.renderingBgColor,{low_quality:o,editor_alpha:r}=this;if(i.globalAlpha=r,this.render_shadows&&!o?(i.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",t.flags.collapsed&&((h=t.onDrawCollapsed)==null?void 0:h.call(t,i,this))==!0)return;const a=t._shape||RenderShape.BOX,l=I(C,Le);if(l.set(t.renderingSize),t.collapsed&&(i.font=this.inner_text_font),t.clip_area&&(i.save(),i.beginPath(),a==RenderShape.BOX?i.rect(0,0,l[0],l[1]):a==RenderShape.ROUND?i.roundRect(0,0,l[0],l[1],[10]):a==RenderShape.CIRCLE&&i.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),i.clip()),this.drawNodeShape(t,i,l,n,s,!!t.selected),t.title_buttons&&!t.flags.collapsed){const f=LiteGraph.NODE_TITLE_HEIGHT;let g=l[0];for(let m=0;m<t.title_buttons.length;m++){const _=t.title_buttons[m];if(!_.visible)continue;const y=_.getWidth(i);g-=y;const b=-f+(f-_.height)/2;_.draw(i,g,b),g-=2}}o||t.drawBadges(i),i.shadowColor="transparent",i.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,(c=t.onDrawForeground)==null||c.call(t,i,this,this.canvas),i.font=this.inner_text_font,t._setConcreteSlots(),t.collapsed?this.render_collapsed_slots&&t.drawCollapsedSlots(i):(t.arrange(),t.drawSlots(i,{fromSlot:(d=this.linkConnector.renderLinks[0])==null?void 0:d.fromSlot,colorContext:this.colourGetter,editorAlpha:this.editor_alpha,lowQuality:this.low_quality}),i.textAlign="left",i.globalAlpha=1,this.drawNodeWidgets(t,null,i)),t.clip_area&&i.restore(),i.globalAlpha=1}drawLinkTooltip(t,i){var h;const n=i._pos;if(t.fillStyle="black",t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const c=t.getTransform();t.translate(n[0],n[1]),Number.isFinite(i._centreAngle)&&t.rotate(i._centreAngle),t.moveTo(-2,-3),t.lineTo(4,0),t.lineTo(-2,3),t.setTransform(c)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(n[0],n[1],3,0,Math.PI*2);t.fill();const{data:s}=i;if(s==null||((h=this.onDrawLinkTooltip)==null?void 0:h.call(this,t,i,this))==!0)return;let o=null;if(typeof s=="number"?o=s.toFixed(2):typeof s=="string"?o=`"${s}"`:typeof s=="boolean"?o=String(s):s.toToolTip?o=s.toToolTip():o=`[${s.constructor.name}]`,o==null)return;o=o.substring(0,30),t.font="14px Courier New";const a=t.measureText(o).width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-a*.5,n[1]-15-l,a,l,[3]),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(o,n[0],n[1]-15-l*.3)}drawNodeShape(t,i,n,s,o,r){var _,y;i.strokeStyle=s,i.fillStyle=o;const a=LiteGraph.NODE_TITLE_HEIGHT,{low_quality:l}=this,{collapsed:h}=t.flags,c=t.renderingShape,{title_mode:d}=t,f=!(d==TitleMode.TRANSPARENT_TITLE||d==TitleMode.NO_TITLE),g=I(C,Se);g.set(t.boundingRect),g[0]-=t.pos[0],g[1]-=t.pos[1];const m=i.globalAlpha;i.beginPath(),c==RenderShape.BOX||l?i.rect(g[0],g[1],g[2],g[3]):c==RenderShape.ROUND||c==RenderShape.CARD?i.roundRect(g[0],g[1],g[2],g[3],c==RenderShape.CARD?[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]:[LiteGraph.ROUND_RADIUS]):c==RenderShape.CIRCLE&&i.arc(n[0]*.5,n[1]*.5,n[0]*.5,0,Math.PI*2),i.fill(),!h&&f&&(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,g[2],2)),i.shadowColor="transparent",(_=t.onDrawBackground)==null||_.call(t,i),(f||d==TitleMode.TRANSPARENT_TITLE)&&(t.drawTitleBarBackground(i,{scale:this.ds.scale,low_quality:l}),t.drawTitleBox(i,{scale:this.ds.scale,low_quality:l,box_size:10}),i.globalAlpha=m,t.drawTitleText(i,{scale:this.ds.scale,default_title_color:this.node_title_color,low_quality:l}),(y=t.onDrawTitle)==null||y.call(t,i));for(const b of Object.values(t.strokeStyles)){const L=b.call(t);L&&strokeShape(i,g,{shape:c,title_height:a,title_mode:d,collapsed:h,...L})}t.drawProgressBar(i),t.execute_triggered!=null&&t.execute_triggered>0&&t.execute_triggered--,t.action_triggered!=null&&t.action_triggered>0&&t.action_triggered--}drawSnapGuide(t,i,n=RenderShape.ROUND){const s=I(C,ke);s.set(i.boundingRect);const{pos:o}=i,r=o[0]-s[0],a=o[1]-s[1];s[0]+=r,s[1]+=a,I(this,et)&&snapPoint(s,I(this,et)),s[0]-=r,s[1]-=a;const{globalAlpha:l}=t;t.globalAlpha=1,t.beginPath();const[h,c,d,f]=s;if(n===RenderShape.CIRCLE){const g=h+d*.5,m=c+f*.5,_=Math.min(d*.5,f*.5);t.arc(g,m,_,0,Math.PI*2)}else t.rect(h,c,d,f);t.lineWidth=.5,t.strokeStyle="#FFFFFF66",t.fillStyle="#FFFFFF22",t.fill(),t.stroke(),t.globalAlpha=l}drawConnections(t){if(this.renderedPaths.clear(),this.links_render_mode===LinkRenderType.HIDDEN_LINK)return;const{graph:i,subgraph:n}=this;if(!i)throw new NullGraphError;const s=[],o=LiteGraph.getTime(),{visible_area:r}=this;I(C,mt)[0]=r[0]-20,I(C,mt)[1]=r[1]-20,I(C,mt)[2]=r[2]+40,I(C,mt)[3]=r[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;const a=i._nodes;for(const h of a){const{inputs:c}=h;if(c!=null&&c.length)for(const[d,f]of c.entries()){if(!f||f.link==null)continue;const g=f.link,m=i._links.get(g);if(!m)continue;const _=h.getInputPos(d),y=i.getNodeById(m.origin_id);if(y==null)continue;const b=m.origin_slot,L=b===-1?[y.pos[0]+10,y.pos[1]+10]:y.getOutputPos(b),k=y.outputs[b];k&&O(this,G,$t).call(this,t,m,L,_,s,o,k.dir,f.dir)}}if(n){for(const h of n.inputNode.slots)if(h.linkIds.length)for(const c of h.linkIds){const d=LLink.resolve(c,i);if(!d)continue;const{link:f,inputNode:g,input:m}=d;if(!g||!m)continue;const _=g.getInputPos(f.target_slot);O(this,G,$t).call(this,t,f,h.pos,_,s,o,m.dir,m.dir)}for(const h of n.outputNode.slots){if(!h.linkIds.length)continue;const c=LLink.resolve(h.linkIds[0],i);if(!c)continue;const{link:d,outputNode:f,output:g}=c;if(!f||!g)continue;const m=f.getOutputPos(d.origin_slot);O(this,G,$t).call(this,t,d,m,h.pos,s,o,g.dir,h.dir)}}i.floatingLinks.size>0&&O(this,G,Ci).call(this,t,i,s,o);const l=I(this,lt);l.clear(),s.sort((h,c)=>h.linkIds.size-c.linkIds.size);for(const h of s)l.add(h),I(this,et)&&this.isDragging&&this.selectedItems.has(h)&&this.drawSnapGuide(t,h,RenderShape.CIRCLE),h.draw(t,this._pattern),this.pointer.isDown||h.drawSlots(t);t.globalAlpha=1}renderLink(t,i,n,s,o,r,a,l,h,{startControl:c,endControl:d,reroute:f,num_sublines:g=1,disabled:m=!1}={}){const _=s!=null&&this.highlighted_links[s.id]?"#FFF":a||(s==null?void 0:s.color)||(s==null?void 0:s.type)!=null&&C.link_type_colors[s.type]||this.default_link_color,y=l||LinkDirection.RIGHT,b=h||LinkDirection.LEFT,L=this.links_render_mode==LinkRenderType.SPLINE_LINK&&(!d||!c)?distance(i,n):0;this.render_connections_border&&!this.low_quality&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",g||(g=1),g>1&&(t.lineWidth=.5);const k=new Path2D,T=f??s;T&&(T.path=k);const S=I(C,Ie),N=I(C,Te),A=(T==null?void 0:T._pos)??[0,0];for(let D=0;D<g;D++){const E=(D-(g-1)*.5)*5;if(S[0]=i[0],S[1]=i[1],N[0]=n[0],N[1]=n[1],this.links_render_mode==LinkRenderType.SPLINE_LINK){if(d?(N[0]=n[0]+d[0],N[1]=n[1]+d[1]):O(this,G,ye).call(this,N,b,L),c?(S[0]=i[0]+c[0],S[1]=i[1]+c[1]):O(this,G,ye).call(this,S,y,L),k.moveTo(i[0],i[1]+E),k.bezierCurveTo(S[0],S[1]+E,N[0],N[1]+E,n[0],n[1]+E),findPointOnCurve(A,i,n,S,N,.5),T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const w=I(C,Ee);findPointOnCurve(w,i,n,S,N,.51),T._centreAngle=Math.atan2(w[1]-A[1],w[0]-A[0])}}else{const w=this.links_render_mode==LinkRenderType.LINEAR_LINK?15:10;switch(y){case LinkDirection.LEFT:S[0]+=-w;break;case LinkDirection.RIGHT:S[0]+=w;break;case LinkDirection.UP:S[1]+=-w;break;case LinkDirection.DOWN:S[1]+=w;break}switch(b){case LinkDirection.LEFT:N[0]+=-w;break;case LinkDirection.RIGHT:N[0]+=w;break;case LinkDirection.UP:N[1]+=-w;break;case LinkDirection.DOWN:N[1]+=w;break}if(this.links_render_mode==LinkRenderType.LINEAR_LINK)k.moveTo(i[0],i[1]+E),k.lineTo(S[0],S[1]+E),k.lineTo(N[0],N[1]+E),k.lineTo(n[0],n[1]+E),A[0]=(S[0]+N[0])*.5,A[1]=(S[1]+N[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow&&(T._centreAngle=Math.atan2(N[1]-S[1],N[0]-S[0]));else if(this.links_render_mode==LinkRenderType.STRAIGHT_LINK){const R=(S[0]+N[0])*.5;if(k.moveTo(i[0],i[1]),k.lineTo(S[0],S[1]),k.lineTo(R,S[1]),k.lineTo(R,N[1]),k.lineTo(N[0],N[1]),k.lineTo(n[0],n[1]),A[0]=R,A[1]=(S[1]+N[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const M=N[1]-S[1];Math.abs(M)<4?T._centreAngle=0:M>0?T._centreAngle=Math.PI*.5:T._centreAngle=-(Math.PI*.5)}}else return}}if(this.render_connections_border&&!this.low_quality&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke(k)),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=_,t.stroke(k),this.ds.scale>=.6&&this.highquality_render&&T){if(this.render_connection_arrows){const D=this.computeConnectionPoint(i,n,.25,y,b),E=this.computeConnectionPoint(i,n,.26,y,b),w=this.computeConnectionPoint(i,n,.75,y,b),R=this.computeConnectionPoint(i,n,.76,y,b);let M=0,U=0;this.render_curved_connections?(M=-Math.atan2(E[0]-D[0],E[1]-D[1]),U=-Math.atan2(R[0]-w[0],R[1]-w[1])):U=M=n[1]>i[1]?0:Math.PI;const F=t.getTransform();t.translate(D[0],D[1]),t.rotate(M),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(F),t.translate(w[0],w[1]),t.rotate(U),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(F)}if(t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const D=t.getTransform();t.translate(A[0],A[1]),T._centreAngle&&t.rotate(T._centreAngle),t.moveTo(-3.2,-5),t.lineTo(7,0),t.lineTo(-3.2,5),t.setTransform(D)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(A[0],A[1],5,0,Math.PI*2);if(m){const{fillStyle:D,globalAlpha:E}=t;t.fillStyle=this._pattern??"#797979",t.globalAlpha=.75,t.fill(),t.globalAlpha=E,t.fillStyle=D}if(t.fill(),LLink._drawDebug){const{fillStyle:D,font:E,globalAlpha:w,lineWidth:R,strokeStyle:M}=t;t.globalAlpha=1,t.lineWidth=4,t.fillStyle="white",t.strokeStyle="black",t.font="16px Arial";const U=String(T.id),{width:F,actualBoundingBoxAscent:j}=t.measureText(U),pt=A[0]-F*.5,st=A[1]+j*.5;t.strokeText(U,pt,st),t.fillText(U,pt,st),t.font=E,t.globalAlpha=w,t.lineWidth=R,t.fillStyle=D,t.strokeStyle=M}}if(r){t.fillStyle=_;for(let D=0;D<5;++D){const E=(LiteGraph.getTime()*.001+D*.2)%1,w=this.computeConnectionPoint(i,n,E,y,b);t.beginPath(),t.arc(w[0],w[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,i,n,s,o){s||(s=LinkDirection.RIGHT),o||(o=LinkDirection.LEFT);const r=distance(t,i),a=[t[0],t[1]],l=[i[0],i[1]];O(this,G,ye).call(this,a,s,r),O(this,G,ye).call(this,l,o,r);const h=(1-n)*(1-n)*(1-n),c=3*((1-n)*(1-n))*n,d=3*(1-n)*(n*n),f=n*n*n,g=h*t[0]+c*a[0]+d*l[0]+f*i[0],m=h*t[1]+c*a[1]+d*l[1]+f*i[1];return[g,m]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;const{visible_nodes:i}=this;for(const n of i)t.fillStyle="black",t.fillRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),n.order==0&&t.strokeRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(stringOrEmpty(n.order),n.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,n.pos[1]-6);t.globalAlpha=1}drawNodeWidgets(t,i,n){t.drawWidgets(n,{lowQuality:this.low_quality,editorAlpha:this.editor_alpha})}drawGroups(t,i){if(!this.graph)return;const n=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;const s=I(this,et)&&this.isDragging;for(const o of n)overlapBounding(this.visible_area,o._bounding)&&(s&&this.selectedItems.has(o)&&this.drawSnapGuide(i,o),o.draw(this,i));i.restore()}resize(t,i){if(!t&&!i){const n=this.canvas.parentElement;if(!n)throw new TypeError("Attempted to resize canvas, but parent element was null.");t=n.offsetWidth,i=n.offsetHeight}this.canvas.width==t&&this.canvas.height==i||(this.canvas.width=t??0,this.canvas.height=i??0,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}onNodeSelectionChange(){}boundaryNodesForSelection(){return C.getBoundaryNodes(this.selected_nodes)}showLinkMenu(t,i){var f,g;const{graph:n}=this;if(!n)throw new NullGraphError;const s="data"in t&&t.data!=null?t.data.constructor.name:void 0,{origin_id:o,origin_slot:r}=t;if(o==null||r==null)return new LiteGraph.ContextMenu(["Link has no origin"],{event:i,title:s}),!1;const a=n.getNodeById(o),l=(g=(f=a==null?void 0:a.outputs)==null?void 0:f[r])==null?void 0:g.type,h=["Add Node","Add Reroute",null,"Delete",null],c=new LiteGraph.ContextMenu(h,{event:i,title:s,callback:d.bind(this)});return!1;function d(m,_,y){if(!n)throw new NullGraphError;switch(m){case"Add Node":C.onMenuAdd(null,null,y,c,b=>{var k,T;if(!((k=b==null?void 0:b.inputs)!=null&&k.length)||!((T=b==null?void 0:b.outputs)!=null&&T.length)||r==null)return;const L={afterRerouteId:t.parentId};a!=null&&a.connectByType(r,b,l??"*",L)&&(b.pos[0]-=b.size[0]*.5)});break;case"Add Reroute":{try{this.emitBeforeChange(),this.adjustMouseEvent(y),n.createReroute(t._pos,t),this.setDirty(!1,!0)}catch(b){console.error(b)}finally{this.emitAfterChange()}break}case"Delete":n.removeLink(t.id);break}}}createDefaultNodeForSlot(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[0,0],nodeType:void 0,posAdd:[0,0],posSizeFix:[0,0]},t),{afterRerouteId:n}=i,s=i.nodeFrom&&i.slotFrom!==null,o=!s&&i.nodeTo&&i.slotTo!==null;if(!s&&!o)return console.warn("No data passed to createDefaultNodeForSlot",i.nodeFrom,i.slotFrom,i.nodeTo,i.slotTo),!1;if(!i.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const r=s?i.nodeFrom:i.nodeTo;if(!r)throw new TypeError("nodeX was null when creating default node for slot.");let a=s?i.slotFrom:i.slotTo,l=!1;if(r instanceof SubgraphIONodeBase){if(typeof a!="object"||!a)return console.warn("Cant get slot information",a),!1;const{name:d}=a;if(l=r.slots.findIndex(f=>f.name===d),a=r.slots[l],!a)return console.warn("Cant get slot information",a),!1}else switch(typeof a){case"string":l=s?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=s?r.outputs[a]:r.inputs[a];break;case"object":if(a===null)return console.warn("Cant get slot information",a),!1;l=s?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":l=a,a=s?r.outputs[a]:r.inputs[a];break;case"undefined":default:return console.warn("Cant get slot information",a),!1}const h=a.type==LiteGraph.EVENT?"_event_":a.type,c=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(c!=null&&c[h]){let d=!1;if(typeof c[h]=="object"){for(const f in c[h])if(i.nodeType==c[h][f]||i.nodeType=="AUTO"){d=c[h][f];break}}else(i.nodeType==c[h]||i.nodeType=="AUTO")&&(d=c[h]);if(d){let f=!1;typeof d=="object"&&d.node&&(f=d,d=d.node);const g=LiteGraph.createNode(d);if(g){if(f){if(f.properties)for(const y in f.properties)g.addProperty(y,f.properties[y]);if(f.inputs){g.inputs=[];for(const y in f.inputs)g.addOutput(f.inputs[y][0],f.inputs[y][1])}if(f.outputs){g.outputs=[];for(const y in f.outputs)g.addOutput(f.outputs[y][0],f.outputs[y][1])}f.title&&(g.title=f.title),f.json&&g.configure(f.json)}if(!this.graph)throw new NullGraphError;this.graph.add(g),g.pos=[i.position[0]+i.posAdd[0]+(i.posSizeFix[0]?i.posSizeFix[0]*g.size[0]:0),i.position[1]+i.posAdd[1]+(i.posSizeFix[1]?i.posSizeFix[1]*g.size[1]:0)];const m={node:g,opts:i};if(!this.canvas.dispatchEvent(new CustomEvent("connect-new-default-node",{detail:m,cancelable:!0})))return!0;if(s){if(!i.nodeFrom)throw new TypeError("createDefaultNodeForSlot - nodeFrom was null");i.nodeFrom.connectByType(l,g,h,{afterRerouteId:n})}else{if(!i.nodeTo)throw new TypeError("createDefaultNodeForSlot - nodeTo was null");i.nodeTo.connectByTypeOutput(l,g,h,{afterRerouteId:n})}return!0}console.log(`failed creating ${d}`)}}return!1}showConnectionMenu(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:void 0,allow_searchbox:this.allow_searchbox,showSearchBox:this.showSearchBox},t||{}),n=()=>O(this,G,ht).call(this),s=this,{graph:o}=this,{afterRerouteId:r}=i,a=i.nodeFrom&&i.slotFrom,l=!a&&i.nodeTo&&i.slotTo;if(!a&&!l){console.warn("No data passed to showConnectionMenu");return}const h=a?i.nodeFrom:i.nodeTo;if(!h)throw new TypeError("nodeX was null when creating default node for slot.");let c=a?i.slotFrom:i.slotTo,d;if(h instanceof SubgraphIONodeBase){if(typeof c!="object"||!c){console.warn("Cant get slot information",c);return}const{name:b}=c;if(d=h.slots.findIndex(L=>L.name===b),d!==-1&&(c=h.slots[d]),!c){console.warn("Cant get slot information",c);return}}else switch(typeof c){case"string":d=a?h.findOutputSlot(c,!1):h.findInputSlot(c,!1),c=a?h.outputs[c]:h.inputs[c];break;case"object":if(c===null){console.warn("Cant get slot information",c);return}d=a?h.findOutputSlot(c.name):h.findInputSlot(c.name);break;case"number":d=c,c=a?h.outputs[c]:h.inputs[c];break;default:console.warn("Cant get slot information",c);return}const f=["Add Node","Add Reroute",null];i.allow_searchbox&&f.push("Search",null);const g=c.type==LiteGraph.EVENT?"_event_":c.type,m=a?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(m!=null&&m[g])if(typeof m[g]=="object")for(const b in m[g])f.push(m[g][b]);else f.push(m[g]);const _=new LiteGraph.ContextMenu(f,{event:i.e,extra:c,title:(c&&c.name!=""?c.name+(g?" | ":""):"")+(c&&g?g:""),callback:y});return _;function y(b,L,k){var T,S;switch(b){case"Add Node":C.onMenuAdd(null,null,k,_,function(N){if(N)if(a){if(!i.nodeFrom)throw new TypeError("Cannot add node to SubgraphInputNode: nodeFrom was null");i.nodeFrom.connectByType(d,N,g,{afterRerouteId:r})||console.warn("Failed to make new connection.")}else{if(!i.nodeTo)throw new TypeError("Cannot add node to SubgraphInputNode: nodeTo was null");i.nodeTo.connectByTypeOutput(d,N,g,{afterRerouteId:r})}});break;case"Add Reroute":{const N=a?i.nodeFrom:i.nodeTo,A=L.extra;if(!o)throw new NullGraphError;if(!N)throw new TypeError("Cannot add reroute: node was null");if(!A)throw new TypeError("Cannot add reroute: slot was null");if(!i.e)throw new TypeError("Cannot add reroute: CanvasPointerEvent was null");if(N instanceof SubgraphIONodeBase)throw new TypeError("Cannot add floating reroute to Subgraph IO Nodes");if(!N.connectFloatingReroute([i.e.canvasX,i.e.canvasY],A,r))throw new Error("Failed to create reroute");n();break}case"Search":a?i.showSearchBox(k,{node_from:i.nodeFrom,slot_from:c,type_filter_in:g}):i.showSearchBox(k,{node_to:i.nodeTo,slot_from:c,type_filter_out:g});break;default:{const N={position:[((T=i.e)==null?void 0:T.canvasX)??0,((S=i.e)==null?void 0:S.canvasY)??0],nodeType:b,afterRerouteId:r},A=Object.assign(i,N);if(!s.createDefaultNodeForSlot(A))break}}}}prompt(t,i,n,s,o){var N;const r=this;t=t||"";const a={is_modified:!1,className:"graphdialog rounded",innerHTML:o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",close(){r.prompt_box=null,h.parentNode&&h.remove()}},l=document.createElement("div"),h=Object.assign(l,a),c=C.active_canvas,{canvas:d}=c;if(!d.parentNode)throw new TypeError("canvas element parentNode was null when opening a prompt.");d.parentNode.append(h),this.ds.scale>1&&(h.style.transform=`scale(${this.ds.scale})`);let f,g=0;LiteGraph.pointerListenerAdd(h,"leave",function(){g||LiteGraph.dialog_close_on_mouse_leave&&!h.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(h.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(h,"enter",function(){LiteGraph.dialog_close_on_mouse_leave&&f&&clearTimeout(f)});const m=h.querySelectorAll("select");if(m)for(const A of m)A.addEventListener("click",function(){g++}),A.addEventListener("blur",function(){g=0}),A.addEventListener("change",function(){g=-1});(N=this.prompt_box)==null||N.close(),this.prompt_box=h;const _=h.querySelector(".name");if(!_)throw new TypeError("name_element was null");_.textContent=t;const y=h.querySelector(".value");if(!y)throw new TypeError("value_element was null");y.value=i,y.select();const b=y;b.addEventListener("keydown",function(A){if(h.is_modified=!0,A.key=="Escape")h.close();else if(A.key=="Enter"&&A.target.localName!="textarea")n&&n(this.value),h.close();else return;A.preventDefault(),A.stopPropagation()});const L=h.querySelector("button");if(!L)throw new TypeError("button was null when opening prompt");L.addEventListener("click",function(){n==null||n(b.value),r.setDirty(!0),h.close()});const k=d.getBoundingClientRect();let T=-20,S=-20;return k&&(T-=k.left,S-=k.top),s?(h.style.left=`${s.clientX+T}px`,h.style.top=`${s.clientY+S}px`):(h.style.left=`${d.width*.5+T}px`,h.style.top=`${d.height*.5+S}px`),setTimeout(function(){var E,w;b.focus();const A=Date.now();function D(R){var M,U;R.target===d&&Date.now()-A>256&&(h.close(),(M=d.parentElement)==null||M.removeEventListener("click",D),(U=d.parentElement)==null||U.removeEventListener("touchend",D))}(E=d.parentElement)==null||E.addEventListener("click",D),(w=d.parentElement)==null||w.addEventListener("touchend",D)},10),h}showSearchBox(t,i){var D;const n={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};Object.assign(n,i);const s=this,o=C.active_canvas,{canvas:r}=o,a=r.ownerDocument||document,l=document.createElement("div"),h=Object.assign(l,{close(){s.search_box=void 0,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(()=>r.focus(),20),h.remove()}});h.className="litegraph litesearchbox graphdialog rounded",h.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",n.do_type_filter&&(h.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",h.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>");const c=document.createElement("div");c.className="helper",h.append(c),a.fullscreenElement?a.fullscreenElement.append(h):(a.body.append(h),a.body.style.overflow="hidden");let d,f;if(n.do_type_filter&&(d=h.querySelector(".slot_in_type_filter"),f=h.querySelector(".slot_out_type_filter")),this.ds.scale>1&&(h.style.transform=`scale(${this.ds.scale})`),n.hide_on_mouse_leave){let E=!1,w=null;if(LiteGraph.pointerListenerAdd(h,"enter",function(){w&&(clearTimeout(w),w=null)}),h.addEventListener("pointerleave",function(){if(E)return;const R=n.hide_on_mouse_leave,M=typeof R=="number"?R:500;w=setTimeout(h.close,M)}),n.do_type_filter){if(!d)throw new TypeError("selIn was null when showing search box");if(!f)throw new TypeError("selOut was null when showing search box");d.addEventListener("click",function(){E++}),d.addEventListener("blur",function(){E=0}),d.addEventListener("change",function(){E=-1}),f.addEventListener("click",function(){E++}),f.addEventListener("blur",function(){E=0}),f.addEventListener("change",function(){E=-1})}}(D=s.search_box)==null||D.close(),s.search_box=h;let g=null,m=null,_=null;const y=h.querySelector("input");if(!y)throw new TypeError("Could not create search input box.");const b=y;if(b&&(b.addEventListener("blur",function(){this.focus()}),b.addEventListener("keydown",function(E){if(E.key=="ArrowUp")N(!1);else if(E.key=="ArrowDown")N(!0);else if(E.key=="Escape")h.close();else if(E.key=="Enter")_ instanceof HTMLElement?S(unescape(String(_.dataset.type))):g?S(g):h.close();else{m&&clearInterval(m),m=setTimeout(A,10);return}return E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation(),!0})),n.do_type_filter){if(d){const E=LiteGraph.slot_types_in,w=E.length;(n.type_filter_in==LiteGraph.EVENT||n.type_filter_in==LiteGraph.ACTION)&&(n.type_filter_in="_event_");for(let R=0;R<w;R++){const M=document.createElement("option");M.value=E[R],M.innerHTML=E[R],d.append(M),n.type_filter_in!==!1&&String(n.type_filter_in).toLowerCase()==String(E[R]).toLowerCase()&&(M.selected=!0)}d.addEventListener("change",function(){A()})}if(f){const E=LiteGraph.slot_types_out;(n.type_filter_out==LiteGraph.EVENT||n.type_filter_out==LiteGraph.ACTION)&&(n.type_filter_out="_event_");for(const w of E){const R=document.createElement("option");R.value=w,R.innerHTML=w,f.append(R),n.type_filter_out!==!1&&String(n.type_filter_out).toLowerCase()==String(w).toLowerCase()&&(R.selected=!0)}f.addEventListener("change",function(){A()})}}const L=r.getBoundingClientRect(),k=(t?t.clientX:L.left+L.width*.5)-80,T=(t?t.clientY:L.top+L.height*.5)-20;h.style.left=`${k}px`,h.style.top=`${T}px`,t.layerY>L.height-200&&(c.style.maxHeight=`${L.height-t.layerY-20}px`),requestAnimationFrame(function(){b.focus()}),n.show_all_on_open&&A();function S(E){if(E)if(s.onSearchBoxSelection)s.onSearchBoxSelection(E,t,o);else{if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const w=LiteGraph.createNode(E);if(w&&(w.pos=o.convertEventToCanvasOffset(t),o.graph.add(w,!1)),n.node_from){let R=!1;switch(typeof n.slot_from){case"string":R=n.node_from.findOutputSlot(n.slot_from);break;case"object":if(n.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");R=n.slot_from.name?n.node_from.findOutputSlot(n.slot_from.name):-1,R==-1&&n.slot_from.slot_index!==void 0&&(R=n.slot_from.slot_index);break;case"number":R=n.slot_from;break;default:R=0}if(n.node_from.outputs[R]!==void 0&&R!==!1&&R>-1){if(w==null)throw new TypeError("options.slot_from was null when showing search box");n.node_from.connectByType(R,w,n.node_from.outputs[R].type)}}if(n.node_to){let R=!1;switch(typeof n.slot_from){case"string":R=n.node_to.findInputSlot(n.slot_from);break;case"object":if(n.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");R=n.slot_from.name?n.node_to.findInputSlot(n.slot_from.name):-1,R==-1&&n.slot_from.slot_index!==void 0&&(R=n.slot_from.slot_index);break;case"number":R=n.slot_from;break;default:R=0}if(n.node_to.inputs[R]!==void 0&&R!==!1&&R>-1){if(w==null)throw new TypeError("options.slot_from was null when showing search box");n.node_to.connectByTypeOutput(R,w,n.node_to.inputs[R].type)}}o.graph.afterChange()}h.close()}function N(E){const w=_;_?_ instanceof Element&&(_.classList.remove("selected"),_=E?_.nextSibling:_.previousSibling,_||(_=w)):_=E?c.childNodes[0]:c.childNodes[c.childNodes.length],_ instanceof Element&&(_.classList.add("selected"),_.scrollIntoView({block:"end",behavior:"smooth"}))}function A(){m=null;let E=b.value;if(g=null,c.innerHTML="",!E&&!n.show_all_if_empty)return;if(s.onSearchBox){const R=s.onSearchBox(c,E,o);if(R)for(const M of R)w(M)}else{let R=function(V,K){var Qe,ti;K=K||{};const Ot=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},K),_e=LiteGraph.registered_node_types[V];if(U&&_e.filter!=U||(!n.show_all_if_empty||E)&&!V.toLowerCase().includes(E)&&(!_e.title||!_e.title.toLowerCase().includes(E)))return!1;if(n.do_type_filter&&!Ot.skipFilter){const ei=V;let wt=Ot.inTypeOverride!==!1?Ot.inTypeOverride:F.value;if(F&&wt&&((Qe=LiteGraph.registered_slot_in_types[wt])!=null&&Qe.nodes)&&LiteGraph.registered_slot_in_types[wt].nodes.includes(ei)===!1||(wt=j.value,Ot.outTypeOverride!==!1&&(wt=Ot.outTypeOverride),j&&wt&&((ti=LiteGraph.registered_slot_out_types[wt])!=null&&ti.nodes)&&LiteGraph.registered_slot_out_types[wt].nodes.includes(ei)===!1))return!1}return!0},M=0;if(E=E.toLowerCase(),!o.graph)throw new NullGraphError;const U=o.filter||o.graph.filter;let F=!1,j=!1;n.do_type_filter&&s.search_box&&(F=s.search_box.querySelector(".slot_in_type_filter"),j=s.search_box.querySelector(".slot_out_type_filter"));const st=Object.keys(LiteGraph.registered_node_types).filter(V=>R(V));for(const V of st)if(w(V),C.search_limit!==-1&&M++>C.search_limit)break;if(n.show_general_after_typefiltered&&(F.value||j.value)){filtered_extra=[];for(const V in LiteGraph.registered_node_types)R(V,{inTypeOverride:F&&F.value?"*":!1,outTypeOverride:j&&j.value?"*":!1})&&filtered_extra.push(V);for(const V of filtered_extra)if(w(V,"generic_type"),C.search_limit!==-1&&M++>C.search_limit)break}if((F.value||j.value)&&c.childNodes.length==0&&n.show_general_if_none_on_typefilter){filtered_extra=[];for(const V in LiteGraph.registered_node_types)R(V,{skipFilter:!0})&&filtered_extra.push(V);for(const V of filtered_extra)if(w(V,"not_in_filter"),C.search_limit!==-1&&M++>C.search_limit)break}}function w(R,M){const U=document.createElement("div");g||(g=R);const F=LiteGraph.registered_node_types[R];if(F!=null&&F.title){U.textContent=F==null?void 0:F.title;const j=document.createElement("span");j.className="litegraph lite-search-item-type",j.textContent=R,U.append(j)}else U.textContent=R;U.dataset.type=escape(R),U.className="litegraph lite-search-item",M&&(U.className+=` ${M}`),U.addEventListener("click",function(){S(unescape(String(this.dataset.type)))}),c.append(U)}}return h}showEditPropertyValue(t,i,n){if(!t||t.properties[i]===void 0)return;n=n||{};const s=t.getPropertyInfo(i),{type:o}=s;let r="";if(o=="string"||o=="number"||o=="array"||o=="object")r="<input autofocus type='text' class='value'/>";else if((o=="enum"||o=="combo")&&s.values){r="<select autofocus type='text' class='value'>";for(const g in s.values){const m=Array.isArray(s.values)?s.values[g]:g,_=m==t.properties[i]?"selected":"";r+=`<option value='${m}' ${_}>${s.values[g]}</option>`}r+="</select>"}else if(o=="boolean"||o=="toggle")r=`<input autofocus type='checkbox' class='value' ${t.properties[i]?"checked":""}/>`;else{console.warn(`unknown type: ${o}`);return}const a=this.createDialog(`<span class='name'>${s.label||i}</span>${r}<button>OK</button>`,n);let l;if((o=="enum"||o=="combo")&&s.values)l=a.querySelector("select"),l==null||l.addEventListener("change",function(g){var m;a.modified(),f((m=g.target)==null?void 0:m.value)});else if(o=="boolean"||o=="toggle")l=a.querySelector("input"),l==null||l.addEventListener("click",function(){a.modified(),f(!!l.checked)});else if(l=a.querySelector("input"),l){l.addEventListener("blur",function(){this.focus()});let g=t.properties[i]!==void 0?t.properties[i]:"";o!=="string"&&(g=JSON.stringify(g)),l.value=g,l.addEventListener("keydown",function(m){if(m.key=="Escape")a.close();else if(m.key=="Enter")c();else{a.modified();return}m.preventDefault(),m.stopPropagation()})}l==null||l.focus();const h=a.querySelector("button");if(!h)throw new TypeError("Show edit property value button was null.");h.addEventListener("click",c);function c(){f(l==null?void 0:l.value)}const d=()=>O(this,G,ht).call(this);function f(g){var m,_;s!=null&&s.values&&typeof s.values=="object"&&s.values[g]!=null&&(g=s.values[g]),typeof t.properties[i]=="number"&&(g=Number(g)),(o=="array"||o=="object")&&(g=JSON.parse(g)),t.properties[i]=g,t.graph&&t.graph._version++,(m=t.onPropertyChanged)==null||m.call(t,i,g),(_=n.onclose)==null||_.call(n),a.close(),d()}return a}createDialog(t,i){i=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},i||{});const s={className:"graphdialog",innerHTML:t,is_modified:!1,modified(){this.is_modified=!0},close(){this.remove()}},o=document.createElement("div"),r=Object.assign(o,s),a=this.canvas.getBoundingClientRect();let l=-20,h=-20;if(a&&(l-=a.left,h-=a.top),i.position?(l+=i.position[0],h+=i.position[1]):i.event?(l+=i.event.clientX,h+=i.event.clientY):(l+=this.canvas.width*.5,h+=this.canvas.height*.5),r.style.left=`${l}px`,r.style.top=`${h}px`,!this.canvas.parentNode)throw new TypeError("Canvas parent element was null.");if(this.canvas.parentNode.append(r),i.checkForInput){const g=r.querySelectorAll("input");if(g)for(const m of g)m.addEventListener("keydown",function(_){if(r.modified(),_.key=="Escape")r.close();else if(_.key!="Enter")return;_.preventDefault(),_.stopPropagation()}),m.focus()}let c,d=0;r.addEventListener("mouseleave",function(){d||!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(){(i.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&c&&clearTimeout(c)});const f=r.querySelectorAll("select");if(f)for(const g of f)g.addEventListener("click",function(){d++}),g.addEventListener("blur",function(){d=0}),g.addEventListener("change",function(){d=-1});return r}createPanel(t,i){i=i||{};const n=i.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),i.width&&(s.style.width=i.width+(typeof i.width=="number"?"px":"")),i.height&&(s.style.height=i.height+(typeof i.height=="number"?"px":"")),i.closable){const o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",function(){s.close()}),s.header.append(o)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.textContent=t,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){typeof s.onClose=="function"&&s.onClose(),s.remove(),this.remove()},s.toggleAltContent=function(o){let r,a;o!==void 0?(r=o?"block":"none",a=o?"none":"block"):(r=s.alt_content.style.display!="block"?"block":"none",a=s.alt_content.style.display!="block"?"none":"block"),s.alt_content.style.display=r,s.content.style.display=a},s.toggleFooterVisibility=function(o){let r;o!==void 0?r=o?"block":"none":r=s.footer.style.display!="block"?"block":"none",s.footer.style.display=r},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(o,r,a){const l=document.createElement("div");return r&&(l.className=r),l.innerHTML=o,a?s.footer.append(l):s.content.append(l),l},s.addButton=function(o,r,a){const l=document.createElement("button");return l.textContent=o,l.options=a,l.classList.add("btn"),l.addEventListener("click",r),s.footer.append(l),l},s.addSeparator=function(){const o=document.createElement("div");o.className="separator",s.content.append(o)},s.addWidget=function(o,r,a,l,h){l=l||{};let c=String(a);o=o.toLowerCase(),o=="number"&&typeof a=="number"&&(c=a.toFixed(3));const d=document.createElement("div");d.className="property",d.innerHTML="<span class='property_name'></span><span class='property_value'></span>";const f=d.querySelector(".property_name");if(!f)throw new TypeError("Property name element was null.");f.textContent=l.label||r;const g=d.querySelector(".property_value");if(!g)throw new TypeError("Property name element was null.");if(g.textContent=c,d.dataset.property=r,d.dataset.type=l.type||o,d.options=l,d.value=a,o=="code")d.addEventListener("click",function(){s.inner_showCodePad(this.dataset.property)});else if(o=="boolean")d.classList.add("boolean"),a&&d.classList.add("bool-on"),d.addEventListener("click",()=>{const _=d.dataset.property;if(d.value=!d.value,d.classList.toggle("bool-on"),!g)throw new TypeError("Property name element was null.");g.textContent=d.value?"true":"false",m(_,d.value)});else if(o=="string"||o=="number"){if(!g)throw new TypeError("Property name element was null.");g.setAttribute("contenteditable","true"),g.addEventListener("keydown",function(_){_.code=="Enter"&&(o!="string"||!_.shiftKey)&&(_.preventDefault(),this.blur())}),g.addEventListener("blur",function(){var L,k;let _=this.textContent;const y=(L=this.parentElement)==null?void 0:L.dataset.property;((k=this.parentElement)==null?void 0:k.dataset.type)=="number"&&(_=Number(_)),m(y,_)})}else if(o=="enum"||o=="combo"){const _=C.getPropertyPrintableValue(a,l.values);if(!g)throw new TypeError("Property name element was null.");g.textContent=_??"",g.addEventListener("click",function(y){var T;const b=l.values||[],L=(T=this.parentElement)==null?void 0:T.dataset.property,k=S=>(this.textContent=S,m(L,S),!1);new LiteGraph.ContextMenu(b,{event:y,className:"dark",callback:k},n)})}s.content.append(d);function m(_,y){var b;(b=l.callback)==null||b.call(l,_,y,l),h==null||h(_,y,l)}return d},typeof s.onOpen=="function"&&s.onOpen(),s}closePanels(){var t,i,n,s;(i=(t=document.querySelector("#node-panel"))==null?void 0:t.close)==null||i.call(t),(s=(n=document.querySelector("#option-panel"))==null?void 0:n.close)==null||s.call(n)}showShowNodePanel(t){this.SELECTED_NODE=t,this.closePanels();const i=this.getCanvasWindow(),n=this.createPanel(t.title||"",{closable:!0,window:i,onOpen:()=>{this.NODEPANEL_IS_OPEN=!0},onClose:()=>{this.NODEPANEL_IS_OPEN=!1,this.node_panel=null}});this.node_panel=n,n.id="node-panel",n.node=t,n.classList.add("settings");const s=()=>{var l,h;n.content.innerHTML="",n.addHTML(`<span class='node_type'>${t.type}</span><span class='node_desc'>${t.constructor.desc||""}</span><span class='separator'></span>`),n.addHTML("<h3>Properties</h3>");const o=(c,d)=>{if(!this.graph)throw new NullGraphError;switch(this.graph.beforeChange(t),c){case"Title":if(typeof d!="string")throw new TypeError("Attempting to set title to non-string value.");t.title=d;break;case"Mode":{if(typeof d!="string")throw new TypeError("Attempting to set mode to non-string value.");const f=Object.values(LiteGraph.NODE_MODES).indexOf(d);f!==-1&&LiteGraph.NODE_MODES[f]?t.changeMode(f):console.warn(`unexpected mode: ${d}`);break}case"Color":if(typeof d!="string")throw new TypeError("Attempting to set colour to non-string value.");C.node_colors[d]?(t.color=C.node_colors[d].color,t.bgcolor=C.node_colors[d].bgcolor):console.warn(`unexpected color: ${d}`);break;default:t.setProperty(c,d);break}this.graph.afterChange(),this.dirty_canvas=!0};n.addWidget("string","Title",t.title,{},o);const r=t.mode==null?void 0:LiteGraph.NODE_MODES[t.mode];n.addWidget("combo","Mode",r,{values:LiteGraph.NODE_MODES},o);const a=t.color!==void 0?Object.keys(C.node_colors).filter(function(c){return C.node_colors[c].color==t.color}):"";n.addWidget("combo","Color",a,{values:Object.keys(C.node_colors)},o);for(const c in t.properties){const d=t.properties[c],f=t.getPropertyInfo(c);(l=t.onAddPropertyToPanel)!=null&&l.call(t,c,n)||n.addWidget(f.widget||f.type,c,d,f,o)}n.addSeparator(),(h=t.onShowCustomPanelInfo)==null||h.call(t,n),n.footer.innerHTML="",n.addButton("Delete",function(){if(!t.block_delete){if(!t.graph)throw new NullGraphError;t.graph.remove(t),n.close()}}).classList.add("delete")};if(n.inner_showCodePad=function(o){n.classList.remove("settings"),n.classList.add("centered"),n.alt_content.innerHTML="<textarea class='code'></textarea>";const r=n.alt_content.querySelector("textarea"),a=function(){n.toggleAltContent(!1),n.toggleFooterVisibility(!0),r.remove(),n.classList.add("settings"),n.classList.remove("centered"),s()};r.value=String(t.properties[o]),r.addEventListener("keydown",function(c){c.code=="Enter"&&c.ctrlKey&&(t.setProperty(o,r.value),a())}),n.toggleAltContent(!0),n.toggleFooterVisibility(!1),r.style.height="calc(100% - 40px)";const l=n.addButton("Assign",function(){t.setProperty(o,r.value),a()});n.alt_content.append(l);const h=n.addButton("Close",a);h.style.float="right",n.alt_content.append(h)},s(),!this.canvas.parentNode)throw new TypeError("showNodePanel - this.canvas.parentNode was null");this.canvas.parentNode.append(n)}checkPanels(){if(!this.canvas)return;if(!this.canvas.parentNode)throw new TypeError("checkPanels - this.canvas.parentNode was null");const t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(const i of t)i.node&&(!i.node.graph||i.graph!=this.graph)&&i.close()}getCanvasMenuOptions(){var n;let t;this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:C.onMenuAdd},{content:"Add Group",callback:C.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&t.push({content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Align",has_submenu:!0,callback:C.onGroupAlign}));const i=(n=this.getExtraMenuOptions)==null?void 0:n.call(this,this,t);return Array.isArray(i)?t.concat(i):t}getNodeMenuOptions(t){var s,o,r,a;let i;t.getMenuOptions?i=t.getMenuOptions(this):(i=[{content:"Inputs",has_submenu:!0,disabled:!0},{content:"Outputs",has_submenu:!0,disabled:!0,callback:C.showMenuNodeOptionalOutputs},null,{content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Properties",has_submenu:!0,callback:C.onShowMenuNodeProperties},{content:"Properties Panel",callback:function(l,h,c,d,f){C.active_canvas.showShowNodePanel(f)}},null,{content:"Title",callback:C.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:C.onMenuNodeMode}],t.resizable!==!1&&i.push({content:"Resize",callback:C.onMenuResizeNode}),t.collapsible&&i.push({content:t.collapsed?"Expand":"Collapse",callback:C.onMenuNodeCollapse}),(s=t.widgets)!=null&&s.some(l=>l.advanced)&&i.push({content:t.showAdvanced?"Hide Advanced":"Show Advanced",callback:C.onMenuToggleAdvanced}),i.push({content:t.pinned?"Unpin":"Pin",callback:()=>{for(const l in this.selected_nodes)this.selected_nodes[l].pin();this.setDirty(!0,!0)}},{content:"Colors",has_submenu:!0,callback:C.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:C.onMenuNodeShapes},null));const n=(o=t.getExtraMenuOptions)==null?void 0:o.call(t,this,i);return Array.isArray(n)&&n.length>0&&(n.push(null),i=n.concat(i)),t.clonable!==!1&&i.push({content:"Clone",callback:C.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&i.push({content:"Align Selected To",has_submenu:!0,callback:C.onNodeAlign},{content:"Distribute Nodes",has_submenu:!0,callback:C.createDistributeMenu}),i.push(null,{content:"Remove",disabled:!(t.removable!==!1&&!t.block_delete),callback:C.onMenuNodeRemove}),(a=(r=t.graph)==null?void 0:r.onGetNodeMenuOptions)==null||a.call(r,i,t),i}getGroupMenuOptions(t){return console.warn("LGraphCanvas.getGroupMenuOptions is deprecated, use LGraphGroup.getMenuOptions instead"),t.getMenuOptions()}processContextMenu(t,i){var c,d,f;const s=C.active_canvas.getCanvasWindow();let o;const r={event:i,callback:h,extra:t};if(t){r.title=t.displayType??t.type??void 0,C.active_node=t;const g=t.getSlotInPosition(i.canvasX,i.canvasY);if(g){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(g);else{((d=(c=g.output)==null?void 0:c.links)!=null&&d.length||((f=g.input)==null?void 0:f.link)!=null)&&o.push({content:"Disconnect Links",slot:g});const m=g.input||g.output;if(!m)throw new TypeError("Both in put and output slots were null when processing context menu.");m.removable&&o.push(m.locked?"Cannot remove":{content:"Remove Slot",slot:g}),!m.nameLocked&&!("link"in m&&m.widget)&&o.push({content:"Rename Slot",slot:g}),t.getExtraSlotMenuOptions&&o.push(...t.getExtraSlotMenuOptions(g))}r.title=(g.input?g.input.type:g.output.type)||"*",g.input&&g.input.type==LiteGraph.ACTION&&(r.title="Action"),g.output&&g.output.type==LiteGraph.EVENT&&(r.title="Event")}else o=this.getNodeMenuOptions(t)}else{if(o=this.getCanvasMenuOptions(),!this.graph)throw new NullGraphError;if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const m=this.graph.getRerouteOnPos(i.canvasX,i.canvasY,I(this,lt));m&&o.unshift({content:"Delete Reroute",callback:()=>{if(!this.graph)throw new NullGraphError;this.graph.removeReroute(m.id)}},null)}const g=this.graph.getGroupOnPos(i.canvasX,i.canvasY);g&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:g,options:g.getMenuOptions()}})}if(!o)return;new LiteGraph.ContextMenu(o,r,s);const a=g=>this.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",g),l=()=>this.setDirty(!0);function h(g,m){var _;if(g){if(g.content=="Remove Slot"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.input?t.removeInput(y.slot):y.output&&t.removeOutput(y.slot),t.graph.afterChange();return}else if(g.content=="Disconnect Links"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.output?t.disconnectOutput(y.slot):y.input&&t.disconnectInput(y.slot,!0),t.graph.afterChange();return}else if(g.content=="Rename Slot"){if(!t)throw new TypeError("`node` was null when processing the context menu.");const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");const b=y.input?t.getInputInfo(y.slot):t.getOutputInfo(y.slot),L=a(m),k=L.querySelector("input");k&&b&&(k.value=b.label||"");const T=function(){if(!t.graph)throw new NullGraphError;t.graph.beforeChange(),k!=null&&k.value&&(b&&(b.label=k.value),l()),L.close(),t.graph.afterChange()};if((_=L.querySelector("button"))==null||_.addEventListener("click",T),!k)throw new TypeError("Input element was null when processing context menu.");k.addEventListener("keydown",function(S){if(L.is_modified=!0,S.key=="Escape")L.close();else if(S.key=="Enter")T();else if(S.target.localName!="textarea")return;S.preventDefault(),S.stopPropagation()}),k.focus()}}}}animateToBounds(t,i={}){const n=()=>this.setDirty(!0,!0);this.ds.animateToBounds(t,n,i)}fitViewToSelectionAnimated(t={}){const i=this.selectedItems.size?Array.from(this.selectedItems):this.positionableItems,n=createBounds(i);if(!n)throw new TypeError("Attempted to fit to view but could not calculate bounds.");const s=()=>this.setDirty(!0,!0);this.ds.animateToBounds(n,s,t)}};ke=new WeakMap,Le=new WeakMap,Se=new WeakMap,mt=new WeakMap,dt=new WeakMap,Ie=new WeakMap,Te=new WeakMap,Ee=new WeakMap,It=new WeakMap,G=new WeakSet,Pe=function(){if(!this.state.shouldSetCursor)return;const t=CanvasItem.Node|CanvasItem.RerouteSlot|CanvasItem.SubgraphIoNode|CanvasItem.SubgraphIoSlot;let i="default";this.state.draggingCanvas?i="grabbing":this.state.readOnly?i="grab":this.pointer.resizeDirection?i=cursors[this.pointer.resizeDirection]??cursors.SE:this.state.hoveringOver&t?i="crosshair":this.state.hoveringOver&CanvasItem.Reroute&&(i="grab"),this.canvas.style.cursor=i},yt=new WeakMap,re=new WeakMap,lt=new WeakMap,et=new WeakMap,ae=new WeakMap,Tt=new WeakMap,mi=function(t){if(typeof t=="string"){const i=document.getElementById(t);if(!(i instanceof HTMLCanvasElement))throw"Error validating LiteGraph canvas: Canvas element not found";return i}return t},ht=function(){this.dirty_canvas=!0,this.dirty_bgcanvas=!0},Ct=function(){const{graph:t,linkConnector:i,pointer:n}=this;if(!t)throw new NullGraphError;n.onDragEnd=s=>i.dropLinks(t,s),n.finally=()=>this.linkConnector.reset(!0)},yi=function(t,i){var s,o;const n=(s=this.subgraph)==null?void 0:s.getIoNodeOnPos(t,i);if(n)return n;for(const r of I(this,lt))if(r.containsPoint([t,i]))return r;return(o=this.graph)==null?void 0:o.getGroupTitlebarOnPos(t,i)},bi=function(t,i){var c;const{pointer:n,graph:s,linkConnector:o,subgraph:r}=this;if(!s)throw new NullGraphError;const a=t.canvasX,l=t.canvasY,h=t.ctrlKey||t.metaKey;if(h&&!t.altKey&&LiteGraph.canvasNavigationMode==="legacy"){O(this,G,Ke).call(this,t,n,i);return}if(this.read_only){n.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0;return}if(LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&!t.ctrlKey&&i&&this.allow_interaction){let d=i.type;if(i instanceof SubgraphNode){const g=i.subgraph.clone().asSerialisable(),m=s.createSubgraph(g);m.configure(g),d=m.id}const f=(c=i.clone())==null?void 0:c.serialize();if((f==null?void 0:f.type)!=null){const g=LiteGraph.createNode(d);if(g){g.configure(f),g.pos[0]+=5,g.pos[1]+=5,this.allow_dragnodes?(n.onDragStart=m=>{s.add(g,!1),O(this,G,Dt).call(this,g,m)},n.onDragEnd=m=>O(this,G,Rt).call(this,m)):(s.beforeChange(),s.add(g,!1),s.afterChange());return}}}if(i&&(this.allow_interaction||i.flags.allow_interaction))O(this,G,wi).call(this,t,h,i);else{if(r){let m=function(b,L){return L.containsPoint([a,l])?(L.onPointerDown(t,n,o),n.onClick??(n.onClick=()=>b.processSelect(L,t)),n.onDragStart??(n.onDragStart=()=>{var k;return O(k=b,G,Dt).call(k,L,n,!0)}),n.onDragEnd??(n.onDragEnd=k=>{var T;return O(T=b,G,Rt).call(T,k)}),!0):!1};const{inputNode:_,outputNode:y}=r;if(m(this,_)||m(this,y))return}if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK)for(const m of I(this,lt)){const _=m.containsPoint([a,l]);if(!(!m.isSlotHovered&&!_)){_&&(n.onClick=()=>this.processSelect(m,t),t.shiftKey||(n.onDragStart=y=>O(this,G,Dt).call(this,m,y,!0),n.onDragEnd=y=>O(this,G,Rt).call(this,y))),(m.isOutputHovered||_&&t.shiftKey)&&(o.dragFromReroute(s,m),O(this,G,Ct).call(this)),m.isInputHovered&&(o.dragFromRerouteToOutput(s,m),O(this,G,Ct).call(this)),m.hideSlots(),this.dirty_bgcanvas=!0;return}}const{lineWidth:d}=this.ctx;this.ctx.lineWidth=this.connections_width+7;const f=(window==null?void 0:window.devicePixelRatio)||1;for(const m of this.renderedPaths){const _=m._pos;if(_){if((t.shiftKey||t.altKey)&&m.path&&this.ctx.isPointInStroke(m.path,a*f,l*f)){if(this.ctx.lineWidth=d,t.shiftKey&&!t.altKey){o.dragFromLinkSegment(s,m),O(this,G,Ct).call(this);return}else if(t.altKey&&!t.shiftKey){const y=s.createReroute([a,l],m);n.onDragStart=b=>O(this,G,Dt).call(this,y,b),n.onDragEnd=b=>O(this,G,Rt).call(this,b);return}}else if(isInRectangle(a,l,_[0]-4,_[1]-4,8,8)){this.ctx.lineWidth=d,n.onClick=()=>this.showLinkMenu(m,t),n.onDragStart=()=>this.dragging_canvas=!0,n.finally=()=>this.dragging_canvas=!1,this.over_link_center=void 0;return}}}this.ctx.lineWidth=d;const g=s.getGroupOnPos(a,l);if(this.selected_group=g??null,g){if(g.isInResize(a,l)){const m=g.boundingRect,_=a-(m[0]+m[2]),y=l-(m[1]+m[3]);n.onDragStart=()=>this.resizingGroup=g,n.onDrag=b=>{if(this.read_only)return;const L=[b.canvasX-g.pos[0]-_,b.canvasY-g.pos[1]-y];I(this,et)&&snapPoint(L,I(this,et)),g.resize(L[0],L[1])&&(this.dirty_bgcanvas=!0)},n.finally=()=>this.resizingGroup=null}else{const _=(g.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE)*1.4;isInRectangle(a,l,g.pos[0],g.pos[1],g.size[0],_)&&(n.onClick=()=>this.processSelect(g,t),n.onDragStart=y=>{g.recomputeInsideNodes(),O(this,G,Dt).call(this,g,y,!0)},n.onDragEnd=y=>O(this,G,Rt).call(this,y))}n.onDoubleClick=()=>{this.emitEvent({subType:"group-double-click",originalEvent:t,group:g})}}else n.onDoubleClick=()=>{this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault()),this.emitEvent({subType:"empty-double-click",originalEvent:t})}}!n.onDragStart&&!n.onClick&&!n.onDrag&&this.allow_dragcanvas&&(LiteGraph.canvasNavigationMode!=="standard"||this.read_only?(n.onClick=()=>this.processSelect(null,t),n.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0):O(this,G,Ke).call(this,t,n))},Ke=function(t,i,n){const s=new Float32Array(4);s[0]=t.canvasX,s[1]=t.canvasY,s[2]=1,s[3]=1,i.onClick=o=>{const r=n??O(this,G,yi).call(this,o.canvasX,o.canvasY);this.processSelect(r,o)},i.onDragStart=()=>this.dragging_rectangle=s,i.onDragEnd=o=>O(this,G,Ti).call(this,o,s),i.finally=()=>this.dragging_rectangle=null},wi=function(t,i,n){var f,g,m,_;const{pointer:s,graph:o,linkConnector:r}=this;if(!o)throw new NullGraphError;const a=t.canvasX,l=t.canvasY;s.onClick=()=>this.processSelect(n,t),n.flags.pinned||this.bringToFront(n);const h=n.isPointInCollapse(a,l);if(h)s.onClick=()=>{n.collapse(),this.setDirty(!0,!0)};else if(!n.flags.collapsed){const{inputs:y,outputs:b}=n;if(b)for(const[L,k]of b.entries()){const T=n.getOutputPos(L);if(isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){if(t.shiftKey&&((f=k.links)!=null&&f.length||(g=k._floatingLinks)!=null&&g.size)){r.moveOutputLink(o,k),O(this,G,Ct).call(this);return}r.dragNewFromOutput(o,n,k),O(this,G,Ct).call(this),LiteGraph.shift_click_do_break_link_from?t.shiftKey&&n.disconnectOutput(L):LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey&&n.disconnectOutput(L),s.onDoubleClick=()=>{var S;return(S=n.onOutputDblClick)==null?void 0:S.call(n,L,t)},s.onClick=()=>{var S;return(S=n.onOutputClick)==null?void 0:S.call(n,L,t)};return}}if(y)for(const[L,k]of y.entries()){const T=n.getInputPos(L);if(k instanceof NodeInputSlot?isInRect(a,l,k.boundingRect):isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){s.onDoubleClick=()=>{var A;return(A=n.onInputDblClick)==null?void 0:A.call(n,L,t)},s.onClick=()=>{var A;return(A=n.onInputClick)==null?void 0:A.call(n,L,t)};const N=LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey;(k.link!==null||(m=k._floatingLinks)!=null&&m.size)&&(N||LiteGraph.click_do_break_link_to?n.disconnectInput(L,!0):(t.shiftKey||this.allow_reconnect_links)&&r.moveInputLink(o,k)),r.isConnecting||r.dragNewFromInput(o,n,k),O(this,G,Ct).call(this),this.dirty_bgcanvas=!0;return}}}const c=[a-n.pos[0],l-n.pos[1]],d=n.getWidgetOnPos(a,l);if(d)O(this,G,vi).call(this,t,n,d),this.node_widget=[n,d];else{if(s.onDoubleClick=()=>{var y,b;c[1]<0&&!h?(y=n.onNodeTitleDblClick)==null||y.call(n,t,c,this):n instanceof SubgraphNode&&this.openSubgraph(n.subgraph),(b=n.onDblClick)==null||b.call(n,t,c,this),this.emitEvent({subType:"node-double-click",originalEvent:t,node:n}),this.processNodeDblClicked(n)},(_=n.onMouseDown)!=null&&_.call(n,t,c,this)){s.onClick=()=>{};return}if(!this.allow_dragnodes)return;if(!n.flags.collapsed){const y=n.findResizeDirection(a,l);if(y){s.resizeDirection=y;const b=new Rectangle(n.pos[0],n.pos[1],n.size[0],n.size[1]);s.onDragStart=()=>{o.beforeChange(),this.resizing_node=n},s.onDrag=L=>{if(this.read_only)return;const k=L.canvasX-a,T=L.canvasY-l,S=new Rectangle(b.x,b.y,b.width,b.height);switch(y){case"NE":S.y=b.y+T,S.width=b.width+k,S.height=b.height-T;break;case"SE":S.width=b.width+k,S.height=b.height+T;break;case"SW":S.x=b.x+k,S.width=b.width-k,S.height=b.height+T;break;case"NW":S.x=b.x+k,S.y=b.y+T,S.width=b.width-k,S.height=b.height-T;break}if(I(this,et)){if(y.includes("N")||y.includes("W")){const A=S.x,D=S.y;snapPoint(S.pos,I(this,et)),y.includes("N")&&(S.height+=D-S.y),y.includes("W")&&(S.width+=A-S.x)}snapPoint(S.size,I(this,et))}const N=n.computeSize();S.width<N[0]&&(y.includes("W")&&(S.x=b.x+b.width-N[0]),S.width=N[0]),S.height<N[1]&&(y.includes("N")&&(S.y=b.y+b.height-N[1]),S.height=N[1]),n.pos=S.pos,n.setSize(S.size),O(this,G,ht).call(this)},s.onDragEnd=()=>{O(this,G,ht).call(this),o.afterChange(n)},s.finally=()=>{this.resizing_node=null,s.resizeDirection=void 0},this.canvas.style.cursor=cursors[y];return}}s.onDragStart=y=>O(this,G,Dt).call(this,n,y,!0),s.onDragEnd=y=>O(this,G,Rt).call(this,y)}this.dirty_canvas=!0},vi=function(t,i,n){var c;const{pointer:s}=this;if(typeof n.onPointerDown=="function"&&n.onPointerDown(s,i,this))return;const o=n.value,r=this.graph_mouse,a=r[0]-i.pos[0],l=r[1]-i.pos[1],h=toConcreteWidget(n,i,!1);if(h)s.onClick=()=>h.onClick({e:t,node:i,canvas:this}),s.onDrag=d=>{var f;return(f=h.onDrag)==null?void 0:f.call(h,{e:d,node:i,canvas:this})};else if(n.mouse){const d=n.mouse(t,[a,l],i);d!=null&&(this.dirty_canvas=d)}if(o!=n.value){if((c=i.onWidgetChanged)==null||c.call(i,n.name,n.value,o,n),!i.graph)throw new NullGraphError;i.graph._version++}s.finally=()=>{if(n.mouse){const{eUp:d}=s;if(!d)return;const{canvasX:f,canvasY:g}=d;n.mouse(d,[f-i.pos[0],g-i.pos[1]],i)}this.node_widget=null}},ki=function(t,i){const{pointer:n}=this;if(LiteGraph.middle_click_slot_add_default_node&&i&&this.allow_interaction&&!this.read_only&&!this.connecting_links&&!i.flags.collapsed){let s=!1,o=!1,r=!1;const{inputs:a,outputs:l}=i;if(l)for(const[h,c]of l.entries()){const d=i.getOutputPos(h);if(isInRectangle(t.canvasX,t.canvasY,d[0]-15,d[1]-10,30,20)){s=c,o=h,r=!0;break}}if(a)for(const[h,c]of a.entries()){const d=i.getInputPos(h);if(isInRectangle(t.canvasX,t.canvasY,d[0]-15,d[1]-10,30,20)){s=c,o=h,r=!1;break}}if(s&&o!==!1){const h=.5-(o+1)/(r?l.length:a.length),c=i.getBounding(),d=[r?c[0]+c[2]:c[0],t.canvasY-80];n.onClick=()=>this.createDefaultNodeForSlot({nodeFrom:r?i:null,slotFrom:r?o:null,nodeTo:r?null:i,slotTo:r?null:o,position:d,nodeType:"AUTO",posAdd:[r?30:-30,-h*130],posSizeFix:[r?0:-1,0]})}}this.allow_dragcanvas&&(n.onDragStart=()=>this.dragging_canvas=!0,n.finally=()=>this.dragging_canvas=!1)},Li=function(t){if(!t.buttons){W(this,Tt,null);return}const i=I(this,Tt);if(!i)throw new TypeError("Drag-zoom state object was null");if(!this.graph)throw new NullGraphError;const n=t.y-i.pos[1],o=i.scale-n/100;this.ds.changeScale(o,i.pos),this.graph.change()},Si=function(t){const{graph:i,pointer:n,linkConnector:s}=this;if(!i)throw new NullGraphError;if(n.isDown){if(s.isConnecting){for(const o of I(this,lt))if(o.containsPoint(this.graph_mouse))return s.isRerouteValidDrop(o)&&(s.overReroute=o,this._highlight_pos=o.pos),t|=CanvasItem.RerouteSlot}}else{let o=!1;for(const r of I(this,lt))o||(o=r.updateVisibility(this.graph_mouse)),r.isSlotHovered&&(t|=CanvasItem.RerouteSlot);o&&(this.dirty_bgcanvas=!0)}return this._highlight_pos&&(this._highlight_pos=void 0),s.overReroute&&(s.overReroute=void 0),t},Dt=function(t,i,n=!1){var s;this.emitBeforeChange(),(s=this.graph)==null||s.beforeChange(),i.finally=()=>{var o;this.isDragging=!1,(o=this.graph)==null||o.afterChange(),this.emitAfterChange()},this.processSelect(t,i.eDown,n),this.isDragging=!0},Rt=function(t){var n;const{graph:i}=this;(t.shiftKey||LiteGraph.alwaysSnapToGrid)&&(i==null||i.snapToGrid(this.selectedItems)),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,(n=this.onNodeMoved)==null||n.call(this,findFirstNode(this.selectedItems))},Ii=function(){const t=new CustomEvent("litegraph:no-items-selected",{bubbles:!0});this.canvas.dispatchEvent(t)},Ti=function(t,i){var d;const{graph:n,selectedItems:s,subgraph:o}=this;if(!n)throw new NullGraphError;const r=Math.abs(i[2]),a=Math.abs(i[3]);i[2]<0&&(i[0]-=r),i[3]<0&&(i[1]-=a),i[2]=r,i[3]=a;const l=new Set,h=[];if(o){const{inputNode:f,outputNode:g}=o;overlapBounding(i,f.boundingRect)&&c(f),overlapBounding(i,g.boundingRect)&&c(g)}for(const f of n._nodes)overlapBounding(i,f.boundingRect)&&c(f);for(const f of n.groups)containsRect(i,f._bounding)&&(f.recomputeInsideNodes(),c(f));for(const f of n.reroutes.values())isPointInRect(f.pos,i)&&(s.add(f),f.selected=!0,c(f));if(t.shiftKey)for(const f of h)this.select(f);else if(t.altKey)for(const f of l)this.deselect(f);else{for(const f of s.values())l.has(f)||this.deselect(f);for(const f of h)this.select(f)}(d=this.onSelectionChange)==null||d.call(this,this.selected_nodes);function c(f){!f.selected||!s.has(f)?h.push(f):l.add(f)}},Ei=function(t){for(const i of this.renderedPaths){const n=i._pos;if(n&&isInRectangle(t.canvasX,t.canvasY,n[0]-4,n[1]-4,8,8))return i}},Ni=function(){return LiteGraph.snaps_for_comfy?this.linkConnector.state.snapLinksPos??this._highlight_pos??this.graph_mouse:this.graph_mouse},Oi=function(t,i){var E;const n=!!this.linkConnector.state.snapLinksPos;if(!this._highlight_pos&&!n)return;t.fillStyle="#ffcc00",t.beginPath(),((E=this._highlight_input)==null?void 0:E.shape)===RenderShape.ARROW?(t.moveTo(i[0]+8,i[1]+.5),t.lineTo(i[0]-4,i[1]+6+.5),t.lineTo(i[0]-4,i[1]-6+.5),t.closePath()):t.arc(i[0],i[1],6,0,Math.PI*2),t.fill();const{linkConnector:o}=this,{overReroute:r,overWidget:a}=o;if(!LiteGraph.snap_highlights_node||!o.isConnecting||n)return;r==null||r.drawHighlight(t,"#ffcc00aa");const l=this.node_over;if(!l)return;const{strokeStyle:h,lineWidth:c}=t,d=l.boundingRect,f=3,g=LiteGraph.ROUND_RADIUS+f,m=d[0]-f,_=d[1]-f,y=d[2]+f*2,b=d[3]+f*2;t.beginPath(),t.roundRect(m,_,y,b,g);const L=o.state.connectingTo==="output"?0:1,k=L?-1:1,T=i[0],S=i[1],N=y<b?y:y*Math.max(b/y,.5),A=t.createRadialGradient(T,S,0,T,S,N);A.addColorStop(1,"#00000000"),A.addColorStop(0,"#ffcc00aa");const D=t.createLinearGradient(m,_,m+y,_);if(D.addColorStop(.5,"#00000000"),D.addColorStop(L+.67*k,"#ddeeff33"),D.addColorStop(L+k,"#ffcc0055"),t.setLineDash([g,g*.001]),t.lineWidth=1,t.strokeStyle=D,t.stroke(),a){const{computedHeight:w}=a;t.beginPath();const{pos:[R,M]}=l,U=LiteGraph.NODE_WIDGET_HEIGHT;a.type.startsWith("custom")&&w!=null&&w>U*2?t.rect(R+9,M+a.y+9,(a.width??d[2])-18,w-18):t.roundRect(R+BaseWidget.margin,M+a.y,a.width??d[2],U,U*.5),t.stroke()}t.strokeStyle=A,t.stroke(),t.setLineDash([]),t.lineWidth=c,t.strokeStyle=h},Ci=function(t,i,n,s){var r,a;const{globalAlpha:o}=t;t.globalAlpha=o*.33;for(const l of i.floatingLinks.values()){const h=LLink.getReroutes(i,l),c=h[0],d=h.at(-1);if(!(!c||!(d!=null&&d.floating)))if(d.floating.slotType==="input"){const f=i.getNodeById(l.target_id);if(!f)continue;const g=c.pos,m=f.getInputPos(l.target_slot),_=(r=f.inputs[l.target_slot])==null?void 0:r.dir;c._dragging=!0,O(this,G,$t).call(this,t,l,g,m,n,s,LinkDirection.CENTER,_,!0)}else{const f=i.getNodeById(l.origin_id);if(!f)continue;const g=f.getOutputPos(l.origin_slot),m=d.pos,_=(a=f.outputs[l.origin_slot])==null?void 0:a.dir;l._dragging=!0,O(this,G,$t).call(this,t,l,g,m,n,s,_,LinkDirection.CENTER,!0)}}t.globalAlpha=o},$t=function(t,i,n,s,o,r,a,l,h=!1){var L,k,T;const{graph:c,renderedPaths:d}=this;if(!c)return;const f=LLink.getReroutes(c,i),g=[n,...f.map(S=>S.pos),s],m=g.map(S=>S[0]),_=g.map(S=>S[1]);if(I(C,dt)[0]=Math.min(...m),I(C,dt)[1]=Math.min(..._),I(C,dt)[2]=Math.max(...m)-I(C,dt)[0],I(C,dt)[3]=Math.max(..._)-I(C,dt)[1],!overlapBounding(I(C,dt),I(C,mt)))return;const y=a||LinkDirection.RIGHT,b=l||LinkDirection.LEFT;if(f.length){let S;const N=f.length;for(let D=0;D<N;D++){const E=f[D];if(!d.has(E)){d.add(E),o.push(E),E._colour=i.color||C.link_type_colors[i.type]||this.default_link_color;const w=c.getReroute(E.parentId),R=(w==null?void 0:w.pos)??n;E.calculateAngle(this.last_draw_time,c,R),E._dragging||this.renderLink(t,R,E.pos,i,!1,0,null,S===void 0?y:LinkDirection.CENTER,LinkDirection.CENTER,{startControl:S,endControl:E.controlPoint,reroute:E,disabled:h})}if(!S&&((k=(L=f.at(-1))==null?void 0:L.floating)==null?void 0:k.slotType)==="input")S=[0,0];else{const w=((T=f[D+1])==null?void 0:T.pos)??s,R=Math.min(Reroute.maxSplineOffset,distance(E.pos,w)*.25);S=[R*E.cos,R*E.sin]}}if(i._dragging)return;const A=g.at(-2)??n;this.renderLink(t,A,s,i,!1,0,null,LinkDirection.CENTER,b,{startControl:S,disabled:h})}else i._dragging||this.renderLink(t,n,s,i,!1,0,null,y,b);if(d.add(i),i!=null&&i._last_time&&r-i._last_time<1e3){const S=2-(r-i._last_time)*.002,N=t.globalAlpha;t.globalAlpha=N*S,this.renderLink(t,n,s,i,!0,S,"white",y,b),t.globalAlpha=N}},ye=function(t,i,n,s=.25){switch(i){case LinkDirection.LEFT:t[0]+=n*-s;break;case LinkDirection.RIGHT:t[0]+=n*s;break;case LinkDirection.UP:t[1]+=n*-s;break;case LinkDirection.DOWN:t[1]+=n*s;break}},P(C,ke,new Float32Array(4)),P(C,Le,new Float32Array(2)),P(C,Se,new Float32Array(4)),P(C,mt,new Float32Array(4)),P(C,dt,new Float32Array(4)),P(C,Ie,new Float32Array(2)),P(C,Te,new Float32Array(2)),P(C,Ee,new Float32Array(2)),u(C,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),u(C,"DEFAULT_EVENT_LINK_COLOR","#A86"),u(C,"link_type_colors",{"-1":C.DEFAULT_EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),u(C,"gradients",{}),u(C,"search_limit",-1),u(C,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}}),u(C,"_measureText"),u(C,"active_canvas"),u(C,"active_node");let LGraphCanvas=C;class MapProxyHandler{getOwnPropertyDescriptor(t,i){const n=this.get(t,i);if(n)return{configurable:!0,enumerable:!0,value:n}}has(t,i){if(typeof i=="symbol")return!1;const n=parseInt(i,10);return t.has(isNaN(n)?i:n)}ownKeys(t){return[...t.keys()].map(String)}get(t,i){if(i in t)return Reflect.get(t,i,t);if(typeof i=="symbol")return;const n=parseInt(i,10);return t.get(isNaN(n)?i:n)}set(t,i,n){if(typeof i=="symbol")return!1;const s=parseInt(i,10);return t.set(isNaN(s)?i:s,n),!0}deleteProperty(t,i){return t.delete(i)}static bindAllMethods(t){t.clear=t.clear.bind(t),t.delete=t.delete.bind(t),t.forEach=t.forEach.bind(t),t.get=t.get.bind(t),t.has=t.has.bind(t),t.set=t.set.bind(t),t.entries=t.entries.bind(t),t.keys=t.keys.bind(t),t.values=t.values.bind(t),t[Symbol.iterator]=t[Symbol.iterator].bind(t)}}const Q=class Q{constructor(t){P(this,Oe);u(this,"id",zeroUuid);u(this,"revision",0);u(this,"_version",-1);u(this,"_links",new Map);u(this,"links");u(this,"list_of_graphcanvas");u(this,"status",Q.STATUS_STOPPED);u(this,"state",{lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0});u(this,"events",new CustomEventTarget);u(this,"_subgraphs",new Map);u(this,"_nodes",[]);u(this,"_nodes_by_id",{});u(this,"_nodes_in_order",[]);u(this,"_nodes_executable",null);u(this,"_groups",[]);u(this,"iteration",0);u(this,"globaltime",0);u(this,"runningtime",0);u(this,"fixedtime",0);u(this,"fixedtime_lapse",.01);u(this,"elapsed_time",.01);u(this,"last_update_time",0);u(this,"starttime",0);u(this,"catch_errors",!0);u(this,"execution_timer_id");u(this,"errors_in_execution");u(this,"execution_time");u(this,"_last_trigger_time");u(this,"filter");u(this,"config",{});u(this,"vars",{});u(this,"nodes_executing",[]);u(this,"nodes_actioning",[]);u(this,"nodes_executedAction",[]);u(this,"extra",{});u(this,"version");P(this,Et,0);P(this,Nt,new Map);P(this,Ne,new Map);u(this,"_input_nodes");P(this,le);LiteGraph.debug&&console.log("Graph created");const i=this._links;MapProxyHandler.bindAllMethods(i);const n=new MapProxyHandler;this.links=new Proxy(i,n),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}get empty(){return this._nodes.length+this._groups.length+this.reroutes.size===0}*positionableItems(){for(const t of this._nodes)yield t;for(const t of this._groups)yield t;for(const t of this.reroutes.values())yield t}get floatingLinks(){return I(this,Nt)}get reroutes(){return I(this,Ne)}get rootGraph(){return this}get isRootGraph(){return this.rootGraph===this}get last_node_id(){return this.state.lastNodeId}set last_node_id(t){this.state.lastNodeId=t}get last_link_id(){return this.state.lastLinkId}set last_link_id(t){this.state.lastLinkId=t}clear(){var t;if(this.stop(),this.status=Q.STATUS_STOPPED,this.id=zeroUuid,this.revision=0,this.state={lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0},this._version=-1,this._subgraphs.clear(),this._nodes)for(const i of this._nodes)(t=i.onRemoved)==null||t.call(i);this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._links.clear(),this.reroutes.clear(),I(this,Nt).clear(),W(this,Et,0),this._groups=[],this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.change(),this.canvasAction(i=>i.clear())}get subgraphs(){return this.rootGraph._subgraphs}get nodes(){return this._nodes}get groups(){return this._groups}attachCanvas(t){var i;if(!(t instanceof LGraphCanvas))throw new TypeError("attachCanvas expects an LGraphCanvas instance");this.primaryCanvas=t,this.list_of_graphcanvas??(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.includes(t)||this.list_of_graphcanvas.push(t),t.graph!==this&&((i=t.graph)==null||i.detachCanvas(t),t.graph=this,t.subgraph=void 0)}detachCanvas(t){t.graph=null;const i=this.list_of_graphcanvas;if(i){const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}start(t){var i;if(this.status!=Q.STATUS_RUNNING)if(this.status=Q.STATUS_RUNNING,(i=this.onPlayEvent)==null||i.call(this),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,t||(t=0),t==0&&typeof window<"u"&&window.requestAnimationFrame){const n=()=>{var s,o;this.execution_timer_id==-1&&(window.requestAnimationFrame(n),(s=this.onBeforeStep)==null||s.call(this),this.runStep(1,!this.catch_errors),(o=this.onAfterStep)==null||o.call(this))};this.execution_timer_id=-1,n()}else this.execution_timer_id=setInterval(()=>{var n,s;(n=this.onBeforeStep)==null||n.call(this),this.runStep(1,!this.catch_errors),(s=this.onAfterStep)==null||s.call(this)},t)}stop(){var t;this.status!=Q.STATUS_STOPPED&&(this.status=Q.STATUS_STOPPED,(t=this.onStopEvent)==null||t.call(this),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t,i,n){var l,h,c,d,f,g;t=t||1;const s=LiteGraph.getTime();this.globaltime=.001*(s-this.starttime);const o=this._nodes_executable||this._nodes;if(!o)return;if(n=n||o.length,i){for(let m=0;m<t;m++){for(let _=0;_<n;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&y.onExecute&&((l=y.doExecute)==null||l.call(y))}this.fixedtime+=this.fixedtime_lapse,(h=this.onExecuteStep)==null||h.call(this)}(c=this.onAfterExecute)==null||c.call(this)}else try{for(let m=0;m<t;m++){for(let _=0;_<n;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&((d=y.onExecute)==null||d.call(y))}this.fixedtime+=this.fixedtime_lapse,(f=this.onExecuteStep)==null||f.call(this)}(g=this.onAfterExecute)==null||g.call(this),this.errors_in_execution=!1}catch(m){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw m;LiteGraph.debug&&console.log("Error during execution:",m),this.stop()}const r=LiteGraph.getTime();let a=r-s;a==0&&(a=1),this.execution_time=.001*a,this.globaltime+=.001*a,this.iteration+=1,this.elapsed_time=(r-this.last_update_time)*.001,this.last_update_time=r,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(const t of this._nodes_in_order)t.onExecute&&this._nodes_executable.push(t)}computeExecutionOrder(t,i){const n=[],s=[],o={},r={},a={};for(const h of this._nodes){if(t&&!h.onExecute)continue;o[h.id]=h;let c=0;if(h.inputs)for(const d of h.inputs)(d==null?void 0:d.link)!=null&&(c+=1);c==0?(s.push(h),i&&(h._level=1)):(i&&(h._level=0),a[h.id]=c)}for(;;){const h=s.shift();if(h===void 0)break;if(n.push(h),delete o[h.id],!!h.outputs){for(const c of h.outputs)if(!((c==null?void 0:c.links)==null||c.links.length==0))for(const d of c.links){const f=this._links.get(d);if(!f||r[f.id])continue;const g=this.getNodeById(f.target_id);if(g==null){r[f.id]=!0;continue}i&&(h._level??(h._level=0),(!g._level||g._level<=h._level)&&(g._level=h._level+1)),r[f.id]=!0,a[g.id]-=1,a[g.id]==0&&s.push(g)}}}for(const h in o)n.push(o[h]);n.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");function l(h){const c=h.length;for(let d=0;d<c;++d)h[d].order=d}return l(n),n.sort(function(h,c){const d=h.constructor.priority||h.priority||0,f=c.constructor.priority||c.priority||0;return d==f?h.order-c.order:d-f}),l(n),n}arrange(t,i){t=t||100;const n=this.computeExecutionOrder(!1,!0),s=[];for(const r of n){const a=r._level||1;s[a]||(s[a]=[]),s[a].push(r)}let o=t;for(const r of s){if(!r)continue;let a=100,l=t+LiteGraph.NODE_TITLE_HEIGHT;for(const h of r){h.pos[0]=i==LiteGraph.VERTICAL_LAYOUT?l:o,h.pos[1]=i==LiteGraph.VERTICAL_LAYOUT?o:l;const c=i==LiteGraph.VERTICAL_LAYOUT?1:0;h.size[c]>a&&(a=h.size[c]);const d=i==LiteGraph.VERTICAL_LAYOUT?0:1;l+=h.size[d]+t+LiteGraph.NODE_TITLE_HEIGHT}o+=a+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,i,n){n=n||LGraphEventMode.ALWAYS;const s=this._nodes_in_order||this._nodes;if(s)for(const o of s)!o[t]||o.mode!=n||(i===void 0?o[t]():i&&i.constructor===Array?o[t].apply(o,i):o[t](i))}canvasAction(t){const i=this.list_of_graphcanvas;if(i)for(const n of i)t(n)}sendActionToCanvas(t,i){var s;const{list_of_graphcanvas:n}=this;if(n)for(const o of n)(s=o[t])==null||s.apply(o,i)}add(t,i){var s,o;if(!t)return;const{state:n}=this;if(LiteGraph.alwaysSnapToGrid){const r=this.getSnapToGridSize();r&&t.snapToGrid(r)}if(t instanceof LGraphGroup){(t.id==null||t.id===-1)&&(t.id=++n.lastGroupId),t.id>n.lastGroupId&&(n.lastGroupId=t.id),this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=LiteGraph.use_uuids?LiteGraph.uuidv4():++n.lastNodeId),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++n.lastNodeId:typeof t.id=="number"&&n.lastNodeId<t.id&&(n.lastNodeId=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,(s=t.onAdded)==null||s.call(t,this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),(o=this.onNodeAdded)==null||o.call(this,t),this.setDirtyCanvas(!0),this.change(),t}remove(t){var r,a,l;if(t instanceof LGraphGroup){this.canvasAction(c=>c.deselect(t));const h=this._groups.indexOf(t);h!=-1&&this._groups.splice(h,1),t.graph=void 0,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]==null){console.warn("LiteGraph: node not found",t);return}if(t.ignore_remove){console.warn("LiteGraph: node cannot be removed",t);return}this.beforeChange();const{inputs:i,outputs:n}=t;if(i)for(const[h,c]of i.entries())c.link!=null&&t.disconnectInput(h,!0);if(n)for(const[h,c]of n.entries())(r=c.links)!=null&&r.length&&t.disconnectOutput(h);for(const h of this.floatingLinks.values())(h.origin_id===t.id||h.target_id===t.id)&&this.removeFloatingLink(h);(a=t.onRemoved)==null||a.call(t),t.graph=null,this._version++;const{list_of_graphcanvas:s}=this;if(s)for(const h of s)h.selected_nodes[t.id]&&delete h.selected_nodes[t.id],h.deselect(t);const o=this._nodes.indexOf(t);o!=-1&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],(l=this.onNodeRemoved)==null||l.call(this,t),this.canvasAction(h=>h.checkPanels()),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}getNodeById(t){return t!=null?this._nodes_by_id[t]:null}findNodesByClass(t,i){i=i||[],i.length=0;const{_nodes:n}=this;for(const s of n)s.constructor===t&&i.push(s);return i}findNodesByType(t,i){var o;const n=t.toLowerCase();i=i||[],i.length=0;const{_nodes:s}=this;for(const r of s)((o=r.type)==null?void 0:o.toLowerCase())==n&&i.push(r);return i}findNodeByTitle(t){const{_nodes:i}=this;for(const n of i)if(n.title==t)return n;return null}findNodesByTitle(t){const i=[],{_nodes:n}=this;for(const s of n)s.title==t&&i.push(s);return i}getNodeOnPos(t,i,n){const s=n||this._nodes;let o=s.length;for(;--o>=0;){const r=s[o];if(r.isPointInside(t,i))return r}return null}getGroupOnPos(t,i){return this._groups.toReversed().find(n=>n.isPointInside(t,i))}getGroupTitlebarOnPos(t,i){return this._groups.toReversed().find(n=>n.isPointInTitlebar(t,i))}getRerouteOnPos(t,i,n){for(const s of n??this.reroutes.values())if(s.containsPoint([t,i]))return s}snapToGrid(t){const i=this.getSnapToGridSize();if(i)for(const n of getAllNestedItems(t))n.pinned||n.snapToGrid(i)}getSnapToGridSize(){return LiteGraph.alwaysSnapToGrid?LiteGraph.CANVAS_GRID_SIZE||1:LiteGraph.CANVAS_GRID_SIZE}checkNodeTypes(){const{_nodes:t}=this;for(const[i,n]of t.entries()){const s=LiteGraph.registered_node_types[n.type];if(n.constructor==s)continue;console.log("node being replaced by newer version:",n.type);const o=LiteGraph.createNode(n.type);o&&(t[i]=o,o.configure(n.serialize()),o.graph=this,this._nodes_by_id[o.id]=o,n.inputs&&(o.inputs=[...n.inputs]),n.outputs&&(o.outputs=[...n.outputs]))}this.updateExecutionOrder()}trigger(t,i){var n;(n=this.onTrigger)==null||n.call(this,t,i)}triggerInput(t,i){const n=this.findNodesByTitle(t);for(const s of n)s.onTrigger(i)}setCallback(t,i){const n=this.findNodesByTitle(t);for(const s of n)s.setTrigger(i)}beforeChange(t){var i;(i=this.onBeforeChange)==null||i.call(this,this,t),this.canvasAction(n=>{var s;return(s=n.onBeforeChange)==null?void 0:s.call(n,this)})}afterChange(t){var i;(i=this.onAfterChange)==null||i.call(this,this,t),this.canvasAction(n=>{var s;return(s=n.onAfterChange)==null?void 0:s.call(n,this)})}clearTriggeredSlots(){for(const t of this._links.values())t&&t._last_time&&(t._last_time=0)}change(){var t;LiteGraph.debug&&console.log("Graph changed"),this.canvasAction(i=>i.setDirty(!0,!0)),(t=this.on_change)==null||t.call(this,this)}setDirtyCanvas(t,i){this.canvasAction(n=>n.setDirty(t,i))}addFloatingLink(t){var s,o,r,a;t.id===-1&&(t.id=++ni(this,Et)._),I(this,Nt).set(t.id,t);const i=t.target_id!==-1?(o=(s=this.getNodeById(t.target_id))==null?void 0:s.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i?(i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(t)):console.warn(`Adding invalid floating link: target/slot: [${t.target_id}/${t.target_slot}] origin/slot: [${t.origin_id}/${t.origin_slot}]`);const n=LLink.getReroutes(this,t);for(const l of n)l.floatingLinkIds.add(t.id);return t}removeFloatingLink(t){var s,o,r,a,l;I(this,Nt).delete(t.id);const i=t.target_id!==-1?(o=(s=this.getNodeById(t.target_id))==null?void 0:s.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i&&((l=i._floatingLinks)==null||l.delete(t));const n=LLink.getReroutes(this,t);for(const h of n)h.floatingLinkIds.delete(t.id),h.floatingLinkIds.size===0&&delete h.floating,h.totalLinks===0&&this.removeReroute(h.id)}getLink(t){return t==null?void 0:this._links.get(t)}getReroute(t){return t==null?void 0:this.reroutes.get(t)}setReroute({id:t,parentId:i,pos:n,linkIds:s,floating:o}){t??(t=++this.state.lastRerouteId),t>this.state.lastRerouteId&&(this.state.lastRerouteId=t);const r=this.reroutes.get(t)??new Reroute(t,this);return r.update(i,n,s,o),this.reroutes.set(t,r),r}createReroute(t,i){const n=++this.state.lastRerouteId,s=i instanceof Reroute?i.linkIds:[i.id],o=i instanceof Reroute?i.floatingLinkIds:[i.id],r=new Reroute(n,this,t,i.parentId,s,o);this.reroutes.set(n,r);for(const a of s){const l=this._links.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=n);const h=LLink.getReroutes(this,l);for(const c of h.filter(d=>d.parentId===i.parentId))c.parentId=n}for(const a of o){const l=this.floatingLinks.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=n);const h=LLink.getReroutes(this,l);for(const c of h.filter(d=>d.parentId===i.parentId))c.parentId=n}return r}removeReroute(t){const{reroutes:i}=this,n=i.get(t);if(!n)return;this.canvasAction(a=>a.deselect(n));const{parentId:s,linkIds:o,floatingLinkIds:r}=n;for(const a of i.values())a.parentId===t&&(a.parentId=s);for(const a of o){const l=this._links.get(a);l&&l.parentId===t&&(l.parentId=s)}for(const a of r){const l=this.floatingLinks.get(a);if(!l){console.warn(`Removed reroute had floating link ID that did not exist [${a}]`);continue}const h=LLink.getReroutes(this,l),c=h.at(-1),d=h.at(-2);n===c&&((d==null?void 0:d.totalLinks)!==1?this.removeFloatingLink(l):l.parentId===t&&(l.parentId=s,d.floating=n.floating))}i.delete(t),this.setDirtyCanvas(!1,!0)}removeLink(t){const i=this._links.get(t);if(!i)return;const n=this.getNodeById(i.target_id);n==null||n.disconnectInput(i.target_slot,!1),i.disconnect(this)}createSubgraph(t){const{id:i}=t,n=new Subgraph(this.rootGraph,t);return this.subgraphs.set(i,n),this.rootGraph.events.dispatch("subgraph-created",{subgraph:n,data:t}),n}convertToSubgraph(t){var M,U;if(t.size===0)throw new Error("Cannot convert to subgraph: nothing to convert");const{state:i,revision:n,config:s}=this,{boundaryLinks:o,boundaryFloatingLinks:r,internalLinks:a,boundaryInputLinks:l,boundaryOutputLinks:h}=getBoundaryLinks(this,t),{nodes:c,reroutes:d,groups:f}=splitPositionables(t),g=createBounds(t);if(!g)throw new Error("Failed to create bounding rect for subgraph");const m=l.map(F=>F.resolve(this)),_=h.map(F=>F.resolve(this)),y=multiClone(c),b=a.map(F=>F.asSerialisable()),L=mapSubgraphInputsAndLinks(m,b),k=mapSubgraphOutputsAndLinks(_,b),T={id:createUuidv4(),name:"New Subgraph",inputNode:{id:SUBGRAPH_INPUT_ID,bounding:[0,0,75,100]},outputNode:{id:SUBGRAPH_OUTPUT_ID,bounding:[0,0,75,100]},inputs:L,outputs:k,widgets:[],version:Q.serialisedSchemaVersion,state:i,revision:n,config:s,links:b,nodes:y,reroutes:structuredClone([...d].map(F=>F.asSerialisable())),groups:structuredClone([...f].map(F=>F.serialize()))},S=this.createSubgraph(T);S.configure(T),S.inputNode.arrange(),S.outputNode.arrange();const{boundingRect:N}=S.inputNode,{boundingRect:A}=S.outputNode;alignOutsideContainer(N,Alignment.MidLeft,g,[50,0]),alignOutsideContainer(A,Alignment.MidRight,g,[50,0]);for(const F of m)(M=F.inputNode)==null||M.disconnectInput(F.inputNode.inputs.indexOf(F.input),!0);for(const F of _)(U=F.outputNode)==null||U.disconnectOutput(F.outputNode.outputs.indexOf(F.output),F.inputNode);for(const F of c)this.remove(F);for(const F of d)this.removeReroute(F.id);for(const F of f)this.remove(F);this.rootGraph.events.dispatch("convert-to-subgraph",{subgraph:S,bounds:g,exportedSubgraph:T,boundaryLinks:o,resolvedInputLinks:m,resolvedOutputLinks:_,boundaryFloatingLinks:r,internalLinks:a});const D=LiteGraph.createNode(S.id,S.name,{inputs:structuredClone(L),outputs:structuredClone(k)});if(!D)throw new Error("Failed to create subgraph node");D.setSize(D.computeSize()),alignToContainer(D._posSize,Alignment.Centre|Alignment.Middle,g),this.add(D);const E=groupResolvedByOutput(m);let w=0;for(const[,F]of E.entries()){const[j,...pt]=F,{output:st,outputNode:V,link:K,subgraphInput:ge}=j;if(w++,K.origin_id===SUBGRAPH_INPUT_ID){if(K.target_id=D.id,K.target_slot=w-1,ge instanceof SubgraphInput)ge.connect(D.findInputSlotByType(K.type,!0,!0),D,K.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");console.debug("Reconnect input links in parent graph",{...K},this.links.get(K.id),this.links.get(K.id)===K);for(const _e of pt)_e.link.disconnect(this);continue}if(!st||!V){console.warn("Convert to Subgraph reconnect: Failed to resolve input link",F[0]);continue}const Ot=D.findInputSlotByType(K.type,!0,!0);V.connectSlots(st,D,Ot,K.parentId)}const R=groupResolvedByOutput(_);w=0;for(const[,F]of R.entries()){w++;for(const j of F){const{input:pt,inputNode:st,link:V,subgraphOutput:K}=j;if(V.target_id===SUBGRAPH_OUTPUT_ID){if(V.origin_id=D.id,V.origin_slot=w-1,this.links.set(V.id,V),K instanceof SubgraphOutput)K.connect(D.findOutputSlotByType(V.type,!0,!0),D,V.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");continue}if(!pt||!st){console.warn("Convert to Subgraph reconnect: Failed to resolve output link",j);continue}const ge=D.outputs[w-1];D.connectSlots(ge,st,pt,V.parentId)}}return{subgraph:S,node:D}}resolveSubgraphIdPath(t){const i=[];let n=this.rootGraph;for(const s of t){const o=n.getNodeById(s);if(!o)throw new Error(`Node [${s}] not found.  ID Path: ${t.join(":")}`);if(!o.isSubgraphNode())throw new Error(`Node [${s}] is not a SubgraphNode.  ID Path: ${t.join(":")}`);i.push(o),n=o.subgraph}return i}serialize(t){const{config:i,state:n,groups:s,nodes:o,reroutes:r,extra:a,floatingLinks:l,definitions:h}=this.asSerialisable(t),c=[...this._links.values()],d=c.map(f=>f.serialize());return r!=null&&r.length&&(a.linkExtensions=c.filter(f=>f.parentId!==void 0).map(f=>({id:f.id,parentId:f.parentId}))),a.reroutes=r!=null&&r.length?r:void 0,{id:this.id,revision:this.revision,last_node_id:n.lastNodeId,last_link_id:n.lastLinkId,nodes:o,links:d,floatingLinks:l,groups:s,definitions:h,config:i,extra:a,version:LiteGraph.VERSION}}asSerialisable(t){var m;const{id:i,revision:n,config:s,state:o}=this,a=(!LiteGraph.use_uuids&&(t!=null&&t.sortNodes)?[...this._nodes].sort((_,y)=>_.id-y.id):this._nodes).map(_=>_.serialize()),l=this._groups.map(_=>_.serialize()),h=this._links.size?[...this._links.values()].map(_=>_.asSerialisable()):void 0,c=this.floatingLinks.size?[...this.floatingLinks.values()].map(_=>_.asSerialisable()):void 0,d=this.reroutes.size?[...this.reroutes.values()].map(_=>_.asSerialisable()):void 0,f={...this.extra};LiteGraph.saveViewportWithGraph&&(f.ds=O(this,Oe,Di).call(this)),f.ds||delete f.ds;const g={id:i,revision:n,version:Q.serialisedSchemaVersion,config:s,state:o,groups:l,nodes:a,links:h,floatingLinks:c,reroutes:d,extra:f};if(this.isRootGraph&&this._subgraphs.size){const _=findUsedSubgraphIds(this,this._subgraphs),y=[...this._subgraphs.values()].filter(b=>_.has(b.id)).map(b=>b.asSerialisable());y.length>0&&(g.definitions={subgraphs:y})}return(m=this.onSerialize)==null||m.call(this,g),g}_configureBase(t){const{id:i,extra:n}=t;i?this.id=i:this.id===zeroUuid&&(this.id=createUuidv4()),this.extra=n?structuredClone(n):{},delete this.extra.linkExtensions}configure(t,i){var o,r,a,l,h;const n={data:t,clearGraph:!i};if(this.events.dispatch("configuring",n))try{if(!t)return;n.clearGraph&&this.clear(),this._configureBase(t);let c;if(t.version===.4){const{extra:L}=t;if(Array.isArray(t.links))for(const k of t.links){const T=LLink.createFromArray(k);this._links.set(T.id,T)}if(Array.isArray(L==null?void 0:L.linkExtensions))for(const k of L.linkExtensions){const T=this._links.get(k.id);T&&(T.parentId=k.parentId)}c=L==null?void 0:L.reroutes}else{if(t.state){const{lastGroupId:L,lastLinkId:k,lastNodeId:T,lastRerouteId:S}=t.state,{state:N}=this;L!=null&&(N.lastGroupId=L),k!=null&&(N.lastLinkId=k),T!=null&&(N.lastNodeId=T),S!=null&&(N.lastRerouteId=S)}if(Array.isArray(t.links))for(const L of t.links){const k=LLink.create(L);this._links.set(k.id,k)}c=t.reroutes}if(Array.isArray(c))for(const L of c)this.setReroute(L);const d=t.nodes;for(const L in t)Q.ConfigureProperties.has(L)||(this[L]=t[L]);const f=(o=t.definitions)==null?void 0:o.subgraphs;if(f){for(const L of f)this.createSubgraph(L);for(const L of f)(r=this.subgraphs.get(L.id))==null||r.configure(L)}let g=!1;const m=new Map;if(this._nodes=[],d){for(const L of d){let k=LiteGraph.createNode(String(L.type),L.title);k||(LiteGraph.debug&&console.log("Node not found or has errors:",L.type),k=new LGraphNode(""),k.last_serialization=L,k.has_errors=!0,g=!0),k.id=L.id,this.add(k,!0),m.set(k.id,L)}for(const[L,k]of m)(a=this.getNodeById(L))==null||a.configure(k)}if(Array.isArray(t.floatingLinks))for(const L of t.floatingLinks){const k=LLink.create(L);this.addFloatingLink(k),k.id>I(this,Et)&&W(this,Et,k.id)}for(const L of this.reroutes.values())L.validateLinks(this._links,this.floatingLinks)||this.reroutes.delete(L.id);this._groups.length=0;const _=t.groups;if(_)for(const L of _){const k=new LiteGraph.LGraphGroup;k.configure(L),this.add(k)}this.updateExecutionOrder(),(l=this.onConfigure)==null||l.call(this,t),this._version++;const{primaryCanvas:y}=this,b=(h=y==null?void 0:y.subgraph)==null?void 0:h.id;if(b){const L=this.subgraphs.get(b);L?y.setGraph(L):y.setGraph(this)}return this.setDirtyCanvas(!0,!0),g}finally{this.events.dispatch("configured")}}get primaryCanvas(){return I(this.rootGraph,le)}set primaryCanvas(t){W(this.rootGraph,le,t)}load(t,i){const n=this;if(t instanceof Blob||t instanceof File){const o=new FileReader;o.addEventListener("load",function(r){var h;const a=stringOrEmpty((h=r.target)==null?void 0:h.result),l=JSON.parse(a);n.configure(l),i==null||i()}),o.readAsText(t);return}const s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.addEventListener("load",function(){if(s.status!==200){console.error("Error loading graph:",s.status,s.response);return}const o=JSON.parse(s.response);n.configure(o),i==null||i()}),s.addEventListener("error",o=>{console.error("Error loading graph:",o)})}};Et=new WeakMap,Nt=new WeakMap,Ne=new WeakMap,Oe=new WeakSet,Di=function(){var i,n;const t=(n=(i=this.list_of_graphcanvas)==null?void 0:i.at(0))==null?void 0:n.ds;if(t)return{scale:t.scale,offset:t.offset}},le=new WeakMap,u(Q,"serialisedSchemaVersion",1),u(Q,"STATUS_STOPPED",1),u(Q,"STATUS_RUNNING",2),u(Q,"ConfigureProperties",new Set(["nodes","groups","links","state","reroutes","floatingLinks","id","subgraphs","definitions","inputs","outputs","widgets","inputNode","outputNode","extra"]));let LGraph=Q;const Ce=class Ce extends LGraph{constructor(i,n){if(!i)throw new Error("Root graph is required");super();P(this,ue);u(this,"name","Unnamed Subgraph");u(this,"inputNode",new SubgraphInputNode(this));u(this,"outputNode",new SubgraphOutputNode(this));u(this,"inputs",[]);u(this,"outputs",[]);u(this,"widgets",[]);P(this,he);W(this,he,i);const s=structuredClone(n);this._configureBase(s),O(this,ue,qe).call(this,s)}get rootGraph(){return I(this,he)}getIoNodeOnPos(i,n){const{inputNode:s,outputNode:o}=this;if(s.containsPoint([i,n]))return s;if(o.containsPoint([i,n]))return o}configure(i,n){const s=super.configure(i,n);return O(this,ue,qe).call(this,i),s}attachCanvas(i){super.attachCanvas(i),i.subgraph=this}addInput(i,n){this.events.dispatch("adding-input",{name:i,type:n});const s=new SubgraphInput({id:createUuidv4(),name:i,type:n},this.inputNode);return this.inputs.push(s),this.events.dispatch("input-added",{input:s}),s}addOutput(i,n){this.events.dispatch("adding-output",{name:i,type:n});const s=new SubgraphOutput({id:createUuidv4(),name:i,type:n},this.outputNode);return this.outputs.push(s),this.events.dispatch("output-added",{output:s}),s}renameInput(i,n){const s=this.inputs.indexOf(i);if(s===-1)throw new Error("Input not found");const o=i.displayName;this.events.dispatch("renaming-input",{input:i,index:s,oldName:o,newName:n}),i.label=n}renameOutput(i,n){const s=this.outputs.indexOf(i);if(s===-1)throw new Error("Output not found");const o=i.displayName;this.events.dispatch("renaming-output",{output:i,index:s,oldName:o,newName:n}),i.label=n}removeInput(i){i.disconnect();const n=this.inputs.indexOf(i);if(n===-1)throw new Error("Input not found");if(!this.events.dispatch("removing-input",{input:i,index:n}))return;this.inputs.splice(n,1);const{length:o}=this.inputs;for(let r=n;r<o;r++)this.inputs[r].decrementSlots("inputs")}removeOutput(i){i.disconnect();const n=this.outputs.indexOf(i);if(n===-1)throw new Error("Output not found");if(!this.events.dispatch("removing-output",{output:i,index:n}))return;this.outputs.splice(n,1);const{length:o}=this.outputs;for(let r=n;r<o;r++)this.outputs[r].decrementSlots("outputs")}draw(i,n,s,o){this.inputNode.draw(i,n,s,o),this.outputNode.draw(i,n,s,o)}clone(i=!1){const n=this.asSerialisable();i||(n.id=createUuidv4());const s=new Ce(this.rootGraph,n);return s.configure(n),s}asSerialisable(){return{id:this.id,version:LGraph.serialisedSchemaVersion,state:this.state,revision:this.revision,config:this.config,name:this.name,inputNode:this.inputNode.asSerialisable(),outputNode:this.outputNode.asSerialisable(),inputs:this.inputs.map(i=>i.asSerialisable()),outputs:this.outputs.map(i=>i.asSerialisable()),widgets:[...this.widgets],nodes:this.nodes.map(i=>i.serialize()),groups:this.groups.map(i=>i.serialize()),links:[...this.links.values()].map(i=>i.asSerialisable()),extra:this.extra}}};he=new WeakMap,ue=new WeakSet,qe=function(i){const{name:n,inputs:s,outputs:o,widgets:r}=i;if(this.name=n,s){this.inputs.length=0;for(const a of s){const l=new SubgraphInput(a,this.inputNode);this.inputs.push(l),this.events.dispatch("input-added",{input:l})}}if(o){this.outputs.length=0;for(const a of o)this.outputs.push(new SubgraphOutput(a,this.outputNode))}if(r){this.widgets.length=0;for(const a of r)this.widgets.push(a)}this.inputNode.configure(i.inputNode),this.outputNode.configure(i.outputNode)},u(Ce,"MAX_NESTED_SUBGRAPHS",1e3);let Subgraph=Ce;class InputIndicators{constructor(t){u(this,"radius",8);u(this,"startAngle",0);u(this,"endAngle",Math.PI*2);u(this,"inactiveColour","#ffffff10");u(this,"colour1","#ff5f00");u(this,"colour2","#00ff7c");u(this,"colour3","#dea7ff");u(this,"fontString","bold 12px Arial");u(this,"enabled",!0);u(this,"shiftDown",!1);u(this,"undoDown",!1);u(this,"redoDown",!1);u(this,"ctrlDown",!1);u(this,"altDown",!1);u(this,"mouse0Down",!1);u(this,"mouse1Down",!1);u(this,"mouse2Down",!1);u(this,"x",0);u(this,"y",0);u(this,"controller");P(this,ce,this.onPointerDownOrMove.bind(this));P(this,De,this.onPointerUp.bind(this));P(this,de,this.onKeyDownOrUp.bind(this));this.canvas=t,this.controller=new AbortController;const{signal:i}=this.controller,n=t.canvas,s={capture:!0,signal:i};n.addEventListener("pointerdown",I(this,ce),s),n.addEventListener("pointermove",I(this,ce),s),n.addEventListener("pointerup",I(this,De),s),n.addEventListener("keydown",I(this,de),s),document.addEventListener("keyup",I(this,de),s);const o=t.drawFrontCanvas.bind(t);i.addEventListener("abort",()=>{t.drawFrontCanvas=o}),t.drawFrontCanvas=()=>{o(),this.draw()}}onPointerDownOrMove(t){this.mouse0Down=(t.buttons&1)===1,this.mouse1Down=(t.buttons&4)===4,this.mouse2Down=(t.buttons&2)===2,this.x=t.clientX,this.y=t.clientY,this.canvas.setDirty(!0)}onPointerUp(){this.mouse0Down=!1,this.mouse1Down=!1,this.mouse2Down=!1}onKeyDownOrUp(t){this.ctrlDown=t.ctrlKey,this.altDown=t.altKey,this.shiftDown=t.shiftKey,this.undoDown=t.ctrlKey&&t.code==="KeyZ"&&t.type==="keydown",this.redoDown=t.ctrlKey&&t.code==="KeyY"&&t.type==="keydown"}draw(){const{canvas:{ctx:t},radius:i,startAngle:n,endAngle:s,x:o,y:r,inactiveColour:a,colour1:l,colour2:h,colour3:c,fontString:d}=this,{fillStyle:f,font:g}=t,m=o,_=r-80,y=m,b=_-15;t.font=d,S(y+0,b,"Shift",this.shiftDown?l:a),S(y+45,b+20,"Alt",this.altDown?h:a),S(y+30,b,"Control",this.ctrlDown?c:a),S(y-30,b,"â†©ï¸",this.undoDown?"#000":"transparent"),S(y+45,b,"â†ªï¸",this.redoDown?"#000":"transparent"),t.beginPath(),A(m,_),A(m+15,_),A(m+30,_),t.fillStyle=a,t.fill();const L=this.mouse0Down?l:a,k=this.mouse1Down?h:a,T=this.mouse2Down?c:a;this.mouse0Down&&N(m,_,L),this.mouse1Down&&N(m+15,_,k),this.mouse2Down&&N(m+30,_,T),t.fillStyle=f,t.font=g;function S(D,E,w,R){t.fillStyle=R,t.fillText(w,D,E)}function N(D,E,w){t.beginPath(),t.fillStyle=w,A(D,E),t.fill()}function A(D,E){t.arc(D,E,i,n,s)}}dispose(){var t;(t=this.controller)==null||t.abort(),this.controller=void 0}[Symbol.dispose](){this.dispose()}}ce=new WeakMap,De=new WeakMap,de=new WeakMap;class ContextMenu{constructor(t,i){u(this,"options");u(this,"parentMenu");u(this,"root");u(this,"current_submenu");u(this,"lock");u(this,"controller",new AbortController);var g,m,_;i||(i={}),this.options=i;const n=i.parentMenu;n&&(n instanceof ContextMenu?(this.parentMenu=n,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this):(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=void 0),((g=n.options)==null?void 0:g.className)==="dark"&&(i.className="dark"));const s=i.event?i.event.constructor.name:null;s!=="MouseEvent"&&s!=="CustomEvent"&&s!=="PointerEvent"&&(console.error(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${s})`),i.event=void 0);const o=document.createElement("div");let r="litegraph litecontextmenu litemenubar-panel";i.className&&(r+=` ${i.className}`),o.className=r,o.style.minWidth="100",o.style.minHeight="100";const{signal:a}=this.controller,l={capture:!0,signal:a};if(this.parentMenu||document.addEventListener("pointerdown",y=>{y.target instanceof Node&&!this.containsNode(y.target)&&this.close()},l),o.addEventListener("pointerup",y=>y.preventDefault(),l),o.addEventListener("contextmenu",y=>{y.button===2&&y.preventDefault()},l),o.addEventListener("pointerdown",y=>{y.button==2&&(this.close(),y.preventDefault())},l),this.root=o,i.title){const y=document.createElement("div");y.className="litemenu-title",y.innerHTML=i.title,o.append(y)}for(let y=0;y<t.length;y++){const b=t[y];let L=Array.isArray(t)?b:String(y);typeof L!="string"&&(L=L!=null?L.content===void 0?String(L):L.content:L),this.addItem(L,b,i)}const c=((_=(m=i.event)==null?void 0:m.target)==null?void 0:_.ownerDocument)||document;c.fullscreenElement?c.fullscreenElement.append(o):c.body.append(o);let d=i.left||0,f=i.top||0;if(i.event){if(d=i.event.clientX-10,f=i.event.clientY-10,i.title&&(f-=20),n){const L=n.root.getBoundingClientRect();d=L.left+L.width}const y=document.body.getBoundingClientRect(),b=o.getBoundingClientRect();y.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),y.width&&d>y.width-b.width-10&&(d=y.width-b.width-10),y.height&&f>y.height-b.height-10&&(f=y.height-b.height-10)}o.style.left=`${d}px`,o.style.top=`${f}px`,LiteGraph.context_menu_scaling&&i.scale&&(o.style.transform=`scale(${Math.round(i.scale*4)*.25})`)}containsNode(t,i=new Set){var n;return i.has(this)?!1:(i.add(this),((n=this.current_submenu)==null?void 0:n.containsNode(t,i))||this.root.contains(t))}addItem(t,i,n){n||(n={});const s=document.createElement("div");s.className="litemenu-entry submenu";let o=!1;if(i===null)s.classList.add("separator");else{const c=t===null?"":String(t);typeof i=="string"?s.innerHTML=c:(s.innerHTML=(i==null?void 0:i.title)??c,i.disabled&&(o=!0,s.classList.add("disabled"),s.setAttribute("aria-disabled","true")),(i.submenu||i.has_submenu)&&(s.classList.add("has_submenu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false")),i.className&&(s.className+=` ${i.className}`)),s.value=i,s.setAttribute("role","menuitem"),typeof i=="function"?(s.dataset.value=String(t),s.onclick_callback=i):s.dataset.value=String(i)}this.root.append(s),o||s.addEventListener("click",h),!o&&n.autoopen&&s.addEventListener("pointerenter",a);const r=()=>{const c=this.root.querySelectorAll("div.litemenu-entry.has_submenu");if(c)for(const d of c)d.setAttribute("aria-expanded","false");s.setAttribute("aria-expanded","true")};function a(c){const d=this.value;!d||!d.has_submenu||(h.call(this,c),r())}const l=this;function h(c){var g;const d=this.value;let f=!0;if((g=l.current_submenu)==null||g.close(c),(d!=null&&d.has_submenu||d!=null&&d.submenu)&&r(),n.callback&&n.callback.call(this,d,n,c,l,n.node)===!0&&(f=!1),typeof d=="object"&&(d.callback&&!n.ignore_item_callbacks&&d.disabled!==!0&&d.callback.call(this,d,n,c,l,n.extra)===!0&&(f=!1),d.submenu)){if(!d.submenu.options)throw"ContextMenu submenu needs options";new l.constructor(d.submenu.options,{callback:d.submenu.callback,event:c,parentMenu:l,ignore_item_callbacks:d.submenu.ignore_item_callbacks,title:d.submenu.title,extra:d.submenu.extra,autoopen:n.autoopen}),f=!1}f&&!l.lock&&l.close()}return s}close(t,i){var n;this.controller.abort(),this.root.remove(),this.parentMenu&&!i&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=void 0,t===void 0?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,`${LiteGraph.pointerevents_method}leave`,t)),(n=this.current_submenu)==null||n.close(t,!0)}static trigger(t,i,n){const s=document.createEvent("CustomEvent");return s.initCustomEvent(i,!0,!0,n),t.dispatchEvent&&t.dispatchEvent(s),s}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(t,i){const n=t.clientX,s=t.clientY,o=i.getBoundingClientRect();return o?s>o.top&&s<o.top+o.height&&n>o.left&&n<o.left+o.width:!1}}class CurveEditor{constructor(t){u(this,"points");u(this,"selected");u(this,"nearest");u(this,"size");u(this,"must_update");u(this,"margin");u(this,"_nearest");this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}static sampleCurve(t,i){if(i){for(let n=0;n<i.length-1;++n){const s=i[n],o=i[n+1];if(o[0]<t)continue;const r=o[0]-s[0];if(Math.abs(r)<1e-5)return s[1];const a=(t-s[0])/r;return s[1]*(1-a)+o[1]*a}return 0}}draw(t,i,n,s,o,r=!1){const a=this.points;if(!a)return;this.size=i;const l=i[0]-this.margin*2,h=i[1]-this.margin*2;o=o||"#666",t.save(),t.translate(this.margin,this.margin),s&&(t.fillStyle="#111",t.fillRect(0,0,l,h),t.fillStyle="#222",t.fillRect(l*.5,0,1,h),t.strokeStyle="#333",t.strokeRect(0,0,l,h)),t.strokeStyle=o,r&&(t.globalAlpha=.5),t.beginPath();for(const c of a)t.lineTo(c[0]*l,(1-c[1])*h);if(t.stroke(),t.globalAlpha=1,!r)for(const[c,d]of a.entries())t.fillStyle=this.selected==c?"#FFF":this.nearest==c?"#DDD":"#AAA",t.beginPath(),t.arc(d[0]*l,(1-d[1])*h,2,0,Math.PI*2),t.fill();t.restore()}onMouseDown(t,i){const n=this.points;if(!n||t[1]<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const s=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=t[0]-this.margin,a=t[1]-this.margin,l=[r,a],h=30/i.ds.scale;if(this.selected=this.getCloserPoint(l,h),this.selected==-1){const c=[r/s,1-a/o];n.push(c),n.sort(function(d,f){return d[0]-f[0]}),this.selected=n.indexOf(c),this.must_update=!0}if(this.selected!=-1)return!0}onMouseMove(t,i){const n=this.points;if(!n)return;const s=this.selected;if(s<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const o=(t[0]-this.margin)/(this.size[0]-this.margin*2),r=(t[1]-this.margin)/(this.size[1]-this.margin*2),a=[t[0]-this.margin,t[1]-this.margin],l=30/i.ds.scale;this._nearest=this.getCloserPoint(a,l);const h=n[s];if(h){const c=s==0||s==n.length-1;if(!c&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)){n.splice(s,1),this.selected=-1;return}c?h[0]=s==0?0:1:h[0]=clamp(o,0,1),h[1]=1-clamp(r,0,1),n.sort(function(d,f){return d[0]-f[0]}),this.selected=n.indexOf(h),this.must_update=!0}}onMouseUp(){return this.selected=-1,!1}getCloserPoint(t,i){const n=this.points;if(!n)return-1;if(i=i||30,this.size==null)throw new Error("CurveEditor.size was null or undefined.");const s=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=n.length,a=[0,0];let l=1e6,h=-1;for(let c=0;c<r;++c){const d=n[c];a[0]=d[0]*s,a[1]=(1-d[1])*o;const f=distance(t,a);f>l||f>i||(h=c,l=f)}return h}}class LiteGraphGlobal{constructor(){u(this,"SlotShape",SlotShape);u(this,"SlotDirection",SlotDirection);u(this,"SlotType",SlotType);u(this,"LabelPosition",LabelPosition);u(this,"VERSION",.4);u(this,"CANVAS_GRID_SIZE",10);u(this,"NODE_TITLE_HEIGHT",30);u(this,"NODE_TITLE_TEXT_Y",20);u(this,"NODE_SLOT_HEIGHT",20);u(this,"NODE_WIDGET_HEIGHT",20);u(this,"NODE_WIDTH",140);u(this,"NODE_MIN_WIDTH",50);u(this,"NODE_COLLAPSED_RADIUS",10);u(this,"NODE_COLLAPSED_WIDTH",80);u(this,"NODE_TITLE_COLOR","#999");u(this,"NODE_SELECTED_TITLE_COLOR","#FFF");u(this,"NODE_TEXT_SIZE",14);u(this,"NODE_TEXT_COLOR","#AAA");u(this,"NODE_TEXT_HIGHLIGHT_COLOR","#EEE");u(this,"NODE_SUBTEXT_SIZE",12);u(this,"NODE_DEFAULT_COLOR","#333");u(this,"NODE_DEFAULT_BGCOLOR","#353535");u(this,"NODE_DEFAULT_BOXCOLOR","#666");u(this,"NODE_DEFAULT_SHAPE",RenderShape.ROUND);u(this,"NODE_BOX_OUTLINE_COLOR","#FFF");u(this,"NODE_ERROR_COLOUR","#E00");u(this,"NODE_FONT","Arial");u(this,"DEFAULT_FONT","Arial");u(this,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)");u(this,"DEFAULT_GROUP_FONT",24);u(this,"DEFAULT_GROUP_FONT_SIZE");u(this,"GROUP_FONT","Arial");u(this,"WIDGET_BGCOLOR","#222");u(this,"WIDGET_OUTLINE_COLOR","#666");u(this,"WIDGET_ADVANCED_OUTLINE_COLOR","rgba(56, 139, 253, 0.8)");u(this,"WIDGET_TEXT_COLOR","#DDD");u(this,"WIDGET_SECONDARY_TEXT_COLOR","#999");u(this,"WIDGET_DISABLED_TEXT_COLOR","#666");u(this,"LINK_COLOR","#9A9");u(this,"EVENT_LINK_COLOR","#A86");u(this,"CONNECTING_LINK_COLOR","#AFA");u(this,"MAX_NUMBER_OF_NODES",1e4);u(this,"DEFAULT_POSITION",[100,100]);u(this,"VALID_SHAPES",["default","box","round","card"]);u(this,"ROUND_RADIUS",8);u(this,"BOX_SHAPE",RenderShape.BOX);u(this,"ROUND_SHAPE",RenderShape.ROUND);u(this,"CIRCLE_SHAPE",RenderShape.CIRCLE);u(this,"CARD_SHAPE",RenderShape.CARD);u(this,"ARROW_SHAPE",RenderShape.ARROW);u(this,"GRID_SHAPE",RenderShape.GRID);u(this,"INPUT",NodeSlotType.INPUT);u(this,"OUTPUT",NodeSlotType.OUTPUT);u(this,"EVENT",-1);u(this,"ACTION",-1);u(this,"NODE_MODES",["Always","On Event","Never","On Trigger"]);u(this,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]);u(this,"ALWAYS",LGraphEventMode.ALWAYS);u(this,"ON_EVENT",LGraphEventMode.ON_EVENT);u(this,"NEVER",LGraphEventMode.NEVER);u(this,"ON_TRIGGER",LGraphEventMode.ON_TRIGGER);u(this,"UP",LinkDirection.UP);u(this,"DOWN",LinkDirection.DOWN);u(this,"LEFT",LinkDirection.LEFT);u(this,"RIGHT",LinkDirection.RIGHT);u(this,"CENTER",LinkDirection.CENTER);u(this,"LINK_RENDER_MODES",["Straight","Linear","Spline"]);u(this,"HIDDEN_LINK",LinkRenderType.HIDDEN_LINK);u(this,"STRAIGHT_LINK",LinkRenderType.STRAIGHT_LINK);u(this,"LINEAR_LINK",LinkRenderType.LINEAR_LINK);u(this,"SPLINE_LINK",LinkRenderType.SPLINE_LINK);u(this,"NORMAL_TITLE",TitleMode.NORMAL_TITLE);u(this,"NO_TITLE",TitleMode.NO_TITLE);u(this,"TRANSPARENT_TITLE",TitleMode.TRANSPARENT_TITLE);u(this,"AUTOHIDE_TITLE",TitleMode.AUTOHIDE_TITLE);u(this,"VERTICAL_LAYOUT","vertical");u(this,"proxy",null);u(this,"node_images_path","");u(this,"debug",!1);u(this,"catch_exceptions",!0);u(this,"throw_errors",!0);u(this,"allow_scripts",!1);u(this,"registered_node_types",{});u(this,"node_types_by_file_extension",{});u(this,"Nodes",{});u(this,"Globals",{});u(this,"searchbox_extras",{});u(this,"node_box_coloured_when_on",!1);u(this,"node_box_coloured_by_mode",!1);u(this,"dialog_close_on_mouse_leave",!1);u(this,"dialog_close_on_mouse_leave_delay",500);u(this,"shift_click_do_break_link_from",!1);u(this,"click_do_break_link_to",!1);u(this,"ctrl_alt_click_do_break_link",!0);u(this,"snaps_for_comfy",!0);u(this,"snap_highlights_node",!0);u(this,"alwaysSnapToGrid");u(this,"snapToGrid");u(this,"search_hide_on_mouse_leave",!0);u(this,"search_filter_enabled",!1);u(this,"search_show_all_on_open",!0);u(this,"auto_load_slot_types",!1);u(this,"registered_slot_in_types",{});u(this,"registered_slot_out_types",{});u(this,"slot_types_in",[]);u(this,"slot_types_out",[]);u(this,"slot_types_default_in",{});u(this,"slot_types_default_out",{});u(this,"alt_drag_do_clone_nodes",!1);u(this,"do_add_triggers_slots",!1);u(this,"allow_multi_output_for_events",!0);u(this,"middle_click_slot_add_default_node",!1);u(this,"release_link_on_empty_shows_menu",!1);u(this,"pointerevents_method","pointer");u(this,"ctrl_shift_v_paste_connect_unselected_outputs",!0);u(this,"use_uuids",!1);u(this,"highlight_selected_group",!0);u(this,"context_menu_scaling",!1);u(this,"alwaysRepeatWarnings",!1);u(this,"onDeprecationWarning",[console.warn]);u(this,"macTrackpadGestures",!1);u(this,"macGesturesRequireMac",!0);u(this,"canvasNavigationMode","legacy");u(this,"truncateWidgetTextEvenly",!1);u(this,"truncateWidgetValuesFirst",!1);u(this,"saveViewportWithGraph",!0);u(this,"LGraph",LGraph);u(this,"LLink",LLink);u(this,"LGraphNode",LGraphNode);u(this,"LGraphGroup",LGraphGroup);u(this,"DragAndScale",DragAndScale);u(this,"LGraphCanvas",LGraphCanvas);u(this,"ContextMenu",ContextMenu);u(this,"CurveEditor",CurveEditor);u(this,"Reroute",Reroute);u(this,"Classes",{get SubgraphSlot(){return SubgraphSlot},get SubgraphIONodeBase(){return SubgraphIONodeBase},get Rectangle(){return Rectangle},get InputIndicators(){return InputIndicators}});u(this,"uuidv4",createUuidv4);u(this,"distance",distance);u(this,"isInsideRectangle",isInsideRectangle);u(this,"overlapBounding",overlapBounding);Object.defineProperty(this,"Classes",{writable:!1})}registerNodeType(t,i){var r,a,l;if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,this.debug&&console.log("Node registered:",t);const n=i.name,s=t.lastIndexOf("/");i.category=t.substring(0,s),i.title||(i.title=n);for(const h in LGraphNode.prototype)(r=i.prototype)[h]||(r[h]=LGraphNode.prototype[h]);const o=this.registered_node_types[t];o&&this.debug&&console.log("replacing node type:",t),this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[n]=i),(a=this.onNodeTypeRegistered)==null||a.call(this,t,i),o&&((l=this.onNodeTypeReplaced)==null||l.call(this,t,i,o)),i.prototype.onPropertyChange&&console.warn(`LiteGraph node class ${t} has onPropertyChange method, it must be called onPropertyChanged with d at the end`),this.auto_load_slot_types&&new i(i.title||"tmpnode")}unregisterNodeType(t){const i=typeof t=="string"?this.registered_node_types[t]:t;if(!i)throw`node type not found: ${String(t)}`;delete this.registered_node_types[String(i.type)];const n=i.constructor.name;n&&delete this.Nodes[n]}registerNodeAndSlotType(t,i,n){n||(n=!1);const o=(typeof t=="string"&&this.registered_node_types[t]!=="anonymous"?this.registered_node_types[t]:t).constructor.type;let r=[];typeof i=="string"?r=i.split(","):i==this.EVENT||i==this.ACTION?r=["_event_"]:r=["*"];for(let a of r){a===""&&(a="*");const l=n?this.registered_slot_out_types:this.registered_slot_in_types;l[a]??(l[a]={nodes:[]});const{nodes:h}=l[a];h.includes(o)||h.push(o);const c=n?this.slot_types_out:this.slot_types_in,d=a.toLowerCase();c.includes(d)||(c.push(d),c.sort())}}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}createNode(t,i,n){var r;const s=this.registered_node_types[t];if(!s)return this.debug&&console.log(`GraphNode type "${t}" not registered.`),null;i=i||s.title||t;let o=null;if(this.catch_exceptions)try{o=new s(i)}catch(a){return console.error(a),null}else o=new s(i);if(o.type=t,!o.title&&i&&(o.title=i),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=[this.DEFAULT_POSITION[0],this.DEFAULT_POSITION[1]]),o.mode||(o.mode=LGraphEventMode.ALWAYS),n)for(const a in n)o[a]=n[a];return(r=o.onNodeCreated)==null||r.call(o),o}getNodeType(t){return this.registered_node_types[t]}getNodeTypesInCategory(t,i){const n=[];for(const s in this.registered_node_types){const o=this.registered_node_types[s];o.filter==i&&(t==""?o.category==null&&n.push(o):o.category==t&&n.push(o))}return n}getNodeTypesCategories(t){const i={"":1};for(const s in this.registered_node_types){const o=this.registered_node_types[s];if(o.category&&!o.skip_list){if(o.filter!=t)continue;i[o.category]=1}}const n=[];for(const s in i)n.push(s);return n}reloadNodes(t){const i=document.getElementsByTagName("script"),n=[];for(const o of i)n.push(o);const s=document.getElementsByTagName("head")[0];t=document.location.href+t;for(const o of n){const r=o.src;if(!(!r||r.substr(0,t.length)!=t))try{this.debug&&console.log("Reloading:",r);const a=document.createElement("script");a.type="text/javascript",a.src=r,s.append(a),o.remove()}catch(a){if(this.throw_errors)throw a;this.debug&&console.log("Error while reloading",r)}}this.debug&&console.log("Nodes reloaded")}cloneObject(t,i){if(t==null)return null;const n=JSON.parse(JSON.stringify(t));if(!i)return n;for(const s in n)i[s]=n[s];return i}isValidConnection(t,i){if((t==""||t==="*")&&(t=0),(i==""||i==="*")&&(i=0),!t||!i||t==i||t==this.EVENT&&i==this.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),!t.includes(",")&&!i.includes(","))return t==i;const n=t.split(","),s=i.split(",");for(const o of n)for(const r of s)if(this.isValidConnection(o,r))return!0;return!1}getParameterNames(t){return String(t).replaceAll(/\/\/.*$/gm,"").replaceAll(/\s+/g,"").replaceAll(/\/\*[^*/]*\*\//g,"").split("){",1)[0].replace(/^[^(]*\(/,"").replaceAll(/=[^,]+/g,"").split(",").filter(Boolean)}pointerListenerAdd(t,i,n,s=!1){if(!t||!t.addEventListener||!i||typeof n!="function")return;let o=this.pointerevents_method,r=i;if(o=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log(`Converting pointer[${r}] : down move up cancel enter TO touchstart touchmove touchend, etc ..`),r){case"down":{o="touch",r="start";break}case"move":{o="touch";break}case"up":{o="touch",r="end";break}case"cancel":{o="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn(`PointerEvent not available in this browser ? The event ${r} would not be called`)}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+r,n,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(o!="mouse")return t.addEventListener(o+r,n,s);default:return t.addEventListener(r,n,s)}}pointerListenerRemove(t,i,n,s=!1){if(!(!t||!t.removeEventListener||!i||typeof n!="function"))switch(i){case"down":case"up":case"move":case"over":case"out":case"enter":(this.pointerevents_method=="pointer"||this.pointerevents_method=="mouse")&&t.removeEventListener(this.pointerevents_method+i,n,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(this.pointerevents_method=="pointer")return t.removeEventListener(this.pointerevents_method+i,n,s);default:return t.removeEventListener(i,n,s)}}getTime(){return performance.now()}colorToString(t){return`rgba(${Math.round(t[0]*255).toFixed()},${Math.round(t[1]*255).toFixed()},${Math.round(t[2]*255).toFixed()},${t.length==4?t[3].toFixed(2):"1.0"})`}growBounding(t,i,n){i<t[0]?t[0]=i:i>t[2]&&(t[2]=i),n<t[1]?t[1]=n:n>t[3]&&(t[3]=n)}isInsideBounding(t,i){return!(t[0]<i[0][0]||t[1]<i[0][1]||t[0]>i[1][0]||t[1]>i[1][1])}hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();const i="0123456789ABCDEF",n=new Array(3);let s=0,o,r;for(let a=0;a<6;a+=2)o=i.indexOf(t.charAt(a)),r=i.indexOf(t.charAt(a+1)),n[s]=o*16+r,s++;return n}num2hex(t){const i="0123456789ABCDEF";let n="#",s,o;for(let r=0;r<3;r++)s=t[r]/16,o=t[r]%16,n+=i.charAt(s)+i.charAt(o);return n}closeAllContextMenus(t=window){const i=[...t.document.querySelectorAll(".litecontextmenu")];if(i.length)for(const n of i)"close"in n&&typeof n.close=="function"?n.close():n.remove()}extendClass(t,i){for(const n in i)t.hasOwnProperty(n)||(t[n]=i[n]);if(i.prototype)for(const n in i.prototype)i.prototype.hasOwnProperty(n)&&(t.prototype.hasOwnProperty(n)||(i.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,i.prototype.__lookupGetter__(n)):t.prototype[n]=i.prototype[n],i.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,i.prototype.__lookupSetter__(n))))}}Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("Symbol.asyncDispose"));function loadPolyfills(){typeof window<"u"&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(p,t,i,n,s,o){let r=0,a=0,l=0,h=0;if(s===0){this.rect(p,t,i,n);return}if(o===void 0&&(o=s),Array.isArray(s))if(s.length==1)r=a=l=h=s[0];else if(s.length==2)r=h=s[0],a=l=s[1];else if(s.length==4)r=s[0],a=s[1],l=s[2],h=s[3];else return;else{r=s||0,a=s||0;const c=!Array.isArray(o)&&o?o:0;l=c,h=c}this.moveTo(p+r,t),this.lineTo(p+i-a,t),this.quadraticCurveTo(p+i,t,p+i,t+a),this.lineTo(p+i,t+n-h),this.quadraticCurveTo(p+i,t+n,p+i-h,t+n),this.lineTo(p+h,t+n),this.quadraticCurveTo(p,t+n,p,t+n-l),this.lineTo(p,t+l),this.quadraticCurveTo(p,t,p+r,t)}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(p){window.setTimeout(p,1e3/60)})}class InvalidLinkError extends Error{constructor(t="Attempted to access a link that was invalid.",i){super(t,{cause:i}),this.name="InvalidLinkError"}}class RecursionError extends Error{constructor(t){super(t),this.name="RecursionError"}}class SlotIndexError extends Error{constructor(t="Attempted to access a slot that was out of bounds.",i){super(t,{cause:i}),this.name="SlotIndexError"}}class ExecutableNodeDTO{constructor(t,i,n,s){P(this,Re);u(this,"graph");u(this,"inputs");P(this,pe);if(this.node=t,this.subgraphNodePath=i,this.nodesByExecutionId=n,this.subgraphNode=s,!t.graph)throw new NullGraphError;W(this,pe,[...this.subgraphNodePath,this.node.id].join(":")),this.graph=t.graph,this.inputs=this.node.inputs.map(o=>({linkId:o.link,name:o.name,type:o.type})),this.node.applyToGraph&&(this.applyToGraph=(...o)=>{var r,a;return(a=(r=this.node).applyToGraph)==null?void 0:a.call(r,...o)})}get id(){return I(this,pe)}get type(){return this.node.type}get title(){return this.node.title}get mode(){return this.node.mode}get comfyClass(){return this.node.comfyClass}get isVirtualNode(){return this.node.isVirtualNode}get widgets(){return this.node.widgets}get subgraphId(){var t;return(t=this.subgraphNode)==null?void 0:t.subgraph.id}getInnerNodes(){return this.node.isSubgraphNode()?this.node.getInnerNodes(this.nodesByExecutionId,this.subgraphNodePath):[this]}resolveInput(t,i=new Set){var c;const n=`${(c=this.subgraphNode)==null?void 0:c.subgraph.id}:${this.node.id}[I]${t}`;if(i.has(n)){const d=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,f=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving input ${t} of node ${d}${f}. This creates an infinite loop in link resolution. UniqueID: [${n}]`)}i.add(n);const s=this.inputs.at(t);if(!s)throw new SlotIndexError(`No input found for flattened id [${this.id}] slot [${t}]`);if(s.linkId==null)return;const o=this.graph.getLink(s.linkId);if(!o)throw new InvalidLinkError(`No link found in parent graph for id [${this.id}] slot [${t}] ${s.name}`);const{subgraphNode:r}=this;if(r&&o.originIsIoNode){const d=r.inputs.at(o.origin_slot);if(!d)throw new SlotIndexError(`No input found for slot [${o.origin_slot}] ${s.name}`);const f=d.link;if(f==null){const y=r.getWidgetFromSlot(d);return y?{node:this,origin_id:this.id,origin_slot:-1,widgetInfo:{value:y.value}}:void 0}const g=r.graph.getLink(f);if(!g)throw new InvalidLinkError(`No outer link found for slot [${o.origin_slot}] ${s.name}`);const m=this.subgraphNodePath.join(":"),_=this.nodesByExecutionId.get(m);if(!_)throw new Error(`No subgraph node DTO found for id [${m}]`);return _.resolveInput(g.target_slot,i)}const a=this.graph.getNodeById(o.origin_id);if(!a)throw new InvalidLinkError(`No input node found for id [${this.id}] slot [${t}] ${s.name}`);const l=[...this.subgraphNodePath,a.id].join(":"),h=this.nodesByExecutionId.get(l);if(!h)throw new Error(`No output node DTO found for id [${l}]`);return h.resolveOutput(o.origin_slot,s.type,i)}resolveOutput(t,i,n){var r;const s=`${(r=this.subgraphNode)==null?void 0:r.subgraph.id}:${this.node.id}[O]${t}`;if(n.has(s)){const a=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,l=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving output ${t} of node ${a}${l}. This creates an infinite loop in link resolution. UniqueID: [${s}]`)}if(n.add(s),this.mode===LGraphEventMode.BYPASS){const{inputs:a}=this,l=Object.keys(a).map(Number),c=[t,...l].find(d=>{var f;return((f=a[d])==null?void 0:f.type)===i});if(c===void 0){console.debug(`[ExecutableNodeDTO.resolveOutput] No input types match type [${i}] for id [${this.id}] slot [${t}]`,this);return}return this.resolveInput(c,n)}const{node:o}=this;if(o.isSubgraphNode())return O(this,Re,Ri).call(this,t,i,n);if(o.isVirtualNode){if(this.inputs.at(t))return this.resolveInput(t,n);const a=this.node.getInputLink(t);if(a){const l=this.graph.getNodeById(a.origin_id);if(!l)throw new InvalidLinkError(`Virtual node failed to resolve parent [${this.id}] slot [${t}]`);const h=[...this.subgraphNodePath,l.id].join(":"),c=this.nodesByExecutionId.get(h);if(!c)throw new Error(`No output node DTO found for id [${l.id}]`);return c.resolveOutput(a.origin_slot,i,n)}return}return{node:this,origin_id:this.id,origin_slot:t}}}pe=new WeakMap,Re=new WeakSet,Ri=function(t,i,n){const{node:s}=this,o=s.outputs.at(t);if(!o)throw new SlotIndexError(`No output found for flattened id [${this.id}] slot [${t}]`);if(!s.isSubgraphNode())throw new TypeError(`Node is not a subgraph node: ${s.id}`);const r=s.resolveSubgraphOutputLink(t);if(!r)return;const a=r.outputNode;if(!a)throw new Error(`No output node found for id [${this.id}] slot [${t}] ${o.name}`);const l=[...this.subgraphNodePath,s.id,a.id].join(":"),h=this.nodesByExecutionId.get(l);if(!h)throw new Error(`No inner node DTO found for id [${l}]`);return h.resolveOutput(r.link.origin_slot,i,n)};class SubgraphNode extends LGraphNode{constructor(i,n,s){super(n.name,n.id);P(this,bt);u(this,"type");u(this,"isVirtualNode",!0);u(this,"widgets",[]);P(this,fe,new AbortController);this.graph=i,this.subgraph=n;const o=this.subgraph.events,{signal:r}=I(this,fe);o.addEventListener("input-added",a=>{const l=a.detail.input,{name:h,type:c}=l;if(this.inputs.some(f=>f.name==h))return;const d=this.addInput(h,c);O(this,bt,Ze).call(this,l,d)},{signal:r}),o.addEventListener("removing-input",a=>{const l=a.detail.input._widget;l&&this.ensureWidgetRemoved(l),this.removeInput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("output-added",a=>{const{name:l,type:h}=a.detail.output;this.addOutput(l,h)},{signal:r}),o.addEventListener("removing-output",a=>{this.removeOutput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("renaming-input",a=>{const{index:l,newName:h}=a.detail,c=this.inputs.at(l);if(!c)throw new Error("Subgraph input not found");c.label=h},{signal:r}),o.addEventListener("renaming-output",a=>{const{index:l,newName:h}=a.detail,c=this.outputs.at(l);if(!c)throw new Error("Subgraph output not found");c.label=h},{signal:r}),this.type=n.id,this.configure(s),this.addTitleButton({name:"enter_subgraph",text:"î¤»",yOffset:0,xOffset:-10,fontSize:16})}get rootGraph(){return this.graph.rootGraph}get displayType(){return"Subgraph node"}isSubgraphNode(){return!0}onTitleButtonClick(i,n){i.name==="enter_subgraph"?n.openSubgraph(this.subgraph):super.onTitleButtonClick(i,n)}configure(i){var n;for(const s of this.inputs)(n=s._listenerController)==null||n.abort();this.inputs.length=0,this.inputs.push(...this.subgraph.inputNode.slots.map(s=>new NodeInputSlot({name:s.name,localized_name:s.localized_name,label:s.label,type:s.type,link:null},this))),this.outputs.length=0,this.outputs.push(...this.subgraph.outputNode.slots.map(s=>new NodeOutputSlot({name:s.name,localized_name:s.localized_name,label:s.label,type:s.type,links:null},this))),super.configure(i)}_internalConfigureAfterSlots(){this.widgets.length=0;for(const i of this.inputs){const n=this.subgraph.inputNode.slots.find(s=>s.name===i.name);if(!n)throw new Error(`[SubgraphNode.configure] No subgraph input found for input ${i.name}`);O(this,bt,Ze).call(this,n,i);for(const s of n.linkIds){const o=this.subgraph.getLink(s);if(!o){console.warn(`[SubgraphNode.configure] No link found for link ID ${s}`,this);continue}const r=o.resolve(this.subgraph);if(!r.input||!r.inputNode){console.warn("Invalid resolved link",r,this);continue}const a=r.inputNode.getWidgetFromSlot(r.input);if(a){O(this,bt,Je).call(this,n,i,a);break}}}}addInput(i,n,s={}){return super.addInput(i,n,s)}getInputLink(i){const n=this.subgraph.outputNode.slots[i].getLinks().at(0);if(!n)return console.warn(`SubgraphNode.getInputLink: no inner link found for slot ${i}`),null;const s=LLink.create(n);return s.origin_id=`${this.id}:${n.origin_id}`,s.origin_slot=n.origin_slot,s}resolveSubgraphInputLinks(i){const n=this.subgraph.inputNode.slots[i],s=n.getLinks();return s.length===0?(console.debug(`[SubgraphNode.resolveSubgraphInputLinks] No inner links found for input slot [${i}] ${n.name}`,this),[]):s.map(o=>o.resolve(this.subgraph))}resolveSubgraphOutputLink(i){const n=this.subgraph.outputNode.slots[i],s=n.getLinks().at(0);if(s)return s.resolve(this.subgraph);console.debug(`[SubgraphNode.resolveSubgraphOutputLink] No inner link found for output slot [${i}] ${n.name}`,this)}getInnerNodes(i,n=[],s=[],o=new Set){if(o.has(this)){const h=`${this.id}${this.title?` (${this.title})`:""}`,c=`'${this.subgraph.name||"Unnamed Subgraph"}'`,d=n.length;throw new RecursionError(`Circular reference detected at depth ${d} in node ${h} of subgraph ${c}. This creates an infinite loop in the subgraph hierarchy.`)}o.add(this);const r=[...n,this.id],a=this.graph.rootGraph.resolveSubgraphIdPath(n).at(-1),l=new ExecutableNodeDTO(this,n,i,a);i.set(l.id,l);for(const h of this.subgraph.nodes)if("getInnerNodes"in h)h.getInnerNodes(i,r,s,new Set(o));else{const c=new ExecutableNodeDTO(h,r,i,this);i.set(c.id,c),s.push(c)}return s}removeWidgetByName(i){const n=this.widgets.find(s=>s.name===i);n&&this.subgraph.events.dispatch("widget-demoted",{widget:n,subgraphNode:this}),super.removeWidgetByName(i)}ensureWidgetRemoved(i){this.widgets.includes(i)&&this.subgraph.events.dispatch("widget-demoted",{widget:i,subgraphNode:this}),super.ensureWidgetRemoved(i)}onRemoved(){var i;I(this,fe).abort();for(const n of this.widgets)this.subgraph.events.dispatch("widget-demoted",{widget:n,subgraphNode:this});for(const n of this.inputs)(i=n._listenerController)==null||i.abort()}}fe=new WeakMap,bt=new WeakSet,Ze=function(i,n){var o;(o=n._listenerController)==null||o.abort(),n._listenerController=new AbortController;const{signal:s}=n._listenerController;i.events.addEventListener("input-connected",()=>{if(n._widget)return;const r=i._widget;r&&O(this,bt,Je).call(this,i,n,r)},{signal:s}),i.events.addEventListener("input-disconnected",()=>{i.getConnectedWidgets().length>0||(this.removeWidgetByName(n.name),delete n.pos,delete n.widget,n._widget=void 0)},{signal:s})},Je=function(i,n,s){const o=toConcreteWidget(s,this).createCopyForNode(this);Object.assign(o,{get name(){return i.name},set name(r){console.warn("Promoted widget: setting name is not allowed",this,r)},get localized_name(){return i.localized_name},set localized_name(r){console.warn("Promoted widget: setting localized_name is not allowed",this,r)},get label(){return i.label},set label(r){console.warn("Promoted widget: setting label is not allowed",this,r)},get tooltip(){return s.tooltip},set tooltip(r){console.warn("Promoted widget: setting tooltip is not allowed",this,r)}}),this.widgets.push(o),this.subgraph.events.dispatch("widget-promoted",{widget:o,subgraphNode:this}),n.widget={name:i.name},n._widget=o};const LiteGraph=new LiteGraphGlobal;loadPolyfills();const litegraphCss=".lgraphcanvas{user-select:none;-moz-user-select:none;-webkit-user-select:none;outline:none;font-family:Tahoma,sans-serif}.lgraphcanvas *{box-sizing:border-box}.litegraph.litecontextmenu{font-family:Tahoma,sans-serif;position:fixed;top:100px;left:100px;min-width:100px;color:#aaf;padding:0;box-shadow:0 0 10px #000!important;background-color:#2e2e2e!important;z-index:10;max-height:-webkit-fill-available;overflow-y:auto}@supports not (max-height: -webkit-fill-available){.litegraph.litecontextmenu{max-height:80vh;overflow-y:scroll}}.litegraph.litecontextmenu.dark{background-color:#000!important}.litegraph.litecontextmenu .litemenu-title img{margin-top:2px;margin-left:2px;margin-right:4px}.litegraph.litecontextmenu .litemenu-entry{margin:2px;padding:2px}.litegraph.litecontextmenu .litemenu-entry.submenu{background-color:#2e2e2e!important}.litegraph.litecontextmenu.dark .litemenu-entry.submenu{background-color:#000!important}.litegraph .litemenubar ul{font-family:Tahoma,sans-serif;margin:0;padding:0}.litegraph .litemenubar li{font-size:14px;color:#999;display:inline-block;min-width:50px;padding-left:10px;padding-right:10px;user-select:none;-moz-user-select:none;-webkit-user-select:none;cursor:pointer}.litegraph .litemenubar li:hover{background-color:#777;color:#eee}.litegraph .litegraph .litemenubar-panel{position:absolute;top:5px;left:5px;min-width:100px;background-color:#444;box-shadow:0 0 3px #000;padding:4px;border-bottom:2px solid #aaf;z-index:10}.litegraph .litemenu-entry,.litemenu-title{font-size:12px;color:#aaa;margin:2px;padding:0 0 0 2px;-moz-user-select:none;-webkit-user-select:none;user-select:none;cursor:pointer}.litegraph .litemenu-entry .icon{display:inline-block;width:12px;height:12px;margin:2px;vertical-align:top}.litegraph .litemenu-entry.checked .icon{background-color:#aaf}.litegraph .litemenu-entry .more{float:right;padding-right:5px}.litegraph .litemenu-entry.disabled{opacity:.5;cursor:default}.litegraph .litemenu-entry.separator{display:block;border-top:1px solid #333;border-bottom:1px solid #666;width:100%;height:0px;margin:3px 0 2px;background-color:transparent;padding:0!important;cursor:default!important}.litegraph .litemenu-entry.has_submenu{border-right:2px solid cyan}.litegraph .litemenu-title{color:#dde;background-color:#111;margin:0;padding:2px;cursor:default}.litegraph .litemenu-entry:hover:not(.disabled):not(.separator){background-color:#444!important;color:#eee;transition:all .2s}.litegraph .litemenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.litegraph .litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.litegraph.litesearchbox{font-family:Tahoma,sans-serif;position:absolute;background-color:#00000080;padding-top:4px}.litegraph.litesearchbox input,.litegraph.litesearchbox select{margin-top:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;margin-right:5px;max-width:300px}.litegraph.litesearchbox .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.litegraph.litesearchbox .helper{overflow:auto;max-height:200px;margin-top:2px}.litegraph.lite-search-item{font-family:Tahoma,sans-serif;background-color:#00000080;color:#fff;padding-top:2px}.litegraph.lite-search-item.not_in_filter{color:#b99;font-style:italic}.litegraph.lite-search-item.generic_type{color:#999;font-style:italic}.litegraph.lite-search-item:hover,.litegraph.lite-search-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph.lite-search-item-type{display:inline-block;background:#0003;margin-left:5px;font-size:14px;padding:2px 5px;position:relative;top:-2px;opacity:.8;border-radius:4px}.litegraph .dialog{position:absolute;top:50%;left:50%;margin-top:-150px;margin-left:-200px;background-color:#2a2a2a;min-width:400px;min-height:200px;box-shadow:0 0 4px #111;border-radius:6px}.litegraph .dialog.settings{left:10px;top:10px;height:calc(100% - 20px);margin:auto;max-width:50%}.litegraph .dialog.centered{top:50px;left:50%;position:absolute;transform:translate(-50%);min-width:600px;min-height:300px;height:calc(100% - 100px);margin:auto}.litegraph .dialog .close{float:right;margin:4px 10px 4px 4px;cursor:pointer;font-size:1.4em}.litegraph .dialog .close:hover{color:#fff}.litegraph .dialog .dialog-header{color:#aaa;border-bottom:1px solid #161616}.litegraph .dialog .dialog-header{height:40px}.litegraph .dialog .dialog-footer{height:50px;padding:10px;margin:0;border-top:1px solid #1a1a1a}.litegraph .dialog .dialog-header .dialog-title{font:20px Arial;margin:4px;padding:4px 10px;display:inline-block}.litegraph .dialog .dialog-content,.litegraph .dialog .dialog-alt-content{height:calc(100% - 90px);width:100%;min-height:100px;display:inline-block;color:#aaa;overflow:auto}.litegraph .dialog .dialog-content h3{margin:10px}.litegraph .dialog .dialog-content .connections{flex-direction:row}.litegraph .dialog .dialog-content .connections .connections_side{width:calc(50% - 5px);min-height:100px;background-color:#000;display:flex}.litegraph .dialog .node_type{font-size:1.2em;display:block;margin:10px}.litegraph .dialog .node_desc{opacity:.5;display:block;margin:10px}.litegraph .dialog .separator{display:block;width:calc(100% - 4px);height:1px;border-top:1px solid #000;border-bottom:1px solid #333;margin:10px 2px;padding:0}.litegraph .dialog .property{margin-bottom:2px;padding:4px}.litegraph .dialog .property:hover{background:#545454}.litegraph .dialog .property_name{color:#737373;display:inline-block;text-align:left;vertical-align:top;width:160px;padding-left:4px;overflow:hidden;margin-right:6px}.litegraph .dialog .property:hover .property_name{color:#fff}.litegraph .dialog .property_value{display:inline-block;text-align:right;color:#aaa;background-color:#1a1a1a;max-width:calc(100% - 162px);min-width:200px;max-height:300px;min-height:20px;padding:4px 12px 4px 4px;overflow:hidden;cursor:pointer;border-radius:3px}.litegraph .dialog .property_value:hover{color:#fff}.litegraph .dialog .property.boolean .property_value{padding-right:30px;color:#a88}.litegraph .dialog .property.boolean.bool-on .property_name,.litegraph .dialog .property.boolean.bool-on .property_value{color:#8a8}.litegraph .dialog .btn{border:0;border-radius:4px;padding:4px 20px;margin-left:0;background-color:#060606;color:#8e8e8e}.litegraph .dialog .btn:hover{background-color:#111;color:#fff}.litegraph .dialog .btn.delete:hover{background-color:#f33;color:#000}.litegraph .bullet_icon{margin-left:10px;border-radius:10px;width:12px;height:12px;background-color:#666;display:inline-block;margin-top:2px;margin-right:4px;transition:background-color .1s ease 0s;-moz-transition:background-color .1s ease 0s}.litegraph .bullet_icon:hover{background-color:#698;cursor:pointer}.graphcontextmenu{padding:4px;min-width:100px}.graphcontextmenu-title{color:#dde;background-color:#222;margin:0;padding:2px;cursor:default}.graphmenu-entry{box-sizing:border-box;margin:2px;padding-left:20px;user-select:none;-moz-user-select:none;-webkit-user-select:none;transition:all linear .3s}.graphmenu-entry.event,.litemenu-entry.event{border-left:8px solid orange;padding-left:12px}.graphmenu-entry.disabled{opacity:.3}.graphmenu-entry.submenu{border-right:2px solid #eee}.graphmenu-entry:hover{background-color:#555}.graphmenu-entry.separator{background-color:#111;border-bottom:1px solid #666;height:1px;width:calc(100% - 20px);-moz-width:calc(100% - 20px);-webkit-width:calc(100% - 20px)}.graphmenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.graphmenu-entry .property_value,.litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.graphdialog{position:absolute;top:10px;left:10px;min-height:2em;background-color:#333;font-size:1.2em;box-shadow:0 0 10px #000!important;z-index:10}.graphdialog.rounded{border-radius:12px;padding-right:2px}.graphdialog .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.graphdialog input,.graphdialog textarea,.graphdialog select{margin:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;outline:none}.graphdialog textarea{min-height:150px}.graphdialog button{margin-top:3px;vertical-align:top;background-color:#999;border:0}.graphdialog button.rounded,.graphdialog input.rounded{border-radius:0 12px 12px 0}.graphdialog .helper{overflow:auto;max-height:200px}.graphdialog .help-item{padding-left:10px}.graphdialog .help-item:hover,.graphdialog .help-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph .dialog{min-height:0}.litegraph .dialog .dialog-content{display:block}.litegraph .graphdialog{display:flex;align-items:center;border-radius:20px;padding:4px 10px;position:fixed}.litegraph .graphdialog .name{padding:0;min-height:0;font-size:16px;vertical-align:middle}.litegraph .graphdialog .value{font-size:16px;min-height:0;margin:0 10px;padding:2px 5px}.litegraph .graphdialog input[type=checkbox]{width:16px;height:16px}.litegraph .graphdialog button{padding:4px 18px;border-radius:20px;cursor:pointer}";let registered=!1,_datasetInfo={dataset_name:"",fields:[],label_fields:[],saved_views:[]};function setDatasetInfo(p){_datasetInfo=p}function populateNodeCombos(p){if(!p.widgets)return;const t=p.type||"";for(const i of p.widgets){if(i.type!=="combo")continue;const n=i.name||"";n==="view_name"&&t.includes("Source/")?i.options.values=_datasetInfo.saved_views.length>0?_datasetInfo.saved_views:["(no saved views)"]:n==="field"&&(t.includes("Filter Labels")||t.includes("Match Labels")||t.includes("To Patches")||t.includes("Map Labels"))?i.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:n==="field"&&(i.options.values=_datasetInfo.fields.length>0?_datasetInfo.fields:["(no fields)"])}}function updateAllComboWidgets(p){const t=p._nodes;if(t)for(const i of t)populateNodeCombos(i)}function hookNodeAdded(p){const t=p.onNodeAdded;p.onNodeAdded=function(i){populateNodeCombos(i),t&&t.call(this,i)}}function registerAllNodes(){if(registered)return;registered=!0;class p extends LGraphNode{constructor(){super(),this.title="Current Dataset",this.addOutput("view","FO_VIEW"),this.properties={},this.size=[240,60],this.color="#1B4F72",this.bgcolor="#154360"}onDrawForeground(w){const R=_datasetInfo.dataset_name;R&&(w.font="bold 13px monospace",w.fillStyle="#4FC3F7",w.textAlign="center",w.fillText(R,this.size[0]/2,this.size[1]-12))}}u(p,"title","Current Dataset"),u(p,"desc","Use the dataset currently loaded in the App"),LiteGraph.registerNodeType("FiftyComfy/Source/Current Dataset",p);class t extends LGraphNode{constructor(){super(),this.title="Load Saved View",this.addOutput("view","FO_VIEW"),this.addWidget("combo","view_name","",w=>{this.properties.view_name=w},{values:[]}),this.properties={view_name:""},this.size=[280,80],this.color="#1B4F72",this.bgcolor="#154360"}onDrawForeground(w){const R=_datasetInfo.dataset_name;R&&(w.font="11px sans-serif",w.fillStyle="rgba(255,255,255,0.35)",w.textAlign="left",w.fillText("dataset: "+R,10,this.size[1]-8))}}u(t,"title","Load Saved View"),u(t,"desc","Load a saved view from the dataset"),LiteGraph.registerNodeType("FiftyComfy/Source/Load Saved View",t);class i extends LGraphNode{constructor(){super(),this.title="Match",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","expression","F('confidence') > 0.5",w=>{this.properties.expression=w}),this.properties={expression:"F('confidence') > 0.5"},this.size=[320,80],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(i,"title","Match"),u(i,"desc","Filter samples by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match",i);class n extends LGraphNode{constructor(){super(),this.title="Filter Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","expression","F('confidence') > 0.5",w=>{this.properties.expression=w}),this.addWidget("toggle","only_matches",!0,w=>{this.properties.only_matches=w}),this.properties={field:"",expression:"F('confidence') > 0.5",only_matches:!0},this.size=[320,130],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(n,"title","Filter Labels"),u(n,"desc","Filter detections/classifications within a label field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Labels",n);class s extends LGraphNode{constructor(){super(),this.title="Match Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","filter","F('confidence') > 0.5",w=>{this.properties.filter=w}),this.addWidget("toggle","bool",!0,w=>{this.properties.bool=w}),this.properties={field:"",filter:"F('confidence') > 0.5",bool:!0},this.size=[320,130],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(s,"title","Match Labels"),u(s,"desc","Match samples containing labels that satisfy a condition"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Labels",s);class o extends LGraphNode{constructor(){super(),this.title="Sort By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("toggle","reverse",!1,w=>{this.properties.reverse=w}),this.properties={field:"",reverse:!1},this.size=[280,90],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(o,"title","Sort By"),u(o,"desc","Sort samples by a field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By",o);class r extends LGraphNode{constructor(){super(),this.title="Sort By Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",w=>{this.properties.brain_key=w}),this.addWidget("number","k",25,w=>{this.properties.k=w},{min:1,max:1e5,step:1}),this.addWidget("toggle","reverse",!1,w=>{this.properties.reverse=w}),this.properties={brain_key:"similarity",k:25,reverse:!1},this.size=[320,120],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(r,"title","Sort By Similarity"),u(r,"desc","Sort samples by similarity to a reference (requires similarity index)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By Similarity",r);class a extends LGraphNode{constructor(){super(),this.title="Limit",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,w=>{this.properties.count=w},{min:1,max:1e5,step:10}),this.properties={count:100},this.size=[220,70],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(a,"title","Limit"),u(a,"desc","Limit number of samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Limit",a);class l extends LGraphNode{constructor(){super(),this.title="Match Tags",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",w=>{this.properties.tags=w}),this.properties={tags:""},this.size=[280,70],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(l,"title","Match Tags"),u(l,"desc","Filter samples by tags (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Tags",l);class h extends LGraphNode{constructor(){super(),this.title="Take",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,w=>{this.properties.count=w},{min:1,max:1e5,step:10}),this.addWidget("number","seed",0,w=>{this.properties.seed=w||null},{min:0,max:99999,step:1}),this.properties={count:100,seed:null},this.size=[240,90],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(h,"title","Take"),u(h,"desc","Randomly sample N samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Take",h);class c extends LGraphNode{constructor(){super(),this.title="Shuffle",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","seed",0,w=>{this.properties.seed=w||null},{min:0,max:99999,step:1}),this.properties={seed:null},this.size=[220,70],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(c,"title","Shuffle"),u(c,"desc","Randomly shuffle samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Shuffle",c);class d extends LGraphNode{constructor(){super(),this.title="To Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.properties={field:""},this.size=[280,70],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(d,"title","To Patches"),u(d,"desc","Create a patches view from a label list field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/To Patches",d);class f extends LGraphNode{constructor(){super(),this.title="Map Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","map",'{"old_label": "new_label"}',w=>{this.properties.map=w}),this.properties={field:"",map:'{"old_label": "new_label"}'},this.size=[340,100],this.color="#2A633A",this.bgcolor="#1E4A2B"}}u(f,"title","Map Labels"),u(f,"desc","Remap label values using a mapping dict"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Map Labels",f);class g extends LGraphNode{constructor(){super(),this.title="Compute Embeddings",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","clip-vit-base32-torch",w=>{this.properties.model=w},{values:["clip-vit-base32-torch","clip-vit-large14-torch","open-clip-vit-b-32","dinov2-vits14-torch"]}),this.addWidget("text","embeddings_field","embeddings",w=>{this.properties.embeddings_field=w}),this.properties={model:"clip-vit-base32-torch",embeddings_field:"embeddings"},this.size=[340,100],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(g,"title","Compute Embeddings"),u(g,"desc","Compute embeddings using a zoo model"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Embeddings",g);class m extends LGraphNode{constructor(){super(),this.title="Compute Visualization",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","visualization",w=>{this.properties.brain_key=w}),this.addWidget("combo","method","umap",w=>{this.properties.method=w},{values:["umap","tsne","pca"]}),this.addWidget("combo","num_dims","2",w=>{this.properties.num_dims=parseInt(w)},{values:["2","3"]}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={brain_key:"visualization",method:"umap",num_dims:2,embeddings:"embeddings"},this.size=[340,150],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(m,"title","Compute Visualization"),u(m,"desc","Compute UMAP/t-SNE/PCA embedding visualization"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Visualization",m);class _ extends LGraphNode{constructor(){super(),this.title="Compute Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",w=>{this.properties.brain_key=w}),this.addWidget("combo","backend","sklearn",w=>{this.properties.backend=w},{values:["sklearn","qdrant","pinecone","milvus","lancedb"]}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={brain_key:"similarity",backend:"sklearn",embeddings:"embeddings"},this.size=[340,130],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(_,"title","Compute Similarity"),u(_,"desc","Create a similarity index"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Similarity",_);class y extends LGraphNode{constructor(){super(),this.title="Compute Uniqueness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","uniqueness_field","uniqueness",w=>{this.properties.uniqueness_field=w}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={uniqueness_field:"uniqueness",embeddings:"embeddings"},this.size=[320,100],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(y,"title","Compute Uniqueness"),u(y,"desc","Compute uniqueness score per sample"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Uniqueness",y);class b extends LGraphNode{constructor(){super(),this.title="Find Exact Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.properties={},this.size=[280,50],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(b,"title","Find Exact Duplicates"),u(b,"desc","Find samples with identical media files"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Exact Duplicates",b);class L extends LGraphNode{constructor(){super(),this.title="Find Near Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","threshold",.1,w=>{this.properties.threshold=w},{min:.001,max:1,step:.01,precision:3}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={threshold:.1,embeddings:"embeddings"},this.size=[320,100],this.color="#5B2C6F",this.bgcolor="#4A235A"}}u(L,"title","Find Near Duplicates"),u(L,"desc","Find near-duplicate samples using embeddings"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Near Duplicates",L);class k extends LGraphNode{constructor(){super(),this.title="Count",this.addInput("view","FO_VIEW"),this.properties={result:null},this.size=[200,70],this.color="#7D6608",this.bgcolor="#5C4B08"}onDrawForeground(w){this.properties.result!==null&&this.properties.result!==void 0&&(w.font="bold 20px monospace",w.fillStyle="#FFD700",w.textAlign="center",w.fillText(String(this.properties.result),this.size[0]/2,this.size[1]-15))}}u(k,"title","Count"),u(k,"desc","Count samples in the view"),LiteGraph.registerNodeType("FiftyComfy/Aggregations/Count",k);class T extends LGraphNode{constructor(){super(),this.title="Count Values",this.addInput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.properties={field:"",result:null},this.size=[300,140],this.color="#7D6608",this.bgcolor="#5C4B08"}onDrawForeground(w){if(this.properties.result){w.font="12px monospace",w.fillStyle="#FFD700",w.textAlign="left";let R=70;const M=Object.entries(this.properties.result).slice(0,5);for(const[U,F]of M)w.fillText(`${U}: ${F}`,10,R),R+=16;Object.keys(this.properties.result).length>5&&w.fillText("...",10,R)}}}u(T,"title","Count Values"),u(T,"desc","Count occurrences of each value in a field"),LiteGraph.registerNodeType("FiftyComfy/Aggregations/Count Values",T);class S extends LGraphNode{constructor(){super(),this.title="Distinct",this.addInput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.properties={field:"",result:null},this.size=[280,120],this.color="#7D6608",this.bgcolor="#5C4B08"}onDrawForeground(w){if(this.properties.result){w.font="12px monospace",w.fillStyle="#FFD700",w.textAlign="left";const R=this.properties.result.slice(0,6);let M=70;for(const U of R)w.fillText(String(U),10,M),M+=16}}}u(S,"title","Distinct"),u(S,"desc","Get distinct values for a field"),LiteGraph.registerNodeType("FiftyComfy/Aggregations/Distinct",S);class N extends LGraphNode{constructor(){super(),this.title="Bounds",this.addInput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.properties={field:"",result:null},this.size=[240,90],this.color="#7D6608",this.bgcolor="#5C4B08"}onDrawForeground(w){if(this.properties.result){const[R,M]=this.properties.result;w.font="14px monospace",w.fillStyle="#FFD700",w.textAlign="left",w.fillText(`[${R}, ${M}]`,10,this.size[1]-15)}}}u(N,"title","Bounds"),u(N,"desc","Get min/max bounds for a numeric field"),LiteGraph.registerNodeType("FiftyComfy/Aggregations/Bounds",N);class A extends LGraphNode{constructor(){super(),this.title="Set App View",this.addInput("view","FO_VIEW"),this.properties={},this.size=[220,50],this.color="#922B21",this.bgcolor="#7B241C"}}u(A,"title","Set App View"),u(A,"desc","Push the resulting view into the FiftyOne App"),LiteGraph.registerNodeType("FiftyComfy/Output/Set App View",A);class D extends LGraphNode{constructor(){super(),this.title="Save View",this.addInput("view","FO_VIEW"),this.addWidget("text","name","my_view",w=>{this.properties.name=w}),this.addWidget("text","description","",w=>{this.properties.description=w}),this.addWidget("toggle","overwrite",!1,w=>{this.properties.overwrite=w}),this.properties={name:"my_view",description:"",overwrite:!1},this.size=[300,120],this.color="#922B21",this.bgcolor="#7B241C"}}u(D,"title","Save View"),u(D,"desc","Save the view as a named saved view"),LiteGraph.registerNodeType("FiftyComfy/Output/Save View",D),console.log("[FiftyComfy] Registered all node types")}const NS$1="@harpreetsahota/FiftyComfy",STORAGE_KEY="fiftycomfy_workflows";let _graph=null,_lgCanvas=null,_initialized=!1,_cssInjected=!1;function getSavedWorkflows(){try{const p=localStorage.getItem(STORAGE_KEY);return p?JSON.parse(p):{}}catch{return{}}}function saveWorkflow(p,t){const i=getSavedWorkflows();i[p]=t,localStorage.setItem(STORAGE_KEY,JSON.stringify(i))}function listWorkflowNames(){return Object.keys(getSavedWorkflows())}function loadWorkflow(p){return getSavedWorkflows()[p]||null}const TH=36,toolbarCss={position:"absolute",top:0,left:0,right:0,height:TH,zIndex:10,display:"flex",alignItems:"center",gap:6,padding:"0 8px",background:"rgba(20,20,20,0.85)",backdropFilter:"blur(4px)",borderBottom:"1px solid rgba(255,255,255,0.08)",fontFamily:"'Inter','Segoe UI',sans-serif"},btnCss={padding:"4px 10px",border:"1px solid rgba(255,255,255,0.15)",borderRadius:4,background:"rgba(255,255,255,0.08)",color:"#ccc",cursor:"pointer",fontSize:12,fontWeight:500,lineHeight:"20px"},btnRunCss={...btnCss,background:"#2d6a4f",borderColor:"#40916c",color:"#fff",fontWeight:600},sepCss={width:1,height:20,background:"rgba(255,255,255,0.1)",margin:"0 2px"};function FiftyComfyView(){const p=React.useRef(null),t=React.useRef(null),[i,n]=React.useState("Ready"),[s,o]=React.useState(!1),[r,a]=React.useState(!1),[l,h]=React.useState([]);React.useEffect(()=>{const _=p.current,y=t.current;if(!_||!y)return;if(!_cssInjected){const k=document.createElement("style");k.id="fiftycomfy-lg-css",k.textContent=litegraphCss,document.head.appendChild(k),_cssInjected=!0}_initialized||(registerAllNodes(),LiteGraph.allow_edit_node_title=!1,LiteGraph.DEFAULT_LINK_COLOR="#99ccff",LiteGraph.LINK_COLOR="#99ccff",LiteGraph.EVENT_LINK_COLOR="#ff9966",LiteGraph.registered_link_types=LiteGraph.registered_link_types||{},LiteGraph.registered_link_types.FO_VIEW={color:"#4FC3F7"},_initialized=!0),_graph||(_graph=new LGraph),_lgCanvas=new LGraphCanvas(_,_graph),_lgCanvas.render_shadows=!1,_lgCanvas.max_zoom=4,_lgCanvas.min_zoom=.1,_lgCanvas.allow_searchbox=!0,_lgCanvas.show_searchbox_on_double_click=!0,_lgCanvas.render_curved_connections=!0,_lgCanvas.render_connection_arrows=!1,_lgCanvas.connections_width=3,_lgCanvas.default_connection_color={input_off:"#888",input_on:"#4FC3F7",output_off:"#888",output_on:"#4FC3F7"},hookNodeAdded(_graph),_graph.start(),operators.executeOperator(`${NS$1}/get_dataset_info`,{}).then(k=>{var T,S;if(k&&k.result){const N=k.result;setDatasetInfo(N),_graph&&updateAllComboWidgets(_graph),console.log("[FiftyComfy] Dataset info loaded:",(T=N.fields)==null?void 0:T.length,"fields,",(S=N.label_fields)==null?void 0:S.length,"label fields")}}).catch(k=>{console.warn("[FiftyComfy] Could not fetch dataset info:",k)});const b=()=>{if(!y||!_||!_lgCanvas)return;const k=y.offsetWidth||y.clientWidth,T=y.offsetHeight||y.clientHeight;if(k===0||T===0)return;_.width=k,_.height=T;const S=_lgCanvas.bgcanvas;S&&(S.width=k,S.height=T),_lgCanvas.setDirty(!0,!0)};b(),requestAnimationFrame(b),setTimeout(b,100);const L=new ResizeObserver(b);return L.observe(y),()=>{L.disconnect()}},[]);const c=React.useCallback(async()=>{if(_graph){for(const _ of _graph._nodes||[])_.boxcolor=null,_.setDirtyCanvas(!0,!0);o(!0),n("Running...");try{await operators.executeOperator(`${NS$1}/execute_graph`,{graph_json:JSON.stringify(_graph.serialize())})}catch(_){console.error("[FiftyComfy] Execution error:",_)}o(!1),n("Done")}},[]),d=React.useCallback(()=>{if(!_graph)return;const _=prompt("Workflow name:");_&&(saveWorkflow(_,_graph.serialize()),n("Saved: "+_))},[]),f=React.useCallback(()=>{h(listWorkflowNames()),a(!0)},[]),g=React.useCallback(_=>{if(!_graph)return;const y=loadWorkflow(_);y&&(_graph.configure(y),updateAllComboWidgets(_graph),n("Loaded: "+_)),a(!1)},[]),m=React.useCallback(()=>{_graph&&_graph.clear(),n("Ready")},[]);return React__namespace.createElement("div",{ref:t,style:{width:"100%",height:"100%",position:"relative",overflow:"hidden"}},React__namespace.createElement("canvas",{ref:p,style:{position:"absolute",top:0,left:0}}),React__namespace.createElement("div",{style:toolbarCss},React__namespace.createElement("button",{style:btnRunCss,onClick:c,disabled:s},s?"Running...":"â–¶ Run Workflow"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:d},"Save"),React__namespace.createElement("button",{style:btnCss,onClick:f},"Load"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:m},"Clear"),React__namespace.createElement("span",{style:{marginLeft:"auto",fontSize:11,color:"rgba(255,255,255,0.4)"}},i)),r&&React__namespace.createElement("div",{style:{position:"absolute",top:TH+4,left:100,zIndex:20,background:"#2a2a2a",border:"1px solid #555",borderRadius:6,padding:8,minWidth:220,maxHeight:300,overflowY:"auto",boxShadow:"0 4px 16px rgba(0,0,0,0.5)"}},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:6,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Saved Workflows"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>a(!1)},"âœ•")),l.length===0?React__namespace.createElement("div",{style:{fontSize:12,color:"#666",padding:8}},"No saved workflows"):l.map(_=>React__namespace.createElement("div",{key:_,onClick:()=>g(_),style:{padding:"5px 8px",cursor:"pointer",borderRadius:4,fontSize:12,color:"#ddd"},onMouseOver:y=>{y.currentTarget.style.background="#3a3a3a"},onMouseOut:y=>{y.currentTarget.style.background="transparent"}},_))))}const listeners={};function emit(p,t){(listeners[p]||[]).forEach(i=>{try{i(t)}catch(n){console.error(`[FiftyComfy] Event listener error (${p}):`,n)}})}class NodeStatusUpdateOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"node_status_update",label:"Node Status Update",unlisted:!0})}async execute({params:t}){emit("node_status",t)}}class ExecutionCompleteOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"execution_complete",label:"Execution Complete",unlisted:!0})}async execute({params:t}){emit("execution_complete",t)}}plugins.registerComponent({name:"FiftyComfyView",component:FiftyComfyView,type:plugins.PluginComponentType.Component,activator:()=>!0});const NS="@harpreetsahota/FiftyComfy";operators.registerOperator(NodeStatusUpdateOperator,NS),operators.registerOperator(ExecutionCompleteOperator,NS),console.log("[FiftyComfy] Component (type=3) and operators registered")});
//# sourceMappingURL=index.umd.js.map
