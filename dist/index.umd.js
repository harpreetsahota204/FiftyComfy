(function(H,V){typeof exports=="object"&&typeof module<"u"?V(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","react"],V):(H=typeof globalThis<"u"?globalThis:H||self,V(H.__fop__,H.__foo__,H.React))})(this,function(plugins,operators,React){"use strict";var zi=Object.defineProperty;var di=H=>{throw TypeError(H)};var Vi=(H,V,Y)=>V in H?zi(H,V,{enumerable:!0,configurable:!0,writable:!0,value:Y}):H[V]=Y;var h=(H,V,Y)=>Vi(H,typeof V!="symbol"?V+"":V,Y),Ye=(H,V,Y)=>V.has(H)||di("Cannot "+Y);var S=(H,V,Y)=>(Ye(H,V,"read from private field"),Y?Y.call(H):V.get(H)),P=(H,V,Y)=>V.has(H)?di("Cannot add the same private member more than once"):V instanceof WeakSet?V.add(H):V.set(H,Y),z=(H,V,Y,wt)=>(Ye(H,V,"write to private field"),wt?wt.call(H,Y):V.set(H,Y),Y),C=(H,V,Y)=>(Ye(H,V,"access private method"),Y);var ui=(H,V,Y,wt)=>({set _(It){z(H,V,It,Y)},get _(){return S(H,V,wt)}});var H,Y,wt,Oe,ci,oe,Ht,et,ct,ut,Et,je,re,Rt,Gt,Ke,Ut,ae,$t,Xt,Yt,jt,le,he,Kt,de,Zt,pi,fi,ue,ce,pe,fe,gt,qe,Ze,Je,Nt,At,ge,_e,U,gi,_i,Qe,Ne,ti,ei,Ue,mi,yi,vi,bi,wi,ki,Qt,me,Q,ii,si,ft,Ft,ye,te,lt,ni,$e,Li,oi,Re,Ii,Ge,Ae,Fe,Ct,Lt,xe,Pe,We,xt,F,Xe,Ot,ve,mt,ht,be,Pt,Si,bt,Bt,Ti,Ei,ri,Ni,Ci,Oi,Di,Ri,zt,Vt,Gi,Ai,Fi,xi,Pi,Wi,ne,Ce,Wt,Mt,Me,Be,Mi,we,ke,Le,ai,Ie,Ve,Se,Te,He,Bi,Ee,Dt,li,hi;function _interopNamespaceDefault(c){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(c){for(const i in c)if(i!=="default"){const s=Object.getOwnPropertyDescriptor(c,i);Object.defineProperty(t,i,s.get?s:{enumerable:!0,get:()=>c[i]})}}return t.default=c,Object.freeze(t)}const React__namespace=_interopNamespaceDefault(React);class CustomEventTarget extends EventTarget{dispatch(t,i){const s=new CustomEvent(t,{detail:i,cancelable:!0});return super.dispatchEvent(s)}addEventListener(t,i,s){super.addEventListener(t,i,s)}removeEventListener(t,i,s){super.removeEventListener(t,i,s)}dispatchEvent(t){return super.dispatchEvent(t)}}const SUBGRAPH_INPUT_ID=-10,SUBGRAPH_OUTPUT_ID=-20,zeroUuid="00000000-0000-0000-0000-000000000000",randomStorage=new Uint32Array(31);function createUuidv4(){if(typeof(crypto==null?void 0:crypto.randomUUID)=="function")return crypto.randomUUID();if(typeof(crypto==null?void 0:crypto.getRandomValues)=="function"){const c=crypto.getRandomValues(randomStorage);let t=0;return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,i=>(Number(i)^c[t++]*3725290298461914e-24>>Number(i)*.25).toString(16))}return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,c=>(Number(c)^Math.random()*16>>Number(c)*.25).toString(16))}const V=class V{constructor(t,i,s,n,o,r,a){h(this,"id");h(this,"parentId");h(this,"type");h(this,"origin_id");h(this,"origin_slot");h(this,"target_id");h(this,"target_slot");h(this,"data");h(this,"_data");h(this,"_pos");h(this,"_last_time");h(this,"path");h(this,"_centreAngle");h(this,"_dragging");P(this,H);this.id=t,this.type=i,this.origin_id=s,this.origin_slot=n,this.target_id=o,this.target_slot=r,this.parentId=a,this._data=null,this._pos=new Float32Array(2)}get color(){return S(this,H)}set color(t){z(this,H,t===""?null:t)}get isFloatingOutput(){return this.origin_id===-1&&this.origin_slot===-1}get isFloatingInput(){return this.target_id===-1&&this.target_slot===-1}get isFloating(){return this.isFloatingOutput||this.isFloatingInput}get originIsIoNode(){return this.origin_id===SUBGRAPH_INPUT_ID}get targetIsIoNode(){return this.target_id===SUBGRAPH_OUTPUT_ID}static createFromArray(t){return new V(t[0],t[5],t[1],t[2],t[3],t[4])}static create(t){return new V(t.id,t.type,t.origin_id,t.origin_slot,t.target_id,t.target_slot,t.parentId)}static getReroutes(t,i){var s;return i.parentId?((s=t.reroutes.get(i.parentId))==null?void 0:s.getReroutes())??[]:[]}static getFirstReroute(t,i){return V.getReroutes(t,i).at(0)}static findNextReroute(t,i,s){var n;if(i.parentId)return(n=t.reroutes.get(i.parentId))==null?void 0:n.findNextReroute(s)}static getOriginNode(t,i){var n;const s=(n=t.links.get(i))==null?void 0:n.origin_id;return t.getNodeById(s)??void 0}static getTargetNode(t,i){var n;const s=(n=t.links.get(i))==null?void 0:n.target_id;return t.getNodeById(s)??void 0}static resolve(t,i){var s;return(s=i.getLink(t))==null?void 0:s.resolve(i)}static resolveMany(t,i){var n;const s=[];for(const o of t){const r=(n=i.getLink(o))==null?void 0:n.resolve(i);r&&s.push(r)}return s}resolve(t){var l,d;const i=this.target_id===-1?void 0:t.getNodeById(this.target_id)??void 0,s=i==null?void 0:i.inputs[this.target_slot],n=this.originIsIoNode?(l=t.inputNode)==null?void 0:l.slots[this.origin_slot]:void 0;if(n)return{inputNode:i,input:s,subgraphInput:n,link:this};const o=this.origin_id===-1?void 0:t.getNodeById(this.origin_id)??void 0,r=o==null?void 0:o.outputs[this.origin_slot],a=this.targetIsIoNode?(d=t.outputNode)==null?void 0:d.slots[this.target_slot]:void 0;return a?{outputNode:o,output:r,subgraphInput:void 0,subgraphOutput:a,link:this}:{inputNode:i,outputNode:o,input:s,output:r,subgraphInput:n,subgraphOutput:a,link:this}}configure(t){Array.isArray(t)?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot,this.parentId=t.parentId)}hasOrigin(t,i){return this.origin_id===t&&this.origin_slot===i}hasTarget(t,i){return this.target_id===t&&this.target_slot===i}toFloating(t,i){const s=this.asSerialisable();return s.id=-1,s.parentId=i,t==="input"?(s.origin_id=-1,s.origin_slot=-1):(s.target_id=-1,s.target_slot=-1),V.create(s)}disconnect(t,i){const s=V.getReroutes(t,this),n=s.at(-1);if(i==="output"&&(n==null?void 0:n.linkIds.size)===1&&n.floatingLinkIds.size===0||i==="input"&&n){const r=V.create(this);r.id=-1,i==="input"?(r.origin_id=-1,r.origin_slot=-1,n.floating={slotType:"input"}):(r.target_id=-1,r.target_slot=-1,n.floating={slotType:"output"}),t.addFloatingLink(r)}for(const r of s)r.linkIds.delete(this.id),!i&&!r.totalLinks&&t.reroutes.delete(r.id);if(t.links.delete(this.id),this.originIsIoNode&&t instanceof Subgraph){const r=t.inputs.at(this.origin_slot);if(!r)throw new Error("Invalid link - subgraph input not found");r.events.dispatch("input-disconnected",{input:r})}}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}asSerialisable(){const t={id:this.id,origin_id:this.origin_id,origin_slot:this.origin_slot,target_id:this.target_id,target_slot:this.target_slot,type:this.type};return this.parentId&&(t.parentId=this.parentId),t}};H=new WeakMap,h(V,"_drawDebug",!1);let LLink=V;var NodeSlotType=(c=>(c[c.INPUT=1]="INPUT",c[c.OUTPUT=2]="OUTPUT",c))(NodeSlotType||{}),RenderShape=(c=>(c[c.BOX=1]="BOX",c[c.ROUND=2]="ROUND",c[c.CIRCLE=3]="CIRCLE",c[c.CARD=4]="CARD",c[c.ARROW=5]="ARROW",c[c.GRID=6]="GRID",c[c.HollowCircle=7]="HollowCircle",c))(RenderShape||{}),CanvasItem=(c=>(c[c.Nothing=0]="Nothing",c[c.Node=1]="Node",c[c.Group=2]="Group",c[c.Reroute=4]="Reroute",c[c.Link=8]="Link",c[c.RerouteSlot=32]="RerouteSlot",c[c.SubgraphIoNode=64]="SubgraphIoNode",c[c.SubgraphIoSlot=128]="SubgraphIoSlot",c))(CanvasItem||{}),LinkDirection=(c=>(c[c.NONE=0]="NONE",c[c.UP=1]="UP",c[c.DOWN=2]="DOWN",c[c.LEFT=3]="LEFT",c[c.RIGHT=4]="RIGHT",c[c.CENTER=5]="CENTER",c))(LinkDirection||{}),LinkRenderType=(c=>(c[c.HIDDEN_LINK=-1]="HIDDEN_LINK",c[c.STRAIGHT_LINK=0]="STRAIGHT_LINK",c[c.LINEAR_LINK=1]="LINEAR_LINK",c[c.SPLINE_LINK=2]="SPLINE_LINK",c))(LinkRenderType||{}),LinkMarkerShape=(c=>(c[c.None=0]="None",c[c.Circle=1]="Circle",c[c.Arrow=2]="Arrow",c))(LinkMarkerShape||{}),TitleMode=(c=>(c[c.NORMAL_TITLE=0]="NORMAL_TITLE",c[c.NO_TITLE=1]="NO_TITLE",c[c.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",c[c.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",c))(TitleMode||{}),LGraphEventMode=(c=>(c[c.ALWAYS=0]="ALWAYS",c[c.ON_EVENT=1]="ON_EVENT",c[c.NEVER=2]="NEVER",c[c.ON_TRIGGER=3]="ON_TRIGGER",c[c.BYPASS=4]="BYPASS",c))(LGraphEventMode||{}),EaseFunction=(c=>(c.LINEAR="linear",c.EASE_IN_QUAD="easeInQuad",c.EASE_OUT_QUAD="easeOutQuad",c.EASE_IN_OUT_QUAD="easeInOutQuad",c))(EaseFunction||{}),Alignment=(c=>(c[c.None=0]="None",c[c.Top=1]="Top",c[c.Bottom=2]="Bottom",c[c.Middle=4]="Middle",c[c.Left=8]="Left",c[c.Right=16]="Right",c[c.Centre=32]="Centre",c[c.TopLeft=9]="TopLeft",c[c.TopCentre=33]="TopCentre",c[c.TopRight=17]="TopRight",c[c.MidLeft=12]="MidLeft",c[c.MidCentre=36]="MidCentre",c[c.MidRight=20]="MidRight",c[c.BottomLeft=10]="BottomLeft",c[c.BottomCentre=34]="BottomCentre",c[c.BottomRight=18]="BottomRight",c))(Alignment||{});function hasFlag(c,t){return(c&t)===t}function distance(c,t){return Math.sqrt((t[0]-c[0])*(t[0]-c[0])+(t[1]-c[1])*(t[1]-c[1]))}function dist2(c,t,i,s){return(i-c)*(i-c)+(s-t)*(s-t)}function isInRectangle(c,t,i,s,n,o){return c>=i&&c<i+n&&t>=s&&t<s+o}function isPointInRect(c,t){return c[0]>=t[0]&&c[0]<t[0]+t[2]&&c[1]>=t[1]&&c[1]<t[1]+t[3]}function isInRect(c,t,i){return c>=i[0]&&c<i[0]+i[2]&&t>=i[1]&&t<i[1]+i[3]}function isInsideRectangle(c,t,i,s,n,o){return i<c&&i+n>c&&s<t&&s+o>t}function overlapBounding(c,t){const i=c[0]+c[2],s=c[1]+c[3],n=t[0]+t[2],o=t[1]+t[3];return!(c[0]>n||c[1]>o||i<t[0]||s<t[1])}function getCentre(c){return[c[0]+c[2]*.5,c[1]+c[3]*.5]}function containsCentre(c,t){const i=t[0]+t[2]*.5,s=t[1]+t[3]*.5;return isInRect(i,s,c)}function containsRect(c,t){const i=c[0]+c[2],s=c[1]+c[3],n=t[0]+t[2],o=t[1]+t[3];return!(c[0]===t[0]&&c[1]===t[1]&&i===n&&s===o)&&c[0]<=t[0]&&c[1]<=t[1]&&i>=n&&s>=o}function findPointOnCurve(c,t,i,s,n,o=.5){const r=1-o,a=r*r*r,l=3*(r*r)*o,d=3*r*(o*o),u=o*o*o;c[0]=a*t[0]+l*s[0]+d*n[0]+u*i[0],c[1]=a*t[1]+l*s[1]+d*n[1]+u*i[1]}function createBounds(c,t=10){const i=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const s of c){const n=s.boundingRect;i[0]=Math.min(i[0],n[0]),i[1]=Math.min(i[1],n[1]),i[2]=Math.max(i[2],n[0]+n[2]),i[3]=Math.max(i[3],n[1]+n[3])}return i.every(s=>isFinite(s))?[i[0]-t,i[1]-t,i[2]-i[0]+2*t,i[3]-i[1]+2*t]:null}function snapPoint(c,t){return t?(c[0]=t*Math.round(c[0]/t),c[1]=t*Math.round(c[1]/t),!0):!1}function alignToContainer(c,t,[i,s,n,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?c[0]=i+r:hasFlag(t,Alignment.Right)?c[0]=i+n-r-c[2]:hasFlag(t,Alignment.Centre)&&(c[0]=i+n*.5-c[2]*.5),hasFlag(t,Alignment.Top)?c[1]=s+a:hasFlag(t,Alignment.Bottom)?c[1]=s+o-a-c[3]:hasFlag(t,Alignment.Middle)&&(c[1]=s+o*.5-c[3]*.5),c}function alignOutsideContainer(c,t,[i,s,n,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?c[0]=i-r-c[2]:hasFlag(t,Alignment.Right)?c[0]=i+n+r:hasFlag(t,Alignment.Centre)&&(c[0]=i+n*.5-c[2]*.5),hasFlag(t,Alignment.Top)?c[1]=s-a-c[3]:hasFlag(t,Alignment.Bottom)?c[1]=s+o+a:hasFlag(t,Alignment.Middle)&&(c[1]=s+o*.5-c[3]*.5),c}function clamp(c,t,i){return c<t?t:c>i?i:c}const It=class It extends Float64Array{constructor(i=0,s=0,n=0,o=0){super(4);P(this,Y);P(this,wt);this[0]=i,this[1]=s,this[2]=n,this[3]=o}static from([i,s,n,o]){return new It(i,s,n,o)}static fromCentre([i,s],n,o=n){const r=i-n*.5,a=s-o*.5;return new It(r,a,n,o)}static ensureRect(i){return i instanceof It?i:new It(i[0],i[1],i[2],i[3])}subarray(i=0,s){const n=i<<3,o=s===void 0?s:s-i;return new Float64Array(this.buffer,n,o)}get pos(){return S(this,Y)??z(this,Y,this.subarray(0,2)),S(this,Y)}set pos(i){this[0]=i[0],this[1]=i[1]}get size(){return S(this,wt)??z(this,wt,this.subarray(2,4)),S(this,wt)}set size(i){this[2]=i[0],this[3]=i[1]}get x(){return this[0]}set x(i){this[0]=i}get y(){return this[1]}set y(i){this[1]=i}get width(){return this[2]}set width(i){this[2]=i}get height(){return this[3]}set height(i){this[3]=i}get left(){return this[0]}set left(i){this[0]=i}get top(){return this[1]}set top(i){this[1]=i}get right(){return this[0]+this[2]}set right(i){this[0]=i-this[2]}get bottom(){return this[1]+this[3]}set bottom(i){this[1]=i-this[3]}get centreX(){return this[0]+this[2]*.5}get centreY(){return this[1]+this[3]*.5}updateTo(i){this[0]=i[0],this[1]=i[1],this[2]=i[2],this[3]=i[3]}containsXy(i,s){const[n,o,r,a]=this;return i>=n&&i<n+r&&s>=o&&s<o+a}containsPoint([i,s]){const[n,o,r,a]=this;return i>=n&&i<n+r&&s>=o&&s<o+a}containsRect(i){const{right:s,bottom:n}=this,o=i[0]+i[2],r=i[1]+i[3];return!(this.x===i[0]&&this.y===i[1]&&s===o&&n===r)&&this.x<=i[0]&&this.y<=i[1]&&s>=o&&n>=r}overlaps(i){return this.x<i[0]+i[2]&&this.y<i[1]+i[3]&&this.x+this.width>i[0]&&this.y+this.height>i[1]}findContainingCorner(i,s,n){if(this.isInTopLeftCorner(i,s,n))return"NW";if(this.isInTopRightCorner(i,s,n))return"NE";if(this.isInBottomLeftCorner(i,s,n))return"SW";if(this.isInBottomRightCorner(i,s,n))return"SE"}isInTopLeftCorner(i,s,n){return isInRectangle(i,s,this.x,this.y,n,n)}isInTopRightCorner(i,s,n){return isInRectangle(i,s,this.right-n,this.y,n,n)}isInBottomLeftCorner(i,s,n){return isInRectangle(i,s,this.x,this.bottom-n,n,n)}isInBottomRightCorner(i,s,n){return isInRectangle(i,s,this.right-n,this.bottom-n,n,n)}isInTopEdge(i,s,n){return isInRectangle(i,s,this.x,this.y,this.width,n)}isInBottomEdge(i,s,n){return isInRectangle(i,s,this.x,this.bottom-n,this.width,n)}isInLeftEdge(i,s,n){return isInRectangle(i,s,this.x,this.y,n,this.height)}isInRightEdge(i,s,n){return isInRectangle(i,s,this.right-n,this.y,n,this.height)}getCentre(){return[this.centreX,this.centreY]}getArea(){return this.width*this.height}getPerimeter(){return 2*(this.width+this.height)}getTopLeft(){return[this[0],this[1]]}getBottomRight(){return[this.right,this.bottom]}getSize(){return[this[2],this[3]]}getOffsetTo([i,s]){return[i-this[0],s-this[1]]}getOffsetFrom([i,s]){return[this[0]-i,this[1]-s]}resizeTopLeft(i,s){this[2]+=this[0]-i,this[3]+=this[1]-s,this[0]=i,this[1]=s}resizeBottomLeft(i,s){this[2]+=this[0]-i,this[3]=s-this[1],this[0]=i}resizeTopRight(i,s){this[2]=i-this[0],this[3]+=this[1]-s,this[1]=s}resizeBottomRight(i,s){this[2]=i-this[0],this[3]=s-this[1]}setWidthRightAnchored(i){const s=this[2];this[2]=i,this[0]+=s-i}setHeightBottomAnchored(i){const s=this[3];this[3]=i,this[1]+=s-i}clone(){return new It(this[0],this[1],this[2],this[3])}toArray(){return this.export()}export(){return[this[0],this[1],this[2],this[3]]}_drawDebug(i,s="red"){const{strokeStyle:n,lineWidth:o}=i;try{i.strokeStyle=s,i.lineWidth=.5,i.beginPath(),i.strokeRect(this[0],this[1],this[2],this[3])}finally{i.strokeStyle=n,i.lineWidth=o}}};Y=new WeakMap,wt=new WeakMap;let Rectangle=It;function getNodeInputOnPos(c,t,i){var n,o,r;const{inputs:s}=c;if(s)for(const[a,l]of s.entries()){const d=c.getInputPos(a),p=20+((((n=l.label)==null?void 0:n.length)??((o=l.localized_name)==null?void 0:o.length)??((r=l.name)==null?void 0:r.length))||3)*7;if(isInRectangle(t,i,d[0]-10,d[1]-10,p,20))return{index:a,input:l,pos:d}}}function getNodeOutputOnPos(c,t,i){const{outputs:s}=c;if(s)for(const[n,o]of s.entries()){const r=c.getOutputPos(n);if(isInRectangle(t,i,r[0]-10,r[1]-10,40,20))return{index:n,output:o,pos:r}}}function isOverNodeInput(c,t,i,s){const n=getNodeInputOnPos(c,t,i);return n?(s&&(s[0]=n.pos[0],s[1]=n.pos[1]),n.index):-1}function isOverNodeOutput(c,t,i,s){const n=getNodeOutputOnPos(c,t,i);return n?(s&&(s[0]=n.pos[0],s[1]=n.pos[1]),n.index):-1}class NullGraphError extends Error{constructor(t="Attempted to access LGraph reference that was null or undefined.",i){super(t,{cause:i}),this.name="NullGraphError"}}class LGraphIcon{constructor({unicode:t,fontFamily:i="PrimeIcons",color:s="#e6c200",bgColor:n,fontSize:o=16,circlePadding:r=2,xOffset:a=0,yOffset:l=0}){h(this,"unicode");h(this,"fontFamily");h(this,"color");h(this,"bgColor");h(this,"fontSize");h(this,"circlePadding");h(this,"xOffset");h(this,"yOffset");this.unicode=t,this.fontFamily=i,this.color=s,this.bgColor=n,this.fontSize=o,this.circlePadding=r,this.xOffset=a,this.yOffset=l}draw(t,i,s){i+=this.xOffset,s+=this.yOffset;const{font:n,textBaseline:o,textAlign:r,fillStyle:a}=t;t.font=`${this.fontSize}px '${this.fontFamily}'`,t.textBaseline="middle",t.textAlign="center";const l=this.fontSize/2+this.circlePadding;this.bgColor&&(t.beginPath(),t.arc(i+l,s,l,0,2*Math.PI),t.fillStyle=this.bgColor,t.fill()),t.fillStyle=this.color,t.fillText(this.unicode,i+l,s),t.font=n,t.textBaseline=o,t.textAlign=r,t.fillStyle=a}}var BadgePosition=(c=>(c.TopLeft="top-left",c.TopRight="top-right",c))(BadgePosition||{});class LGraphBadge{constructor({text:t,fgColor:i="white",bgColor:s="#0F1F0F",fontSize:n=12,padding:o=6,height:r=20,cornerRadius:a=5,iconOptions:l,xOffset:d=0,yOffset:u=0}){h(this,"text");h(this,"fgColor");h(this,"bgColor");h(this,"fontSize");h(this,"padding");h(this,"height");h(this,"cornerRadius");h(this,"icon");h(this,"xOffset");h(this,"yOffset");this.text=t,this.fgColor=i,this.bgColor=s,this.fontSize=n,this.padding=o,this.height=r,this.cornerRadius=a,l&&(this.icon=new LGraphIcon(l)),this.xOffset=d,this.yOffset=u}get visible(){var t;return(((t=this.text)==null?void 0:t.length)??0)>0||!!this.icon}getWidth(t){if(!this.visible)return 0;const{font:i}=t;let s=0;this.icon&&(t.font=`${this.icon.fontSize}px '${this.icon.fontFamily}'`,s=t.measureText(this.icon.unicode).width+this.padding),t.font=`${this.fontSize}px sans-serif`;const n=this.text?t.measureText(this.text).width:0;return t.font=i,s+n+this.padding*2}draw(t,i,s){if(!this.visible)return;i+=this.xOffset,s+=this.yOffset;const{font:n,fillStyle:o,textBaseline:r,textAlign:a}=t;t.font=`${this.fontSize}px sans-serif`;const l=this.getWidth(t),d=0;t.fillStyle=this.bgColor,t.beginPath(),t.roundRect?t.roundRect(i+d,s,l,this.height,this.cornerRadius):t.rect(i+d,s,l,this.height),t.fill();let u=i+d+this.padding;const p=s+this.height/2;this.icon&&(this.icon.draw(t,u,p),u+=this.icon.fontSize+this.padding/2+4),this.text&&(t.fillStyle=this.fgColor,t.textBaseline="middle",t.textAlign="left",t.fillText(this.text,u,p+1)),t.font=n,t.fillStyle=o,t.textBaseline=r,t.textAlign=a}}class LGraphButton extends LGraphBadge{constructor(i){super(i);h(this,"name");h(this,"_last_area",new Rectangle);this.name=i.name}getWidth(i){if(!this.visible)return 0;const{font:s}=i;i.font=`${this.fontSize}px 'PrimeIcons'`;const n=this.text?i.measureText(this.text).width:0;return i.font=s,n}draw(i,s,n){if(!this.visible)return;const o=this.getWidth(i);this._last_area[0]=s+this.xOffset,this._last_area[1]=n+this.yOffset,this._last_area[2]=o,this._last_area[3]=this.height;const r=s+this.xOffset,a=n+this.yOffset,{font:l,fillStyle:d,textBaseline:u,textAlign:p}=i,f=i.fillStyle||"white";i.font=`${this.fontSize}px 'PrimeIcons'`,i.fillStyle=f,i.textBaseline="middle",i.textAlign="center";const g=r+o/2,m=a+this.height/2;this.text&&i.fillText(this.text,g,m),i.font=l,i.fillStyle=d,i.textBaseline=u,i.textAlign=p}isPointInside(i,s){return this._last_area.containsPoint([i,s])}}const ELLIPSIS="â€¦",TWO_DOT_LEADER="â€¥",ONE_DOT_LEADER="â€¤";var SlotType=(c=>(c.Array="array",c[c.Event=-1]="Event",c))(SlotType||{}),SlotShape=(c=>(c[c.Box=RenderShape.BOX]="Box",c[c.Arrow=RenderShape.ARROW]="Arrow",c[c.Grid=RenderShape.GRID]="Grid",c[c.Circle=RenderShape.CIRCLE]="Circle",c[c.HollowCircle=RenderShape.HollowCircle]="HollowCircle",c))(SlotShape||{}),SlotDirection=(c=>(c[c.Up=LinkDirection.UP]="Up",c[c.Right=LinkDirection.RIGHT]="Right",c[c.Down=LinkDirection.DOWN]="Down",c[c.Left=LinkDirection.LEFT]="Left",c))(SlotDirection||{}),LabelPosition=(c=>(c.Left="left",c.Right="right",c))(LabelPosition||{});function strokeShape(c,t,{shape:i=RenderShape.BOX,round_radius:s,title_height:n,title_mode:o=TitleMode.NORMAL_TITLE,color:r,padding:a=6,collapsed:l=!1,lineWidth:d=1}={}){if(s??(s=LiteGraph.ROUND_RADIUS),r??(r=LiteGraph.NODE_BOX_OUTLINE_COLOR),o===TitleMode.TRANSPARENT_TITLE){const y=n??LiteGraph.NODE_TITLE_HEIGHT;t[1]-=y,t[3]+=y}const{lineWidth:u,strokeStyle:p}=c;c.lineWidth=d,c.globalAlpha=.8,c.strokeStyle=r,c.beginPath();const[f,g,m,_]=t;switch(i){case RenderShape.BOX:{c.rect(f-a,g-a,m+2*a,_+2*a);break}case RenderShape.ROUND:case RenderShape.CARD:{const y=s+a,L=i===RenderShape.CARD&&l||i===RenderShape.ROUND?[y]:[y,2,y,2];c.roundRect(f-a,g-a,m+2*a,_+2*a,L);break}case RenderShape.CIRCLE:{const y=f+m/2,b=g+_/2,L=Math.max(m,_)/2+a;c.arc(y,b,L,0,Math.PI*2);break}}c.stroke(),c.lineWidth=u,c.strokeStyle=p,c.globalAlpha=1}function truncateTextToWidth(c,t,i){if(!(i>0))return"";if(c.measureText(t).width<=i)return t;const n=c.measureText(ELLIPSIS).width*.75;if(n>i)return c.measureText(TWO_DOT_LEADER).width*.75<i?TWO_DOT_LEADER:c.measureText(ONE_DOT_LEADER).width*.75<i?ONE_DOT_LEADER:"";let o=0,r=t.length,a=0;for(;o<=r;){const l=Math.floor((o+r)*.5);if(l===0){o=l+1;continue}const d=t.substring(0,l);c.measureText(d).width+n<=i?(a=l,o=l+1):r=l-1}return a===0?ELLIPSIS:t.substring(0,a)+ELLIPSIS}function drawTextInArea({ctx:c,text:t,area:i,align:s="left"}){const{left:n,right:o,bottom:r,width:a,centreX:l}=i;if(c.measureText(t).width<=a){c.textAlign=s;const f=s==="left"?n:s==="right"?o:l;c.fillText(t,f,r);return}const u=truncateTextToWidth(c,t,a);if(u.length===0)return;c.textAlign="left",c.fillText(u.slice(0,-1),n,r),c.rect(n,r,a,1),c.textAlign="right";const p=u.at(-1);c.fillText(p,o,r,c.measureText(p).width*.75)}class SlotBase{constructor(t,i,s){h(this,"name");h(this,"localized_name");h(this,"label");h(this,"type");h(this,"dir");h(this,"removable");h(this,"shape");h(this,"color_off");h(this,"color_on");h(this,"locked");h(this,"nameLocked");h(this,"widget");h(this,"_floatingLinks");h(this,"hasErrors");h(this,"boundingRect");this.name=t,this.type=i,this.boundingRect=s??new Rectangle}renderingColor(t){return this.isConnected?this.color_on||t.getConnectedColor(this.type):this.color_off||t.getDisconnectedColor(this.type)}}class NodeSlot extends SlotBase{constructor(i,s){const n=i,{boundingRect:o,name:r,type:a,_listenerController:l,...d}=n,u=o?Rectangle.ensureRect(o):new Rectangle;super(r,a,u);P(this,Oe);h(this,"pos");P(this,oe);Object.assign(this,d),z(this,oe,s)}get node(){return S(this,oe)}get highlightColor(){return LiteGraph.NODE_TEXT_HIGHLIGHT_COLOR??LiteGraph.NODE_SELECTED_TITLE_COLOR??LiteGraph.NODE_TEXT_COLOR}get renderingLabel(){return this.label||this.localized_name||this.name||""}draw(i,{colorContext:s,labelPosition:n=LabelPosition.Right,lowQuality:o=!1,highlight:r=!1,doStroke:a=!1}){const l=i.fillStyle,d=i.strokeStyle,u=i.lineWidth,p=r?this.highlightColor:LiteGraph.NODE_TEXT_COLOR,f=S(this,Oe,ci),g=this.type,m=g===SlotType.Array?SlotShape.Grid:this.shape;i.beginPath();let _=!0;if(i.fillStyle=this.renderingColor(s),i.lineWidth=1,g===SlotType.Event||m===SlotShape.Box)i.rect(f[0]-6+.5,f[1]-5+.5,14,10);else if(m===SlotShape.Arrow)i.moveTo(f[0]+8,f[1]+.5),i.lineTo(f[0]-4,f[1]+6+.5),i.lineTo(f[0]-4,f[1]-6+.5),i.closePath();else if(m===SlotShape.Grid){for(let T=0;T<3;T++)for(let I=0;I<3;I++)i.rect(f[0]-4+T*3,f[1]-4+I*3,2,2);a=!1}else if(o)i.rect(f[0]-4,f[1]-4,8,8);else{let b;m===SlotShape.HollowCircle?(_=!1,a=!0,i.lineWidth=3,i.strokeStyle=i.fillStyle,b=r?4:3):b=r?5:4,i.arc(f[0],f[1],b,0,Math.PI*2)}if(_&&i.fill(),!o&&a&&i.stroke(),!(o||this.isWidgetInputSlot)){const b=this.renderingLabel;b&&(i.fillStyle=p,n===LabelPosition.Right?this.dir==LinkDirection.UP?i.fillText(b,f[0],f[1]-10):i.fillText(b,f[0]+10,f[1]+5):this.dir==LinkDirection.DOWN?i.fillText(b,f[0],f[1]-8):i.fillText(b,f[0]-10,f[1]+5))}this.hasErrors&&(i.lineWidth=2,i.strokeStyle="red",i.beginPath(),i.arc(f[0],f[1],12,0,Math.PI*2),i.stroke()),i.fillStyle=l,i.strokeStyle=d,i.lineWidth=u}drawCollapsed(i){const[s,n]=this.collapsedPos,{fillStyle:o}=i;i.fillStyle="#686",i.beginPath(),this.type===SlotType.Event||this.shape===RenderShape.BOX?i.rect(s-7+.5,n-4,14,8):this.shape===RenderShape.ARROW?(this instanceof NodeInputSlot?(i.moveTo(s+8,n),i.lineTo(s-4,n-4),i.lineTo(s-4,n+4)):(i.moveTo(s+6,n),i.lineTo(s-6,n-4),i.lineTo(s-6,n+4)),i.closePath()):i.arc(s,n,4,0,Math.PI*2),i.fill(),i.fillStyle=o}}Oe=new WeakSet,ci=function(){const i=this.node.pos,{boundingRect:s}=this,n=s[3];return getCentre([s[0]-i[0],s[1]-i[1],n,n])},oe=new WeakMap;const st=class st{constructor(t,i){h(this,"id");h(this,"color");h(this,"title");h(this,"font");h(this,"font_size",LiteGraph.DEFAULT_GROUP_FONT||24);h(this,"_bounding",new Float32Array([10,10,st.minWidth,st.minHeight]));h(this,"_pos",this._bounding.subarray(0,2));h(this,"_size",this._bounding.subarray(2,4));h(this,"_nodes",[]);h(this,"_children",new Set);h(this,"graph");h(this,"flags",{});h(this,"selected");h(this,"isPointInside",LGraphNode.prototype.isPointInside);h(this,"setDirtyCanvas",LGraphNode.prototype.setDirtyCanvas);this.id=i??-1,this.title=t||"Group";const{pale_blue:s}=LGraphCanvas.node_colors;this.color=s?s.groupcolor:"#AAA"}setColorOption(t){t==null?delete this.color:this.color=t.groupcolor}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.groupcolor===this.color)??null}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=Math.max(st.minWidth,t[0]),this._size[1]=Math.max(st.minHeight,t[1]))}get boundingRect(){return this._bounding}get nodes(){return this._nodes}get titleHeight(){return this.font_size*1.4}get children(){return this._children}get pinned(){return!!this.flags.pinned}pin(t){(t===void 0?!this.pinned:t)?this.flags.pinned=!0:delete this.flags.pinned}unpin(){this.pin(!1)}configure(t){this.id=t.id,this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.flags=t.flags||this.flags,t.font_size&&(this.font_size=t.font_size)}serialize(){const t=this._bounding;return{id:this.id,title:this.title,bounding:[...t],color:this.color,font_size:this.font_size,flags:this.flags}}draw(t,i){const{padding:s,resizeLength:n,defaultColour:o}=st,r=this.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,[a,l]=this._pos,[d,u]=this._size,p=this.color||o;i.globalAlpha=.25*t.editor_alpha,i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,d,r*1.4),i.fill(),i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,d,u),i.fill(),i.globalAlpha=t.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(a+d,l+u),i.lineTo(a+d-n,l+u),i.lineTo(a+d,l+u-n),i.fill(),i.font=`${r}px ${LiteGraph.GROUP_FONT}`,i.textAlign="left",i.fillText(this.title+(this.pinned?"ðŸ“Œ":""),a+s,l+r),LiteGraph.highlight_selected_group&&this.selected&&strokeShape(i,this._bounding,{title_height:this.titleHeight,padding:s})}resize(t,i){return this.pinned?!1:(this._size[0]=Math.max(st.minWidth,t),this._size[1]=Math.max(st.minHeight,i),!0)}move(t,i,s=!1){if(!this.pinned&&(this._pos[0]+=t,this._pos[1]+=i,s!==!0))for(const n of this._children)n.move(t,i)}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}recomputeInsideNodes(){if(!this.graph)throw new NullGraphError;const{nodes:t,reroutes:i,groups:s}=this.graph,n=this._children;this._nodes.length=0,n.clear();for(const o of t)containsCentre(this._bounding,o.boundingRect)&&(this._nodes.push(o),n.add(o));for(const o of i.values())isPointInRect(o.pos,this._bounding)&&n.add(o);for(const o of s)containsRect(this._bounding,o._bounding)&&n.add(o);s.sort((o,r)=>o===this?n.has(r)?-1:0:r===this&&n.has(o)?1:0)}resizeTo(t,i=10){const s=createBounds(t,i);s!==null&&(this.pos[0]=s[0],this.pos[1]=s[1]-this.titleHeight,this.size[0]=s[2],this.size[1]=s[3]+this.titleHeight)}addNodes(t,i=10){!this._nodes&&t.length===0||this.resizeTo([...this.children,...this._nodes,...t],i)}getMenuOptions(){return[{content:this.pinned?"Unpin":"Pin",callback:()=>{this.pinned?this.unpin():this.pin(),this.setDirtyCanvas(!1,!0)}},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}isPointInTitlebar(t,i){const s=this.boundingRect;return isInRectangle(t,i,s[0],s[1],s[2],this.titleHeight)}isInResize(t,i){const s=this.boundingRect,n=s[0]+s[2],o=s[1]+s[3];return t<n&&i<o&&t-n+(i-o)>-st.resizeLength}};h(st,"minWidth",140),h(st,"minHeight",80),h(st,"resizeLength",10),h(st,"padding",4),h(st,"defaultColour","#335");let LGraphGroup=st;const q=class q{constructor(t,i,s,n,o,r){P(this,Et);P(this,Ht,new Float32Array(8));P(this,et);P(this,ct);h(this,"floating");P(this,ut,S(this,Ht).subarray(0,2));h(this,"selected");h(this,"linkIds");h(this,"floatingLinkIds");h(this,"cos",0);h(this,"sin",0);h(this,"controlPoint",S(this,Ht).subarray(4,6));h(this,"path");h(this,"_centreAngle");h(this,"_pos",S(this,Ht).subarray(6,8));h(this,"_dragging");h(this,"_colour");P(this,re,-1/0);P(this,Rt,new RerouteSlot(this,!0));P(this,Gt,new RerouteSlot(this,!1));this.id=t,z(this,et,new WeakRef(i)),this.parentId=n,s&&(this.pos=s),this.linkIds=new Set(o),this.floatingLinkIds=new Set(r)}static get slotOffset(){const t=q.slotRadius*.33;return q.radius+t+q.slotRadius}get parentId(){return S(this,ct)}set parentId(t){t!==this.id&&this.getReroutes()!==null&&z(this,ct,t)}get parent(){var t;return(t=S(this,et).deref())==null?void 0:t.getReroute(S(this,ct))}get pos(){return S(this,ut)}set pos(t){if(!((t==null?void 0:t.length)>=2))throw new TypeError("Reroute.pos is an x,y point, and expects an indexable with at least two values.");S(this,ut)[0]=t[0],S(this,ut)[1]=t[1]}get boundingRect(){const{radius:t}=q,[i,s]=S(this,ut);return[i-t,s-t,2*t,2*t]}get totalLinks(){return this.linkIds.size+this.floatingLinkIds.size}get colour(){return this._colour??"#18184d"}get isSlotHovered(){return this.isInputHovered||this.isOutputHovered}get isInputHovered(){return S(this,Rt).hovering}get isOutputHovered(){return S(this,Gt).hovering}get firstLink(){var i;const t=this.linkIds.values().next().value;return t===void 0||(i=S(this,et).deref())==null?void 0:i.links.get(t)}get firstFloatingLink(){var i;const t=this.floatingLinkIds.values().next().value;return t===void 0||(i=S(this,et).deref())==null?void 0:i.floatingLinks.get(t)}get origin_id(){var t;return(t=this.firstLink)==null?void 0:t.origin_id}get origin_slot(){var t;return(t=this.firstLink)==null?void 0:t.origin_slot}update(t,i,s,n){this.parentId=t,i&&(this.pos=i),s&&(this.linkIds=new Set(s)),this.floating=n}validateLinks(t,i){const{linkIds:s,floatingLinkIds:n}=this;for(const o of s)t.has(o)||s.delete(o);for(const o of n)i.has(o)||n.delete(o);return s.size>0||n.size>0}getReroutes(t=new Set){var n;if(S(this,ct)===void 0)return[this];if(t.has(this))return null;t.add(this);const i=(n=S(this,et).deref())==null?void 0:n.reroutes.get(S(this,ct));if(!i)return z(this,ct,void 0),[this];const s=i.getReroutes(t);return s==null||s.push(this),s}findNextReroute(t,i=new Set){var s,n;if(S(this,ct)===t)return this;if(i.has(this))return null;if(i.add(this),S(this,ct)!==void 0)return(n=(s=S(this,et).deref())==null?void 0:s.reroutes.get(S(this,ct)))==null?void 0:n.findNextReroute(t,i)}findSourceOutput(){var s;const t=this.firstLink??this.firstFloatingLink;if(!t)return;const i=(s=S(this,et).deref())==null?void 0:s.getNodeById(t.origin_id);if(i)return{node:i,output:i.outputs[t.origin_slot]}}findTargetInputs(){const t=S(this,et).deref();if(!t)return;const i=[];return s(t,this.linkIds,t.links),s(t,this.floatingLinkIds,t.floatingLinks),i;function s(n,o,r){for(const a of o){const l=r.get(a);if(!l)continue;const d=n.getNodeById(l.target_id),u=d==null?void 0:d.inputs[l.target_slot];u&&i.push({node:d,input:u,link:l})}}}getFloatingLinks(t){var o;const i=(o=S(this,et).deref())==null?void 0:o.floatingLinks;if(!i)return;const s=t==="input"?"origin_id":"target_id",n=[];for(const r of this.floatingLinkIds){const a=i.get(r);(a==null?void 0:a[s])===-1&&n.push(a)}return n}setFloatingLinkOrigin(t,i,s){var r,a,l;const n=S(this,et).deref(),o=this.getFloatingLinks("output");if(!o)throw new Error("[setFloatingLinkOrigin]: Invalid network.");if(o.length){i._floatingLinks??(i._floatingLinks=new Set);for(const d of o)i._floatingLinks.add(d),(l=(a=(r=n==null?void 0:n.getNodeById(d.origin_id))==null?void 0:r.outputs[d.origin_slot])==null?void 0:a._floatingLinks)==null||l.delete(d),d.origin_id=t.id,d.origin_slot=s}}move(t,i){S(this,ut)[0]+=t,S(this,ut)[1]+=i}snapToGrid(t){if(!t)return!1;const{pos:i}=this;return i[0]=t*Math.round(i[0]/t),i[1]=t*Math.round(i[1]/t),!0}removeAllFloatingLinks(){for(const t of this.floatingLinkIds)this.removeFloatingLink(t)}removeFloatingLink(t){const i=S(this,et).deref();if(!i)return;const s=i.floatingLinks.get(t);if(!s){console.warn(`[Reroute.removeFloatingLink] Floating link not found: ${t}, ignoring and discarding ID.`),this.floatingLinkIds.delete(t);return}i.removeFloatingLink(s)}removeLink(t){const i=S(this,et).deref();if(!i)return;const s=i.floatingLinks.get(t.id);t===s?this.floatingLinkIds.delete(t.id):this.linkIds.delete(t.id)}remove(){const t=S(this,et).deref();t&&t.removeReroute(this.id)}calculateAngle(t,i,s){if(!(t>S(this,re)))return;z(this,re,t);const{id:n,pos:o}=this,r=[];let a=0;if(m(this.linkIds,i.links),m(this.floatingLinkIds,i.floatingLinks),!r.length){this.cos=0,this.sin=0,this.controlPoint[0]=0,this.controlPoint[1]=0;return}a/=r.length;const l=Math.atan2(S(this,ut)[1]-s[1],S(this,ut)[0]-s[0]);let d=(l-a)*.5;Math.abs(d)>Math.PI*.5&&(d+=Math.PI);const u=Math.min(q.maxSplineOffset,distance(s,S(this,ut))*.25),p=l-d,f=Math.cos(p),g=Math.sin(p);this.cos=f,this.sin=g,this.controlPoint[0]=u*-f,this.controlPoint[1]=u*-g;function m(_,y){for(const b of _){const L=y.get(b),k=getNextPos(i,L,n);if(!k)continue;const T=getDirection(o,k);r.push(T),a+=T}}}draw(t,i){const{globalAlpha:s}=t,{pos:n}=this;if(t.beginPath(),t.arc(n[0],n[1],q.radius,0,2*Math.PI),this.linkIds.size===0&&(t.fillStyle=i??"#797979",t.fill(),t.globalAlpha=s*.33),t.fillStyle=this.colour,t.lineWidth=q.radius*.1,t.strokeStyle="rgb(0,0,0,0.5)",t.fill(),t.stroke(),t.fillStyle="#ffffff55",t.strokeStyle="rgb(0,0,0,0.3)",t.beginPath(),t.arc(n[0],n[1],q.radius*.8,0,2*Math.PI),t.fill(),t.stroke(),this.selected&&(t.strokeStyle="#fff",t.beginPath(),t.arc(n[0],n[1],q.radius*1.2,0,2*Math.PI),t.stroke()),q.drawIdBadge){const o=new LGraphBadge({text:this.id.toString()}),r=n[0]-o.getWidth(t)*.5,a=n[1]-o.height-q.radius-2;o.draw(t,r,a)}t.globalAlpha=s}drawSlots(t){S(this,Rt).draw(t),S(this,Gt).draw(t)}drawHighlight(t,i){const{pos:s}=this,{strokeStyle:n,lineWidth:o}=t;t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(s[0],s[1],q.radius*1.5,0,2*Math.PI),t.stroke(),t.strokeStyle=n,t.lineWidth=o}updateVisibility(t){const i=S(this,Rt),s=S(this,Gt);i.dirty=!1,s.dirty=!1;const{firstFloatingLink:n}=this,o=!!this.firstLink,r=o||(n==null?void 0:n.isFloatingOutput),a=o||(n==null?void 0:n.isFloatingInput);if((r||a)&&isPointInRect(t,S(this,Et,je))){const d=C(this,Et,Ke).call(this,t);r&&i.update(t,d),a&&s.update(t,d)}else this.hideSlots();return i.dirty||s.dirty}hideSlots(){S(this,Rt).hide(),S(this,Gt).hide()}containsPoint(t){return isPointInRect(t,S(this,Et,je))&&C(this,Et,Ke).call(this,t)}asSerialisable(){const{id:t,parentId:i,pos:s,linkIds:n}=this;return{id:t,parentId:i,pos:[s[0],s[1]],linkIds:[...n],floating:this.floating?{slotType:this.floating.slotType}:void 0}}};Ht=new WeakMap,et=new WeakMap,ct=new WeakMap,ut=new WeakMap,Et=new WeakSet,je=function(){const t=2*q.slotOffset,i=2*Math.max(q.radius,q.slotRadius),[s,n]=S(this,ut);return[s-t,n-i,2*t,2*i]},re=new WeakMap,Rt=new WeakMap,Gt=new WeakMap,Ke=function(t){return distance(this.pos,t)<=q.radius},h(q,"radius",10),h(q,"maxSplineOffset",80),h(q,"drawIdBadge",!1),h(q,"slotRadius",5);let Reroute=q;class RerouteSlot{constructor(t,i){P(this,Ut);P(this,ae);h(this,"dirty",!1);P(this,$t,!1);P(this,Xt,!1);z(this,Ut,t),z(this,ae,i?-1:1)}get pos(){const[t,i]=S(this,Ut).pos;return[t+Reroute.slotOffset*S(this,ae),i]}get hovering(){return S(this,$t)}set hovering(t){Object.is(S(this,$t),t)||(z(this,$t,t),this.dirty=!0)}get showOutline(){return S(this,Xt)}set showOutline(t){Object.is(S(this,Xt),t)||(z(this,Xt,t),this.dirty=!0)}update(t,i){if(i)this.hovering=!1,this.showOutline=!0;else{const s=distance(this.pos,t);this.hovering=s<=2*Reroute.slotRadius,this.showOutline=s<=5*Reroute.slotRadius}}hide(){this.hovering=!1,this.showOutline=!1}draw(t){const{fillStyle:i,strokeStyle:s,lineWidth:n}=t,{showOutline:o,hovering:r,pos:[a,l]}=this;if(o)try{t.fillStyle=r?S(this,Ut).colour:"rgba(127,127,127,0.3)",t.strokeStyle="rgb(0,0,0,0.5)",t.lineWidth=1,t.beginPath(),t.arc(a,l,Reroute.slotRadius,0,2*Math.PI),t.fill(),t.stroke()}finally{t.fillStyle=i,t.strokeStyle=s,t.lineWidth=n}}}Ut=new WeakMap,ae=new WeakMap,$t=new WeakMap,Xt=new WeakMap;function getNextPos(c,t,i){var n,o;if(!t)return;const s=(n=LLink.findNextReroute(c,t,i))==null?void 0:n.pos;if(s)return s;if(!(t.target_id===-1||t.target_slot===-1))return(o=c.getNodeById(t.target_id))==null?void 0:o.getInputPos(t.target_slot)}function getDirection(c,t){return Math.atan2(t[1]-c[1],t[0]-c[0])}function stringOrEmpty(c){return c==null?"":String(c)}function parseSlotTypes(c){return c==""||c=="0"?["*"]:String(c).toLowerCase().split(",")}function nextUniqueName(c,t=[]){let i=1;const s=c;for(;t.includes(c);)c=`${s}_${i++}`;return c}const De=class De{constructor(t,i){P(this,Yt,0);P(this,jt,0);P(this,le,0);P(this,he,0);h(this,"minWidth",0);h(this,"minHeight",0);h(this,"maxWidth",1/0);h(this,"maxHeight",1/0);this.desiredWidth=t,this.desiredHeight=i}get width(){return S(this,Yt)}get height(){return S(this,jt)}get desiredWidth(){return S(this,le)}set desiredWidth(t){z(this,le,t),z(this,Yt,clamp(t,this.minWidth,this.maxWidth))}get desiredHeight(){return S(this,he)}set desiredHeight(t){z(this,he,t),z(this,jt,clamp(t,this.minHeight,this.maxHeight))}static fromSize(t){return new De(t[0],t[1])}static fromRect(t){return new De(t[2],t[3])}setSize(t){this.desiredWidth=t[0],this.desiredHeight=t[1]}setValues(t,i){this.desiredWidth=t,this.desiredHeight=i}toSize(){return[S(this,Yt),S(this,jt)]}};Yt=new WeakMap,jt=new WeakMap,le=new WeakMap,he=new WeakMap;let ConstrainedSize=De;const qt=class qt extends SlotBase{constructor(i,s){super(i.name,i.type);P(this,Kt,new Float32Array(2));h(this,"measurement",new ConstrainedSize(qt.defaultHeight,qt.defaultHeight));h(this,"id");h(this,"parent");h(this,"type");h(this,"linkIds",[]);h(this,"boundingRect",new Rectangle(0,0,0,qt.defaultHeight));h(this,"isPointerOver",!1);Object.assign(this,i),this.id=i.id??createUuidv4(),this.type=i.type,this.parent=s}static get defaultHeight(){return LiteGraph.NODE_SLOT_HEIGHT}get pos(){return S(this,Kt)}set pos(i){!i||i.length<2||(S(this,Kt)[0]=i[0],S(this,Kt)[1]=i[1])}get isConnected(){return this.linkIds.length>0}get displayName(){return this.label??this.localized_name??this.name}containsPoint(i){return this.boundingRect.containsPoint(i)}onPointerMove(i){this.isPointerOver=this.boundingRect.containsXy(i.canvasX,i.canvasY)}getLinks(){const i=[],{subgraph:s}=this.parent;for(const n of this.linkIds){const o=s.getLink(n);o&&i.push(o)}return i}decrementSlots(i){const{links:s}=this.parent.subgraph,n=i==="inputs"?"origin_slot":"target_slot";for(const o of this.linkIds){const r=s.get(o);r?r[n]--:console.warn("decrementSlots: link ID not found",o)}}measure(){var n;const i=((n=LGraphCanvas._measureText)==null?void 0:n.call(LGraphCanvas,this.displayName))??0,{defaultHeight:s}=qt;return this.measurement.setValues(i+s,s),this.measurement.toSize()}disconnect(){const{subgraph:i}=this.parent;for(const s of this.linkIds)i.removeLink(s);this.linkIds.length=0}draw({ctx:i,colorContext:s,lowQuality:n,fromSlot:o,editorAlpha:r=1}){const a=this.shape,{isPointerOver:l,pos:[d,u]}=this,p=o?this.isValidTarget(o):!0,f=!o||p,g=f&&l,m=i.globalAlpha;i.globalAlpha=f?r:.4*r,i.beginPath();const _=this.renderingColor(s);if(n)i.fillStyle=_,i.rect(d-4,u-4,8,8),i.fill();else if(a===SlotShape.HollowCircle){i.lineWidth=3,i.strokeStyle=_;const y=g?4:3;i.arc(d,u,y,0,Math.PI*2),i.stroke()}else{i.fillStyle=_;const y=g?5:4;i.arc(d,u,y,0,Math.PI*2),i.fill()}if(this.displayName){const[y,b]=this.labelPos;i.fillStyle=g?"white":LiteGraph.NODE_TEXT_COLOR||"#AAA",i.fillText(this.displayName,y,b)}i.globalAlpha=m}asSerialisable(){const{id:i,name:s,type:n,linkIds:o,localized_name:r,label:a,dir:l,shape:d,color_off:u,color_on:p,pos:f}=this;return{id:i,name:s,type:n,linkIds:o,localized_name:r,label:a,dir:l,shape:d,color_off:u,color_on:p,pos:f}}};Kt=new WeakMap;let SubgraphSlot=qt;class SubgraphOutput extends SubgraphSlot{connect(t,i,s){var u,p,f;const{subgraph:n}=this.parent;if(!LiteGraph.isValidConnection(t.type,this.type))return;const o=i.outputs.indexOf(t);if(o===-1)throw new Error("Slot is not an output of the given node");if(((u=i.onConnectOutput)==null?void 0:u.call(i,o,this.type,this,this.parent,-1))===!1)return;const r=this.getLinks().at(0);if(r!=null){n.beforeChange(),r.disconnect(n,"input");const m=(p=r.resolve(n).output)==null?void 0:p.links;m&&removeFromArray(m,r.id)}const a=new LLink(++n.state.lastLinkId,t.type,i.id,o,this.parent.id,this.parent.slots.indexOf(this),s);n._links.set(a.id,a),this.linkIds[0]=a.id,t.links??(t.links=[]),t.links.push(a.id);const l=LLink.getReroutes(n,a);for(const g of l)g.linkIds.add(a.id),g.floating&&delete g.floating,g._dragging=void 0;const d=l.at(-1);if(d)for(const g of d.floatingLinkIds){const m=n.floatingLinks.get(g);(m==null?void 0:m.parentId)===d.id&&n.removeFloatingLink(m)}return n._version++,(f=i.onConnectionsChange)==null||f.call(i,NodeSlotType.OUTPUT,o,!0,a,t),n.afterChange(),a}get labelPos(){const[t,i,,s]=this.boundingRect;return[t+s,i+s*.5]}arrange(t){const[i,s,n,o]=t,{boundingRect:r,pos:a}=this;r[0]=i,r[1]=s,r[2]=n,r[3]=o,a[0]=i+o*.5,a[1]=s+o*.5}isValidTarget(t){return isNodeSlot(t)?"links"in t&&LiteGraph.isValidConnection(t.type,this.type):isSubgraphInput(t)?LiteGraph.isValidConnection(t.type,this.type):!1}}class EmptySubgraphOutput extends SubgraphOutput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,s){const{subgraph:n}=this.parent,o=n.outputs.map(l=>l.name),r=nextUniqueName(t.name,o);return n.addOutput(r,String(t.type)).connect(t,i,s)}get labelPos(){const[t,i,,s]=this.boundingRect;return[t,i+s*.5]}}const Jt=class Jt{constructor(t){P(this,Zt);P(this,de,new Rectangle);h(this,"selected",!1);h(this,"pinned",!1);h(this,"removable",!1);h(this,"isPointerOver",!1);this.subgraph=t}get boundingRect(){return S(this,de)}get pos(){return this.boundingRect.pos}set pos(t){this.boundingRect.pos=t}get size(){return this.boundingRect.size}set size(t){this.boundingRect.size=t}get sideLineWidth(){return this.isPointerOver?2.5:2}get sideStrokeStyle(){return this.isPointerOver?"white":"#efefef"}move(t,i){this.pos[0]+=t,this.pos[1]+=i}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}containsPoint(t){return this.boundingRect.containsPoint(t)}onPointerMove(t){const i=this.boundingRect.containsXy(t.canvasX,t.canvasY);let s=i?CanvasItem.SubgraphIoNode:CanvasItem.Nothing;if(i){this.isPointerOver||this.onPointerEnter();for(const n of this.allSlots)n.onPointerMove(t),n.isPointerOver&&(s|=CanvasItem.SubgraphIoSlot)}else this.isPointerOver&&this.onPointerLeave();return s}onPointerEnter(){this.isPointerOver=!0}onPointerLeave(){this.isPointerOver=!1;for(const t of this.slots)t.isPointerOver=!1}getSlotInPosition(t,i){for(const s of this.allSlots)if(s.boundingRect.containsXy(t,i))return s}showSlotContextMenu(t,i){const s=C(this,Zt,pi).call(this,t);s.length>0&&new LiteGraph.ContextMenu(s,{event:i,title:t.name||"Subgraph Output",callback:n=>{C(this,Zt,fi).call(this,n,t,i)}})}arrange(){const{minWidth:t,roundedRadius:i}=Jt,[,s]=this.boundingRect,n=this.slotAnchorX,{size:o}=this;let r=t,a=s+i;for(const l of this.allSlots){const[d,u]=l.measure();l.arrange([n,a,d,u]),a+=u,d>r&&(r=d)}o[0]=r+2*i,o[1]=a-s+i}draw(t,i,s,n){const{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:d}=t;this.drawProtected(t,i,s,n),Object.assign(t,{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:d})}drawSlots(t,i,s,n){t.fillStyle="#AAA",t.font="12px Arial",t.textBaseline="middle";for(const o of this.allSlots)o.draw({ctx:t,colorContext:i,fromSlot:s,editorAlpha:n})}configure(t){S(this,de).set(t.bounding),this.pinned=t.pinned??!1}asSerialisable(){return{id:this.id,bounding:this.boundingRect.export(),pinned:this.pinned?!0:void 0}}};de=new WeakMap,Zt=new WeakSet,pi=function(t){const i=[];return t!==this.emptySlot&&t.linkIds.length>0&&i.push({content:"Disconnect Links",value:"disconnect"}),t!==this.emptySlot&&i.push({content:"Remove Slot",value:"remove"},{content:"Rename Slot",value:"rename"}),i},fi=function(t,i,s){switch(t.value){case"disconnect":i.disconnect();break;case"remove":i!==this.emptySlot&&this.removeSlot(i);break;case"rename":i!==this.emptySlot&&this.subgraph.canvasAction(n=>n.prompt("Slot name",i.name,o=>{o&&this.renameSlot(i,o)},s));break}this.subgraph.setDirtyCanvas(!0)},h(Jt,"margin",10),h(Jt,"minWidth",100),h(Jt,"roundedRadius",10);let SubgraphIONodeBase=Jt;class SubgraphOutputNode extends SubgraphIONodeBase{constructor(){super(...arguments);h(this,"id",SUBGRAPH_OUTPUT_ID);h(this,"emptySlot",new EmptySubgraphOutput(this))}get slots(){return this.subgraph.outputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i]=this.boundingRect;return i+SubgraphIONodeBase.roundedRadius}onPointerDown(i,s,n){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(s.onDragStart=()=>{n.dragNewFromSubgraphOutput(this.subgraph,this,o)},s.onDragEnd=a=>{n.dropLinks(this.subgraph,a)},s.finally=()=>{n.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,s){this.subgraph.renameOutput(i,s)}removeSlot(i){this.subgraph.removeOutput(i)}canConnectTo(i,s,n){return i.canConnectTo(this,s,n)}connectByTypeOutput(i,s,n,o){const r=s.findOutputByType(n);if(r)return this.slots[i].connect(r.slot,s,o==null?void 0:o.afterRerouteId)}findInputByType(i){var s;return(s=findFreeSlotOfType(this.slots,i,n=>n.linkIds.length>0))==null?void 0:s.slot}drawProtected(i,s,n,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,d,,u]=this.boundingRect;i.translate(l,d),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(r,r,r,Math.PI,Math.PI*1.5),i.moveTo(0,r),i.lineTo(0,u-r),i.arc(r,u-r,r,Math.PI,Math.PI*.5,!0),i.stroke(),i.setTransform(a),this.drawSlots(i,s,n,o)}}function splitPositionables(c){const t=new Set,i=new Set,s=new Set,n=new Set,o=new Set,r=new Set;for(const a of c)switch(!0){case a instanceof LGraphNode:t.add(a);break;case a instanceof LGraphGroup:s.add(a);break;case a instanceof Reroute:i.add(a);break;case a instanceof SubgraphInputNode:n.add(a);break;case a instanceof SubgraphOutputNode:o.add(a);break;default:r.add(a);break}return{nodes:t,reroutes:i,groups:s,subgraphInputNodes:n,subgraphOutputNodes:o,unknown:r}}function getBoundaryLinks(c,t){const i=[],s=[],n=[],o=[],r=[],a=new WeakSet;for(const d of t)if(!a.has(d)){if(a.add(d),d instanceof LGraphNode){const u=d;if(u.inputs)for(const p of u.inputs){if(l(p._floatingLinks),p.link==null)continue;const f=LLink.resolve(p.link,c);if(!f){console.debug(`Failed to resolve link ID [${p.link}]`);continue}const{link:g,outputNode:m}=f;m?t.has(m)?i.push(g):n.push(g):g.origin_id===SUBGRAPH_INPUT_ID&&n.push(g)}if(u.outputs)for(const p of u.outputs){if(l(p._floatingLinks),!p.links)continue;const f=LLink.resolveMany(p.links,c);for(const{link:g,inputNode:m}of f)(g.target_id===SUBGRAPH_OUTPUT_ID||m&&!t.has(m))&&o.push(g)}}else if(d instanceof Reroute){const u=d,p=LLink.resolveMany(u.linkIds,c);for(const{link:f}of p){const m=LLink.getReroutes(c,f).filter(b=>!t.has(b)),{inputNode:_,outputNode:y}=f.resolve(c);(m.length||_&&!t.has(_)||y&&!t.has(y))&&s.push(f)}}}return{boundaryLinks:s,boundaryFloatingLinks:r,internalLinks:i,boundaryInputLinks:n,boundaryOutputLinks:o};function l(d){if(d)for(const u of d)LLink.getReroutes(c,u).some(f=>!t.has(f))&&r.push(u)}}function multiClone(c){const t=[];for(const i of c){const s=LiteGraph.createNode(i.type);if(!s){console.warn("Failed to create node",i.type);continue}const n=LiteGraph.cloneObject(i.serialize());s.configure(n),t.push(s.serialize())}return t}function groupResolvedByOutput(c){const t=new Map;for(const i of c){const s=i.subgraphInput??i.output??{},n=t.get(s);n?n.push(i):t.set(s,[i])}return t}function mapSubgraphInputsAndLinks(c,t){const i=groupResolvedByOutput(c),s=[];for(const[,n]of i){const o=[];for(const k of n){const{link:T,input:I}=k;if(!I)continue;const E=T.asSerialisable();E.origin_id=SUBGRAPH_INPUT_ID,E.origin_slot=s.length,t.push(E),o.push(E)}const{input:r}=n[0];if(!r)continue;const{color_off:a,color_on:l,dir:d,hasErrors:u,label:p,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,s.map(k=>k.name)),b=f?nextUniqueName(f,s.map(k=>k.localized_name??"")):void 0,L={id:createUuidv4(),type:String(_),linkIds:o.map(k=>k.id),name:y,color_off:a,color_on:l,dir:d,label:p,localized_name:b,hasErrors:u,shape:m};s.push(L)}return s}function mapSubgraphOutputsAndLinks(c,t){const i=groupResolvedByOutput(c),s=[];for(const[,n]of i){const o=[];for(const k of n){const{link:T,output:I}=k;if(!I)continue;const E=T.asSerialisable();E.target_id=SUBGRAPH_OUTPUT_ID,E.target_slot=s.length,t.push(E),o.push(E)}const{output:r}=n[0];if(!r)continue;const{color_off:a,color_on:l,dir:d,hasErrors:u,label:p,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,s.map(k=>k.name)),b=f?nextUniqueName(f,s.map(k=>k.localized_name??"")):void 0,L={id:createUuidv4(),type:String(_),linkIds:o.map(k=>k.id),name:y,color_off:a,color_on:l,dir:d,label:p,localized_name:b,hasErrors:u,shape:m};s.push(structuredClone(L))}return s}function getDirectSubgraphIds(c){const t=new Set;for(const i of c._nodes)i.isSubgraphNode()&&t.add(i.type);return t}function findUsedSubgraphIds(c,t){const i=new Set,s=[c];for(;s.length>0;){const n=s.shift(),o=getDirectSubgraphIds(n);for(const r of o)if(!i.has(r)){i.add(r);const a=t.get(r);a&&s.push(a)}}return i}function isSubgraphInput(c){return c!=null&&typeof c=="object"&&"parent"in c&&c.parent instanceof SubgraphInputNode}function isSubgraphOutput(c){return c!=null&&typeof c=="object"&&"parent"in c&&c.parent instanceof SubgraphOutputNode}function isNodeSlot(c){return c!=null&&typeof c=="object"&&("link"in c||"links"in c)}class NodeInputSlot extends NodeSlot{constructor(i,s){super(i,s);h(this,"link");P(this,ue);this.link=i.link}get isWidgetInputSlot(){return!!this.widget}get _widget(){var i;return(i=S(this,ue))==null?void 0:i.deref()}set _widget(i){z(this,ue,i?new WeakRef(i):void 0)}get collapsedPos(){return[0,LiteGraph.NODE_TITLE_HEIGHT*-.5]}get isConnected(){return this.link!=null}isValidTarget(i){return"links"in i?LiteGraph.isValidConnection(i.type,this.type):isSubgraphInput(i)?LiteGraph.isValidConnection(i.type,this.type):!1}draw(i,s){const{textAlign:n}=i;i.textAlign="left",super.draw(i,{...s,labelPosition:LabelPosition.Right,doStroke:!1}),i.textAlign=n}}ue=new WeakMap;class NodeOutputSlot extends NodeSlot{constructor(i,s){super(i,s);P(this,ce);h(this,"links");h(this,"_data");h(this,"slot_index");this.links=i.links,this._data=i._data,this.slot_index=i.slot_index,z(this,ce,s)}get isWidgetInputSlot(){return!1}get collapsedPos(){return[S(this,ce)._collapsed_width??LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT*-.5]}isValidTarget(i){return"link"in i?LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}get isConnected(){return this.links!=null&&this.links.length>0}draw(i,s){const{textAlign:n,strokeStyle:o}=i;i.textAlign="right",i.strokeStyle="black",super.draw(i,{...s,labelPosition:LabelPosition.Left,doStroke:!0}),i.textAlign=n,i.strokeStyle=o}}ce=new WeakMap;function shallowCloneCommonProps(c){const{color_off:t,color_on:i,dir:s,label:n,localized_name:o,locked:r,name:a,nameLocked:l,removable:d,shape:u,type:p}=c;return{color_off:t,color_on:i,dir:s,label:n,localized_name:o,locked:r,name:a,nameLocked:l,removable:d,shape:u,type:p}}function inputAsSerialisable(c){const{link:t}=c,i=c.widget?{widget:{name:c.widget.name}}:{pos:c.pos};return{...shallowCloneCommonProps(c),...i,link:t}}function outputAsSerialisable(c){const{pos:t,slot_index:i,links:s,widget:n}=c,o=n?{widget:{name:n.name}}:null;return{...shallowCloneCommonProps(c),...o,pos:t,slot_index:i,links:s}}function isINodeInputSlot(c){return"link"in c}function isWidgetInputSlot(c){return!!c.widget}const UNIQUE_MESSAGE_LIMIT=1e4,sentWarnings=new Set;function warnDeprecated(c,t){if(!LiteGraph.alwaysRepeatWarnings){if(sentWarnings.has(c)||sentWarnings.size>UNIQUE_MESSAGE_LIMIT)return;sentWarnings.add(c)}for(const i of LiteGraph.onDeprecationWarning)i(c,t)}function distributeSpace(c,t){if(t.length===0)return[];const i=t.reduce((o,r)=>o+r.minSize,0);if(c<i)return t.map(o=>o.minSize);let s=t.map(o=>({computedSize:o.minSize,maxSize:o.maxSize??1/0,remaining:(o.maxSize??1/0)-o.minSize})),n=c-i;for(;n>0&&s.some(o=>o.remaining>0);){const o=s.filter(l=>l.remaining>0).length;if(o===0)break;const r=n/o;let a=0;if(s=s.map(l=>{if(l.remaining<=0)return l;const d=Math.min(r,l.remaining);return a+=d,{...l,computedSize:l.computedSize+d,remaining:l.remaining-d}}),n-=a,a===0)break}return s.map(({computedSize:o})=>o)}function truncateText(c,t,i,s="..."){if(c.measureText(t).width<=i||i<=0)return t;const o=c.measureText(s).width,r=i-o;if(r<=0)return s;let a=0,l=t.length,d=0;for(;a<=l;){const u=Math.floor((a+l)/2),p=t.substring(0,u);c.measureText(p).width<=r?(d=u,a=u+1):l=u-1}return t.substring(0,d)+s}function toClass(c,...t){return t[0]instanceof c?t[0]:new c(...t)}const kt=class kt{constructor(t,i){P(this,pe);h(this,"linkedWidgets");h(this,"name");h(this,"options");h(this,"label");h(this,"type");h(this,"y",0);h(this,"last_y");h(this,"width");h(this,"disabled");h(this,"computedDisabled");h(this,"hidden");h(this,"advanced");h(this,"tooltip");h(this,"element");P(this,fe);z(this,pe,i??t.node),this.name=t.name,this.options=t.options,this.type=t.type;const{node:s,outline_color:n,background_color:o,height:r,text_color:a,secondary_text_color:l,disabledTextColor:d,displayName:u,displayValue:p,labelBaseline:f,...g}=t;Object.assign(this,g)}get node(){return S(this,pe)}get value(){return S(this,fe)}set value(t){z(this,fe,t)}get outline_color(){return this.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR}get background_color(){return LiteGraph.WIDGET_BGCOLOR}get height(){return LiteGraph.NODE_WIDGET_HEIGHT}get text_color(){return LiteGraph.WIDGET_TEXT_COLOR}get secondary_text_color(){return LiteGraph.WIDGET_SECONDARY_TEXT_COLOR}get disabledTextColor(){return LiteGraph.WIDGET_DISABLED_TEXT_COLOR}get displayName(){return this.label||this.name}get _displayValue(){return this.computedDisabled?"":String(this.value)}get labelBaseline(){return this.y+this.height*.7}drawWidgetShape(t,{width:i,showText:s}){const{height:n,y:o}=this,{margin:r}=kt;t.textAlign="left",t.strokeStyle=this.outline_color,t.fillStyle=this.background_color,t.beginPath(),s?t.roundRect(r,o,i-r*2,n,[n*.5]):t.rect(r,o,i-r*2,n),t.fill(),s&&!this.computedDisabled&&t.stroke()}drawTruncatingText({ctx:t,width:i,leftPadding:s=5,rightPadding:n=20}){const{height:o,y:r}=this,{margin:a}=kt,{displayName:l,_displayValue:d}=this,u=t.measureText(l).width,p=t.measureText(d).width,f=kt.labelValueGap,g=a*2+s,m=i-g-2*a-n,_=u+f+p,y=new Rectangle(g,r,m,o*.7);if(t.fillStyle=this.secondary_text_color,_<=m)drawTextInArea({ctx:t,text:l,area:y,align:"left"});else if(LiteGraph.truncateWidgetTextEvenly){const b=(m-f)/(_-f);y.width=u*b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(p*b)}else if(LiteGraph.truncateWidgetValuesFirst){const b=Math.min(u,m);y.width=b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(Math.max(m-f-b,0))}else{const b=Math.min(p,m);y.width=Math.max(m-f-b,0),drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(b)}t.fillStyle=this.text_color,drawTextInArea({ctx:t,text:d,area:y,align:"right"})}setValue(t,{e:i,node:s,canvas:n}){var l,d,u;const o=this.value;if(t===this.value)return;const r=this.type==="number"?Number(t):t;this.value=r,(l=this.options)!=null&&l.property&&s.properties[this.options.property]!==void 0&&s.setProperty(this.options.property,r);const a=n.graph_mouse;(d=this.callback)==null||d.call(this,this.value,n,s,a,i),(u=s.onWidgetChanged)==null||u.call(s,this.name??"",r,o,this),s.graph&&s.graph._version++}createCopyForNode(t){const i=new this.constructor(this,t);return i.value=this.value,i}};pe=new WeakMap,fe=new WeakMap,h(kt,"margin",15),h(kt,"arrowMargin",6),h(kt,"arrowWidth",10),h(kt,"minValueWidth",42),h(kt,"labelValueGap",5);let BaseWidget=kt;class BooleanWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","toggle")}drawWidget(i,{width:s,showText:n=!0}){const{height:o,y:r}=this,{margin:a}=BaseWidget;this.drawWidgetShape(i,{width:s,showText:n}),i.fillStyle=this.value?"#89A":"#333",i.beginPath(),i.arc(s-a*2,r+o*.5,o*.36,0,Math.PI*2),i.fill(),n&&(this.drawLabel(i,a*2),this.drawValue(i,s-40))}drawLabel(i,s){i.fillStyle=this.secondary_text_color;const{displayName:n}=this;n&&i.fillText(n,s,this.labelBaseline)}drawValue(i,s){i.fillStyle=this.value?this.text_color:this.secondary_text_color,i.textAlign="right";const n=this.value?this.options.on||"true":this.options.off||"false";i.fillText(n,s,this.labelBaseline)}onClick(i){this.setValue(!this.value,i)}}class ButtonWidget extends BaseWidget{constructor(i,s){super(i,s);h(this,"type","button");h(this,"clicked");this.clicked??(this.clicked=!1)}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:d}=this,{margin:u}=BaseWidget;i.fillStyle=this.background_color,this.clicked&&(i.fillStyle="#AAA",this.clicked=!1),i.fillRect(u,d,s-u*2,l),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(u,d,s-u*2,l)),n&&this.drawLabel(i,s*.5),Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}drawLabel(i,s){i.textAlign="center",i.fillStyle=this.text_color,i.fillText(this.displayName,s,this.y+this.height*.7)}onClick({e:i,node:s,canvas:n}){var r;const o=n.graph_mouse;this.clicked=!0,n.setDirty(!0),(r=this.callback)==null||r.call(this,this,n,s,o,i)}}class BaseSteppedWidget extends BaseWidget{drawArrowButtons(t,i){const{height:s,text_color:n,disabledTextColor:o,y:r}=this,{arrowMargin:a,arrowWidth:l,margin:d}=BaseWidget,u=d+a,p=u+l;t.fillStyle=this.canDecrement()?n:o,t.beginPath(),t.moveTo(p,r+5),t.lineTo(u,r+s*.5),t.lineTo(p,r+s-5),t.fill(),t.fillStyle=this.canIncrement()?n:o,t.beginPath(),t.moveTo(i-p,r+5),t.lineTo(i-u,r+s*.5),t.lineTo(i-p,r+s-5),t.fill()}drawWidget(t,i){const{fillStyle:s,strokeStyle:n,textAlign:o}=t;this.drawWidgetShape(t,i),i.showText&&(this.computedDisabled||this.drawArrowButtons(t,i.width),this.drawTruncatingText({ctx:t,width:i.width})),Object.assign(t,{textAlign:o,strokeStyle:n,fillStyle:s})}}function toArray(c){return Array.isArray(c)?c:Object.keys(c)}class ComboWidget extends BaseSteppedWidget{constructor(){super(...arguments);P(this,gt);h(this,"type","combo")}get _displayValue(){if(this.computedDisabled)return"";const{values:i}=this.options;if(i){const s=typeof i=="function"?i():i;if(s&&!Array.isArray(s))return s[this.value]}return typeof this.value=="number"?String(this.value):this.value}canIncrement(){return C(this,gt,Ze).call(this,!0)}canDecrement(){return C(this,gt,Ze).call(this,!1)}incrementValue(i){C(this,gt,Je).call(this,1,i)}decrementValue(i){C(this,gt,Je).call(this,-1,i)}onClick({e:i,node:s,canvas:n}){const o=i.canvasX-s.pos[0],r=this.width||s.size[0];if(typeof this.options.values=="function"&&warnDeprecated("Using a function for values is deprecated. Use an array of unique values instead."),o<40)return this.decrementValue({e:i,node:s,canvas:n});if(o>r-40)return this.incrementValue({e:i,node:s,canvas:n});const a=C(this,gt,qe).call(this,s),l=toArray(a),d=a!=l?Object.values(a):a;new LiteGraph.ContextMenu(d,{scale:Math.max(1,n.ds.scale),event:i,className:"dark",callback:u=>{this.setValue(a!=l?d.indexOf(u):u,{e:i,node:s,canvas:n})}})}}gt=new WeakSet,qe=function(i){const{values:s}=this.options;if(s==null)throw new Error("[ComboWidget]: values is required");return typeof s=="function"?s(this,i):s},Ze=function(i){const{values:s}=this.options;if(typeof s=="function")return!1;const n=toArray(s);if(!(n.length>1))return!1;const o=n.at(0),r=n.at(-1);return o===r?!0:this.value!==(i?r:o)},Je=function(i,s){const n=C(this,gt,qe).call(this,s.node),o=toArray(n);s.canvas.last_mouseclick=0;const r=typeof n=="object"?o.indexOf(String(this.value))+i:o.indexOf(this.value)+i,a=clamp(r,0,o.length-1),l=Array.isArray(n)?n[a]:a;this.setValue(l,s)};function getWidgetStep(c){return c.step2||(c.step||10)*.1}class KnobWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","knob");h(this,"current_drag_offset",0)}computeLayoutSize(){return{minHeight:60,minWidth:20,maxHeight:1e6,maxWidth:1e6}}get height(){return this.computedHeight||super.height}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{y:l}=this,{margin:d}=BaseWidget,{gradient_stops:u="rgb(14, 182, 201); rgb(0, 216, 72)"}=this.options,p=this.computedHeight||this.height,f=Math.min(this.computedHeight||this.height,this.width||20)/20,g={x:s/2,y:p/2+l};i.lineWidth=(Math.min(s,p)-d*f)/6;const m=(Math.min(s,p)-d*f-i.lineWidth)/2;{const I=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);I.addColorStop(0,"rgb(29, 29, 29)"),I.addColorStop(1,"rgb(116, 116, 116)"),i.fillStyle=I}i.beginPath(),i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.fill(),i.closePath();const _={start_angle:Math.PI*.6,end_angle:Math.PI*2.4};i.beginPath();{const I=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);I.addColorStop(0,"rgb(99, 99, 99)"),I.addColorStop(1,"rgb(36, 36, 36)"),i.strokeStyle=I}i.arc(g.x,g.y,m,_.start_angle,_.end_angle,!1),i.stroke(),i.closePath();const y=this.options.max-this.options.min;let b=(this.value-this.options.min)/y;b=clamp(b,0,1),i.beginPath();const L=i.createConicGradient(_.start_angle,g.x,g.y),k=u.split(";");for(const[I,E]of k.entries())L.addColorStop(I,E.trim());i.strokeStyle=L;const T=(_.end_angle-_.start_angle)*b+_.start_angle;if(i.arc(g.x,g.y,m,_.start_angle,T,!1),i.stroke(),i.closePath(),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.beginPath(),i.strokeStyle=this.outline_color,i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.lineWidth=1,i.stroke(),i.closePath()),n){i.textAlign="center",i.fillStyle=this.text_color;const I=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}
${I}`,s*.5,l+p*.5)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(){this.current_drag_offset=0}onDrag(i){if(this.options.read_only)return;const{e:s}=i,n=getWidgetStep(this.options),o=this.options.max-this.options.min,r=o/10,a=o/100,l={shift:r>n?r-r%n:n,delta_y:a>n?a-a%n:n},d=Math.abs(s.movementY)>Math.abs(s.movementX),u=d?-s.movementY:s.movementX,p=15;this.current_drag_offset+=u;let f=0;this.current_drag_offset>p?(f+=1,this.current_drag_offset-=p):this.current_drag_offset<-15&&(f-=1,this.current_drag_offset+=p);const g=s.shiftKey?l.shift:d?l.delta_y:n,m=f*g,_=clamp(this.value+m,this.options.min,this.options.max);_!==this.value&&this.setValue(_,i)}}class LegacyWidget extends BaseWidget{drawWidget(t,i){var n;const s=LiteGraph.NODE_WIDGET_HEIGHT;(n=this.draw)==null||n.call(this,t,this.node,i.width,this.y,s,!!i.showText)}onClick(){console.warn("Custom widget wrapper onClick was just called. Handling for third party widgets is done via LGraphCanvas - the mouse callback.")}}class NumberWidget extends BaseSteppedWidget{constructor(){super(...arguments);h(this,"type","number")}get _displayValue(){return this.computedDisabled?"":Number(this.value).toFixed(this.options.precision!==void 0?this.options.precision:3)}canIncrement(){const{max:t}=this.options;return t==null||this.value<t}canDecrement(){const{min:t}=this.options;return t==null||this.value>t}incrementValue(t){this.setValue(this.value+getWidgetStep(this.options),t)}decrementValue(t){this.setValue(this.value-getWidgetStep(this.options),t)}setValue(t,i){let s=t;this.options.min!=null&&s<this.options.min&&(s=this.options.min),this.options.max!=null&&s>this.options.max&&(s=this.options.max),super.setValue(s,i)}onClick({e,node,canvas}){const x=e.canvasX-node.pos[0],width=this.width||node.size[0],delta=x<40?-1:x>width-40?1:0;if(delta){this.setValue(this.value+delta*getWidgetStep(this.options),{e,node,canvas});return}canvas.prompt("Value",this.value,v=>{if(/^[\d\s()*+/-]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch{}const newValue=Number(v);isNaN(newValue)||this.setValue(newValue,{e,node,canvas})},e)}onDrag({e:t,node:i,canvas:s}){const n=this.width||i.width,o=t.canvasX-i.pos[0];(o<40||o>n-40)&&o>-3&&o<n+3||this.setValue(this.value+(t.deltaX??0)*getWidgetStep(this.options),{e:t,node:i,canvas:s})}}class SliderWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","slider");h(this,"marker")}drawWidget(i,{width:s,showText:n=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:d}=this,{margin:u}=BaseWidget;i.fillStyle=this.background_color,i.fillRect(u,d,s-u*2,l);const p=this.options.max-this.options.min;let f=(this.value-this.options.min)/p;if(f=clamp(f,0,1),i.fillStyle=this.options.slider_color??"#678",i.fillRect(u,d,f*(s-u*2),l),n&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(u,d,s-u*2,l)),this.marker!=null){let g=(this.marker-this.options.min)/p;g=clamp(g,0,1),i.fillStyle=this.options.marker_color??"#AA9",i.fillRect(u+g*(s-u*2),d,2,l)}if(n){i.textAlign="center",i.fillStyle=this.text_color;const g=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}  ${g}`,s*.5,d+l*.7)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(i){if(this.options.read_only)return;const{e:s,node:n}=i,o=this.width||n.size[0],r=s.canvasX-n.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}onDrag(i){if(this.options.read_only)return!1;const{e:s,node:n}=i,o=this.width||n.size[0],r=s.canvasX-n.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}}class TextWidget extends BaseWidget{constructor(t,i){var s;super(t,i),this.type??(this.type="string"),this.value=((s=t.value)==null?void 0:s.toString())??""}drawWidget(t,{width:i,showText:s=!0}){const{fillStyle:n,strokeStyle:o,textAlign:r}=t;this.drawWidgetShape(t,{width:i,showText:s}),s&&this.drawTruncatingText({ctx:t,width:i,leftPadding:0,rightPadding:0}),Object.assign(t,{textAlign:r,strokeStyle:o,fillStyle:n})}onClick({e:t,node:i,canvas:s}){var n;s.prompt("Value",this.value,o=>{o!==null&&this.setValue(o,{e:t,node:i,canvas:s})},t,((n=this.options)==null?void 0:n.multiline)??!1)}}function toConcreteWidget(c,t,i=!0){if(c instanceof BaseWidget)return c;const s=c;switch(s.type){case"button":return toClass(ButtonWidget,s,t);case"toggle":return toClass(BooleanWidget,s,t);case"slider":return toClass(SliderWidget,s,t);case"knob":return toClass(KnobWidget,s,t);case"combo":return toClass(ComboWidget,s,t);case"number":return toClass(NumberWidget,s,t);case"string":return toClass(TextWidget,s,t);case"text":return toClass(TextWidget,s,t);default:if(i)return toClass(LegacyWidget,c,t)}}const nt=class nt{constructor(t,i){P(this,U);h(this,"title");h(this,"graph",null);h(this,"id");h(this,"type","");h(this,"inputs",[]);h(this,"outputs",[]);P(this,Nt,[]);P(this,At,[]);h(this,"properties",{});h(this,"properties_info",[]);h(this,"flags",{});h(this,"widgets");h(this,"freeWidgetSpace");h(this,"locked");h(this,"order",0);h(this,"mode",LGraphEventMode.ALWAYS);h(this,"last_serialization");h(this,"serialize_widgets");h(this,"color");h(this,"bgcolor");h(this,"boxcolor");h(this,"strokeStyles");h(this,"progress");h(this,"exec_version");h(this,"action_call");h(this,"execute_triggered");h(this,"action_triggered");h(this,"widgets_up");h(this,"widgets_start_y");h(this,"lostFocusAt");h(this,"gotFocusAt");h(this,"badges",[]);h(this,"title_buttons",[]);h(this,"badgePosition",BadgePosition.TopLeft);h(this,"_collapsed_width");h(this,"console");h(this,"_level");h(this,"_shape");h(this,"mouseOver");h(this,"redraw_on_mouse");h(this,"resizable");h(this,"clonable");h(this,"_relative_id");h(this,"clip_area");h(this,"ignore_remove");h(this,"has_errors");h(this,"removable");h(this,"block_delete");h(this,"selected");h(this,"showAdvanced");P(this,ge,new Float32Array(4));P(this,_e,new Rectangle);h(this,"_posSize",new Float32Array(4));h(this,"_pos",this._posSize.subarray(0,2));h(this,"_size",this._posSize.subarray(2,4));this.id=LiteGraph.use_uuids?LiteGraph.uuidv4():-1,this.title=t||"Unnamed",this.type=i??"",this.size=[LiteGraph.NODE_WIDTH,60],this.pos=[10,10],this.strokeStyles={error:C(this,U,gi),selected:C(this,U,_i)},this.onMouseDown=(s,n,o)=>{var r;if((r=this.title_buttons)!=null&&r.length&&!this.flags.collapsed){const a=n[0],l=n[1];for(let d=0;d<this.title_buttons.length;d++){const u=this.title_buttons[d];if(u.visible&&u.isPointInside(a,l))return this.onTitleButtonClick(u,o),!0}}return!1}}get titleFontStyle(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get innerFontStyle(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get displayType(){return this.type}get renderingColor(){return this.color||this.constructor.color||LiteGraph.NODE_DEFAULT_COLOR}get renderingBgColor(){return this.bgcolor||this.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR}get renderingBoxColor(){if(this.boxcolor)return this.boxcolor;if(LiteGraph.node_box_coloured_when_on){if(this.action_triggered)return"#FFF";if(this.execute_triggered)return"#AAA"}if(LiteGraph.node_box_coloured_by_mode){const t=LiteGraph.NODE_MODES_COLORS[this.mode??LGraphEventMode.ALWAYS];if(t)return t}return LiteGraph.NODE_DEFAULT_BOXCOLOR}setColorOption(t){t==null?(delete this.color,delete this.bgcolor):(this.color=t.color,this.bgcolor=t.bgcolor)}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.color===this.color&&t.bgcolor===this.bgcolor)??null}isSubgraphNode(){return!1}get renderArea(){return S(this,ge)}get boundingRect(){return S(this,_e)}get boundingOffset(){const{pos:[t,i],boundingRect:[s,n]}=this;return[t-s,i-n]}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=t[0],this._size[1]=t[1])}get renderingSize(){return this.flags.collapsed?[this._collapsed_width??0,0]:this._size}get shape(){return this._shape}set shape(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=RenderShape.BOX;break;case"round":this._shape=RenderShape.ROUND;break;case"circle":this._shape=RenderShape.CIRCLE;break;case"card":this._shape=RenderShape.CARD;break;default:this._shape=t}}get renderingShape(){return this._shape||this.constructor.shape||LiteGraph.NODE_DEFAULT_SHAPE}get is_selected(){return this.selected}set is_selected(t){this.selected=t}get title_mode(){return this.constructor.title_mode??TitleMode.NORMAL_TITLE}configure(t){var i,s,n,o,r,a,l,d,u,p;this.graph&&this.graph._version++;for(const f in t){if(f=="properties"){for(const g in t.properties)this.properties[g]=t.properties[g],(i=this.onPropertyChanged)==null||i.call(this,g,t.properties[g]);continue}t[f]!=null&&(typeof t[f]=="object"?(s=this[f])!=null&&s.configure?(n=this[f])==null||n.configure(t[f]):this[f]=LiteGraph.cloneObject(t[f],this[f]):this[f]=t[f])}t.title||(this.title=this.constructor.title),this.inputs??(this.inputs=[]),this.inputs=this.inputs.map(f=>toClass(NodeInputSlot,f,this));for(const[f,g]of this.inputs.entries()){const m=this.graph&&g.link!=null?this.graph._links.get(g.link):null;(o=this.onConnectionsChange)==null||o.call(this,NodeSlotType.INPUT,f,!0,m,g),(r=this.onInputAdded)==null||r.call(this,g)}this.outputs??(this.outputs=[]),this.outputs=this.outputs.map(f=>toClass(NodeOutputSlot,f,this));for(const[f,g]of this.outputs.entries())if(g.links){for(const m of g.links){const _=this.graph?this.graph._links.get(m):null;(a=this.onConnectionsChange)==null||a.call(this,NodeSlotType.OUTPUT,f,!0,_,g)}(l=this.onOutputAdded)==null||l.call(this,g)}if((d=this._internalConfigureAfterSlots)==null||d.call(this),this.widgets){for(const f of this.widgets)f&&(u=f.options)!=null&&u.property&&this.properties[f.options.property]!=null&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property])));if(t.widgets_values){const f=this.widgets.filter(g=>g.serialize!==!1);for(let g=0;g<t.widgets_values.length;++g){const m=f[g];m&&(m.value=t.widgets_values[g])}}}this.pinned&&(this.resizable=!1),(p=this.onConfigure)==null||p.call(this,t)}serialize(){var s;const t={id:this.id,type:this.type,pos:[this.pos[0],this.pos[1]],size:[this.size[0],this.size[1]],flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode,showAdvanced:this.showAdvanced};if(this.constructor===nt&&this.last_serialization)return this.last_serialization;this.inputs&&(t.inputs=this.inputs.map(n=>inputAsSerialisable(n))),this.outputs&&(t.outputs=this.outputs.map(n=>outputAsSerialisable(n))),this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties));const{widgets:i}=this;if(i&&this.serialize_widgets){t.widgets_values=[];for(const[n,o]of i.entries())o.serialize!==!1&&(t.widgets_values[n]=o?o.value:null)}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),(s=this.onSerialize)!=null&&s.call(this,t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){if(this.type==null)return null;const t=LiteGraph.createNode(this.type);if(!t)return null;const i=LiteGraph.cloneObject(this.serialize()),{inputs:s,outputs:n}=i;if(s)for(const o of s)o.link=null;if(n)for(const{links:o}of n)o&&(o.length=0);return delete i.id,LiteGraph.use_uuids&&(i.id=LiteGraph.uuidv4()),t.configure(i),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,i){var n;if(this.properties||(this.properties={}),i===this.properties[t])return;const s=this.properties[t];if(this.properties[t]=i,((n=this.onPropertyChanged)==null?void 0:n.call(this,t,i,s))===!1&&(this.properties[t]=s),this.widgets){for(const o of this.widgets)if(o&&o.options.property==t){o.value=i;break}}}setOutputData(t,i){const{outputs:s}=this;if(!s||t==-1||t>=s.length)return;const n=s[t];if(!n)return;if(n._data=i,!this.graph)throw new NullGraphError;const{links:o}=s[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.data=i)}}setOutputDataType(t,i){const{outputs:s}=this;if(!s||t==-1||t>=s.length)return;const n=s[t];if(!n)return;if(n.type=i,!this.graph)throw new NullGraphError;const{links:o}=s[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.type=i)}}getInputData(t,i){var r;if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return;if(!this.graph)throw new NullGraphError;const s=this.inputs[t].link,n=this.graph._links.get(s);if(!n)return null;if(!i)return n.data;const o=this.graph.getNodeById(n.origin_id);return o&&(o.updateOutputData?o.updateOutputData(n.origin_slot):(r=o.onExecute)==null||r.call(o)),n.data}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;if(!this.graph)throw new NullGraphError;const i=this.inputs[t].link,s=this.graph._links.get(i);if(!s)return null;const n=this.graph.getNodeById(s.origin_id);if(!n)return s.type;const o=n.outputs[s.origin_slot];return o?o.type:null}getInputDataByName(t,i){const s=this.findInputSlot(t);return s==-1?null:this.getInputData(s,i)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return!this.inputs||!(t<this.inputs.length)?null:this.inputs[t]}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){if(!this.graph)throw new NullGraphError;const i=this.inputs[t];if(i.link!=null)return this.graph._links.get(i.link)??null}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;const i=this.inputs[t];if(!i||i.link===null)return null;if(!this.graph)throw new NullGraphError;const s=this.graph._links.get(i.link);return s?this.graph.getNodeById(s.origin_id):null}getInputOrProperty(t){const{inputs:i}=this;if(!(i!=null&&i.length))return this.properties?this.properties[t]:null;if(!this.graph)throw new NullGraphError;for(const s of i)if(t==s.name&&s.link!=null){const n=this.graph._links.get(s.link);if(n)return n.data}return this.properties[t]}getOutputData(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data}getOutputInfo(t){return!this.outputs||!(t<this.outputs.length)?null:this.outputs[t]}isOutputConnected(t){var i;return this.outputs?t<this.outputs.length&&Number((i=this.outputs[t].links)==null?void 0:i.length)>0:!1}isAnyOutputConnected(){var i;const{outputs:t}=this;if(!t)return!1;for(const s of t)if((i=s.links)!=null&&i.length)return!0;return!1}getOutputNodes(t){const{outputs:i}=this;if(!i||i.length==0||t>=i.length)return null;const{links:s}=i[t];if(!s||s.length==0)return null;if(!this.graph)throw new NullGraphError;const n=[];for(const o of s){const r=this.graph._links.get(o);if(r){const a=this.graph.getNodeById(r.target_id);a&&n.push(a)}}return n}addOnTriggerInput(){const t=this.findInputSlot("onTrigger");return t==-1?(this.addInput("onTrigger",LiteGraph.EVENT,{nameLocked:!0}),this.findInputSlot("onTrigger")):t}addOnExecutedOutput(){const t=this.findOutputSlot("onExecuted");return t==-1?(this.addOutput("onExecuted",LiteGraph.ACTION,{nameLocked:!0}),this.findOutputSlot("onExecuted")):t}onAfterExecuteNode(t,i){const s=this.findOutputSlot("onExecuted");s!=-1&&this.triggerSlot(s,t,null,i)}changeMode(t){switch(t){case LGraphEventMode.ON_EVENT:break;case LGraphEventMode.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LGraphEventMode.NEVER:break;case LGraphEventMode.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,i){var s;if(i=i||{},this.onExecute){if(i.action_call||(i.action_call=`${this.id}_exec_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_executing[this.id]=!0,this.onExecute(t,i),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,i!=null&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call)}this.execute_triggered=2,(s=this.onAfterExecuteNode)==null||s.call(this,t,i)}actionDo(t,i,s){var n;if(s=s||{},this.onAction){if(s.action_call||(s.action_call=`${this.id}_${t||"action"}_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,i,s),this.graph.nodes_actioning[this.id]=!1,s!=null&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)}this.action_triggered=2,(n=this.onAfterExecuteNode)==null||n.call(this,i,s)}trigger(t,i,s){const{outputs:n}=this;if(!(!n||!n.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(const[o,r]of n.entries())!r||r.type!==LiteGraph.EVENT||t&&r.name!=t||this.triggerSlot(o,i,null,s)}}triggerSlot(t,i,s,n){var a;if(n=n||{},!this.outputs)return;if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const o=this.outputs[t];if(!o)return;const r=o.links;if(!(!r||!r.length)){if(!this.graph)throw new NullGraphError;this.graph._last_trigger_time=LiteGraph.getTime();for(const l of r){if(s!=null&&s!=l)continue;const d=this.graph._links.get(l);if(!d)continue;d._last_time=LiteGraph.getTime();const u=this.graph.getNodeById(d.target_id);if(u){if(u.mode===LGraphEventMode.ON_TRIGGER)n.action_call||(n.action_call=`${this.id}_trigg_${Math.floor(Math.random()*9999)}`),(a=u.doExecute)==null||a.call(u,i,n);else if(u.onAction){n.action_call||(n.action_call=`${this.id}_act_${Math.floor(Math.random()*9999)}`);const p=u.inputs[d.target_slot];u.actionDo(p.name,i,n)}}}}}clearTriggeredSlot(t,i){if(!this.outputs)return;const s=this.outputs[t];if(!s)return;const n=s.links;if(!(!n||!n.length)){if(!this.graph)throw new NullGraphError;for(const o of n){if(i!=null&&i!=o)continue;const r=this.graph._links.get(o);r&&(r._last_time=0)}}}setSize(t){var i;this.size=t,(i=this.onResize)==null||i.call(this,this.size)}expandToFitContent(){const t=this.computeSize();this.setSize([Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])])}addProperty(t,i,s,n){const o={name:t,type:s,default_value:i};return n&&Object.assign(o,n),this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=i,o}addOutput(t,i,s){var o;const n=Object.assign(new NodeOutputSlot({name:t,type:i,links:null},this),s);return this.outputs||(this.outputs=[]),this.outputs.push(n),(o=this.onOutputAdded)==null||o.call(this,n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i,!0),this.expandToFitContent(),this.setDirtyCanvas(!0,!0),n}removeOutput(t){var s;this.disconnectOutput(t);const{outputs:i}=this;i.splice(t,1);for(let n=t;n<i.length;++n){const o=i[n];if(!(!o||!o.links))for(const r of o.links){if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r);a&&a.origin_slot--}}(s=this.onOutputRemoved)==null||s.call(this,t),this.setDirtyCanvas(!0,!0)}addInput(t,i,s){var o;i||(i=0);const n=Object.assign(new NodeInputSlot({name:t,type:i,link:null},this),s);return this.inputs||(this.inputs=[]),this.inputs.push(n),this.expandToFitContent(),(o=this.onInputAdded)==null||o.call(this,n),LiteGraph.registerNodeAndSlotType(this,i),this.setDirtyCanvas(!0,!0),n}removeInput(t){var n;this.disconnectInput(t,!0);const{inputs:i}=this,s=i.splice(t,1);for(let o=t;o<i.length;++o){const r=i[o];if(!(r!=null&&r.link))continue;if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r.link);a&&a.target_slot--}(n=this.onInputRemoved)==null||n.call(this,t,s[0]),this.setDirtyCanvas(!0,!0)}computeSize(t){const i=this.constructor.size;if(i)return[i[0],i[1]];const{inputs:s,outputs:n,widgets:o}=this;let r=Math.max(s?s.filter(E=>!isWidgetInputSlot(E)).length:1,n?n.length:1);const a=t||new Float32Array([0,0]);r=Math.max(r,1);const l=LiteGraph.NODE_TEXT_SIZE,d=LiteGraph.NODE_TITLE_HEIGHT,u=d*.33,p=d+I(this.title,this.titleFontStyle)+u;let f=0,g=0,m=0;if(s)for(const E of s){const G=E.label||E.localized_name||E.name||"",R=I(G,this.innerFontStyle);if(isWidgetInputSlot(E)){const N=this.getWidgetFromSlot(E);if(N&&!this.isWidgetVisible(N))continue;R>g&&(g=R)}else R>f&&(f=R)}if(n)for(const E of n){const G=E.label||E.localized_name||E.name||"",R=I(G,this.innerFontStyle);m<R&&(m=R)}const _=LiteGraph.NODE_WIDTH*(o!=null&&o.length?1.5:1),y=f&&m?5:0,b=f+m+2*LiteGraph.NODE_SLOT_HEIGHT+y,L=BaseWidget.margin+BaseWidget.arrowMargin+BaseWidget.arrowWidth,k=BaseWidget.minValueWidth+2*L;g&&(g+=k),a[0]=Math.max(b,g,p,_),a[1]=(this.constructor.slot_start_y||0)+r*LiteGraph.NODE_SLOT_HEIGHT;let T=0;if(o!=null&&o.length){for(const E of o){if(!this.isWidgetVisible(E))continue;let G=0;if(E.computeSize)G+=E.computeSize(a[0])[1];else if(E.computeLayoutSize){const{minHeight:R,minWidth:N}=E.computeLayoutSize(this),D=N+k;D>a[0]&&(a[0]=D),G+=R}else G+=LiteGraph.NODE_WIDGET_HEIGHT;T+=G+4}T+=8}this.widgets_up?a[1]=Math.max(a[1],T):this.widgets_start_y!=null?a[1]=Math.max(a[1],T+this.widgets_start_y):a[1]+=T;function I(E,G){var R;return((R=LGraphCanvas._measureText)==null?void 0:R.call(LGraphCanvas,E,G))??l*((E==null?void 0:E.length)??0)*.6}return this.constructor.min_height&&a[1]<this.constructor.min_height&&(a[1]=this.constructor.min_height),a[1]+=6,a}inResizeCorner(t,i){const s=this.outputs?this.outputs.length:1,n=(this.constructor.slot_start_y||0)+s*LiteGraph.NODE_SLOT_HEIGHT;return isInRectangle(t,i,this.pos[0]+this.size[0]-15,this.pos[1]+Math.max(this.size[1]-15,n),20,20)}findResizeDirection(t,i){if(this.resizable===!1)return;const{boundingRect:s}=this;if(s.containsXy(t,i))return s.findContainingCorner(t,i,nt.resizeHandleSize)}getPropertyInfo(t){var n;let i=null;const{properties_info:s}=this;if(s){for(const o of s)if(o.name==t){i=o;break}}return this.constructor[`@${t}`]&&(i=this.constructor[`@${t}`]),(n=this.constructor.widgets_info)!=null&&n[t]&&(i=this.constructor.widgets_info[t]),!i&&this.onGetPropertyInfo&&(i=this.onGetPropertyInfo(t)),i||(i={}),i.type||(i.type=typeof this.properties[t]),i.widget=="combo"&&(i.type="enum"),i}addWidget(t,i,s,n,o){this.widgets||(this.widgets=[]),!o&&n&&typeof n=="object"&&(o=n,n=null),o||(o={}),typeof o=="string"&&(o={property:o}),n&&typeof n=="string"&&(o.property=n,n=null);const r={type:t.toLowerCase(),name:i,value:s,callback:typeof n!="function"?void 0:n,options:o,y:0};if(r.options.y!==void 0&&(r.y=r.options.y),!n&&!r.options.callback&&!r.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";const a=this.addCustomWidget(r);return this.expandToFitContent(),a}addCustomWidget(t){this.widgets||(this.widgets=[]);const i=toConcreteWidget(t,this,!1)??t;return this.widgets.push(i),i}addTitleButton(t){this.title_buttons||(this.title_buttons=[]);const i=new LGraphButton(t);return this.title_buttons.push(i),i}onTitleButtonClick(t,i){i.dispatch("litegraph:node-title-button-clicked",{node:this,button:t})}removeWidgetByName(t){var s;const i=(s=this.widgets)==null?void 0:s.find(n=>n.name===t);i&&this.removeWidget(i)}removeWidget(t){if(!this.widgets)throw new Error("removeWidget called on node without widgets");const i=this.widgets.indexOf(t);if(i===-1)throw new Error("Widget not found on this node");if(this.inputs)for(const s of this.inputs)s._widget===t&&(s._widget=void 0,delete s.widget);this.widgets.splice(i,1)}ensureWidgetRemoved(t){try{this.removeWidget(t)}catch(i){console.debug("Failed to remove widget",i)}}move(t,i){this.pinned||(this.pos[0]+=t,this.pos[1]+=i)}measure(t,i){var r;const s=this.title_mode,o=s!=TitleMode.TRANSPARENT_TITLE&&s!=TitleMode.NO_TITLE?LiteGraph.NODE_TITLE_HEIGHT:0;t[0]=this.pos[0],t[1]=this.pos[1]+-o,(r=this.flags)!=null&&r.collapsed?(i.font=this.innerFontStyle,this._collapsed_width=Math.min(this.size[0],i.measureText(this.getTitle()??"").width+LiteGraph.NODE_TITLE_HEIGHT*2),t[2]=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,t[3]=LiteGraph.NODE_TITLE_HEIGHT):(t[2]=this.size[0],t[3]=this.size[1]+o)}getBounding(t,i){t||(t=new Float32Array(4));const s=i?this.renderArea:this.boundingRect;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t}updateArea(t){var n;const i=S(this,_e);this.measure(i,t),(n=this.onBounding)==null||n.call(this,i);const s=S(this,ge);s.set(i),s[0]-=4,s[1]-=4,s[2]+=10,s[3]+=9}isPointInside(t,i){return isInRect(t,i,this.boundingRect)}isPointInCollapse(t,i){const s=LiteGraph.NODE_TITLE_HEIGHT;return isInRectangle(t,i,this.pos[0],this.pos[1]-s,s,s)}getInputOnPos(t){var i;return(i=getNodeInputOnPos(this,t[0],t[1]))==null?void 0:i.input}getOutputOnPos(t){var i;return(i=getNodeOutputOnPos(this,t[0],t[1]))==null?void 0:i.output}getSlotOnPos(t){if(isPointInRect(t,this.boundingRect))return this.getInputOnPos(t)??this.getOutputOnPos(t)}getSlotInPosition(t,i){const{inputs:s,outputs:n}=this;if(s)for(const[o,r]of s.entries()){const a=this.getInputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{input:r,slot:o,link_pos:a}}if(n)for(const[o,r]of n.entries()){const a=this.getOutputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{output:r,slot:o,link_pos:a}}return null}getWidgetOnPos(t,i,s=!1){var u;const{widgets:n,pos:o,size:r}=this;if(!(n!=null&&n.length))return;const a=t-o[0],l=i-o[1],d=r[0];for(const p of n){if(p.computedDisabled&&!s||!this.isWidgetVisible(p))continue;const f=p.computedHeight??((u=p.computeSize)==null?void 0:u.call(p,d)[1])??LiteGraph.NODE_WIDGET_HEIGHT,g=p.width||d;if(p.last_y!==void 0&&isInRectangle(a,l,6,p.last_y,g-12,f))return p}}findInputSlot(t,i=!1){const{inputs:s}=this;if(!s)return-1;for(const[n,o]of s.entries())if(t==o.name)return i?o:n;return-1}findOutputSlot(t,i=!1){const{outputs:s}=this;if(!s)return-1;for(const[n,o]of s.entries())if(t==o.name)return i?o:n;return-1}findInputSlotFree(t){return C(this,U,Qe).call(this,this.inputs,t)}findOutputSlotFree(t){return C(this,U,Qe).call(this,this.outputs,t)}findInputSlotByType(t,i,s,n){return C(this,U,Ne).call(this,this.inputs,t,i,s,n)}findOutputSlotByType(t,i,s,n){return C(this,U,Ne).call(this,this.outputs,t,i,s,n)}findSlotByType(t,i,s,n,o){return t?C(this,U,Ne).call(this,this.inputs,i,s,n,o):C(this,U,Ne).call(this,this.outputs,i,s,n,o)}findConnectByTypeSlot(t,i,s,n){n&&typeof n=="object"&&("firstFreeIfInputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfInputGeneralInCase),"firstFreeIfOutputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfOutputGeneralInCase),"generalTypeInCase"in n&&(n.typedToWildcard=!!n.generalTypeInCase));const r=Object.assign({createEventInCase:!0,wildcardToTyped:!0,typedToWildcard:!0},n);if(!this.graph)throw new NullGraphError;if(i&&typeof i=="number"){const l=this.graph.getNodeById(i);if(!l)return;i=l}const a=i.findSlotByType(t,s,!1,!0);if(a>=0&&a!==null)return a;if(r.createEventInCase&&s==LiteGraph.EVENT){if(t)return-1;if(LiteGraph.do_add_triggers_slots)return i.addOnExecutedOutput()}if(r.typedToWildcard){const l=i.findSlotByType(t,0,!1,!0,!0);if(l>=0)return l}if(r.wildcardToTyped&&(s==0||s=="*"||s=="")){const l={typesNotAccepted:[LiteGraph.EVENT]},d=t?i.findInputSlotFree(l):i.findOutputSlotFree(l);if(d>=0)return d}}findOutputByType(t){return findFreeSlotOfType(this.outputs,t,i=>{var s;return!((s=i.links)!=null&&s.length)})}findInputByType(t){return findFreeSlotOfType(this.inputs,t,i=>i.link==null)}connectByType(t,i,s,n){const o=this.findConnectByTypeSlot(!0,i,s,n);return o!==void 0?this.connect(t,i,o,n==null?void 0:n.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",s,"to node:",i),null)}connectByTypeOutput(t,i,s,n){typeof n=="object"&&("firstFreeIfInputGeneralInCase"in n&&(n.wildcardToTyped=!!n.firstFreeIfInputGeneralInCase),"generalTypeInCase"in n&&(n.typedToWildcard=!!n.generalTypeInCase));const o=this.findConnectByTypeSlot(!1,i,s,n);return o!==void 0?i.connect(o,this,t,n==null?void 0:n.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",s,"to node:",i),null)}canConnectTo(t,i,s){return this.id!==t.id&&LiteGraph.isValidConnection(s.type,i.type)}connect(t,i,s,n){var p;let o;const{graph:r,outputs:a}=this;if(!r)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),null}else if(!a||t>=a.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&typeof i=="number"){const f=r.getNodeById(i);if(!f)throw"target node is null";i=f}if(!i)throw"target node is null";if(i==this)return null;if(typeof s=="string"){if(o=i.findInputSlot(s),o==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${o}`),null}else if(s===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)i.changeMode(LGraphEventMode.ON_TRIGGER),o=i.findInputSlot("onTrigger");else return null;else typeof s=="number"?o=s:o=0;if(i.onBeforeConnectInput){const f=i.onBeforeConnectInput(o,s);o=typeof f=="number"?f:null}if(o===null||!i.inputs||o>=i.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;const l=i.inputs[o],d=a[t];return d?((p=d.links)!=null&&p.length&&d.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(r.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1})),this.connectSlots(d,i,l,n)??null):null}connectSlots(t,i,s,n){var p,f,g,m,_;const{graph:o}=this;if(!o)throw new NullGraphError;const r=this.outputs.indexOf(t);if(r===-1){console.warn("connectSlots: output not found");return}const a=i.inputs.indexOf(s);if(a===-1){console.warn("connectSlots: input not found");return}if(!LiteGraph.isValidConnection(t.type,s.type))return this.setDirtyCanvas(!1,!0),null;if(((p=i.onConnectInput)==null?void 0:p.call(i,a,t.type,t,this,r))===!1||((f=this.onConnectOutput)==null?void 0:f.call(this,r,s.type,s,i,a))===!1)return null;((g=i.inputs[a])==null?void 0:g.link)!=null&&(o.beforeChange(),i.disconnectInput(a,!0));const l=new LLink(++o.state.lastLinkId,s.type||t.type,this.id,r,i.id,a,n);o._links.set(l.id,l),t.links??(t.links=[]),t.links.push(l.id),i.inputs[a].link=l.id;const d=LLink.getReroutes(o,l);for(const y of d)y.linkIds.add(l.id),y.floating&&delete y.floating,y._dragging=void 0;const u=d.at(-1);if(u)for(const y of u.floatingLinkIds){const b=o.floatingLinks.get(y);(b==null?void 0:b.parentId)===u.id&&o.removeFloatingLink(b)}return o._version++,(m=this.onConnectionsChange)==null||m.call(this,NodeSlotType.OUTPUT,r,!0,l,t),(_=i.onConnectionsChange)==null||_.call(i,NodeSlotType.INPUT,a,!0,l,s),this.setDirtyCanvas(!1,!0),o.afterChange(),l}connectFloatingReroute(t,i,s){var g,m;const{graph:n,id:o}=this;if(!n)throw new NullGraphError;const r=this.inputs.indexOf(i),a=this.outputs.indexOf(i);if(r===-1&&a===-1)throw new Error("Invalid slot");const l=a===-1?"input":"output",d=n.setReroute({pos:t,parentId:s,linkIds:[],floating:{slotType:l}}),u=n.getReroute(s),p=((g=u==null?void 0:u.floating)==null?void 0:g.slotType)==="output";if(s==null||!p){const _=new LLink(-1,i.type,a===-1?-1:o,a,r===-1?-1:o,r);return _.parentId=d.id,n.addFloatingLink(_),d}if(!u)throw new Error("[connectFloatingReroute] Parent reroute not found");const f=(m=u.getFloatingLinks("output"))==null?void 0:m[0];if(!f)throw new Error("[connectFloatingReroute] Floating link not found");return d.floatingLinkIds.add(f.id),f.parentId=d.id,delete u.floating,d}disconnectOutput(t,i){var r,a,l,d,u;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const s=this.outputs[t];if(!s)return!1;if(s._floatingLinks)for(const p of s._floatingLinks)p.hasOrigin(this.id,t)&&((r=this.graph)==null||r.removeFloatingLink(p));if(!s.links||s.links.length==0)return!1;const{links:n}=s,o=this.graph;if(!o)throw new NullGraphError;if(i){const p=typeof i=="number"?o.getNodeById(i):i;if(!p)throw"Target Node not found";for(const[f,g]of n.entries()){const m=o._links.get(g);if((m==null?void 0:m.target_id)!=p.id)continue;n.splice(f,1);const _=p.inputs[m.target_slot];_.link=null,m.disconnect(o,"input"),o._version++,(a=p.onConnectionsChange)==null||a.call(p,NodeSlotType.INPUT,m.target_slot,!1,m,_),(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.OUTPUT,t,!1,m,s);break}}else{for(const p of n){const f=o._links.get(p);if(!f)continue;const g=o.getNodeById(f.target_id);if(o._version++,g){const m=g.inputs[f.target_slot];m.link=null,(d=g.onConnectionsChange)==null||d.call(g,NodeSlotType.INPUT,f.target_slot,!1,f,m)}f.disconnect(o,"input"),(u=this.onConnectionsChange)==null||u.call(this,NodeSlotType.OUTPUT,t,!1,f,s)}s.links=null}return this.setDirtyCanvas(!1,!0),!0}disconnectInput(t,i){var r,a,l,d;if(typeof t=="string"){if(t=this.findInputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const s=this.inputs[t];if(!s)return console.debug("disconnectInput: input not found",t,this.inputs),!1;const{graph:n}=this;if(!n)throw new NullGraphError;if((r=s._floatingLinks)!=null&&r.size)for(const u of s._floatingLinks)n.removeFloatingLink(u);const o=this.inputs[t].link;if(o!=null){this.inputs[t].link=null;const u=n._links.get(o);if(u){if(u.origin_id===-10&&"inputNode"in n)return n.inputNode._disconnectNodeInput(this,s,u),!0;const p=n.getNodeById(u.origin_id);if(!p)return console.debug("disconnectInput: target node not found",u.origin_id),!1;const f=p.outputs[u.origin_slot];if(!((a=f==null?void 0:f.links)!=null&&a.length))return console.debug("disconnectInput: output not found",u.origin_slot),!1;let g=0;for(const m=f.links.length;g<m;g++)if(f.links[g]==o){f.links.splice(g,1);break}u.disconnect(n,i?"output":void 0),n&&n._version++,(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.INPUT,t,!1,u,s),(d=p.onConnectionsChange)==null||d.call(p,NodeSlotType.OUTPUT,g,!1,u,f)}}return this.setDirtyCanvas(!1,!0),!0}getConnectionPos(t,i,s){var f,g;s||(s=new Float32Array(2));const{pos:[n,o],inputs:r,outputs:a}=this;if(this.flags.collapsed){const m=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return s[0]=t?n:n+m,s[1]=o-LiteGraph.NODE_TITLE_HEIGHT*.5,s}if(t&&i==-1)return s[0]=n+LiteGraph.NODE_TITLE_HEIGHT*.5,s[1]=o+LiteGraph.NODE_TITLE_HEIGHT*.5,s;const l=(f=r==null?void 0:r[i])==null?void 0:f.pos,d=(g=a==null?void 0:a[i])==null?void 0:g.pos;if(t&&l)return s[0]=n+l[0],s[1]=o+l[1],s;if(!t&&d)return s[0]=n+d[0],s[1]=o+d[1],s;const u=LiteGraph.NODE_SLOT_HEIGHT*.5,p=t?S(this,U,ti).indexOf(this.inputs[i]):S(this,U,ei).indexOf(this.outputs[i]);return s[0]=t?n+u:n+this.size[0]+1-u,s[1]=o+(p+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s}getInputPos(t){return this.getInputSlotPos(this.inputs[t])}getInputSlotPos(t){const{pos:[i,s]}=this;if(this.flags.collapsed){const d=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i,s-d]}const{pos:n}=t;if(n)return[i+n[0],s+n[1]];const o=LiteGraph.NODE_SLOT_HEIGHT*.5,r=this.constructor.slot_start_y||0,l=(S(this,U,ti).indexOf(t)+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o,s+l+r]}getOutputPos(t){var p;const{pos:[i,s],outputs:n,size:[o]}=this;if(this.flags.collapsed){const f=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,g=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i+f,s-g]}const r=(p=n==null?void 0:n[t])==null?void 0:p.pos;if(r)return[i+r[0],s+r[1]];const a=LiteGraph.NODE_SLOT_HEIGHT*.5,l=this.constructor.slot_start_y||0,u=(S(this,U,ei).indexOf(this.outputs[t])+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o+1-a,s+u+l]}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}alignToGrid(){this.snapToGrid(LiteGraph.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>nt.MAX_CONSOLE&&this.console.shift()}setDirtyCanvas(t,i){var s;(s=this.graph)==null||s.canvasAction(n=>n.setDirty(t,i))}loadImage(t){const i=new Image;i.src=LiteGraph.node_images_path+t,i.ready=!1;const s=()=>this.setDirtyCanvas(!0);return i.addEventListener("load",function(){this.ready=!0,s()}),i}captureInput(t){if(warnDeprecated("[DEPRECATED] captureInput will be removed in a future version. Please use LGraphCanvas.pointer (CanvasPointer) instead."),!this.graph||!this.graph.list_of_graphcanvas)return;const i=this.graph.list_of_graphcanvas;for(const s of i)!t&&s.node_capturing_input!=this||(s.node_capturing_input=t?this:null)}get collapsed(){return!!this.flags.collapsed}get collapsible(){return!this.pinned&&this.constructor.collapsable!==!1}collapse(t){if(!(!this.collapsible&&!t)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0)}}toggleAdvanced(){var t;if((t=this.widgets)!=null&&t.some(i=>i.advanced)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.showAdvanced=!this.showAdvanced,this.expandToFitContent(),this.setDirtyCanvas(!0,!0)}}get pinned(){return!!this.flags.pinned}pin(t){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.pinned=t??!this.flags.pinned,this.resizable=!this.pinned,this.pinned||delete this.flags.pinned}unpin(){this.pin(!1)}localToScreen(t,i,s){return[(t+this.pos[0])*s.scale+s.offset[0],(i+this.pos[1])*s.scale+s.offset[1]]}get width(){return this.collapsed?this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH:this.size[0]}get height(){return LiteGraph.NODE_TITLE_HEIGHT+this.bodyHeight}get bodyHeight(){return this.collapsed?0:this.size[1]}drawBadges(t,{gap:i=2}={}){const s=this.badges.map(a=>a instanceof LGraphBadge?a:a());let o=this.badgePosition===BadgePosition.TopLeft?0:this.width-s.reduce((a,l)=>a+l.getWidth(t)+i,0);const r=-(LiteGraph.NODE_TITLE_HEIGHT+i);for(const a of s)a.draw(t,o,r-a.height),o+=a.getWidth(t)+i}drawTitleBarBackground(t,{scale:i,title_height:s=LiteGraph.NODE_TITLE_HEIGHT,low_quality:n=!1}){const o=this.renderingColor,r=this.renderingShape,a=this.renderingSize;if(this.onDrawTitleBar){this.onDrawTitleBar(t,s,a,i,o);return}this.title_mode!==TitleMode.TRANSPARENT_TITLE&&(this.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),t.fillStyle=this.constructor.title_color||o,t.beginPath(),r==RenderShape.BOX||n?t.rect(0,-s,a[0],s):(r==RenderShape.ROUND||r==RenderShape.CARD)&&t.roundRect(0,-s,a[0],s,this.collapsed?[LiteGraph.ROUND_RADIUS]:[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]),t.fill(),t.shadowColor="transparent")}drawTitleBox(t,{scale:i,low_quality:s=!1,title_height:n=LiteGraph.NODE_TITLE_HEIGHT,box_size:o=10}){const r=this.renderingSize,a=this.renderingShape;if(this.onDrawTitleBox){this.onDrawTitleBox(t,n,r,i);return}[RenderShape.ROUND,RenderShape.CIRCLE,RenderShape.CARD].includes(a)?(s&&(t.fillStyle="black",t.beginPath(),t.arc(n*.5,n*-.5,o*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=this.renderingBoxColor,s?t.fillRect(n*.5-o*.5,n*-.5-o*.5,o,o):(t.beginPath(),t.arc(n*.5,n*-.5,o*.5,0,Math.PI*2),t.fill())):(s&&(t.fillStyle="black",t.fillRect((n-o)*.5-1,(n+o)*-.5-1,o+2,o+2)),t.fillStyle=this.renderingBoxColor,t.fillRect((n-o)*.5,(n+o)*-.5,o,o))}drawTitleText(t,{scale:i,default_title_color:s,low_quality:n=!1,title_height:o=LiteGraph.NODE_TITLE_HEIGHT}){var u;const r=this.renderingSize,a=this.selected;if(this.onDrawTitleText){this.onDrawTitleText(t,o,r,i,this.titleFontStyle,a);return}if(n)return;t.font=this.titleFontStyle;const l=this.getTitle()??`âŒ ${this.type}`,d=String(l)+(this.pinned?"ðŸ“Œ":"");if(d){a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=this.constructor.title_text_color||s;let p=r[0]-o*2;if(((u=this.title_buttons)==null?void 0:u.length)>0){let g=0;const m=t.font;for(const _ of this.title_buttons)_.visible&&(g+=_.getWidth(t)+2);t.font=m,g>0&&(g+=10,p-=g)}let f=d;this.collapsed?f=d.substr(0,20):p>0&&(f=truncateText(t,d,p)),t.textAlign="left",t.fillText(f,o,LiteGraph.NODE_TITLE_TEXT_Y-o)}}connectInputToOutput(){const{inputs:t,outputs:i,graph:s}=this;if(!t||!i)return;if(!s)throw new NullGraphError;const{_links:n}=s;let o=!1;for(const[a,l]of t.entries()){if(l.link==null)continue;const d=i[a];if(!d||!LiteGraph.isValidConnection(l.type,d.type))continue;const u=n.get(l.link);if(!u)continue;const p=s.getNodeById(u==null?void 0:u.origin_id);p&&r(d,p,u,s)}if(!(this.flags.keepAllLinksOnBypass??nt.keepAllLinksOnBypass))return o;for(const a of t){if(a.link==null)continue;const l=n.get(a.link);if(!l)continue;const d=s.getNodeById(l==null?void 0:l.origin_id);if(d){for(const u of i)if(LiteGraph.isValidConnection(a.type,u.type)){r(u,d,l,s);break}}}return o;function r(a,l,d,u){var f;const p=(f=a.links)==null?void 0:f.map(g=>n.get(g)).filter(g=>!!g);if(p!=null&&p.length)for(const g of p){const m=u.getNodeById(g.target_id);if(!m)continue;const _=l.connect(d.origin_slot,m,g.target_slot,d.parentId);o||(o=!!_)}}}isWidgetVisible(t){return!(this.collapsed||t.hidden||t.advanced&&!this.showAdvanced)}drawWidgets(t,{lowQuality:i=!1,editorAlpha:s=1}){var l,d;if(!this.widgets)return;const n=this.size[0],{widgets:o}=this,r=LiteGraph.NODE_WIDGET_HEIGHT,a=!i;t.save(),t.globalAlpha=s;for(const u of o){if(!this.isWidgetVisible(u))continue;const{y:p}=u,f=u.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR;u.last_y=p,u.computedDisabled=u.disabled||((l=this.getSlotFromWidget(u))==null?void 0:l.link)!=null,t.strokeStyle=f,t.fillStyle="#222",t.textAlign="left",u.computedDisabled&&(t.globalAlpha*=.5);const g=u.width||n;typeof u.draw=="function"?u.draw(t,this,g,p,r,i):(d=toConcreteWidget(u,this,!1))==null||d.drawWidget(t,{width:g,showText:a}),t.globalAlpha=s}t.restore()}drawCollapsedSlots(t){var i;for(const s of S(this,Nt))if(s.link!=null){s.drawCollapsed(t);break}for(const s of S(this,At))if((i=s.links)!=null&&i.length){s.drawCollapsed(t);break}}get slots(){return[...this.inputs,...this.outputs]}getSlotFromWidget(t){if(t)return this.inputs.find(i=>isWidgetInputSlot(i)&&i.widget.name===t.name)}getWidgetFromSlot(t){var i;if(isWidgetInputSlot(t))return(i=this.widgets)==null?void 0:i.find(s=>s.name===t.widget.name)}drawSlots(t,{fromSlot:i,colorContext:s,editorAlpha:n,lowQuality:o}){for(const r of[...S(this,Nt),...S(this,At)]){const a=i&&r.isValidTarget(i),l=C(this,U,vi).call(this,r),d=!i||a,u=d&&l;(l||a||!r.isWidgetInputSlot||C(this,U,bi).call(this,this.getWidgetFromSlot(r))||r.isConnected)&&(t.globalAlpha=d?n:.4*n,r.draw(t,{colorContext:s,lowQuality:o,highlight:u}))}}_setConcreteSlots(){z(this,Nt,this.inputs.map(t=>toClass(NodeInputSlot,t,this))),z(this,At,this.outputs.map(t=>toClass(NodeOutputSlot,t,this)))}arrange(){const t=C(this,U,mi).call(this),i=t?t[1]+t[3]-this.pos[1]:0;C(this,U,wi).call(this,i),C(this,U,ki).call(this)}drawProgressBar(t){if(!this.progress)return;const i=t.fillStyle;t.fillStyle="green",t.fillRect(0,0,this.width*this.progress,6),t.fillStyle=i}};Nt=new WeakMap,At=new WeakMap,ge=new WeakMap,_e=new WeakMap,U=new WeakSet,gi=function(){if(this.has_errors)return{padding:12,lineWidth:10,color:LiteGraph.NODE_ERROR_COLOUR}},_i=function(){if(this.selected)return{padding:this.has_errors?20:void 0}},Qe=function(t,i){var r,a,l;const n=Object.assign({returnObj:!1,typesNotAccepted:[]},i||{}),o=t==null?void 0:t.length;if(!(o>0))return-1;for(let d=0;d<o;++d){const u=t[d];if(!(!u||u.link||(r=u.links)!=null&&r.length)&&!((l=(a=n.typesNotAccepted)==null?void 0:a.includes)!=null&&l.call(a,u.type)))return n.returnObj?u:d}return-1},Ne=function(t,i,s,n,o){var d;const r=t==null?void 0:t.length;if(!r)return-1;(i==""||i=="*")&&(i=0);const a=String(i).toLowerCase().split(",");let l=null;for(let u=0;u<r;++u){const p=t[u],f=p.type=="0"||p.type=="*"?["0"]:String(p.type).toLowerCase().split(",");for(const g of a){const m=g=="_event_"?LiteGraph.EVENT:g;for(const _ of f){const y=_=="_event_"?LiteGraph.EVENT:_;if(m==y||m==="*"||y==="*"){if(n&&((d=p.links)!=null&&d.length||p.link!=null)){l??(l=s?p:u);continue}return s?p:u}}}}return o?-1:l??-1},ti=function(){return this.inputs.filter(t=>{var i;return!t.pos&&!((i=this.widgets)!=null&&i.length&&isWidgetInputSlot(t))})},ei=function(){return this.outputs.filter(t=>!t.pos)},Ue=function(t,i,s){const n=s?this.getInputPos(i):this.getOutputPos(i);t.boundingRect[0]=n[0]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[1]=n[1]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[2]=t.isWidgetInputSlot?BaseWidget.margin:LiteGraph.NODE_SLOT_HEIGHT,t.boundingRect[3]=LiteGraph.NODE_SLOT_HEIGHT},mi=function(){var i;const t=[];for(const[s,n]of S(this,Nt).entries())(i=this.widgets)!=null&&i.length&&isWidgetInputSlot(n)||(C(this,U,Ue).call(this,n,s,!0),t.push(n));for(const[s,n]of S(this,At).entries())C(this,U,Ue).call(this,n,s,!1),t.push(n);return t.length?createBounds(t,0):null},yi=function(t){var n;const i=isINodeInputSlot(t),s=((n=this.mouseOver)==null?void 0:n[i?"inputId":"outputId"])??-1;return s===-1?null:i?this.inputs[s]:this.outputs[s]},vi=function(t){return C(this,U,yi).call(this,t)===t},bi=function(t){var i;return t?((i=this.mouseOver)==null?void 0:i.overWidget)===t:!1},wi=function(t){if(!this.widgets||!this.widgets.length)return;const i=this.bodyHeight,s=this.widgets_start_y??(this.widgets_up?0:t)+2;let n=i-s,o=0;const r=[];for(const u of this.widgets)if(u.computeSize){const p=u.computeSize()[1]+4;u.computedHeight=p,o+=p}else if(u.computeLayoutSize){const{minHeight:p,maxHeight:f}=u.computeLayoutSize(this);r.push({minHeight:p,prefHeight:f,w:u})}else{const p=LiteGraph.NODE_WIDGET_HEIGHT+4;u.computedHeight=p,o+=p}n-=o,this.freeWidgetSpace=n;const a=r.map(u=>({minSize:u.minHeight,maxSize:u.prefHeight})),l=distributeSpace(Math.max(0,n),a);for(const[u,p]of r.entries())p.w.computedHeight=l[u];let d=s;for(const u of this.widgets)u.y=d,d+=u.computedHeight??0;if(!this.graph)throw new NullGraphError;d>i&&(this.setSize([this.size[0],d]),this.graph.setDirtyCanvas(!1,!0))},ki=function(){if(!this.widgets)return;const t=new Map;for(const[i,s]of this.inputs.entries())isWidgetInputSlot(s)&&t.set(s.widget.name,{...s,index:i});if(t.size)for(const i of this.widgets){const s=t.get(i.name);if(!s)continue;const n=S(this,Nt)[s.index],o=LiteGraph.NODE_SLOT_HEIGHT*.5;n.pos=[o,i.y+o],C(this,U,Ue).call(this,n,s.index,!0)}},h(nt,"title"),h(nt,"MAX_CONSOLE"),h(nt,"type"),h(nt,"category"),h(nt,"filter"),h(nt,"skip_list"),h(nt,"resizeHandleSize",15),h(nt,"resizeEdgeSize",5),h(nt,"keepAllLinksOnBypass",!1);let LGraphNode=nt;function getAllNestedItems(c){const t=new Set;if(c)for(const s of c)i(s,t);return t;function i(s,n){if(!(n.has(s)||s.pinned)&&(n.add(s),s.children))for(const o of s.children)i(o,n)}}function findFirstNode(c){for(const t of c)if(t instanceof LGraphNode)return t}function findFreeSlotOfType(c,t,i){if(!(c!=null&&c.length))return;let s,n,o;const r=parseSlotTypes(t);for(const[a,l]of c.entries()){const d=parseSlotTypes(l.type);for(const u of r)for(const p of d)if(p===u){if(i(l))return{index:a,slot:l};s??(s={index:a,slot:l})}else!n&&(u==="*"||p==="*")&&(i(l)?n={index:a,slot:l}:o??(o={index:a,slot:l}))}return n??s??o}function removeFromArray(c,t){const i=c.indexOf(t),s=i!==-1;return s&&c.splice(i,1),s}class SubgraphInput extends SubgraphSlot{constructor(){super(...arguments);h(this,"events",new CustomEventTarget);P(this,Qt)}get _widget(){var i;return(i=S(this,Qt))==null?void 0:i.deref()}set _widget(i){z(this,Qt,i?new WeakRef(i):void 0)}connect(i,s,n){var p,f;const{subgraph:o}=this.parent,r=s.inputs.indexOf(i);if(((p=s.onConnectInput)==null?void 0:p.call(s,r,this.type,this,this.parent,-1))===!1)return;if(i.link!=null){o.beforeChange();const g=o.getLink(i.link);this.parent._disconnectNodeInput(s,i,g)}const a=s.getWidgetFromSlot(i);if(a){if(!this.matchesWidget(a)){console.warn("Target input has invalid widget.",i,s);return}this._widget??(this._widget=a),this.events.dispatch("input-connected",{input:i,widget:a})}const l=new LLink(++o.state.lastLinkId,i.type,this.parent.id,this.parent.slots.indexOf(this),s.id,r,n);o._links.set(l.id,l),this.linkIds.push(l.id),i.link=l.id;const d=LLink.getReroutes(o,l);for(const g of d)g.linkIds.add(l.id),g.floating&&delete g.floating,g._dragging=void 0;const u=d.at(-1);if(u)for(const g of u.floatingLinkIds){const m=o.floatingLinks.get(g);(m==null?void 0:m.parentId)===u.id&&o.removeFloatingLink(m)}return o._version++,(f=s.onConnectionsChange)==null||f.call(s,NodeSlotType.INPUT,r,!0,l,i),o.afterChange(),l}get labelPos(){const[i,s,,n]=this.boundingRect;return[i,s+n*.5]}getConnectedWidgets(){var n;const{subgraph:i}=this.parent,s=[];for(const o of this.linkIds){const r=i.getLink(o);if(!r){console.error("Link not found",o);continue}const a=r.resolve(i);if(a.input&&((n=a.inputNode)!=null&&n.widgets)){const l=a.input.widget;if(!l)continue;if(!l.name){console.warn("Invalid widget name",l);continue}const d=a.inputNode.widgets.find(u=>u.name===l.name);if(!d){console.warn("Widget not found",l);continue}s.push(d)}else console.debug("No input found on link id",o,r)}return s}matchesWidget(i){var n;const s=(n=S(this,Qt))==null?void 0:n.deref();return s?!(i.type!==s.type||i.options.min!==s.options.min||i.options.max!==s.options.max||i.options.step!==s.options.step||i.options.step2!==s.options.step2||i.options.precision!==s.options.precision):!0}disconnect(){super.disconnect(),this.events.dispatch("input-disconnected",{input:this})}arrange(i){const[s,n,o,r]=i,{boundingRect:a,pos:l}=this;a[0]=s-o,a[1]=n,a[2]=o,a[3]=r,l[0]=s-r*.5,l[1]=n+r*.5}isValidTarget(i){return isNodeSlot(i)?"link"in i&&LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}}Qt=new WeakMap;class EmptySubgraphInput extends SubgraphInput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,s){const{subgraph:n}=this.parent,o=n.inputs.map(l=>l.name),r=nextUniqueName(t.name,o);return n.addInput(r,String(t.type)).connect(t,i,s)}get labelPos(){const[t,i,,s]=this.boundingRect;return[t,i+s*.5]}}class SubgraphInputNode extends SubgraphIONodeBase{constructor(){super(...arguments);h(this,"id",SUBGRAPH_INPUT_ID);h(this,"emptySlot",new EmptySubgraphInput(this))}get slots(){return this.subgraph.inputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i,,s]=this.boundingRect;return i+s-SubgraphIONodeBase.roundedRadius}onPointerDown(i,s,n){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(s.onDragStart=()=>{n.dragNewFromSubgraphInput(this.subgraph,this,o)},s.onDragEnd=a=>{n.dropLinks(this.subgraph,a)},s.finally=()=>{n.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,s){this.subgraph.renameInput(i,s)}removeSlot(i){this.subgraph.removeInput(i)}canConnectTo(i,s,n){return i.canConnectTo(this,s,n)}connectSlots(i,s,n,o){const{subgraph:r}=this,a=this.slots.indexOf(i),l=s.inputs.indexOf(n);if(a===-1||l===-1)throw new Error("Invalid slot indices.");return new LLink(++r.state.lastLinkId,n.type||i.type,this.id,a,s.id,l,o)}connectByType(i,s,n,o){const r=s.findInputByType(n);if(r){if(i===-1){const a=this.subgraph.addInput(r.slot.name,String(r.slot.type??"")),l=this.slots.indexOf(a);if(l===-1){console.error("Could not find newly created subgraph input slot.");return}i=l}return this.slots[i].connect(r.slot,s,o==null?void 0:o.afterRerouteId)}}findOutputSlot(i){return this.slots.find(s=>s.name===i)}findOutputByType(i){var s;return(s=findFreeSlotOfType(this.slots,i,n=>n.linkIds.length>0))==null?void 0:s.slot}_disconnectNodeInput(i,s,n){var d,u;const{subgraph:o}=this;if((d=s._floatingLinks)!=null&&d.size)for(const p of s._floatingLinks)o.removeFloatingLink(p);if(s.link=null,o.setDirtyCanvas(!1,!0),!n)return;const r=n.origin_slot;n.disconnect(o,"output"),o._version++;const a=this.slots.at(r);if(!a){console.debug("disconnectNodeInput: subgraphInput not found",this,r);return}const l=a.linkIds.indexOf(n.id);l!==-1?a.linkIds.splice(l,1):console.debug("disconnectNodeInput: link ID not found in subgraphInput linkIds",n.id),(u=i.onConnectionsChange)==null||u.call(i,NodeSlotType.OUTPUT,l,!1,n,a)}drawProtected(i,s,n,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,d,u,p]=this.boundingRect;i.translate(l,d),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(u-r,r,r,Math.PI*1.5,0),i.moveTo(u,r),i.lineTo(u,p-r),i.arc(u-r,p-r,r,0,Math.PI*.5),i.stroke(),i.setTransform(a),this.drawSlots(i,s,n,o)}}class FloatingRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");h(this,"outputNodeId",-1);h(this,"outputNode");h(this,"outputSlot");h(this,"outputIndex",-1);h(this,"outputPos");h(this,"inputNodeId",-1);h(this,"inputNode");h(this,"inputSlot");h(this,"inputIndex",-1);h(this,"inputPos");this.network=t,this.link=i,this.toType=s,this.fromReroute=n,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:d}=i;if(r!==-1){const u=t.getNodeById(r)??void 0;if(!u)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=u==null?void 0:u.outputs.at(l);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=u,this.outputSlot=p,this.outputIndex=l,this.outputPos=u.getOutputPos(l),this.node=u,this.fromSlot=p,this.fromPos=(n==null?void 0:n.pos)??this.outputPos,this.fromDirection=LinkDirection.LEFT,this.dragDirection=LinkDirection.RIGHT,this.fromSlotIndex=l}else{const u=t.getNodeById(a)??void 0;if(!u)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const p=u==null?void 0:u.inputs.at(d);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${d}] not found.`);this.inputNodeId=a,this.inputNode=u,this.inputSlot=p,this.inputIndex=d,this.inputPos=u.getInputPos(d),this.node=u,this.fromSlot=p,this.fromDirection=LinkDirection.RIGHT,this.fromSlotIndex=d}this.fromPos=n.pos}canConnectToInput(){return this.toType==="input"}canConnectToOutput(){return this.toType==="output"}canConnectToReroute(t){var i,s;if(this.toType==="input"){if(t.origin_id===((i=this.inputNode)==null?void 0:i.id))return!1}else if(t.origin_id===((s=this.outputNode)==null?void 0:s.id))return!1;return!0}connectToInput(t,i,s){var o;const n=this.link;n.target_id=t.id,n.target_slot=t.inputs.indexOf(i),t.disconnectInput(t.inputs.indexOf(i)),(o=this.fromSlot._floatingLinks)==null||o.delete(n),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(n)}connectToOutput(t,i,s){var o;const n=this.link;n.origin_id=t.id,n.origin_slot=t.outputs.indexOf(i),(o=this.fromSlot._floatingLinks)==null||o.delete(n),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(n)}connectToSubgraphInput(t,i){var n;const s=this.link;s.origin_id=SUBGRAPH_INPUT_ID,s.origin_slot=t.parent.slots.indexOf(t),(n=this.fromSlot._floatingLinks)==null||n.delete(s),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(s)}connectToSubgraphOutput(t,i){var n;const s=this.link;s.origin_id=SUBGRAPH_OUTPUT_ID,s.origin_slot=t.parent.slots.indexOf(t),(n=this.fromSlot._floatingLinks)==null||n.delete(s),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(s)}connectToRerouteInput(t,{node:i,input:s},n){var r;const o=this.link;o.target_id=i.id,o.target_slot=i.inputs.indexOf(s),(r=this.fromSlot._floatingLinks)==null||r.delete(o),s._floatingLinks??(s._floatingLinks=new Set),s._floatingLinks.add(o),n.dispatch("input-moved",this)}connectToRerouteOutput(t,i,s,n){var r;const o=this.link;o.origin_id=i.id,o.origin_slot=i.outputs.indexOf(s),(r=this.fromSlot._floatingLinks)==null||r.delete(o),s._floatingLinks??(s._floatingLinks=new Set),s._floatingLinks.add(o),n.dispatch("output-moved",this)}}class MovingLinkBase{constructor(t,i,s,n,o=LinkDirection.CENTER){h(this,"outputNodeId");h(this,"outputNode");h(this,"outputSlot");h(this,"outputIndex");h(this,"outputPos");h(this,"inputNodeId");h(this,"inputNode");h(this,"inputSlot");h(this,"inputIndex");h(this,"inputPos");this.network=t,this.link=i,this.toType=s,this.fromReroute=n,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:d}=i,u=t.getNodeById(r)??void 0;if(!u)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=u.outputs.at(l);if(!p)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=u,this.outputSlot=p,this.outputIndex=l,this.outputPos=u.getOutputPos(l);const f=t.getNodeById(a)??void 0;if(!f)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const g=f.inputs.at(d);if(!g)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${d}] not found.`);this.inputNodeId=a,this.inputNode=f,this.inputSlot=g,this.inputIndex=d,this.inputPos=f.getInputPos(d)}}class MovingInputLink extends MovingLinkBase{constructor(i,s,n,o=LinkDirection.CENTER){super(i,s,"input",n,o);h(this,"toType","input");h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");this.node=this.outputNode,this.fromSlot=this.outputSlot,this.fromPos=(n==null?void 0:n.pos)??this.outputPos,this.fromDirection=LinkDirection.NONE,this.fromSlotIndex=this.outputIndex}canConnectToInput(i,s){return this.node.canConnectTo(i,s,this.outputSlot)}canConnectToOutput(){return!1}canConnectToReroute(i){return i.origin_id!==this.inputNode.id}connectToInput(i,s,n){var r;if(s===this.inputSlot)return;this.inputNode.disconnectInput(this.inputIndex,!0);const o=this.outputNode.connectSlots(this.outputSlot,i,s,(r=this.fromReroute)==null?void 0:r.id);return o&&n.dispatch("input-moved",this),o}connectToOutput(){throw new Error("MovingInputLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("MovingInputLink cannot connect to a subgraph input.")}connectToSubgraphOutput(i,s){var o;const n=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);s==null||s.dispatch("link-created",n)}connectToRerouteInput(i,{node:s,input:n,link:o},r,a){const{outputNode:l,outputSlot:d,fromReroute:u}=this;for(const f of a){if(f.id===this.link.parentId)break;f.totalLinks===1&&f.remove()}i.parentId=u==null?void 0:u.id,l.connectSlots(d,s,n,o.parentId)&&r.dispatch("input-moved",this)}connectToRerouteOutput(){throw new Error("MovingInputLink cannot connect to an output.")}disconnect(){return this.inputNode.disconnectInput(this.inputIndex,!0)}}class MovingOutputLink extends MovingLinkBase{constructor(i,s,n,o=LinkDirection.CENTER){super(i,s,"output",n,o);h(this,"toType","output");h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");this.node=this.inputNode,this.fromSlot=this.inputSlot,this.fromPos=(n==null?void 0:n.pos)??this.inputPos,this.fromDirection=LinkDirection.LEFT,this.fromSlotIndex=this.inputIndex}canConnectToInput(){return!1}canConnectToOutput(i,s){return i.canConnectTo(this.node,this.inputSlot,s)}canConnectToReroute(i){return i.origin_id!==this.outputNode.id}connectToInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToOutput(i,s,n){if(s===this.outputSlot)return;const o=i.connectSlots(s,this.inputNode,this.inputSlot,this.link.parentId);return o&&n.dispatch("output-moved",this),o}connectToSubgraphInput(i,s){var o;const n=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);s==null||s.dispatch("link-created",n)}connectToSubgraphOutput(){throw new Error("MovingOutputLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToRerouteOutput(i,s,n,o){var u;const{inputNode:r,inputSlot:a,fromReroute:l}=this,d=((u=i==null?void 0:i.floating)==null?void 0:u.slotType)==="output";l?l.parentId=i.id:this.link.parentId=i.id,s.connectSlots(n,r,a,this.link.parentId),d&&i.removeAllFloatingLinks(),o.dispatch("output-moved",this)}disconnect(){return this.outputNode.disconnectOutput(this.outputIndex,this.inputNode)}}class ToInputFromIoNodeLink{constructor(t,i,s,n,o=LinkDirection.CENTER,r){h(this,"toType","input");h(this,"fromSlotIndex");h(this,"fromPos");h(this,"fromDirection",LinkDirection.RIGHT);h(this,"existingLink");this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const a=i.slots.indexOf(s);if(a===-1&&s!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=a,this.fromPos=n?n.pos:s.pos,this.existingLink=r}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,s){const{fromSlot:n,fromReroute:o,existingLink:r}=this,a=n.connect(i,t,o==null?void 0:o.id);r?s.dispatch("input-moved",this):s.dispatch("link-created",a)}connectToSubgraphOutput(){throw new Error("Not implemented")}connectToRerouteInput(t,{node:i,input:s,link:n},o,r){var p;const{fromSlot:a,fromReroute:l}=this,d=((p=l==null?void 0:l.floating)==null?void 0:p.slotType)==="output";t.parentId=l==null?void 0:l.id;const u=a.connect(s,i,n.parentId);d&&l.removeAllFloatingLinks();for(const f of r){if(f.id===(l==null?void 0:l.id))break;if(f.removeLink(n),f.totalLinks===0)if(n.isFloating)f.remove();else{const g=n.toFloating("output",f.id);this.network.addFloatingLink(g),f.floating={slotType:"output"}}}this.existingLink?o.dispatch("input-moved",this):o.dispatch("link-created",u)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToInputRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){h(this,"toType","input");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.RIGHT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.outputs.indexOf(s);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:this.node.getOutputPos(r)}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,s){const{node:n,fromSlot:o,fromReroute:r}=this;if(t===n)return;const a=n.connectSlots(o,t,i,r==null?void 0:r.id);s.dispatch("link-created",a)}connectToSubgraphOutput(t,i){var n;const s=t.connect(this.fromSlot,this.node,(n=this.fromReroute)==null?void 0:n.id);i.dispatch("link-created",s)}connectToRerouteInput(t,{node:i,input:s,link:n},o,r){var f;const{node:a,fromSlot:l,fromReroute:d}=this,u=((f=d==null?void 0:d.floating)==null?void 0:f.slotType)==="output";t.parentId=d==null?void 0:d.id;const p=a.connectSlots(l,i,s,n.parentId);u&&d.removeAllFloatingLinks();for(const g of r){if(g.id===(d==null?void 0:d.id))break;if(g.removeLink(n),g.totalLinks===0)if(n.isFloating)g.remove();else{const m=n.toFloating("output",g.id);this.network.addFloatingLink(m),g.floating={slotType:"output"}}}o.dispatch("link-created",p)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToOutputFromIoNodeLink{constructor(t,i,s,n,o=LinkDirection.CENTER){h(this,"toType","output");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.slots.indexOf(s);if(r===-1&&s!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:s.pos}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,s){const{fromSlot:n,fromReroute:o}=this,r=n.connect(i,t,o==null?void 0:o.id);s.dispatch("link-created",r)}connectToSubgraphInput(){throw new Error("Not implemented")}connectToRerouteOutput(t,i,s,n){const{fromSlot:o}=this,r=o.connect(s,i,t==null?void 0:t.id);n.dispatch("link-created",r)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputRenderLink{constructor(t,i,s,n,o=LinkDirection.CENTER){h(this,"toType","output");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=s,this.fromReroute=n,this.dragDirection=o;const r=i.inputs.indexOf(s);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=n?n.pos:this.node.getInputPos(r)}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,s){const{node:n,fromSlot:o,fromReroute:r}=this;if(!n)return;const a=t.connectSlots(i,n,o,r==null?void 0:r.id);s.dispatch("link-created",a)}connectToSubgraphInput(t,i){var n;const s=t.connect(this.fromSlot,this.node,(n=this.fromReroute)==null?void 0:n.id);i==null||i.dispatch("link-created",s)}connectToRerouteOutput(t,i,s,n){const{node:o,fromSlot:r}=this,a=i.connectSlots(s,o,r,t==null?void 0:t.id);n.dispatch("link-created",a)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputFromRerouteLink extends ToOutputRenderLink{constructor(t,i,s,n,o){super(t,i,s,n),this.fromReroute=n,this.linkConnector=o}canConnectToReroute(){return!1}connectToOutput(t,i){const s=new ToInputRenderLink(this.network,t,i);this.linkConnector._connectOutputToReroute(this.fromReroute,s)}}class LinkConnector{constructor(t){P(this,Q);h(this,"state",{connectingTo:void 0,multi:!1,draggingExistingLinks:!1,snapLinksPos:void 0});h(this,"events",new CustomEventTarget);h(this,"renderLinks",[]);h(this,"inputLinks",[]);h(this,"outputLinks",[]);h(this,"floatingLinks",[]);h(this,"hiddenReroutes",new Set);h(this,"overWidget");h(this,"overWidgetType");h(this,"overReroute");P(this,me);z(this,me,t)}get isConnecting(){return this.state.connectingTo!==void 0}get draggingExistingLinks(){return this.state.draggingExistingLinks}moveInputLink(t,i){var a,l;if(this.isConnecting)throw new Error("Already dragging links.");const{state:s,inputLinks:n,renderLinks:o}=this,r=i.link;if(r==null){const d=(a=i._floatingLinks)==null?void 0:a.values().next().value;if((d==null?void 0:d.parentId)==null)return;try{const u=t.reroutes.get(d.parentId);if(!u)throw new Error(`Invalid reroute id: [${d.parentId}] for floating link id: [${d.id}].`);const p=new FloatingRenderLink(t,d,"input",u);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p)}catch(u){console.warn(`Could not create render link for link id: [${d.id}].`,d,u)}d._dragging=!0,this.floatingLinks.push(d)}else{const d=t.links.get(r);if(!d)return;if(d.origin_id===SUBGRAPH_INPUT_ID){const u=(l=t.inputNode)==null?void 0:l.slots[d.origin_slot];if(!u){console.warn(`Could not find subgraph input for slot [${d.origin_slot}]`);return}try{const p=t.getReroute(d.parentId),f=new ToInputFromIoNodeLink(t,t.inputNode,u,p,LinkDirection.CENTER,d);o.push(f),this.listenUntilReset("input-moved",()=>{d.disconnect(t,"input")})}catch(p){console.warn(`Could not create render link for subgraph input link id: [${d.id}].`,d,p);return}d._dragging=!0,n.push(d)}else{try{const u=t.getReroute(d.parentId),p=new MovingInputLink(t,d,u);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p),this.listenUntilReset("input-moved",g=>{"link"in g.detail&&g.detail.link&&g.detail.link.disconnect(t,"output")})}catch(u){console.warn(`Could not create render link for link id: [${d.id}].`,d,u);return}d._dragging=!0,n.push(d)}}s.connectingTo="input",s.draggingExistingLinks=!0,C(this,Q,ft).call(this,!1)}moveOutputLink(t,i){var o,r;if(this.isConnecting)throw new Error("Already dragging links.");const{state:s,renderLinks:n}=this;if((o=i._floatingLinks)!=null&&o.size)for(const a of i._floatingLinks.values())try{const l=LLink.getFirstReroute(t,a);if(!l)throw new Error(`Invalid reroute id: [${a.parentId}] for floating link id: [${a.id}].`);const d=new FloatingRenderLink(t,a,"output",l);if(this.events.dispatch("before-move-output",d)===!1)continue;n.push(d),this.floatingLinks.push(a)}catch(l){console.warn(`Could not create render link for link id: [${a.id}].`,a,l)}if((r=i.links)!=null&&r.length)for(const a of i.links){const l=t.links.get(a);if(!l)continue;const d=LLink.getFirstReroute(t,l);d?(d._dragging=!0,this.hiddenReroutes.add(d)):l._dragging=!0,this.outputLinks.push(l);try{const u=new MovingOutputLink(t,l,d,LinkDirection.RIGHT);if(this.events.dispatch("before-move-output",u)===!1)continue;n.push(u)}catch(u){console.warn(`Could not create render link for link id: [${l.id}].`,l,u);continue}}n.length!==0&&(s.draggingExistingLinks=!0,s.multi=!0,s.connectingTo="output",C(this,Q,ft).call(this,!0))}dragNewFromOutput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToInputRenderLink(t,i,s,n);this.renderLinks.push(r),o.connectingTo="input",C(this,Q,ft).call(this,!1)}dragNewFromInput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToOutputRenderLink(t,i,s,n);this.renderLinks.push(r),o.connectingTo="output",C(this,Q,ft).call(this,!0)}dragNewFromSubgraphInput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToInputFromIoNodeLink(t,i,s,n);this.renderLinks.push(o),this.state.connectingTo="input",C(this,Q,ft).call(this,!1)}dragNewFromSubgraphOutput(t,i,s,n){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToOutputFromIoNodeLink(t,i,s,n);this.renderLinks.push(o),this.state.connectingTo="output",C(this,Q,ft).call(this,!0)}dragFromReroute(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const s=i.firstLink??i.firstFloatingLink;if(!s){console.warn("No link found for reroute.");return}if(s.origin_id===SUBGRAPH_INPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph input link found in non-subgraph network.");return}const a=t.inputs.at(s.origin_slot);if(!a)throw new Error("No subgraph input found for link.");const l=new ToInputFromIoNodeLink(t,t.inputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="input",C(this,Q,ft).call(this,!1);return}const n=t.getNodeById(s.origin_id);if(!n){console.warn("No output node found for link.",s);return}const o=n.outputs.at(s.origin_slot);if(!o){console.warn("No output slot found for link.",s);return}const r=new ToInputRenderLink(t,n,o,i);r.fromDirection=LinkDirection.NONE,this.renderLinks.push(r),this.state.connectingTo="input",C(this,Q,ft).call(this,!1)}dragFromRerouteToOutput(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const s=i.firstLink??i.firstFloatingLink;if(!s){console.warn("No link found for reroute.");return}if(s.target_id===SUBGRAPH_OUTPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph output link found in non-subgraph network.");return}const a=t.outputs.at(s.target_slot);if(!a)throw new Error("No subgraph output found for link.");const l=new ToOutputFromIoNodeLink(t,t.outputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="output",C(this,Q,ft).call(this,!1);return}const n=t.getNodeById(s.target_id);if(!n){console.warn("No input node found for link.",s);return}const o=n.inputs.at(s.target_slot);if(!o){console.warn("No input slot found for link.",s);return}const r=new ToOutputFromRerouteLink(t,n,o,i,this);r.fromDirection=LinkDirection.LEFT,this.renderLinks.push(r),this.state.connectingTo="output",C(this,Q,ft).call(this,!0)}dragFromLinkSegment(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const{state:s}=this;if(i.origin_id==null||i.origin_slot==null)return;const n=t.getNodeById(i.origin_id);if(!n)return;const o=n.outputs.at(i.origin_slot);if(!o)return;const r=t.getReroute(i.parentId),a=new ToInputRenderLink(t,n,o,r);a.fromDirection=LinkDirection.NONE,this.renderLinks.push(a),s.connectingTo="input",C(this,Q,ft).call(this,!1)}dropLinks(t,i){var s;if(!(!this.isConnecting&&this.events.dispatch("before-drop-links",{renderLinks:this.renderLinks,event:i})===!1))try{const{canvasX:n,canvasY:o}=i,r=(s=t.getIoNodeOnPos)==null?void 0:s.call(t,n,o);if(r){this.dropOnIoNode(r,i);return}const a=t.getNodeOnPos(n,o)??void 0;if(a)this.dropOnNode(a,i);else{const l=t.getRerouteOnPos(n,o);l&&this.isRerouteValidDrop(l)?this.dropOnReroute(l,i):this.dropOnNothing(i)}}finally{this.events.dispatch("after-drop-links",{renderLinks:this.renderLinks,event:i})}}dropOnIoNode(t,i){const{renderLinks:s,state:n}=this,{connectingTo:o}=n,{canvasX:r,canvasY:a}=i;if(o==="input"&&t instanceof SubgraphOutputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No output slot found for link.");for(const d of s)d.connectToSubgraphOutput(l,this.events)}else if(o==="output"&&t instanceof SubgraphInputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No input slot found for link.");for(const d of s)d.connectToSubgraphInput(l,this.events)}else console.error("Invalid connectingTo state &/ ioNode",o,t)}dropOnNode(t,i){const{renderLinks:s,state:n}=this,{connectingTo:o}=n,{canvasX:r,canvasY:a}=i;if(!s.every(l=>l.node===t)){if(o==="output"){const l=t.getOutputOnPos([r,a]);l?C(this,Q,si).call(this,t,l):this.connectToNode(t,i)}else if(o==="input"){const d=t.getInputOnPos([r,a])??t.getSlotFromWidget(this.overWidget);d?C(this,Q,ii).call(this,t,d):this.connectToNode(t,i)}}}dropOnReroute(t,i){if(this.events.dispatch("dropped-on-reroute",{reroute:t,event:i})!==!1){if(this.state.connectingTo==="input"){if(this.renderLinks.length!==1)throw new Error(`Attempted to connect ${this.renderLinks.length} input links to a reroute.`);const n=this.renderLinks[0];this._connectOutputToReroute(t,n);return}for(const n of this.renderLinks){if(n.toType!=="output")continue;const o=t.findSourceOutput();if(!o)continue;const{node:r,output:a}=o;n.canConnectToOutput(r,a)&&n.connectToRerouteOutput(t,r,a,this.events)}}}_connectOutputToReroute(t,i){const s=t.findTargetInputs();if(!(s!=null&&s.length))return;const n=t.getReroutes();if(n===null)throw new Error("Reroute loop detected.");const o=n.slice(0,-1).reverse();if(i instanceof ToInputRenderLink){const{node:a,fromSlot:l,fromSlotIndex:d,fromReroute:u}=i;if(t.setFloatingLinkOrigin(a,l,d),u!=null)for(const p of o){if(p.id===u.id)break;for(const f of t.floatingLinkIds)p.floatingLinkIds.delete(f)}}const r=s.filter(a=>i.toType==="input"&&canConnectInputLinkToReroute(i,a.node,a.input,t));for(const a of r)i.connectToRerouteInput(t,a,this.events,o)}dropOnNothing(t){this.events.dispatch("dropped-on-canvas",t)!==!1&&this.disconnectLinks()}disconnectLinks(){for(const t of this.renderLinks)t instanceof MovingLinkBase&&t.disconnect()}connectToNode(t,i){var r,a;const{state:{connectingTo:s}}=this;if(this.events.dispatch("dropped-on-node",{node:t,event:i})===!1)return;const o=this.renderLinks[0];if(o){if(s==="output"){const l=(r=t.findOutputByType(o.fromSlot.type))==null?void 0:r.slot;if(console.debug("out",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}C(this,Q,si).call(this,t,l)}else if(s==="input"){const l=(a=t.findInputByType(o.fromSlot.type))==null?void 0:a.slot;if(console.debug("in",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}C(this,Q,ii).call(this,t,l)}}}isInputValidDrop(t,i){return this.renderLinks.some(s=>s.canConnectToInput(t,i))}isNodeValidDrop(t){return this.state.connectingTo==="output"?t.outputs.some(i=>this.renderLinks.some(s=>s.canConnectToOutput(t,i))):t.inputs.some(i=>this.renderLinks.some(s=>s.canConnectToInput(t,i)))}isRerouteValidDrop(t){if(this.state.connectingTo==="input"){const i=t.findTargetInputs();if(!(i!=null&&i.length))return!1;for(const{node:s,input:n}of i)for(const o of this.renderLinks)if(o.toType==="input"&&canConnectInputLinkToReroute(o,s,n,t))return!0}else{const i=t.findSourceOutput();if(!i)return!1;const{node:s,output:n}=i;for(const o of this.renderLinks)if(o.toType==="output"&&o.canConnectToReroute(t)&&o.canConnectToOutput(s,n))return!0}return!1}export(t){return{renderLinks:[...this.renderLinks],inputLinks:[...this.inputLinks],outputLinks:[...this.outputLinks],floatingLinks:[...this.floatingLinks],state:{...this.state},network:t}}listenUntilReset(t,i,s){this.events.addEventListener(t,i,s),this.events.addEventListener("reset",()=>this.events.removeEventListener(t,i),{once:!0})}reset(t=!1){if(this.events.dispatch("reset",t)===!1)return;const{state:s,outputLinks:n,inputLinks:o,hiddenReroutes:r,renderLinks:a,floatingLinks:l}=this;if(!(!t&&s.connectingTo===void 0)){s.connectingTo=void 0;for(const d of n)delete d._dragging;for(const d of o)delete d._dragging;for(const d of l)delete d._dragging;for(const d of r)delete d._dragging;a.length=0,o.length=0,n.length=0,l.length=0,r.clear(),s.multi=!1,s.draggingExistingLinks=!1,s.snapLinksPos=void 0}}}me=new WeakMap,Q=new WeakSet,ii=function(t,i){for(const s of this.renderLinks)s.canConnectToInput(t,i)&&s.connectToInput(t,i,this.events)},si=function(t,i){for(const s of this.renderLinks){if(!s.canConnectToOutput(t,i)){s instanceof MovingOutputLink&&s.link.parentId!==void 0&&s.outputNode.connectSlots(s.outputSlot,s.inputNode,s.inputSlot,void 0);continue}s.connectToOutput(t,i,this.events)}},ft=function(t){const i=this.renderLinks.map(s=>{var a,l;const n=t?s.fromSlot:null,o=t?null:s.fromSlot,r=s instanceof MovingLinkBase?(a=s.link)==null?void 0:a.parentId:(l=s.fromReroute)==null?void 0:l.id;return{node:s.node,slot:s.fromSlotIndex,input:n,output:o,pos:s.fromPos,afterRerouteId:r}});S(this,me).call(this,i)};function canConnectInputLinkToReroute(c,t,i,s){var o,r,a;const{fromReroute:n}=c;if(!c.canConnectToInput(t,i)||(n==null?void 0:n.id)===s.id||(o=n==null?void 0:n.getReroutes())!=null&&o.includes(s))return!1;if(c instanceof ToInputRenderLink){if(s.parentId==null){if((r=s.firstLink)!=null&&r.hasOrigin(c.node.id,c.fromSlotIndex))return!1}else if(((a=c.fromReroute)==null?void 0:a.id)===s.parentId)return!1}return!0}const _t=class _t{constructor(t){P(this,lt);h(this,"element");h(this,"pointerId");h(this,"dragStarted",!1);h(this,"eLastDown");h(this,"isDouble",!1);h(this,"isDown",!1);h(this,"resizeDirection");h(this,"clearEventsOnReset",!0);h(this,"eDown");h(this,"eMove");h(this,"eUp");P(this,te);this.element=t}static get maxClickDrift(){return S(this,Ft)}static set maxClickDrift(t){z(this,Ft,t),z(this,ye,t*t)}get finally(){return S(this,te)}set finally(t){var i;try{(i=S(this,te))==null||i.call(this)}finally{z(this,te,t)}}down(t){this.reset(),this.eDown=t,this.pointerId=t.pointerId,this.element.setPointerCapture(t.pointerId)}move(t){var n;const{eDown:i}=this;if(!i)return;if(!t.buttons){this.reset();return}if(!(t.buttons&i.buttons)){C(this,lt,ni).call(this,t),this.reset();return}if(this.eMove=t,(n=this.onDrag)==null||n.call(this,t),this.dragStarted)return;(t.timeStamp-i.timeStamp>_t.bufferTime||!C(this,lt,$e).call(this,t,i))&&C(this,lt,oi).call(this,t)}up(t){var s;if(t.button!==((s=this.eDown)==null?void 0:s.button))return!1;C(this,lt,ni).call(this,t);const{dragStarted:i}=this;return this.reset(),!i}reset(){this.finally=void 0,delete this.onClick,delete this.onDoubleClick,delete this.onDragStart,delete this.onDrag,delete this.onDragEnd,this.isDown=!1,this.isDouble=!1,this.dragStarted=!1,this.resizeDirection=void 0,this.clearEventsOnReset&&(this.eDown=void 0,this.eMove=void 0,this.eUp=void 0);const{element:t,pointerId:i}=this;this.pointerId=void 0,typeof i=="number"&&t.hasPointerCapture(i)&&t.releasePointerCapture(i)}};Ft=new WeakMap,ye=new WeakMap,te=new WeakMap,lt=new WeakSet,ni=function(t){var s,n,o;const{eDown:i}=this;i&&(this.eUp=t,this.dragStarted?(s=this.onDragEnd)==null||s.call(this,t):C(this,lt,$e).call(this,t,i)?this.onDoubleClick&&C(this,lt,Li).call(this)?(this.onDoubleClick(t),this.eLastDown=void 0):((o=this.onClick)==null||o.call(this,t),this.eLastDown=i):(C(this,lt,oi).call(this),(n=this.onDragEnd)==null||n.call(this,t)))},$e=function(t,i,s=S(_t,ye)){return dist2(t.clientX,t.clientY,i.clientX,i.clientY)<=s},Li=function(){const{eDown:t,eLastDown:i}=this;if(!t||!i)return!1;const s=(3*S(_t,Ft))**2,n=t.timeStamp-i.timeStamp;return n>0&&n<_t.doubleClickTime&&C(this,lt,$e).call(this,t,i,s)},oi=function(t){var i;this.dragStarted=!0,(i=this.onDragStart)==null||i.call(this,this,t),delete this.onDragStart},h(_t,"bufferTime",150),h(_t,"doubleClickTime",300),P(_t,Ft,6),P(_t,ye,S(_t,Ft)**2);let CanvasPointer=_t;class DragAndScale{constructor(t){P(this,Re);h(this,"state");h(this,"lastState",{offset:[0,0],scale:0});h(this,"max_scale");h(this,"min_scale");h(this,"enabled");h(this,"last_mouse");h(this,"element");h(this,"visible_area");h(this,"dragging");h(this,"viewport");this.state={offset:[0,0],scale:1},this.max_scale=10,this.min_scale=.1,this.enabled=!0,this.last_mouse=[0,0],this.visible_area=new Rectangle,this.element=t}get offset(){return this.state.offset}set offset(t){this.state.offset[0]=t[0],this.state.offset[1]=t[1]}get scale(){return this.state.scale}set scale(t){this.state.scale=t}computeVisibleArea(t){var p;const{scale:i,offset:s,visible_area:n}=this;if(C(this,Re,Ii).call(this)&&((p=this.onChanged)==null||p.call(this,i,s),copyState(this.state,this.lastState)),!this.element){n[0]=n[1]=n[2]=n[3]=0;return}let{width:o,height:r}=this.element,a=-s[0],l=-s[1];t&&(a+=t[0]/i,l+=t[1]/i,o=t[2],r=t[3]);const d=a+o/i,u=l+r/i;n[0]=a,n[1]=l,n.resizeBottomRight(d,u)}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,i){return i=i||[0,0],i[0]=t[0]/this.scale-this.offset[0],i[1]=t[1]/this.scale-this.offset[1],i}mouseDrag(t,i){var s;this.offset[0]+=t/this.scale,this.offset[1]+=i/this.scale,(s=this.onredraw)==null||s.call(this,this)}changeScale(t,i,s=!0){var d;if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t==this.scale)return;const n=this.element.getBoundingClientRect();if(!n)return;i=i??[n.width*.5,n.height*.5];const o=[i[0]-n.x,i[1]-n.y],r=this.convertCanvasToOffset(o);this.scale=t,s&&Math.abs(this.scale-1)<.01&&(this.scale=1);const a=this.convertCanvasToOffset(o),l=[a[0]-r[0],a[1]-r[1]];this.offset[0]+=l[0],this.offset[1]+=l[1],(d=this.onredraw)==null||d.call(this,this)}changeDeltaScale(t,i){this.changeScale(this.scale*t,i)}fitToBounds(t,{zoom:i=.75}={}){const s=this.element.width/window.devicePixelRatio,n=this.element.height/window.devicePixelRatio;let o=this.scale;if(i>0){const u=i*s/Math.max(t[2],300),p=i*n/Math.max(t[3],300);o=Math.min(u,p,this.max_scale)}const r=s/o,a=n/o,l=-t[0]-t[2]*.5+r*.5,d=-t[1]-t[3]*.5+a*.5;this.offset[0]=l,this.offset[1]=d,this.scale=o}animateToBounds(t,i,{duration:s=350,zoom:n=.75,easing:o=EaseFunction.EASE_IN_OUT_QUAD}={}){if(!(s>0))throw new RangeError("Duration must be greater than 0");const r={linear:N=>N,easeInQuad:N=>N*N,easeOutQuad:N=>N*(2-N),easeInOutQuad:N=>N<.5?2*N*N:-1+(4-2*N)*N},a=r[o]??r.linear,l=performance.now(),d=this.element.width/window.devicePixelRatio,u=this.element.height/window.devicePixelRatio,p=this.offset[0],f=this.offset[1],g=p-d/this.scale,m=f-u/this.scale;let y=this.scale;if(n>0){const N=n*d/Math.max(t[2],300),D=n*u/Math.max(t[3],300);y=Math.min(N,D,this.max_scale)}const b=d/y,L=u/y,k=-t[0]-t[2]*.5+b*.5,T=-t[1]-t[3]*.5+L*.5,I=k-b,E=T-L,G=N=>{const D=N-l,A=Math.min(D/s,1),B=a(A),$=p+(k-p)*B,W=f+(T-f)*B;if(this.offset[0]=$,this.offset[1]=W,n>0){const j=g+(I-g)*B,dt=m+(E-m)*B,it=Math.abs(j-$),X=Math.abs(dt-W);this.scale=Math.min(d/it,u/X)}i(),A<1?R=requestAnimationFrame(G):cancelAnimationFrame(R)};let R=requestAnimationFrame(G)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}Re=new WeakSet,Ii=function(){const t=this.state,i=this.lastState;return t.scale!==i.scale||t.offset[0]!==i.offset[0]||t.offset[1]!==i.offset[1]};function copyState(c,t){t.scale=c.scale,t.offset[0]=c.offset[0],t.offset[1]=c.offset[1]}function getBoundaryNodes(c){const t=c==null?void 0:c.find(r=>r);if(!t)return null;let i=t,s=t,n=t,o=t;for(const r of c){if(!r)continue;const[a,l]=r.pos,[d,u]=r.size;l<i.pos[1]&&(i=r),a+d>s.pos[0]+s.size[0]&&(s=r),l+u>n.pos[1]+n.size[1]&&(n=r),a<o.pos[0]&&(o=r)}return{top:i,right:s,bottom:n,left:o}}function distributeNodes(c,t){const i=c==null?void 0:c.length;if(!(i>1))return;const s=t?0:1;let n=0,o=-1/0;for(const u of c){n+=u.size[s];const p=u.pos[s]+u.size[s];p>o&&(o=p)}const r=[...c].sort((u,p)=>u.pos[s]-p.pos[s]),a=r[0].pos[s],l=(o-a-n)/(i-1);let d=a;for(let u=0;u<i;u++){const p=r[u];p.pos[s]=d+l*u,d+=p.size[s]}}function alignNodes(c,t,i){if(!c)return;const s=i===void 0?getBoundaryNodes(c):{top:i,right:i,bottom:i,left:i};if(s!==null)for(const n of c)switch(t){case"right":n.pos[0]=s.right.pos[0]+s.right.size[0]-n.size[0];break;case"left":n.pos[0]=s.left.pos[0];break;case"top":n.pos[1]=s.top.pos[1];break;case"bottom":n.pos[1]=s.bottom.pos[1]+s.bottom.size[1]-n.size[1];break}}const cursors={NE:"nesw-resize",SE:"nwse-resize",SW:"nesw-resize",NW:"nwse-resize"},O=class O{constructor(t,i,s){P(this,F);h(this,"state",{draggingItems:!1,draggingCanvas:!1,readOnly:!1,hoveringOver:CanvasItem.Nothing,shouldSetCursor:!0,selectionChanged:!1});P(this,xt);h(this,"_previously_dragging_canvas",null);P(this,Ot,0);h(this,"options");h(this,"background_image");h(this,"ds");h(this,"pointer");h(this,"zoom_modify_alpha");h(this,"zoom_speed");h(this,"node_title_color");h(this,"default_link_color");h(this,"default_connection_color");h(this,"default_connection_color_byType");h(this,"default_connection_color_byTypeOff");h(this,"colourGetter",{getConnectedColor:t=>this.default_connection_color_byType[t]||this.default_connection_color.output_on,getDisconnectedColor:t=>this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.output_off});h(this,"highquality_render");h(this,"use_gradients");h(this,"editor_alpha");h(this,"pause_rendering");h(this,"clear_background");h(this,"clear_background_color");h(this,"render_only_selected");h(this,"show_info");h(this,"allow_dragcanvas");h(this,"allow_dragnodes");h(this,"allow_interaction");h(this,"multi_select");h(this,"allow_searchbox");h(this,"allow_reconnect_links");h(this,"align_to_grid");h(this,"drag_mode");h(this,"dragging_rectangle");h(this,"filter");h(this,"set_canvas_dirty_on_mouse_event");h(this,"always_render_background");h(this,"render_shadows");h(this,"render_canvas_border");h(this,"render_connections_shadows");h(this,"render_connections_border");h(this,"render_curved_connections");h(this,"render_connection_arrows");h(this,"render_collapsed_slots");h(this,"render_execution_order");h(this,"render_link_tooltip");h(this,"linkMarkerShape",LinkMarkerShape.Circle);h(this,"links_render_mode");h(this,"low_quality_zoom_threshold",.6);h(this,"mouse");h(this,"graph_mouse");h(this,"canvas_mouse");h(this,"onSearchBox");h(this,"onSearchBoxSelection");h(this,"onMouse");h(this,"onDrawBackground");h(this,"onDrawForeground");h(this,"connections_width");h(this,"current_node");h(this,"node_widget");h(this,"over_link_center");h(this,"last_mouse_position");h(this,"visible_area");h(this,"renderedPaths",new Set);h(this,"visible_links",[]);h(this,"connecting_links");h(this,"linkConnector",new LinkConnector(t=>this.connecting_links=t));h(this,"viewport");h(this,"autoresize");h(this,"frame",0);h(this,"last_draw_time",0);h(this,"render_time",0);h(this,"fps",0);h(this,"selected_nodes",{});h(this,"selectedItems",new Set);h(this,"resizingGroup",null);h(this,"selected_group",null);h(this,"visible_nodes",[]);P(this,ve,new Set);h(this,"node_over");h(this,"node_capturing_input");h(this,"highlighted_links",{});P(this,mt,new Set);h(this,"dirty_canvas",!0);h(this,"dirty_bgcanvas",!0);h(this,"dirty_nodes",new Map);h(this,"dirty_area");h(this,"node_in_panel");h(this,"last_mouse",[0,0]);h(this,"last_mouseclick",0);h(this,"graph");h(this,"canvas");h(this,"bgcanvas");h(this,"ctx");h(this,"_events_binded");h(this,"bgctx");h(this,"is_rendering");h(this,"block_click");h(this,"last_click_position");h(this,"resizing_node");h(this,"selected_group_resizing");h(this,"last_mouse_dragging");h(this,"onMouseDown");h(this,"_highlight_pos");h(this,"_highlight_input");h(this,"node_panel");h(this,"options_panel");h(this,"_bg_img");h(this,"_pattern");h(this,"_pattern_img");h(this,"prompt_box");h(this,"search_box");h(this,"SELECTED_NODE");h(this,"NODEPANEL_IS_OPEN");P(this,ht);P(this,be,!1);h(this,"dragZoomEnabled",!1);P(this,Pt,null);h(this,"onClear");h(this,"onNodeMoved");h(this,"onSelectionChange");h(this,"onDrawLinkTooltip");h(this,"onDrawOverlay");h(this,"onRenderBackground");h(this,"onNodeDblClicked");h(this,"onShowNodePanel");h(this,"onNodeSelected");h(this,"onNodeDeselected");h(this,"onRender");s||(s={}),this.options=s,this.background_image=O.DEFAULT_BACKGROUND_IMAGE,this.ds=new DragAndScale(t),this.pointer=new CanvasPointer(t),this.linkConnector.events.addEventListener("link-created",()=>C(this,F,bt).call(this)),this.linkConnector.events.addEventListener("reset",()=>{this.connecting_links=null,this.dirty_bgcanvas=!0}),this.linkConnector.events.addEventListener("dropped-on-canvas",n=>{var a;if(!this.connecting_links)return;const o=n.detail;this.emitEvent({subType:"empty-release",originalEvent:o,linkReleaseContext:{links:this.connecting_links}});const r=this.linkConnector.renderLinks[0];if(LiteGraph.release_link_on_empty_shows_menu){const l=this.linkConnector.state.connectingTo==="input"?{node_from:r.node,slot_from:r.fromSlot,type_filter_in:r.fromSlot.type}:{node_to:r.node,slot_to:r.fromSlot,type_filter_out:r.fromSlot.type},d=(a=r.fromReroute)==null?void 0:a.id;"shiftKey"in o&&o.shiftKey?this.allow_searchbox&&this.showSearchBox(o,l):this.linkConnector.state.connectingTo==="input"?this.showConnectionMenu({nodeFrom:r.node,slotFrom:r.fromSlot,e:o,afterRerouteId:d}):this.showConnectionMenu({nodeTo:r.node,slotTo:r.fromSlot,e:o,afterRerouteId:d})}}),this.zoom_modify_alpha=!0,this.zoom_speed=1.1,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.render_only_selected=!0,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_link_tooltip=!0,this.links_render_mode=LinkRenderType.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.connections_width=3,this.current_node=null,this.node_widget=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.connecting_links=null,this.viewport=s.viewport||null,this.graph=i,i==null||i.attachCanvas(this),this.canvas=void 0,this.bgcanvas=void 0,this.ctx=void 0,this.setCanvas(t,s.skip_events),this.clear(),O._measureText=(n,o=this.inner_text_font)=>{const{ctx:r}=this,{font:a}=r;try{return r.font=o,r.measureText(n).width}finally{r.font=a}},s.skip_render||this.startRendering(),this.autoresize=s.autoresize}get subgraph(){return S(this,xt)}set subgraph(t){t!==S(this,xt)&&(z(this,xt,t),t&&this.dispatch("litegraph:set-graph",{oldGraph:S(this,xt),newGraph:t}))}dispatch(t,i){const s=new CustomEvent(t,{detail:i,bubbles:!0});return this.canvas.dispatchEvent(s)}dispatchEvent(t,i){this.canvas.dispatchEvent(new CustomEvent(t,{detail:i}))}get read_only(){return this.state.readOnly}set read_only(t){this.state.readOnly=t,C(this,F,Xe).call(this)}get isDragging(){return this.state.draggingItems}set isDragging(t){this.state.draggingItems=t}get hoveringOver(){return this.state.hoveringOver}set hoveringOver(t){this.state.hoveringOver=t,C(this,F,Xe).call(this)}get pointer_is_down(){return this.pointer.isDown}get pointer_is_double(){return this.pointer.isDouble}get dragging_canvas(){return this.state.draggingCanvas}set dragging_canvas(t){this.state.draggingCanvas=t,C(this,F,Xe).call(this)}get title_text_font(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get inner_text_font(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get maximumFps(){return S(this,Ot)>Number.EPSILON?S(this,Ot)/1e3:0}set maximumFps(t){z(this,Ot,t>Number.EPSILON?1e3/t:0)}get round_radius(){return LiteGraph.ROUND_RADIUS}set round_radius(t){LiteGraph.ROUND_RADIUS=t}get low_quality(){return this.ds.scale<this.low_quality_zoom_threshold}get _graph(){if(!this.graph)throw new NullGraphError;return this.graph}static onGroupAdd(t,i,s){const n=O.active_canvas,o=new LiteGraph.LGraphGroup;if(o.pos=n.convertEventToCanvasOffset(s),!n.graph)throw new NullGraphError;n.graph.add(o)}static getBoundaryNodes(t){const i=Array.isArray(t)?t:Object.values(t);return getBoundaryNodes(i)??{top:null,right:null,bottom:null,left:null}}static alignNodes(t,i,s){alignNodes(Object.values(t),i,s),O.active_canvas.setDirty(!0,!0)}static onNodeAlign(t,i,s,n,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:r,parentMenu:n});function r(a){alignNodes(Object.values(O.active_canvas.selected_nodes),a.toLowerCase(),o),O.active_canvas.setDirty(!0,!0)}}static onGroupAlign(t,i,s,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:o,parentMenu:n});function o(r){alignNodes(Object.values(O.active_canvas.selected_nodes),r.toLowerCase()),O.active_canvas.setDirty(!0,!0)}}static createDistributeMenu(t,i,s,n){new LiteGraph.ContextMenu(["Vertically","Horizontally"],{event:s,callback:o,parentMenu:n});function o(r){const a=O.active_canvas;distributeNodes(Object.values(a.selected_nodes),r==="Horizontally"),a.setDirty(!0,!0)}}static onMenuAdd(t,i,s,n,o){const r=O.active_canvas,a=r.getCanvasWindow(),{graph:l}=r;if(!l)return;return d("",n),!1;function d(u,p){if(!l)return;const f=LiteGraph.getNodeTypesCategories(r.filter||l.filter).filter(_=>_.startsWith(u)),g=[];for(const _ of f){if(!_)continue;const y=new RegExp(`^(${u})`),b=_.replace(y,"").split("/",1)[0],L=u===""?`${b}/`:`${u}${b}/`;let k=b;k.includes("::")&&(k=k.split("::",2)[1]),g.findIndex(I=>I.value===L)===-1&&g.push({value:L,content:k,has_submenu:!0,callback:function(I,E,G,R){d(I.value,R)}})}const m=LiteGraph.getNodeTypesInCategory(u.slice(0,-1),r.filter||l.filter);for(const _ of m){if(_.skip_list)continue;const y={value:_.type,content:_.title,has_submenu:!1,callback:function(b,L,k,T){if(!r.graph)throw new NullGraphError;const I=T.getFirstEvent();r.graph.beforeChange();const E=LiteGraph.createNode(b.value);if(E){if(!I)throw new TypeError("Context menu event was null. This should not occur in normal usage.");E.pos=r.convertEventToCanvasOffset(I),r.graph.add(E)}else console.warn("Failed to create node of type:",b.value);o==null||o(E),r.graph.afterChange()}};g.push(y)}new LiteGraph.ContextMenu(g,{event:s,parentMenu:p},a)}}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalOutputs(t,i,s,n,o){var u;if(!o)return;const r=O.active_canvas;let a=[];LiteGraph.do_add_triggers_slots&&o.findOutputSlot("onExecuted")==-1&&a.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"});const l=(u=o.onMenuNodeOutputs)==null?void 0:u.call(o,a);if(l&&(a=l),!a.length)return;new LiteGraph.ContextMenu(a,{event:s,callback:d,parentMenu:n,node:o});function d(p,f,g){var y;if(!o||(p.callback&&p.callback.call(this,o,p,f,g),!p.value))return;const m=p.value[1];if(m&&(typeof m=="object"||Array.isArray(m))){const b=[];for(const L in m)b.push({content:L,value:m[L]});return new LiteGraph.ContextMenu(b,{event:f,callback:d,parentMenu:n,node:o}),!1}const{graph:_}=o;if(!_)throw new NullGraphError;_.beforeChange(),o.addOutput(p.value[0],p.value[1],p.value[2]),(y=o.onNodeOutputAdd)==null||y.call(o,p.value),r.setDirty(!0,!0),_.afterChange()}return!1}static onShowMenuNodeProperties(t,i,s,n,o){if(!o||!o.properties)return;const r=O.active_canvas,a=r.getCanvasWindow(),l=[];for(const u in o.properties){t=o.properties[u]!==void 0?o.properties[u]:" ",typeof t=="object"&&(t=JSON.stringify(t));const p=o.getPropertyInfo(u);(p.type=="enum"||p.type=="combo")&&(t=O.getPropertyPrintableValue(t,p.values)),t=O.decodeHTML(stringOrEmpty(t)),l.push({content:`<span class='property_name'>${p.label||u}</span><span class='property_value'>${t}</span>`,value:u})}if(!l.length)return;new LiteGraph.ContextMenu(l,{event:s,callback:d,parentMenu:n,allow_html:!0,node:o},a);function d(u){if(!o)return;const p=this.getBoundingClientRect();r.showEditPropertyValue(o,u.value,{position:[p.left,p.top]})}return!1}static decodeHTML(t){const i=document.createElement("div");return i.textContent=t,i.innerHTML}static onMenuResizeNode(t,i,s,n,o){if(!o)return;const r=function(l){l.setSize(l.computeSize())},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);a.setDirty(!0,!0)}static onShowPropertyEditor(t,i,s,n,o){const r=t.property||"title",a=o[r],l=document.createElement("span");l.className="name",l.textContent=r;const d=document.createElement("input");Object.assign(d,{type:"text",className:"value",autofocus:!0});const u=document.createElement("button");u.textContent="OK";const p=Object.assign(document.createElement("div"),{is_modified:!1,className:"graphdialog",close:()=>p.remove()});p.append(l,d,u),d.value=String(a),d.addEventListener("blur",function(){this.focus()}),d.addEventListener("keydown",T=>{if(p.is_modified=!0,T.key=="Escape")p.close();else if(T.key=="Enter")L();else if(!T.target||!("localName"in T.target)||T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()});const f=O.active_canvas,g=f.canvas,m=g.getBoundingClientRect(),_=m?-20-m.left:-20,y=m?-20-m.top:-20;if(s?(p.style.left=`${s.clientX+_}px`,p.style.top=`${s.clientY+y}px`):(p.style.left=`${g.width*.5+_}px`,p.style.top=`${g.height*.5+y}px`),u.addEventListener("click",L),g.parentNode==null)throw new TypeError("canvasEl.parentNode was null");g.parentNode.append(p),d.focus();let b;p.addEventListener("mouseleave",function(){LiteGraph.dialog_close_on_mouse_leave&&!p.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(p.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),p.addEventListener("mouseenter",function(){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});function L(){d&&k(d.value)}function k(T){t.type=="Number"?T=Number(T):t.type=="Boolean"&&(T=!!T),o[r]=T,p.remove(),f.setDirty(!0,!0)}}static getPropertyPrintableValue(t,i){if(!i||Array.isArray(i))return String(t);if(typeof i=="object"){let s="";for(const n in i)if(i[n]==t){s=n;break}return`${String(t)} (${s})`}}static onMenuNodeCollapse(t,i,s,n,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.collapse()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuToggleAdvanced(t,i,s,n,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.toggleAdvanced()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuNodeMode(t,i,s,n,o){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:s,callback:r,parentMenu:n,node:o});function r(a){if(!o)return;const l=Object.values(LiteGraph.NODE_MODES).indexOf(a),d=function(p){l!==-1&&LiteGraph.NODE_MODES[l]?p.changeMode(l):(console.warn(`unexpected mode: ${a}`),p.changeMode(LGraphEventMode.ALWAYS))},u=O.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)d(o);else for(const p in u.selected_nodes)d(u.selected_nodes[p])}return!1}static onMenuNodeColors(t,i,s,n,o){if(!o)throw"no node for color";const r=[];r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const l in O.node_colors){const d=O.node_colors[l];t={value:l,content:`<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid ${d.color}; background-color:${d.bgcolor}'>${l}</span>`},r.push(t)}new LiteGraph.ContextMenu(r,{event:s,callback:a,parentMenu:n,node:o});function a(l){if(!o)return;const d=function(p){const f=l.value?O.node_colors[l.value]:null;p.setColorOption(f)},u=O.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)d(o);else for(const p in u.selected_nodes)d(u.selected_nodes[p]);u.setDirty(!0,!0)}return!1}static onMenuNodeShapes(t,i,s,n,o){if(!o)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:s,callback:r,parentMenu:n,node:o});function r(a){if(!o)return;if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const l=function(u){u.shape=a},d=O.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)l(o);else for(const u in d.selected_nodes)l(d.selected_nodes[u]);o.graph.afterChange(),d.setDirty(!0)}return!1}static onMenuNodeRemove(){O.active_canvas.deleteSelected()}static onMenuNodeClone(t,i,s,n,o){const{graph:r}=o;if(!r)throw new NullGraphError;r.beforeChange();const a=new Set,l=function(u,p){if(u.clonable===!1)return;const f=u.clone();if(f){if(f.pos=[u.pos[0]+5,u.pos[1]+5],!u.graph)throw new NullGraphError;u.graph.add(f),p.add(f)}},d=O.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)l(o,a);else for(const u in d.selected_nodes)l(d.selected_nodes[u],a);a.size&&d.selectNodes([...a]),r.afterChange(),d.setDirty(!0,!0)}clear(){var t,i;this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.selectedItems.clear(),this.state.selectionChanged=!0,(t=this.onSelectionChange)==null||t.call(this,this.selected_nodes),this.visible_nodes=[],this.node_over=void 0,this.node_capturing_input=null,this.connecting_links=null,this.highlighted_links={},this.dragging_canvas=!1,C(this,F,bt).call(this),this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer.reset(),this.visible_area.set([0,0,0,0]),(i=this.onClear)==null||i.call(this)}setGraph(t){const{graph:i}=this;t!==i&&(this.clear(),t.attachCanvas(this),this.dispatch("litegraph:set-graph",{newGraph:t,oldGraph:i}),C(this,F,bt).call(this))}openSubgraph(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s={bubbles:!0,detail:{subgraph:t,closingGraph:i},cancelable:!0};this.canvas.dispatchEvent(new CustomEvent("subgraph-opening",s))&&(this.clear(),this.subgraph=t,this.setGraph(t),this.canvas.dispatchEvent(new CustomEvent("subgraph-opened",s)))}getCurrentGraph(){return this.graph}setCanvas(t,i){var o;const s=C(this,F,Si).call(this,t);if(s===this.canvas||(!s&&this.canvas&&!i&&this.unbindEvents(),this.canvas=s,this.ds.element=s,this.pointer.element=s,!s))return;s.className+=" lgraphcanvas",s.data=this,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height;const n=(o=s.getContext)==null?void 0:o.call(s,"2d");if(n==null)throw s.localName!="canvas"?`Element supplied for LGraphCanvas must be a <canvas> element, you passed a ${s.localName}`:"This browser doesn't support Canvas";this.ctx=n,i||this.bindEvents()}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already bound");return}const{canvas:t}=this,{document:i}=this.getCanvasWindow();this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),this._mouseout_callback=this.processMouseOut.bind(this),this._mousecancel_callback=this.processMouseCancel.bind(this),t.addEventListener("pointerdown",this._mousedown_callback,!0),t.addEventListener("wheel",this._mousewheel_callback,!1),t.addEventListener("pointerup",this._mouseup_callback,!0),t.addEventListener("pointermove",this._mousemove_callback),t.addEventListener("pointerout",this._mouseout_callback),t.addEventListener("pointercancel",this._mousecancel_callback,!0),t.addEventListener("contextmenu",this._doNothing),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),i.addEventListener("keyup",this._key_callback,!0),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events bound");return}const{document:t}=this.getCanvasWindow(),{canvas:i}=this;i.removeEventListener("pointercancel",this._mousecancel_callback),i.removeEventListener("pointerout",this._mouseout_callback),i.removeEventListener("pointermove",this._mousemove_callback),i.removeEventListener("pointerup",this._mouseup_callback),i.removeEventListener("pointerdown",this._mousedown_callback),i.removeEventListener("wheel",this._mousewheel_callback),i.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),i.removeEventListener("contextmenu",this._doNothing),i.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=void 0,this._mousewheel_callback=void 0,this._key_callback=void 0,this._events_binded=!1}setDirty(t,i){t&&(this.dirty_canvas=!0),i&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();const i=this.getCanvasWindow();if(this.is_rendering)if(S(this,Ot)>0){const s=S(this,Ot)-(LiteGraph.getTime()-this.last_draw_time);setTimeout(t.bind(this),Math.max(1,s))}else i.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}getWidgetAtCursor(t){return t??(t=this.node_over),t==null?void 0:t.getWidgetOnPos(this.graph_mouse[0],this.graph_mouse[1],!0)}updateMouseOverNodes(t,i){var o,r;if(!this.graph)throw new NullGraphError;const{pointer:s}=this,n=this.graph._nodes;for(const a of n)a.mouseOver&&t!=a&&(s.eDown||(s.resizeDirection=void 0),a.mouseOver=void 0,this._highlight_input=void 0,this._highlight_pos=void 0,this.linkConnector.overWidget=void 0,a.lostFocusAt=LiteGraph.getTime(),(r=(o=this.node_over)==null?void 0:o.onMouseLeave)==null||r.call(o,i),this.node_over=void 0,this.dirty_canvas=!0)}processMouseDown(t){var d,u;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&!t.altKey&&t.buttons){z(this,Pt,{pos:[t.x,t.y],scale:this.ds.scale});return}const{graph:i,pointer:s}=this;if(this.adjustMouseEvent(t),t.isPrimary&&s.down(t),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!i)return;const n=this.getCanvasWindow();O.active_canvas=this;const o=t.clientX,r=t.clientY;if(this.ds.viewport=this.viewport,!(!this.viewport||isInRect(o,r,this.viewport)))return;const l=i.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes)??void 0;if(this.mouse[0]=o,this.mouse[1]=r,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],s.isDouble=s.isDown&&t.isPrimary,s.isDown=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(n),((d=this.onMouse)==null?void 0:d.call(this,t))!=!0){if(t.button===0&&!s.isDouble)C(this,F,Ei).call(this,t,l);else if(t.button===1)C(this,F,Oi).call(this,t,l);else if((t.button===2||s.isDouble)&&this.allow_interaction&&!this.read_only){const{linkConnector:p,subgraph:f}=this;if(f!=null&&f.inputNode.containsPoint(this.graph_mouse))this.processSelect(f.inputNode,t,!0),f.inputNode.onPointerDown(t,s,p);else if(f!=null&&f.outputNode.containsPoint(this.graph_mouse))this.processSelect(f.outputNode,t,!0),f.outputNode.onPointerDown(t,s,p);else{if(l)this.processSelect(l,t,!0);else if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const g=i.getRerouteOnPos(t.canvasX,t.canvasY,S(this,mt));g&&(t.altKey?s.onClick=m=>{var _;m.altKey&&(g.selected&&(this.deselect(g),(_=this.onSelectionChange)==null||_.call(this,this.selected_nodes)),g.remove())}:this.processSelect(g,t,!0))}s.onClick??(s.onClick=()=>this.processContextMenu(l,t))}}this.last_mouse=[o,r],this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,i.change(),(!n.document.activeElement||n.document.activeElement.nodeName.toLowerCase()!="input"&&n.document.activeElement.nodeName.toLowerCase()!="textarea")&&t.preventDefault(),t.stopPropagation(),(u=this.onMouseDown)==null||u.call(this,t)}}processMouseMove(t){var m,_,y,b;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&S(this,Pt)){C(this,F,Di).call(this,t);return}this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0);const{graph:i,resizingGroup:s,linkConnector:n,pointer:o,subgraph:r}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const a=[t.clientX,t.clientY];this.mouse[0]=a[0],this.mouse[1]=a[1];const l=[a[0]-this.last_mouse[0],a[1]-this.last_mouse[1]];this.last_mouse=a;const{canvasX:d,canvasY:u}=t;this.graph_mouse[0]=d,this.graph_mouse[1]=u,t.isPrimary&&o.move(t);let p=CanvasItem.Nothing;if(r&&(p|=r.inputNode.onPointerMove(t),p|=r.outputNode.onPointerMove(t)),this.block_click){t.preventDefault();return}if(t.dragging=this.last_mouse_dragging,this.node_widget){const[L,k]=this.node_widget;if(k!=null&&k.mouse){const T=d-L.pos[0],I=u-L.pos[1],E=k.mouse(t,[T,I],L);E!=null&&(this.dirty_canvas=E)}}const f=i.getNodeOnPos(d,u,this.visible_nodes),g=this.dragging_rectangle;if(g)g[2]=d-g[0],g[3]=u-g[1],this.dirty_canvas=!0;else if(s)p|=CanvasItem.Group,o.resizeDirection="SE";else if(this.dragging_canvas)this.ds.offset[0]+=l[0]/this.ds.scale,this.ds.offset[1]+=l[1]/this.ds.scale,C(this,F,bt).call(this);else if((this.allow_interaction||f!=null&&f.flags.allow_interaction)&&!this.read_only){if(n.isConnecting&&(this.dirty_canvas=!0),this.updateMouseOverNodes(f,t),f){p|=CanvasItem.Node,f.redraw_on_mouse&&(this.dirty_canvas=!0);const L=[0,0],k=isOverNodeInput(f,d,u,L),T=isOverNodeOutput(f,d,u,L),I=f.getWidgetOnPos(d,u,!0)??void 0;if(!f.mouseOver){f.mouseOver={},this.node_over=f,this.dirty_canvas=!0;for(const G of S(this,mt))G.hideSlots(),this.dirty_bgcanvas=!0;(m=f.onMouseEnter)==null||m.call(f,t)}(_=f.onMouseMove)==null||_.call(f,t,[d-f.pos[0],u-f.pos[1]],this);const{mouseOver:E}=f;if(E.inputId!==k||E.outputId!==T||E.overWidget!==I){if(E.inputId=k,E.outputId=T,E.overWidget=I,n.overWidget=void 0,n.isConnecting){const G=n.renderLinks.at(0);let R,N;if(!(!G||!n.isNodeValidDrop(f))){if(n.state.connectingTo==="input"){if(I){const D=f.getSlotFromWidget(I);D&&n.isInputValidDrop(f,D)&&(N=D,R=f.getInputSlotPos(D),n.overWidget=I)}if(!n.overWidget){if(k===-1&&T===-1){const D=f.findInputByType(G.fromSlot.type);D&&(N=D.slot,R=f.getInputSlotPos(D.slot))}else k!=-1&&f.inputs[k]&&LiteGraph.isValidConnection(G.fromSlot.type,f.inputs[k].type)&&(R=L,N=f.inputs[k]);if(N){const D=f.getWidgetFromSlot(N);D&&(n.overWidget=D)}}}else if(n.state.connectingTo==="output")if(k===-1&&T===-1){const D=f.findOutputByType(G.fromSlot.type);D&&(R=f.getOutputPos(D.index))}else T!=-1&&f.outputs[T]&&LiteGraph.isValidConnection(G.fromSlot.type,f.outputs[T].type)&&(R=L)}this._highlight_pos=R,this._highlight_input=N}this.dirty_canvas=!0}o.eDown||(k===-1&&T===-1&&!I?o.resizeDirection=f.findResizeDirection(d,u):o.resizeDirection&&(o.resizeDirection=void 0))}else{p=C(this,F,Ri).call(this,p);const L=C(this,F,Fi).call(this,t);if(this.over_link_center!==L&&(p|=CanvasItem.Link,this.over_link_center=L,this.dirty_bgcanvas=!0),this.canvas){const k=i.getGroupOnPos(d,u);k&&!t.ctrlKey&&!this.read_only&&k.isInResize(d,u)?o.resizeDirection="SE":o.resizeDirection&&(o.resizeDirection=void 0)}}if(this.node_capturing_input&&this.node_capturing_input!=f&&((b=(y=this.node_capturing_input).onMouseMove)==null||b.call(y,t,[d-this.node_capturing_input.pos[0],u-this.node_capturing_input.pos[1]],this)),this.isDragging){const L=this.selectedItems,k=t.ctrlKey?L:getAllNestedItems(L),T=l[0]/this.ds.scale,I=l[1]/this.ds.scale;for(const E of k)E.move(T,I,!0);C(this,F,bt).call(this)}}this.hoveringOver=p,t.preventDefault()}processMouseUp(t){var r,a,l,d;if(t.isPrimary===!1)return;const{graph:i,pointer:s}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const n=LiteGraph.getTime();if(t.click_time=n-this.last_mouseclick,s.up(t)===!0){s.isDown=!1,s.isDouble=!1,this.connecting_links=null,this.dragging_canvas=!1,i.change(),t.stopPropagation(),t.preventDefault();return}if(this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),t.button===0){this.selected_group=null,this.isDragging=!1;const u=t.canvasX,p=t.canvasY;this.linkConnector.isConnecting||(this.dirty_canvas=!0,(a=(r=this.node_over)==null?void 0:r.onMouseUp)==null||a.call(r,t,[u-this.node_over.pos[0],p-this.node_over.pos[1]],this),(d=(l=this.node_capturing_input)==null?void 0:l.onMouseUp)==null||d.call(l,t,[u-this.node_capturing_input.pos[0],p-this.node_capturing_input.pos[1]]))}else t.button===1?(this.dirty_canvas=!0,this.dragging_canvas=!1):t.button===2&&(this.dirty_canvas=!0);s.isDown=!1,s.isDouble=!1,i.change(),t.stopPropagation(),t.preventDefault()}processMouseOut(t){this.adjustMouseEvent(t),this.updateMouseOverNodes(null,t)}processMouseCancel(){console.warn("Pointer cancel!"),this.pointer.reset()}processMouseWheel(t){if(!this.graph||!this.allow_dragcanvas)return;const i=t.wheelDeltaY??t.detail*-60;this.adjustMouseEvent(t);const s=[t.clientX,t.clientY];if(this.viewport&&!isPointInRect(s,this.viewport))return;let{scale:n}=this.ds;LiteGraph.canvasNavigationMode==="legacy"||LiteGraph.canvasNavigationMode==="standard"&&t.ctrlKey?(i>0?n*=this.zoom_speed:i<0&&(n*=1/this.zoom_speed),this.ds.changeScale(n,[t.clientX,t.clientY])):LiteGraph.macTrackpadGestures&&(!LiteGraph.macGesturesRequireMac||navigator.userAgent.includes("Mac"))&&(t.metaKey&&!t.ctrlKey&&!t.shiftKey&&!t.altKey?(t.deltaY>0?n*=1/this.zoom_speed:t.deltaY<0&&(n*=this.zoom_speed),this.ds.changeScale(n,[t.clientX,t.clientY])):t.ctrlKey?(n*=1+t.deltaY*(1-this.zoom_speed)*.18,this.ds.changeScale(n,[t.clientX,t.clientY],!1)):t.shiftKey?this.ds.offset[0]-=t.deltaY*1.18*(1/n):(this.ds.offset[0]-=t.deltaX*1.18*(1/n),this.ds.offset[1]-=t.deltaY*1.18*(1/n))),this.graph.change(),t.preventDefault()}processKey(t){var n,o,r,a;z(this,be,t.shiftKey);const{graph:i}=this;if(!i)return;let s=!1;if(t.target.localName!="input"){if(t.type=="keydown"){if(t.key===" ")this.read_only=!0,this._previously_dragging_canvas===null&&(this._previously_dragging_canvas=this.dragging_canvas),this.dragging_canvas=this.pointer.isDown,s=!0;else if(t.key==="Escape"){if(this.linkConnector.isConnecting){this.linkConnector.reset(),t.preventDefault();return}(n=this.node_panel)==null||n.close(),(o=this.options_panel)==null||o.close(),(this.node_panel||this.options_panel)&&(s=!0)}else if(t.keyCode===65&&t.ctrlKey)this.selectItems(),s=!0;else if(t.keyCode===67&&(t.metaKey||t.ctrlKey)&&!t.shiftKey)this.selected_nodes&&(this.copyToClipboard(),s=!0);else if(t.keyCode===86&&(t.metaKey||t.ctrlKey))this.pasteFromClipboard({connectInputs:t.shiftKey});else if((t.key==="Delete"||t.key==="Backspace")&&t.target.localName!="input"&&t.target.localName!="textarea"){if(this.selectedItems.size===0){C(this,F,Gi).call(this);return}this.deleteSelected(),s=!0}for(const l of Object.values(this.selected_nodes))(r=l.onKeyDown)==null||r.call(l,t)}else if(t.type=="keyup"){t.key===" "&&(this.read_only=!1,this.dragging_canvas=(this._previously_dragging_canvas??!1)&&this.pointer.isDown,this._previously_dragging_canvas=null);for(const l of Object.values(this.selected_nodes))(a=l.onKeyUp)==null||a.call(l,t)}i.change(),s&&(t.preventDefault(),t.stopImmediatePropagation())}}copyToClipboard(t){var n,o,r;const i={nodes:[],groups:[],reroutes:[],links:[],subgraphs:[]},s=new Set;for(const a of t??this.selectedItems)if(a instanceof LGraphNode){if(a.clonable===!1)continue;const l=(n=a.clone())==null?void 0:n.serialize();if(!l)continue;if(l.id=a.id,i.nodes.push(l),a.inputs)for(const{link:d}of a.inputs){if(d==null)continue;const u=(r=(o=this.graph)==null?void 0:o._links.get(d))==null?void 0:r.asSerialisable();u&&i.links.push(u)}a instanceof SubgraphNode&&s.add(a.subgraph)}else a instanceof LGraphGroup?i.groups.push(a.serialize()):a instanceof Reroute&&i.reroutes.push(a.asSerialisable());for(const a of s){const l=a.clone(!0).asSerialisable();i.subgraphs.push(l)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(i))}emitEvent(t){this.canvas.dispatchEvent(new CustomEvent("litegraph:canvas",{bubbles:!0,detail:t}))}emitBeforeChange(){this.emitEvent({subType:"before-change"})}emitAfterChange(){this.emitEvent({subType:"after-change"})}_pasteFromClipboard(t={}){var m;const{connectInputs:i=!1,position:s=this.graph_mouse}=t;if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&i)return;const n=localStorage.getItem("litegrapheditor_clipboard");if(!n)return;const{graph:o}=this;if(!o)throw new NullGraphError;o.beforeChange();const r=JSON.parse(n);r.nodes??(r.nodes=[]),r.groups??(r.groups=[]),r.reroutes??(r.reroutes=[]),r.links??(r.links=[]),r.subgraphs??(r.subgraphs=[]);let a=1/0,l=1/0;for(const _ of[...r.nodes,...r.reroutes]){if(_.pos==null)throw new TypeError("Invalid node encounterd on paste.  `pos` was null.");_.pos[0]<a&&(a=_.pos[0]),_.pos[1]<l&&(l=_.pos[1])}if(r.groups)for(const _ of r.groups)_.bounding[0]<a&&(a=_.bounding[0]),_.bounding[1]<l&&(l=_.bounding[1]);const d={created:[],nodes:new Map,links:new Map,reroutes:new Map,subgraphs:new Map},{created:u,nodes:p,links:f,reroutes:g}=d;for(const _ of r.subgraphs){const y=_.id;_.id=createUuidv4();const b=o.createSubgraph(_);b.configure(_),d.subgraphs.set(y,b)}for(const _ of r.groups){_.id=-1;const y=new LGraphGroup;y.configure(_),o.add(y),u.push(y)}for(const _ of r.nodes){const y=d.subgraphs.get(_.type);y&&(_.type=y.id);const b=_.type==null?null:LiteGraph.createNode(_.type);b&&(p.set(_.id,b),_.id=-1,b.configure(_),o.add(b),u.push(b))}for(const _ of r.reroutes){const{id:y,...b}=_,L=o.setReroute(b);u.push(L),g.set(y,L)}for(const _ of g.values()){if(_.parentId==null)continue;const y=g.get(_.parentId);y&&(_.parentId=y.id)}for(const _ of r.links){let y=p.get(_.origin_id),b;_.parentId!=null&&(b=(m=g.get(_.parentId))==null?void 0:m.id),i&&LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&(y??(y=o.getNodeById(_.origin_id)),b??(b=_.parentId));const L=p.get(_.target_id);if(L){const k=y==null?void 0:y.connect(_.origin_slot,L,_.target_slot,b);k&&f.set(_.id,k)}}for(const _ of g.values()){const y=[..._.linkIds].map(b=>{var L;return((L=f.get(b))==null?void 0:L.id)??b});_.update(_.parentId,void 0,y,_.floating),_.validateLinks(o.links,o.floatingLinks)||o.removeReroute(_.id)}for(const _ of u)_.pos[0]+=s[0]-a,_.pos[1]+=s[1]-l;return this.selectItems(u),o.afterChange(),d}pasteFromClipboard(t={}){this.emitBeforeChange();try{this._pasteFromClipboard(t)}finally{this.emitAfterChange()}}processNodeDblClicked(t){var i,s;(i=this.onShowNodePanel)==null||i.call(this,t),(s=this.onNodeDblClicked)==null||s.call(this,t),this.setDirty(!0)}processSelect(t,i,s=!1){var l;const n=i==null?void 0:i.shiftKey,o=i!=null&&(i.metaKey||i.ctrlKey),r=n||o,a=r||this.multi_select;if(!t)(!r||this.multi_select)&&this.deselectAll();else if(!t.selected||!this.selectedItems.has(t))a||this.deselectAll(t),this.select(t);else if(a&&!s)this.deselect(t);else if(!s)this.deselectAll(t);else return;(l=this.onSelectionChange)==null||l.call(this,this.selected_nodes),this.setDirty(!0)}select(t){var i,s;if(!(t.selected&&this.selectedItems.has(t))&&(t.selected=!0,this.selectedItems.add(t),this.state.selectionChanged=!0,t instanceof LGraphNode)){if((i=t.onSelected)==null||i.call(t),this.selected_nodes[t.id]=t,(s=this.onNodeSelected)==null||s.call(this,t),t.inputs)for(const n of t.inputs)n.link!=null&&(this.highlighted_links[n.link]=!0);if(t.outputs)for(const n of t.outputs.flatMap(o=>o.links))n!=null&&(this.highlighted_links[n]=!0)}}deselect(t){var s,n;if(!t.selected&&!this.selectedItems.has(t)||(t.selected=!1,this.selectedItems.delete(t),this.state.selectionChanged=!0,!(t instanceof LGraphNode)))return;(s=t.onDeselected)==null||s.call(t),delete this.selected_nodes[t.id],(n=this.onNodeDeselected)==null||n.call(this,t);const{graph:i}=this;if(i){if(t.inputs)for(const o of t.inputs){if(o.link==null)continue;const r=LLink.getOriginNode(i,o.link);r&&this.selectedItems.has(r)||delete this.highlighted_links[o.link]}if(t.outputs)for(const o of t.outputs.flatMap(r=>r.links)){if(o==null)continue;const r=LLink.getTargetNode(i,o);r&&this.selectedItems.has(r)||delete this.highlighted_links[o]}}}processNodeSelected(t,i){this.processSelect(t,i,i&&(i.shiftKey||i.metaKey||i.ctrlKey||this.multi_select))}selectNode(t,i){t==null?this.deselectAll():this.selectNodes([t],i)}get empty(){if(!this.graph)throw new NullGraphError;return this.graph.empty}get positionableItems(){if(!this.graph)throw new NullGraphError;return this.graph.positionableItems()}selectItems(t,i){var n;const s=t??this.positionableItems;i||this.deselectAll();for(const o of s)this.select(o);(n=this.onSelectionChange)==null||n.call(this,this.selected_nodes),this.setDirty(!0)}selectNodes(t,i){this.selectItems(t,i)}deselectNode(t){this.deselect(t)}deselectAll(t){var o,r;if(!this.graph)return;const i=this.selectedItems;if(!i.size)return;let s;for(const a of i){if(a===t){s=a;continue}(o=a.onDeselected)==null||o.call(a),a.selected=!1}i.clear(),s&&i.add(s),this.setDirty(!0);const n=(t==null?void 0:t.id)==null?null:this.selected_nodes[t.id];if(this.selected_nodes={},this.current_node=null,this.highlighted_links={},t instanceof LGraphNode){if(n&&(this.selected_nodes[n.id]=n),t.inputs)for(const a of t.inputs)a.link!=null&&(this.highlighted_links[a.link]=!0);if(t.outputs)for(const a of t.outputs.flatMap(l=>l.links))a!=null&&(this.highlighted_links[a]=!0)}this.state.selectionChanged=!0,(r=this.onSelectionChange)==null||r.call(this,this.selected_nodes)}deselectAllNodes(){this.deselectAll()}deleteSelected(){var i,s;const{graph:t}=this;if(!t)throw new NullGraphError;this.emitBeforeChange(),t.beforeChange();for(const n of this.selectedItems)if(n instanceof LGraphNode){const o=n;if(o.block_delete)continue;o.connectInputToOutput(),t.remove(o),(i=this.onNodeDeselected)==null||i.call(this,o)}else n instanceof LGraphGroup?t.remove(n):n instanceof Reroute&&t.removeReroute(n.id);this.selected_nodes={},this.selectedItems.clear(),this.current_node=null,this.highlighted_links={},this.state.selectionChanged=!0,(s=this.onSelectionChange)==null||s.call(this,this.selected_nodes),this.setDirty(!0),t.afterChange(),this.emitAfterChange()}deleteSelectedNodes(){this.deleteSelected()}centerOnNode(t){const i=(window==null?void 0:window.devicePixelRatio)||1;this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/(this.ds.scale*i),this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/(this.ds.scale*i),this.setDirty(!0,!0)}adjustMouseEvent(t){let i=t.clientX,s=t.clientY;if(this.canvas){const n=this.canvas.getBoundingClientRect();i-=n.left,s-=n.top}t.safeOffsetX=i,t.safeOffsetY=s,t.deltaX===void 0&&(t.deltaX=i-this.last_mouse_position[0]),t.deltaY===void 0&&(t.deltaY=s-this.last_mouse_position[1]),this.last_mouse_position[0]=i,this.last_mouse_position[1]=s,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=s/this.ds.scale-this.ds.offset[1]}setZoom(t,i){this.ds.changeScale(t,i),C(this,F,bt).call(this)}convertOffsetToCanvas(t,i){return this.ds.convertOffsetToCanvas(t,i)}convertCanvasToOffset(t,i){return this.ds.convertCanvasToOffset(t,i)}convertEventToCanvasOffset(t){const i=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-i.left,t.clientY-i.top])}bringToFront(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s=i._nodes.indexOf(t);s!=-1&&(i._nodes.splice(s,1),i._nodes.push(t))}sendToBack(t){const{graph:i}=this;if(!i)throw new NullGraphError;const s=i._nodes.indexOf(t);s!=-1&&(i._nodes.splice(s,1),i._nodes.unshift(t))}computeVisibleNodes(t,i){const s=i||[];if(s.length=0,!this.graph)throw new NullGraphError;const n=t||this.graph._nodes;for(const o of n)o.updateArea(this.ctx),overlapBounding(this.visible_area,o.renderArea)&&s.push(o);return s}isNodeVisible(t){return S(this,ve).has(t.id)}draw(t,i){var n;if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const s=LiteGraph.getTime();if(this.render_time=(s-this.last_draw_time)*.001,this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(this.viewport),this.dirty_canvas||t){this.computeVisibleNodes(void 0,this.visible_nodes),z(this,ve,new Set(this.visible_nodes.map(r=>r.id)));const{subgraph:o}=this;o&&(o.inputNode.arrange(),o.outputNode.arrange())}(this.dirty_bgcanvas||i||this.always_render_background||(n=this.graph)!=null&&n._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame++}drawFrontCanvas(){var r,a,l,d,u,p,f;this.dirty_canvas=!1;const{ctx:t,canvas:i,graph:s,linkConnector:n}=this;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));const o=this.viewport||this.dirty_area;if(o&&(t.save(),t.beginPath(),t.rect(o[0],o[1],o[2],o[3]),t.clip()),z(this,ht,S(this,be)||LiteGraph.alwaysSnapToGrid?(r=this.graph)==null?void 0:r.getSnapToGridSize():void 0),this.clear_background&&(o?t.clearRect(o[0],o[1],o[2],o[3]):t.clearRect(0,0,i.width,i.height)),this.bgcanvas==this.canvas)this.drawBackCanvas();else{const g=window.devicePixelRatio;t.drawImage(this.bgcanvas,0,0,this.bgcanvas.width/g,this.bgcanvas.height/g)}if((a=this.onRender)==null||a.call(this,i,t),this.show_info&&this.renderInfo(t,o?o[0]:0,o?o[1]:0),s){t.save(),this.ds.toCanvasContext(t);const{visible_nodes:g}=this,m=S(this,ht)&&this.isDragging;for(const _ of g)t.save(),m&&this.selectedItems.has(_)&&this.drawSnapGuide(t,_),t.translate(_.pos[0],_.pos[1]),this.drawNode(_,t),t.restore();if((d=this.subgraph)==null||d.draw(t,this.colourGetter,(l=this.linkConnector.renderLinks[0])==null?void 0:l.fromSlot,this.editor_alpha),this.render_execution_order&&this.drawExecutionOrder(t),s.config.links_ontop&&this.drawConnections(t),n.isConnecting){const{renderLinks:_}=n,y=C(this,F,xi).call(this);t.lineWidth=this.connections_width;for(const b of _){const{fromSlot:L,fromPos:k,fromDirection:T,dragDirection:I}=b,E=L.shape,G=L.type,R=G===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR;this.renderLink(t,k,y,null,!1,null,R,T,I),t.beginPath(),G===LiteGraph.EVENT||E===RenderShape.BOX?(t.rect(k[0]-6+.5,k[1]-5+.5,14,10),t.rect(y[0]-6+.5,y[1]-5+.5,14,10)):E===RenderShape.ARROW?(t.moveTo(k[0]+8,k[1]+.5),t.lineTo(k[0]-4,k[1]+6+.5),t.lineTo(k[0]-4,k[1]-6+.5),t.closePath()):(t.arc(k[0],k[1],4,0,Math.PI*2),t.arc(y[0],y[1],4,0,Math.PI*2)),t.fill()}C(this,F,Pi).call(this,t,y)}if(this.dragging_rectangle){const{eDown:_,eMove:y}=this.pointer;if(t.strokeStyle="#FFF",_&&y){const b=t.getTransform(),L=Math.max(1,window.devicePixelRatio);t.setTransform(L,0,0,L,0,0);const k=_.safeOffsetX,T=_.safeOffsetY;t.strokeRect(k,T,y.safeOffsetX-k,y.safeOffsetY-T),t.setTransform(b)}else{const[b,L,k,T]=this.dragging_rectangle;t.strokeRect(b,L,k,T)}}!this.isDragging&&this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):(u=this.onDrawLinkTooltip)==null||u.call(this,t,null),(p=this.onDrawForeground)==null||p.call(this,t,this.visible_area),t.restore()}(f=this.onDrawOverlay)==null||f.call(this,t),o&&t.restore()}renderInfo(t,i,s){i=i||10,s=s||this.canvas.offsetHeight-80,t.save(),t.translate(i,s),t.font=`10px ${LiteGraph.DEFAULT_FONT}`,t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText(`T: ${this.graph.globaltime.toFixed(2)}s`,5,13*1),t.fillText(`I: ${this.graph.iteration}`,5,13*2),t.fillText(`N: ${this.graph._nodes.length} [${this.visible_nodes.length}]`,5,13*3),t.fillText(`V: ${this.graph._version}`,5,13*4),t.fillText(`FPS:${this.fps.toFixed(2)}`,5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var o;const t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const i=this.bgctx;if(!i)throw new TypeError("Background canvas context was null.");const s=this.viewport||[0,0,i.canvas.width,i.canvas.height];this.clear_background&&i.clearRect(s[0],s[1],s[2],s[3]);const n=this.onRenderBackground?this.onRenderBackground(t,i):!1;if(!this.viewport){const r=window.devicePixelRatio;i.restore(),i.setTransform(r,0,0,r,0,0)}if(this.graph){if(i.save(),this.ds.toCanvasContext(i),this.ds.scale<1.5&&!n&&this.clear_background_color&&(i.fillStyle=this.clear_background_color,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!n){if(this.zoom_modify_alpha?i.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:i.globalAlpha=this.editor_alpha,i.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const a=this;this._bg_img.addEventListener("load",function(){a.draw(!0,!0)})}let r=this._pattern;r==null&&this._bg_img.width>0&&(r=i.createPattern(this._bg_img,"repeat")??void 0,this._pattern_img=this._bg_img,this._pattern=r),r&&(i.fillStyle=r,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),i.fillStyle="transparent"),i.globalAlpha=1,i.imageSmoothingEnabled=!0}this.graph._groups.length&&this.drawGroups(t,i),(o=this.onDrawBackground)==null||o.call(this,i,this.visible_area),this.render_canvas_border&&(i.strokeStyle="#235",i.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(i.shadowColor="#000",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=6):i.shadowColor="rgba(0,0,0,0)",this.drawConnections(i),i.shadowColor="rgba(0,0,0,0)",i.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,i){var d,u,p;this.current_node=t;const s=t.renderingColor,n=t.renderingBgColor,{low_quality:o,editor_alpha:r}=this;if(i.globalAlpha=r,this.render_shadows&&!o?(i.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",t.flags.collapsed&&((d=t.onDrawCollapsed)==null?void 0:d.call(t,i,this))==!0)return;const a=t._shape||RenderShape.BOX,l=S(O,Ae);if(l.set(t.renderingSize),t.collapsed&&(i.font=this.inner_text_font),t.clip_area&&(i.save(),i.beginPath(),a==RenderShape.BOX?i.rect(0,0,l[0],l[1]):a==RenderShape.ROUND?i.roundRect(0,0,l[0],l[1],[10]):a==RenderShape.CIRCLE&&i.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),i.clip()),this.drawNodeShape(t,i,l,s,n,!!t.selected),t.title_buttons&&!t.flags.collapsed){const f=LiteGraph.NODE_TITLE_HEIGHT;let g=l[0];for(let m=0;m<t.title_buttons.length;m++){const _=t.title_buttons[m];if(!_.visible)continue;const y=_.getWidth(i);g-=y;const b=-f+(f-_.height)/2;_.draw(i,g,b),g-=2}}o||t.drawBadges(i),i.shadowColor="transparent",i.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,(u=t.onDrawForeground)==null||u.call(t,i,this,this.canvas),i.font=this.inner_text_font,t._setConcreteSlots(),t.collapsed?this.render_collapsed_slots&&t.drawCollapsedSlots(i):(t.arrange(),t.drawSlots(i,{fromSlot:(p=this.linkConnector.renderLinks[0])==null?void 0:p.fromSlot,colorContext:this.colourGetter,editorAlpha:this.editor_alpha,lowQuality:this.low_quality}),i.textAlign="left",i.globalAlpha=1,this.drawNodeWidgets(t,null,i)),t.clip_area&&i.restore(),i.globalAlpha=1}drawLinkTooltip(t,i){var d;const s=i._pos;if(t.fillStyle="black",t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const u=t.getTransform();t.translate(s[0],s[1]),Number.isFinite(i._centreAngle)&&t.rotate(i._centreAngle),t.moveTo(-2,-3),t.lineTo(4,0),t.lineTo(-2,3),t.setTransform(u)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(s[0],s[1],3,0,Math.PI*2);t.fill();const{data:n}=i;if(n==null||((d=this.onDrawLinkTooltip)==null?void 0:d.call(this,t,i,this))==!0)return;let o=null;if(typeof n=="number"?o=n.toFixed(2):typeof n=="string"?o=`"${n}"`:typeof n=="boolean"?o=String(n):n.toToolTip?o=n.toToolTip():o=`[${n.constructor.name}]`,o==null)return;o=o.substring(0,30),t.font="14px Courier New";const a=t.measureText(o).width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(s[0]-a*.5,s[1]-15-l,a,l,[3]),t.moveTo(s[0]-10,s[1]-15),t.lineTo(s[0]+10,s[1]-15),t.lineTo(s[0],s[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(o,s[0],s[1]-15-l*.3)}drawNodeShape(t,i,s,n,o,r){var _,y;i.strokeStyle=n,i.fillStyle=o;const a=LiteGraph.NODE_TITLE_HEIGHT,{low_quality:l}=this,{collapsed:d}=t.flags,u=t.renderingShape,{title_mode:p}=t,f=!(p==TitleMode.TRANSPARENT_TITLE||p==TitleMode.NO_TITLE),g=S(O,Fe);g.set(t.boundingRect),g[0]-=t.pos[0],g[1]-=t.pos[1];const m=i.globalAlpha;i.beginPath(),u==RenderShape.BOX||l?i.rect(g[0],g[1],g[2],g[3]):u==RenderShape.ROUND||u==RenderShape.CARD?i.roundRect(g[0],g[1],g[2],g[3],u==RenderShape.CARD?[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]:[LiteGraph.ROUND_RADIUS]):u==RenderShape.CIRCLE&&i.arc(s[0]*.5,s[1]*.5,s[0]*.5,0,Math.PI*2),i.fill(),!d&&f&&(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,g[2],2)),i.shadowColor="transparent",(_=t.onDrawBackground)==null||_.call(t,i),(f||p==TitleMode.TRANSPARENT_TITLE)&&(t.drawTitleBarBackground(i,{scale:this.ds.scale,low_quality:l}),t.drawTitleBox(i,{scale:this.ds.scale,low_quality:l,box_size:10}),i.globalAlpha=m,t.drawTitleText(i,{scale:this.ds.scale,default_title_color:this.node_title_color,low_quality:l}),(y=t.onDrawTitle)==null||y.call(t,i));for(const b of Object.values(t.strokeStyles)){const L=b.call(t);L&&strokeShape(i,g,{shape:u,title_height:a,title_mode:p,collapsed:d,...L})}t.drawProgressBar(i),t.execute_triggered!=null&&t.execute_triggered>0&&t.execute_triggered--,t.action_triggered!=null&&t.action_triggered>0&&t.action_triggered--}drawSnapGuide(t,i,s=RenderShape.ROUND){const n=S(O,Ge);n.set(i.boundingRect);const{pos:o}=i,r=o[0]-n[0],a=o[1]-n[1];n[0]+=r,n[1]+=a,S(this,ht)&&snapPoint(n,S(this,ht)),n[0]-=r,n[1]-=a;const{globalAlpha:l}=t;t.globalAlpha=1,t.beginPath();const[d,u,p,f]=n;if(s===RenderShape.CIRCLE){const g=d+p*.5,m=u+f*.5,_=Math.min(p*.5,f*.5);t.arc(g,m,_,0,Math.PI*2)}else t.rect(d,u,p,f);t.lineWidth=.5,t.strokeStyle="#FFFFFF66",t.fillStyle="#FFFFFF22",t.fill(),t.stroke(),t.globalAlpha=l}drawConnections(t){if(this.renderedPaths.clear(),this.links_render_mode===LinkRenderType.HIDDEN_LINK)return;const{graph:i,subgraph:s}=this;if(!i)throw new NullGraphError;const n=[],o=LiteGraph.getTime(),{visible_area:r}=this;S(O,Ct)[0]=r[0]-20,S(O,Ct)[1]=r[1]-20,S(O,Ct)[2]=r[2]+40,S(O,Ct)[3]=r[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;const a=i._nodes;for(const d of a){const{inputs:u}=d;if(u!=null&&u.length)for(const[p,f]of u.entries()){if(!f||f.link==null)continue;const g=f.link,m=i._links.get(g);if(!m)continue;const _=d.getInputPos(p),y=i.getNodeById(m.origin_id);if(y==null)continue;const b=m.origin_slot,L=b===-1?[y.pos[0]+10,y.pos[1]+10]:y.getOutputPos(b),k=y.outputs[b];k&&C(this,F,ne).call(this,t,m,L,_,n,o,k.dir,f.dir)}}if(s){for(const d of s.inputNode.slots)if(d.linkIds.length)for(const u of d.linkIds){const p=LLink.resolve(u,i);if(!p)continue;const{link:f,inputNode:g,input:m}=p;if(!g||!m)continue;const _=g.getInputPos(f.target_slot);C(this,F,ne).call(this,t,f,d.pos,_,n,o,m.dir,m.dir)}for(const d of s.outputNode.slots){if(!d.linkIds.length)continue;const u=LLink.resolve(d.linkIds[0],i);if(!u)continue;const{link:p,outputNode:f,output:g}=u;if(!f||!g)continue;const m=f.getOutputPos(p.origin_slot);C(this,F,ne).call(this,t,p,m,d.pos,n,o,g.dir,d.dir)}}i.floatingLinks.size>0&&C(this,F,Wi).call(this,t,i,n,o);const l=S(this,mt);l.clear(),n.sort((d,u)=>d.linkIds.size-u.linkIds.size);for(const d of n)l.add(d),S(this,ht)&&this.isDragging&&this.selectedItems.has(d)&&this.drawSnapGuide(t,d,RenderShape.CIRCLE),d.draw(t,this._pattern),this.pointer.isDown||d.drawSlots(t);t.globalAlpha=1}renderLink(t,i,s,n,o,r,a,l,d,{startControl:u,endControl:p,reroute:f,num_sublines:g=1,disabled:m=!1}={}){const _=n!=null&&this.highlighted_links[n.id]?"#FFF":a||(n==null?void 0:n.color)||(n==null?void 0:n.type)!=null&&O.link_type_colors[n.type]||this.default_link_color,y=l||LinkDirection.RIGHT,b=d||LinkDirection.LEFT,L=this.links_render_mode==LinkRenderType.SPLINE_LINK&&(!p||!u)?distance(i,s):0;this.render_connections_border&&!this.low_quality&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",g||(g=1),g>1&&(t.lineWidth=.5);const k=new Path2D,T=f??n;T&&(T.path=k);const I=S(O,xe),E=S(O,Pe),G=(T==null?void 0:T._pos)??[0,0];for(let R=0;R<g;R++){const N=(R-(g-1)*.5)*5;if(I[0]=i[0],I[1]=i[1],E[0]=s[0],E[1]=s[1],this.links_render_mode==LinkRenderType.SPLINE_LINK){if(p?(E[0]=s[0]+p[0],E[1]=s[1]+p[1]):C(this,F,Ce).call(this,E,b,L),u?(I[0]=i[0]+u[0],I[1]=i[1]+u[1]):C(this,F,Ce).call(this,I,y,L),k.moveTo(i[0],i[1]+N),k.bezierCurveTo(I[0],I[1]+N,E[0],E[1]+N,s[0],s[1]+N),findPointOnCurve(G,i,s,I,E,.5),T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const D=S(O,We);findPointOnCurve(D,i,s,I,E,.51),T._centreAngle=Math.atan2(D[1]-G[1],D[0]-G[0])}}else{const D=this.links_render_mode==LinkRenderType.LINEAR_LINK?15:10;switch(y){case LinkDirection.LEFT:I[0]+=-D;break;case LinkDirection.RIGHT:I[0]+=D;break;case LinkDirection.UP:I[1]+=-D;break;case LinkDirection.DOWN:I[1]+=D;break}switch(b){case LinkDirection.LEFT:E[0]+=-D;break;case LinkDirection.RIGHT:E[0]+=D;break;case LinkDirection.UP:E[1]+=-D;break;case LinkDirection.DOWN:E[1]+=D;break}if(this.links_render_mode==LinkRenderType.LINEAR_LINK)k.moveTo(i[0],i[1]+N),k.lineTo(I[0],I[1]+N),k.lineTo(E[0],E[1]+N),k.lineTo(s[0],s[1]+N),G[0]=(I[0]+E[0])*.5,G[1]=(I[1]+E[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow&&(T._centreAngle=Math.atan2(E[1]-I[1],E[0]-I[0]));else if(this.links_render_mode==LinkRenderType.STRAIGHT_LINK){const A=(I[0]+E[0])*.5;if(k.moveTo(i[0],i[1]),k.lineTo(I[0],I[1]),k.lineTo(A,I[1]),k.lineTo(A,E[1]),k.lineTo(E[0],E[1]),k.lineTo(s[0],s[1]),G[0]=A,G[1]=(I[1]+E[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const B=E[1]-I[1];Math.abs(B)<4?T._centreAngle=0:B>0?T._centreAngle=Math.PI*.5:T._centreAngle=-(Math.PI*.5)}}else return}}if(this.render_connections_border&&!this.low_quality&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke(k)),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=_,t.stroke(k),this.ds.scale>=.6&&this.highquality_render&&T){if(this.render_connection_arrows){const R=this.computeConnectionPoint(i,s,.25,y,b),N=this.computeConnectionPoint(i,s,.26,y,b),D=this.computeConnectionPoint(i,s,.75,y,b),A=this.computeConnectionPoint(i,s,.76,y,b);let B=0,$=0;this.render_curved_connections?(B=-Math.atan2(N[0]-R[0],N[1]-R[1]),$=-Math.atan2(A[0]-D[0],A[1]-D[1])):$=B=s[1]>i[1]?0:Math.PI;const W=t.getTransform();t.translate(R[0],R[1]),t.rotate(B),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(W),t.translate(D[0],D[1]),t.rotate($),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(W)}if(t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const R=t.getTransform();t.translate(G[0],G[1]),T._centreAngle&&t.rotate(T._centreAngle),t.moveTo(-3.2,-5),t.lineTo(7,0),t.lineTo(-3.2,5),t.setTransform(R)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(G[0],G[1],5,0,Math.PI*2);if(m){const{fillStyle:R,globalAlpha:N}=t;t.fillStyle=this._pattern??"#797979",t.globalAlpha=.75,t.fill(),t.globalAlpha=N,t.fillStyle=R}if(t.fill(),LLink._drawDebug){const{fillStyle:R,font:N,globalAlpha:D,lineWidth:A,strokeStyle:B}=t;t.globalAlpha=1,t.lineWidth=4,t.fillStyle="white",t.strokeStyle="black",t.font="16px Arial";const $=String(T.id),{width:W,actualBoundingBoxAscent:j}=t.measureText($),dt=G[0]-W*.5,it=G[1]+j*.5;t.strokeText($,dt,it),t.fillText($,dt,it),t.font=N,t.globalAlpha=D,t.lineWidth=A,t.fillStyle=R,t.strokeStyle=B}}if(r){t.fillStyle=_;for(let R=0;R<5;++R){const N=(LiteGraph.getTime()*.001+R*.2)%1,D=this.computeConnectionPoint(i,s,N,y,b);t.beginPath(),t.arc(D[0],D[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,i,s,n,o){n||(n=LinkDirection.RIGHT),o||(o=LinkDirection.LEFT);const r=distance(t,i),a=[t[0],t[1]],l=[i[0],i[1]];C(this,F,Ce).call(this,a,n,r),C(this,F,Ce).call(this,l,o,r);const d=(1-s)*(1-s)*(1-s),u=3*((1-s)*(1-s))*s,p=3*(1-s)*(s*s),f=s*s*s,g=d*t[0]+u*a[0]+p*l[0]+f*i[0],m=d*t[1]+u*a[1]+p*l[1]+f*i[1];return[g,m]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;const{visible_nodes:i}=this;for(const s of i)t.fillStyle="black",t.fillRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),s.order==0&&t.strokeRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(stringOrEmpty(s.order),s.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,s.pos[1]-6);t.globalAlpha=1}drawNodeWidgets(t,i,s){t.drawWidgets(s,{lowQuality:this.low_quality,editorAlpha:this.editor_alpha})}drawGroups(t,i){if(!this.graph)return;const s=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;const n=S(this,ht)&&this.isDragging;for(const o of s)overlapBounding(this.visible_area,o._bounding)&&(n&&this.selectedItems.has(o)&&this.drawSnapGuide(i,o),o.draw(this,i));i.restore()}resize(t,i){if(!t&&!i){const s=this.canvas.parentElement;if(!s)throw new TypeError("Attempted to resize canvas, but parent element was null.");t=s.offsetWidth,i=s.offsetHeight}this.canvas.width==t&&this.canvas.height==i||(this.canvas.width=t??0,this.canvas.height=i??0,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}onNodeSelectionChange(){}boundaryNodesForSelection(){return O.getBoundaryNodes(this.selected_nodes)}showLinkMenu(t,i){var f,g;const{graph:s}=this;if(!s)throw new NullGraphError;const n="data"in t&&t.data!=null?t.data.constructor.name:void 0,{origin_id:o,origin_slot:r}=t;if(o==null||r==null)return new LiteGraph.ContextMenu(["Link has no origin"],{event:i,title:n}),!1;const a=s.getNodeById(o),l=(g=(f=a==null?void 0:a.outputs)==null?void 0:f[r])==null?void 0:g.type,d=["Add Node","Add Reroute",null,"Delete",null],u=new LiteGraph.ContextMenu(d,{event:i,title:n,callback:p.bind(this)});return!1;function p(m,_,y){if(!s)throw new NullGraphError;switch(m){case"Add Node":O.onMenuAdd(null,null,y,u,b=>{var k,T;if(!((k=b==null?void 0:b.inputs)!=null&&k.length)||!((T=b==null?void 0:b.outputs)!=null&&T.length)||r==null)return;const L={afterRerouteId:t.parentId};a!=null&&a.connectByType(r,b,l??"*",L)&&(b.pos[0]-=b.size[0]*.5)});break;case"Add Reroute":{try{this.emitBeforeChange(),this.adjustMouseEvent(y),s.createReroute(t._pos,t),this.setDirty(!1,!0)}catch(b){console.error(b)}finally{this.emitAfterChange()}break}case"Delete":s.removeLink(t.id);break}}}createDefaultNodeForSlot(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[0,0],nodeType:void 0,posAdd:[0,0],posSizeFix:[0,0]},t),{afterRerouteId:s}=i,n=i.nodeFrom&&i.slotFrom!==null,o=!n&&i.nodeTo&&i.slotTo!==null;if(!n&&!o)return console.warn("No data passed to createDefaultNodeForSlot",i.nodeFrom,i.slotFrom,i.nodeTo,i.slotTo),!1;if(!i.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const r=n?i.nodeFrom:i.nodeTo;if(!r)throw new TypeError("nodeX was null when creating default node for slot.");let a=n?i.slotFrom:i.slotTo,l=!1;if(r instanceof SubgraphIONodeBase){if(typeof a!="object"||!a)return console.warn("Cant get slot information",a),!1;const{name:p}=a;if(l=r.slots.findIndex(f=>f.name===p),a=r.slots[l],!a)return console.warn("Cant get slot information",a),!1}else switch(typeof a){case"string":l=n?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=n?r.outputs[a]:r.inputs[a];break;case"object":if(a===null)return console.warn("Cant get slot information",a),!1;l=n?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":l=a,a=n?r.outputs[a]:r.inputs[a];break;case"undefined":default:return console.warn("Cant get slot information",a),!1}const d=a.type==LiteGraph.EVENT?"_event_":a.type,u=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(u!=null&&u[d]){let p=!1;if(typeof u[d]=="object"){for(const f in u[d])if(i.nodeType==u[d][f]||i.nodeType=="AUTO"){p=u[d][f];break}}else(i.nodeType==u[d]||i.nodeType=="AUTO")&&(p=u[d]);if(p){let f=!1;typeof p=="object"&&p.node&&(f=p,p=p.node);const g=LiteGraph.createNode(p);if(g){if(f){if(f.properties)for(const y in f.properties)g.addProperty(y,f.properties[y]);if(f.inputs){g.inputs=[];for(const y in f.inputs)g.addOutput(f.inputs[y][0],f.inputs[y][1])}if(f.outputs){g.outputs=[];for(const y in f.outputs)g.addOutput(f.outputs[y][0],f.outputs[y][1])}f.title&&(g.title=f.title),f.json&&g.configure(f.json)}if(!this.graph)throw new NullGraphError;this.graph.add(g),g.pos=[i.position[0]+i.posAdd[0]+(i.posSizeFix[0]?i.posSizeFix[0]*g.size[0]:0),i.position[1]+i.posAdd[1]+(i.posSizeFix[1]?i.posSizeFix[1]*g.size[1]:0)];const m={node:g,opts:i};if(!this.canvas.dispatchEvent(new CustomEvent("connect-new-default-node",{detail:m,cancelable:!0})))return!0;if(n){if(!i.nodeFrom)throw new TypeError("createDefaultNodeForSlot - nodeFrom was null");i.nodeFrom.connectByType(l,g,d,{afterRerouteId:s})}else{if(!i.nodeTo)throw new TypeError("createDefaultNodeForSlot - nodeTo was null");i.nodeTo.connectByTypeOutput(l,g,d,{afterRerouteId:s})}return!0}console.log(`failed creating ${p}`)}}return!1}showConnectionMenu(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:void 0,allow_searchbox:this.allow_searchbox,showSearchBox:this.showSearchBox},t||{}),s=()=>C(this,F,bt).call(this),n=this,{graph:o}=this,{afterRerouteId:r}=i,a=i.nodeFrom&&i.slotFrom,l=!a&&i.nodeTo&&i.slotTo;if(!a&&!l){console.warn("No data passed to showConnectionMenu");return}const d=a?i.nodeFrom:i.nodeTo;if(!d)throw new TypeError("nodeX was null when creating default node for slot.");let u=a?i.slotFrom:i.slotTo,p;if(d instanceof SubgraphIONodeBase){if(typeof u!="object"||!u){console.warn("Cant get slot information",u);return}const{name:b}=u;if(p=d.slots.findIndex(L=>L.name===b),p!==-1&&(u=d.slots[p]),!u){console.warn("Cant get slot information",u);return}}else switch(typeof u){case"string":p=a?d.findOutputSlot(u,!1):d.findInputSlot(u,!1),u=a?d.outputs[u]:d.inputs[u];break;case"object":if(u===null){console.warn("Cant get slot information",u);return}p=a?d.findOutputSlot(u.name):d.findInputSlot(u.name);break;case"number":p=u,u=a?d.outputs[u]:d.inputs[u];break;default:console.warn("Cant get slot information",u);return}const f=["Add Node","Add Reroute",null];i.allow_searchbox&&f.push("Search",null);const g=u.type==LiteGraph.EVENT?"_event_":u.type,m=a?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(m!=null&&m[g])if(typeof m[g]=="object")for(const b in m[g])f.push(m[g][b]);else f.push(m[g]);const _=new LiteGraph.ContextMenu(f,{event:i.e,extra:u,title:(u&&u.name!=""?u.name+(g?" | ":""):"")+(u&&g?g:""),callback:y});return _;function y(b,L,k){var T,I;switch(b){case"Add Node":O.onMenuAdd(null,null,k,_,function(E){if(E)if(a){if(!i.nodeFrom)throw new TypeError("Cannot add node to SubgraphInputNode: nodeFrom was null");i.nodeFrom.connectByType(p,E,g,{afterRerouteId:r})||console.warn("Failed to make new connection.")}else{if(!i.nodeTo)throw new TypeError("Cannot add node to SubgraphInputNode: nodeTo was null");i.nodeTo.connectByTypeOutput(p,E,g,{afterRerouteId:r})}});break;case"Add Reroute":{const E=a?i.nodeFrom:i.nodeTo,G=L.extra;if(!o)throw new NullGraphError;if(!E)throw new TypeError("Cannot add reroute: node was null");if(!G)throw new TypeError("Cannot add reroute: slot was null");if(!i.e)throw new TypeError("Cannot add reroute: CanvasPointerEvent was null");if(E instanceof SubgraphIONodeBase)throw new TypeError("Cannot add floating reroute to Subgraph IO Nodes");if(!E.connectFloatingReroute([i.e.canvasX,i.e.canvasY],G,r))throw new Error("Failed to create reroute");s();break}case"Search":a?i.showSearchBox(k,{node_from:i.nodeFrom,slot_from:u,type_filter_in:g}):i.showSearchBox(k,{node_to:i.nodeTo,slot_from:u,type_filter_out:g});break;default:{const E={position:[((T=i.e)==null?void 0:T.canvasX)??0,((I=i.e)==null?void 0:I.canvasY)??0],nodeType:b,afterRerouteId:r},G=Object.assign(i,E);if(!n.createDefaultNodeForSlot(G))break}}}}prompt(t,i,s,n,o){var E;const r=this;t=t||"";const a={is_modified:!1,className:"graphdialog rounded",innerHTML:o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",close(){r.prompt_box=null,d.parentNode&&d.remove()}},l=document.createElement("div"),d=Object.assign(l,a),u=O.active_canvas,{canvas:p}=u;if(!p.parentNode)throw new TypeError("canvas element parentNode was null when opening a prompt.");p.parentNode.append(d),this.ds.scale>1&&(d.style.transform=`scale(${this.ds.scale})`);let f,g=0;LiteGraph.pointerListenerAdd(d,"leave",function(){g||LiteGraph.dialog_close_on_mouse_leave&&!d.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(d.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(d,"enter",function(){LiteGraph.dialog_close_on_mouse_leave&&f&&clearTimeout(f)});const m=d.querySelectorAll("select");if(m)for(const G of m)G.addEventListener("click",function(){g++}),G.addEventListener("blur",function(){g=0}),G.addEventListener("change",function(){g=-1});(E=this.prompt_box)==null||E.close(),this.prompt_box=d;const _=d.querySelector(".name");if(!_)throw new TypeError("name_element was null");_.textContent=t;const y=d.querySelector(".value");if(!y)throw new TypeError("value_element was null");y.value=i,y.select();const b=y;b.addEventListener("keydown",function(G){if(d.is_modified=!0,G.key=="Escape")d.close();else if(G.key=="Enter"&&G.target.localName!="textarea")s&&s(this.value),d.close();else return;G.preventDefault(),G.stopPropagation()});const L=d.querySelector("button");if(!L)throw new TypeError("button was null when opening prompt");L.addEventListener("click",function(){s==null||s(b.value),r.setDirty(!0),d.close()});const k=p.getBoundingClientRect();let T=-20,I=-20;return k&&(T-=k.left,I-=k.top),n?(d.style.left=`${n.clientX+T}px`,d.style.top=`${n.clientY+I}px`):(d.style.left=`${p.width*.5+T}px`,d.style.top=`${p.height*.5+I}px`),setTimeout(function(){var N,D;b.focus();const G=Date.now();function R(A){var B,$;A.target===p&&Date.now()-G>256&&(d.close(),(B=p.parentElement)==null||B.removeEventListener("click",R),($=p.parentElement)==null||$.removeEventListener("touchend",R))}(N=p.parentElement)==null||N.addEventListener("click",R),(D=p.parentElement)==null||D.addEventListener("touchend",R)},10),d}showSearchBox(t,i){var R;const s={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};Object.assign(s,i);const n=this,o=O.active_canvas,{canvas:r}=o,a=r.ownerDocument||document,l=document.createElement("div"),d=Object.assign(l,{close(){n.search_box=void 0,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(()=>r.focus(),20),d.remove()}});d.className="litegraph litesearchbox graphdialog rounded",d.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",s.do_type_filter&&(d.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",d.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>");const u=document.createElement("div");u.className="helper",d.append(u),a.fullscreenElement?a.fullscreenElement.append(d):(a.body.append(d),a.body.style.overflow="hidden");let p,f;if(s.do_type_filter&&(p=d.querySelector(".slot_in_type_filter"),f=d.querySelector(".slot_out_type_filter")),this.ds.scale>1&&(d.style.transform=`scale(${this.ds.scale})`),s.hide_on_mouse_leave){let N=!1,D=null;if(LiteGraph.pointerListenerAdd(d,"enter",function(){D&&(clearTimeout(D),D=null)}),d.addEventListener("pointerleave",function(){if(N)return;const A=s.hide_on_mouse_leave,B=typeof A=="number"?A:500;D=setTimeout(d.close,B)}),s.do_type_filter){if(!p)throw new TypeError("selIn was null when showing search box");if(!f)throw new TypeError("selOut was null when showing search box");p.addEventListener("click",function(){N++}),p.addEventListener("blur",function(){N=0}),p.addEventListener("change",function(){N=-1}),f.addEventListener("click",function(){N++}),f.addEventListener("blur",function(){N=0}),f.addEventListener("change",function(){N=-1})}}(R=n.search_box)==null||R.close(),n.search_box=d;let g=null,m=null,_=null;const y=d.querySelector("input");if(!y)throw new TypeError("Could not create search input box.");const b=y;if(b&&(b.addEventListener("blur",function(){this.focus()}),b.addEventListener("keydown",function(N){if(N.key=="ArrowUp")E(!1);else if(N.key=="ArrowDown")E(!0);else if(N.key=="Escape")d.close();else if(N.key=="Enter")_ instanceof HTMLElement?I(unescape(String(_.dataset.type))):g?I(g):d.close();else{m&&clearInterval(m),m=setTimeout(G,10);return}return N.preventDefault(),N.stopPropagation(),N.stopImmediatePropagation(),!0})),s.do_type_filter){if(p){const N=LiteGraph.slot_types_in,D=N.length;(s.type_filter_in==LiteGraph.EVENT||s.type_filter_in==LiteGraph.ACTION)&&(s.type_filter_in="_event_");for(let A=0;A<D;A++){const B=document.createElement("option");B.value=N[A],B.innerHTML=N[A],p.append(B),s.type_filter_in!==!1&&String(s.type_filter_in).toLowerCase()==String(N[A]).toLowerCase()&&(B.selected=!0)}p.addEventListener("change",function(){G()})}if(f){const N=LiteGraph.slot_types_out;(s.type_filter_out==LiteGraph.EVENT||s.type_filter_out==LiteGraph.ACTION)&&(s.type_filter_out="_event_");for(const D of N){const A=document.createElement("option");A.value=D,A.innerHTML=D,f.append(A),s.type_filter_out!==!1&&String(s.type_filter_out).toLowerCase()==String(D).toLowerCase()&&(A.selected=!0)}f.addEventListener("change",function(){G()})}}const L=r.getBoundingClientRect(),k=(t?t.clientX:L.left+L.width*.5)-80,T=(t?t.clientY:L.top+L.height*.5)-20;d.style.left=`${k}px`,d.style.top=`${T}px`,t.layerY>L.height-200&&(u.style.maxHeight=`${L.height-t.layerY-20}px`),requestAnimationFrame(function(){b.focus()}),s.show_all_on_open&&G();function I(N){if(N)if(n.onSearchBoxSelection)n.onSearchBoxSelection(N,t,o);else{if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const D=LiteGraph.createNode(N);if(D&&(D.pos=o.convertEventToCanvasOffset(t),o.graph.add(D,!1)),s.node_from){let A=!1;switch(typeof s.slot_from){case"string":A=s.node_from.findOutputSlot(s.slot_from);break;case"object":if(s.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");A=s.slot_from.name?s.node_from.findOutputSlot(s.slot_from.name):-1,A==-1&&s.slot_from.slot_index!==void 0&&(A=s.slot_from.slot_index);break;case"number":A=s.slot_from;break;default:A=0}if(s.node_from.outputs[A]!==void 0&&A!==!1&&A>-1){if(D==null)throw new TypeError("options.slot_from was null when showing search box");s.node_from.connectByType(A,D,s.node_from.outputs[A].type)}}if(s.node_to){let A=!1;switch(typeof s.slot_from){case"string":A=s.node_to.findInputSlot(s.slot_from);break;case"object":if(s.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");A=s.slot_from.name?s.node_to.findInputSlot(s.slot_from.name):-1,A==-1&&s.slot_from.slot_index!==void 0&&(A=s.slot_from.slot_index);break;case"number":A=s.slot_from;break;default:A=0}if(s.node_to.inputs[A]!==void 0&&A!==!1&&A>-1){if(D==null)throw new TypeError("options.slot_from was null when showing search box");s.node_to.connectByTypeOutput(A,D,s.node_to.inputs[A].type)}}o.graph.afterChange()}d.close()}function E(N){const D=_;_?_ instanceof Element&&(_.classList.remove("selected"),_=N?_.nextSibling:_.previousSibling,_||(_=D)):_=N?u.childNodes[0]:u.childNodes[u.childNodes.length],_ instanceof Element&&(_.classList.add("selected"),_.scrollIntoView({block:"end",behavior:"smooth"}))}function G(){m=null;let N=b.value;if(g=null,u.innerHTML="",!N&&!s.show_all_if_empty)return;if(n.onSearchBox){const A=n.onSearchBox(u,N,o);if(A)for(const B of A)D(B)}else{let A=function(X,Z){var ee,ie;Z=Z||{};const yt=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},Z),Tt=LiteGraph.registered_node_types[X];if($&&Tt.filter!=$||(!s.show_all_if_empty||N)&&!X.toLowerCase().includes(N)&&(!Tt.title||!Tt.title.toLowerCase().includes(N)))return!1;if(s.do_type_filter&&!yt.skipFilter){const se=X;let pt=yt.inTypeOverride!==!1?yt.inTypeOverride:W.value;if(W&&pt&&((ee=LiteGraph.registered_slot_in_types[pt])!=null&&ee.nodes)&&LiteGraph.registered_slot_in_types[pt].nodes.includes(se)===!1||(pt=j.value,yt.outTypeOverride!==!1&&(pt=yt.outTypeOverride),j&&pt&&((ie=LiteGraph.registered_slot_out_types[pt])!=null&&ie.nodes)&&LiteGraph.registered_slot_out_types[pt].nodes.includes(se)===!1))return!1}return!0},B=0;if(N=N.toLowerCase(),!o.graph)throw new NullGraphError;const $=o.filter||o.graph.filter;let W=!1,j=!1;s.do_type_filter&&n.search_box&&(W=n.search_box.querySelector(".slot_in_type_filter"),j=n.search_box.querySelector(".slot_out_type_filter"));const it=Object.keys(LiteGraph.registered_node_types).filter(X=>A(X));for(const X of it)if(D(X),O.search_limit!==-1&&B++>O.search_limit)break;if(s.show_general_after_typefiltered&&(W.value||j.value)){filtered_extra=[];for(const X in LiteGraph.registered_node_types)A(X,{inTypeOverride:W&&W.value?"*":!1,outTypeOverride:j&&j.value?"*":!1})&&filtered_extra.push(X);for(const X of filtered_extra)if(D(X,"generic_type"),O.search_limit!==-1&&B++>O.search_limit)break}if((W.value||j.value)&&u.childNodes.length==0&&s.show_general_if_none_on_typefilter){filtered_extra=[];for(const X in LiteGraph.registered_node_types)A(X,{skipFilter:!0})&&filtered_extra.push(X);for(const X of filtered_extra)if(D(X,"not_in_filter"),O.search_limit!==-1&&B++>O.search_limit)break}}function D(A,B){const $=document.createElement("div");g||(g=A);const W=LiteGraph.registered_node_types[A];if(W!=null&&W.title){$.textContent=W==null?void 0:W.title;const j=document.createElement("span");j.className="litegraph lite-search-item-type",j.textContent=A,$.append(j)}else $.textContent=A;$.dataset.type=escape(A),$.className="litegraph lite-search-item",B&&($.className+=` ${B}`),$.addEventListener("click",function(){I(unescape(String(this.dataset.type)))}),u.append($)}}return d}showEditPropertyValue(t,i,s){if(!t||t.properties[i]===void 0)return;s=s||{};const n=t.getPropertyInfo(i),{type:o}=n;let r="";if(o=="string"||o=="number"||o=="array"||o=="object")r="<input autofocus type='text' class='value'/>";else if((o=="enum"||o=="combo")&&n.values){r="<select autofocus type='text' class='value'>";for(const g in n.values){const m=Array.isArray(n.values)?n.values[g]:g,_=m==t.properties[i]?"selected":"";r+=`<option value='${m}' ${_}>${n.values[g]}</option>`}r+="</select>"}else if(o=="boolean"||o=="toggle")r=`<input autofocus type='checkbox' class='value' ${t.properties[i]?"checked":""}/>`;else{console.warn(`unknown type: ${o}`);return}const a=this.createDialog(`<span class='name'>${n.label||i}</span>${r}<button>OK</button>`,s);let l;if((o=="enum"||o=="combo")&&n.values)l=a.querySelector("select"),l==null||l.addEventListener("change",function(g){var m;a.modified(),f((m=g.target)==null?void 0:m.value)});else if(o=="boolean"||o=="toggle")l=a.querySelector("input"),l==null||l.addEventListener("click",function(){a.modified(),f(!!l.checked)});else if(l=a.querySelector("input"),l){l.addEventListener("blur",function(){this.focus()});let g=t.properties[i]!==void 0?t.properties[i]:"";o!=="string"&&(g=JSON.stringify(g)),l.value=g,l.addEventListener("keydown",function(m){if(m.key=="Escape")a.close();else if(m.key=="Enter")u();else{a.modified();return}m.preventDefault(),m.stopPropagation()})}l==null||l.focus();const d=a.querySelector("button");if(!d)throw new TypeError("Show edit property value button was null.");d.addEventListener("click",u);function u(){f(l==null?void 0:l.value)}const p=()=>C(this,F,bt).call(this);function f(g){var m,_;n!=null&&n.values&&typeof n.values=="object"&&n.values[g]!=null&&(g=n.values[g]),typeof t.properties[i]=="number"&&(g=Number(g)),(o=="array"||o=="object")&&(g=JSON.parse(g)),t.properties[i]=g,t.graph&&t.graph._version++,(m=t.onPropertyChanged)==null||m.call(t,i,g),(_=s.onclose)==null||_.call(s),a.close(),p()}return a}createDialog(t,i){i=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},i||{});const n={className:"graphdialog",innerHTML:t,is_modified:!1,modified(){this.is_modified=!0},close(){this.remove()}},o=document.createElement("div"),r=Object.assign(o,n),a=this.canvas.getBoundingClientRect();let l=-20,d=-20;if(a&&(l-=a.left,d-=a.top),i.position?(l+=i.position[0],d+=i.position[1]):i.event?(l+=i.event.clientX,d+=i.event.clientY):(l+=this.canvas.width*.5,d+=this.canvas.height*.5),r.style.left=`${l}px`,r.style.top=`${d}px`,!this.canvas.parentNode)throw new TypeError("Canvas parent element was null.");if(this.canvas.parentNode.append(r),i.checkForInput){const g=r.querySelectorAll("input");if(g)for(const m of g)m.addEventListener("keydown",function(_){if(r.modified(),_.key=="Escape")r.close();else if(_.key!="Enter")return;_.preventDefault(),_.stopPropagation()}),m.focus()}let u,p=0;r.addEventListener("mouseleave",function(){p||!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(u=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(){(i.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&u&&clearTimeout(u)});const f=r.querySelectorAll("select");if(f)for(const g of f)g.addEventListener("click",function(){p++}),g.addEventListener("blur",function(){p=0}),g.addEventListener("change",function(){p=-1});return r}createPanel(t,i){i=i||{};const s=i.window||window,n=document.createElement("div");if(n.className="litegraph dialog",n.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",n.header=n.querySelector(".dialog-header"),i.width&&(n.style.width=i.width+(typeof i.width=="number"?"px":"")),i.height&&(n.style.height=i.height+(typeof i.height=="number"?"px":"")),i.closable){const o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",function(){n.close()}),n.header.append(o)}return n.title_element=n.querySelector(".dialog-title"),n.title_element.textContent=t,n.content=n.querySelector(".dialog-content"),n.alt_content=n.querySelector(".dialog-alt-content"),n.footer=n.querySelector(".dialog-footer"),n.close=function(){typeof n.onClose=="function"&&n.onClose(),n.remove(),this.remove()},n.toggleAltContent=function(o){let r,a;o!==void 0?(r=o?"block":"none",a=o?"none":"block"):(r=n.alt_content.style.display!="block"?"block":"none",a=n.alt_content.style.display!="block"?"none":"block"),n.alt_content.style.display=r,n.content.style.display=a},n.toggleFooterVisibility=function(o){let r;o!==void 0?r=o?"block":"none":r=n.footer.style.display!="block"?"block":"none",n.footer.style.display=r},n.clear=function(){this.content.innerHTML=""},n.addHTML=function(o,r,a){const l=document.createElement("div");return r&&(l.className=r),l.innerHTML=o,a?n.footer.append(l):n.content.append(l),l},n.addButton=function(o,r,a){const l=document.createElement("button");return l.textContent=o,l.options=a,l.classList.add("btn"),l.addEventListener("click",r),n.footer.append(l),l},n.addSeparator=function(){const o=document.createElement("div");o.className="separator",n.content.append(o)},n.addWidget=function(o,r,a,l,d){l=l||{};let u=String(a);o=o.toLowerCase(),o=="number"&&typeof a=="number"&&(u=a.toFixed(3));const p=document.createElement("div");p.className="property",p.innerHTML="<span class='property_name'></span><span class='property_value'></span>";const f=p.querySelector(".property_name");if(!f)throw new TypeError("Property name element was null.");f.textContent=l.label||r;const g=p.querySelector(".property_value");if(!g)throw new TypeError("Property name element was null.");if(g.textContent=u,p.dataset.property=r,p.dataset.type=l.type||o,p.options=l,p.value=a,o=="code")p.addEventListener("click",function(){n.inner_showCodePad(this.dataset.property)});else if(o=="boolean")p.classList.add("boolean"),a&&p.classList.add("bool-on"),p.addEventListener("click",()=>{const _=p.dataset.property;if(p.value=!p.value,p.classList.toggle("bool-on"),!g)throw new TypeError("Property name element was null.");g.textContent=p.value?"true":"false",m(_,p.value)});else if(o=="string"||o=="number"){if(!g)throw new TypeError("Property name element was null.");g.setAttribute("contenteditable","true"),g.addEventListener("keydown",function(_){_.code=="Enter"&&(o!="string"||!_.shiftKey)&&(_.preventDefault(),this.blur())}),g.addEventListener("blur",function(){var L,k;let _=this.textContent;const y=(L=this.parentElement)==null?void 0:L.dataset.property;((k=this.parentElement)==null?void 0:k.dataset.type)=="number"&&(_=Number(_)),m(y,_)})}else if(o=="enum"||o=="combo"){const _=O.getPropertyPrintableValue(a,l.values);if(!g)throw new TypeError("Property name element was null.");g.textContent=_??"",g.addEventListener("click",function(y){var T;const b=l.values||[],L=(T=this.parentElement)==null?void 0:T.dataset.property,k=I=>(this.textContent=I,m(L,I),!1);new LiteGraph.ContextMenu(b,{event:y,className:"dark",callback:k},s)})}n.content.append(p);function m(_,y){var b;(b=l.callback)==null||b.call(l,_,y,l),d==null||d(_,y,l)}return p},typeof n.onOpen=="function"&&n.onOpen(),n}closePanels(){var t,i,s,n;(i=(t=document.querySelector("#node-panel"))==null?void 0:t.close)==null||i.call(t),(n=(s=document.querySelector("#option-panel"))==null?void 0:s.close)==null||n.call(s)}showShowNodePanel(t){this.SELECTED_NODE=t,this.closePanels();const i=this.getCanvasWindow(),s=this.createPanel(t.title||"",{closable:!0,window:i,onOpen:()=>{this.NODEPANEL_IS_OPEN=!0},onClose:()=>{this.NODEPANEL_IS_OPEN=!1,this.node_panel=null}});this.node_panel=s,s.id="node-panel",s.node=t,s.classList.add("settings");const n=()=>{var l,d;s.content.innerHTML="",s.addHTML(`<span class='node_type'>${t.type}</span><span class='node_desc'>${t.constructor.desc||""}</span><span class='separator'></span>`),s.addHTML("<h3>Properties</h3>");const o=(u,p)=>{if(!this.graph)throw new NullGraphError;switch(this.graph.beforeChange(t),u){case"Title":if(typeof p!="string")throw new TypeError("Attempting to set title to non-string value.");t.title=p;break;case"Mode":{if(typeof p!="string")throw new TypeError("Attempting to set mode to non-string value.");const f=Object.values(LiteGraph.NODE_MODES).indexOf(p);f!==-1&&LiteGraph.NODE_MODES[f]?t.changeMode(f):console.warn(`unexpected mode: ${p}`);break}case"Color":if(typeof p!="string")throw new TypeError("Attempting to set colour to non-string value.");O.node_colors[p]?(t.color=O.node_colors[p].color,t.bgcolor=O.node_colors[p].bgcolor):console.warn(`unexpected color: ${p}`);break;default:t.setProperty(u,p);break}this.graph.afterChange(),this.dirty_canvas=!0};s.addWidget("string","Title",t.title,{},o);const r=t.mode==null?void 0:LiteGraph.NODE_MODES[t.mode];s.addWidget("combo","Mode",r,{values:LiteGraph.NODE_MODES},o);const a=t.color!==void 0?Object.keys(O.node_colors).filter(function(u){return O.node_colors[u].color==t.color}):"";s.addWidget("combo","Color",a,{values:Object.keys(O.node_colors)},o);for(const u in t.properties){const p=t.properties[u],f=t.getPropertyInfo(u);(l=t.onAddPropertyToPanel)!=null&&l.call(t,u,s)||s.addWidget(f.widget||f.type,u,p,f,o)}s.addSeparator(),(d=t.onShowCustomPanelInfo)==null||d.call(t,s),s.footer.innerHTML="",s.addButton("Delete",function(){if(!t.block_delete){if(!t.graph)throw new NullGraphError;t.graph.remove(t),s.close()}}).classList.add("delete")};if(s.inner_showCodePad=function(o){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";const r=s.alt_content.querySelector("textarea"),a=function(){s.toggleAltContent(!1),s.toggleFooterVisibility(!0),r.remove(),s.classList.add("settings"),s.classList.remove("centered"),n()};r.value=String(t.properties[o]),r.addEventListener("keydown",function(u){u.code=="Enter"&&u.ctrlKey&&(t.setProperty(o,r.value),a())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),r.style.height="calc(100% - 40px)";const l=s.addButton("Assign",function(){t.setProperty(o,r.value),a()});s.alt_content.append(l);const d=s.addButton("Close",a);d.style.float="right",s.alt_content.append(d)},n(),!this.canvas.parentNode)throw new TypeError("showNodePanel - this.canvas.parentNode was null");this.canvas.parentNode.append(s)}checkPanels(){if(!this.canvas)return;if(!this.canvas.parentNode)throw new TypeError("checkPanels - this.canvas.parentNode was null");const t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(const i of t)i.node&&(!i.node.graph||i.graph!=this.graph)&&i.close()}getCanvasMenuOptions(){var s;let t;this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:O.onMenuAdd},{content:"Add Group",callback:O.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&t.push({content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Align",has_submenu:!0,callback:O.onGroupAlign}));const i=(s=this.getExtraMenuOptions)==null?void 0:s.call(this,this,t);return Array.isArray(i)?t.concat(i):t}getNodeMenuOptions(t){var n,o,r,a;let i;t.getMenuOptions?i=t.getMenuOptions(this):(i=[{content:"Inputs",has_submenu:!0,disabled:!0},{content:"Outputs",has_submenu:!0,disabled:!0,callback:O.showMenuNodeOptionalOutputs},null,{content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Properties",has_submenu:!0,callback:O.onShowMenuNodeProperties},{content:"Properties Panel",callback:function(l,d,u,p,f){O.active_canvas.showShowNodePanel(f)}},null,{content:"Title",callback:O.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:O.onMenuNodeMode}],t.resizable!==!1&&i.push({content:"Resize",callback:O.onMenuResizeNode}),t.collapsible&&i.push({content:t.collapsed?"Expand":"Collapse",callback:O.onMenuNodeCollapse}),(n=t.widgets)!=null&&n.some(l=>l.advanced)&&i.push({content:t.showAdvanced?"Hide Advanced":"Show Advanced",callback:O.onMenuToggleAdvanced}),i.push({content:t.pinned?"Unpin":"Pin",callback:()=>{for(const l in this.selected_nodes)this.selected_nodes[l].pin();this.setDirty(!0,!0)}},{content:"Colors",has_submenu:!0,callback:O.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:O.onMenuNodeShapes},null));const s=(o=t.getExtraMenuOptions)==null?void 0:o.call(t,this,i);return Array.isArray(s)&&s.length>0&&(s.push(null),i=s.concat(i)),t.clonable!==!1&&i.push({content:"Clone",callback:O.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&i.push({content:"Align Selected To",has_submenu:!0,callback:O.onNodeAlign},{content:"Distribute Nodes",has_submenu:!0,callback:O.createDistributeMenu}),i.push(null,{content:"Remove",disabled:!(t.removable!==!1&&!t.block_delete),callback:O.onMenuNodeRemove}),(a=(r=t.graph)==null?void 0:r.onGetNodeMenuOptions)==null||a.call(r,i,t),i}getGroupMenuOptions(t){return console.warn("LGraphCanvas.getGroupMenuOptions is deprecated, use LGraphGroup.getMenuOptions instead"),t.getMenuOptions()}processContextMenu(t,i){var u,p,f;const n=O.active_canvas.getCanvasWindow();let o;const r={event:i,callback:d,extra:t};if(t){r.title=t.displayType??t.type??void 0,O.active_node=t;const g=t.getSlotInPosition(i.canvasX,i.canvasY);if(g){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(g);else{((p=(u=g.output)==null?void 0:u.links)!=null&&p.length||((f=g.input)==null?void 0:f.link)!=null)&&o.push({content:"Disconnect Links",slot:g});const m=g.input||g.output;if(!m)throw new TypeError("Both in put and output slots were null when processing context menu.");m.removable&&o.push(m.locked?"Cannot remove":{content:"Remove Slot",slot:g}),!m.nameLocked&&!("link"in m&&m.widget)&&o.push({content:"Rename Slot",slot:g}),t.getExtraSlotMenuOptions&&o.push(...t.getExtraSlotMenuOptions(g))}r.title=(g.input?g.input.type:g.output.type)||"*",g.input&&g.input.type==LiteGraph.ACTION&&(r.title="Action"),g.output&&g.output.type==LiteGraph.EVENT&&(r.title="Event")}else o=this.getNodeMenuOptions(t)}else{if(o=this.getCanvasMenuOptions(),!this.graph)throw new NullGraphError;if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const m=this.graph.getRerouteOnPos(i.canvasX,i.canvasY,S(this,mt));m&&o.unshift({content:"Delete Reroute",callback:()=>{if(!this.graph)throw new NullGraphError;this.graph.removeReroute(m.id)}},null)}const g=this.graph.getGroupOnPos(i.canvasX,i.canvasY);g&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:g,options:g.getMenuOptions()}})}if(!o)return;new LiteGraph.ContextMenu(o,r,n);const a=g=>this.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",g),l=()=>this.setDirty(!0);function d(g,m){var _;if(g){if(g.content=="Remove Slot"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.input?t.removeInput(y.slot):y.output&&t.removeOutput(y.slot),t.graph.afterChange();return}else if(g.content=="Disconnect Links"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.output?t.disconnectOutput(y.slot):y.input&&t.disconnectInput(y.slot,!0),t.graph.afterChange();return}else if(g.content=="Rename Slot"){if(!t)throw new TypeError("`node` was null when processing the context menu.");const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");const b=y.input?t.getInputInfo(y.slot):t.getOutputInfo(y.slot),L=a(m),k=L.querySelector("input");k&&b&&(k.value=b.label||"");const T=function(){if(!t.graph)throw new NullGraphError;t.graph.beforeChange(),k!=null&&k.value&&(b&&(b.label=k.value),l()),L.close(),t.graph.afterChange()};if((_=L.querySelector("button"))==null||_.addEventListener("click",T),!k)throw new TypeError("Input element was null when processing context menu.");k.addEventListener("keydown",function(I){if(L.is_modified=!0,I.key=="Escape")L.close();else if(I.key=="Enter")T();else if(I.target.localName!="textarea")return;I.preventDefault(),I.stopPropagation()}),k.focus()}}}}animateToBounds(t,i={}){const s=()=>this.setDirty(!0,!0);this.ds.animateToBounds(t,s,i)}fitViewToSelectionAnimated(t={}){const i=this.selectedItems.size?Array.from(this.selectedItems):this.positionableItems,s=createBounds(i);if(!s)throw new TypeError("Attempted to fit to view but could not calculate bounds.");const n=()=>this.setDirty(!0,!0);this.ds.animateToBounds(s,n,t)}};Ge=new WeakMap,Ae=new WeakMap,Fe=new WeakMap,Ct=new WeakMap,Lt=new WeakMap,xe=new WeakMap,Pe=new WeakMap,We=new WeakMap,xt=new WeakMap,F=new WeakSet,Xe=function(){if(!this.state.shouldSetCursor)return;const t=CanvasItem.Node|CanvasItem.RerouteSlot|CanvasItem.SubgraphIoNode|CanvasItem.SubgraphIoSlot;let i="default";this.state.draggingCanvas?i="grabbing":this.state.readOnly?i="grab":this.pointer.resizeDirection?i=cursors[this.pointer.resizeDirection]??cursors.SE:this.state.hoveringOver&t?i="crosshair":this.state.hoveringOver&CanvasItem.Reroute&&(i="grab"),this.canvas.style.cursor=i},Ot=new WeakMap,ve=new WeakMap,mt=new WeakMap,ht=new WeakMap,be=new WeakMap,Pt=new WeakMap,Si=function(t){if(typeof t=="string"){const i=document.getElementById(t);if(!(i instanceof HTMLCanvasElement))throw"Error validating LiteGraph canvas: Canvas element not found";return i}return t},bt=function(){this.dirty_canvas=!0,this.dirty_bgcanvas=!0},Bt=function(){const{graph:t,linkConnector:i,pointer:s}=this;if(!t)throw new NullGraphError;s.onDragEnd=n=>i.dropLinks(t,n),s.finally=()=>this.linkConnector.reset(!0)},Ti=function(t,i){var n,o;const s=(n=this.subgraph)==null?void 0:n.getIoNodeOnPos(t,i);if(s)return s;for(const r of S(this,mt))if(r.containsPoint([t,i]))return r;return(o=this.graph)==null?void 0:o.getGroupTitlebarOnPos(t,i)},Ei=function(t,i){var u;const{pointer:s,graph:n,linkConnector:o,subgraph:r}=this;if(!n)throw new NullGraphError;const a=t.canvasX,l=t.canvasY,d=t.ctrlKey||t.metaKey;if(d&&!t.altKey&&LiteGraph.canvasNavigationMode==="legacy"){C(this,F,ri).call(this,t,s,i);return}if(this.read_only){s.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0;return}if(LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&!t.ctrlKey&&i&&this.allow_interaction){let p=i.type;if(i instanceof SubgraphNode){const g=i.subgraph.clone().asSerialisable(),m=n.createSubgraph(g);m.configure(g),p=m.id}const f=(u=i.clone())==null?void 0:u.serialize();if((f==null?void 0:f.type)!=null){const g=LiteGraph.createNode(p);if(g){g.configure(f),g.pos[0]+=5,g.pos[1]+=5,this.allow_dragnodes?(s.onDragStart=m=>{n.add(g,!1),C(this,F,zt).call(this,g,m)},s.onDragEnd=m=>C(this,F,Vt).call(this,m)):(n.beforeChange(),n.add(g,!1),n.afterChange());return}}}if(i&&(this.allow_interaction||i.flags.allow_interaction))C(this,F,Ni).call(this,t,d,i);else{if(r){let m=function(b,L){return L.containsPoint([a,l])?(L.onPointerDown(t,s,o),s.onClick??(s.onClick=()=>b.processSelect(L,t)),s.onDragStart??(s.onDragStart=()=>{var k;return C(k=b,F,zt).call(k,L,s,!0)}),s.onDragEnd??(s.onDragEnd=k=>{var T;return C(T=b,F,Vt).call(T,k)}),!0):!1};const{inputNode:_,outputNode:y}=r;if(m(this,_)||m(this,y))return}if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK)for(const m of S(this,mt)){const _=m.containsPoint([a,l]);if(!(!m.isSlotHovered&&!_)){_&&(s.onClick=()=>this.processSelect(m,t),t.shiftKey||(s.onDragStart=y=>C(this,F,zt).call(this,m,y,!0),s.onDragEnd=y=>C(this,F,Vt).call(this,y))),(m.isOutputHovered||_&&t.shiftKey)&&(o.dragFromReroute(n,m),C(this,F,Bt).call(this)),m.isInputHovered&&(o.dragFromRerouteToOutput(n,m),C(this,F,Bt).call(this)),m.hideSlots(),this.dirty_bgcanvas=!0;return}}const{lineWidth:p}=this.ctx;this.ctx.lineWidth=this.connections_width+7;const f=(window==null?void 0:window.devicePixelRatio)||1;for(const m of this.renderedPaths){const _=m._pos;if(_){if((t.shiftKey||t.altKey)&&m.path&&this.ctx.isPointInStroke(m.path,a*f,l*f)){if(this.ctx.lineWidth=p,t.shiftKey&&!t.altKey){o.dragFromLinkSegment(n,m),C(this,F,Bt).call(this);return}else if(t.altKey&&!t.shiftKey){const y=n.createReroute([a,l],m);s.onDragStart=b=>C(this,F,zt).call(this,y,b),s.onDragEnd=b=>C(this,F,Vt).call(this,b);return}}else if(isInRectangle(a,l,_[0]-4,_[1]-4,8,8)){this.ctx.lineWidth=p,s.onClick=()=>this.showLinkMenu(m,t),s.onDragStart=()=>this.dragging_canvas=!0,s.finally=()=>this.dragging_canvas=!1,this.over_link_center=void 0;return}}}this.ctx.lineWidth=p;const g=n.getGroupOnPos(a,l);if(this.selected_group=g??null,g){if(g.isInResize(a,l)){const m=g.boundingRect,_=a-(m[0]+m[2]),y=l-(m[1]+m[3]);s.onDragStart=()=>this.resizingGroup=g,s.onDrag=b=>{if(this.read_only)return;const L=[b.canvasX-g.pos[0]-_,b.canvasY-g.pos[1]-y];S(this,ht)&&snapPoint(L,S(this,ht)),g.resize(L[0],L[1])&&(this.dirty_bgcanvas=!0)},s.finally=()=>this.resizingGroup=null}else{const _=(g.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE)*1.4;isInRectangle(a,l,g.pos[0],g.pos[1],g.size[0],_)&&(s.onClick=()=>this.processSelect(g,t),s.onDragStart=y=>{g.recomputeInsideNodes(),C(this,F,zt).call(this,g,y,!0)},s.onDragEnd=y=>C(this,F,Vt).call(this,y))}s.onDoubleClick=()=>{this.emitEvent({subType:"group-double-click",originalEvent:t,group:g})}}else s.onDoubleClick=()=>{this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault()),this.emitEvent({subType:"empty-double-click",originalEvent:t})}}!s.onDragStart&&!s.onClick&&!s.onDrag&&this.allow_dragcanvas&&(LiteGraph.canvasNavigationMode!=="standard"||this.read_only?(s.onClick=()=>this.processSelect(null,t),s.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0):C(this,F,ri).call(this,t,s))},ri=function(t,i,s){const n=new Float32Array(4);n[0]=t.canvasX,n[1]=t.canvasY,n[2]=1,n[3]=1,i.onClick=o=>{const r=s??C(this,F,Ti).call(this,o.canvasX,o.canvasY);this.processSelect(r,o)},i.onDragStart=()=>this.dragging_rectangle=n,i.onDragEnd=o=>C(this,F,Ai).call(this,o,n),i.finally=()=>this.dragging_rectangle=null},Ni=function(t,i,s){var f,g,m,_;const{pointer:n,graph:o,linkConnector:r}=this;if(!o)throw new NullGraphError;const a=t.canvasX,l=t.canvasY;n.onClick=()=>this.processSelect(s,t),s.flags.pinned||this.bringToFront(s);const d=s.isPointInCollapse(a,l);if(d)n.onClick=()=>{s.collapse(),this.setDirty(!0,!0)};else if(!s.flags.collapsed){const{inputs:y,outputs:b}=s;if(b)for(const[L,k]of b.entries()){const T=s.getOutputPos(L);if(isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){if(t.shiftKey&&((f=k.links)!=null&&f.length||(g=k._floatingLinks)!=null&&g.size)){r.moveOutputLink(o,k),C(this,F,Bt).call(this);return}r.dragNewFromOutput(o,s,k),C(this,F,Bt).call(this),LiteGraph.shift_click_do_break_link_from?t.shiftKey&&s.disconnectOutput(L):LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey&&s.disconnectOutput(L),n.onDoubleClick=()=>{var I;return(I=s.onOutputDblClick)==null?void 0:I.call(s,L,t)},n.onClick=()=>{var I;return(I=s.onOutputClick)==null?void 0:I.call(s,L,t)};return}}if(y)for(const[L,k]of y.entries()){const T=s.getInputPos(L);if(k instanceof NodeInputSlot?isInRect(a,l,k.boundingRect):isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){n.onDoubleClick=()=>{var G;return(G=s.onInputDblClick)==null?void 0:G.call(s,L,t)},n.onClick=()=>{var G;return(G=s.onInputClick)==null?void 0:G.call(s,L,t)};const E=LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey;(k.link!==null||(m=k._floatingLinks)!=null&&m.size)&&(E||LiteGraph.click_do_break_link_to?s.disconnectInput(L,!0):(t.shiftKey||this.allow_reconnect_links)&&r.moveInputLink(o,k)),r.isConnecting||r.dragNewFromInput(o,s,k),C(this,F,Bt).call(this),this.dirty_bgcanvas=!0;return}}}const u=[a-s.pos[0],l-s.pos[1]],p=s.getWidgetOnPos(a,l);if(p)C(this,F,Ci).call(this,t,s,p),this.node_widget=[s,p];else{if(n.onDoubleClick=()=>{var y,b;u[1]<0&&!d?(y=s.onNodeTitleDblClick)==null||y.call(s,t,u,this):s instanceof SubgraphNode&&this.openSubgraph(s.subgraph),(b=s.onDblClick)==null||b.call(s,t,u,this),this.emitEvent({subType:"node-double-click",originalEvent:t,node:s}),this.processNodeDblClicked(s)},(_=s.onMouseDown)!=null&&_.call(s,t,u,this)){n.onClick=()=>{};return}if(!this.allow_dragnodes)return;if(!s.flags.collapsed){const y=s.findResizeDirection(a,l);if(y){n.resizeDirection=y;const b=new Rectangle(s.pos[0],s.pos[1],s.size[0],s.size[1]);n.onDragStart=()=>{o.beforeChange(),this.resizing_node=s},n.onDrag=L=>{if(this.read_only)return;const k=L.canvasX-a,T=L.canvasY-l,I=new Rectangle(b.x,b.y,b.width,b.height);switch(y){case"NE":I.y=b.y+T,I.width=b.width+k,I.height=b.height-T;break;case"SE":I.width=b.width+k,I.height=b.height+T;break;case"SW":I.x=b.x+k,I.width=b.width-k,I.height=b.height+T;break;case"NW":I.x=b.x+k,I.y=b.y+T,I.width=b.width-k,I.height=b.height-T;break}if(S(this,ht)){if(y.includes("N")||y.includes("W")){const G=I.x,R=I.y;snapPoint(I.pos,S(this,ht)),y.includes("N")&&(I.height+=R-I.y),y.includes("W")&&(I.width+=G-I.x)}snapPoint(I.size,S(this,ht))}const E=s.computeSize();I.width<E[0]&&(y.includes("W")&&(I.x=b.x+b.width-E[0]),I.width=E[0]),I.height<E[1]&&(y.includes("N")&&(I.y=b.y+b.height-E[1]),I.height=E[1]),s.pos=I.pos,s.setSize(I.size),C(this,F,bt).call(this)},n.onDragEnd=()=>{C(this,F,bt).call(this),o.afterChange(s)},n.finally=()=>{this.resizing_node=null,n.resizeDirection=void 0},this.canvas.style.cursor=cursors[y];return}}n.onDragStart=y=>C(this,F,zt).call(this,s,y,!0),n.onDragEnd=y=>C(this,F,Vt).call(this,y)}this.dirty_canvas=!0},Ci=function(t,i,s){var u;const{pointer:n}=this;if(typeof s.onPointerDown=="function"&&s.onPointerDown(n,i,this))return;const o=s.value,r=this.graph_mouse,a=r[0]-i.pos[0],l=r[1]-i.pos[1],d=toConcreteWidget(s,i,!1);if(d)n.onClick=()=>d.onClick({e:t,node:i,canvas:this}),n.onDrag=p=>{var f;return(f=d.onDrag)==null?void 0:f.call(d,{e:p,node:i,canvas:this})};else if(s.mouse){const p=s.mouse(t,[a,l],i);p!=null&&(this.dirty_canvas=p)}if(o!=s.value){if((u=i.onWidgetChanged)==null||u.call(i,s.name,s.value,o,s),!i.graph)throw new NullGraphError;i.graph._version++}n.finally=()=>{if(s.mouse){const{eUp:p}=n;if(!p)return;const{canvasX:f,canvasY:g}=p;s.mouse(p,[f-i.pos[0],g-i.pos[1]],i)}this.node_widget=null}},Oi=function(t,i){const{pointer:s}=this;if(LiteGraph.middle_click_slot_add_default_node&&i&&this.allow_interaction&&!this.read_only&&!this.connecting_links&&!i.flags.collapsed){let n=!1,o=!1,r=!1;const{inputs:a,outputs:l}=i;if(l)for(const[d,u]of l.entries()){const p=i.getOutputPos(d);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){n=u,o=d,r=!0;break}}if(a)for(const[d,u]of a.entries()){const p=i.getInputPos(d);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){n=u,o=d,r=!1;break}}if(n&&o!==!1){const d=.5-(o+1)/(r?l.length:a.length),u=i.getBounding(),p=[r?u[0]+u[2]:u[0],t.canvasY-80];s.onClick=()=>this.createDefaultNodeForSlot({nodeFrom:r?i:null,slotFrom:r?o:null,nodeTo:r?null:i,slotTo:r?null:o,position:p,nodeType:"AUTO",posAdd:[r?30:-30,-d*130],posSizeFix:[r?0:-1,0]})}}this.allow_dragcanvas&&(s.onDragStart=()=>this.dragging_canvas=!0,s.finally=()=>this.dragging_canvas=!1)},Di=function(t){if(!t.buttons){z(this,Pt,null);return}const i=S(this,Pt);if(!i)throw new TypeError("Drag-zoom state object was null");if(!this.graph)throw new NullGraphError;const s=t.y-i.pos[1],o=i.scale-s/100;this.ds.changeScale(o,i.pos),this.graph.change()},Ri=function(t){const{graph:i,pointer:s,linkConnector:n}=this;if(!i)throw new NullGraphError;if(s.isDown){if(n.isConnecting){for(const o of S(this,mt))if(o.containsPoint(this.graph_mouse))return n.isRerouteValidDrop(o)&&(n.overReroute=o,this._highlight_pos=o.pos),t|=CanvasItem.RerouteSlot}}else{let o=!1;for(const r of S(this,mt))o||(o=r.updateVisibility(this.graph_mouse)),r.isSlotHovered&&(t|=CanvasItem.RerouteSlot);o&&(this.dirty_bgcanvas=!0)}return this._highlight_pos&&(this._highlight_pos=void 0),n.overReroute&&(n.overReroute=void 0),t},zt=function(t,i,s=!1){var n;this.emitBeforeChange(),(n=this.graph)==null||n.beforeChange(),i.finally=()=>{var o;this.isDragging=!1,(o=this.graph)==null||o.afterChange(),this.emitAfterChange()},this.processSelect(t,i.eDown,s),this.isDragging=!0},Vt=function(t){var s;const{graph:i}=this;(t.shiftKey||LiteGraph.alwaysSnapToGrid)&&(i==null||i.snapToGrid(this.selectedItems)),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,(s=this.onNodeMoved)==null||s.call(this,findFirstNode(this.selectedItems))},Gi=function(){const t=new CustomEvent("litegraph:no-items-selected",{bubbles:!0});this.canvas.dispatchEvent(t)},Ai=function(t,i){var p;const{graph:s,selectedItems:n,subgraph:o}=this;if(!s)throw new NullGraphError;const r=Math.abs(i[2]),a=Math.abs(i[3]);i[2]<0&&(i[0]-=r),i[3]<0&&(i[1]-=a),i[2]=r,i[3]=a;const l=new Set,d=[];if(o){const{inputNode:f,outputNode:g}=o;overlapBounding(i,f.boundingRect)&&u(f),overlapBounding(i,g.boundingRect)&&u(g)}for(const f of s._nodes)overlapBounding(i,f.boundingRect)&&u(f);for(const f of s.groups)containsRect(i,f._bounding)&&(f.recomputeInsideNodes(),u(f));for(const f of s.reroutes.values())isPointInRect(f.pos,i)&&(n.add(f),f.selected=!0,u(f));if(t.shiftKey)for(const f of d)this.select(f);else if(t.altKey)for(const f of l)this.deselect(f);else{for(const f of n.values())l.has(f)||this.deselect(f);for(const f of d)this.select(f)}(p=this.onSelectionChange)==null||p.call(this,this.selected_nodes);function u(f){!f.selected||!n.has(f)?d.push(f):l.add(f)}},Fi=function(t){for(const i of this.renderedPaths){const s=i._pos;if(s&&isInRectangle(t.canvasX,t.canvasY,s[0]-4,s[1]-4,8,8))return i}},xi=function(){return LiteGraph.snaps_for_comfy?this.linkConnector.state.snapLinksPos??this._highlight_pos??this.graph_mouse:this.graph_mouse},Pi=function(t,i){var N;const s=!!this.linkConnector.state.snapLinksPos;if(!this._highlight_pos&&!s)return;t.fillStyle="#ffcc00",t.beginPath(),((N=this._highlight_input)==null?void 0:N.shape)===RenderShape.ARROW?(t.moveTo(i[0]+8,i[1]+.5),t.lineTo(i[0]-4,i[1]+6+.5),t.lineTo(i[0]-4,i[1]-6+.5),t.closePath()):t.arc(i[0],i[1],6,0,Math.PI*2),t.fill();const{linkConnector:o}=this,{overReroute:r,overWidget:a}=o;if(!LiteGraph.snap_highlights_node||!o.isConnecting||s)return;r==null||r.drawHighlight(t,"#ffcc00aa");const l=this.node_over;if(!l)return;const{strokeStyle:d,lineWidth:u}=t,p=l.boundingRect,f=3,g=LiteGraph.ROUND_RADIUS+f,m=p[0]-f,_=p[1]-f,y=p[2]+f*2,b=p[3]+f*2;t.beginPath(),t.roundRect(m,_,y,b,g);const L=o.state.connectingTo==="output"?0:1,k=L?-1:1,T=i[0],I=i[1],E=y<b?y:y*Math.max(b/y,.5),G=t.createRadialGradient(T,I,0,T,I,E);G.addColorStop(1,"#00000000"),G.addColorStop(0,"#ffcc00aa");const R=t.createLinearGradient(m,_,m+y,_);if(R.addColorStop(.5,"#00000000"),R.addColorStop(L+.67*k,"#ddeeff33"),R.addColorStop(L+k,"#ffcc0055"),t.setLineDash([g,g*.001]),t.lineWidth=1,t.strokeStyle=R,t.stroke(),a){const{computedHeight:D}=a;t.beginPath();const{pos:[A,B]}=l,$=LiteGraph.NODE_WIDGET_HEIGHT;a.type.startsWith("custom")&&D!=null&&D>$*2?t.rect(A+9,B+a.y+9,(a.width??p[2])-18,D-18):t.roundRect(A+BaseWidget.margin,B+a.y,a.width??p[2],$,$*.5),t.stroke()}t.strokeStyle=G,t.stroke(),t.setLineDash([]),t.lineWidth=u,t.strokeStyle=d},Wi=function(t,i,s,n){var r,a;const{globalAlpha:o}=t;t.globalAlpha=o*.33;for(const l of i.floatingLinks.values()){const d=LLink.getReroutes(i,l),u=d[0],p=d.at(-1);if(!(!u||!(p!=null&&p.floating)))if(p.floating.slotType==="input"){const f=i.getNodeById(l.target_id);if(!f)continue;const g=u.pos,m=f.getInputPos(l.target_slot),_=(r=f.inputs[l.target_slot])==null?void 0:r.dir;u._dragging=!0,C(this,F,ne).call(this,t,l,g,m,s,n,LinkDirection.CENTER,_,!0)}else{const f=i.getNodeById(l.origin_id);if(!f)continue;const g=f.getOutputPos(l.origin_slot),m=p.pos,_=(a=f.outputs[l.origin_slot])==null?void 0:a.dir;l._dragging=!0,C(this,F,ne).call(this,t,l,g,m,s,n,_,LinkDirection.CENTER,!0)}}t.globalAlpha=o},ne=function(t,i,s,n,o,r,a,l,d=!1){var L,k,T;const{graph:u,renderedPaths:p}=this;if(!u)return;const f=LLink.getReroutes(u,i),g=[s,...f.map(I=>I.pos),n],m=g.map(I=>I[0]),_=g.map(I=>I[1]);if(S(O,Lt)[0]=Math.min(...m),S(O,Lt)[1]=Math.min(..._),S(O,Lt)[2]=Math.max(...m)-S(O,Lt)[0],S(O,Lt)[3]=Math.max(..._)-S(O,Lt)[1],!overlapBounding(S(O,Lt),S(O,Ct)))return;const y=a||LinkDirection.RIGHT,b=l||LinkDirection.LEFT;if(f.length){let I;const E=f.length;for(let R=0;R<E;R++){const N=f[R];if(!p.has(N)){p.add(N),o.push(N),N._colour=i.color||O.link_type_colors[i.type]||this.default_link_color;const D=u.getReroute(N.parentId),A=(D==null?void 0:D.pos)??s;N.calculateAngle(this.last_draw_time,u,A),N._dragging||this.renderLink(t,A,N.pos,i,!1,0,null,I===void 0?y:LinkDirection.CENTER,LinkDirection.CENTER,{startControl:I,endControl:N.controlPoint,reroute:N,disabled:d})}if(!I&&((k=(L=f.at(-1))==null?void 0:L.floating)==null?void 0:k.slotType)==="input")I=[0,0];else{const D=((T=f[R+1])==null?void 0:T.pos)??n,A=Math.min(Reroute.maxSplineOffset,distance(N.pos,D)*.25);I=[A*N.cos,A*N.sin]}}if(i._dragging)return;const G=g.at(-2)??s;this.renderLink(t,G,n,i,!1,0,null,LinkDirection.CENTER,b,{startControl:I,disabled:d})}else i._dragging||this.renderLink(t,s,n,i,!1,0,null,y,b);if(p.add(i),i!=null&&i._last_time&&r-i._last_time<1e3){const I=2-(r-i._last_time)*.002,E=t.globalAlpha;t.globalAlpha=E*I,this.renderLink(t,s,n,i,!0,I,"white",y,b),t.globalAlpha=E}},Ce=function(t,i,s,n=.25){switch(i){case LinkDirection.LEFT:t[0]+=s*-n;break;case LinkDirection.RIGHT:t[0]+=s*n;break;case LinkDirection.UP:t[1]+=s*-n;break;case LinkDirection.DOWN:t[1]+=s*n;break}},P(O,Ge,new Float32Array(4)),P(O,Ae,new Float32Array(2)),P(O,Fe,new Float32Array(4)),P(O,Ct,new Float32Array(4)),P(O,Lt,new Float32Array(4)),P(O,xe,new Float32Array(2)),P(O,Pe,new Float32Array(2)),P(O,We,new Float32Array(2)),h(O,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),h(O,"DEFAULT_EVENT_LINK_COLOR","#A86"),h(O,"link_type_colors",{"-1":O.DEFAULT_EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),h(O,"gradients",{}),h(O,"search_limit",-1),h(O,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}}),h(O,"_measureText"),h(O,"active_canvas"),h(O,"active_node");let LGraphCanvas=O;class MapProxyHandler{getOwnPropertyDescriptor(t,i){const s=this.get(t,i);if(s)return{configurable:!0,enumerable:!0,value:s}}has(t,i){if(typeof i=="symbol")return!1;const s=parseInt(i,10);return t.has(isNaN(s)?i:s)}ownKeys(t){return[...t.keys()].map(String)}get(t,i){if(i in t)return Reflect.get(t,i,t);if(typeof i=="symbol")return;const s=parseInt(i,10);return t.get(isNaN(s)?i:s)}set(t,i,s){if(typeof i=="symbol")return!1;const n=parseInt(i,10);return t.set(isNaN(n)?i:n,s),!0}deleteProperty(t,i){return t.delete(i)}static bindAllMethods(t){t.clear=t.clear.bind(t),t.delete=t.delete.bind(t),t.forEach=t.forEach.bind(t),t.get=t.get.bind(t),t.has=t.has.bind(t),t.set=t.set.bind(t),t.entries=t.entries.bind(t),t.keys=t.keys.bind(t),t.values=t.values.bind(t),t[Symbol.iterator]=t[Symbol.iterator].bind(t)}}const ot=class ot{constructor(t){P(this,Be);h(this,"id",zeroUuid);h(this,"revision",0);h(this,"_version",-1);h(this,"_links",new Map);h(this,"links");h(this,"list_of_graphcanvas");h(this,"status",ot.STATUS_STOPPED);h(this,"state",{lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0});h(this,"events",new CustomEventTarget);h(this,"_subgraphs",new Map);h(this,"_nodes",[]);h(this,"_nodes_by_id",{});h(this,"_nodes_in_order",[]);h(this,"_nodes_executable",null);h(this,"_groups",[]);h(this,"iteration",0);h(this,"globaltime",0);h(this,"runningtime",0);h(this,"fixedtime",0);h(this,"fixedtime_lapse",.01);h(this,"elapsed_time",.01);h(this,"last_update_time",0);h(this,"starttime",0);h(this,"catch_errors",!0);h(this,"execution_timer_id");h(this,"errors_in_execution");h(this,"execution_time");h(this,"_last_trigger_time");h(this,"filter");h(this,"config",{});h(this,"vars",{});h(this,"nodes_executing",[]);h(this,"nodes_actioning",[]);h(this,"nodes_executedAction",[]);h(this,"extra",{});h(this,"version");P(this,Wt,0);P(this,Mt,new Map);P(this,Me,new Map);h(this,"_input_nodes");P(this,we);LiteGraph.debug&&console.log("Graph created");const i=this._links;MapProxyHandler.bindAllMethods(i);const s=new MapProxyHandler;this.links=new Proxy(i,s),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}get empty(){return this._nodes.length+this._groups.length+this.reroutes.size===0}*positionableItems(){for(const t of this._nodes)yield t;for(const t of this._groups)yield t;for(const t of this.reroutes.values())yield t}get floatingLinks(){return S(this,Mt)}get reroutes(){return S(this,Me)}get rootGraph(){return this}get isRootGraph(){return this.rootGraph===this}get last_node_id(){return this.state.lastNodeId}set last_node_id(t){this.state.lastNodeId=t}get last_link_id(){return this.state.lastLinkId}set last_link_id(t){this.state.lastLinkId=t}clear(){var t;if(this.stop(),this.status=ot.STATUS_STOPPED,this.id=zeroUuid,this.revision=0,this.state={lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0},this._version=-1,this._subgraphs.clear(),this._nodes)for(const i of this._nodes)(t=i.onRemoved)==null||t.call(i);this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._links.clear(),this.reroutes.clear(),S(this,Mt).clear(),z(this,Wt,0),this._groups=[],this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.change(),this.canvasAction(i=>i.clear())}get subgraphs(){return this.rootGraph._subgraphs}get nodes(){return this._nodes}get groups(){return this._groups}attachCanvas(t){var i;if(!(t instanceof LGraphCanvas))throw new TypeError("attachCanvas expects an LGraphCanvas instance");this.primaryCanvas=t,this.list_of_graphcanvas??(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.includes(t)||this.list_of_graphcanvas.push(t),t.graph!==this&&((i=t.graph)==null||i.detachCanvas(t),t.graph=this,t.subgraph=void 0)}detachCanvas(t){t.graph=null;const i=this.list_of_graphcanvas;if(i){const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}start(t){var i;if(this.status!=ot.STATUS_RUNNING)if(this.status=ot.STATUS_RUNNING,(i=this.onPlayEvent)==null||i.call(this),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,t||(t=0),t==0&&typeof window<"u"&&window.requestAnimationFrame){const s=()=>{var n,o;this.execution_timer_id==-1&&(window.requestAnimationFrame(s),(n=this.onBeforeStep)==null||n.call(this),this.runStep(1,!this.catch_errors),(o=this.onAfterStep)==null||o.call(this))};this.execution_timer_id=-1,s()}else this.execution_timer_id=setInterval(()=>{var s,n;(s=this.onBeforeStep)==null||s.call(this),this.runStep(1,!this.catch_errors),(n=this.onAfterStep)==null||n.call(this)},t)}stop(){var t;this.status!=ot.STATUS_STOPPED&&(this.status=ot.STATUS_STOPPED,(t=this.onStopEvent)==null||t.call(this),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t,i,s){var l,d,u,p,f,g;t=t||1;const n=LiteGraph.getTime();this.globaltime=.001*(n-this.starttime);const o=this._nodes_executable||this._nodes;if(!o)return;if(s=s||o.length,i){for(let m=0;m<t;m++){for(let _=0;_<s;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&y.onExecute&&((l=y.doExecute)==null||l.call(y))}this.fixedtime+=this.fixedtime_lapse,(d=this.onExecuteStep)==null||d.call(this)}(u=this.onAfterExecute)==null||u.call(this)}else try{for(let m=0;m<t;m++){for(let _=0;_<s;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&((p=y.onExecute)==null||p.call(y))}this.fixedtime+=this.fixedtime_lapse,(f=this.onExecuteStep)==null||f.call(this)}(g=this.onAfterExecute)==null||g.call(this),this.errors_in_execution=!1}catch(m){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw m;LiteGraph.debug&&console.log("Error during execution:",m),this.stop()}const r=LiteGraph.getTime();let a=r-n;a==0&&(a=1),this.execution_time=.001*a,this.globaltime+=.001*a,this.iteration+=1,this.elapsed_time=(r-this.last_update_time)*.001,this.last_update_time=r,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(const t of this._nodes_in_order)t.onExecute&&this._nodes_executable.push(t)}computeExecutionOrder(t,i){const s=[],n=[],o={},r={},a={};for(const d of this._nodes){if(t&&!d.onExecute)continue;o[d.id]=d;let u=0;if(d.inputs)for(const p of d.inputs)(p==null?void 0:p.link)!=null&&(u+=1);u==0?(n.push(d),i&&(d._level=1)):(i&&(d._level=0),a[d.id]=u)}for(;;){const d=n.shift();if(d===void 0)break;if(s.push(d),delete o[d.id],!!d.outputs){for(const u of d.outputs)if(!((u==null?void 0:u.links)==null||u.links.length==0))for(const p of u.links){const f=this._links.get(p);if(!f||r[f.id])continue;const g=this.getNodeById(f.target_id);if(g==null){r[f.id]=!0;continue}i&&(d._level??(d._level=0),(!g._level||g._level<=d._level)&&(g._level=d._level+1)),r[f.id]=!0,a[g.id]-=1,a[g.id]==0&&n.push(g)}}}for(const d in o)s.push(o[d]);s.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");function l(d){const u=d.length;for(let p=0;p<u;++p)d[p].order=p}return l(s),s.sort(function(d,u){const p=d.constructor.priority||d.priority||0,f=u.constructor.priority||u.priority||0;return p==f?d.order-u.order:p-f}),l(s),s}arrange(t,i){t=t||100;const s=this.computeExecutionOrder(!1,!0),n=[];for(const r of s){const a=r._level||1;n[a]||(n[a]=[]),n[a].push(r)}let o=t;for(const r of n){if(!r)continue;let a=100,l=t+LiteGraph.NODE_TITLE_HEIGHT;for(const d of r){d.pos[0]=i==LiteGraph.VERTICAL_LAYOUT?l:o,d.pos[1]=i==LiteGraph.VERTICAL_LAYOUT?o:l;const u=i==LiteGraph.VERTICAL_LAYOUT?1:0;d.size[u]>a&&(a=d.size[u]);const p=i==LiteGraph.VERTICAL_LAYOUT?0:1;l+=d.size[p]+t+LiteGraph.NODE_TITLE_HEIGHT}o+=a+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,i,s){s=s||LGraphEventMode.ALWAYS;const n=this._nodes_in_order||this._nodes;if(n)for(const o of n)!o[t]||o.mode!=s||(i===void 0?o[t]():i&&i.constructor===Array?o[t].apply(o,i):o[t](i))}canvasAction(t){const i=this.list_of_graphcanvas;if(i)for(const s of i)t(s)}sendActionToCanvas(t,i){var n;const{list_of_graphcanvas:s}=this;if(s)for(const o of s)(n=o[t])==null||n.apply(o,i)}add(t,i){var n,o;if(!t)return;const{state:s}=this;if(LiteGraph.alwaysSnapToGrid){const r=this.getSnapToGridSize();r&&t.snapToGrid(r)}if(t instanceof LGraphGroup){(t.id==null||t.id===-1)&&(t.id=++s.lastGroupId),t.id>s.lastGroupId&&(s.lastGroupId=t.id),this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=LiteGraph.use_uuids?LiteGraph.uuidv4():++s.lastNodeId),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++s.lastNodeId:typeof t.id=="number"&&s.lastNodeId<t.id&&(s.lastNodeId=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,(n=t.onAdded)==null||n.call(t,this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),(o=this.onNodeAdded)==null||o.call(this,t),this.setDirtyCanvas(!0),this.change(),t}remove(t){var r,a,l;if(t instanceof LGraphGroup){this.canvasAction(u=>u.deselect(t));const d=this._groups.indexOf(t);d!=-1&&this._groups.splice(d,1),t.graph=void 0,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]==null){console.warn("LiteGraph: node not found",t);return}if(t.ignore_remove){console.warn("LiteGraph: node cannot be removed",t);return}this.beforeChange();const{inputs:i,outputs:s}=t;if(i)for(const[d,u]of i.entries())u.link!=null&&t.disconnectInput(d,!0);if(s)for(const[d,u]of s.entries())(r=u.links)!=null&&r.length&&t.disconnectOutput(d);for(const d of this.floatingLinks.values())(d.origin_id===t.id||d.target_id===t.id)&&this.removeFloatingLink(d);(a=t.onRemoved)==null||a.call(t),t.graph=null,this._version++;const{list_of_graphcanvas:n}=this;if(n)for(const d of n)d.selected_nodes[t.id]&&delete d.selected_nodes[t.id],d.deselect(t);const o=this._nodes.indexOf(t);o!=-1&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],(l=this.onNodeRemoved)==null||l.call(this,t),this.canvasAction(d=>d.checkPanels()),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}getNodeById(t){return t!=null?this._nodes_by_id[t]:null}findNodesByClass(t,i){i=i||[],i.length=0;const{_nodes:s}=this;for(const n of s)n.constructor===t&&i.push(n);return i}findNodesByType(t,i){var o;const s=t.toLowerCase();i=i||[],i.length=0;const{_nodes:n}=this;for(const r of n)((o=r.type)==null?void 0:o.toLowerCase())==s&&i.push(r);return i}findNodeByTitle(t){const{_nodes:i}=this;for(const s of i)if(s.title==t)return s;return null}findNodesByTitle(t){const i=[],{_nodes:s}=this;for(const n of s)n.title==t&&i.push(n);return i}getNodeOnPos(t,i,s){const n=s||this._nodes;let o=n.length;for(;--o>=0;){const r=n[o];if(r.isPointInside(t,i))return r}return null}getGroupOnPos(t,i){return this._groups.toReversed().find(s=>s.isPointInside(t,i))}getGroupTitlebarOnPos(t,i){return this._groups.toReversed().find(s=>s.isPointInTitlebar(t,i))}getRerouteOnPos(t,i,s){for(const n of s??this.reroutes.values())if(n.containsPoint([t,i]))return n}snapToGrid(t){const i=this.getSnapToGridSize();if(i)for(const s of getAllNestedItems(t))s.pinned||s.snapToGrid(i)}getSnapToGridSize(){return LiteGraph.alwaysSnapToGrid?LiteGraph.CANVAS_GRID_SIZE||1:LiteGraph.CANVAS_GRID_SIZE}checkNodeTypes(){const{_nodes:t}=this;for(const[i,s]of t.entries()){const n=LiteGraph.registered_node_types[s.type];if(s.constructor==n)continue;console.log("node being replaced by newer version:",s.type);const o=LiteGraph.createNode(s.type);o&&(t[i]=o,o.configure(s.serialize()),o.graph=this,this._nodes_by_id[o.id]=o,s.inputs&&(o.inputs=[...s.inputs]),s.outputs&&(o.outputs=[...s.outputs]))}this.updateExecutionOrder()}trigger(t,i){var s;(s=this.onTrigger)==null||s.call(this,t,i)}triggerInput(t,i){const s=this.findNodesByTitle(t);for(const n of s)n.onTrigger(i)}setCallback(t,i){const s=this.findNodesByTitle(t);for(const n of s)n.setTrigger(i)}beforeChange(t){var i;(i=this.onBeforeChange)==null||i.call(this,this,t),this.canvasAction(s=>{var n;return(n=s.onBeforeChange)==null?void 0:n.call(s,this)})}afterChange(t){var i;(i=this.onAfterChange)==null||i.call(this,this,t),this.canvasAction(s=>{var n;return(n=s.onAfterChange)==null?void 0:n.call(s,this)})}clearTriggeredSlots(){for(const t of this._links.values())t&&t._last_time&&(t._last_time=0)}change(){var t;LiteGraph.debug&&console.log("Graph changed"),this.canvasAction(i=>i.setDirty(!0,!0)),(t=this.on_change)==null||t.call(this,this)}setDirtyCanvas(t,i){this.canvasAction(s=>s.setDirty(t,i))}addFloatingLink(t){var n,o,r,a;t.id===-1&&(t.id=++ui(this,Wt)._),S(this,Mt).set(t.id,t);const i=t.target_id!==-1?(o=(n=this.getNodeById(t.target_id))==null?void 0:n.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i?(i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(t)):console.warn(`Adding invalid floating link: target/slot: [${t.target_id}/${t.target_slot}] origin/slot: [${t.origin_id}/${t.origin_slot}]`);const s=LLink.getReroutes(this,t);for(const l of s)l.floatingLinkIds.add(t.id);return t}removeFloatingLink(t){var n,o,r,a,l;S(this,Mt).delete(t.id);const i=t.target_id!==-1?(o=(n=this.getNodeById(t.target_id))==null?void 0:n.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i&&((l=i._floatingLinks)==null||l.delete(t));const s=LLink.getReroutes(this,t);for(const d of s)d.floatingLinkIds.delete(t.id),d.floatingLinkIds.size===0&&delete d.floating,d.totalLinks===0&&this.removeReroute(d.id)}getLink(t){return t==null?void 0:this._links.get(t)}getReroute(t){return t==null?void 0:this.reroutes.get(t)}setReroute({id:t,parentId:i,pos:s,linkIds:n,floating:o}){t??(t=++this.state.lastRerouteId),t>this.state.lastRerouteId&&(this.state.lastRerouteId=t);const r=this.reroutes.get(t)??new Reroute(t,this);return r.update(i,s,n,o),this.reroutes.set(t,r),r}createReroute(t,i){const s=++this.state.lastRerouteId,n=i instanceof Reroute?i.linkIds:[i.id],o=i instanceof Reroute?i.floatingLinkIds:[i.id],r=new Reroute(s,this,t,i.parentId,n,o);this.reroutes.set(s,r);for(const a of n){const l=this._links.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=s);const d=LLink.getReroutes(this,l);for(const u of d.filter(p=>p.parentId===i.parentId))u.parentId=s}for(const a of o){const l=this.floatingLinks.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=s);const d=LLink.getReroutes(this,l);for(const u of d.filter(p=>p.parentId===i.parentId))u.parentId=s}return r}removeReroute(t){const{reroutes:i}=this,s=i.get(t);if(!s)return;this.canvasAction(a=>a.deselect(s));const{parentId:n,linkIds:o,floatingLinkIds:r}=s;for(const a of i.values())a.parentId===t&&(a.parentId=n);for(const a of o){const l=this._links.get(a);l&&l.parentId===t&&(l.parentId=n)}for(const a of r){const l=this.floatingLinks.get(a);if(!l){console.warn(`Removed reroute had floating link ID that did not exist [${a}]`);continue}const d=LLink.getReroutes(this,l),u=d.at(-1),p=d.at(-2);s===u&&((p==null?void 0:p.totalLinks)!==1?this.removeFloatingLink(l):l.parentId===t&&(l.parentId=n,p.floating=s.floating))}i.delete(t),this.setDirtyCanvas(!1,!0)}removeLink(t){const i=this._links.get(t);if(!i)return;const s=this.getNodeById(i.target_id);s==null||s.disconnectInput(i.target_slot,!1),i.disconnect(this)}createSubgraph(t){const{id:i}=t,s=new Subgraph(this.rootGraph,t);return this.subgraphs.set(i,s),this.rootGraph.events.dispatch("subgraph-created",{subgraph:s,data:t}),s}convertToSubgraph(t){var B,$;if(t.size===0)throw new Error("Cannot convert to subgraph: nothing to convert");const{state:i,revision:s,config:n}=this,{boundaryLinks:o,boundaryFloatingLinks:r,internalLinks:a,boundaryInputLinks:l,boundaryOutputLinks:d}=getBoundaryLinks(this,t),{nodes:u,reroutes:p,groups:f}=splitPositionables(t),g=createBounds(t);if(!g)throw new Error("Failed to create bounding rect for subgraph");const m=l.map(W=>W.resolve(this)),_=d.map(W=>W.resolve(this)),y=multiClone(u),b=a.map(W=>W.asSerialisable()),L=mapSubgraphInputsAndLinks(m,b),k=mapSubgraphOutputsAndLinks(_,b),T={id:createUuidv4(),name:"New Subgraph",inputNode:{id:SUBGRAPH_INPUT_ID,bounding:[0,0,75,100]},outputNode:{id:SUBGRAPH_OUTPUT_ID,bounding:[0,0,75,100]},inputs:L,outputs:k,widgets:[],version:ot.serialisedSchemaVersion,state:i,revision:s,config:n,links:b,nodes:y,reroutes:structuredClone([...p].map(W=>W.asSerialisable())),groups:structuredClone([...f].map(W=>W.serialize()))},I=this.createSubgraph(T);I.configure(T),I.inputNode.arrange(),I.outputNode.arrange();const{boundingRect:E}=I.inputNode,{boundingRect:G}=I.outputNode;alignOutsideContainer(E,Alignment.MidLeft,g,[50,0]),alignOutsideContainer(G,Alignment.MidRight,g,[50,0]);for(const W of m)(B=W.inputNode)==null||B.disconnectInput(W.inputNode.inputs.indexOf(W.input),!0);for(const W of _)($=W.outputNode)==null||$.disconnectOutput(W.outputNode.outputs.indexOf(W.output),W.inputNode);for(const W of u)this.remove(W);for(const W of p)this.removeReroute(W.id);for(const W of f)this.remove(W);this.rootGraph.events.dispatch("convert-to-subgraph",{subgraph:I,bounds:g,exportedSubgraph:T,boundaryLinks:o,resolvedInputLinks:m,resolvedOutputLinks:_,boundaryFloatingLinks:r,internalLinks:a});const R=LiteGraph.createNode(I.id,I.name,{inputs:structuredClone(L),outputs:structuredClone(k)});if(!R)throw new Error("Failed to create subgraph node");R.setSize(R.computeSize()),alignToContainer(R._posSize,Alignment.Centre|Alignment.Middle,g),this.add(R);const N=groupResolvedByOutput(m);let D=0;for(const[,W]of N.entries()){const[j,...dt]=W,{output:it,outputNode:X,link:Z,subgraphInput:St}=j;if(D++,Z.origin_id===SUBGRAPH_INPUT_ID){if(Z.target_id=R.id,Z.target_slot=D-1,St instanceof SubgraphInput)St.connect(R.findInputSlotByType(Z.type,!0,!0),R,Z.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");console.debug("Reconnect input links in parent graph",{...Z},this.links.get(Z.id),this.links.get(Z.id)===Z);for(const Tt of dt)Tt.link.disconnect(this);continue}if(!it||!X){console.warn("Convert to Subgraph reconnect: Failed to resolve input link",W[0]);continue}const yt=R.findInputSlotByType(Z.type,!0,!0);X.connectSlots(it,R,yt,Z.parentId)}const A=groupResolvedByOutput(_);D=0;for(const[,W]of A.entries()){D++;for(const j of W){const{input:dt,inputNode:it,link:X,subgraphOutput:Z}=j;if(X.target_id===SUBGRAPH_OUTPUT_ID){if(X.origin_id=R.id,X.origin_slot=D-1,this.links.set(X.id,X),Z instanceof SubgraphOutput)Z.connect(R.findOutputSlotByType(X.type,!0,!0),R,X.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");continue}if(!dt||!it){console.warn("Convert to Subgraph reconnect: Failed to resolve output link",j);continue}const St=R.outputs[D-1];R.connectSlots(St,it,dt,X.parentId)}}return{subgraph:I,node:R}}resolveSubgraphIdPath(t){const i=[];let s=this.rootGraph;for(const n of t){const o=s.getNodeById(n);if(!o)throw new Error(`Node [${n}] not found.  ID Path: ${t.join(":")}`);if(!o.isSubgraphNode())throw new Error(`Node [${n}] is not a SubgraphNode.  ID Path: ${t.join(":")}`);i.push(o),s=o.subgraph}return i}serialize(t){const{config:i,state:s,groups:n,nodes:o,reroutes:r,extra:a,floatingLinks:l,definitions:d}=this.asSerialisable(t),u=[...this._links.values()],p=u.map(f=>f.serialize());return r!=null&&r.length&&(a.linkExtensions=u.filter(f=>f.parentId!==void 0).map(f=>({id:f.id,parentId:f.parentId}))),a.reroutes=r!=null&&r.length?r:void 0,{id:this.id,revision:this.revision,last_node_id:s.lastNodeId,last_link_id:s.lastLinkId,nodes:o,links:p,floatingLinks:l,groups:n,definitions:d,config:i,extra:a,version:LiteGraph.VERSION}}asSerialisable(t){var m;const{id:i,revision:s,config:n,state:o}=this,a=(!LiteGraph.use_uuids&&(t!=null&&t.sortNodes)?[...this._nodes].sort((_,y)=>_.id-y.id):this._nodes).map(_=>_.serialize()),l=this._groups.map(_=>_.serialize()),d=this._links.size?[...this._links.values()].map(_=>_.asSerialisable()):void 0,u=this.floatingLinks.size?[...this.floatingLinks.values()].map(_=>_.asSerialisable()):void 0,p=this.reroutes.size?[...this.reroutes.values()].map(_=>_.asSerialisable()):void 0,f={...this.extra};LiteGraph.saveViewportWithGraph&&(f.ds=C(this,Be,Mi).call(this)),f.ds||delete f.ds;const g={id:i,revision:s,version:ot.serialisedSchemaVersion,config:n,state:o,groups:l,nodes:a,links:d,floatingLinks:u,reroutes:p,extra:f};if(this.isRootGraph&&this._subgraphs.size){const _=findUsedSubgraphIds(this,this._subgraphs),y=[...this._subgraphs.values()].filter(b=>_.has(b.id)).map(b=>b.asSerialisable());y.length>0&&(g.definitions={subgraphs:y})}return(m=this.onSerialize)==null||m.call(this,g),g}_configureBase(t){const{id:i,extra:s}=t;i?this.id=i:this.id===zeroUuid&&(this.id=createUuidv4()),this.extra=s?structuredClone(s):{},delete this.extra.linkExtensions}configure(t,i){var o,r,a,l,d;const s={data:t,clearGraph:!i};if(this.events.dispatch("configuring",s))try{if(!t)return;s.clearGraph&&this.clear(),this._configureBase(t);let u;if(t.version===.4){const{extra:L}=t;if(Array.isArray(t.links))for(const k of t.links){const T=LLink.createFromArray(k);this._links.set(T.id,T)}if(Array.isArray(L==null?void 0:L.linkExtensions))for(const k of L.linkExtensions){const T=this._links.get(k.id);T&&(T.parentId=k.parentId)}u=L==null?void 0:L.reroutes}else{if(t.state){const{lastGroupId:L,lastLinkId:k,lastNodeId:T,lastRerouteId:I}=t.state,{state:E}=this;L!=null&&(E.lastGroupId=L),k!=null&&(E.lastLinkId=k),T!=null&&(E.lastNodeId=T),I!=null&&(E.lastRerouteId=I)}if(Array.isArray(t.links))for(const L of t.links){const k=LLink.create(L);this._links.set(k.id,k)}u=t.reroutes}if(Array.isArray(u))for(const L of u)this.setReroute(L);const p=t.nodes;for(const L in t)ot.ConfigureProperties.has(L)||(this[L]=t[L]);const f=(o=t.definitions)==null?void 0:o.subgraphs;if(f){for(const L of f)this.createSubgraph(L);for(const L of f)(r=this.subgraphs.get(L.id))==null||r.configure(L)}let g=!1;const m=new Map;if(this._nodes=[],p){for(const L of p){let k=LiteGraph.createNode(String(L.type),L.title);k||(LiteGraph.debug&&console.log("Node not found or has errors:",L.type),k=new LGraphNode(""),k.last_serialization=L,k.has_errors=!0,g=!0),k.id=L.id,this.add(k,!0),m.set(k.id,L)}for(const[L,k]of m)(a=this.getNodeById(L))==null||a.configure(k)}if(Array.isArray(t.floatingLinks))for(const L of t.floatingLinks){const k=LLink.create(L);this.addFloatingLink(k),k.id>S(this,Wt)&&z(this,Wt,k.id)}for(const L of this.reroutes.values())L.validateLinks(this._links,this.floatingLinks)||this.reroutes.delete(L.id);this._groups.length=0;const _=t.groups;if(_)for(const L of _){const k=new LiteGraph.LGraphGroup;k.configure(L),this.add(k)}this.updateExecutionOrder(),(l=this.onConfigure)==null||l.call(this,t),this._version++;const{primaryCanvas:y}=this,b=(d=y==null?void 0:y.subgraph)==null?void 0:d.id;if(b){const L=this.subgraphs.get(b);L?y.setGraph(L):y.setGraph(this)}return this.setDirtyCanvas(!0,!0),g}finally{this.events.dispatch("configured")}}get primaryCanvas(){return S(this.rootGraph,we)}set primaryCanvas(t){z(this.rootGraph,we,t)}load(t,i){const s=this;if(t instanceof Blob||t instanceof File){const o=new FileReader;o.addEventListener("load",function(r){var d;const a=stringOrEmpty((d=r.target)==null?void 0:d.result),l=JSON.parse(a);s.configure(l),i==null||i()}),o.readAsText(t);return}const n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.addEventListener("load",function(){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}const o=JSON.parse(n.response);s.configure(o),i==null||i()}),n.addEventListener("error",o=>{console.error("Error loading graph:",o)})}};Wt=new WeakMap,Mt=new WeakMap,Me=new WeakMap,Be=new WeakSet,Mi=function(){var i,s;const t=(s=(i=this.list_of_graphcanvas)==null?void 0:i.at(0))==null?void 0:s.ds;if(t)return{scale:t.scale,offset:t.offset}},we=new WeakMap,h(ot,"serialisedSchemaVersion",1),h(ot,"STATUS_STOPPED",1),h(ot,"STATUS_RUNNING",2),h(ot,"ConfigureProperties",new Set(["nodes","groups","links","state","reroutes","floatingLinks","id","subgraphs","definitions","inputs","outputs","widgets","inputNode","outputNode","extra"]));let LGraph=ot;const ze=class ze extends LGraph{constructor(i,s){if(!i)throw new Error("Root graph is required");super();P(this,Le);h(this,"name","Unnamed Subgraph");h(this,"inputNode",new SubgraphInputNode(this));h(this,"outputNode",new SubgraphOutputNode(this));h(this,"inputs",[]);h(this,"outputs",[]);h(this,"widgets",[]);P(this,ke);z(this,ke,i);const n=structuredClone(s);this._configureBase(n),C(this,Le,ai).call(this,n)}get rootGraph(){return S(this,ke)}getIoNodeOnPos(i,s){const{inputNode:n,outputNode:o}=this;if(n.containsPoint([i,s]))return n;if(o.containsPoint([i,s]))return o}configure(i,s){const n=super.configure(i,s);return C(this,Le,ai).call(this,i),n}attachCanvas(i){super.attachCanvas(i),i.subgraph=this}addInput(i,s){this.events.dispatch("adding-input",{name:i,type:s});const n=new SubgraphInput({id:createUuidv4(),name:i,type:s},this.inputNode);return this.inputs.push(n),this.events.dispatch("input-added",{input:n}),n}addOutput(i,s){this.events.dispatch("adding-output",{name:i,type:s});const n=new SubgraphOutput({id:createUuidv4(),name:i,type:s},this.outputNode);return this.outputs.push(n),this.events.dispatch("output-added",{output:n}),n}renameInput(i,s){const n=this.inputs.indexOf(i);if(n===-1)throw new Error("Input not found");const o=i.displayName;this.events.dispatch("renaming-input",{input:i,index:n,oldName:o,newName:s}),i.label=s}renameOutput(i,s){const n=this.outputs.indexOf(i);if(n===-1)throw new Error("Output not found");const o=i.displayName;this.events.dispatch("renaming-output",{output:i,index:n,oldName:o,newName:s}),i.label=s}removeInput(i){i.disconnect();const s=this.inputs.indexOf(i);if(s===-1)throw new Error("Input not found");if(!this.events.dispatch("removing-input",{input:i,index:s}))return;this.inputs.splice(s,1);const{length:o}=this.inputs;for(let r=s;r<o;r++)this.inputs[r].decrementSlots("inputs")}removeOutput(i){i.disconnect();const s=this.outputs.indexOf(i);if(s===-1)throw new Error("Output not found");if(!this.events.dispatch("removing-output",{output:i,index:s}))return;this.outputs.splice(s,1);const{length:o}=this.outputs;for(let r=s;r<o;r++)this.outputs[r].decrementSlots("outputs")}draw(i,s,n,o){this.inputNode.draw(i,s,n,o),this.outputNode.draw(i,s,n,o)}clone(i=!1){const s=this.asSerialisable();i||(s.id=createUuidv4());const n=new ze(this.rootGraph,s);return n.configure(s),n}asSerialisable(){return{id:this.id,version:LGraph.serialisedSchemaVersion,state:this.state,revision:this.revision,config:this.config,name:this.name,inputNode:this.inputNode.asSerialisable(),outputNode:this.outputNode.asSerialisable(),inputs:this.inputs.map(i=>i.asSerialisable()),outputs:this.outputs.map(i=>i.asSerialisable()),widgets:[...this.widgets],nodes:this.nodes.map(i=>i.serialize()),groups:this.groups.map(i=>i.serialize()),links:[...this.links.values()].map(i=>i.asSerialisable()),extra:this.extra}}};ke=new WeakMap,Le=new WeakSet,ai=function(i){const{name:s,inputs:n,outputs:o,widgets:r}=i;if(this.name=s,n){this.inputs.length=0;for(const a of n){const l=new SubgraphInput(a,this.inputNode);this.inputs.push(l),this.events.dispatch("input-added",{input:l})}}if(o){this.outputs.length=0;for(const a of o)this.outputs.push(new SubgraphOutput(a,this.outputNode))}if(r){this.widgets.length=0;for(const a of r)this.widgets.push(a)}this.inputNode.configure(i.inputNode),this.outputNode.configure(i.outputNode)},h(ze,"MAX_NESTED_SUBGRAPHS",1e3);let Subgraph=ze;class InputIndicators{constructor(t){h(this,"radius",8);h(this,"startAngle",0);h(this,"endAngle",Math.PI*2);h(this,"inactiveColour","#ffffff10");h(this,"colour1","#ff5f00");h(this,"colour2","#00ff7c");h(this,"colour3","#dea7ff");h(this,"fontString","bold 12px Arial");h(this,"enabled",!0);h(this,"shiftDown",!1);h(this,"undoDown",!1);h(this,"redoDown",!1);h(this,"ctrlDown",!1);h(this,"altDown",!1);h(this,"mouse0Down",!1);h(this,"mouse1Down",!1);h(this,"mouse2Down",!1);h(this,"x",0);h(this,"y",0);h(this,"controller");P(this,Ie,this.onPointerDownOrMove.bind(this));P(this,Ve,this.onPointerUp.bind(this));P(this,Se,this.onKeyDownOrUp.bind(this));this.canvas=t,this.controller=new AbortController;const{signal:i}=this.controller,s=t.canvas,n={capture:!0,signal:i};s.addEventListener("pointerdown",S(this,Ie),n),s.addEventListener("pointermove",S(this,Ie),n),s.addEventListener("pointerup",S(this,Ve),n),s.addEventListener("keydown",S(this,Se),n),document.addEventListener("keyup",S(this,Se),n);const o=t.drawFrontCanvas.bind(t);i.addEventListener("abort",()=>{t.drawFrontCanvas=o}),t.drawFrontCanvas=()=>{o(),this.draw()}}onPointerDownOrMove(t){this.mouse0Down=(t.buttons&1)===1,this.mouse1Down=(t.buttons&4)===4,this.mouse2Down=(t.buttons&2)===2,this.x=t.clientX,this.y=t.clientY,this.canvas.setDirty(!0)}onPointerUp(){this.mouse0Down=!1,this.mouse1Down=!1,this.mouse2Down=!1}onKeyDownOrUp(t){this.ctrlDown=t.ctrlKey,this.altDown=t.altKey,this.shiftDown=t.shiftKey,this.undoDown=t.ctrlKey&&t.code==="KeyZ"&&t.type==="keydown",this.redoDown=t.ctrlKey&&t.code==="KeyY"&&t.type==="keydown"}draw(){const{canvas:{ctx:t},radius:i,startAngle:s,endAngle:n,x:o,y:r,inactiveColour:a,colour1:l,colour2:d,colour3:u,fontString:p}=this,{fillStyle:f,font:g}=t,m=o,_=r-80,y=m,b=_-15;t.font=p,I(y+0,b,"Shift",this.shiftDown?l:a),I(y+45,b+20,"Alt",this.altDown?d:a),I(y+30,b,"Control",this.ctrlDown?u:a),I(y-30,b,"â†©ï¸",this.undoDown?"#000":"transparent"),I(y+45,b,"â†ªï¸",this.redoDown?"#000":"transparent"),t.beginPath(),G(m,_),G(m+15,_),G(m+30,_),t.fillStyle=a,t.fill();const L=this.mouse0Down?l:a,k=this.mouse1Down?d:a,T=this.mouse2Down?u:a;this.mouse0Down&&E(m,_,L),this.mouse1Down&&E(m+15,_,k),this.mouse2Down&&E(m+30,_,T),t.fillStyle=f,t.font=g;function I(R,N,D,A){t.fillStyle=A,t.fillText(D,R,N)}function E(R,N,D){t.beginPath(),t.fillStyle=D,G(R,N),t.fill()}function G(R,N){t.arc(R,N,i,s,n)}}dispose(){var t;(t=this.controller)==null||t.abort(),this.controller=void 0}[Symbol.dispose](){this.dispose()}}Ie=new WeakMap,Ve=new WeakMap,Se=new WeakMap;class ContextMenu{constructor(t,i){h(this,"options");h(this,"parentMenu");h(this,"root");h(this,"current_submenu");h(this,"lock");h(this,"controller",new AbortController);var g,m,_;i||(i={}),this.options=i;const s=i.parentMenu;s&&(s instanceof ContextMenu?(this.parentMenu=s,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this):(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=void 0),((g=s.options)==null?void 0:g.className)==="dark"&&(i.className="dark"));const n=i.event?i.event.constructor.name:null;n!=="MouseEvent"&&n!=="CustomEvent"&&n!=="PointerEvent"&&(console.error(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${n})`),i.event=void 0);const o=document.createElement("div");let r="litegraph litecontextmenu litemenubar-panel";i.className&&(r+=` ${i.className}`),o.className=r,o.style.minWidth="100",o.style.minHeight="100";const{signal:a}=this.controller,l={capture:!0,signal:a};if(this.parentMenu||document.addEventListener("pointerdown",y=>{y.target instanceof Node&&!this.containsNode(y.target)&&this.close()},l),o.addEventListener("pointerup",y=>y.preventDefault(),l),o.addEventListener("contextmenu",y=>{y.button===2&&y.preventDefault()},l),o.addEventListener("pointerdown",y=>{y.button==2&&(this.close(),y.preventDefault())},l),this.root=o,i.title){const y=document.createElement("div");y.className="litemenu-title",y.innerHTML=i.title,o.append(y)}for(let y=0;y<t.length;y++){const b=t[y];let L=Array.isArray(t)?b:String(y);typeof L!="string"&&(L=L!=null?L.content===void 0?String(L):L.content:L),this.addItem(L,b,i)}const u=((_=(m=i.event)==null?void 0:m.target)==null?void 0:_.ownerDocument)||document;u.fullscreenElement?u.fullscreenElement.append(o):u.body.append(o);let p=i.left||0,f=i.top||0;if(i.event){if(p=i.event.clientX-10,f=i.event.clientY-10,i.title&&(f-=20),s){const L=s.root.getBoundingClientRect();p=L.left+L.width}const y=document.body.getBoundingClientRect(),b=o.getBoundingClientRect();y.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),y.width&&p>y.width-b.width-10&&(p=y.width-b.width-10),y.height&&f>y.height-b.height-10&&(f=y.height-b.height-10)}o.style.left=`${p}px`,o.style.top=`${f}px`,LiteGraph.context_menu_scaling&&i.scale&&(o.style.transform=`scale(${Math.round(i.scale*4)*.25})`)}containsNode(t,i=new Set){var s;return i.has(this)?!1:(i.add(this),((s=this.current_submenu)==null?void 0:s.containsNode(t,i))||this.root.contains(t))}addItem(t,i,s){s||(s={});const n=document.createElement("div");n.className="litemenu-entry submenu";let o=!1;if(i===null)n.classList.add("separator");else{const u=t===null?"":String(t);typeof i=="string"?n.innerHTML=u:(n.innerHTML=(i==null?void 0:i.title)??u,i.disabled&&(o=!0,n.classList.add("disabled"),n.setAttribute("aria-disabled","true")),(i.submenu||i.has_submenu)&&(n.classList.add("has_submenu"),n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false")),i.className&&(n.className+=` ${i.className}`)),n.value=i,n.setAttribute("role","menuitem"),typeof i=="function"?(n.dataset.value=String(t),n.onclick_callback=i):n.dataset.value=String(i)}this.root.append(n),o||n.addEventListener("click",d),!o&&s.autoopen&&n.addEventListener("pointerenter",a);const r=()=>{const u=this.root.querySelectorAll("div.litemenu-entry.has_submenu");if(u)for(const p of u)p.setAttribute("aria-expanded","false");n.setAttribute("aria-expanded","true")};function a(u){const p=this.value;!p||!p.has_submenu||(d.call(this,u),r())}const l=this;function d(u){var g;const p=this.value;let f=!0;if((g=l.current_submenu)==null||g.close(u),(p!=null&&p.has_submenu||p!=null&&p.submenu)&&r(),s.callback&&s.callback.call(this,p,s,u,l,s.node)===!0&&(f=!1),typeof p=="object"&&(p.callback&&!s.ignore_item_callbacks&&p.disabled!==!0&&p.callback.call(this,p,s,u,l,s.extra)===!0&&(f=!1),p.submenu)){if(!p.submenu.options)throw"ContextMenu submenu needs options";new l.constructor(p.submenu.options,{callback:p.submenu.callback,event:u,parentMenu:l,ignore_item_callbacks:p.submenu.ignore_item_callbacks,title:p.submenu.title,extra:p.submenu.extra,autoopen:s.autoopen}),f=!1}f&&!l.lock&&l.close()}return n}close(t,i){var s;this.controller.abort(),this.root.remove(),this.parentMenu&&!i&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=void 0,t===void 0?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,`${LiteGraph.pointerevents_method}leave`,t)),(s=this.current_submenu)==null||s.close(t,!0)}static trigger(t,i,s){const n=document.createEvent("CustomEvent");return n.initCustomEvent(i,!0,!0,s),t.dispatchEvent&&t.dispatchEvent(n),n}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(t,i){const s=t.clientX,n=t.clientY,o=i.getBoundingClientRect();return o?n>o.top&&n<o.top+o.height&&s>o.left&&s<o.left+o.width:!1}}class CurveEditor{constructor(t){h(this,"points");h(this,"selected");h(this,"nearest");h(this,"size");h(this,"must_update");h(this,"margin");h(this,"_nearest");this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}static sampleCurve(t,i){if(i){for(let s=0;s<i.length-1;++s){const n=i[s],o=i[s+1];if(o[0]<t)continue;const r=o[0]-n[0];if(Math.abs(r)<1e-5)return n[1];const a=(t-n[0])/r;return n[1]*(1-a)+o[1]*a}return 0}}draw(t,i,s,n,o,r=!1){const a=this.points;if(!a)return;this.size=i;const l=i[0]-this.margin*2,d=i[1]-this.margin*2;o=o||"#666",t.save(),t.translate(this.margin,this.margin),n&&(t.fillStyle="#111",t.fillRect(0,0,l,d),t.fillStyle="#222",t.fillRect(l*.5,0,1,d),t.strokeStyle="#333",t.strokeRect(0,0,l,d)),t.strokeStyle=o,r&&(t.globalAlpha=.5),t.beginPath();for(const u of a)t.lineTo(u[0]*l,(1-u[1])*d);if(t.stroke(),t.globalAlpha=1,!r)for(const[u,p]of a.entries())t.fillStyle=this.selected==u?"#FFF":this.nearest==u?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*l,(1-p[1])*d,2,0,Math.PI*2),t.fill();t.restore()}onMouseDown(t,i){const s=this.points;if(!s||t[1]<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const n=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=t[0]-this.margin,a=t[1]-this.margin,l=[r,a],d=30/i.ds.scale;if(this.selected=this.getCloserPoint(l,d),this.selected==-1){const u=[r/n,1-a/o];s.push(u),s.sort(function(p,f){return p[0]-f[0]}),this.selected=s.indexOf(u),this.must_update=!0}if(this.selected!=-1)return!0}onMouseMove(t,i){const s=this.points;if(!s)return;const n=this.selected;if(n<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const o=(t[0]-this.margin)/(this.size[0]-this.margin*2),r=(t[1]-this.margin)/(this.size[1]-this.margin*2),a=[t[0]-this.margin,t[1]-this.margin],l=30/i.ds.scale;this._nearest=this.getCloserPoint(a,l);const d=s[n];if(d){const u=n==0||n==s.length-1;if(!u&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)){s.splice(n,1),this.selected=-1;return}u?d[0]=n==0?0:1:d[0]=clamp(o,0,1),d[1]=1-clamp(r,0,1),s.sort(function(p,f){return p[0]-f[0]}),this.selected=s.indexOf(d),this.must_update=!0}}onMouseUp(){return this.selected=-1,!1}getCloserPoint(t,i){const s=this.points;if(!s)return-1;if(i=i||30,this.size==null)throw new Error("CurveEditor.size was null or undefined.");const n=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=s.length,a=[0,0];let l=1e6,d=-1;for(let u=0;u<r;++u){const p=s[u];a[0]=p[0]*n,a[1]=(1-p[1])*o;const f=distance(t,a);f>l||f>i||(d=u,l=f)}return d}}class LiteGraphGlobal{constructor(){h(this,"SlotShape",SlotShape);h(this,"SlotDirection",SlotDirection);h(this,"SlotType",SlotType);h(this,"LabelPosition",LabelPosition);h(this,"VERSION",.4);h(this,"CANVAS_GRID_SIZE",10);h(this,"NODE_TITLE_HEIGHT",30);h(this,"NODE_TITLE_TEXT_Y",20);h(this,"NODE_SLOT_HEIGHT",20);h(this,"NODE_WIDGET_HEIGHT",20);h(this,"NODE_WIDTH",140);h(this,"NODE_MIN_WIDTH",50);h(this,"NODE_COLLAPSED_RADIUS",10);h(this,"NODE_COLLAPSED_WIDTH",80);h(this,"NODE_TITLE_COLOR","#999");h(this,"NODE_SELECTED_TITLE_COLOR","#FFF");h(this,"NODE_TEXT_SIZE",14);h(this,"NODE_TEXT_COLOR","#AAA");h(this,"NODE_TEXT_HIGHLIGHT_COLOR","#EEE");h(this,"NODE_SUBTEXT_SIZE",12);h(this,"NODE_DEFAULT_COLOR","#333");h(this,"NODE_DEFAULT_BGCOLOR","#353535");h(this,"NODE_DEFAULT_BOXCOLOR","#666");h(this,"NODE_DEFAULT_SHAPE",RenderShape.ROUND);h(this,"NODE_BOX_OUTLINE_COLOR","#FFF");h(this,"NODE_ERROR_COLOUR","#E00");h(this,"NODE_FONT","Arial");h(this,"DEFAULT_FONT","Arial");h(this,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)");h(this,"DEFAULT_GROUP_FONT",24);h(this,"DEFAULT_GROUP_FONT_SIZE");h(this,"GROUP_FONT","Arial");h(this,"WIDGET_BGCOLOR","#222");h(this,"WIDGET_OUTLINE_COLOR","#666");h(this,"WIDGET_ADVANCED_OUTLINE_COLOR","rgba(56, 139, 253, 0.8)");h(this,"WIDGET_TEXT_COLOR","#DDD");h(this,"WIDGET_SECONDARY_TEXT_COLOR","#999");h(this,"WIDGET_DISABLED_TEXT_COLOR","#666");h(this,"LINK_COLOR","#9A9");h(this,"EVENT_LINK_COLOR","#A86");h(this,"CONNECTING_LINK_COLOR","#AFA");h(this,"MAX_NUMBER_OF_NODES",1e4);h(this,"DEFAULT_POSITION",[100,100]);h(this,"VALID_SHAPES",["default","box","round","card"]);h(this,"ROUND_RADIUS",8);h(this,"BOX_SHAPE",RenderShape.BOX);h(this,"ROUND_SHAPE",RenderShape.ROUND);h(this,"CIRCLE_SHAPE",RenderShape.CIRCLE);h(this,"CARD_SHAPE",RenderShape.CARD);h(this,"ARROW_SHAPE",RenderShape.ARROW);h(this,"GRID_SHAPE",RenderShape.GRID);h(this,"INPUT",NodeSlotType.INPUT);h(this,"OUTPUT",NodeSlotType.OUTPUT);h(this,"EVENT",-1);h(this,"ACTION",-1);h(this,"NODE_MODES",["Always","On Event","Never","On Trigger"]);h(this,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]);h(this,"ALWAYS",LGraphEventMode.ALWAYS);h(this,"ON_EVENT",LGraphEventMode.ON_EVENT);h(this,"NEVER",LGraphEventMode.NEVER);h(this,"ON_TRIGGER",LGraphEventMode.ON_TRIGGER);h(this,"UP",LinkDirection.UP);h(this,"DOWN",LinkDirection.DOWN);h(this,"LEFT",LinkDirection.LEFT);h(this,"RIGHT",LinkDirection.RIGHT);h(this,"CENTER",LinkDirection.CENTER);h(this,"LINK_RENDER_MODES",["Straight","Linear","Spline"]);h(this,"HIDDEN_LINK",LinkRenderType.HIDDEN_LINK);h(this,"STRAIGHT_LINK",LinkRenderType.STRAIGHT_LINK);h(this,"LINEAR_LINK",LinkRenderType.LINEAR_LINK);h(this,"SPLINE_LINK",LinkRenderType.SPLINE_LINK);h(this,"NORMAL_TITLE",TitleMode.NORMAL_TITLE);h(this,"NO_TITLE",TitleMode.NO_TITLE);h(this,"TRANSPARENT_TITLE",TitleMode.TRANSPARENT_TITLE);h(this,"AUTOHIDE_TITLE",TitleMode.AUTOHIDE_TITLE);h(this,"VERTICAL_LAYOUT","vertical");h(this,"proxy",null);h(this,"node_images_path","");h(this,"debug",!1);h(this,"catch_exceptions",!0);h(this,"throw_errors",!0);h(this,"allow_scripts",!1);h(this,"registered_node_types",{});h(this,"node_types_by_file_extension",{});h(this,"Nodes",{});h(this,"Globals",{});h(this,"searchbox_extras",{});h(this,"node_box_coloured_when_on",!1);h(this,"node_box_coloured_by_mode",!1);h(this,"dialog_close_on_mouse_leave",!1);h(this,"dialog_close_on_mouse_leave_delay",500);h(this,"shift_click_do_break_link_from",!1);h(this,"click_do_break_link_to",!1);h(this,"ctrl_alt_click_do_break_link",!0);h(this,"snaps_for_comfy",!0);h(this,"snap_highlights_node",!0);h(this,"alwaysSnapToGrid");h(this,"snapToGrid");h(this,"search_hide_on_mouse_leave",!0);h(this,"search_filter_enabled",!1);h(this,"search_show_all_on_open",!0);h(this,"auto_load_slot_types",!1);h(this,"registered_slot_in_types",{});h(this,"registered_slot_out_types",{});h(this,"slot_types_in",[]);h(this,"slot_types_out",[]);h(this,"slot_types_default_in",{});h(this,"slot_types_default_out",{});h(this,"alt_drag_do_clone_nodes",!1);h(this,"do_add_triggers_slots",!1);h(this,"allow_multi_output_for_events",!0);h(this,"middle_click_slot_add_default_node",!1);h(this,"release_link_on_empty_shows_menu",!1);h(this,"pointerevents_method","pointer");h(this,"ctrl_shift_v_paste_connect_unselected_outputs",!0);h(this,"use_uuids",!1);h(this,"highlight_selected_group",!0);h(this,"context_menu_scaling",!1);h(this,"alwaysRepeatWarnings",!1);h(this,"onDeprecationWarning",[console.warn]);h(this,"macTrackpadGestures",!1);h(this,"macGesturesRequireMac",!0);h(this,"canvasNavigationMode","legacy");h(this,"truncateWidgetTextEvenly",!1);h(this,"truncateWidgetValuesFirst",!1);h(this,"saveViewportWithGraph",!0);h(this,"LGraph",LGraph);h(this,"LLink",LLink);h(this,"LGraphNode",LGraphNode);h(this,"LGraphGroup",LGraphGroup);h(this,"DragAndScale",DragAndScale);h(this,"LGraphCanvas",LGraphCanvas);h(this,"ContextMenu",ContextMenu);h(this,"CurveEditor",CurveEditor);h(this,"Reroute",Reroute);h(this,"Classes",{get SubgraphSlot(){return SubgraphSlot},get SubgraphIONodeBase(){return SubgraphIONodeBase},get Rectangle(){return Rectangle},get InputIndicators(){return InputIndicators}});h(this,"uuidv4",createUuidv4);h(this,"distance",distance);h(this,"isInsideRectangle",isInsideRectangle);h(this,"overlapBounding",overlapBounding);Object.defineProperty(this,"Classes",{writable:!1})}registerNodeType(t,i){var r,a,l;if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,this.debug&&console.log("Node registered:",t);const s=i.name,n=t.lastIndexOf("/");i.category=t.substring(0,n),i.title||(i.title=s);for(const d in LGraphNode.prototype)(r=i.prototype)[d]||(r[d]=LGraphNode.prototype[d]);const o=this.registered_node_types[t];o&&this.debug&&console.log("replacing node type:",t),this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[s]=i),(a=this.onNodeTypeRegistered)==null||a.call(this,t,i),o&&((l=this.onNodeTypeReplaced)==null||l.call(this,t,i,o)),i.prototype.onPropertyChange&&console.warn(`LiteGraph node class ${t} has onPropertyChange method, it must be called onPropertyChanged with d at the end`),this.auto_load_slot_types&&new i(i.title||"tmpnode")}unregisterNodeType(t){const i=typeof t=="string"?this.registered_node_types[t]:t;if(!i)throw`node type not found: ${String(t)}`;delete this.registered_node_types[String(i.type)];const s=i.constructor.name;s&&delete this.Nodes[s]}registerNodeAndSlotType(t,i,s){s||(s=!1);const o=(typeof t=="string"&&this.registered_node_types[t]!=="anonymous"?this.registered_node_types[t]:t).constructor.type;let r=[];typeof i=="string"?r=i.split(","):i==this.EVENT||i==this.ACTION?r=["_event_"]:r=["*"];for(let a of r){a===""&&(a="*");const l=s?this.registered_slot_out_types:this.registered_slot_in_types;l[a]??(l[a]={nodes:[]});const{nodes:d}=l[a];d.includes(o)||d.push(o);const u=s?this.slot_types_out:this.slot_types_in,p=a.toLowerCase();u.includes(p)||(u.push(p),u.sort())}}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}createNode(t,i,s){var r;const n=this.registered_node_types[t];if(!n)return this.debug&&console.log(`GraphNode type "${t}" not registered.`),null;i=i||n.title||t;let o=null;if(this.catch_exceptions)try{o=new n(i)}catch(a){return console.error(a),null}else o=new n(i);if(o.type=t,!o.title&&i&&(o.title=i),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=[this.DEFAULT_POSITION[0],this.DEFAULT_POSITION[1]]),o.mode||(o.mode=LGraphEventMode.ALWAYS),s)for(const a in s)o[a]=s[a];return(r=o.onNodeCreated)==null||r.call(o),o}getNodeType(t){return this.registered_node_types[t]}getNodeTypesInCategory(t,i){const s=[];for(const n in this.registered_node_types){const o=this.registered_node_types[n];o.filter==i&&(t==""?o.category==null&&s.push(o):o.category==t&&s.push(o))}return s}getNodeTypesCategories(t){const i={"":1};for(const n in this.registered_node_types){const o=this.registered_node_types[n];if(o.category&&!o.skip_list){if(o.filter!=t)continue;i[o.category]=1}}const s=[];for(const n in i)s.push(n);return s}reloadNodes(t){const i=document.getElementsByTagName("script"),s=[];for(const o of i)s.push(o);const n=document.getElementsByTagName("head")[0];t=document.location.href+t;for(const o of s){const r=o.src;if(!(!r||r.substr(0,t.length)!=t))try{this.debug&&console.log("Reloading:",r);const a=document.createElement("script");a.type="text/javascript",a.src=r,n.append(a),o.remove()}catch(a){if(this.throw_errors)throw a;this.debug&&console.log("Error while reloading",r)}}this.debug&&console.log("Nodes reloaded")}cloneObject(t,i){if(t==null)return null;const s=JSON.parse(JSON.stringify(t));if(!i)return s;for(const n in s)i[n]=s[n];return i}isValidConnection(t,i){if((t==""||t==="*")&&(t=0),(i==""||i==="*")&&(i=0),!t||!i||t==i||t==this.EVENT&&i==this.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),!t.includes(",")&&!i.includes(","))return t==i;const s=t.split(","),n=i.split(",");for(const o of s)for(const r of n)if(this.isValidConnection(o,r))return!0;return!1}getParameterNames(t){return String(t).replaceAll(/\/\/.*$/gm,"").replaceAll(/\s+/g,"").replaceAll(/\/\*[^*/]*\*\//g,"").split("){",1)[0].replace(/^[^(]*\(/,"").replaceAll(/=[^,]+/g,"").split(",").filter(Boolean)}pointerListenerAdd(t,i,s,n=!1){if(!t||!t.addEventListener||!i||typeof s!="function")return;let o=this.pointerevents_method,r=i;if(o=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log(`Converting pointer[${r}] : down move up cancel enter TO touchstart touchmove touchend, etc ..`),r){case"down":{o="touch",r="start";break}case"move":{o="touch";break}case"up":{o="touch",r="end";break}case"cancel":{o="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn(`PointerEvent not available in this browser ? The event ${r} would not be called`)}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+r,s,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(o!="mouse")return t.addEventListener(o+r,s,n);default:return t.addEventListener(r,s,n)}}pointerListenerRemove(t,i,s,n=!1){if(!(!t||!t.removeEventListener||!i||typeof s!="function"))switch(i){case"down":case"up":case"move":case"over":case"out":case"enter":(this.pointerevents_method=="pointer"||this.pointerevents_method=="mouse")&&t.removeEventListener(this.pointerevents_method+i,s,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(this.pointerevents_method=="pointer")return t.removeEventListener(this.pointerevents_method+i,s,n);default:return t.removeEventListener(i,s,n)}}getTime(){return performance.now()}colorToString(t){return`rgba(${Math.round(t[0]*255).toFixed()},${Math.round(t[1]*255).toFixed()},${Math.round(t[2]*255).toFixed()},${t.length==4?t[3].toFixed(2):"1.0"})`}growBounding(t,i,s){i<t[0]?t[0]=i:i>t[2]&&(t[2]=i),s<t[1]?t[1]=s:s>t[3]&&(t[3]=s)}isInsideBounding(t,i){return!(t[0]<i[0][0]||t[1]<i[0][1]||t[0]>i[1][0]||t[1]>i[1][1])}hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();const i="0123456789ABCDEF",s=new Array(3);let n=0,o,r;for(let a=0;a<6;a+=2)o=i.indexOf(t.charAt(a)),r=i.indexOf(t.charAt(a+1)),s[n]=o*16+r,n++;return s}num2hex(t){const i="0123456789ABCDEF";let s="#",n,o;for(let r=0;r<3;r++)n=t[r]/16,o=t[r]%16,s+=i.charAt(n)+i.charAt(o);return s}closeAllContextMenus(t=window){const i=[...t.document.querySelectorAll(".litecontextmenu")];if(i.length)for(const s of i)"close"in s&&typeof s.close=="function"?s.close():s.remove()}extendClass(t,i){for(const s in i)t.hasOwnProperty(s)||(t[s]=i[s]);if(i.prototype)for(const s in i.prototype)i.prototype.hasOwnProperty(s)&&(t.prototype.hasOwnProperty(s)||(i.prototype.__lookupGetter__(s)?t.prototype.__defineGetter__(s,i.prototype.__lookupGetter__(s)):t.prototype[s]=i.prototype[s],i.prototype.__lookupSetter__(s)&&t.prototype.__defineSetter__(s,i.prototype.__lookupSetter__(s))))}}Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("Symbol.asyncDispose"));function loadPolyfills(){typeof window<"u"&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(c,t,i,s,n,o){let r=0,a=0,l=0,d=0;if(n===0){this.rect(c,t,i,s);return}if(o===void 0&&(o=n),Array.isArray(n))if(n.length==1)r=a=l=d=n[0];else if(n.length==2)r=d=n[0],a=l=n[1];else if(n.length==4)r=n[0],a=n[1],l=n[2],d=n[3];else return;else{r=n||0,a=n||0;const u=!Array.isArray(o)&&o?o:0;l=u,d=u}this.moveTo(c+r,t),this.lineTo(c+i-a,t),this.quadraticCurveTo(c+i,t,c+i,t+a),this.lineTo(c+i,t+s-d),this.quadraticCurveTo(c+i,t+s,c+i-d,t+s),this.lineTo(c+d,t+s),this.quadraticCurveTo(c,t+s,c,t+s-l),this.lineTo(c,t+l),this.quadraticCurveTo(c,t,c+r,t)}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(c){window.setTimeout(c,1e3/60)})}class InvalidLinkError extends Error{constructor(t="Attempted to access a link that was invalid.",i){super(t,{cause:i}),this.name="InvalidLinkError"}}class RecursionError extends Error{constructor(t){super(t),this.name="RecursionError"}}class SlotIndexError extends Error{constructor(t="Attempted to access a slot that was out of bounds.",i){super(t,{cause:i}),this.name="SlotIndexError"}}class ExecutableNodeDTO{constructor(t,i,s,n){P(this,He);h(this,"graph");h(this,"inputs");P(this,Te);if(this.node=t,this.subgraphNodePath=i,this.nodesByExecutionId=s,this.subgraphNode=n,!t.graph)throw new NullGraphError;z(this,Te,[...this.subgraphNodePath,this.node.id].join(":")),this.graph=t.graph,this.inputs=this.node.inputs.map(o=>({linkId:o.link,name:o.name,type:o.type})),this.node.applyToGraph&&(this.applyToGraph=(...o)=>{var r,a;return(a=(r=this.node).applyToGraph)==null?void 0:a.call(r,...o)})}get id(){return S(this,Te)}get type(){return this.node.type}get title(){return this.node.title}get mode(){return this.node.mode}get comfyClass(){return this.node.comfyClass}get isVirtualNode(){return this.node.isVirtualNode}get widgets(){return this.node.widgets}get subgraphId(){var t;return(t=this.subgraphNode)==null?void 0:t.subgraph.id}getInnerNodes(){return this.node.isSubgraphNode()?this.node.getInnerNodes(this.nodesByExecutionId,this.subgraphNodePath):[this]}resolveInput(t,i=new Set){var u;const s=`${(u=this.subgraphNode)==null?void 0:u.subgraph.id}:${this.node.id}[I]${t}`;if(i.has(s)){const p=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,f=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving input ${t} of node ${p}${f}. This creates an infinite loop in link resolution. UniqueID: [${s}]`)}i.add(s);const n=this.inputs.at(t);if(!n)throw new SlotIndexError(`No input found for flattened id [${this.id}] slot [${t}]`);if(n.linkId==null)return;const o=this.graph.getLink(n.linkId);if(!o)throw new InvalidLinkError(`No link found in parent graph for id [${this.id}] slot [${t}] ${n.name}`);const{subgraphNode:r}=this;if(r&&o.originIsIoNode){const p=r.inputs.at(o.origin_slot);if(!p)throw new SlotIndexError(`No input found for slot [${o.origin_slot}] ${n.name}`);const f=p.link;if(f==null){const y=r.getWidgetFromSlot(p);return y?{node:this,origin_id:this.id,origin_slot:-1,widgetInfo:{value:y.value}}:void 0}const g=r.graph.getLink(f);if(!g)throw new InvalidLinkError(`No outer link found for slot [${o.origin_slot}] ${n.name}`);const m=this.subgraphNodePath.join(":"),_=this.nodesByExecutionId.get(m);if(!_)throw new Error(`No subgraph node DTO found for id [${m}]`);return _.resolveInput(g.target_slot,i)}const a=this.graph.getNodeById(o.origin_id);if(!a)throw new InvalidLinkError(`No input node found for id [${this.id}] slot [${t}] ${n.name}`);const l=[...this.subgraphNodePath,a.id].join(":"),d=this.nodesByExecutionId.get(l);if(!d)throw new Error(`No output node DTO found for id [${l}]`);return d.resolveOutput(o.origin_slot,n.type,i)}resolveOutput(t,i,s){var r;const n=`${(r=this.subgraphNode)==null?void 0:r.subgraph.id}:${this.node.id}[O]${t}`;if(s.has(n)){const a=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,l=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving output ${t} of node ${a}${l}. This creates an infinite loop in link resolution. UniqueID: [${n}]`)}if(s.add(n),this.mode===LGraphEventMode.BYPASS){const{inputs:a}=this,l=Object.keys(a).map(Number),u=[t,...l].find(p=>{var f;return((f=a[p])==null?void 0:f.type)===i});if(u===void 0){console.debug(`[ExecutableNodeDTO.resolveOutput] No input types match type [${i}] for id [${this.id}] slot [${t}]`,this);return}return this.resolveInput(u,s)}const{node:o}=this;if(o.isSubgraphNode())return C(this,He,Bi).call(this,t,i,s);if(o.isVirtualNode){if(this.inputs.at(t))return this.resolveInput(t,s);const a=this.node.getInputLink(t);if(a){const l=this.graph.getNodeById(a.origin_id);if(!l)throw new InvalidLinkError(`Virtual node failed to resolve parent [${this.id}] slot [${t}]`);const d=[...this.subgraphNodePath,l.id].join(":"),u=this.nodesByExecutionId.get(d);if(!u)throw new Error(`No output node DTO found for id [${l.id}]`);return u.resolveOutput(a.origin_slot,i,s)}return}return{node:this,origin_id:this.id,origin_slot:t}}}Te=new WeakMap,He=new WeakSet,Bi=function(t,i,s){const{node:n}=this,o=n.outputs.at(t);if(!o)throw new SlotIndexError(`No output found for flattened id [${this.id}] slot [${t}]`);if(!n.isSubgraphNode())throw new TypeError(`Node is not a subgraph node: ${n.id}`);const r=n.resolveSubgraphOutputLink(t);if(!r)return;const a=r.outputNode;if(!a)throw new Error(`No output node found for id [${this.id}] slot [${t}] ${o.name}`);const l=[...this.subgraphNodePath,n.id,a.id].join(":"),d=this.nodesByExecutionId.get(l);if(!d)throw new Error(`No inner node DTO found for id [${l}]`);return d.resolveOutput(r.link.origin_slot,i,s)};class SubgraphNode extends LGraphNode{constructor(i,s,n){super(s.name,s.id);P(this,Dt);h(this,"type");h(this,"isVirtualNode",!0);h(this,"widgets",[]);P(this,Ee,new AbortController);this.graph=i,this.subgraph=s;const o=this.subgraph.events,{signal:r}=S(this,Ee);o.addEventListener("input-added",a=>{const l=a.detail.input,{name:d,type:u}=l;if(this.inputs.some(f=>f.name==d))return;const p=this.addInput(d,u);C(this,Dt,li).call(this,l,p)},{signal:r}),o.addEventListener("removing-input",a=>{const l=a.detail.input._widget;l&&this.ensureWidgetRemoved(l),this.removeInput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("output-added",a=>{const{name:l,type:d}=a.detail.output;this.addOutput(l,d)},{signal:r}),o.addEventListener("removing-output",a=>{this.removeOutput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("renaming-input",a=>{const{index:l,newName:d}=a.detail,u=this.inputs.at(l);if(!u)throw new Error("Subgraph input not found");u.label=d},{signal:r}),o.addEventListener("renaming-output",a=>{const{index:l,newName:d}=a.detail,u=this.outputs.at(l);if(!u)throw new Error("Subgraph output not found");u.label=d},{signal:r}),this.type=s.id,this.configure(n),this.addTitleButton({name:"enter_subgraph",text:"î¤»",yOffset:0,xOffset:-10,fontSize:16})}get rootGraph(){return this.graph.rootGraph}get displayType(){return"Subgraph node"}isSubgraphNode(){return!0}onTitleButtonClick(i,s){i.name==="enter_subgraph"?s.openSubgraph(this.subgraph):super.onTitleButtonClick(i,s)}configure(i){var s;for(const n of this.inputs)(s=n._listenerController)==null||s.abort();this.inputs.length=0,this.inputs.push(...this.subgraph.inputNode.slots.map(n=>new NodeInputSlot({name:n.name,localized_name:n.localized_name,label:n.label,type:n.type,link:null},this))),this.outputs.length=0,this.outputs.push(...this.subgraph.outputNode.slots.map(n=>new NodeOutputSlot({name:n.name,localized_name:n.localized_name,label:n.label,type:n.type,links:null},this))),super.configure(i)}_internalConfigureAfterSlots(){this.widgets.length=0;for(const i of this.inputs){const s=this.subgraph.inputNode.slots.find(n=>n.name===i.name);if(!s)throw new Error(`[SubgraphNode.configure] No subgraph input found for input ${i.name}`);C(this,Dt,li).call(this,s,i);for(const n of s.linkIds){const o=this.subgraph.getLink(n);if(!o){console.warn(`[SubgraphNode.configure] No link found for link ID ${n}`,this);continue}const r=o.resolve(this.subgraph);if(!r.input||!r.inputNode){console.warn("Invalid resolved link",r,this);continue}const a=r.inputNode.getWidgetFromSlot(r.input);if(a){C(this,Dt,hi).call(this,s,i,a);break}}}}addInput(i,s,n={}){return super.addInput(i,s,n)}getInputLink(i){const s=this.subgraph.outputNode.slots[i].getLinks().at(0);if(!s)return console.warn(`SubgraphNode.getInputLink: no inner link found for slot ${i}`),null;const n=LLink.create(s);return n.origin_id=`${this.id}:${s.origin_id}`,n.origin_slot=s.origin_slot,n}resolveSubgraphInputLinks(i){const s=this.subgraph.inputNode.slots[i],n=s.getLinks();return n.length===0?(console.debug(`[SubgraphNode.resolveSubgraphInputLinks] No inner links found for input slot [${i}] ${s.name}`,this),[]):n.map(o=>o.resolve(this.subgraph))}resolveSubgraphOutputLink(i){const s=this.subgraph.outputNode.slots[i],n=s.getLinks().at(0);if(n)return n.resolve(this.subgraph);console.debug(`[SubgraphNode.resolveSubgraphOutputLink] No inner link found for output slot [${i}] ${s.name}`,this)}getInnerNodes(i,s=[],n=[],o=new Set){if(o.has(this)){const d=`${this.id}${this.title?` (${this.title})`:""}`,u=`'${this.subgraph.name||"Unnamed Subgraph"}'`,p=s.length;throw new RecursionError(`Circular reference detected at depth ${p} in node ${d} of subgraph ${u}. This creates an infinite loop in the subgraph hierarchy.`)}o.add(this);const r=[...s,this.id],a=this.graph.rootGraph.resolveSubgraphIdPath(s).at(-1),l=new ExecutableNodeDTO(this,s,i,a);i.set(l.id,l);for(const d of this.subgraph.nodes)if("getInnerNodes"in d)d.getInnerNodes(i,r,n,new Set(o));else{const u=new ExecutableNodeDTO(d,r,i,this);i.set(u.id,u),n.push(u)}return n}removeWidgetByName(i){const s=this.widgets.find(n=>n.name===i);s&&this.subgraph.events.dispatch("widget-demoted",{widget:s,subgraphNode:this}),super.removeWidgetByName(i)}ensureWidgetRemoved(i){this.widgets.includes(i)&&this.subgraph.events.dispatch("widget-demoted",{widget:i,subgraphNode:this}),super.ensureWidgetRemoved(i)}onRemoved(){var i;S(this,Ee).abort();for(const s of this.widgets)this.subgraph.events.dispatch("widget-demoted",{widget:s,subgraphNode:this});for(const s of this.inputs)(i=s._listenerController)==null||i.abort()}}Ee=new WeakMap,Dt=new WeakSet,li=function(i,s){var o;(o=s._listenerController)==null||o.abort(),s._listenerController=new AbortController;const{signal:n}=s._listenerController;i.events.addEventListener("input-connected",()=>{if(s._widget)return;const r=i._widget;r&&C(this,Dt,hi).call(this,i,s,r)},{signal:n}),i.events.addEventListener("input-disconnected",()=>{i.getConnectedWidgets().length>0||(this.removeWidgetByName(s.name),delete s.pos,delete s.widget,s._widget=void 0)},{signal:n})},hi=function(i,s,n){const o=toConcreteWidget(n,this).createCopyForNode(this);Object.assign(o,{get name(){return i.name},set name(r){console.warn("Promoted widget: setting name is not allowed",this,r)},get localized_name(){return i.localized_name},set localized_name(r){console.warn("Promoted widget: setting localized_name is not allowed",this,r)},get label(){return i.label},set label(r){console.warn("Promoted widget: setting label is not allowed",this,r)},get tooltip(){return n.tooltip},set tooltip(r){console.warn("Promoted widget: setting tooltip is not allowed",this,r)}}),this.widgets.push(o),this.subgraph.events.dispatch("widget-promoted",{widget:o,subgraphNode:this}),s.widget={name:i.name},s._widget=o};const LiteGraph=new LiteGraphGlobal;loadPolyfills();const litegraphCss=".lgraphcanvas{user-select:none;-moz-user-select:none;-webkit-user-select:none;outline:none;font-family:Tahoma,sans-serif}.lgraphcanvas *{box-sizing:border-box}.litegraph.litecontextmenu{font-family:Tahoma,sans-serif;position:fixed;top:100px;left:100px;min-width:100px;color:#aaf;padding:0;box-shadow:0 0 10px #000!important;background-color:#2e2e2e!important;z-index:10;max-height:-webkit-fill-available;overflow-y:auto}@supports not (max-height: -webkit-fill-available){.litegraph.litecontextmenu{max-height:80vh;overflow-y:scroll}}.litegraph.litecontextmenu.dark{background-color:#000!important}.litegraph.litecontextmenu .litemenu-title img{margin-top:2px;margin-left:2px;margin-right:4px}.litegraph.litecontextmenu .litemenu-entry{margin:2px;padding:2px}.litegraph.litecontextmenu .litemenu-entry.submenu{background-color:#2e2e2e!important}.litegraph.litecontextmenu.dark .litemenu-entry.submenu{background-color:#000!important}.litegraph .litemenubar ul{font-family:Tahoma,sans-serif;margin:0;padding:0}.litegraph .litemenubar li{font-size:14px;color:#999;display:inline-block;min-width:50px;padding-left:10px;padding-right:10px;user-select:none;-moz-user-select:none;-webkit-user-select:none;cursor:pointer}.litegraph .litemenubar li:hover{background-color:#777;color:#eee}.litegraph .litegraph .litemenubar-panel{position:absolute;top:5px;left:5px;min-width:100px;background-color:#444;box-shadow:0 0 3px #000;padding:4px;border-bottom:2px solid #aaf;z-index:10}.litegraph .litemenu-entry,.litemenu-title{font-size:12px;color:#aaa;margin:2px;padding:0 0 0 2px;-moz-user-select:none;-webkit-user-select:none;user-select:none;cursor:pointer}.litegraph .litemenu-entry .icon{display:inline-block;width:12px;height:12px;margin:2px;vertical-align:top}.litegraph .litemenu-entry.checked .icon{background-color:#aaf}.litegraph .litemenu-entry .more{float:right;padding-right:5px}.litegraph .litemenu-entry.disabled{opacity:.5;cursor:default}.litegraph .litemenu-entry.separator{display:block;border-top:1px solid #333;border-bottom:1px solid #666;width:100%;height:0px;margin:3px 0 2px;background-color:transparent;padding:0!important;cursor:default!important}.litegraph .litemenu-entry.has_submenu{border-right:2px solid cyan}.litegraph .litemenu-title{color:#dde;background-color:#111;margin:0;padding:2px;cursor:default}.litegraph .litemenu-entry:hover:not(.disabled):not(.separator){background-color:#444!important;color:#eee;transition:all .2s}.litegraph .litemenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.litegraph .litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.litegraph.litesearchbox{font-family:Tahoma,sans-serif;position:absolute;background-color:#00000080;padding-top:4px}.litegraph.litesearchbox input,.litegraph.litesearchbox select{margin-top:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;margin-right:5px;max-width:300px}.litegraph.litesearchbox .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.litegraph.litesearchbox .helper{overflow:auto;max-height:200px;margin-top:2px}.litegraph.lite-search-item{font-family:Tahoma,sans-serif;background-color:#00000080;color:#fff;padding-top:2px}.litegraph.lite-search-item.not_in_filter{color:#b99;font-style:italic}.litegraph.lite-search-item.generic_type{color:#999;font-style:italic}.litegraph.lite-search-item:hover,.litegraph.lite-search-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph.lite-search-item-type{display:inline-block;background:#0003;margin-left:5px;font-size:14px;padding:2px 5px;position:relative;top:-2px;opacity:.8;border-radius:4px}.litegraph .dialog{position:absolute;top:50%;left:50%;margin-top:-150px;margin-left:-200px;background-color:#2a2a2a;min-width:400px;min-height:200px;box-shadow:0 0 4px #111;border-radius:6px}.litegraph .dialog.settings{left:10px;top:10px;height:calc(100% - 20px);margin:auto;max-width:50%}.litegraph .dialog.centered{top:50px;left:50%;position:absolute;transform:translate(-50%);min-width:600px;min-height:300px;height:calc(100% - 100px);margin:auto}.litegraph .dialog .close{float:right;margin:4px 10px 4px 4px;cursor:pointer;font-size:1.4em}.litegraph .dialog .close:hover{color:#fff}.litegraph .dialog .dialog-header{color:#aaa;border-bottom:1px solid #161616}.litegraph .dialog .dialog-header{height:40px}.litegraph .dialog .dialog-footer{height:50px;padding:10px;margin:0;border-top:1px solid #1a1a1a}.litegraph .dialog .dialog-header .dialog-title{font:20px Arial;margin:4px;padding:4px 10px;display:inline-block}.litegraph .dialog .dialog-content,.litegraph .dialog .dialog-alt-content{height:calc(100% - 90px);width:100%;min-height:100px;display:inline-block;color:#aaa;overflow:auto}.litegraph .dialog .dialog-content h3{margin:10px}.litegraph .dialog .dialog-content .connections{flex-direction:row}.litegraph .dialog .dialog-content .connections .connections_side{width:calc(50% - 5px);min-height:100px;background-color:#000;display:flex}.litegraph .dialog .node_type{font-size:1.2em;display:block;margin:10px}.litegraph .dialog .node_desc{opacity:.5;display:block;margin:10px}.litegraph .dialog .separator{display:block;width:calc(100% - 4px);height:1px;border-top:1px solid #000;border-bottom:1px solid #333;margin:10px 2px;padding:0}.litegraph .dialog .property{margin-bottom:2px;padding:4px}.litegraph .dialog .property:hover{background:#545454}.litegraph .dialog .property_name{color:#737373;display:inline-block;text-align:left;vertical-align:top;width:160px;padding-left:4px;overflow:hidden;margin-right:6px}.litegraph .dialog .property:hover .property_name{color:#fff}.litegraph .dialog .property_value{display:inline-block;text-align:right;color:#aaa;background-color:#1a1a1a;max-width:calc(100% - 162px);min-width:200px;max-height:300px;min-height:20px;padding:4px 12px 4px 4px;overflow:hidden;cursor:pointer;border-radius:3px}.litegraph .dialog .property_value:hover{color:#fff}.litegraph .dialog .property.boolean .property_value{padding-right:30px;color:#a88}.litegraph .dialog .property.boolean.bool-on .property_name,.litegraph .dialog .property.boolean.bool-on .property_value{color:#8a8}.litegraph .dialog .btn{border:0;border-radius:4px;padding:4px 20px;margin-left:0;background-color:#060606;color:#8e8e8e}.litegraph .dialog .btn:hover{background-color:#111;color:#fff}.litegraph .dialog .btn.delete:hover{background-color:#f33;color:#000}.litegraph .bullet_icon{margin-left:10px;border-radius:10px;width:12px;height:12px;background-color:#666;display:inline-block;margin-top:2px;margin-right:4px;transition:background-color .1s ease 0s;-moz-transition:background-color .1s ease 0s}.litegraph .bullet_icon:hover{background-color:#698;cursor:pointer}.graphcontextmenu{padding:4px;min-width:100px}.graphcontextmenu-title{color:#dde;background-color:#222;margin:0;padding:2px;cursor:default}.graphmenu-entry{box-sizing:border-box;margin:2px;padding-left:20px;user-select:none;-moz-user-select:none;-webkit-user-select:none;transition:all linear .3s}.graphmenu-entry.event,.litemenu-entry.event{border-left:8px solid orange;padding-left:12px}.graphmenu-entry.disabled{opacity:.3}.graphmenu-entry.submenu{border-right:2px solid #eee}.graphmenu-entry:hover{background-color:#555}.graphmenu-entry.separator{background-color:#111;border-bottom:1px solid #666;height:1px;width:calc(100% - 20px);-moz-width:calc(100% - 20px);-webkit-width:calc(100% - 20px)}.graphmenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.graphmenu-entry .property_value,.litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.graphdialog{position:absolute;top:10px;left:10px;min-height:2em;background-color:#333;font-size:1.2em;box-shadow:0 0 10px #000!important;z-index:10}.graphdialog.rounded{border-radius:12px;padding-right:2px}.graphdialog .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.graphdialog input,.graphdialog textarea,.graphdialog select{margin:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;outline:none}.graphdialog textarea{min-height:150px}.graphdialog button{margin-top:3px;vertical-align:top;background-color:#999;border:0}.graphdialog button.rounded,.graphdialog input.rounded{border-radius:0 12px 12px 0}.graphdialog .helper{overflow:auto;max-height:200px}.graphdialog .help-item{padding-left:10px}.graphdialog .help-item:hover,.graphdialog .help-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph .dialog{min-height:0}.litegraph .dialog .dialog-content{display:block}.litegraph .graphdialog{display:flex;align-items:center;border-radius:20px;padding:4px 10px;position:fixed}.litegraph .graphdialog .name{padding:0;min-height:0;font-size:16px;vertical-align:middle}.litegraph .graphdialog .value{font-size:16px;min-height:0;margin:0 10px;padding:2px 5px}.litegraph .graphdialog input[type=checkbox]{width:16px;height:16px}.litegraph .graphdialog button{padding:4px 18px;border-radius:20px;cursor:pointer}";let registered=!1,_datasetInfo={dataset_name:"",fields:[],label_fields:[],patches_fields:[],detection_fields:[],classification_fields:[],segmentation_fields:[],regression_fields:[],saved_views:[],tags:[],label_classes:{},brain_runs:[],evaluations:[],zoo_models:[]};function setDatasetInfo(c){_datasetInfo=c,updateNodeVisibility()}function populateNodeCombos(c){var i;if(!c.widgets)return;const t=c.type||"";for(const s of c.widgets){if(s.type!=="combo")continue;const n=s.name||"";n==="view_name"&&t.includes("Source/")?s.options.values=_datasetInfo.saved_views.length>0?_datasetInfo.saved_views:["(no saved views)"]:n==="field"&&t.includes("To Patches")?s.options.values=_datasetInfo.patches_fields.length>0?_datasetInfo.patches_fields:["(no patchable fields)"]:n==="field"&&(t.includes("Filter Labels")||t.includes("Match Labels")||t.includes("Map Labels"))?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:(n==="pred_field"||n==="label_field"||n==="predictions_field")&&t.includes("Brain/")?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:n==="model"&&t.includes("Model/")?s.options.values=_datasetInfo.zoo_models.length>0?_datasetInfo.zoo_models:["(no models available)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Detections")?s.options.values=_datasetInfo.detection_fields.length>0?_datasetInfo.detection_fields:["(no detection fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Classifications")?s.options.values=_datasetInfo.classification_fields.length>0?_datasetInfo.classification_fields:["(no classification fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Segmentations")?s.options.values=_datasetInfo.segmentation_fields.length>0?_datasetInfo.segmentation_fields:["(no segmentation fields)"]:(n==="pred_field"||n==="gt_field")&&t.includes("Evaluate Regressions")?s.options.values=_datasetInfo.regression_fields.length>0?_datasetInfo.regression_fields:["(no regression fields)"]:n==="eval_key"&&(t.includes("Manage Evaluation")||t.includes("To Evaluation Patches"))?s.options.values=_datasetInfo.evaluations.length>0?_datasetInfo.evaluations:["(no evaluations)"]:n==="brain_key"&&t.includes("Manage Brain Run")?s.options.values=_datasetInfo.brain_runs.length>0?_datasetInfo.brain_runs:["(no brain runs)"]:n==="field"&&t.includes("Filter Keypoints")?s.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:n==="field"&&(s.options.values=_datasetInfo.fields.length>0?_datasetInfo.fields:["(no fields)"])}if(t.includes("Filter Labels")||t.includes("Match Labels")){const s=((i=c.properties)==null?void 0:i.field)||"",n=_datasetInfo.label_classes[s];n&&n.length>0&&(c.properties._available_classes=n)}}function updateAllComboWidgets(c){const t=c._nodes;if(t)for(const i of t)populateNodeCombos(i)}const NODE_VISIBILITY_RULES={"FiftyComfy/Source/Load Saved View":c=>c.saved_views.length===0,"FiftyComfy/View Stages/To Patches":c=>c.patches_fields.length===0,"FiftyComfy/View Stages/Filter Labels":c=>c.label_fields.length===0,"FiftyComfy/View Stages/Match Labels":c=>c.label_fields.length===0,"FiftyComfy/View Stages/Map Labels":c=>c.label_fields.length===0,"FiftyComfy/View Stages/Filter Keypoints":c=>c.label_fields.length===0,"FiftyComfy/View Stages/Select Labels":c=>c.label_fields.length===0,"FiftyComfy/View Stages/Exclude Labels":c=>c.label_fields.length===0,"FiftyComfy/Brain/Compute Mistakenness":c=>c.label_fields.length===0,"FiftyComfy/Brain/Compute Hardness":c=>c.label_fields.length===0,"FiftyComfy/Brain/Manage Brain Run":c=>c.brain_runs.length===0,"FiftyComfy/View Stages/Sort By Similarity":c=>c.brain_runs.length===0,"FiftyComfy/Evaluation/Evaluate Detections":c=>c.detection_fields.length===0,"FiftyComfy/Evaluation/Evaluate Classifications":c=>c.classification_fields.length===0,"FiftyComfy/Evaluation/Evaluate Segmentations":c=>c.segmentation_fields.length===0,"FiftyComfy/Evaluation/Evaluate Regressions":c=>c.regression_fields.length===0,"FiftyComfy/Evaluation/Manage Evaluation":c=>c.evaluations.length===0,"FiftyComfy/Evaluation/To Evaluation Patches":c=>c.evaluations.length===0};let _hiddenNodeTypes=new Set;function updateNodeVisibility(){_hiddenNodeTypes.clear();for(const[c,t]of Object.entries(NODE_VISIBILITY_RULES)){const i=LiteGraph.registered_node_types[c];if(!i)continue;const s=t(_datasetInfo);i.skip_list=s,s&&_hiddenNodeTypes.add(c)}}function installSearchFilter(c){c.onSearchBox=function(t,i,s){const n=(i||"").toLowerCase(),o=[],r=LiteGraph.registered_node_types;for(const a in r){if(_hiddenNodeTypes.has(a))continue;const d=r[a].title||"";n&&!a.toLowerCase().includes(n)&&!d.toLowerCase().includes(n)||o.push(a)}return o.sort((a,l)=>{var p,f;const d=(((p=r[a])==null?void 0:p.title)||a).toLowerCase(),u=(((f=r[l])==null?void 0:f.title)||l).toLowerCase();return d.localeCompare(u)}),o}}function hookNodeAdded(c){const t=c.onNodeAdded;c.onNodeAdded=function(i){populateNodeCombos(i),t&&t.call(this,i)}}function registerAllNodes(){if(registered)return;registered=!0;class c extends LGraphNode{constructor(){super(),this.title="Current Dataset",this.addOutput("view","FO_VIEW"),this.properties={},this.size=[240,60],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(w){var J;if((J=this.flags)!=null&&J.collapsed)return;const tt=_datasetInfo.dataset_name;if(tt){w.font="bold 13px monospace",w.fillStyle="#FFFFFF",w.textAlign="center";const rt=this.size[0]-20;let K=tt;for(;w.measureText(K).width>rt&&K.length>4;)K=K.slice(0,-2);K!==tt&&(K+="â€¦"),w.fillText(K,this.size[0]/2,this.size[1]-12)}}}h(c,"title","Current Dataset"),h(c,"desc","Use the dataset currently loaded in the App"),LiteGraph.registerNodeType("FiftyComfy/Source/Current Dataset",c);class t extends LGraphNode{constructor(){super(),this.title="Load Saved View",this.addOutput("view","FO_VIEW"),this.addWidget("combo","view_name","",w=>{this.properties.view_name=w},{values:[]}),this.properties={view_name:""},this.size=[280,80],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(w){var J;if((J=this.flags)!=null&&J.collapsed)return;const tt=_datasetInfo.dataset_name;if(tt){w.font="11px sans-serif",w.fillStyle="rgba(255,255,255,0.45)",w.textAlign="left";const rt=this.size[0]-20,K="dataset: ";let vt=K+tt;for(;w.measureText(vt).width>rt&&vt.length>K.length+4;)vt=K+tt.slice(0,vt.length-K.length-2);vt!==K+tt&&(vt+="â€¦"),w.fillText(vt,10,this.size[1]-8)}}}h(t,"title","Load Saved View"),h(t,"desc","Load a saved view from the dataset"),LiteGraph.registerNodeType("FiftyComfy/Source/Load Saved View",t);class i extends LGraphNode{constructor(){super(),this.title="Match",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","expression","F('confidence') > 0.5",w=>{this.properties.expression=w}),this.properties={expression:"F('confidence') > 0.5"},this.size=[320,80],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(i,"title","Match"),h(i,"desc","Filter samples by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match",i);class s extends LGraphNode{constructor(){super(),this.title="Filter Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","expression","F('label') == 'car'",w=>{this.properties.expression=w}),this.addWidget("toggle","only_matches",!0,w=>{this.properties.only_matches=w}),this.properties={field:"",expression:"F('label') == 'car'",only_matches:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(w){var rt;if((rt=this.flags)!=null&&rt.collapsed)return;const tt=this.properties.field,J=tt?_datasetInfo.label_classes[tt]||[]:[];if(J.length>0){w.font="10px sans-serif",w.fillStyle="rgba(255,255,255,0.4)",w.textAlign="left";const K=J.slice(0,6).join(", ")+(J.length>6?", ...":"");w.fillText("classes: "+K,8,this.size[1]-6)}}}h(s,"title","Filter Labels"),h(s,"desc","Filter detections/classifications within a label field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Labels",s);class n extends LGraphNode{constructor(){super(),this.title="Match Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","filter","F('label') == 'car'",w=>{this.properties.filter=w}),this.addWidget("toggle","bool",!0,w=>{this.properties.bool=w}),this.properties={field:"",filter:"F('label') == 'car'",bool:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(w){var rt;if((rt=this.flags)!=null&&rt.collapsed)return;const tt=this.properties.field,J=tt?_datasetInfo.label_classes[tt]||[]:[];if(J.length>0){w.font="10px sans-serif",w.fillStyle="rgba(255,255,255,0.4)",w.textAlign="left";const K=J.slice(0,6).join(", ")+(J.length>6?", ...":"");w.fillText("classes: "+K,8,this.size[1]-6)}}}h(n,"title","Match Labels"),h(n,"desc","Match samples containing labels that satisfy a condition"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Labels",n);class o extends LGraphNode{constructor(){super(),this.title="Sort By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("toggle","reverse",!1,w=>{this.properties.reverse=w}),this.properties={field:"",reverse:!1},this.size=[280,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(o,"title","Sort By"),h(o,"desc","Sort samples by a field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By",o);class r extends LGraphNode{constructor(){super(),this.title="Sort By Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","query","",w=>{this.properties.query=w}),this.addWidget("text","brain_key","similarity",w=>{this.properties.brain_key=w}),this.addWidget("number","k",25,w=>{this.properties.k=w},{min:1,max:1e5,step:1,precision:0}),this.addWidget("toggle","reverse",!1,w=>{this.properties.reverse=w}),this.properties={query:"",brain_key:"similarity",k:25,reverse:!1},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(r,"title","Sort By Similarity"),h(r,"desc","Sort samples by similarity to a reference (requires similarity index)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By Similarity",r);class a extends LGraphNode{constructor(){super(),this.title="Limit",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,w=>{this.properties.count=w},{min:1,max:1e5,step:10,precision:0}),this.properties={count:100},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(a,"title","Limit"),h(a,"desc","Limit number of samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Limit",a);class l extends LGraphNode{constructor(){super(),this.title="Match Tags",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",w=>{this.properties.tags=w}),this.properties={tags:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(l,"title","Match Tags"),h(l,"desc","Filter samples by tags (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Tags",l);class d extends LGraphNode{constructor(){super(),this.title="Take",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,w=>{this.properties.count=w},{min:1,max:1e5,step:10,precision:0}),this.addWidget("number","seed",0,w=>{this.properties.seed=w||null},{min:0,max:99999,step:1,precision:0}),this.properties={count:100,seed:null},this.size=[240,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(d,"title","Take"),h(d,"desc","Randomly sample N samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Take",d);class u extends LGraphNode{constructor(){super(),this.title="Shuffle",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","seed",0,w=>{this.properties.seed=w||null},{min:0,max:99999,step:1,precision:0}),this.properties={seed:null},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(u,"title","Shuffle"),h(u,"desc","Randomly shuffle samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Shuffle",u);class p extends LGraphNode{constructor(){super(),this.title="To Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.properties={field:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(p,"title","To Patches"),h(p,"desc","Create a patches view from a label list field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/To Patches",p);class f extends LGraphNode{constructor(){super(),this.title="Map Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","map",'{"old_label": "new_label"}',w=>{this.properties.map=w}),this.properties={field:"",map:'{"old_label": "new_label"}'},this.size=[340,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(f,"title","Map Labels"),h(f,"desc","Remap label values using a mapping dict"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Map Labels",f);class g extends LGraphNode{constructor(){super(),this.title="Exists",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("toggle","bool",!0,w=>{this.properties.bool=w}),this.properties={field:"",bool:!0},this.size=[260,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(g,"title","Exists"),h(g,"desc","Filter samples where a field exists (is not None)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exists",g);class m extends LGraphNode{constructor(){super(),this.title="Select Fields",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","fields","",w=>{this.properties.fields=w}),this.properties={fields:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(m,"title","Select Fields"),h(m,"desc","Select only specified fields (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Select Fields",m);class _ extends LGraphNode{constructor(){super(),this.title="Exclude Fields",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","fields","",w=>{this.properties.fields=w}),this.properties={fields:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(_,"title","Exclude Fields"),h(_,"desc","Exclude specified fields (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exclude Fields",_);class y extends LGraphNode{constructor(){super(),this.title="Skip",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",0,w=>{this.properties.count=w},{min:0,max:1e5,step:10,precision:0}),this.properties={count:0},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(y,"title","Skip"),h(y,"desc","Omit the first N samples from the view"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Skip",y);class b extends LGraphNode{constructor(){super(),this.title="Filter Field",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","expression","F() > 0",w=>{this.properties.expression=w}),this.addWidget("toggle","only_matches",!0,w=>{this.properties.only_matches=w}),this.properties={field:"",expression:"F() > 0",only_matches:!0},this.size=[320,130],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(b,"title","Filter Field"),h(b,"desc","Filter values of a field by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Field",b);class L extends LGraphNode{constructor(){super(),this.title="Filter Keypoints",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("text","filter","F('confidence') > 0.5",w=>{this.properties.filter=w}),this.addWidget("toggle","only_matches",!0,w=>{this.properties.only_matches=w}),this.properties={field:"",filter:"F('confidence') > 0.5",only_matches:!0},this.size=[340,130],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(L,"title","Filter Keypoints"),h(L,"desc","Filter individual keypoint elements by expression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Keypoints",L);class k extends LGraphNode{constructor(){super(),this.title="Select Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",w=>{this.properties.tags=w}),this.addWidget("text","fields","",w=>{this.properties.fields=w}),this.properties={tags:"",fields:""},this.size=[300,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(k,"title","Select Labels"),h(k,"desc","Select labels matching tags or fields"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Select Labels",k);class T extends LGraphNode{constructor(){super(),this.title="Exclude Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",w=>{this.properties.tags=w}),this.addWidget("text","fields","",w=>{this.properties.fields=w}),this.properties={tags:"",fields:""},this.size=[300,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(T,"title","Exclude Labels"),h(T,"desc","Exclude labels matching tags or fields"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Exclude Labels",T);class I extends LGraphNode{constructor(){super(),this.title="Set Field",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","field","",w=>{this.properties.field=w}),this.addWidget("text","expression","F('confidence') > 0.5",w=>{this.properties.expression=w}),this.properties={field:"",expression:"F('confidence') > 0.5"},this.size=[340,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(I,"title","Set Field"),h(I,"desc","Set a field value using a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Set Field",I);class E extends LGraphNode{constructor(){super(),this.title="Group By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",w=>{this.properties.field=w},{values:[]}),this.addWidget("toggle","reverse",!1,w=>{this.properties.reverse=w}),this.addWidget("toggle","flat",!1,w=>{this.properties.flat=w}),this.properties={field:"",reverse:!1,flat:!1},this.size=[280,120],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(E,"title","Group By"),h(E,"desc","Group samples by a field value"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Group By",E);class G extends LGraphNode{constructor(){super(),this.title="Compute Embeddings",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","clip-vit-base32-torch",w=>{this.properties.model=w},{values:["clip-vit-base32-torch","clip-vit-large14-torch","open-clip-vit-b-32","dinov2-vits14-torch"]}),this.addWidget("text","embeddings_field","embeddings",w=>{this.properties.embeddings_field=w}),this.properties={model:"clip-vit-base32-torch",embeddings_field:"embeddings"},this.size=[340,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(G,"title","Compute Embeddings"),h(G,"desc","Compute embeddings using a zoo model"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Embeddings",G);class R extends LGraphNode{constructor(){super(),this.title="Compute Visualization",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","visualization",w=>{this.properties.brain_key=w}),this.addWidget("combo","method","umap",w=>{this.properties.method=w},{values:["umap","tsne","pca"]}),this.addWidget("combo","num_dims","2",w=>{this.properties.num_dims=parseInt(w)},{values:["2","3"]}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={brain_key:"visualization",method:"umap",num_dims:2,embeddings:"embeddings"},this.size=[340,150],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(R,"title","Compute Visualization"),h(R,"desc","Compute UMAP/t-SNE/PCA embedding visualization"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Visualization",R);class N extends LGraphNode{constructor(){super(),this.title="Compute Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",w=>{this.properties.brain_key=w}),this.addWidget("combo","backend","sklearn",w=>{this.properties.backend=w},{values:["sklearn","qdrant","pinecone","milvus","lancedb"]}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={brain_key:"similarity",backend:"sklearn",embeddings:"embeddings"},this.size=[340,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(N,"title","Compute Similarity"),h(N,"desc","Create a similarity index"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Similarity",N);class D extends LGraphNode{constructor(){super(),this.title="Compute Uniqueness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","uniqueness_field","uniqueness",w=>{this.properties.uniqueness_field=w}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={uniqueness_field:"uniqueness",embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(D,"title","Compute Uniqueness"),h(D,"desc","Compute uniqueness score per sample"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Uniqueness",D);class A extends LGraphNode{constructor(){super(),this.title="Find Exact Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.properties={},this.size=[280,50],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(A,"title","Find Exact Duplicates"),h(A,"desc","Find samples with identical media files"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Exact Duplicates",A);class B extends LGraphNode{constructor(){super(),this.title="Find Near Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","threshold",.1,w=>{this.properties.threshold=w},{min:.001,max:1,step:.01,precision:3}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={threshold:.1,embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(B,"title","Find Near Duplicates"),h(B,"desc","Find near-duplicate samples using embeddings"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Near Duplicates",B);class $ extends LGraphNode{constructor(){super(),this.title="Compute Representativeness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","representativeness_field","representativeness",w=>{this.properties.representativeness_field=w}),this.addWidget("combo","method","cluster-center",w=>{this.properties.method=w},{values:["cluster-center","cluster-center-downweight"]}),this.addWidget("text","embeddings","embeddings",w=>{this.properties.embeddings=w}),this.properties={representativeness_field:"representativeness",method:"cluster-center",embeddings:"embeddings"},this.size=[360,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h($,"title","Compute Representativeness"),h($,"desc","Score how representative each sample is of its neighborhood"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Representativeness",$);class W extends LGraphNode{constructor(){super(),this.title="Compute Mistakenness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",w=>{this.properties.pred_field=w},{values:[]}),this.addWidget("combo","label_field","",w=>{this.properties.label_field=w},{values:[]}),this.properties={pred_field:"",label_field:""},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(W,"title","Compute Mistakenness"),h(W,"desc","Estimate likelihood of annotation mistakes"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Mistakenness",W);class j extends LGraphNode{constructor(){super(),this.title="Compute Hardness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","predictions_field","",w=>{this.properties.predictions_field=w},{values:[]}),this.properties={predictions_field:""},this.size=[320,70],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(j,"title","Compute Hardness"),h(j,"desc","Compute sample hardness (how difficult to classify)"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Hardness",j);class dt extends LGraphNode{constructor(){super(),this.title="Detect Leaky Splits",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","splits","train,test",w=>{this.properties.splits=w}),this.addWidget("number","threshold",.1,w=>{this.properties.threshold=w},{min:.001,max:1,step:.01,precision:3}),this.properties={splits:"train,test",threshold:.1},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(dt,"title","Detect Leaky Splits"),h(dt,"desc","Find data leaks across train/test/val splits"),LiteGraph.registerNodeType("FiftyComfy/Brain/Detect Leaky Splits",dt);class it extends LGraphNode{constructor(){super(),this.title="Manage Brain Run",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","brain_key","",w=>{this.properties.brain_key=w},{values:[]}),this.addWidget("combo","action","delete",w=>{this.properties.action=w},{values:["delete","rename"]}),this.addWidget("text","new_name","",w=>{this.properties.new_name=w}),this.properties={brain_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}onDrawForeground(w){var rt;if((rt=this.flags)!=null&&rt.collapsed)return;const tt=this.properties.action||"delete",J=this.properties.brain_key||"";if(J){w.font="10px sans-serif",w.fillStyle="rgba(255,255,255,0.4)",w.textAlign="left";const K=tt==="rename"?`will rename "${J}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${J}"`,vt=this.size[0]-16;let at=K;for(;w.measureText(at).width>vt&&at.length>10;)at=at.slice(0,-2);at!==K&&(at+="â€¦"),w.fillText(at,8,this.size[1]-6)}}}h(it,"title","Manage Brain Run"),h(it,"desc","Rename or delete a brain run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Brain/Manage Brain Run",it);class X extends LGraphNode{constructor(){super(),this.title="Apply Zoo Model",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","",w=>{this.properties.model=w},{values:[]}),this.addWidget("text","label_field","predictions",w=>{this.properties.label_field=w}),this.addWidget("number","confidence_thresh",0,w=>{this.properties.confidence_thresh=w},{min:0,max:1,step:.05,precision:2}),this.addWidget("toggle","store_logits",!1,w=>{this.properties.store_logits=w}),this.properties={model:"",label_field:"predictions",confidence_thresh:0,store_logits:!1},this.size=[360,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(X,"title","Apply Zoo Model"),h(X,"desc","Apply a model from the FiftyOne Model Zoo"),LiteGraph.registerNodeType("FiftyComfy/Model/Apply Zoo Model",X);class Z extends LGraphNode{constructor(){super(),this.title="Evaluate Detections",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",w=>{this.properties.pred_field=w},{values:[]}),this.addWidget("combo","gt_field","",w=>{this.properties.gt_field=w},{values:[]}),this.addWidget("text","eval_key","eval",w=>{this.properties.eval_key=w}),this.addWidget("combo","method","coco",w=>{this.properties.method=w},{values:["coco","open-images"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"coco"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(Z,"title","Evaluate Detections"),h(Z,"desc","Evaluate detection predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Detections",Z);class St extends LGraphNode{constructor(){super(),this.title="Evaluate Classifications",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",w=>{this.properties.pred_field=w},{values:[]}),this.addWidget("combo","gt_field","",w=>{this.properties.gt_field=w},{values:[]}),this.addWidget("text","eval_key","eval",w=>{this.properties.eval_key=w}),this.properties={pred_field:"",gt_field:"",eval_key:"eval"},this.size=[340,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(St,"title","Evaluate Classifications"),h(St,"desc","Evaluate classification predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Classifications",St);class yt extends LGraphNode{constructor(){super(),this.title="Manage Evaluation",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","eval_key","",w=>{this.properties.eval_key=w},{values:[]}),this.addWidget("combo","action","delete",w=>{this.properties.action=w},{values:["delete","rename"]}),this.addWidget("text","new_name","",w=>{this.properties.new_name=w}),this.properties={eval_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}onDrawForeground(w){var rt;if((rt=this.flags)!=null&&rt.collapsed)return;const tt=this.properties.action||"delete",J=this.properties.eval_key||"";if(J){w.font="10px sans-serif",w.fillStyle="rgba(255,255,255,0.4)",w.textAlign="left";const K=tt==="rename"?`will rename "${J}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${J}"`,vt=this.size[0]-16;let at=K;for(;w.measureText(at).width>vt&&at.length>10;)at=at.slice(0,-2);at!==K&&(at+="â€¦"),w.fillText(at,8,this.size[1]-6)}}}h(yt,"title","Manage Evaluation"),h(yt,"desc","Rename or delete an evaluation run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Manage Evaluation",yt);class Tt extends LGraphNode{constructor(){super(),this.title="Evaluate Segmentations",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",w=>{this.properties.pred_field=w},{values:[]}),this.addWidget("combo","gt_field","",w=>{this.properties.gt_field=w},{values:[]}),this.addWidget("text","eval_key","eval",w=>{this.properties.eval_key=w}),this.addWidget("combo","method","simple",w=>{this.properties.method=w},{values:["simple"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"simple"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(Tt,"title","Evaluate Segmentations"),h(Tt,"desc","Evaluate semantic segmentation masks against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Segmentations",Tt);class ee extends LGraphNode{constructor(){super(),this.title="Evaluate Regressions",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",w=>{this.properties.pred_field=w},{values:[]}),this.addWidget("combo","gt_field","",w=>{this.properties.gt_field=w},{values:[]}),this.addWidget("text","eval_key","eval",w=>{this.properties.eval_key=w}),this.addWidget("combo","method","simple",w=>{this.properties.method=w},{values:["simple"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"simple"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(ee,"title","Evaluate Regressions"),h(ee,"desc","Evaluate regression predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Regressions",ee);class ie extends LGraphNode{constructor(){super(),this.title="To Evaluation Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","eval_key","",w=>{this.properties.eval_key=w},{values:[]}),this.properties={eval_key:""},this.size=[320,70],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(ie,"title","To Evaluation Patches"),h(ie,"desc","Convert to TP/FP/FN patches from an evaluation run"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/To Evaluation Patches",ie);class se extends LGraphNode{constructor(){super(),this.title="Set App View",this.addInput("view","FO_VIEW"),this.properties={},this.size=[220,50],this.color="#998E3B",this.bgcolor="#FFED63"}}h(se,"title","Set App View"),h(se,"desc","Push the resulting view into the FiftyOne App"),LiteGraph.registerNodeType("FiftyComfy/Output/Set App View",se);class pt extends LGraphNode{constructor(){super(),this.title="Save View",this.addInput("view","FO_VIEW"),this.addWidget("text","name","my_view",w=>{this.properties.name=w}),this.addWidget("text","description","",w=>{this.properties.description=w}),this.addWidget("toggle","overwrite",!1,w=>{this.properties.overwrite=w}),this.properties={name:"my_view",description:"",overwrite:!1},this.size=[300,120],this.color="#998E3B",this.bgcolor="#FFED63"}}h(pt,"title","Save View"),h(pt,"desc","Save the view as a named saved view"),LiteGraph.registerNodeType("FiftyComfy/Output/Save View",pt),console.log("[FiftyComfy] Registered all node types")}const listeners={};function onEvent(c,t){return listeners[c]||(listeners[c]=[]),listeners[c].push(t),()=>{listeners[c]=listeners[c].filter(i=>i!==t)}}function emit(c,t){(listeners[c]||[]).forEach(i=>{try{i(t)}catch(s){console.error(`[FiftyComfy] Event listener error (${c}):`,s)}})}class NodeStatusUpdateOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"node_status_update",label:"Node Status Update",unlisted:!0})}async execute({params:t}){emit("node_status",t)}}class ExecutionCompleteOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"execution_complete",label:"Execution Complete",unlisted:!0})}async execute({params:t}){emit("execution_complete",t)}}class DatasetInfoLoadedOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"dataset_info_loaded",label:"Dataset Info Loaded",unlisted:!0})}async execute({params:t}){console.log("[FiftyComfy] dataset_info_loaded received:",t),emit("dataset_info",t)}}const NS$1="@harpreetsahota/FiftyComfy",STORAGE_KEY="fiftycomfy_workflows";let _graph=null,_lgCanvas=null,_initialized=!1,_cssInjected=!1,_currentDatasetName="";function getSavedWorkflows(){try{const c=localStorage.getItem(STORAGE_KEY);return c?JSON.parse(c):{}}catch{return{}}}function saveWorkflow(c,t){const i=getSavedWorkflows();i[c]=t,localStorage.setItem(STORAGE_KEY,JSON.stringify(i))}function listWorkflowNames(){return Object.keys(getSavedWorkflows())}function loadWorkflow(c){return getSavedWorkflows()[c]||null}const TH=36,toolbarCss={position:"absolute",top:0,left:0,right:0,height:TH,zIndex:10,display:"flex",alignItems:"center",gap:6,padding:"0 8px",background:"rgba(20,20,20,0.85)",backdropFilter:"blur(4px)",borderBottom:"1px solid rgba(255,255,255,0.08)",fontFamily:"'Inter','Segoe UI',sans-serif"},btnCss={padding:"4px 10px",border:"1px solid rgba(255,255,255,0.15)",borderRadius:4,background:"rgba(255,255,255,0.08)",color:"#ccc",cursor:"pointer",fontSize:12,fontWeight:500,lineHeight:"20px"},btnRunCss={...btnCss,background:"#2d6a4f",borderColor:"#40916c",color:"#fff",fontWeight:600},sepCss={width:1,height:20,background:"rgba(255,255,255,0.1)",margin:"0 2px"};let _datasetInfoListenerSet=!1;function setupDatasetInfoListener(){_datasetInfoListenerSet||(_datasetInfoListenerSet=!0,onEvent("dataset_info",c=>{var t,i,s;if(c&&c.fields){const n=c.dataset_name||"";_currentDatasetName&&n&&n!==_currentDatasetName&&(console.log(`[FiftyComfy] Dataset changed: ${_currentDatasetName} -> ${n}, clearing canvas`),_graph&&_graph.clear()),_currentDatasetName=n,setDatasetInfo(c),_graph&&updateAllComboWidgets(_graph),console.log("[FiftyComfy] Dataset info received:",n+",",(t=c.fields)==null?void 0:t.length,"fields,",(i=c.label_fields)==null?void 0:i.length,"label fields,",(s=c.patches_fields)==null?void 0:s.length,"patches fields,",Object.keys(c.label_classes||{}).length,"label class fields")}}))}function fetchDatasetInfo(){setupDatasetInfoListener(),operators.executeOperator(`${NS$1}/get_dataset_info`,{}).catch(c=>{console.warn("[FiftyComfy] Could not fetch dataset info:",c)})}function FiftyComfyView(){const c=React.useRef(null),t=React.useRef(null),[i,s]=React.useState("Ready"),[n,o]=React.useState(!1),[r,a]=React.useState(!1),[l,d]=React.useState([]);React.useEffect(()=>{const _=c.current,y=t.current;if(!_||!y)return;if(!_cssInjected){const k=document.createElement("style");k.id="fiftycomfy-lg-css",k.textContent=litegraphCss,document.head.appendChild(k),_cssInjected=!0}if(_initialized||(registerAllNodes(),LiteGraph.allow_edit_node_title=!1,LiteGraph.NODE_TEXT_COLOR="#FFFFFF",LiteGraph.NODE_TITLE_COLOR="#FFFFFF",LiteGraph.WIDGET_TEXT_COLOR="#FFFFFF",LiteGraph.DEFAULT_LINK_COLOR="#99ccff",LiteGraph.LINK_COLOR="#99ccff",LiteGraph.EVENT_LINK_COLOR="#ff9966",LiteGraph.registered_link_types=LiteGraph.registered_link_types||{},LiteGraph.registered_link_types.FO_VIEW={color:"#4FC3F7"},_initialized=!0),_graph||(_graph=new LGraph,hookNodeAdded(_graph)),_lgCanvas){try{_lgCanvas.setGraph(null)}catch{}_lgCanvas=null}_lgCanvas=new LGraphCanvas(_,_graph),_lgCanvas.render_shadows=!1,_lgCanvas.max_zoom=4,_lgCanvas.min_zoom=.1,_lgCanvas.allow_searchbox=!0,_lgCanvas.show_searchbox_on_double_click=!0,_lgCanvas.render_curved_connections=!0,_lgCanvas.render_connection_arrows=!1,_lgCanvas.connections_width=3,_lgCanvas.default_connection_color={input_off:"#888",input_on:"#4FC3F7",output_off:"#888",output_on:"#4FC3F7"},_lgCanvas.autoresize=!0,installSearchFilter(_lgCanvas),_graph.start(),fetchDatasetInfo();const b=()=>{_lgCanvas&&_lgCanvas.resize()};b(),requestAnimationFrame(b),setTimeout(b,100);const L=new ResizeObserver(b);return L.observe(y),()=>{L.disconnect()}},[]);const u=React.useCallback(async()=>{if(_graph){for(const _ of _graph._nodes||[])_.boxcolor=null,_.setDirtyCanvas(!0,!0);o(!0),s("Running...");try{await operators.executeOperator(`${NS$1}/execute_graph`,{graph_json:JSON.stringify(_graph.serialize())})}catch(_){console.error("[FiftyComfy] Execution error:",_)}o(!1),s("Done")}},[]),p=React.useCallback(()=>{if(!_graph)return;const _=prompt("Workflow name:");_&&(saveWorkflow(_,_graph.serialize()),s("Saved: "+_))},[]),f=React.useCallback(()=>{d(listWorkflowNames()),a(!0)},[]),g=React.useCallback(_=>{if(!_graph)return;const y=loadWorkflow(_);y&&(_graph.configure(y),updateAllComboWidgets(_graph),s("Loaded: "+_)),a(!1)},[]),m=React.useCallback(()=>{_graph&&_graph.clear(),s("Ready")},[]);return React__namespace.createElement("div",{ref:t,style:{width:"100%",height:"100%",position:"relative",overflow:"hidden"}},React__namespace.createElement("canvas",{ref:c,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"}}),React__namespace.createElement("div",{style:toolbarCss},React__namespace.createElement("button",{style:btnRunCss,onClick:u,disabled:n},n?"Running...":"â–¶ Run Workflow"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:p},"Save"),React__namespace.createElement("button",{style:btnCss,onClick:f},"Load"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:m},"Clear"),React__namespace.createElement("span",{style:{marginLeft:"auto",fontSize:11,color:"rgba(255,255,255,0.4)"}},i)),r&&React__namespace.createElement("div",{style:{position:"absolute",top:TH+4,left:100,zIndex:20,background:"#2a2a2a",border:"1px solid #555",borderRadius:6,padding:8,minWidth:220,maxHeight:300,overflowY:"auto",boxShadow:"0 4px 16px rgba(0,0,0,0.5)"}},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:6,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Saved Workflows"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>a(!1)},"âœ•")),l.length===0?React__namespace.createElement("div",{style:{fontSize:12,color:"#666",padding:8}},"No saved workflows"):l.map(_=>React__namespace.createElement("div",{key:_,onClick:()=>g(_),style:{padding:"5px 8px",cursor:"pointer",borderRadius:4,fontSize:12,color:"#ddd"},onMouseOver:y=>{y.currentTarget.style.background="#3a3a3a"},onMouseOut:y=>{y.currentTarget.style.background="transparent"}},_))))}plugins.registerComponent({name:"FiftyComfyView",component:FiftyComfyView,type:plugins.PluginComponentType.Component,activator:()=>!0});const NS="@harpreetsahota/FiftyComfy";operators.registerOperator(NodeStatusUpdateOperator,NS),operators.registerOperator(ExecutionCompleteOperator,NS),operators.registerOperator(DatasetInfoLoadedOperator,NS),console.log("[FiftyComfy] Component (type=3) and operators registered")});
//# sourceMappingURL=index.umd.js.map
