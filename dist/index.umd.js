(function(V,U){typeof exports=="object"&&typeof module<"u"?U(require("@fiftyone/plugins"),require("@fiftyone/operators"),require("react")):typeof define=="function"&&define.amd?define(["@fiftyone/plugins","@fiftyone/operators","react"],U):(V=typeof globalThis<"u"?globalThis:V||self,U(V.__fop__,V.__foo__,V.React))})(this,function(plugins,operators,React){"use strict";var Ai=Object.defineProperty;var ii=V=>{throw TypeError(V)};var Pi=(V,U,K)=>U in V?Ai(V,U,{enumerable:!0,configurable:!0,writable:!0,value:K}):V[U]=K;var h=(V,U,K)=>Pi(V,typeof U!="symbol"?U+"":U,K),xe=(V,U,K)=>U.has(V)||ii("Cannot "+K);var S=(V,U,K)=>(xe(V,U,"read from private field"),K?K.call(V):U.get(V)),W=(V,U,K)=>U.has(V)?ii("Cannot add the same private member more than once"):U instanceof WeakSet?U.add(V):U.set(V,K),H=(V,U,K,pt)=>(xe(V,U,"write to private field"),pt?pt.call(V,K):U.set(V,K),K),C=(V,U,K)=>(xe(V,U,"access private method"),K);var ni=(V,U,K,pt)=>({set _(_t){H(V,U,_t,K)},get _(){return S(V,U,pt)}});var V,K,pt,be,si,Yt,At,tt,at,rt,mt,Fe,jt,Lt,It,We,Pt,Kt,xt,Ft,Wt,Mt,qt,Zt,Bt,Jt,Ht,oi,ri,Qt,te,ee,ie,ht,Me,Be,ze,yt,St,ne,se,$,ai,li,He,me,Ue,Ve,Ge,hi,ui,ci,di,pi,fi,Vt,oe,J,$e,Xe,lt,Tt,re,$t,st,Ye,Ae,gi,je,we,_i,ke,Le,Ie,bt,gt,Se,Te,Ee,Et,F,Pe,vt,ae,ct,ot,le,Nt,mi,dt,Dt,yi,bi,Ke,vi,wi,ki,Li,Ii,Rt,Gt,Si,Ti,Ei,Ni,Ci,Oi,Xt,ye,Ct,Ot,Ne,Ce,Di,he,ue,ce,qe,de,De,pe,fe,Re,Ri,ge,wt,Ze,Je;function _interopNamespaceDefault(d){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(d){for(const i in d)if(i!=="default"){const n=Object.getOwnPropertyDescriptor(d,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:()=>d[i]})}}return t.default=d,Object.freeze(t)}const React__namespace=_interopNamespaceDefault(React);class CustomEventTarget extends EventTarget{dispatch(t,i){const n=new CustomEvent(t,{detail:i,cancelable:!0});return super.dispatchEvent(n)}addEventListener(t,i,n){super.addEventListener(t,i,n)}removeEventListener(t,i,n){super.removeEventListener(t,i,n)}dispatchEvent(t){return super.dispatchEvent(t)}}const SUBGRAPH_INPUT_ID=-10,SUBGRAPH_OUTPUT_ID=-20,zeroUuid="00000000-0000-0000-0000-000000000000",randomStorage=new Uint32Array(31);function createUuidv4(){if(typeof(crypto==null?void 0:crypto.randomUUID)=="function")return crypto.randomUUID();if(typeof(crypto==null?void 0:crypto.getRandomValues)=="function"){const d=crypto.getRandomValues(randomStorage);let t=0;return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,i=>(Number(i)^d[t++]*3725290298461914e-24>>Number(i)*.25).toString(16))}return"10000000-1000-4000-8000-100000000000".replaceAll(/[018]/g,d=>(Number(d)^Math.random()*16>>Number(d)*.25).toString(16))}const U=class U{constructor(t,i,n,s,o,r,a){h(this,"id");h(this,"parentId");h(this,"type");h(this,"origin_id");h(this,"origin_slot");h(this,"target_id");h(this,"target_slot");h(this,"data");h(this,"_data");h(this,"_pos");h(this,"_last_time");h(this,"path");h(this,"_centreAngle");h(this,"_dragging");W(this,V);this.id=t,this.type=i,this.origin_id=n,this.origin_slot=s,this.target_id=o,this.target_slot=r,this.parentId=a,this._data=null,this._pos=new Float32Array(2)}get color(){return S(this,V)}set color(t){H(this,V,t===""?null:t)}get isFloatingOutput(){return this.origin_id===-1&&this.origin_slot===-1}get isFloatingInput(){return this.target_id===-1&&this.target_slot===-1}get isFloating(){return this.isFloatingOutput||this.isFloatingInput}get originIsIoNode(){return this.origin_id===SUBGRAPH_INPUT_ID}get targetIsIoNode(){return this.target_id===SUBGRAPH_OUTPUT_ID}static createFromArray(t){return new U(t[0],t[5],t[1],t[2],t[3],t[4])}static create(t){return new U(t.id,t.type,t.origin_id,t.origin_slot,t.target_id,t.target_slot,t.parentId)}static getReroutes(t,i){var n;return i.parentId?((n=t.reroutes.get(i.parentId))==null?void 0:n.getReroutes())??[]:[]}static getFirstReroute(t,i){return U.getReroutes(t,i).at(0)}static findNextReroute(t,i,n){var s;if(i.parentId)return(s=t.reroutes.get(i.parentId))==null?void 0:s.findNextReroute(n)}static getOriginNode(t,i){var s;const n=(s=t.links.get(i))==null?void 0:s.origin_id;return t.getNodeById(n)??void 0}static getTargetNode(t,i){var s;const n=(s=t.links.get(i))==null?void 0:s.target_id;return t.getNodeById(n)??void 0}static resolve(t,i){var n;return(n=i.getLink(t))==null?void 0:n.resolve(i)}static resolveMany(t,i){var s;const n=[];for(const o of t){const r=(s=i.getLink(o))==null?void 0:s.resolve(i);r&&n.push(r)}return n}resolve(t){var l,u;const i=this.target_id===-1?void 0:t.getNodeById(this.target_id)??void 0,n=i==null?void 0:i.inputs[this.target_slot],s=this.originIsIoNode?(l=t.inputNode)==null?void 0:l.slots[this.origin_slot]:void 0;if(s)return{inputNode:i,input:n,subgraphInput:s,link:this};const o=this.origin_id===-1?void 0:t.getNodeById(this.origin_id)??void 0,r=o==null?void 0:o.outputs[this.origin_slot],a=this.targetIsIoNode?(u=t.outputNode)==null?void 0:u.slots[this.target_slot]:void 0;return a?{outputNode:o,output:r,subgraphInput:void 0,subgraphOutput:a,link:this}:{inputNode:i,outputNode:o,input:n,output:r,subgraphInput:s,subgraphOutput:a,link:this}}configure(t){Array.isArray(t)?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot,this.parentId=t.parentId)}hasOrigin(t,i){return this.origin_id===t&&this.origin_slot===i}hasTarget(t,i){return this.target_id===t&&this.target_slot===i}toFloating(t,i){const n=this.asSerialisable();return n.id=-1,n.parentId=i,t==="input"?(n.origin_id=-1,n.origin_slot=-1):(n.target_id=-1,n.target_slot=-1),U.create(n)}disconnect(t,i){const n=U.getReroutes(t,this),s=n.at(-1);if(i==="output"&&(s==null?void 0:s.linkIds.size)===1&&s.floatingLinkIds.size===0||i==="input"&&s){const r=U.create(this);r.id=-1,i==="input"?(r.origin_id=-1,r.origin_slot=-1,s.floating={slotType:"input"}):(r.target_id=-1,r.target_slot=-1,s.floating={slotType:"output"}),t.addFloatingLink(r)}for(const r of n)r.linkIds.delete(this.id),!i&&!r.totalLinks&&t.reroutes.delete(r.id);if(t.links.delete(this.id),this.originIsIoNode&&t instanceof Subgraph){const r=t.inputs.at(this.origin_slot);if(!r)throw new Error("Invalid link - subgraph input not found");r.events.dispatch("input-disconnected",{input:r})}}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}asSerialisable(){const t={id:this.id,origin_id:this.origin_id,origin_slot:this.origin_slot,target_id:this.target_id,target_slot:this.target_slot,type:this.type};return this.parentId&&(t.parentId=this.parentId),t}};V=new WeakMap,h(U,"_drawDebug",!1);let LLink=U;var NodeSlotType=(d=>(d[d.INPUT=1]="INPUT",d[d.OUTPUT=2]="OUTPUT",d))(NodeSlotType||{}),RenderShape=(d=>(d[d.BOX=1]="BOX",d[d.ROUND=2]="ROUND",d[d.CIRCLE=3]="CIRCLE",d[d.CARD=4]="CARD",d[d.ARROW=5]="ARROW",d[d.GRID=6]="GRID",d[d.HollowCircle=7]="HollowCircle",d))(RenderShape||{}),CanvasItem=(d=>(d[d.Nothing=0]="Nothing",d[d.Node=1]="Node",d[d.Group=2]="Group",d[d.Reroute=4]="Reroute",d[d.Link=8]="Link",d[d.RerouteSlot=32]="RerouteSlot",d[d.SubgraphIoNode=64]="SubgraphIoNode",d[d.SubgraphIoSlot=128]="SubgraphIoSlot",d))(CanvasItem||{}),LinkDirection=(d=>(d[d.NONE=0]="NONE",d[d.UP=1]="UP",d[d.DOWN=2]="DOWN",d[d.LEFT=3]="LEFT",d[d.RIGHT=4]="RIGHT",d[d.CENTER=5]="CENTER",d))(LinkDirection||{}),LinkRenderType=(d=>(d[d.HIDDEN_LINK=-1]="HIDDEN_LINK",d[d.STRAIGHT_LINK=0]="STRAIGHT_LINK",d[d.LINEAR_LINK=1]="LINEAR_LINK",d[d.SPLINE_LINK=2]="SPLINE_LINK",d))(LinkRenderType||{}),LinkMarkerShape=(d=>(d[d.None=0]="None",d[d.Circle=1]="Circle",d[d.Arrow=2]="Arrow",d))(LinkMarkerShape||{}),TitleMode=(d=>(d[d.NORMAL_TITLE=0]="NORMAL_TITLE",d[d.NO_TITLE=1]="NO_TITLE",d[d.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",d[d.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",d))(TitleMode||{}),LGraphEventMode=(d=>(d[d.ALWAYS=0]="ALWAYS",d[d.ON_EVENT=1]="ON_EVENT",d[d.NEVER=2]="NEVER",d[d.ON_TRIGGER=3]="ON_TRIGGER",d[d.BYPASS=4]="BYPASS",d))(LGraphEventMode||{}),EaseFunction=(d=>(d.LINEAR="linear",d.EASE_IN_QUAD="easeInQuad",d.EASE_OUT_QUAD="easeOutQuad",d.EASE_IN_OUT_QUAD="easeInOutQuad",d))(EaseFunction||{}),Alignment=(d=>(d[d.None=0]="None",d[d.Top=1]="Top",d[d.Bottom=2]="Bottom",d[d.Middle=4]="Middle",d[d.Left=8]="Left",d[d.Right=16]="Right",d[d.Centre=32]="Centre",d[d.TopLeft=9]="TopLeft",d[d.TopCentre=33]="TopCentre",d[d.TopRight=17]="TopRight",d[d.MidLeft=12]="MidLeft",d[d.MidCentre=36]="MidCentre",d[d.MidRight=20]="MidRight",d[d.BottomLeft=10]="BottomLeft",d[d.BottomCentre=34]="BottomCentre",d[d.BottomRight=18]="BottomRight",d))(Alignment||{});function hasFlag(d,t){return(d&t)===t}function distance(d,t){return Math.sqrt((t[0]-d[0])*(t[0]-d[0])+(t[1]-d[1])*(t[1]-d[1]))}function dist2(d,t,i,n){return(i-d)*(i-d)+(n-t)*(n-t)}function isInRectangle(d,t,i,n,s,o){return d>=i&&d<i+s&&t>=n&&t<n+o}function isPointInRect(d,t){return d[0]>=t[0]&&d[0]<t[0]+t[2]&&d[1]>=t[1]&&d[1]<t[1]+t[3]}function isInRect(d,t,i){return d>=i[0]&&d<i[0]+i[2]&&t>=i[1]&&t<i[1]+i[3]}function isInsideRectangle(d,t,i,n,s,o){return i<d&&i+s>d&&n<t&&n+o>t}function overlapBounding(d,t){const i=d[0]+d[2],n=d[1]+d[3],s=t[0]+t[2],o=t[1]+t[3];return!(d[0]>s||d[1]>o||i<t[0]||n<t[1])}function getCentre(d){return[d[0]+d[2]*.5,d[1]+d[3]*.5]}function containsCentre(d,t){const i=t[0]+t[2]*.5,n=t[1]+t[3]*.5;return isInRect(i,n,d)}function containsRect(d,t){const i=d[0]+d[2],n=d[1]+d[3],s=t[0]+t[2],o=t[1]+t[3];return!(d[0]===t[0]&&d[1]===t[1]&&i===s&&n===o)&&d[0]<=t[0]&&d[1]<=t[1]&&i>=s&&n>=o}function findPointOnCurve(d,t,i,n,s,o=.5){const r=1-o,a=r*r*r,l=3*(r*r)*o,u=3*r*(o*o),c=o*o*o;d[0]=a*t[0]+l*n[0]+u*s[0]+c*i[0],d[1]=a*t[1]+l*n[1]+u*s[1]+c*i[1]}function createBounds(d,t=10){const i=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const n of d){const s=n.boundingRect;i[0]=Math.min(i[0],s[0]),i[1]=Math.min(i[1],s[1]),i[2]=Math.max(i[2],s[0]+s[2]),i[3]=Math.max(i[3],s[1]+s[3])}return i.every(n=>isFinite(n))?[i[0]-t,i[1]-t,i[2]-i[0]+2*t,i[3]-i[1]+2*t]:null}function snapPoint(d,t){return t?(d[0]=t*Math.round(d[0]/t),d[1]=t*Math.round(d[1]/t),!0):!1}function alignToContainer(d,t,[i,n,s,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?d[0]=i+r:hasFlag(t,Alignment.Right)?d[0]=i+s-r-d[2]:hasFlag(t,Alignment.Centre)&&(d[0]=i+s*.5-d[2]*.5),hasFlag(t,Alignment.Top)?d[1]=n+a:hasFlag(t,Alignment.Bottom)?d[1]=n+o-a-d[3]:hasFlag(t,Alignment.Middle)&&(d[1]=n+o*.5-d[3]*.5),d}function alignOutsideContainer(d,t,[i,n,s,o],[r,a]=[0,0]){return hasFlag(t,Alignment.Left)?d[0]=i-r-d[2]:hasFlag(t,Alignment.Right)?d[0]=i+s+r:hasFlag(t,Alignment.Centre)&&(d[0]=i+s*.5-d[2]*.5),hasFlag(t,Alignment.Top)?d[1]=n-a-d[3]:hasFlag(t,Alignment.Bottom)?d[1]=n+o+a:hasFlag(t,Alignment.Middle)&&(d[1]=n+o*.5-d[3]*.5),d}function clamp(d,t,i){return d<t?t:d>i?i:d}const _t=class _t extends Float64Array{constructor(i=0,n=0,s=0,o=0){super(4);W(this,K);W(this,pt);this[0]=i,this[1]=n,this[2]=s,this[3]=o}static from([i,n,s,o]){return new _t(i,n,s,o)}static fromCentre([i,n],s,o=s){const r=i-s*.5,a=n-o*.5;return new _t(r,a,s,o)}static ensureRect(i){return i instanceof _t?i:new _t(i[0],i[1],i[2],i[3])}subarray(i=0,n){const s=i<<3,o=n===void 0?n:n-i;return new Float64Array(this.buffer,s,o)}get pos(){return S(this,K)??H(this,K,this.subarray(0,2)),S(this,K)}set pos(i){this[0]=i[0],this[1]=i[1]}get size(){return S(this,pt)??H(this,pt,this.subarray(2,4)),S(this,pt)}set size(i){this[2]=i[0],this[3]=i[1]}get x(){return this[0]}set x(i){this[0]=i}get y(){return this[1]}set y(i){this[1]=i}get width(){return this[2]}set width(i){this[2]=i}get height(){return this[3]}set height(i){this[3]=i}get left(){return this[0]}set left(i){this[0]=i}get top(){return this[1]}set top(i){this[1]=i}get right(){return this[0]+this[2]}set right(i){this[0]=i-this[2]}get bottom(){return this[1]+this[3]}set bottom(i){this[1]=i-this[3]}get centreX(){return this[0]+this[2]*.5}get centreY(){return this[1]+this[3]*.5}updateTo(i){this[0]=i[0],this[1]=i[1],this[2]=i[2],this[3]=i[3]}containsXy(i,n){const[s,o,r,a]=this;return i>=s&&i<s+r&&n>=o&&n<o+a}containsPoint([i,n]){const[s,o,r,a]=this;return i>=s&&i<s+r&&n>=o&&n<o+a}containsRect(i){const{right:n,bottom:s}=this,o=i[0]+i[2],r=i[1]+i[3];return!(this.x===i[0]&&this.y===i[1]&&n===o&&s===r)&&this.x<=i[0]&&this.y<=i[1]&&n>=o&&s>=r}overlaps(i){return this.x<i[0]+i[2]&&this.y<i[1]+i[3]&&this.x+this.width>i[0]&&this.y+this.height>i[1]}findContainingCorner(i,n,s){if(this.isInTopLeftCorner(i,n,s))return"NW";if(this.isInTopRightCorner(i,n,s))return"NE";if(this.isInBottomLeftCorner(i,n,s))return"SW";if(this.isInBottomRightCorner(i,n,s))return"SE"}isInTopLeftCorner(i,n,s){return isInRectangle(i,n,this.x,this.y,s,s)}isInTopRightCorner(i,n,s){return isInRectangle(i,n,this.right-s,this.y,s,s)}isInBottomLeftCorner(i,n,s){return isInRectangle(i,n,this.x,this.bottom-s,s,s)}isInBottomRightCorner(i,n,s){return isInRectangle(i,n,this.right-s,this.bottom-s,s,s)}isInTopEdge(i,n,s){return isInRectangle(i,n,this.x,this.y,this.width,s)}isInBottomEdge(i,n,s){return isInRectangle(i,n,this.x,this.bottom-s,this.width,s)}isInLeftEdge(i,n,s){return isInRectangle(i,n,this.x,this.y,s,this.height)}isInRightEdge(i,n,s){return isInRectangle(i,n,this.right-s,this.y,s,this.height)}getCentre(){return[this.centreX,this.centreY]}getArea(){return this.width*this.height}getPerimeter(){return 2*(this.width+this.height)}getTopLeft(){return[this[0],this[1]]}getBottomRight(){return[this.right,this.bottom]}getSize(){return[this[2],this[3]]}getOffsetTo([i,n]){return[i-this[0],n-this[1]]}getOffsetFrom([i,n]){return[this[0]-i,this[1]-n]}resizeTopLeft(i,n){this[2]+=this[0]-i,this[3]+=this[1]-n,this[0]=i,this[1]=n}resizeBottomLeft(i,n){this[2]+=this[0]-i,this[3]=n-this[1],this[0]=i}resizeTopRight(i,n){this[2]=i-this[0],this[3]+=this[1]-n,this[1]=n}resizeBottomRight(i,n){this[2]=i-this[0],this[3]=n-this[1]}setWidthRightAnchored(i){const n=this[2];this[2]=i,this[0]+=n-i}setHeightBottomAnchored(i){const n=this[3];this[3]=i,this[1]+=n-i}clone(){return new _t(this[0],this[1],this[2],this[3])}toArray(){return this.export()}export(){return[this[0],this[1],this[2],this[3]]}_drawDebug(i,n="red"){const{strokeStyle:s,lineWidth:o}=i;try{i.strokeStyle=n,i.lineWidth=.5,i.beginPath(),i.strokeRect(this[0],this[1],this[2],this[3])}finally{i.strokeStyle=s,i.lineWidth=o}}};K=new WeakMap,pt=new WeakMap;let Rectangle=_t;function getNodeInputOnPos(d,t,i){var s,o,r;const{inputs:n}=d;if(n)for(const[a,l]of n.entries()){const u=d.getInputPos(a),p=20+((((s=l.label)==null?void 0:s.length)??((o=l.localized_name)==null?void 0:o.length)??((r=l.name)==null?void 0:r.length))||3)*7;if(isInRectangle(t,i,u[0]-10,u[1]-10,p,20))return{index:a,input:l,pos:u}}}function getNodeOutputOnPos(d,t,i){const{outputs:n}=d;if(n)for(const[s,o]of n.entries()){const r=d.getOutputPos(s);if(isInRectangle(t,i,r[0]-10,r[1]-10,40,20))return{index:s,output:o,pos:r}}}function isOverNodeInput(d,t,i,n){const s=getNodeInputOnPos(d,t,i);return s?(n&&(n[0]=s.pos[0],n[1]=s.pos[1]),s.index):-1}function isOverNodeOutput(d,t,i,n){const s=getNodeOutputOnPos(d,t,i);return s?(n&&(n[0]=s.pos[0],n[1]=s.pos[1]),s.index):-1}class NullGraphError extends Error{constructor(t="Attempted to access LGraph reference that was null or undefined.",i){super(t,{cause:i}),this.name="NullGraphError"}}class LGraphIcon{constructor({unicode:t,fontFamily:i="PrimeIcons",color:n="#e6c200",bgColor:s,fontSize:o=16,circlePadding:r=2,xOffset:a=0,yOffset:l=0}){h(this,"unicode");h(this,"fontFamily");h(this,"color");h(this,"bgColor");h(this,"fontSize");h(this,"circlePadding");h(this,"xOffset");h(this,"yOffset");this.unicode=t,this.fontFamily=i,this.color=n,this.bgColor=s,this.fontSize=o,this.circlePadding=r,this.xOffset=a,this.yOffset=l}draw(t,i,n){i+=this.xOffset,n+=this.yOffset;const{font:s,textBaseline:o,textAlign:r,fillStyle:a}=t;t.font=`${this.fontSize}px '${this.fontFamily}'`,t.textBaseline="middle",t.textAlign="center";const l=this.fontSize/2+this.circlePadding;this.bgColor&&(t.beginPath(),t.arc(i+l,n,l,0,2*Math.PI),t.fillStyle=this.bgColor,t.fill()),t.fillStyle=this.color,t.fillText(this.unicode,i+l,n),t.font=s,t.textBaseline=o,t.textAlign=r,t.fillStyle=a}}var BadgePosition=(d=>(d.TopLeft="top-left",d.TopRight="top-right",d))(BadgePosition||{});class LGraphBadge{constructor({text:t,fgColor:i="white",bgColor:n="#0F1F0F",fontSize:s=12,padding:o=6,height:r=20,cornerRadius:a=5,iconOptions:l,xOffset:u=0,yOffset:c=0}){h(this,"text");h(this,"fgColor");h(this,"bgColor");h(this,"fontSize");h(this,"padding");h(this,"height");h(this,"cornerRadius");h(this,"icon");h(this,"xOffset");h(this,"yOffset");this.text=t,this.fgColor=i,this.bgColor=n,this.fontSize=s,this.padding=o,this.height=r,this.cornerRadius=a,l&&(this.icon=new LGraphIcon(l)),this.xOffset=u,this.yOffset=c}get visible(){var t;return(((t=this.text)==null?void 0:t.length)??0)>0||!!this.icon}getWidth(t){if(!this.visible)return 0;const{font:i}=t;let n=0;this.icon&&(t.font=`${this.icon.fontSize}px '${this.icon.fontFamily}'`,n=t.measureText(this.icon.unicode).width+this.padding),t.font=`${this.fontSize}px sans-serif`;const s=this.text?t.measureText(this.text).width:0;return t.font=i,n+s+this.padding*2}draw(t,i,n){if(!this.visible)return;i+=this.xOffset,n+=this.yOffset;const{font:s,fillStyle:o,textBaseline:r,textAlign:a}=t;t.font=`${this.fontSize}px sans-serif`;const l=this.getWidth(t),u=0;t.fillStyle=this.bgColor,t.beginPath(),t.roundRect?t.roundRect(i+u,n,l,this.height,this.cornerRadius):t.rect(i+u,n,l,this.height),t.fill();let c=i+u+this.padding;const p=n+this.height/2;this.icon&&(this.icon.draw(t,c,p),c+=this.icon.fontSize+this.padding/2+4),this.text&&(t.fillStyle=this.fgColor,t.textBaseline="middle",t.textAlign="left",t.fillText(this.text,c,p+1)),t.font=s,t.fillStyle=o,t.textBaseline=r,t.textAlign=a}}class LGraphButton extends LGraphBadge{constructor(i){super(i);h(this,"name");h(this,"_last_area",new Rectangle);this.name=i.name}getWidth(i){if(!this.visible)return 0;const{font:n}=i;i.font=`${this.fontSize}px 'PrimeIcons'`;const s=this.text?i.measureText(this.text).width:0;return i.font=n,s}draw(i,n,s){if(!this.visible)return;const o=this.getWidth(i);this._last_area[0]=n+this.xOffset,this._last_area[1]=s+this.yOffset,this._last_area[2]=o,this._last_area[3]=this.height;const r=n+this.xOffset,a=s+this.yOffset,{font:l,fillStyle:u,textBaseline:c,textAlign:p}=i,f=i.fillStyle||"white";i.font=`${this.fontSize}px 'PrimeIcons'`,i.fillStyle=f,i.textBaseline="middle",i.textAlign="center";const g=r+o/2,m=a+this.height/2;this.text&&i.fillText(this.text,g,m),i.font=l,i.fillStyle=u,i.textBaseline=c,i.textAlign=p}isPointInside(i,n){return this._last_area.containsPoint([i,n])}}const ELLIPSIS="â€¦",TWO_DOT_LEADER="â€¥",ONE_DOT_LEADER="â€¤";var SlotType=(d=>(d.Array="array",d[d.Event=-1]="Event",d))(SlotType||{}),SlotShape=(d=>(d[d.Box=RenderShape.BOX]="Box",d[d.Arrow=RenderShape.ARROW]="Arrow",d[d.Grid=RenderShape.GRID]="Grid",d[d.Circle=RenderShape.CIRCLE]="Circle",d[d.HollowCircle=RenderShape.HollowCircle]="HollowCircle",d))(SlotShape||{}),SlotDirection=(d=>(d[d.Up=LinkDirection.UP]="Up",d[d.Right=LinkDirection.RIGHT]="Right",d[d.Down=LinkDirection.DOWN]="Down",d[d.Left=LinkDirection.LEFT]="Left",d))(SlotDirection||{}),LabelPosition=(d=>(d.Left="left",d.Right="right",d))(LabelPosition||{});function strokeShape(d,t,{shape:i=RenderShape.BOX,round_radius:n,title_height:s,title_mode:o=TitleMode.NORMAL_TITLE,color:r,padding:a=6,collapsed:l=!1,lineWidth:u=1}={}){if(n??(n=LiteGraph.ROUND_RADIUS),r??(r=LiteGraph.NODE_BOX_OUTLINE_COLOR),o===TitleMode.TRANSPARENT_TITLE){const y=s??LiteGraph.NODE_TITLE_HEIGHT;t[1]-=y,t[3]+=y}const{lineWidth:c,strokeStyle:p}=d;d.lineWidth=u,d.globalAlpha=.8,d.strokeStyle=r,d.beginPath();const[f,g,m,_]=t;switch(i){case RenderShape.BOX:{d.rect(f-a,g-a,m+2*a,_+2*a);break}case RenderShape.ROUND:case RenderShape.CARD:{const y=n+a,k=i===RenderShape.CARD&&l||i===RenderShape.ROUND?[y]:[y,2,y,2];d.roundRect(f-a,g-a,m+2*a,_+2*a,k);break}case RenderShape.CIRCLE:{const y=f+m/2,b=g+_/2,k=Math.max(m,_)/2+a;d.arc(y,b,k,0,Math.PI*2);break}}d.stroke(),d.lineWidth=c,d.strokeStyle=p,d.globalAlpha=1}function truncateTextToWidth(d,t,i){if(!(i>0))return"";if(d.measureText(t).width<=i)return t;const s=d.measureText(ELLIPSIS).width*.75;if(s>i)return d.measureText(TWO_DOT_LEADER).width*.75<i?TWO_DOT_LEADER:d.measureText(ONE_DOT_LEADER).width*.75<i?ONE_DOT_LEADER:"";let o=0,r=t.length,a=0;for(;o<=r;){const l=Math.floor((o+r)*.5);if(l===0){o=l+1;continue}const u=t.substring(0,l);d.measureText(u).width+s<=i?(a=l,o=l+1):r=l-1}return a===0?ELLIPSIS:t.substring(0,a)+ELLIPSIS}function drawTextInArea({ctx:d,text:t,area:i,align:n="left"}){const{left:s,right:o,bottom:r,width:a,centreX:l}=i;if(d.measureText(t).width<=a){d.textAlign=n;const f=n==="left"?s:n==="right"?o:l;d.fillText(t,f,r);return}const c=truncateTextToWidth(d,t,a);if(c.length===0)return;d.textAlign="left",d.fillText(c.slice(0,-1),s,r),d.rect(s,r,a,1),d.textAlign="right";const p=c.at(-1);d.fillText(p,o,r,d.measureText(p).width*.75)}class SlotBase{constructor(t,i,n){h(this,"name");h(this,"localized_name");h(this,"label");h(this,"type");h(this,"dir");h(this,"removable");h(this,"shape");h(this,"color_off");h(this,"color_on");h(this,"locked");h(this,"nameLocked");h(this,"widget");h(this,"_floatingLinks");h(this,"hasErrors");h(this,"boundingRect");this.name=t,this.type=i,this.boundingRect=n??new Rectangle}renderingColor(t){return this.isConnected?this.color_on||t.getConnectedColor(this.type):this.color_off||t.getDisconnectedColor(this.type)}}class NodeSlot extends SlotBase{constructor(i,n){const s=i,{boundingRect:o,name:r,type:a,_listenerController:l,...u}=s,c=o?Rectangle.ensureRect(o):new Rectangle;super(r,a,c);W(this,be);h(this,"pos");W(this,Yt);Object.assign(this,u),H(this,Yt,n)}get node(){return S(this,Yt)}get highlightColor(){return LiteGraph.NODE_TEXT_HIGHLIGHT_COLOR??LiteGraph.NODE_SELECTED_TITLE_COLOR??LiteGraph.NODE_TEXT_COLOR}get renderingLabel(){return this.label||this.localized_name||this.name||""}draw(i,{colorContext:n,labelPosition:s=LabelPosition.Right,lowQuality:o=!1,highlight:r=!1,doStroke:a=!1}){const l=i.fillStyle,u=i.strokeStyle,c=i.lineWidth,p=r?this.highlightColor:LiteGraph.NODE_TEXT_COLOR,f=S(this,be,si),g=this.type,m=g===SlotType.Array?SlotShape.Grid:this.shape;i.beginPath();let _=!0;if(i.fillStyle=this.renderingColor(n),i.lineWidth=1,g===SlotType.Event||m===SlotShape.Box)i.rect(f[0]-6+.5,f[1]-5+.5,14,10);else if(m===SlotShape.Arrow)i.moveTo(f[0]+8,f[1]+.5),i.lineTo(f[0]-4,f[1]+6+.5),i.lineTo(f[0]-4,f[1]-6+.5),i.closePath();else if(m===SlotShape.Grid){for(let T=0;T<3;T++)for(let I=0;I<3;I++)i.rect(f[0]-4+T*3,f[1]-4+I*3,2,2);a=!1}else if(o)i.rect(f[0]-4,f[1]-4,8,8);else{let b;m===SlotShape.HollowCircle?(_=!1,a=!0,i.lineWidth=3,i.strokeStyle=i.fillStyle,b=r?4:3):b=r?5:4,i.arc(f[0],f[1],b,0,Math.PI*2)}if(_&&i.fill(),!o&&a&&i.stroke(),!(o||this.isWidgetInputSlot)){const b=this.renderingLabel;b&&(i.fillStyle=p,s===LabelPosition.Right?this.dir==LinkDirection.UP?i.fillText(b,f[0],f[1]-10):i.fillText(b,f[0]+10,f[1]+5):this.dir==LinkDirection.DOWN?i.fillText(b,f[0],f[1]-8):i.fillText(b,f[0]-10,f[1]+5))}this.hasErrors&&(i.lineWidth=2,i.strokeStyle="red",i.beginPath(),i.arc(f[0],f[1],12,0,Math.PI*2),i.stroke()),i.fillStyle=l,i.strokeStyle=u,i.lineWidth=c}drawCollapsed(i){const[n,s]=this.collapsedPos,{fillStyle:o}=i;i.fillStyle="#686",i.beginPath(),this.type===SlotType.Event||this.shape===RenderShape.BOX?i.rect(n-7+.5,s-4,14,8):this.shape===RenderShape.ARROW?(this instanceof NodeInputSlot?(i.moveTo(n+8,s),i.lineTo(n-4,s-4),i.lineTo(n-4,s+4)):(i.moveTo(n+6,s),i.lineTo(n-6,s-4),i.lineTo(n-6,s+4)),i.closePath()):i.arc(n,s,4,0,Math.PI*2),i.fill(),i.fillStyle=o}}be=new WeakSet,si=function(){const i=this.node.pos,{boundingRect:n}=this,s=n[3];return getCentre([n[0]-i[0],n[1]-i[1],s,s])},Yt=new WeakMap;const et=class et{constructor(t,i){h(this,"id");h(this,"color");h(this,"title");h(this,"font");h(this,"font_size",LiteGraph.DEFAULT_GROUP_FONT||24);h(this,"_bounding",new Float32Array([10,10,et.minWidth,et.minHeight]));h(this,"_pos",this._bounding.subarray(0,2));h(this,"_size",this._bounding.subarray(2,4));h(this,"_nodes",[]);h(this,"_children",new Set);h(this,"graph");h(this,"flags",{});h(this,"selected");h(this,"isPointInside",LGraphNode.prototype.isPointInside);h(this,"setDirtyCanvas",LGraphNode.prototype.setDirtyCanvas);this.id=i??-1,this.title=t||"Group";const{pale_blue:n}=LGraphCanvas.node_colors;this.color=n?n.groupcolor:"#AAA"}setColorOption(t){t==null?delete this.color:this.color=t.groupcolor}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.groupcolor===this.color)??null}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=Math.max(et.minWidth,t[0]),this._size[1]=Math.max(et.minHeight,t[1]))}get boundingRect(){return this._bounding}get nodes(){return this._nodes}get titleHeight(){return this.font_size*1.4}get children(){return this._children}get pinned(){return!!this.flags.pinned}pin(t){(t===void 0?!this.pinned:t)?this.flags.pinned=!0:delete this.flags.pinned}unpin(){this.pin(!1)}configure(t){this.id=t.id,this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.flags=t.flags||this.flags,t.font_size&&(this.font_size=t.font_size)}serialize(){const t=this._bounding;return{id:this.id,title:this.title,bounding:[...t],color:this.color,font_size:this.font_size,flags:this.flags}}draw(t,i){const{padding:n,resizeLength:s,defaultColour:o}=et,r=this.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,[a,l]=this._pos,[u,c]=this._size,p=this.color||o;i.globalAlpha=.25*t.editor_alpha,i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,u,r*1.4),i.fill(),i.fillStyle=p,i.strokeStyle=p,i.beginPath(),i.rect(a+.5,l+.5,u,c),i.fill(),i.globalAlpha=t.editor_alpha,i.stroke(),i.beginPath(),i.moveTo(a+u,l+c),i.lineTo(a+u-s,l+c),i.lineTo(a+u,l+c-s),i.fill(),i.font=`${r}px ${LiteGraph.GROUP_FONT}`,i.textAlign="left",i.fillText(this.title+(this.pinned?"ðŸ“Œ":""),a+n,l+r),LiteGraph.highlight_selected_group&&this.selected&&strokeShape(i,this._bounding,{title_height:this.titleHeight,padding:n})}resize(t,i){return this.pinned?!1:(this._size[0]=Math.max(et.minWidth,t),this._size[1]=Math.max(et.minHeight,i),!0)}move(t,i,n=!1){if(!this.pinned&&(this._pos[0]+=t,this._pos[1]+=i,n!==!0))for(const s of this._children)s.move(t,i)}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}recomputeInsideNodes(){if(!this.graph)throw new NullGraphError;const{nodes:t,reroutes:i,groups:n}=this.graph,s=this._children;this._nodes.length=0,s.clear();for(const o of t)containsCentre(this._bounding,o.boundingRect)&&(this._nodes.push(o),s.add(o));for(const o of i.values())isPointInRect(o.pos,this._bounding)&&s.add(o);for(const o of n)containsRect(this._bounding,o._bounding)&&s.add(o);n.sort((o,r)=>o===this?s.has(r)?-1:0:r===this&&s.has(o)?1:0)}resizeTo(t,i=10){const n=createBounds(t,i);n!==null&&(this.pos[0]=n[0],this.pos[1]=n[1]-this.titleHeight,this.size[0]=n[2],this.size[1]=n[3]+this.titleHeight)}addNodes(t,i=10){!this._nodes&&t.length===0||this.resizeTo([...this.children,...this._nodes,...t],i)}getMenuOptions(){return[{content:this.pinned?"Unpin":"Pin",callback:()=>{this.pinned?this.unpin():this.pin(),this.setDirtyCanvas(!1,!0)}},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}isPointInTitlebar(t,i){const n=this.boundingRect;return isInRectangle(t,i,n[0],n[1],n[2],this.titleHeight)}isInResize(t,i){const n=this.boundingRect,s=n[0]+n[2],o=n[1]+n[3];return t<s&&i<o&&t-s+(i-o)>-et.resizeLength}};h(et,"minWidth",140),h(et,"minHeight",80),h(et,"resizeLength",10),h(et,"padding",4),h(et,"defaultColour","#335");let LGraphGroup=et;const Z=class Z{constructor(t,i,n,s,o,r){W(this,mt);W(this,At,new Float32Array(8));W(this,tt);W(this,at);h(this,"floating");W(this,rt,S(this,At).subarray(0,2));h(this,"selected");h(this,"linkIds");h(this,"floatingLinkIds");h(this,"cos",0);h(this,"sin",0);h(this,"controlPoint",S(this,At).subarray(4,6));h(this,"path");h(this,"_centreAngle");h(this,"_pos",S(this,At).subarray(6,8));h(this,"_dragging");h(this,"_colour");W(this,jt,-1/0);W(this,Lt,new RerouteSlot(this,!0));W(this,It,new RerouteSlot(this,!1));this.id=t,H(this,tt,new WeakRef(i)),this.parentId=s,n&&(this.pos=n),this.linkIds=new Set(o),this.floatingLinkIds=new Set(r)}static get slotOffset(){const t=Z.slotRadius*.33;return Z.radius+t+Z.slotRadius}get parentId(){return S(this,at)}set parentId(t){t!==this.id&&this.getReroutes()!==null&&H(this,at,t)}get parent(){var t;return(t=S(this,tt).deref())==null?void 0:t.getReroute(S(this,at))}get pos(){return S(this,rt)}set pos(t){if(!((t==null?void 0:t.length)>=2))throw new TypeError("Reroute.pos is an x,y point, and expects an indexable with at least two values.");S(this,rt)[0]=t[0],S(this,rt)[1]=t[1]}get boundingRect(){const{radius:t}=Z,[i,n]=S(this,rt);return[i-t,n-t,2*t,2*t]}get totalLinks(){return this.linkIds.size+this.floatingLinkIds.size}get colour(){return this._colour??"#18184d"}get isSlotHovered(){return this.isInputHovered||this.isOutputHovered}get isInputHovered(){return S(this,Lt).hovering}get isOutputHovered(){return S(this,It).hovering}get firstLink(){var i;const t=this.linkIds.values().next().value;return t===void 0||(i=S(this,tt).deref())==null?void 0:i.links.get(t)}get firstFloatingLink(){var i;const t=this.floatingLinkIds.values().next().value;return t===void 0||(i=S(this,tt).deref())==null?void 0:i.floatingLinks.get(t)}get origin_id(){var t;return(t=this.firstLink)==null?void 0:t.origin_id}get origin_slot(){var t;return(t=this.firstLink)==null?void 0:t.origin_slot}update(t,i,n,s){this.parentId=t,i&&(this.pos=i),n&&(this.linkIds=new Set(n)),this.floating=s}validateLinks(t,i){const{linkIds:n,floatingLinkIds:s}=this;for(const o of n)t.has(o)||n.delete(o);for(const o of s)i.has(o)||s.delete(o);return n.size>0||s.size>0}getReroutes(t=new Set){var s;if(S(this,at)===void 0)return[this];if(t.has(this))return null;t.add(this);const i=(s=S(this,tt).deref())==null?void 0:s.reroutes.get(S(this,at));if(!i)return H(this,at,void 0),[this];const n=i.getReroutes(t);return n==null||n.push(this),n}findNextReroute(t,i=new Set){var n,s;if(S(this,at)===t)return this;if(i.has(this))return null;if(i.add(this),S(this,at)!==void 0)return(s=(n=S(this,tt).deref())==null?void 0:n.reroutes.get(S(this,at)))==null?void 0:s.findNextReroute(t,i)}findSourceOutput(){var n;const t=this.firstLink??this.firstFloatingLink;if(!t)return;const i=(n=S(this,tt).deref())==null?void 0:n.getNodeById(t.origin_id);if(i)return{node:i,output:i.outputs[t.origin_slot]}}findTargetInputs(){const t=S(this,tt).deref();if(!t)return;const i=[];return n(t,this.linkIds,t.links),n(t,this.floatingLinkIds,t.floatingLinks),i;function n(s,o,r){for(const a of o){const l=r.get(a);if(!l)continue;const u=s.getNodeById(l.target_id),c=u==null?void 0:u.inputs[l.target_slot];c&&i.push({node:u,input:c,link:l})}}}getFloatingLinks(t){var o;const i=(o=S(this,tt).deref())==null?void 0:o.floatingLinks;if(!i)return;const n=t==="input"?"origin_id":"target_id",s=[];for(const r of this.floatingLinkIds){const a=i.get(r);(a==null?void 0:a[n])===-1&&s.push(a)}return s}setFloatingLinkOrigin(t,i,n){var r,a,l;const s=S(this,tt).deref(),o=this.getFloatingLinks("output");if(!o)throw new Error("[setFloatingLinkOrigin]: Invalid network.");if(o.length){i._floatingLinks??(i._floatingLinks=new Set);for(const u of o)i._floatingLinks.add(u),(l=(a=(r=s==null?void 0:s.getNodeById(u.origin_id))==null?void 0:r.outputs[u.origin_slot])==null?void 0:a._floatingLinks)==null||l.delete(u),u.origin_id=t.id,u.origin_slot=n}}move(t,i){S(this,rt)[0]+=t,S(this,rt)[1]+=i}snapToGrid(t){if(!t)return!1;const{pos:i}=this;return i[0]=t*Math.round(i[0]/t),i[1]=t*Math.round(i[1]/t),!0}removeAllFloatingLinks(){for(const t of this.floatingLinkIds)this.removeFloatingLink(t)}removeFloatingLink(t){const i=S(this,tt).deref();if(!i)return;const n=i.floatingLinks.get(t);if(!n){console.warn(`[Reroute.removeFloatingLink] Floating link not found: ${t}, ignoring and discarding ID.`),this.floatingLinkIds.delete(t);return}i.removeFloatingLink(n)}removeLink(t){const i=S(this,tt).deref();if(!i)return;const n=i.floatingLinks.get(t.id);t===n?this.floatingLinkIds.delete(t.id):this.linkIds.delete(t.id)}remove(){const t=S(this,tt).deref();t&&t.removeReroute(this.id)}calculateAngle(t,i,n){if(!(t>S(this,jt)))return;H(this,jt,t);const{id:s,pos:o}=this,r=[];let a=0;if(m(this.linkIds,i.links),m(this.floatingLinkIds,i.floatingLinks),!r.length){this.cos=0,this.sin=0,this.controlPoint[0]=0,this.controlPoint[1]=0;return}a/=r.length;const l=Math.atan2(S(this,rt)[1]-n[1],S(this,rt)[0]-n[0]);let u=(l-a)*.5;Math.abs(u)>Math.PI*.5&&(u+=Math.PI);const c=Math.min(Z.maxSplineOffset,distance(n,S(this,rt))*.25),p=l-u,f=Math.cos(p),g=Math.sin(p);this.cos=f,this.sin=g,this.controlPoint[0]=c*-f,this.controlPoint[1]=c*-g;function m(_,y){for(const b of _){const k=y.get(b),w=getNextPos(i,k,s);if(!w)continue;const T=getDirection(o,w);r.push(T),a+=T}}}draw(t,i){const{globalAlpha:n}=t,{pos:s}=this;if(t.beginPath(),t.arc(s[0],s[1],Z.radius,0,2*Math.PI),this.linkIds.size===0&&(t.fillStyle=i??"#797979",t.fill(),t.globalAlpha=n*.33),t.fillStyle=this.colour,t.lineWidth=Z.radius*.1,t.strokeStyle="rgb(0,0,0,0.5)",t.fill(),t.stroke(),t.fillStyle="#ffffff55",t.strokeStyle="rgb(0,0,0,0.3)",t.beginPath(),t.arc(s[0],s[1],Z.radius*.8,0,2*Math.PI),t.fill(),t.stroke(),this.selected&&(t.strokeStyle="#fff",t.beginPath(),t.arc(s[0],s[1],Z.radius*1.2,0,2*Math.PI),t.stroke()),Z.drawIdBadge){const o=new LGraphBadge({text:this.id.toString()}),r=s[0]-o.getWidth(t)*.5,a=s[1]-o.height-Z.radius-2;o.draw(t,r,a)}t.globalAlpha=n}drawSlots(t){S(this,Lt).draw(t),S(this,It).draw(t)}drawHighlight(t,i){const{pos:n}=this,{strokeStyle:s,lineWidth:o}=t;t.strokeStyle=i,t.lineWidth=1,t.beginPath(),t.arc(n[0],n[1],Z.radius*1.5,0,2*Math.PI),t.stroke(),t.strokeStyle=s,t.lineWidth=o}updateVisibility(t){const i=S(this,Lt),n=S(this,It);i.dirty=!1,n.dirty=!1;const{firstFloatingLink:s}=this,o=!!this.firstLink,r=o||(s==null?void 0:s.isFloatingOutput),a=o||(s==null?void 0:s.isFloatingInput);if((r||a)&&isPointInRect(t,S(this,mt,Fe))){const u=C(this,mt,We).call(this,t);r&&i.update(t,u),a&&n.update(t,u)}else this.hideSlots();return i.dirty||n.dirty}hideSlots(){S(this,Lt).hide(),S(this,It).hide()}containsPoint(t){return isPointInRect(t,S(this,mt,Fe))&&C(this,mt,We).call(this,t)}asSerialisable(){const{id:t,parentId:i,pos:n,linkIds:s}=this;return{id:t,parentId:i,pos:[n[0],n[1]],linkIds:[...s],floating:this.floating?{slotType:this.floating.slotType}:void 0}}};At=new WeakMap,tt=new WeakMap,at=new WeakMap,rt=new WeakMap,mt=new WeakSet,Fe=function(){const t=2*Z.slotOffset,i=2*Math.max(Z.radius,Z.slotRadius),[n,s]=S(this,rt);return[n-t,s-i,2*t,2*i]},jt=new WeakMap,Lt=new WeakMap,It=new WeakMap,We=function(t){return distance(this.pos,t)<=Z.radius},h(Z,"radius",10),h(Z,"maxSplineOffset",80),h(Z,"drawIdBadge",!1),h(Z,"slotRadius",5);let Reroute=Z;class RerouteSlot{constructor(t,i){W(this,Pt);W(this,Kt);h(this,"dirty",!1);W(this,xt,!1);W(this,Ft,!1);H(this,Pt,t),H(this,Kt,i?-1:1)}get pos(){const[t,i]=S(this,Pt).pos;return[t+Reroute.slotOffset*S(this,Kt),i]}get hovering(){return S(this,xt)}set hovering(t){Object.is(S(this,xt),t)||(H(this,xt,t),this.dirty=!0)}get showOutline(){return S(this,Ft)}set showOutline(t){Object.is(S(this,Ft),t)||(H(this,Ft,t),this.dirty=!0)}update(t,i){if(i)this.hovering=!1,this.showOutline=!0;else{const n=distance(this.pos,t);this.hovering=n<=2*Reroute.slotRadius,this.showOutline=n<=5*Reroute.slotRadius}}hide(){this.hovering=!1,this.showOutline=!1}draw(t){const{fillStyle:i,strokeStyle:n,lineWidth:s}=t,{showOutline:o,hovering:r,pos:[a,l]}=this;if(o)try{t.fillStyle=r?S(this,Pt).colour:"rgba(127,127,127,0.3)",t.strokeStyle="rgb(0,0,0,0.5)",t.lineWidth=1,t.beginPath(),t.arc(a,l,Reroute.slotRadius,0,2*Math.PI),t.fill(),t.stroke()}finally{t.fillStyle=i,t.strokeStyle=n,t.lineWidth=s}}}Pt=new WeakMap,Kt=new WeakMap,xt=new WeakMap,Ft=new WeakMap;function getNextPos(d,t,i){var s,o;if(!t)return;const n=(s=LLink.findNextReroute(d,t,i))==null?void 0:s.pos;if(n)return n;if(!(t.target_id===-1||t.target_slot===-1))return(o=d.getNodeById(t.target_id))==null?void 0:o.getInputPos(t.target_slot)}function getDirection(d,t){return Math.atan2(t[1]-d[1],t[0]-d[0])}function stringOrEmpty(d){return d==null?"":String(d)}function parseSlotTypes(d){return d==""||d=="0"?["*"]:String(d).toLowerCase().split(",")}function nextUniqueName(d,t=[]){let i=1;const n=d;for(;t.includes(d);)d=`${n}_${i++}`;return d}const ve=class ve{constructor(t,i){W(this,Wt,0);W(this,Mt,0);W(this,qt,0);W(this,Zt,0);h(this,"minWidth",0);h(this,"minHeight",0);h(this,"maxWidth",1/0);h(this,"maxHeight",1/0);this.desiredWidth=t,this.desiredHeight=i}get width(){return S(this,Wt)}get height(){return S(this,Mt)}get desiredWidth(){return S(this,qt)}set desiredWidth(t){H(this,qt,t),H(this,Wt,clamp(t,this.minWidth,this.maxWidth))}get desiredHeight(){return S(this,Zt)}set desiredHeight(t){H(this,Zt,t),H(this,Mt,clamp(t,this.minHeight,this.maxHeight))}static fromSize(t){return new ve(t[0],t[1])}static fromRect(t){return new ve(t[2],t[3])}setSize(t){this.desiredWidth=t[0],this.desiredHeight=t[1]}setValues(t,i){this.desiredWidth=t,this.desiredHeight=i}toSize(){return[S(this,Wt),S(this,Mt)]}};Wt=new WeakMap,Mt=new WeakMap,qt=new WeakMap,Zt=new WeakMap;let ConstrainedSize=ve;const zt=class zt extends SlotBase{constructor(i,n){super(i.name,i.type);W(this,Bt,new Float32Array(2));h(this,"measurement",new ConstrainedSize(zt.defaultHeight,zt.defaultHeight));h(this,"id");h(this,"parent");h(this,"type");h(this,"linkIds",[]);h(this,"boundingRect",new Rectangle(0,0,0,zt.defaultHeight));h(this,"isPointerOver",!1);Object.assign(this,i),this.id=i.id??createUuidv4(),this.type=i.type,this.parent=n}static get defaultHeight(){return LiteGraph.NODE_SLOT_HEIGHT}get pos(){return S(this,Bt)}set pos(i){!i||i.length<2||(S(this,Bt)[0]=i[0],S(this,Bt)[1]=i[1])}get isConnected(){return this.linkIds.length>0}get displayName(){return this.label??this.localized_name??this.name}containsPoint(i){return this.boundingRect.containsPoint(i)}onPointerMove(i){this.isPointerOver=this.boundingRect.containsXy(i.canvasX,i.canvasY)}getLinks(){const i=[],{subgraph:n}=this.parent;for(const s of this.linkIds){const o=n.getLink(s);o&&i.push(o)}return i}decrementSlots(i){const{links:n}=this.parent.subgraph,s=i==="inputs"?"origin_slot":"target_slot";for(const o of this.linkIds){const r=n.get(o);r?r[s]--:console.warn("decrementSlots: link ID not found",o)}}measure(){var s;const i=((s=LGraphCanvas._measureText)==null?void 0:s.call(LGraphCanvas,this.displayName))??0,{defaultHeight:n}=zt;return this.measurement.setValues(i+n,n),this.measurement.toSize()}disconnect(){const{subgraph:i}=this.parent;for(const n of this.linkIds)i.removeLink(n);this.linkIds.length=0}draw({ctx:i,colorContext:n,lowQuality:s,fromSlot:o,editorAlpha:r=1}){const a=this.shape,{isPointerOver:l,pos:[u,c]}=this,p=o?this.isValidTarget(o):!0,f=!o||p,g=f&&l,m=i.globalAlpha;i.globalAlpha=f?r:.4*r,i.beginPath();const _=this.renderingColor(n);if(s)i.fillStyle=_,i.rect(u-4,c-4,8,8),i.fill();else if(a===SlotShape.HollowCircle){i.lineWidth=3,i.strokeStyle=_;const y=g?4:3;i.arc(u,c,y,0,Math.PI*2),i.stroke()}else{i.fillStyle=_;const y=g?5:4;i.arc(u,c,y,0,Math.PI*2),i.fill()}if(this.displayName){const[y,b]=this.labelPos;i.fillStyle=g?"white":LiteGraph.NODE_TEXT_COLOR||"#AAA",i.fillText(this.displayName,y,b)}i.globalAlpha=m}asSerialisable(){const{id:i,name:n,type:s,linkIds:o,localized_name:r,label:a,dir:l,shape:u,color_off:c,color_on:p,pos:f}=this;return{id:i,name:n,type:s,linkIds:o,localized_name:r,label:a,dir:l,shape:u,color_off:c,color_on:p,pos:f}}};Bt=new WeakMap;let SubgraphSlot=zt;class SubgraphOutput extends SubgraphSlot{connect(t,i,n){var c,p,f;const{subgraph:s}=this.parent;if(!LiteGraph.isValidConnection(t.type,this.type))return;const o=i.outputs.indexOf(t);if(o===-1)throw new Error("Slot is not an output of the given node");if(((c=i.onConnectOutput)==null?void 0:c.call(i,o,this.type,this,this.parent,-1))===!1)return;const r=this.getLinks().at(0);if(r!=null){s.beforeChange(),r.disconnect(s,"input");const m=(p=r.resolve(s).output)==null?void 0:p.links;m&&removeFromArray(m,r.id)}const a=new LLink(++s.state.lastLinkId,t.type,i.id,o,this.parent.id,this.parent.slots.indexOf(this),n);s._links.set(a.id,a),this.linkIds[0]=a.id,t.links??(t.links=[]),t.links.push(a.id);const l=LLink.getReroutes(s,a);for(const g of l)g.linkIds.add(a.id),g.floating&&delete g.floating,g._dragging=void 0;const u=l.at(-1);if(u)for(const g of u.floatingLinkIds){const m=s.floatingLinks.get(g);(m==null?void 0:m.parentId)===u.id&&s.removeFloatingLink(m)}return s._version++,(f=i.onConnectionsChange)==null||f.call(i,NodeSlotType.OUTPUT,o,!0,a,t),s.afterChange(),a}get labelPos(){const[t,i,,n]=this.boundingRect;return[t+n,i+n*.5]}arrange(t){const[i,n,s,o]=t,{boundingRect:r,pos:a}=this;r[0]=i,r[1]=n,r[2]=s,r[3]=o,a[0]=i+o*.5,a[1]=n+o*.5}isValidTarget(t){return isNodeSlot(t)?"links"in t&&LiteGraph.isValidConnection(t.type,this.type):isSubgraphInput(t)?LiteGraph.isValidConnection(t.type,this.type):!1}}class EmptySubgraphOutput extends SubgraphOutput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,n){const{subgraph:s}=this.parent,o=s.outputs.map(l=>l.name),r=nextUniqueName(t.name,o);return s.addOutput(r,String(t.type)).connect(t,i,n)}get labelPos(){const[t,i,,n]=this.boundingRect;return[t,i+n*.5]}}const Ut=class Ut{constructor(t){W(this,Ht);W(this,Jt,new Rectangle);h(this,"selected",!1);h(this,"pinned",!1);h(this,"removable",!1);h(this,"isPointerOver",!1);this.subgraph=t}get boundingRect(){return S(this,Jt)}get pos(){return this.boundingRect.pos}set pos(t){this.boundingRect.pos=t}get size(){return this.boundingRect.size}set size(t){this.boundingRect.size=t}get sideLineWidth(){return this.isPointerOver?2.5:2}get sideStrokeStyle(){return this.isPointerOver?"white":"#efefef"}move(t,i){this.pos[0]+=t,this.pos[1]+=i}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}containsPoint(t){return this.boundingRect.containsPoint(t)}onPointerMove(t){const i=this.boundingRect.containsXy(t.canvasX,t.canvasY);let n=i?CanvasItem.SubgraphIoNode:CanvasItem.Nothing;if(i){this.isPointerOver||this.onPointerEnter();for(const s of this.allSlots)s.onPointerMove(t),s.isPointerOver&&(n|=CanvasItem.SubgraphIoSlot)}else this.isPointerOver&&this.onPointerLeave();return n}onPointerEnter(){this.isPointerOver=!0}onPointerLeave(){this.isPointerOver=!1;for(const t of this.slots)t.isPointerOver=!1}getSlotInPosition(t,i){for(const n of this.allSlots)if(n.boundingRect.containsXy(t,i))return n}showSlotContextMenu(t,i){const n=C(this,Ht,oi).call(this,t);n.length>0&&new LiteGraph.ContextMenu(n,{event:i,title:t.name||"Subgraph Output",callback:s=>{C(this,Ht,ri).call(this,s,t,i)}})}arrange(){const{minWidth:t,roundedRadius:i}=Ut,[,n]=this.boundingRect,s=this.slotAnchorX,{size:o}=this;let r=t,a=n+i;for(const l of this.allSlots){const[u,c]=l.measure();l.arrange([s,a,u,c]),a+=c,u>r&&(r=u)}o[0]=r+2*i,o[1]=a-n+i}draw(t,i,n,s){const{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:u}=t;this.drawProtected(t,i,n,s),Object.assign(t,{lineWidth:o,strokeStyle:r,fillStyle:a,font:l,textBaseline:u})}drawSlots(t,i,n,s){t.fillStyle="#AAA",t.font="12px Arial",t.textBaseline="middle";for(const o of this.allSlots)o.draw({ctx:t,colorContext:i,fromSlot:n,editorAlpha:s})}configure(t){S(this,Jt).set(t.bounding),this.pinned=t.pinned??!1}asSerialisable(){return{id:this.id,bounding:this.boundingRect.export(),pinned:this.pinned?!0:void 0}}};Jt=new WeakMap,Ht=new WeakSet,oi=function(t){const i=[];return t!==this.emptySlot&&t.linkIds.length>0&&i.push({content:"Disconnect Links",value:"disconnect"}),t!==this.emptySlot&&i.push({content:"Remove Slot",value:"remove"},{content:"Rename Slot",value:"rename"}),i},ri=function(t,i,n){switch(t.value){case"disconnect":i.disconnect();break;case"remove":i!==this.emptySlot&&this.removeSlot(i);break;case"rename":i!==this.emptySlot&&this.subgraph.canvasAction(s=>s.prompt("Slot name",i.name,o=>{o&&this.renameSlot(i,o)},n));break}this.subgraph.setDirtyCanvas(!0)},h(Ut,"margin",10),h(Ut,"minWidth",100),h(Ut,"roundedRadius",10);let SubgraphIONodeBase=Ut;class SubgraphOutputNode extends SubgraphIONodeBase{constructor(){super(...arguments);h(this,"id",SUBGRAPH_OUTPUT_ID);h(this,"emptySlot",new EmptySubgraphOutput(this))}get slots(){return this.subgraph.outputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i]=this.boundingRect;return i+SubgraphIONodeBase.roundedRadius}onPointerDown(i,n,s){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(n.onDragStart=()=>{s.dragNewFromSubgraphOutput(this.subgraph,this,o)},n.onDragEnd=a=>{s.dropLinks(this.subgraph,a)},n.finally=()=>{s.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,n){this.subgraph.renameOutput(i,n)}removeSlot(i){this.subgraph.removeOutput(i)}canConnectTo(i,n,s){return i.canConnectTo(this,n,s)}connectByTypeOutput(i,n,s,o){const r=n.findOutputByType(s);if(r)return this.slots[i].connect(r.slot,n,o==null?void 0:o.afterRerouteId)}findInputByType(i){var n;return(n=findFreeSlotOfType(this.slots,i,s=>s.linkIds.length>0))==null?void 0:n.slot}drawProtected(i,n,s,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,u,,c]=this.boundingRect;i.translate(l,u),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(r,r,r,Math.PI,Math.PI*1.5),i.moveTo(0,r),i.lineTo(0,c-r),i.arc(r,c-r,r,Math.PI,Math.PI*.5,!0),i.stroke(),i.setTransform(a),this.drawSlots(i,n,s,o)}}function splitPositionables(d){const t=new Set,i=new Set,n=new Set,s=new Set,o=new Set,r=new Set;for(const a of d)switch(!0){case a instanceof LGraphNode:t.add(a);break;case a instanceof LGraphGroup:n.add(a);break;case a instanceof Reroute:i.add(a);break;case a instanceof SubgraphInputNode:s.add(a);break;case a instanceof SubgraphOutputNode:o.add(a);break;default:r.add(a);break}return{nodes:t,reroutes:i,groups:n,subgraphInputNodes:s,subgraphOutputNodes:o,unknown:r}}function getBoundaryLinks(d,t){const i=[],n=[],s=[],o=[],r=[],a=new WeakSet;for(const u of t)if(!a.has(u)){if(a.add(u),u instanceof LGraphNode){const c=u;if(c.inputs)for(const p of c.inputs){if(l(p._floatingLinks),p.link==null)continue;const f=LLink.resolve(p.link,d);if(!f){console.debug(`Failed to resolve link ID [${p.link}]`);continue}const{link:g,outputNode:m}=f;m?t.has(m)?i.push(g):s.push(g):g.origin_id===SUBGRAPH_INPUT_ID&&s.push(g)}if(c.outputs)for(const p of c.outputs){if(l(p._floatingLinks),!p.links)continue;const f=LLink.resolveMany(p.links,d);for(const{link:g,inputNode:m}of f)(g.target_id===SUBGRAPH_OUTPUT_ID||m&&!t.has(m))&&o.push(g)}}else if(u instanceof Reroute){const c=u,p=LLink.resolveMany(c.linkIds,d);for(const{link:f}of p){const m=LLink.getReroutes(d,f).filter(b=>!t.has(b)),{inputNode:_,outputNode:y}=f.resolve(d);(m.length||_&&!t.has(_)||y&&!t.has(y))&&n.push(f)}}}return{boundaryLinks:n,boundaryFloatingLinks:r,internalLinks:i,boundaryInputLinks:s,boundaryOutputLinks:o};function l(u){if(u)for(const c of u)LLink.getReroutes(d,c).some(f=>!t.has(f))&&r.push(c)}}function multiClone(d){const t=[];for(const i of d){const n=LiteGraph.createNode(i.type);if(!n){console.warn("Failed to create node",i.type);continue}const s=LiteGraph.cloneObject(i.serialize());n.configure(s),t.push(n.serialize())}return t}function groupResolvedByOutput(d){const t=new Map;for(const i of d){const n=i.subgraphInput??i.output??{},s=t.get(n);s?s.push(i):t.set(n,[i])}return t}function mapSubgraphInputsAndLinks(d,t){const i=groupResolvedByOutput(d),n=[];for(const[,s]of i){const o=[];for(const w of s){const{link:T,input:I}=w;if(!I)continue;const E=T.asSerialisable();E.origin_id=SUBGRAPH_INPUT_ID,E.origin_slot=n.length,t.push(E),o.push(E)}const{input:r}=s[0];if(!r)continue;const{color_off:a,color_on:l,dir:u,hasErrors:c,label:p,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,n.map(w=>w.name)),b=f?nextUniqueName(f,n.map(w=>w.localized_name??"")):void 0,k={id:createUuidv4(),type:String(_),linkIds:o.map(w=>w.id),name:y,color_off:a,color_on:l,dir:u,label:p,localized_name:b,hasErrors:c,shape:m};n.push(k)}return n}function mapSubgraphOutputsAndLinks(d,t){const i=groupResolvedByOutput(d),n=[];for(const[,s]of i){const o=[];for(const w of s){const{link:T,output:I}=w;if(!I)continue;const E=T.asSerialisable();E.target_id=SUBGRAPH_OUTPUT_ID,E.target_slot=n.length,t.push(E),o.push(E)}const{output:r}=s[0];if(!r)continue;const{color_off:a,color_on:l,dir:u,hasErrors:c,label:p,localized_name:f,name:g,shape:m,type:_}=r,y=nextUniqueName(g,n.map(w=>w.name)),b=f?nextUniqueName(f,n.map(w=>w.localized_name??"")):void 0,k={id:createUuidv4(),type:String(_),linkIds:o.map(w=>w.id),name:y,color_off:a,color_on:l,dir:u,label:p,localized_name:b,hasErrors:c,shape:m};n.push(structuredClone(k))}return n}function getDirectSubgraphIds(d){const t=new Set;for(const i of d._nodes)i.isSubgraphNode()&&t.add(i.type);return t}function findUsedSubgraphIds(d,t){const i=new Set,n=[d];for(;n.length>0;){const s=n.shift(),o=getDirectSubgraphIds(s);for(const r of o)if(!i.has(r)){i.add(r);const a=t.get(r);a&&n.push(a)}}return i}function isSubgraphInput(d){return d!=null&&typeof d=="object"&&"parent"in d&&d.parent instanceof SubgraphInputNode}function isSubgraphOutput(d){return d!=null&&typeof d=="object"&&"parent"in d&&d.parent instanceof SubgraphOutputNode}function isNodeSlot(d){return d!=null&&typeof d=="object"&&("link"in d||"links"in d)}class NodeInputSlot extends NodeSlot{constructor(i,n){super(i,n);h(this,"link");W(this,Qt);this.link=i.link}get isWidgetInputSlot(){return!!this.widget}get _widget(){var i;return(i=S(this,Qt))==null?void 0:i.deref()}set _widget(i){H(this,Qt,i?new WeakRef(i):void 0)}get collapsedPos(){return[0,LiteGraph.NODE_TITLE_HEIGHT*-.5]}get isConnected(){return this.link!=null}isValidTarget(i){return"links"in i?LiteGraph.isValidConnection(i.type,this.type):isSubgraphInput(i)?LiteGraph.isValidConnection(i.type,this.type):!1}draw(i,n){const{textAlign:s}=i;i.textAlign="left",super.draw(i,{...n,labelPosition:LabelPosition.Right,doStroke:!1}),i.textAlign=s}}Qt=new WeakMap;class NodeOutputSlot extends NodeSlot{constructor(i,n){super(i,n);W(this,te);h(this,"links");h(this,"_data");h(this,"slot_index");this.links=i.links,this._data=i._data,this.slot_index=i.slot_index,H(this,te,n)}get isWidgetInputSlot(){return!1}get collapsedPos(){return[S(this,te)._collapsed_width??LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT*-.5]}isValidTarget(i){return"link"in i?LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}get isConnected(){return this.links!=null&&this.links.length>0}draw(i,n){const{textAlign:s,strokeStyle:o}=i;i.textAlign="right",i.strokeStyle="black",super.draw(i,{...n,labelPosition:LabelPosition.Left,doStroke:!0}),i.textAlign=s,i.strokeStyle=o}}te=new WeakMap;function shallowCloneCommonProps(d){const{color_off:t,color_on:i,dir:n,label:s,localized_name:o,locked:r,name:a,nameLocked:l,removable:u,shape:c,type:p}=d;return{color_off:t,color_on:i,dir:n,label:s,localized_name:o,locked:r,name:a,nameLocked:l,removable:u,shape:c,type:p}}function inputAsSerialisable(d){const{link:t}=d,i=d.widget?{widget:{name:d.widget.name}}:{pos:d.pos};return{...shallowCloneCommonProps(d),...i,link:t}}function outputAsSerialisable(d){const{pos:t,slot_index:i,links:n,widget:s}=d,o=s?{widget:{name:s.name}}:null;return{...shallowCloneCommonProps(d),...o,pos:t,slot_index:i,links:n}}function isINodeInputSlot(d){return"link"in d}function isWidgetInputSlot(d){return!!d.widget}const UNIQUE_MESSAGE_LIMIT=1e4,sentWarnings=new Set;function warnDeprecated(d,t){if(!LiteGraph.alwaysRepeatWarnings){if(sentWarnings.has(d)||sentWarnings.size>UNIQUE_MESSAGE_LIMIT)return;sentWarnings.add(d)}for(const i of LiteGraph.onDeprecationWarning)i(d,t)}function distributeSpace(d,t){if(t.length===0)return[];const i=t.reduce((o,r)=>o+r.minSize,0);if(d<i)return t.map(o=>o.minSize);let n=t.map(o=>({computedSize:o.minSize,maxSize:o.maxSize??1/0,remaining:(o.maxSize??1/0)-o.minSize})),s=d-i;for(;s>0&&n.some(o=>o.remaining>0);){const o=n.filter(l=>l.remaining>0).length;if(o===0)break;const r=s/o;let a=0;if(n=n.map(l=>{if(l.remaining<=0)return l;const u=Math.min(r,l.remaining);return a+=u,{...l,computedSize:l.computedSize+u,remaining:l.remaining-u}}),s-=a,a===0)break}return n.map(({computedSize:o})=>o)}function truncateText(d,t,i,n="..."){if(d.measureText(t).width<=i||i<=0)return t;const o=d.measureText(n).width,r=i-o;if(r<=0)return n;let a=0,l=t.length,u=0;for(;a<=l;){const c=Math.floor((a+l)/2),p=t.substring(0,c);d.measureText(p).width<=r?(u=c,a=c+1):l=c-1}return t.substring(0,u)+n}function toClass(d,...t){return t[0]instanceof d?t[0]:new d(...t)}const ft=class ft{constructor(t,i){W(this,ee);h(this,"linkedWidgets");h(this,"name");h(this,"options");h(this,"label");h(this,"type");h(this,"y",0);h(this,"last_y");h(this,"width");h(this,"disabled");h(this,"computedDisabled");h(this,"hidden");h(this,"advanced");h(this,"tooltip");h(this,"element");W(this,ie);H(this,ee,i??t.node),this.name=t.name,this.options=t.options,this.type=t.type;const{node:n,outline_color:s,background_color:o,height:r,text_color:a,secondary_text_color:l,disabledTextColor:u,displayName:c,displayValue:p,labelBaseline:f,...g}=t;Object.assign(this,g)}get node(){return S(this,ee)}get value(){return S(this,ie)}set value(t){H(this,ie,t)}get outline_color(){return this.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR}get background_color(){return LiteGraph.WIDGET_BGCOLOR}get height(){return LiteGraph.NODE_WIDGET_HEIGHT}get text_color(){return LiteGraph.WIDGET_TEXT_COLOR}get secondary_text_color(){return LiteGraph.WIDGET_SECONDARY_TEXT_COLOR}get disabledTextColor(){return LiteGraph.WIDGET_DISABLED_TEXT_COLOR}get displayName(){return this.label||this.name}get _displayValue(){return this.computedDisabled?"":String(this.value)}get labelBaseline(){return this.y+this.height*.7}drawWidgetShape(t,{width:i,showText:n}){const{height:s,y:o}=this,{margin:r}=ft;t.textAlign="left",t.strokeStyle=this.outline_color,t.fillStyle=this.background_color,t.beginPath(),n?t.roundRect(r,o,i-r*2,s,[s*.5]):t.rect(r,o,i-r*2,s),t.fill(),n&&!this.computedDisabled&&t.stroke()}drawTruncatingText({ctx:t,width:i,leftPadding:n=5,rightPadding:s=20}){const{height:o,y:r}=this,{margin:a}=ft,{displayName:l,_displayValue:u}=this,c=t.measureText(l).width,p=t.measureText(u).width,f=ft.labelValueGap,g=a*2+n,m=i-g-2*a-s,_=c+f+p,y=new Rectangle(g,r,m,o*.7);if(t.fillStyle=this.secondary_text_color,_<=m)drawTextInArea({ctx:t,text:l,area:y,align:"left"});else if(LiteGraph.truncateWidgetTextEvenly){const b=(m-f)/(_-f);y.width=c*b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(p*b)}else if(LiteGraph.truncateWidgetValuesFirst){const b=Math.min(c,m);y.width=b,drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(Math.max(m-f-b,0))}else{const b=Math.min(p,m);y.width=Math.max(m-f-b,0),drawTextInArea({ctx:t,text:l,area:y,align:"left"}),y.right=g+m,y.setWidthRightAnchored(b)}t.fillStyle=this.text_color,drawTextInArea({ctx:t,text:u,area:y,align:"right"})}setValue(t,{e:i,node:n,canvas:s}){var l,u,c;const o=this.value;if(t===this.value)return;const r=this.type==="number"?Number(t):t;this.value=r,(l=this.options)!=null&&l.property&&n.properties[this.options.property]!==void 0&&n.setProperty(this.options.property,r);const a=s.graph_mouse;(u=this.callback)==null||u.call(this,this.value,s,n,a,i),(c=n.onWidgetChanged)==null||c.call(n,this.name??"",r,o,this),n.graph&&n.graph._version++}createCopyForNode(t){const i=new this.constructor(this,t);return i.value=this.value,i}};ee=new WeakMap,ie=new WeakMap,h(ft,"margin",15),h(ft,"arrowMargin",6),h(ft,"arrowWidth",10),h(ft,"minValueWidth",42),h(ft,"labelValueGap",5);let BaseWidget=ft;class BooleanWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","toggle")}drawWidget(i,{width:n,showText:s=!0}){const{height:o,y:r}=this,{margin:a}=BaseWidget;this.drawWidgetShape(i,{width:n,showText:s}),i.fillStyle=this.value?"#89A":"#333",i.beginPath(),i.arc(n-a*2,r+o*.5,o*.36,0,Math.PI*2),i.fill(),s&&(this.drawLabel(i,a*2),this.drawValue(i,n-40))}drawLabel(i,n){i.fillStyle=this.secondary_text_color;const{displayName:s}=this;s&&i.fillText(s,n,this.labelBaseline)}drawValue(i,n){i.fillStyle=this.value?this.text_color:this.secondary_text_color,i.textAlign="right";const s=this.value?this.options.on||"true":this.options.off||"false";i.fillText(s,n,this.labelBaseline)}onClick(i){this.setValue(!this.value,i)}}class ButtonWidget extends BaseWidget{constructor(i,n){super(i,n);h(this,"type","button");h(this,"clicked");this.clicked??(this.clicked=!1)}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:u}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,this.clicked&&(i.fillStyle="#AAA",this.clicked=!1),i.fillRect(c,u,n-c*2,l),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,u,n-c*2,l)),s&&this.drawLabel(i,n*.5),Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}drawLabel(i,n){i.textAlign="center",i.fillStyle=this.text_color,i.fillText(this.displayName,n,this.y+this.height*.7)}onClick({e:i,node:n,canvas:s}){var r;const o=s.graph_mouse;this.clicked=!0,s.setDirty(!0),(r=this.callback)==null||r.call(this,this,s,n,o,i)}}class BaseSteppedWidget extends BaseWidget{drawArrowButtons(t,i){const{height:n,text_color:s,disabledTextColor:o,y:r}=this,{arrowMargin:a,arrowWidth:l,margin:u}=BaseWidget,c=u+a,p=c+l;t.fillStyle=this.canDecrement()?s:o,t.beginPath(),t.moveTo(p,r+5),t.lineTo(c,r+n*.5),t.lineTo(p,r+n-5),t.fill(),t.fillStyle=this.canIncrement()?s:o,t.beginPath(),t.moveTo(i-p,r+5),t.lineTo(i-c,r+n*.5),t.lineTo(i-p,r+n-5),t.fill()}drawWidget(t,i){const{fillStyle:n,strokeStyle:s,textAlign:o}=t;this.drawWidgetShape(t,i),i.showText&&(this.computedDisabled||this.drawArrowButtons(t,i.width),this.drawTruncatingText({ctx:t,width:i.width})),Object.assign(t,{textAlign:o,strokeStyle:s,fillStyle:n})}}function toArray(d){return Array.isArray(d)?d:Object.keys(d)}class ComboWidget extends BaseSteppedWidget{constructor(){super(...arguments);W(this,ht);h(this,"type","combo")}get _displayValue(){if(this.computedDisabled)return"";const{values:i}=this.options;if(i){const n=typeof i=="function"?i():i;if(n&&!Array.isArray(n))return n[this.value]}return typeof this.value=="number"?String(this.value):this.value}canIncrement(){return C(this,ht,Be).call(this,!0)}canDecrement(){return C(this,ht,Be).call(this,!1)}incrementValue(i){C(this,ht,ze).call(this,1,i)}decrementValue(i){C(this,ht,ze).call(this,-1,i)}onClick({e:i,node:n,canvas:s}){const o=i.canvasX-n.pos[0],r=this.width||n.size[0];if(typeof this.options.values=="function"&&warnDeprecated("Using a function for values is deprecated. Use an array of unique values instead."),o<40)return this.decrementValue({e:i,node:n,canvas:s});if(o>r-40)return this.incrementValue({e:i,node:n,canvas:s});const a=C(this,ht,Me).call(this,n),l=toArray(a),u=a!=l?Object.values(a):a;new LiteGraph.ContextMenu(u,{scale:Math.max(1,s.ds.scale),event:i,className:"dark",callback:c=>{this.setValue(a!=l?u.indexOf(c):c,{e:i,node:n,canvas:s})}})}}ht=new WeakSet,Me=function(i){const{values:n}=this.options;if(n==null)throw new Error("[ComboWidget]: values is required");return typeof n=="function"?n(this,i):n},Be=function(i){const{values:n}=this.options;if(typeof n=="function")return!1;const s=toArray(n);if(!(s.length>1))return!1;const o=s.at(0),r=s.at(-1);return o===r?!0:this.value!==(i?r:o)},ze=function(i,n){const s=C(this,ht,Me).call(this,n.node),o=toArray(s);n.canvas.last_mouseclick=0;const r=typeof s=="object"?o.indexOf(String(this.value))+i:o.indexOf(this.value)+i,a=clamp(r,0,o.length-1),l=Array.isArray(s)?s[a]:a;this.setValue(l,n)};function getWidgetStep(d){return d.step2||(d.step||10)*.1}class KnobWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","knob");h(this,"current_drag_offset",0)}computeLayoutSize(){return{minHeight:60,minWidth:20,maxHeight:1e6,maxWidth:1e6}}get height(){return this.computedHeight||super.height}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{y:l}=this,{margin:u}=BaseWidget,{gradient_stops:c="rgb(14, 182, 201); rgb(0, 216, 72)"}=this.options,p=this.computedHeight||this.height,f=Math.min(this.computedHeight||this.height,this.width||20)/20,g={x:n/2,y:p/2+l};i.lineWidth=(Math.min(n,p)-u*f)/6;const m=(Math.min(n,p)-u*f-i.lineWidth)/2;{const I=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);I.addColorStop(0,"rgb(29, 29, 29)"),I.addColorStop(1,"rgb(116, 116, 116)"),i.fillStyle=I}i.beginPath(),i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.fill(),i.closePath();const _={start_angle:Math.PI*.6,end_angle:Math.PI*2.4};i.beginPath();{const I=i.createRadialGradient(g.x,g.y,m+i.lineWidth,0,0,m+i.lineWidth);I.addColorStop(0,"rgb(99, 99, 99)"),I.addColorStop(1,"rgb(36, 36, 36)"),i.strokeStyle=I}i.arc(g.x,g.y,m,_.start_angle,_.end_angle,!1),i.stroke(),i.closePath();const y=this.options.max-this.options.min;let b=(this.value-this.options.min)/y;b=clamp(b,0,1),i.beginPath();const k=i.createConicGradient(_.start_angle,g.x,g.y),w=c.split(";");for(const[I,E]of w.entries())k.addColorStop(I,E.trim());i.strokeStyle=k;const T=(_.end_angle-_.start_angle)*b+_.start_angle;if(i.arc(g.x,g.y,m,_.start_angle,T,!1),i.stroke(),i.closePath(),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.beginPath(),i.strokeStyle=this.outline_color,i.arc(g.x,g.y,m+i.lineWidth/2,0,Math.PI*2,!1),i.lineWidth=1,i.stroke(),i.closePath()),s){i.textAlign="center",i.fillStyle=this.text_color;const I=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}
${I}`,n*.5,l+p*.5)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(){this.current_drag_offset=0}onDrag(i){if(this.options.read_only)return;const{e:n}=i,s=getWidgetStep(this.options),o=this.options.max-this.options.min,r=o/10,a=o/100,l={shift:r>s?r-r%s:s,delta_y:a>s?a-a%s:s},u=Math.abs(n.movementY)>Math.abs(n.movementX),c=u?-n.movementY:n.movementX,p=15;this.current_drag_offset+=c;let f=0;this.current_drag_offset>p?(f+=1,this.current_drag_offset-=p):this.current_drag_offset<-15&&(f-=1,this.current_drag_offset+=p);const g=n.shiftKey?l.shift:u?l.delta_y:s,m=f*g,_=clamp(this.value+m,this.options.min,this.options.max);_!==this.value&&this.setValue(_,i)}}class LegacyWidget extends BaseWidget{drawWidget(t,i){var s;const n=LiteGraph.NODE_WIDGET_HEIGHT;(s=this.draw)==null||s.call(this,t,this.node,i.width,this.y,n,!!i.showText)}onClick(){console.warn("Custom widget wrapper onClick was just called. Handling for third party widgets is done via LGraphCanvas - the mouse callback.")}}class NumberWidget extends BaseSteppedWidget{constructor(){super(...arguments);h(this,"type","number")}get _displayValue(){return this.computedDisabled?"":Number(this.value).toFixed(this.options.precision!==void 0?this.options.precision:3)}canIncrement(){const{max:t}=this.options;return t==null||this.value<t}canDecrement(){const{min:t}=this.options;return t==null||this.value>t}incrementValue(t){this.setValue(this.value+getWidgetStep(this.options),t)}decrementValue(t){this.setValue(this.value-getWidgetStep(this.options),t)}setValue(t,i){let n=t;this.options.min!=null&&n<this.options.min&&(n=this.options.min),this.options.max!=null&&n>this.options.max&&(n=this.options.max),super.setValue(n,i)}onClick({e,node,canvas}){const x=e.canvasX-node.pos[0],width=this.width||node.size[0],delta=x<40?-1:x>width-40?1:0;if(delta){this.setValue(this.value+delta*getWidgetStep(this.options),{e,node,canvas});return}canvas.prompt("Value",this.value,v=>{if(/^[\d\s()*+/-]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch{}const newValue=Number(v);isNaN(newValue)||this.setValue(newValue,{e,node,canvas})},e)}onDrag({e:t,node:i,canvas:n}){const s=this.width||i.width,o=t.canvasX-i.pos[0];(o<40||o>s-40)&&o>-3&&o<s+3||this.setValue(this.value+(t.deltaX??0)*getWidgetStep(this.options),{e:t,node:i,canvas:n})}}class SliderWidget extends BaseWidget{constructor(){super(...arguments);h(this,"type","slider");h(this,"marker")}drawWidget(i,{width:n,showText:s=!0}){const{fillStyle:o,strokeStyle:r,textAlign:a}=i,{height:l,y:u}=this,{margin:c}=BaseWidget;i.fillStyle=this.background_color,i.fillRect(c,u,n-c*2,l);const p=this.options.max-this.options.min;let f=(this.value-this.options.min)/p;if(f=clamp(f,0,1),i.fillStyle=this.options.slider_color??"#678",i.fillRect(c,u,f*(n-c*2),l),s&&!this.computedDisabled&&(i.strokeStyle=this.outline_color,i.strokeRect(c,u,n-c*2,l)),this.marker!=null){let g=(this.marker-this.options.min)/p;g=clamp(g,0,1),i.fillStyle=this.options.marker_color??"#AA9",i.fillRect(c+g*(n-c*2),u,2,l)}if(s){i.textAlign="center",i.fillStyle=this.text_color;const g=Number(this.value).toFixed(this.options.precision??3);i.fillText(`${this.label||this.name}  ${g}`,n*.5,u+l*.7)}Object.assign(i,{textAlign:a,strokeStyle:r,fillStyle:o})}onClick(i){if(this.options.read_only)return;const{e:n,node:s}=i,o=this.width||s.size[0],r=n.canvasX-s.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}onDrag(i){if(this.options.read_only)return!1;const{e:n,node:s}=i,o=this.width||s.size[0],r=n.canvasX-s.pos[0],a=clamp((r-15)/(o-30),0,1),l=this.options.min+(this.options.max-this.options.min)*a;l!==this.value&&this.setValue(l,i)}}class TextWidget extends BaseWidget{constructor(t,i){var n;super(t,i),this.type??(this.type="string"),this.value=((n=t.value)==null?void 0:n.toString())??""}drawWidget(t,{width:i,showText:n=!0}){const{fillStyle:s,strokeStyle:o,textAlign:r}=t;this.drawWidgetShape(t,{width:i,showText:n}),n&&this.drawTruncatingText({ctx:t,width:i,leftPadding:0,rightPadding:0}),Object.assign(t,{textAlign:r,strokeStyle:o,fillStyle:s})}onClick({e:t,node:i,canvas:n}){var s;n.prompt("Value",this.value,o=>{o!==null&&this.setValue(o,{e:t,node:i,canvas:n})},t,((s=this.options)==null?void 0:s.multiline)??!1)}}function toConcreteWidget(d,t,i=!0){if(d instanceof BaseWidget)return d;const n=d;switch(n.type){case"button":return toClass(ButtonWidget,n,t);case"toggle":return toClass(BooleanWidget,n,t);case"slider":return toClass(SliderWidget,n,t);case"knob":return toClass(KnobWidget,n,t);case"combo":return toClass(ComboWidget,n,t);case"number":return toClass(NumberWidget,n,t);case"string":return toClass(TextWidget,n,t);case"text":return toClass(TextWidget,n,t);default:if(i)return toClass(LegacyWidget,d,t)}}const it=class it{constructor(t,i){W(this,$);h(this,"title");h(this,"graph",null);h(this,"id");h(this,"type","");h(this,"inputs",[]);h(this,"outputs",[]);W(this,yt,[]);W(this,St,[]);h(this,"properties",{});h(this,"properties_info",[]);h(this,"flags",{});h(this,"widgets");h(this,"freeWidgetSpace");h(this,"locked");h(this,"order",0);h(this,"mode",LGraphEventMode.ALWAYS);h(this,"last_serialization");h(this,"serialize_widgets");h(this,"color");h(this,"bgcolor");h(this,"boxcolor");h(this,"strokeStyles");h(this,"progress");h(this,"exec_version");h(this,"action_call");h(this,"execute_triggered");h(this,"action_triggered");h(this,"widgets_up");h(this,"widgets_start_y");h(this,"lostFocusAt");h(this,"gotFocusAt");h(this,"badges",[]);h(this,"title_buttons",[]);h(this,"badgePosition",BadgePosition.TopLeft);h(this,"_collapsed_width");h(this,"console");h(this,"_level");h(this,"_shape");h(this,"mouseOver");h(this,"redraw_on_mouse");h(this,"resizable");h(this,"clonable");h(this,"_relative_id");h(this,"clip_area");h(this,"ignore_remove");h(this,"has_errors");h(this,"removable");h(this,"block_delete");h(this,"selected");h(this,"showAdvanced");W(this,ne,new Float32Array(4));W(this,se,new Rectangle);h(this,"_posSize",new Float32Array(4));h(this,"_pos",this._posSize.subarray(0,2));h(this,"_size",this._posSize.subarray(2,4));this.id=LiteGraph.use_uuids?LiteGraph.uuidv4():-1,this.title=t||"Unnamed",this.type=i??"",this.size=[LiteGraph.NODE_WIDTH,60],this.pos=[10,10],this.strokeStyles={error:C(this,$,ai),selected:C(this,$,li)},this.onMouseDown=(n,s,o)=>{var r;if((r=this.title_buttons)!=null&&r.length&&!this.flags.collapsed){const a=s[0],l=s[1];for(let u=0;u<this.title_buttons.length;u++){const c=this.title_buttons[u];if(c.visible&&c.isPointInside(a,l))return this.onTitleButtonClick(c,o),!0}}return!1}}get titleFontStyle(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get innerFontStyle(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get displayType(){return this.type}get renderingColor(){return this.color||this.constructor.color||LiteGraph.NODE_DEFAULT_COLOR}get renderingBgColor(){return this.bgcolor||this.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR}get renderingBoxColor(){if(this.boxcolor)return this.boxcolor;if(LiteGraph.node_box_coloured_when_on){if(this.action_triggered)return"#FFF";if(this.execute_triggered)return"#AAA"}if(LiteGraph.node_box_coloured_by_mode){const t=LiteGraph.NODE_MODES_COLORS[this.mode??LGraphEventMode.ALWAYS];if(t)return t}return LiteGraph.NODE_DEFAULT_BOXCOLOR}setColorOption(t){t==null?(delete this.color,delete this.bgcolor):(this.color=t.color,this.bgcolor=t.bgcolor)}getColorOption(){return Object.values(LGraphCanvas.node_colors).find(t=>t.color===this.color&&t.bgcolor===this.bgcolor)??null}isSubgraphNode(){return!1}get renderArea(){return S(this,ne)}get boundingRect(){return S(this,se)}get boundingOffset(){const{pos:[t,i],boundingRect:[n,s]}=this;return[t-n,i-s]}get pos(){return this._pos}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return this._size}set size(t){!t||t.length<2||(this._size[0]=t[0],this._size[1]=t[1])}get renderingSize(){return this.flags.collapsed?[this._collapsed_width??0,0]:this._size}get shape(){return this._shape}set shape(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=RenderShape.BOX;break;case"round":this._shape=RenderShape.ROUND;break;case"circle":this._shape=RenderShape.CIRCLE;break;case"card":this._shape=RenderShape.CARD;break;default:this._shape=t}}get renderingShape(){return this._shape||this.constructor.shape||LiteGraph.NODE_DEFAULT_SHAPE}get is_selected(){return this.selected}set is_selected(t){this.selected=t}get title_mode(){return this.constructor.title_mode??TitleMode.NORMAL_TITLE}configure(t){var i,n,s,o,r,a,l,u,c,p;this.graph&&this.graph._version++;for(const f in t){if(f=="properties"){for(const g in t.properties)this.properties[g]=t.properties[g],(i=this.onPropertyChanged)==null||i.call(this,g,t.properties[g]);continue}t[f]!=null&&(typeof t[f]=="object"?(n=this[f])!=null&&n.configure?(s=this[f])==null||s.configure(t[f]):this[f]=LiteGraph.cloneObject(t[f],this[f]):this[f]=t[f])}t.title||(this.title=this.constructor.title),this.inputs??(this.inputs=[]),this.inputs=this.inputs.map(f=>toClass(NodeInputSlot,f,this));for(const[f,g]of this.inputs.entries()){const m=this.graph&&g.link!=null?this.graph._links.get(g.link):null;(o=this.onConnectionsChange)==null||o.call(this,NodeSlotType.INPUT,f,!0,m,g),(r=this.onInputAdded)==null||r.call(this,g)}this.outputs??(this.outputs=[]),this.outputs=this.outputs.map(f=>toClass(NodeOutputSlot,f,this));for(const[f,g]of this.outputs.entries())if(g.links){for(const m of g.links){const _=this.graph?this.graph._links.get(m):null;(a=this.onConnectionsChange)==null||a.call(this,NodeSlotType.OUTPUT,f,!0,_,g)}(l=this.onOutputAdded)==null||l.call(this,g)}if((u=this._internalConfigureAfterSlots)==null||u.call(this),this.widgets){for(const f of this.widgets)f&&(c=f.options)!=null&&c.property&&this.properties[f.options.property]!=null&&(f.value=JSON.parse(JSON.stringify(this.properties[f.options.property])));if(t.widgets_values){const f=this.widgets.filter(g=>g.serialize!==!1);for(let g=0;g<t.widgets_values.length;++g){const m=f[g];m&&(m.value=t.widgets_values[g])}}}this.pinned&&(this.resizable=!1),(p=this.onConfigure)==null||p.call(this,t)}serialize(){var n;const t={id:this.id,type:this.type,pos:[this.pos[0],this.pos[1]],size:[this.size[0],this.size[1]],flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode,showAdvanced:this.showAdvanced};if(this.constructor===it&&this.last_serialization)return this.last_serialization;this.inputs&&(t.inputs=this.inputs.map(s=>inputAsSerialisable(s))),this.outputs&&(t.outputs=this.outputs.map(s=>outputAsSerialisable(s))),this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties));const{widgets:i}=this;if(i&&this.serialize_widgets){t.widgets_values=[];for(const[s,o]of i.entries())o.serialize!==!1&&(t.widgets_values[s]=o?o.value:null)}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),(n=this.onSerialize)!=null&&n.call(this,t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){if(this.type==null)return null;const t=LiteGraph.createNode(this.type);if(!t)return null;const i=LiteGraph.cloneObject(this.serialize()),{inputs:n,outputs:s}=i;if(n)for(const o of n)o.link=null;if(s)for(const{links:o}of s)o&&(o.length=0);return delete i.id,LiteGraph.use_uuids&&(i.id=LiteGraph.uuidv4()),t.configure(i),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,i){var s;if(this.properties||(this.properties={}),i===this.properties[t])return;const n=this.properties[t];if(this.properties[t]=i,((s=this.onPropertyChanged)==null?void 0:s.call(this,t,i,n))===!1&&(this.properties[t]=n),this.widgets){for(const o of this.widgets)if(o&&o.options.property==t){o.value=i;break}}}setOutputData(t,i){const{outputs:n}=this;if(!n||t==-1||t>=n.length)return;const s=n[t];if(!s)return;if(s._data=i,!this.graph)throw new NullGraphError;const{links:o}=n[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.data=i)}}setOutputDataType(t,i){const{outputs:n}=this;if(!n||t==-1||t>=n.length)return;const s=n[t];if(!s)return;if(s.type=i,!this.graph)throw new NullGraphError;const{links:o}=n[t];if(o)for(const r of o){const a=this.graph._links.get(r);a&&(a.type=i)}}getInputData(t,i){var r;if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return;if(!this.graph)throw new NullGraphError;const n=this.inputs[t].link,s=this.graph._links.get(n);if(!s)return null;if(!i)return s.data;const o=this.graph.getNodeById(s.origin_id);return o&&(o.updateOutputData?o.updateOutputData(s.origin_slot):(r=o.onExecute)==null||r.call(o)),s.data}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;if(!this.graph)throw new NullGraphError;const i=this.inputs[t].link,n=this.graph._links.get(i);if(!n)return null;const s=this.graph.getNodeById(n.origin_id);if(!s)return n.type;const o=s.outputs[n.origin_slot];return o?o.type:null}getInputDataByName(t,i){const n=this.findInputSlot(t);return n==-1?null:this.getInputData(n,i)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return!this.inputs||!(t<this.inputs.length)?null:this.inputs[t]}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){if(!this.graph)throw new NullGraphError;const i=this.inputs[t];if(i.link!=null)return this.graph._links.get(i.link)??null}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;const i=this.inputs[t];if(!i||i.link===null)return null;if(!this.graph)throw new NullGraphError;const n=this.graph._links.get(i.link);return n?this.graph.getNodeById(n.origin_id):null}getInputOrProperty(t){const{inputs:i}=this;if(!(i!=null&&i.length))return this.properties?this.properties[t]:null;if(!this.graph)throw new NullGraphError;for(const n of i)if(t==n.name&&n.link!=null){const s=this.graph._links.get(n.link);if(s)return s.data}return this.properties[t]}getOutputData(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data}getOutputInfo(t){return!this.outputs||!(t<this.outputs.length)?null:this.outputs[t]}isOutputConnected(t){var i;return this.outputs?t<this.outputs.length&&Number((i=this.outputs[t].links)==null?void 0:i.length)>0:!1}isAnyOutputConnected(){var i;const{outputs:t}=this;if(!t)return!1;for(const n of t)if((i=n.links)!=null&&i.length)return!0;return!1}getOutputNodes(t){const{outputs:i}=this;if(!i||i.length==0||t>=i.length)return null;const{links:n}=i[t];if(!n||n.length==0)return null;if(!this.graph)throw new NullGraphError;const s=[];for(const o of n){const r=this.graph._links.get(o);if(r){const a=this.graph.getNodeById(r.target_id);a&&s.push(a)}}return s}addOnTriggerInput(){const t=this.findInputSlot("onTrigger");return t==-1?(this.addInput("onTrigger",LiteGraph.EVENT,{nameLocked:!0}),this.findInputSlot("onTrigger")):t}addOnExecutedOutput(){const t=this.findOutputSlot("onExecuted");return t==-1?(this.addOutput("onExecuted",LiteGraph.ACTION,{nameLocked:!0}),this.findOutputSlot("onExecuted")):t}onAfterExecuteNode(t,i){const n=this.findOutputSlot("onExecuted");n!=-1&&this.triggerSlot(n,t,null,i)}changeMode(t){switch(t){case LGraphEventMode.ON_EVENT:break;case LGraphEventMode.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LGraphEventMode.NEVER:break;case LGraphEventMode.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,i){var n;if(i=i||{},this.onExecute){if(i.action_call||(i.action_call=`${this.id}_exec_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_executing[this.id]=!0,this.onExecute(t,i),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,i!=null&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call)}this.execute_triggered=2,(n=this.onAfterExecuteNode)==null||n.call(this,t,i)}actionDo(t,i,n){var s;if(n=n||{},this.onAction){if(n.action_call||(n.action_call=`${this.id}_${t||"action"}_${Math.floor(Math.random()*9999)}`),!this.graph)throw new NullGraphError;this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,i,n),this.graph.nodes_actioning[this.id]=!1,n!=null&&n.action_call&&(this.action_call=n.action_call,this.graph.nodes_executedAction[this.id]=n.action_call)}this.action_triggered=2,(s=this.onAfterExecuteNode)==null||s.call(this,i,n)}trigger(t,i,n){const{outputs:s}=this;if(!(!s||!s.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(const[o,r]of s.entries())!r||r.type!==LiteGraph.EVENT||t&&r.name!=t||this.triggerSlot(o,i,null,n)}}triggerSlot(t,i,n,s){var a;if(s=s||{},!this.outputs)return;if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const o=this.outputs[t];if(!o)return;const r=o.links;if(!(!r||!r.length)){if(!this.graph)throw new NullGraphError;this.graph._last_trigger_time=LiteGraph.getTime();for(const l of r){if(n!=null&&n!=l)continue;const u=this.graph._links.get(l);if(!u)continue;u._last_time=LiteGraph.getTime();const c=this.graph.getNodeById(u.target_id);if(c){if(c.mode===LGraphEventMode.ON_TRIGGER)s.action_call||(s.action_call=`${this.id}_trigg_${Math.floor(Math.random()*9999)}`),(a=c.doExecute)==null||a.call(c,i,s);else if(c.onAction){s.action_call||(s.action_call=`${this.id}_act_${Math.floor(Math.random()*9999)}`);const p=c.inputs[u.target_slot];c.actionDo(p.name,i,s)}}}}}clearTriggeredSlot(t,i){if(!this.outputs)return;const n=this.outputs[t];if(!n)return;const s=n.links;if(!(!s||!s.length)){if(!this.graph)throw new NullGraphError;for(const o of s){if(i!=null&&i!=o)continue;const r=this.graph._links.get(o);r&&(r._last_time=0)}}}setSize(t){var i;this.size=t,(i=this.onResize)==null||i.call(this,this.size)}expandToFitContent(){const t=this.computeSize();this.setSize([Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])])}addProperty(t,i,n,s){const o={name:t,type:n,default_value:i};return s&&Object.assign(o,s),this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=i,o}addOutput(t,i,n){var o;const s=Object.assign(new NodeOutputSlot({name:t,type:i,links:null},this),n);return this.outputs||(this.outputs=[]),this.outputs.push(s),(o=this.onOutputAdded)==null||o.call(this,s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i,!0),this.expandToFitContent(),this.setDirtyCanvas(!0,!0),s}removeOutput(t){var n;this.disconnectOutput(t);const{outputs:i}=this;i.splice(t,1);for(let s=t;s<i.length;++s){const o=i[s];if(!(!o||!o.links))for(const r of o.links){if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r);a&&a.origin_slot--}}(n=this.onOutputRemoved)==null||n.call(this,t),this.setDirtyCanvas(!0,!0)}addInput(t,i,n){var o;i||(i=0);const s=Object.assign(new NodeInputSlot({name:t,type:i,link:null},this),n);return this.inputs||(this.inputs=[]),this.inputs.push(s),this.expandToFitContent(),(o=this.onInputAdded)==null||o.call(this,s),LiteGraph.registerNodeAndSlotType(this,i),this.setDirtyCanvas(!0,!0),s}removeInput(t){var s;this.disconnectInput(t,!0);const{inputs:i}=this,n=i.splice(t,1);for(let o=t;o<i.length;++o){const r=i[o];if(!(r!=null&&r.link))continue;if(!this.graph)throw new NullGraphError;const a=this.graph._links.get(r.link);a&&a.target_slot--}(s=this.onInputRemoved)==null||s.call(this,t,n[0]),this.setDirtyCanvas(!0,!0)}computeSize(t){const i=this.constructor.size;if(i)return[i[0],i[1]];const{inputs:n,outputs:s,widgets:o}=this;let r=Math.max(n?n.filter(E=>!isWidgetInputSlot(E)).length:1,s?s.length:1);const a=t||new Float32Array([0,0]);r=Math.max(r,1);const l=LiteGraph.NODE_TEXT_SIZE,u=LiteGraph.NODE_TITLE_HEIGHT,c=u*.33,p=u+I(this.title,this.titleFontStyle)+c;let f=0,g=0,m=0;if(n)for(const E of n){const G=E.label||E.localized_name||E.name||"",R=I(G,this.innerFontStyle);if(isWidgetInputSlot(E)){const N=this.getWidgetFromSlot(E);if(N&&!this.isWidgetVisible(N))continue;R>g&&(g=R)}else R>f&&(f=R)}if(s)for(const E of s){const G=E.label||E.localized_name||E.name||"",R=I(G,this.innerFontStyle);m<R&&(m=R)}const _=LiteGraph.NODE_WIDTH*(o!=null&&o.length?1.5:1),y=f&&m?5:0,b=f+m+2*LiteGraph.NODE_SLOT_HEIGHT+y,k=BaseWidget.margin+BaseWidget.arrowMargin+BaseWidget.arrowWidth,w=BaseWidget.minValueWidth+2*k;g&&(g+=w),a[0]=Math.max(b,g,p,_),a[1]=(this.constructor.slot_start_y||0)+r*LiteGraph.NODE_SLOT_HEIGHT;let T=0;if(o!=null&&o.length){for(const E of o){if(!this.isWidgetVisible(E))continue;let G=0;if(E.computeSize)G+=E.computeSize(a[0])[1];else if(E.computeLayoutSize){const{minHeight:R,minWidth:N}=E.computeLayoutSize(this),D=N+w;D>a[0]&&(a[0]=D),G+=R}else G+=LiteGraph.NODE_WIDGET_HEIGHT;T+=G+4}T+=8}this.widgets_up?a[1]=Math.max(a[1],T):this.widgets_start_y!=null?a[1]=Math.max(a[1],T+this.widgets_start_y):a[1]+=T;function I(E,G){var R;return((R=LGraphCanvas._measureText)==null?void 0:R.call(LGraphCanvas,E,G))??l*((E==null?void 0:E.length)??0)*.6}return this.constructor.min_height&&a[1]<this.constructor.min_height&&(a[1]=this.constructor.min_height),a[1]+=6,a}inResizeCorner(t,i){const n=this.outputs?this.outputs.length:1,s=(this.constructor.slot_start_y||0)+n*LiteGraph.NODE_SLOT_HEIGHT;return isInRectangle(t,i,this.pos[0]+this.size[0]-15,this.pos[1]+Math.max(this.size[1]-15,s),20,20)}findResizeDirection(t,i){if(this.resizable===!1)return;const{boundingRect:n}=this;if(n.containsXy(t,i))return n.findContainingCorner(t,i,it.resizeHandleSize)}getPropertyInfo(t){var s;let i=null;const{properties_info:n}=this;if(n){for(const o of n)if(o.name==t){i=o;break}}return this.constructor[`@${t}`]&&(i=this.constructor[`@${t}`]),(s=this.constructor.widgets_info)!=null&&s[t]&&(i=this.constructor.widgets_info[t]),!i&&this.onGetPropertyInfo&&(i=this.onGetPropertyInfo(t)),i||(i={}),i.type||(i.type=typeof this.properties[t]),i.widget=="combo"&&(i.type="enum"),i}addWidget(t,i,n,s,o){this.widgets||(this.widgets=[]),!o&&s&&typeof s=="object"&&(o=s,s=null),o||(o={}),typeof o=="string"&&(o={property:o}),s&&typeof s=="string"&&(o.property=s,s=null);const r={type:t.toLowerCase(),name:i,value:n,callback:typeof s!="function"?void 0:s,options:o,y:0};if(r.options.y!==void 0&&(r.y=r.options.y),!s&&!r.options.callback&&!r.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!r.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";const a=this.addCustomWidget(r);return this.expandToFitContent(),a}addCustomWidget(t){this.widgets||(this.widgets=[]);const i=toConcreteWidget(t,this,!1)??t;return this.widgets.push(i),i}addTitleButton(t){this.title_buttons||(this.title_buttons=[]);const i=new LGraphButton(t);return this.title_buttons.push(i),i}onTitleButtonClick(t,i){i.dispatch("litegraph:node-title-button-clicked",{node:this,button:t})}removeWidgetByName(t){var n;const i=(n=this.widgets)==null?void 0:n.find(s=>s.name===t);i&&this.removeWidget(i)}removeWidget(t){if(!this.widgets)throw new Error("removeWidget called on node without widgets");const i=this.widgets.indexOf(t);if(i===-1)throw new Error("Widget not found on this node");if(this.inputs)for(const n of this.inputs)n._widget===t&&(n._widget=void 0,delete n.widget);this.widgets.splice(i,1)}ensureWidgetRemoved(t){try{this.removeWidget(t)}catch(i){console.debug("Failed to remove widget",i)}}move(t,i){this.pinned||(this.pos[0]+=t,this.pos[1]+=i)}measure(t,i){var r;const n=this.title_mode,o=n!=TitleMode.TRANSPARENT_TITLE&&n!=TitleMode.NO_TITLE?LiteGraph.NODE_TITLE_HEIGHT:0;t[0]=this.pos[0],t[1]=this.pos[1]+-o,(r=this.flags)!=null&&r.collapsed?(i.font=this.innerFontStyle,this._collapsed_width=Math.min(this.size[0],i.measureText(this.getTitle()??"").width+LiteGraph.NODE_TITLE_HEIGHT*2),t[2]=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,t[3]=LiteGraph.NODE_TITLE_HEIGHT):(t[2]=this.size[0],t[3]=this.size[1]+o)}getBounding(t,i){t||(t=new Float32Array(4));const n=i?this.renderArea:this.boundingRect;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}updateArea(t){var s;const i=S(this,se);this.measure(i,t),(s=this.onBounding)==null||s.call(this,i);const n=S(this,ne);n.set(i),n[0]-=4,n[1]-=4,n[2]+=10,n[3]+=9}isPointInside(t,i){return isInRect(t,i,this.boundingRect)}isPointInCollapse(t,i){const n=LiteGraph.NODE_TITLE_HEIGHT;return isInRectangle(t,i,this.pos[0],this.pos[1]-n,n,n)}getInputOnPos(t){var i;return(i=getNodeInputOnPos(this,t[0],t[1]))==null?void 0:i.input}getOutputOnPos(t){var i;return(i=getNodeOutputOnPos(this,t[0],t[1]))==null?void 0:i.output}getSlotOnPos(t){if(isPointInRect(t,this.boundingRect))return this.getInputOnPos(t)??this.getOutputOnPos(t)}getSlotInPosition(t,i){const{inputs:n,outputs:s}=this;if(n)for(const[o,r]of n.entries()){const a=this.getInputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{input:r,slot:o,link_pos:a}}if(s)for(const[o,r]of s.entries()){const a=this.getOutputPos(o);if(isInRectangle(t,i,a[0]-10,a[1]-10,20,20))return{output:r,slot:o,link_pos:a}}return null}getWidgetOnPos(t,i,n=!1){var c;const{widgets:s,pos:o,size:r}=this;if(!(s!=null&&s.length))return;const a=t-o[0],l=i-o[1],u=r[0];for(const p of s){if(p.computedDisabled&&!n||!this.isWidgetVisible(p))continue;const f=p.computedHeight??((c=p.computeSize)==null?void 0:c.call(p,u)[1])??LiteGraph.NODE_WIDGET_HEIGHT,g=p.width||u;if(p.last_y!==void 0&&isInRectangle(a,l,6,p.last_y,g-12,f))return p}}findInputSlot(t,i=!1){const{inputs:n}=this;if(!n)return-1;for(const[s,o]of n.entries())if(t==o.name)return i?o:s;return-1}findOutputSlot(t,i=!1){const{outputs:n}=this;if(!n)return-1;for(const[s,o]of n.entries())if(t==o.name)return i?o:s;return-1}findInputSlotFree(t){return C(this,$,He).call(this,this.inputs,t)}findOutputSlotFree(t){return C(this,$,He).call(this,this.outputs,t)}findInputSlotByType(t,i,n,s){return C(this,$,me).call(this,this.inputs,t,i,n,s)}findOutputSlotByType(t,i,n,s){return C(this,$,me).call(this,this.outputs,t,i,n,s)}findSlotByType(t,i,n,s,o){return t?C(this,$,me).call(this,this.inputs,i,n,s,o):C(this,$,me).call(this,this.outputs,i,n,s,o)}findConnectByTypeSlot(t,i,n,s){s&&typeof s=="object"&&("firstFreeIfInputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfInputGeneralInCase),"firstFreeIfOutputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfOutputGeneralInCase),"generalTypeInCase"in s&&(s.typedToWildcard=!!s.generalTypeInCase));const r=Object.assign({createEventInCase:!0,wildcardToTyped:!0,typedToWildcard:!0},s);if(!this.graph)throw new NullGraphError;if(i&&typeof i=="number"){const l=this.graph.getNodeById(i);if(!l)return;i=l}const a=i.findSlotByType(t,n,!1,!0);if(a>=0&&a!==null)return a;if(r.createEventInCase&&n==LiteGraph.EVENT){if(t)return-1;if(LiteGraph.do_add_triggers_slots)return i.addOnExecutedOutput()}if(r.typedToWildcard){const l=i.findSlotByType(t,0,!1,!0,!0);if(l>=0)return l}if(r.wildcardToTyped&&(n==0||n=="*"||n=="")){const l={typesNotAccepted:[LiteGraph.EVENT]},u=t?i.findInputSlotFree(l):i.findOutputSlotFree(l);if(u>=0)return u}}findOutputByType(t){return findFreeSlotOfType(this.outputs,t,i=>{var n;return!((n=i.links)!=null&&n.length)})}findInputByType(t){return findFreeSlotOfType(this.inputs,t,i=>i.link==null)}connectByType(t,i,n,s){const o=this.findConnectByTypeSlot(!0,i,n,s);return o!==void 0?this.connect(t,i,o,s==null?void 0:s.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",n,"to node:",i),null)}connectByTypeOutput(t,i,n,s){typeof s=="object"&&("firstFreeIfInputGeneralInCase"in s&&(s.wildcardToTyped=!!s.firstFreeIfInputGeneralInCase),"generalTypeInCase"in s&&(s.typedToWildcard=!!s.generalTypeInCase));const o=this.findConnectByTypeSlot(!1,i,n,s);return o!==void 0?i.connect(o,this,t,s==null?void 0:s.afterRerouteId):(console.debug("[connectByType]: no way to connect type:",n,"to node:",i),null)}canConnectTo(t,i,n){return this.id!==t.id&&LiteGraph.isValidConnection(n.type,i.type)}connect(t,i,n,s){var p;let o;const{graph:r,outputs:a}=this;if(!r)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),null}else if(!a||t>=a.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(i&&typeof i=="number"){const f=r.getNodeById(i);if(!f)throw"target node is null";i=f}if(!i)throw"target node is null";if(i==this)return null;if(typeof n=="string"){if(o=i.findInputSlot(n),o==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${o}`),null}else if(n===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)i.changeMode(LGraphEventMode.ON_TRIGGER),o=i.findInputSlot("onTrigger");else return null;else typeof n=="number"?o=n:o=0;if(i.onBeforeConnectInput){const f=i.onBeforeConnectInput(o,n);o=typeof f=="number"?f:null}if(o===null||!i.inputs||o>=i.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;const l=i.inputs[o],u=a[t];return u?((p=u.links)!=null&&p.length&&u.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(r.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1})),this.connectSlots(u,i,l,s)??null):null}connectSlots(t,i,n,s){var p,f,g,m,_;const{graph:o}=this;if(!o)throw new NullGraphError;const r=this.outputs.indexOf(t);if(r===-1){console.warn("connectSlots: output not found");return}const a=i.inputs.indexOf(n);if(a===-1){console.warn("connectSlots: input not found");return}if(!LiteGraph.isValidConnection(t.type,n.type))return this.setDirtyCanvas(!1,!0),null;if(((p=i.onConnectInput)==null?void 0:p.call(i,a,t.type,t,this,r))===!1||((f=this.onConnectOutput)==null?void 0:f.call(this,r,n.type,n,i,a))===!1)return null;((g=i.inputs[a])==null?void 0:g.link)!=null&&(o.beforeChange(),i.disconnectInput(a,!0));const l=new LLink(++o.state.lastLinkId,n.type||t.type,this.id,r,i.id,a,s);o._links.set(l.id,l),t.links??(t.links=[]),t.links.push(l.id),i.inputs[a].link=l.id;const u=LLink.getReroutes(o,l);for(const y of u)y.linkIds.add(l.id),y.floating&&delete y.floating,y._dragging=void 0;const c=u.at(-1);if(c)for(const y of c.floatingLinkIds){const b=o.floatingLinks.get(y);(b==null?void 0:b.parentId)===c.id&&o.removeFloatingLink(b)}return o._version++,(m=this.onConnectionsChange)==null||m.call(this,NodeSlotType.OUTPUT,r,!0,l,t),(_=i.onConnectionsChange)==null||_.call(i,NodeSlotType.INPUT,a,!0,l,n),this.setDirtyCanvas(!1,!0),o.afterChange(),l}connectFloatingReroute(t,i,n){var g,m;const{graph:s,id:o}=this;if(!s)throw new NullGraphError;const r=this.inputs.indexOf(i),a=this.outputs.indexOf(i);if(r===-1&&a===-1)throw new Error("Invalid slot");const l=a===-1?"input":"output",u=s.setReroute({pos:t,parentId:n,linkIds:[],floating:{slotType:l}}),c=s.getReroute(n),p=((g=c==null?void 0:c.floating)==null?void 0:g.slotType)==="output";if(n==null||!p){const _=new LLink(-1,i.type,a===-1?-1:o,a,r===-1?-1:o,r);return _.parentId=u.id,s.addFloatingLink(_),u}if(!c)throw new Error("[connectFloatingReroute] Parent reroute not found");const f=(m=c.getFloatingLinks("output"))==null?void 0:m[0];if(!f)throw new Error("[connectFloatingReroute] Floating link not found");return u.floatingLinkIds.add(f.id),f.parentId=u.id,delete c.floating,u}disconnectOutput(t,i){var r,a,l,u,c;if(typeof t=="string"){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const n=this.outputs[t];if(!n)return!1;if(n._floatingLinks)for(const p of n._floatingLinks)p.hasOrigin(this.id,t)&&((r=this.graph)==null||r.removeFloatingLink(p));if(!n.links||n.links.length==0)return!1;const{links:s}=n,o=this.graph;if(!o)throw new NullGraphError;if(i){const p=typeof i=="number"?o.getNodeById(i):i;if(!p)throw"Target Node not found";for(const[f,g]of s.entries()){const m=o._links.get(g);if((m==null?void 0:m.target_id)!=p.id)continue;s.splice(f,1);const _=p.inputs[m.target_slot];_.link=null,m.disconnect(o,"input"),o._version++,(a=p.onConnectionsChange)==null||a.call(p,NodeSlotType.INPUT,m.target_slot,!1,m,_),(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.OUTPUT,t,!1,m,n);break}}else{for(const p of s){const f=o._links.get(p);if(!f)continue;const g=o.getNodeById(f.target_id);if(o._version++,g){const m=g.inputs[f.target_slot];m.link=null,(u=g.onConnectionsChange)==null||u.call(g,NodeSlotType.INPUT,f.target_slot,!1,f,m)}f.disconnect(o,"input"),(c=this.onConnectionsChange)==null||c.call(this,NodeSlotType.OUTPUT,t,!1,f,n)}n.links=null}return this.setDirtyCanvas(!1,!0),!0}disconnectInput(t,i){var r,a,l,u;if(typeof t=="string"){if(t=this.findInputSlot(t),t==-1)return LiteGraph.debug&&console.log(`Connect: Error, no slot of name ${t}`),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const n=this.inputs[t];if(!n)return console.debug("disconnectInput: input not found",t,this.inputs),!1;const{graph:s}=this;if(!s)throw new NullGraphError;if((r=n._floatingLinks)!=null&&r.size)for(const c of n._floatingLinks)s.removeFloatingLink(c);const o=this.inputs[t].link;if(o!=null){this.inputs[t].link=null;const c=s._links.get(o);if(c){if(c.origin_id===-10&&"inputNode"in s)return s.inputNode._disconnectNodeInput(this,n,c),!0;const p=s.getNodeById(c.origin_id);if(!p)return console.debug("disconnectInput: target node not found",c.origin_id),!1;const f=p.outputs[c.origin_slot];if(!((a=f==null?void 0:f.links)!=null&&a.length))return console.debug("disconnectInput: output not found",c.origin_slot),!1;let g=0;for(const m=f.links.length;g<m;g++)if(f.links[g]==o){f.links.splice(g,1);break}c.disconnect(s,i?"output":void 0),s&&s._version++,(l=this.onConnectionsChange)==null||l.call(this,NodeSlotType.INPUT,t,!1,c,n),(u=p.onConnectionsChange)==null||u.call(p,NodeSlotType.OUTPUT,g,!1,c,f)}}return this.setDirtyCanvas(!1,!0),!0}getConnectionPos(t,i,n){var f,g;n||(n=new Float32Array(2));const{pos:[s,o],inputs:r,outputs:a}=this;if(this.flags.collapsed){const m=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return n[0]=t?s:s+m,n[1]=o-LiteGraph.NODE_TITLE_HEIGHT*.5,n}if(t&&i==-1)return n[0]=s+LiteGraph.NODE_TITLE_HEIGHT*.5,n[1]=o+LiteGraph.NODE_TITLE_HEIGHT*.5,n;const l=(f=r==null?void 0:r[i])==null?void 0:f.pos,u=(g=a==null?void 0:a[i])==null?void 0:g.pos;if(t&&l)return n[0]=s+l[0],n[1]=o+l[1],n;if(!t&&u)return n[0]=s+u[0],n[1]=o+u[1],n;const c=LiteGraph.NODE_SLOT_HEIGHT*.5,p=t?S(this,$,Ue).indexOf(this.inputs[i]):S(this,$,Ve).indexOf(this.outputs[i]);return n[0]=t?s+c:s+this.size[0]+1-c,n[1]=o+(p+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n}getInputPos(t){return this.getInputSlotPos(this.inputs[t])}getInputSlotPos(t){const{pos:[i,n]}=this;if(this.flags.collapsed){const u=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i,n-u]}const{pos:s}=t;if(s)return[i+s[0],n+s[1]];const o=LiteGraph.NODE_SLOT_HEIGHT*.5,r=this.constructor.slot_start_y||0,l=(S(this,$,Ue).indexOf(t)+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o,n+l+r]}getOutputPos(t){var p;const{pos:[i,n],outputs:s,size:[o]}=this;if(this.flags.collapsed){const f=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,g=LiteGraph.NODE_TITLE_HEIGHT*.5;return[i+f,n-g]}const r=(p=s==null?void 0:s[t])==null?void 0:p.pos;if(r)return[i+r[0],n+r[1]];const a=LiteGraph.NODE_SLOT_HEIGHT*.5,l=this.constructor.slot_start_y||0,c=(S(this,$,Ve).indexOf(this.outputs[t])+.7)*LiteGraph.NODE_SLOT_HEIGHT;return[i+o+1-a,n+c+l]}snapToGrid(t){return this.pinned?!1:snapPoint(this.pos,t)}alignToGrid(){this.snapToGrid(LiteGraph.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>it.MAX_CONSOLE&&this.console.shift()}setDirtyCanvas(t,i){var n;(n=this.graph)==null||n.canvasAction(s=>s.setDirty(t,i))}loadImage(t){const i=new Image;i.src=LiteGraph.node_images_path+t,i.ready=!1;const n=()=>this.setDirtyCanvas(!0);return i.addEventListener("load",function(){this.ready=!0,n()}),i}captureInput(t){if(warnDeprecated("[DEPRECATED] captureInput will be removed in a future version. Please use LGraphCanvas.pointer (CanvasPointer) instead."),!this.graph||!this.graph.list_of_graphcanvas)return;const i=this.graph.list_of_graphcanvas;for(const n of i)!t&&n.node_capturing_input!=this||(n.node_capturing_input=t?this:null)}get collapsed(){return!!this.flags.collapsed}get collapsible(){return!this.pinned&&this.constructor.collapsable!==!1}collapse(t){if(!(!this.collapsible&&!t)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.collapsed=!this.flags.collapsed,this.setDirtyCanvas(!0,!0)}}toggleAdvanced(){var t;if((t=this.widgets)!=null&&t.some(i=>i.advanced)){if(!this.graph)throw new NullGraphError;this.graph._version++,this.showAdvanced=!this.showAdvanced,this.expandToFitContent(),this.setDirtyCanvas(!0,!0)}}get pinned(){return!!this.flags.pinned}pin(t){if(!this.graph)throw new NullGraphError;this.graph._version++,this.flags.pinned=t??!this.flags.pinned,this.resizable=!this.pinned,this.pinned||delete this.flags.pinned}unpin(){this.pin(!1)}localToScreen(t,i,n){return[(t+this.pos[0])*n.scale+n.offset[0],(i+this.pos[1])*n.scale+n.offset[1]]}get width(){return this.collapsed?this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH:this.size[0]}get height(){return LiteGraph.NODE_TITLE_HEIGHT+this.bodyHeight}get bodyHeight(){return this.collapsed?0:this.size[1]}drawBadges(t,{gap:i=2}={}){const n=this.badges.map(a=>a instanceof LGraphBadge?a:a());let o=this.badgePosition===BadgePosition.TopLeft?0:this.width-n.reduce((a,l)=>a+l.getWidth(t)+i,0);const r=-(LiteGraph.NODE_TITLE_HEIGHT+i);for(const a of n)a.draw(t,o,r-a.height),o+=a.getWidth(t)+i}drawTitleBarBackground(t,{scale:i,title_height:n=LiteGraph.NODE_TITLE_HEIGHT,low_quality:s=!1}){const o=this.renderingColor,r=this.renderingShape,a=this.renderingSize;if(this.onDrawTitleBar){this.onDrawTitleBar(t,n,a,i,o);return}this.title_mode!==TitleMode.TRANSPARENT_TITLE&&(this.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),t.fillStyle=this.constructor.title_color||o,t.beginPath(),r==RenderShape.BOX||s?t.rect(0,-n,a[0],n):(r==RenderShape.ROUND||r==RenderShape.CARD)&&t.roundRect(0,-n,a[0],n,this.collapsed?[LiteGraph.ROUND_RADIUS]:[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]),t.fill(),t.shadowColor="transparent")}drawTitleBox(t,{scale:i,low_quality:n=!1,title_height:s=LiteGraph.NODE_TITLE_HEIGHT,box_size:o=10}){const r=this.renderingSize,a=this.renderingShape;if(this.onDrawTitleBox){this.onDrawTitleBox(t,s,r,i);return}[RenderShape.ROUND,RenderShape.CIRCLE,RenderShape.CARD].includes(a)?(n&&(t.fillStyle="black",t.beginPath(),t.arc(s*.5,s*-.5,o*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=this.renderingBoxColor,n?t.fillRect(s*.5-o*.5,s*-.5-o*.5,o,o):(t.beginPath(),t.arc(s*.5,s*-.5,o*.5,0,Math.PI*2),t.fill())):(n&&(t.fillStyle="black",t.fillRect((s-o)*.5-1,(s+o)*-.5-1,o+2,o+2)),t.fillStyle=this.renderingBoxColor,t.fillRect((s-o)*.5,(s+o)*-.5,o,o))}drawTitleText(t,{scale:i,default_title_color:n,low_quality:s=!1,title_height:o=LiteGraph.NODE_TITLE_HEIGHT}){var c;const r=this.renderingSize,a=this.selected;if(this.onDrawTitleText){this.onDrawTitleText(t,o,r,i,this.titleFontStyle,a);return}if(s)return;t.font=this.titleFontStyle;const l=this.getTitle()??`âŒ ${this.type}`,u=String(l)+(this.pinned?"ðŸ“Œ":"");if(u){a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=this.constructor.title_text_color||n;let p=r[0]-o*2;if(((c=this.title_buttons)==null?void 0:c.length)>0){let g=0;const m=t.font;for(const _ of this.title_buttons)_.visible&&(g+=_.getWidth(t)+2);t.font=m,g>0&&(g+=10,p-=g)}let f=u;this.collapsed?f=u.substr(0,20):p>0&&(f=truncateText(t,u,p)),t.textAlign="left",t.fillText(f,o,LiteGraph.NODE_TITLE_TEXT_Y-o)}}connectInputToOutput(){const{inputs:t,outputs:i,graph:n}=this;if(!t||!i)return;if(!n)throw new NullGraphError;const{_links:s}=n;let o=!1;for(const[a,l]of t.entries()){if(l.link==null)continue;const u=i[a];if(!u||!LiteGraph.isValidConnection(l.type,u.type))continue;const c=s.get(l.link);if(!c)continue;const p=n.getNodeById(c==null?void 0:c.origin_id);p&&r(u,p,c,n)}if(!(this.flags.keepAllLinksOnBypass??it.keepAllLinksOnBypass))return o;for(const a of t){if(a.link==null)continue;const l=s.get(a.link);if(!l)continue;const u=n.getNodeById(l==null?void 0:l.origin_id);if(u){for(const c of i)if(LiteGraph.isValidConnection(a.type,c.type)){r(c,u,l,n);break}}}return o;function r(a,l,u,c){var f;const p=(f=a.links)==null?void 0:f.map(g=>s.get(g)).filter(g=>!!g);if(p!=null&&p.length)for(const g of p){const m=c.getNodeById(g.target_id);if(!m)continue;const _=l.connect(u.origin_slot,m,g.target_slot,u.parentId);o||(o=!!_)}}}isWidgetVisible(t){return!(this.collapsed||t.hidden||t.advanced&&!this.showAdvanced)}drawWidgets(t,{lowQuality:i=!1,editorAlpha:n=1}){var l,u;if(!this.widgets)return;const s=this.size[0],{widgets:o}=this,r=LiteGraph.NODE_WIDGET_HEIGHT,a=!i;t.save(),t.globalAlpha=n;for(const c of o){if(!this.isWidgetVisible(c))continue;const{y:p}=c,f=c.advanced?LiteGraph.WIDGET_ADVANCED_OUTLINE_COLOR:LiteGraph.WIDGET_OUTLINE_COLOR;c.last_y=p,c.computedDisabled=c.disabled||((l=this.getSlotFromWidget(c))==null?void 0:l.link)!=null,t.strokeStyle=f,t.fillStyle="#222",t.textAlign="left",c.computedDisabled&&(t.globalAlpha*=.5);const g=c.width||s;typeof c.draw=="function"?c.draw(t,this,g,p,r,i):(u=toConcreteWidget(c,this,!1))==null||u.drawWidget(t,{width:g,showText:a}),t.globalAlpha=n}t.restore()}drawCollapsedSlots(t){var i;for(const n of S(this,yt))if(n.link!=null){n.drawCollapsed(t);break}for(const n of S(this,St))if((i=n.links)!=null&&i.length){n.drawCollapsed(t);break}}get slots(){return[...this.inputs,...this.outputs]}getSlotFromWidget(t){if(t)return this.inputs.find(i=>isWidgetInputSlot(i)&&i.widget.name===t.name)}getWidgetFromSlot(t){var i;if(isWidgetInputSlot(t))return(i=this.widgets)==null?void 0:i.find(n=>n.name===t.widget.name)}drawSlots(t,{fromSlot:i,colorContext:n,editorAlpha:s,lowQuality:o}){for(const r of[...S(this,yt),...S(this,St)]){const a=i&&r.isValidTarget(i),l=C(this,$,ci).call(this,r),u=!i||a,c=u&&l;(l||a||!r.isWidgetInputSlot||C(this,$,di).call(this,this.getWidgetFromSlot(r))||r.isConnected)&&(t.globalAlpha=u?s:.4*s,r.draw(t,{colorContext:n,lowQuality:o,highlight:c}))}}_setConcreteSlots(){H(this,yt,this.inputs.map(t=>toClass(NodeInputSlot,t,this))),H(this,St,this.outputs.map(t=>toClass(NodeOutputSlot,t,this)))}arrange(){const t=C(this,$,hi).call(this),i=t?t[1]+t[3]-this.pos[1]:0;C(this,$,pi).call(this,i),C(this,$,fi).call(this)}drawProgressBar(t){if(!this.progress)return;const i=t.fillStyle;t.fillStyle="green",t.fillRect(0,0,this.width*this.progress,6),t.fillStyle=i}};yt=new WeakMap,St=new WeakMap,ne=new WeakMap,se=new WeakMap,$=new WeakSet,ai=function(){if(this.has_errors)return{padding:12,lineWidth:10,color:LiteGraph.NODE_ERROR_COLOUR}},li=function(){if(this.selected)return{padding:this.has_errors?20:void 0}},He=function(t,i){var r,a,l;const s=Object.assign({returnObj:!1,typesNotAccepted:[]},i||{}),o=t==null?void 0:t.length;if(!(o>0))return-1;for(let u=0;u<o;++u){const c=t[u];if(!(!c||c.link||(r=c.links)!=null&&r.length)&&!((l=(a=s.typesNotAccepted)==null?void 0:a.includes)!=null&&l.call(a,c.type)))return s.returnObj?c:u}return-1},me=function(t,i,n,s,o){var u;const r=t==null?void 0:t.length;if(!r)return-1;(i==""||i=="*")&&(i=0);const a=String(i).toLowerCase().split(",");let l=null;for(let c=0;c<r;++c){const p=t[c],f=p.type=="0"||p.type=="*"?["0"]:String(p.type).toLowerCase().split(",");for(const g of a){const m=g=="_event_"?LiteGraph.EVENT:g;for(const _ of f){const y=_=="_event_"?LiteGraph.EVENT:_;if(m==y||m==="*"||y==="*"){if(s&&((u=p.links)!=null&&u.length||p.link!=null)){l??(l=n?p:c);continue}return n?p:c}}}}return o?-1:l??-1},Ue=function(){return this.inputs.filter(t=>{var i;return!t.pos&&!((i=this.widgets)!=null&&i.length&&isWidgetInputSlot(t))})},Ve=function(){return this.outputs.filter(t=>!t.pos)},Ge=function(t,i,n){const s=n?this.getInputPos(i):this.getOutputPos(i);t.boundingRect[0]=s[0]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[1]=s[1]-LiteGraph.NODE_SLOT_HEIGHT*.5,t.boundingRect[2]=t.isWidgetInputSlot?BaseWidget.margin:LiteGraph.NODE_SLOT_HEIGHT,t.boundingRect[3]=LiteGraph.NODE_SLOT_HEIGHT},hi=function(){var i;const t=[];for(const[n,s]of S(this,yt).entries())(i=this.widgets)!=null&&i.length&&isWidgetInputSlot(s)||(C(this,$,Ge).call(this,s,n,!0),t.push(s));for(const[n,s]of S(this,St).entries())C(this,$,Ge).call(this,s,n,!1),t.push(s);return t.length?createBounds(t,0):null},ui=function(t){var s;const i=isINodeInputSlot(t),n=((s=this.mouseOver)==null?void 0:s[i?"inputId":"outputId"])??-1;return n===-1?null:i?this.inputs[n]:this.outputs[n]},ci=function(t){return C(this,$,ui).call(this,t)===t},di=function(t){var i;return t?((i=this.mouseOver)==null?void 0:i.overWidget)===t:!1},pi=function(t){if(!this.widgets||!this.widgets.length)return;const i=this.bodyHeight,n=this.widgets_start_y??(this.widgets_up?0:t)+2;let s=i-n,o=0;const r=[];for(const c of this.widgets)if(c.computeSize){const p=c.computeSize()[1]+4;c.computedHeight=p,o+=p}else if(c.computeLayoutSize){const{minHeight:p,maxHeight:f}=c.computeLayoutSize(this);r.push({minHeight:p,prefHeight:f,w:c})}else{const p=LiteGraph.NODE_WIDGET_HEIGHT+4;c.computedHeight=p,o+=p}s-=o,this.freeWidgetSpace=s;const a=r.map(c=>({minSize:c.minHeight,maxSize:c.prefHeight})),l=distributeSpace(Math.max(0,s),a);for(const[c,p]of r.entries())p.w.computedHeight=l[c];let u=n;for(const c of this.widgets)c.y=u,u+=c.computedHeight??0;if(!this.graph)throw new NullGraphError;u>i&&(this.setSize([this.size[0],u]),this.graph.setDirtyCanvas(!1,!0))},fi=function(){if(!this.widgets)return;const t=new Map;for(const[i,n]of this.inputs.entries())isWidgetInputSlot(n)&&t.set(n.widget.name,{...n,index:i});if(t.size)for(const i of this.widgets){const n=t.get(i.name);if(!n)continue;const s=S(this,yt)[n.index],o=LiteGraph.NODE_SLOT_HEIGHT*.5;s.pos=[o,i.y+o],C(this,$,Ge).call(this,s,n.index,!0)}},h(it,"title"),h(it,"MAX_CONSOLE"),h(it,"type"),h(it,"category"),h(it,"filter"),h(it,"skip_list"),h(it,"resizeHandleSize",15),h(it,"resizeEdgeSize",5),h(it,"keepAllLinksOnBypass",!1);let LGraphNode=it;function getAllNestedItems(d){const t=new Set;if(d)for(const n of d)i(n,t);return t;function i(n,s){if(!(s.has(n)||n.pinned)&&(s.add(n),n.children))for(const o of n.children)i(o,s)}}function findFirstNode(d){for(const t of d)if(t instanceof LGraphNode)return t}function findFreeSlotOfType(d,t,i){if(!(d!=null&&d.length))return;let n,s,o;const r=parseSlotTypes(t);for(const[a,l]of d.entries()){const u=parseSlotTypes(l.type);for(const c of r)for(const p of u)if(p===c){if(i(l))return{index:a,slot:l};n??(n={index:a,slot:l})}else!s&&(c==="*"||p==="*")&&(i(l)?s={index:a,slot:l}:o??(o={index:a,slot:l}))}return s??n??o}function removeFromArray(d,t){const i=d.indexOf(t),n=i!==-1;return n&&d.splice(i,1),n}class SubgraphInput extends SubgraphSlot{constructor(){super(...arguments);h(this,"events",new CustomEventTarget);W(this,Vt)}get _widget(){var i;return(i=S(this,Vt))==null?void 0:i.deref()}set _widget(i){H(this,Vt,i?new WeakRef(i):void 0)}connect(i,n,s){var p,f;const{subgraph:o}=this.parent,r=n.inputs.indexOf(i);if(((p=n.onConnectInput)==null?void 0:p.call(n,r,this.type,this,this.parent,-1))===!1)return;if(i.link!=null){o.beforeChange();const g=o.getLink(i.link);this.parent._disconnectNodeInput(n,i,g)}const a=n.getWidgetFromSlot(i);if(a){if(!this.matchesWidget(a)){console.warn("Target input has invalid widget.",i,n);return}this._widget??(this._widget=a),this.events.dispatch("input-connected",{input:i,widget:a})}const l=new LLink(++o.state.lastLinkId,i.type,this.parent.id,this.parent.slots.indexOf(this),n.id,r,s);o._links.set(l.id,l),this.linkIds.push(l.id),i.link=l.id;const u=LLink.getReroutes(o,l);for(const g of u)g.linkIds.add(l.id),g.floating&&delete g.floating,g._dragging=void 0;const c=u.at(-1);if(c)for(const g of c.floatingLinkIds){const m=o.floatingLinks.get(g);(m==null?void 0:m.parentId)===c.id&&o.removeFloatingLink(m)}return o._version++,(f=n.onConnectionsChange)==null||f.call(n,NodeSlotType.INPUT,r,!0,l,i),o.afterChange(),l}get labelPos(){const[i,n,,s]=this.boundingRect;return[i,n+s*.5]}getConnectedWidgets(){var s;const{subgraph:i}=this.parent,n=[];for(const o of this.linkIds){const r=i.getLink(o);if(!r){console.error("Link not found",o);continue}const a=r.resolve(i);if(a.input&&((s=a.inputNode)!=null&&s.widgets)){const l=a.input.widget;if(!l)continue;if(!l.name){console.warn("Invalid widget name",l);continue}const u=a.inputNode.widgets.find(c=>c.name===l.name);if(!u){console.warn("Widget not found",l);continue}n.push(u)}else console.debug("No input found on link id",o,r)}return n}matchesWidget(i){var s;const n=(s=S(this,Vt))==null?void 0:s.deref();return n?!(i.type!==n.type||i.options.min!==n.options.min||i.options.max!==n.options.max||i.options.step!==n.options.step||i.options.step2!==n.options.step2||i.options.precision!==n.options.precision):!0}disconnect(){super.disconnect(),this.events.dispatch("input-disconnected",{input:this})}arrange(i){const[n,s,o,r]=i,{boundingRect:a,pos:l}=this;a[0]=n-o,a[1]=s,a[2]=o,a[3]=r,l[0]=n-r*.5,l[1]=s+r*.5}isValidTarget(i){return isNodeSlot(i)?"link"in i&&LiteGraph.isValidConnection(this.type,i.type):isSubgraphOutput(i)?LiteGraph.isValidConnection(this.type,i.type):!1}}Vt=new WeakMap;class EmptySubgraphInput extends SubgraphInput{constructor(t){super({id:zeroUuid,name:"",type:""},t)}connect(t,i,n){const{subgraph:s}=this.parent,o=s.inputs.map(l=>l.name),r=nextUniqueName(t.name,o);return s.addInput(r,String(t.type)).connect(t,i,n)}get labelPos(){const[t,i,,n]=this.boundingRect;return[t,i+n*.5]}}class SubgraphInputNode extends SubgraphIONodeBase{constructor(){super(...arguments);h(this,"id",SUBGRAPH_INPUT_ID);h(this,"emptySlot",new EmptySubgraphInput(this))}get slots(){return this.subgraph.inputs}get allSlots(){return[...this.slots,this.emptySlot]}get slotAnchorX(){const[i,,n]=this.boundingRect;return i+n-SubgraphIONodeBase.roundedRadius}onPointerDown(i,n,s){if(i.button===0)for(const o of this.allSlots)Rectangle.fromCentre(o.pos,o.boundingRect.height).containsXy(i.canvasX,i.canvasY)&&(n.onDragStart=()=>{s.dragNewFromSubgraphInput(this.subgraph,this,o)},n.onDragEnd=a=>{s.dropLinks(this.subgraph,a)},n.finally=()=>{s.reset(!0)});else if(i.button===2){const o=this.getSlotInPosition(i.canvasX,i.canvasY);o&&this.showSlotContextMenu(o,i)}}renameSlot(i,n){this.subgraph.renameInput(i,n)}removeSlot(i){this.subgraph.removeInput(i)}canConnectTo(i,n,s){return i.canConnectTo(this,n,s)}connectSlots(i,n,s,o){const{subgraph:r}=this,a=this.slots.indexOf(i),l=n.inputs.indexOf(s);if(a===-1||l===-1)throw new Error("Invalid slot indices.");return new LLink(++r.state.lastLinkId,s.type||i.type,this.id,a,n.id,l,o)}connectByType(i,n,s,o){const r=n.findInputByType(s);if(r){if(i===-1){const a=this.subgraph.addInput(r.slot.name,String(r.slot.type??"")),l=this.slots.indexOf(a);if(l===-1){console.error("Could not find newly created subgraph input slot.");return}i=l}return this.slots[i].connect(r.slot,n,o==null?void 0:o.afterRerouteId)}}findOutputSlot(i){return this.slots.find(n=>n.name===i)}findOutputByType(i){var n;return(n=findFreeSlotOfType(this.slots,i,s=>s.linkIds.length>0))==null?void 0:n.slot}_disconnectNodeInput(i,n,s){var u,c;const{subgraph:o}=this;if((u=n._floatingLinks)!=null&&u.size)for(const p of n._floatingLinks)o.removeFloatingLink(p);if(n.link=null,o.setDirtyCanvas(!1,!0),!s)return;const r=s.origin_slot;s.disconnect(o,"output"),o._version++;const a=this.slots.at(r);if(!a){console.debug("disconnectNodeInput: subgraphInput not found",this,r);return}const l=a.linkIds.indexOf(s.id);l!==-1?a.linkIds.splice(l,1):console.debug("disconnectNodeInput: link ID not found in subgraphInput linkIds",s.id),(c=i.onConnectionsChange)==null||c.call(i,NodeSlotType.OUTPUT,l,!1,s,a)}drawProtected(i,n,s,o){const{roundedRadius:r}=SubgraphIONodeBase,a=i.getTransform(),[l,u,c,p]=this.boundingRect;i.translate(l,u),i.strokeStyle=this.sideStrokeStyle,i.lineWidth=this.sideLineWidth,i.beginPath(),i.arc(c-r,r,r,Math.PI*1.5,0),i.moveTo(c,r),i.lineTo(c,p-r),i.arc(c-r,p-r,r,0,Math.PI*.5),i.stroke(),i.setTransform(a),this.drawSlots(i,n,s,o)}}class FloatingRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");h(this,"outputNodeId",-1);h(this,"outputNode");h(this,"outputSlot");h(this,"outputIndex",-1);h(this,"outputPos");h(this,"inputNodeId",-1);h(this,"inputNode");h(this,"inputSlot");h(this,"inputIndex",-1);h(this,"inputPos");this.network=t,this.link=i,this.toType=n,this.fromReroute=s,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:u}=i;if(r!==-1){const c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=c==null?void 0:c.outputs.at(l);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=p,this.outputIndex=l,this.outputPos=c.getOutputPos(l),this.node=c,this.fromSlot=p,this.fromPos=(s==null?void 0:s.pos)??this.outputPos,this.fromDirection=LinkDirection.LEFT,this.dragDirection=LinkDirection.RIGHT,this.fromSlotIndex=l}else{const c=t.getNodeById(a)??void 0;if(!c)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const p=c==null?void 0:c.inputs.at(u);if(!p)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${u}] not found.`);this.inputNodeId=a,this.inputNode=c,this.inputSlot=p,this.inputIndex=u,this.inputPos=c.getInputPos(u),this.node=c,this.fromSlot=p,this.fromDirection=LinkDirection.RIGHT,this.fromSlotIndex=u}this.fromPos=s.pos}canConnectToInput(){return this.toType==="input"}canConnectToOutput(){return this.toType==="output"}canConnectToReroute(t){var i,n;if(this.toType==="input"){if(t.origin_id===((i=this.inputNode)==null?void 0:i.id))return!1}else if(t.origin_id===((n=this.outputNode)==null?void 0:n.id))return!1;return!0}connectToInput(t,i,n){var o;const s=this.link;s.target_id=t.id,s.target_slot=t.inputs.indexOf(i),t.disconnectInput(t.inputs.indexOf(i)),(o=this.fromSlot._floatingLinks)==null||o.delete(s),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(s)}connectToOutput(t,i,n){var o;const s=this.link;s.origin_id=t.id,s.origin_slot=t.outputs.indexOf(i),(o=this.fromSlot._floatingLinks)==null||o.delete(s),i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(s)}connectToSubgraphInput(t,i){var s;const n=this.link;n.origin_id=SUBGRAPH_INPUT_ID,n.origin_slot=t.parent.slots.indexOf(t),(s=this.fromSlot._floatingLinks)==null||s.delete(n),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(n)}connectToSubgraphOutput(t,i){var s;const n=this.link;n.origin_id=SUBGRAPH_OUTPUT_ID,n.origin_slot=t.parent.slots.indexOf(t),(s=this.fromSlot._floatingLinks)==null||s.delete(n),t._floatingLinks??(t._floatingLinks=new Set),t._floatingLinks.add(n)}connectToRerouteInput(t,{node:i,input:n},s){var r;const o=this.link;o.target_id=i.id,o.target_slot=i.inputs.indexOf(n),(r=this.fromSlot._floatingLinks)==null||r.delete(o),n._floatingLinks??(n._floatingLinks=new Set),n._floatingLinks.add(o),s.dispatch("input-moved",this)}connectToRerouteOutput(t,i,n,s){var r;const o=this.link;o.origin_id=i.id,o.origin_slot=i.outputs.indexOf(n),(r=this.fromSlot._floatingLinks)==null||r.delete(o),n._floatingLinks??(n._floatingLinks=new Set),n._floatingLinks.add(o),s.dispatch("output-moved",this)}}class MovingLinkBase{constructor(t,i,n,s,o=LinkDirection.CENTER){h(this,"outputNodeId");h(this,"outputNode");h(this,"outputSlot");h(this,"outputIndex");h(this,"outputPos");h(this,"inputNodeId");h(this,"inputNode");h(this,"inputSlot");h(this,"inputIndex");h(this,"inputPos");this.network=t,this.link=i,this.toType=n,this.fromReroute=s,this.dragDirection=o;const{origin_id:r,target_id:a,origin_slot:l,target_slot:u}=i,c=t.getNodeById(r)??void 0;if(!c)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output node [${r}] not found.`);const p=c.outputs.at(l);if(!p)throw new Error(`Creating MovingRenderLink for link [${i.id}] failed: Output slot [${l}] not found.`);this.outputNodeId=r,this.outputNode=c,this.outputSlot=p,this.outputIndex=l,this.outputPos=c.getOutputPos(l);const f=t.getNodeById(a)??void 0;if(!f)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input node [${a}] not found.`);const g=f.inputs.at(u);if(!g)throw new Error(`Creating DraggingRenderLink for link [${i.id}] failed: Input slot [${u}] not found.`);this.inputNodeId=a,this.inputNode=f,this.inputSlot=g,this.inputIndex=u,this.inputPos=f.getInputPos(u)}}class MovingInputLink extends MovingLinkBase{constructor(i,n,s,o=LinkDirection.CENTER){super(i,n,"input",s,o);h(this,"toType","input");h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");this.node=this.outputNode,this.fromSlot=this.outputSlot,this.fromPos=(s==null?void 0:s.pos)??this.outputPos,this.fromDirection=LinkDirection.NONE,this.fromSlotIndex=this.outputIndex}canConnectToInput(i,n){return this.node.canConnectTo(i,n,this.outputSlot)}canConnectToOutput(){return!1}canConnectToReroute(i){return i.origin_id!==this.inputNode.id}connectToInput(i,n,s){var r;if(n===this.inputSlot)return;this.inputNode.disconnectInput(this.inputIndex,!0);const o=this.outputNode.connectSlots(this.outputSlot,i,n,(r=this.fromReroute)==null?void 0:r.id);return o&&s.dispatch("input-moved",this),o}connectToOutput(){throw new Error("MovingInputLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("MovingInputLink cannot connect to a subgraph input.")}connectToSubgraphOutput(i,n){var o;const s=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);n==null||n.dispatch("link-created",s)}connectToRerouteInput(i,{node:n,input:s,link:o},r,a){const{outputNode:l,outputSlot:u,fromReroute:c}=this;for(const f of a){if(f.id===this.link.parentId)break;f.totalLinks===1&&f.remove()}i.parentId=c==null?void 0:c.id,l.connectSlots(u,n,s,o.parentId)&&r.dispatch("input-moved",this)}connectToRerouteOutput(){throw new Error("MovingInputLink cannot connect to an output.")}disconnect(){return this.inputNode.disconnectInput(this.inputIndex,!0)}}class MovingOutputLink extends MovingLinkBase{constructor(i,n,s,o=LinkDirection.CENTER){super(i,n,"output",s,o);h(this,"toType","output");h(this,"node");h(this,"fromSlot");h(this,"fromPos");h(this,"fromDirection");h(this,"fromSlotIndex");this.node=this.inputNode,this.fromSlot=this.inputSlot,this.fromPos=(s==null?void 0:s.pos)??this.inputPos,this.fromDirection=LinkDirection.LEFT,this.fromSlotIndex=this.inputIndex}canConnectToInput(){return!1}canConnectToOutput(i,n){return i.canConnectTo(this.node,this.inputSlot,n)}canConnectToReroute(i){return i.origin_id!==this.outputNode.id}connectToInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToOutput(i,n,s){if(n===this.outputSlot)return;const o=i.connectSlots(n,this.inputNode,this.inputSlot,this.link.parentId);return o&&s.dispatch("output-moved",this),o}connectToSubgraphInput(i,n){var o;const s=i.connect(this.fromSlot,this.node,(o=this.fromReroute)==null?void 0:o.id);n==null||n.dispatch("link-created",s)}connectToSubgraphOutput(){throw new Error("MovingOutputLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("MovingOutputLink cannot connect to an input.")}connectToRerouteOutput(i,n,s,o){var c;const{inputNode:r,inputSlot:a,fromReroute:l}=this,u=((c=i==null?void 0:i.floating)==null?void 0:c.slotType)==="output";l?l.parentId=i.id:this.link.parentId=i.id,n.connectSlots(s,r,a,this.link.parentId),u&&i.removeAllFloatingLinks(),o.dispatch("output-moved",this)}disconnect(){return this.outputNode.disconnectOutput(this.outputIndex,this.inputNode)}}class ToInputFromIoNodeLink{constructor(t,i,n,s,o=LinkDirection.CENTER,r){h(this,"toType","input");h(this,"fromSlotIndex");h(this,"fromPos");h(this,"fromDirection",LinkDirection.RIGHT);h(this,"existingLink");this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const a=i.slots.indexOf(n);if(a===-1&&n!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=a,this.fromPos=s?s.pos:n.pos,this.existingLink=r}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,n){const{fromSlot:s,fromReroute:o,existingLink:r}=this,a=s.connect(i,t,o==null?void 0:o.id);r?n.dispatch("input-moved",this):n.dispatch("link-created",a)}connectToSubgraphOutput(){throw new Error("Not implemented")}connectToRerouteInput(t,{node:i,input:n,link:s},o,r){var p;const{fromSlot:a,fromReroute:l}=this,u=((p=l==null?void 0:l.floating)==null?void 0:p.slotType)==="output";t.parentId=l==null?void 0:l.id;const c=a.connect(n,i,s.parentId);u&&l.removeAllFloatingLinks();for(const f of r){if(f.id===(l==null?void 0:l.id))break;if(f.removeLink(s),f.totalLinks===0)if(s.isFloating)f.remove();else{const g=s.toFloating("output",f.id);this.network.addFloatingLink(g),f.floating={slotType:"output"}}}this.existingLink?o.dispatch("input-moved",this):o.dispatch("link-created",c)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToInputRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){h(this,"toType","input");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.RIGHT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.outputs.indexOf(n);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:this.node.getOutputPos(r)}canConnectToInput(t,i){return this.node.canConnectTo(t,i,this.fromSlot)}canConnectToOutput(){return!1}connectToInput(t,i,n){const{node:s,fromSlot:o,fromReroute:r}=this;if(t===s)return;const a=s.connectSlots(o,t,i,r==null?void 0:r.id);n.dispatch("link-created",a)}connectToSubgraphOutput(t,i){var s;const n=t.connect(this.fromSlot,this.node,(s=this.fromReroute)==null?void 0:s.id);i.dispatch("link-created",n)}connectToRerouteInput(t,{node:i,input:n,link:s},o,r){var f;const{node:a,fromSlot:l,fromReroute:u}=this,c=((f=u==null?void 0:u.floating)==null?void 0:f.slotType)==="output";t.parentId=u==null?void 0:u.id;const p=a.connectSlots(l,i,n,s.parentId);c&&u.removeAllFloatingLinks();for(const g of r){if(g.id===(u==null?void 0:u.id))break;if(g.removeLink(s),g.totalLinks===0)if(s.isFloating)g.remove();else{const m=s.toFloating("output",g.id);this.network.addFloatingLink(m),g.floating={slotType:"output"}}}o.dispatch("link-created",p)}connectToOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}connectToSubgraphInput(){throw new Error("ToInputRenderLink cannot connect to a subgraph input.")}connectToRerouteOutput(){throw new Error("ToInputRenderLink cannot connect to an output.")}}class ToOutputFromIoNodeLink{constructor(t,i,n,s,o=LinkDirection.CENTER){h(this,"toType","output");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.slots.indexOf(n);if(r===-1&&n!==i.emptySlot)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:n.pos}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,n){const{fromSlot:s,fromReroute:o}=this,r=s.connect(i,t,o==null?void 0:o.id);n.dispatch("link-created",r)}connectToSubgraphInput(){throw new Error("Not implemented")}connectToRerouteOutput(t,i,n,s){const{fromSlot:o}=this,r=o.connect(n,i,t==null?void 0:t.id);s.dispatch("link-created",r)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputRenderLink{constructor(t,i,n,s,o=LinkDirection.CENTER){h(this,"toType","output");h(this,"fromPos");h(this,"fromSlotIndex");h(this,"fromDirection",LinkDirection.LEFT);this.network=t,this.node=i,this.fromSlot=n,this.fromReroute=s,this.dragDirection=o;const r=i.inputs.indexOf(n);if(r===-1)throw new Error(`Creating render link for node [${this.node.id}] failed: Slot index not found.`);this.fromSlotIndex=r,this.fromPos=s?s.pos:this.node.getInputPos(r)}canConnectToInput(){return!1}canConnectToOutput(t,i){return this.node.canConnectTo(t,this.fromSlot,i)}canConnectToReroute(t){return t.origin_id!==this.node.id}connectToOutput(t,i,n){const{node:s,fromSlot:o,fromReroute:r}=this;if(!s)return;const a=t.connectSlots(i,s,o,r==null?void 0:r.id);n.dispatch("link-created",a)}connectToSubgraphInput(t,i){var s;const n=t.connect(this.fromSlot,this.node,(s=this.fromReroute)==null?void 0:s.id);i==null||i.dispatch("link-created",n)}connectToRerouteOutput(t,i,n,s){const{node:o,fromSlot:r}=this,a=i.connectSlots(n,o,r,t==null?void 0:t.id);s.dispatch("link-created",a)}connectToInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}connectToSubgraphOutput(){throw new Error("ToOutputRenderLink cannot connect to a subgraph output.")}connectToRerouteInput(){throw new Error("ToOutputRenderLink cannot connect to an input.")}}class ToOutputFromRerouteLink extends ToOutputRenderLink{constructor(t,i,n,s,o){super(t,i,n,s),this.fromReroute=s,this.linkConnector=o}canConnectToReroute(){return!1}connectToOutput(t,i){const n=new ToInputRenderLink(this.network,t,i);this.linkConnector._connectOutputToReroute(this.fromReroute,n)}}class LinkConnector{constructor(t){W(this,J);h(this,"state",{connectingTo:void 0,multi:!1,draggingExistingLinks:!1,snapLinksPos:void 0});h(this,"events",new CustomEventTarget);h(this,"renderLinks",[]);h(this,"inputLinks",[]);h(this,"outputLinks",[]);h(this,"floatingLinks",[]);h(this,"hiddenReroutes",new Set);h(this,"overWidget");h(this,"overWidgetType");h(this,"overReroute");W(this,oe);H(this,oe,t)}get isConnecting(){return this.state.connectingTo!==void 0}get draggingExistingLinks(){return this.state.draggingExistingLinks}moveInputLink(t,i){var a,l;if(this.isConnecting)throw new Error("Already dragging links.");const{state:n,inputLinks:s,renderLinks:o}=this,r=i.link;if(r==null){const u=(a=i._floatingLinks)==null?void 0:a.values().next().value;if((u==null?void 0:u.parentId)==null)return;try{const c=t.reroutes.get(u.parentId);if(!c)throw new Error(`Invalid reroute id: [${u.parentId}] for floating link id: [${u.id}].`);const p=new FloatingRenderLink(t,u,"input",c);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p)}catch(c){console.warn(`Could not create render link for link id: [${u.id}].`,u,c)}u._dragging=!0,this.floatingLinks.push(u)}else{const u=t.links.get(r);if(!u)return;if(u.origin_id===SUBGRAPH_INPUT_ID){const c=(l=t.inputNode)==null?void 0:l.slots[u.origin_slot];if(!c){console.warn(`Could not find subgraph input for slot [${u.origin_slot}]`);return}try{const p=t.getReroute(u.parentId),f=new ToInputFromIoNodeLink(t,t.inputNode,c,p,LinkDirection.CENTER,u);o.push(f),this.listenUntilReset("input-moved",()=>{u.disconnect(t,"input")})}catch(p){console.warn(`Could not create render link for subgraph input link id: [${u.id}].`,u,p);return}u._dragging=!0,s.push(u)}else{try{const c=t.getReroute(u.parentId),p=new MovingInputLink(t,u,c);if(this.events.dispatch("before-move-input",p)===!1)return;o.push(p),this.listenUntilReset("input-moved",g=>{"link"in g.detail&&g.detail.link&&g.detail.link.disconnect(t,"output")})}catch(c){console.warn(`Could not create render link for link id: [${u.id}].`,u,c);return}u._dragging=!0,s.push(u)}}n.connectingTo="input",n.draggingExistingLinks=!0,C(this,J,lt).call(this,!1)}moveOutputLink(t,i){var o,r;if(this.isConnecting)throw new Error("Already dragging links.");const{state:n,renderLinks:s}=this;if((o=i._floatingLinks)!=null&&o.size)for(const a of i._floatingLinks.values())try{const l=LLink.getFirstReroute(t,a);if(!l)throw new Error(`Invalid reroute id: [${a.parentId}] for floating link id: [${a.id}].`);const u=new FloatingRenderLink(t,a,"output",l);if(this.events.dispatch("before-move-output",u)===!1)continue;s.push(u),this.floatingLinks.push(a)}catch(l){console.warn(`Could not create render link for link id: [${a.id}].`,a,l)}if((r=i.links)!=null&&r.length)for(const a of i.links){const l=t.links.get(a);if(!l)continue;const u=LLink.getFirstReroute(t,l);u?(u._dragging=!0,this.hiddenReroutes.add(u)):l._dragging=!0,this.outputLinks.push(l);try{const c=new MovingOutputLink(t,l,u,LinkDirection.RIGHT);if(this.events.dispatch("before-move-output",c)===!1)continue;s.push(c)}catch(c){console.warn(`Could not create render link for link id: [${l.id}].`,l,c);continue}}s.length!==0&&(n.draggingExistingLinks=!0,n.multi=!0,n.connectingTo="output",C(this,J,lt).call(this,!0))}dragNewFromOutput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToInputRenderLink(t,i,n,s);this.renderLinks.push(r),o.connectingTo="input",C(this,J,lt).call(this,!1)}dragNewFromInput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const{state:o}=this,r=new ToOutputRenderLink(t,i,n,s);this.renderLinks.push(r),o.connectingTo="output",C(this,J,lt).call(this,!0)}dragNewFromSubgraphInput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToInputFromIoNodeLink(t,i,n,s);this.renderLinks.push(o),this.state.connectingTo="input",C(this,J,lt).call(this,!1)}dragNewFromSubgraphOutput(t,i,n,s){if(this.isConnecting)throw new Error("Already dragging links.");const o=new ToOutputFromIoNodeLink(t,i,n,s);this.renderLinks.push(o),this.state.connectingTo="output",C(this,J,lt).call(this,!0)}dragFromReroute(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const n=i.firstLink??i.firstFloatingLink;if(!n){console.warn("No link found for reroute.");return}if(n.origin_id===SUBGRAPH_INPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph input link found in non-subgraph network.");return}const a=t.inputs.at(n.origin_slot);if(!a)throw new Error("No subgraph input found for link.");const l=new ToInputFromIoNodeLink(t,t.inputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="input",C(this,J,lt).call(this,!1);return}const s=t.getNodeById(n.origin_id);if(!s){console.warn("No output node found for link.",n);return}const o=s.outputs.at(n.origin_slot);if(!o){console.warn("No output slot found for link.",n);return}const r=new ToInputRenderLink(t,s,o,i);r.fromDirection=LinkDirection.NONE,this.renderLinks.push(r),this.state.connectingTo="input",C(this,J,lt).call(this,!1)}dragFromRerouteToOutput(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const n=i.firstLink??i.firstFloatingLink;if(!n){console.warn("No link found for reroute.");return}if(n.target_id===SUBGRAPH_OUTPUT_ID){if(!(t instanceof Subgraph)){console.warn("Subgraph output link found in non-subgraph network.");return}const a=t.outputs.at(n.target_slot);if(!a)throw new Error("No subgraph output found for link.");const l=new ToOutputFromIoNodeLink(t,t.outputNode,a,i);l.fromDirection=LinkDirection.NONE,this.renderLinks.push(l),this.state.connectingTo="output",C(this,J,lt).call(this,!1);return}const s=t.getNodeById(n.target_id);if(!s){console.warn("No input node found for link.",n);return}const o=s.inputs.at(n.target_slot);if(!o){console.warn("No input slot found for link.",n);return}const r=new ToOutputFromRerouteLink(t,s,o,i,this);r.fromDirection=LinkDirection.LEFT,this.renderLinks.push(r),this.state.connectingTo="output",C(this,J,lt).call(this,!0)}dragFromLinkSegment(t,i){if(this.isConnecting)throw new Error("Already dragging links.");const{state:n}=this;if(i.origin_id==null||i.origin_slot==null)return;const s=t.getNodeById(i.origin_id);if(!s)return;const o=s.outputs.at(i.origin_slot);if(!o)return;const r=t.getReroute(i.parentId),a=new ToInputRenderLink(t,s,o,r);a.fromDirection=LinkDirection.NONE,this.renderLinks.push(a),n.connectingTo="input",C(this,J,lt).call(this,!1)}dropLinks(t,i){var n;if(!(!this.isConnecting&&this.events.dispatch("before-drop-links",{renderLinks:this.renderLinks,event:i})===!1))try{const{canvasX:s,canvasY:o}=i,r=(n=t.getIoNodeOnPos)==null?void 0:n.call(t,s,o);if(r){this.dropOnIoNode(r,i);return}const a=t.getNodeOnPos(s,o)??void 0;if(a)this.dropOnNode(a,i);else{const l=t.getRerouteOnPos(s,o);l&&this.isRerouteValidDrop(l)?this.dropOnReroute(l,i):this.dropOnNothing(i)}}finally{this.events.dispatch("after-drop-links",{renderLinks:this.renderLinks,event:i})}}dropOnIoNode(t,i){const{renderLinks:n,state:s}=this,{connectingTo:o}=s,{canvasX:r,canvasY:a}=i;if(o==="input"&&t instanceof SubgraphOutputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No output slot found for link.");for(const u of n)u.connectToSubgraphOutput(l,this.events)}else if(o==="output"&&t instanceof SubgraphInputNode){const l=t.getSlotInPosition(r,a);if(!l)throw new Error("No input slot found for link.");for(const u of n)u.connectToSubgraphInput(l,this.events)}else console.error("Invalid connectingTo state &/ ioNode",o,t)}dropOnNode(t,i){const{renderLinks:n,state:s}=this,{connectingTo:o}=s,{canvasX:r,canvasY:a}=i;if(!n.every(l=>l.node===t)){if(o==="output"){const l=t.getOutputOnPos([r,a]);l?C(this,J,Xe).call(this,t,l):this.connectToNode(t,i)}else if(o==="input"){const u=t.getInputOnPos([r,a])??t.getSlotFromWidget(this.overWidget);u?C(this,J,$e).call(this,t,u):this.connectToNode(t,i)}}}dropOnReroute(t,i){if(this.events.dispatch("dropped-on-reroute",{reroute:t,event:i})!==!1){if(this.state.connectingTo==="input"){if(this.renderLinks.length!==1)throw new Error(`Attempted to connect ${this.renderLinks.length} input links to a reroute.`);const s=this.renderLinks[0];this._connectOutputToReroute(t,s);return}for(const s of this.renderLinks){if(s.toType!=="output")continue;const o=t.findSourceOutput();if(!o)continue;const{node:r,output:a}=o;s.canConnectToOutput(r,a)&&s.connectToRerouteOutput(t,r,a,this.events)}}}_connectOutputToReroute(t,i){const n=t.findTargetInputs();if(!(n!=null&&n.length))return;const s=t.getReroutes();if(s===null)throw new Error("Reroute loop detected.");const o=s.slice(0,-1).reverse();if(i instanceof ToInputRenderLink){const{node:a,fromSlot:l,fromSlotIndex:u,fromReroute:c}=i;if(t.setFloatingLinkOrigin(a,l,u),c!=null)for(const p of o){if(p.id===c.id)break;for(const f of t.floatingLinkIds)p.floatingLinkIds.delete(f)}}const r=n.filter(a=>i.toType==="input"&&canConnectInputLinkToReroute(i,a.node,a.input,t));for(const a of r)i.connectToRerouteInput(t,a,this.events,o)}dropOnNothing(t){this.events.dispatch("dropped-on-canvas",t)!==!1&&this.disconnectLinks()}disconnectLinks(){for(const t of this.renderLinks)t instanceof MovingLinkBase&&t.disconnect()}connectToNode(t,i){var r,a;const{state:{connectingTo:n}}=this;if(this.events.dispatch("dropped-on-node",{node:t,event:i})===!1)return;const o=this.renderLinks[0];if(o){if(n==="output"){const l=(r=t.findOutputByType(o.fromSlot.type))==null?void 0:r.slot;if(console.debug("out",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}C(this,J,Xe).call(this,t,l)}else if(n==="input"){const l=(a=t.findInputByType(o.fromSlot.type))==null?void 0:a.slot;if(console.debug("in",t,l,o.fromSlot),l===void 0){console.warn(`Could not find slot for link type: [${o.fromSlot.type}].`);return}C(this,J,$e).call(this,t,l)}}}isInputValidDrop(t,i){return this.renderLinks.some(n=>n.canConnectToInput(t,i))}isNodeValidDrop(t){return this.state.connectingTo==="output"?t.outputs.some(i=>this.renderLinks.some(n=>n.canConnectToOutput(t,i))):t.inputs.some(i=>this.renderLinks.some(n=>n.canConnectToInput(t,i)))}isRerouteValidDrop(t){if(this.state.connectingTo==="input"){const i=t.findTargetInputs();if(!(i!=null&&i.length))return!1;for(const{node:n,input:s}of i)for(const o of this.renderLinks)if(o.toType==="input"&&canConnectInputLinkToReroute(o,n,s,t))return!0}else{const i=t.findSourceOutput();if(!i)return!1;const{node:n,output:s}=i;for(const o of this.renderLinks)if(o.toType==="output"&&o.canConnectToReroute(t)&&o.canConnectToOutput(n,s))return!0}return!1}export(t){return{renderLinks:[...this.renderLinks],inputLinks:[...this.inputLinks],outputLinks:[...this.outputLinks],floatingLinks:[...this.floatingLinks],state:{...this.state},network:t}}listenUntilReset(t,i,n){this.events.addEventListener(t,i,n),this.events.addEventListener("reset",()=>this.events.removeEventListener(t,i),{once:!0})}reset(t=!1){if(this.events.dispatch("reset",t)===!1)return;const{state:n,outputLinks:s,inputLinks:o,hiddenReroutes:r,renderLinks:a,floatingLinks:l}=this;if(!(!t&&n.connectingTo===void 0)){n.connectingTo=void 0;for(const u of s)delete u._dragging;for(const u of o)delete u._dragging;for(const u of l)delete u._dragging;for(const u of r)delete u._dragging;a.length=0,o.length=0,s.length=0,l.length=0,r.clear(),n.multi=!1,n.draggingExistingLinks=!1,n.snapLinksPos=void 0}}}oe=new WeakMap,J=new WeakSet,$e=function(t,i){for(const n of this.renderLinks)n.canConnectToInput(t,i)&&n.connectToInput(t,i,this.events)},Xe=function(t,i){for(const n of this.renderLinks){if(!n.canConnectToOutput(t,i)){n instanceof MovingOutputLink&&n.link.parentId!==void 0&&n.outputNode.connectSlots(n.outputSlot,n.inputNode,n.inputSlot,void 0);continue}n.connectToOutput(t,i,this.events)}},lt=function(t){const i=this.renderLinks.map(n=>{var a,l;const s=t?n.fromSlot:null,o=t?null:n.fromSlot,r=n instanceof MovingLinkBase?(a=n.link)==null?void 0:a.parentId:(l=n.fromReroute)==null?void 0:l.id;return{node:n.node,slot:n.fromSlotIndex,input:s,output:o,pos:n.fromPos,afterRerouteId:r}});S(this,oe).call(this,i)};function canConnectInputLinkToReroute(d,t,i,n){var o,r,a;const{fromReroute:s}=d;if(!d.canConnectToInput(t,i)||(s==null?void 0:s.id)===n.id||(o=s==null?void 0:s.getReroutes())!=null&&o.includes(n))return!1;if(d instanceof ToInputRenderLink){if(n.parentId==null){if((r=n.firstLink)!=null&&r.hasOrigin(d.node.id,d.fromSlotIndex))return!1}else if(((a=d.fromReroute)==null?void 0:a.id)===n.parentId)return!1}return!0}const ut=class ut{constructor(t){W(this,st);h(this,"element");h(this,"pointerId");h(this,"dragStarted",!1);h(this,"eLastDown");h(this,"isDouble",!1);h(this,"isDown",!1);h(this,"resizeDirection");h(this,"clearEventsOnReset",!0);h(this,"eDown");h(this,"eMove");h(this,"eUp");W(this,$t);this.element=t}static get maxClickDrift(){return S(this,Tt)}static set maxClickDrift(t){H(this,Tt,t),H(this,re,t*t)}get finally(){return S(this,$t)}set finally(t){var i;try{(i=S(this,$t))==null||i.call(this)}finally{H(this,$t,t)}}down(t){this.reset(),this.eDown=t,this.pointerId=t.pointerId,this.element.setPointerCapture(t.pointerId)}move(t){var s;const{eDown:i}=this;if(!i)return;if(!t.buttons){this.reset();return}if(!(t.buttons&i.buttons)){C(this,st,Ye).call(this,t),this.reset();return}if(this.eMove=t,(s=this.onDrag)==null||s.call(this,t),this.dragStarted)return;(t.timeStamp-i.timeStamp>ut.bufferTime||!C(this,st,Ae).call(this,t,i))&&C(this,st,je).call(this,t)}up(t){var n;if(t.button!==((n=this.eDown)==null?void 0:n.button))return!1;C(this,st,Ye).call(this,t);const{dragStarted:i}=this;return this.reset(),!i}reset(){this.finally=void 0,delete this.onClick,delete this.onDoubleClick,delete this.onDragStart,delete this.onDrag,delete this.onDragEnd,this.isDown=!1,this.isDouble=!1,this.dragStarted=!1,this.resizeDirection=void 0,this.clearEventsOnReset&&(this.eDown=void 0,this.eMove=void 0,this.eUp=void 0);const{element:t,pointerId:i}=this;this.pointerId=void 0,typeof i=="number"&&t.hasPointerCapture(i)&&t.releasePointerCapture(i)}};Tt=new WeakMap,re=new WeakMap,$t=new WeakMap,st=new WeakSet,Ye=function(t){var n,s,o;const{eDown:i}=this;i&&(this.eUp=t,this.dragStarted?(n=this.onDragEnd)==null||n.call(this,t):C(this,st,Ae).call(this,t,i)?this.onDoubleClick&&C(this,st,gi).call(this)?(this.onDoubleClick(t),this.eLastDown=void 0):((o=this.onClick)==null||o.call(this,t),this.eLastDown=i):(C(this,st,je).call(this),(s=this.onDragEnd)==null||s.call(this,t)))},Ae=function(t,i,n=S(ut,re)){return dist2(t.clientX,t.clientY,i.clientX,i.clientY)<=n},gi=function(){const{eDown:t,eLastDown:i}=this;if(!t||!i)return!1;const n=(3*S(ut,Tt))**2,s=t.timeStamp-i.timeStamp;return s>0&&s<ut.doubleClickTime&&C(this,st,Ae).call(this,t,i,n)},je=function(t){var i;this.dragStarted=!0,(i=this.onDragStart)==null||i.call(this,this,t),delete this.onDragStart},h(ut,"bufferTime",150),h(ut,"doubleClickTime",300),W(ut,Tt,6),W(ut,re,S(ut,Tt)**2);let CanvasPointer=ut;class DragAndScale{constructor(t){W(this,we);h(this,"state");h(this,"lastState",{offset:[0,0],scale:0});h(this,"max_scale");h(this,"min_scale");h(this,"enabled");h(this,"last_mouse");h(this,"element");h(this,"visible_area");h(this,"dragging");h(this,"viewport");this.state={offset:[0,0],scale:1},this.max_scale=10,this.min_scale=.1,this.enabled=!0,this.last_mouse=[0,0],this.visible_area=new Rectangle,this.element=t}get offset(){return this.state.offset}set offset(t){this.state.offset[0]=t[0],this.state.offset[1]=t[1]}get scale(){return this.state.scale}set scale(t){this.state.scale=t}computeVisibleArea(t){var p;const{scale:i,offset:n,visible_area:s}=this;if(C(this,we,_i).call(this)&&((p=this.onChanged)==null||p.call(this,i,n),copyState(this.state,this.lastState)),!this.element){s[0]=s[1]=s[2]=s[3]=0;return}let{width:o,height:r}=this.element,a=-n[0],l=-n[1];t&&(a+=t[0]/i,l+=t[1]/i,o=t[2],r=t[3]);const u=a+o/i,c=l+r/i;s[0]=a,s[1]=l,s.resizeBottomRight(u,c)}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,i){return i=i||[0,0],i[0]=t[0]/this.scale-this.offset[0],i[1]=t[1]/this.scale-this.offset[1],i}mouseDrag(t,i){var n;this.offset[0]+=t/this.scale,this.offset[1]+=i/this.scale,(n=this.onredraw)==null||n.call(this,this)}changeScale(t,i,n=!0){var u;if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t==this.scale)return;const s=this.element.getBoundingClientRect();if(!s)return;i=i??[s.width*.5,s.height*.5];const o=[i[0]-s.x,i[1]-s.y],r=this.convertCanvasToOffset(o);this.scale=t,n&&Math.abs(this.scale-1)<.01&&(this.scale=1);const a=this.convertCanvasToOffset(o),l=[a[0]-r[0],a[1]-r[1]];this.offset[0]+=l[0],this.offset[1]+=l[1],(u=this.onredraw)==null||u.call(this,this)}changeDeltaScale(t,i){this.changeScale(this.scale*t,i)}fitToBounds(t,{zoom:i=.75}={}){const n=this.element.width/window.devicePixelRatio,s=this.element.height/window.devicePixelRatio;let o=this.scale;if(i>0){const c=i*n/Math.max(t[2],300),p=i*s/Math.max(t[3],300);o=Math.min(c,p,this.max_scale)}const r=n/o,a=s/o,l=-t[0]-t[2]*.5+r*.5,u=-t[1]-t[3]*.5+a*.5;this.offset[0]=l,this.offset[1]=u,this.scale=o}animateToBounds(t,i,{duration:n=350,zoom:s=.75,easing:o=EaseFunction.EASE_IN_OUT_QUAD}={}){if(!(n>0))throw new RangeError("Duration must be greater than 0");const r={linear:N=>N,easeInQuad:N=>N*N,easeOutQuad:N=>N*(2-N),easeInOutQuad:N=>N<.5?2*N*N:-1+(4-2*N)*N},a=r[o]??r.linear,l=performance.now(),u=this.element.width/window.devicePixelRatio,c=this.element.height/window.devicePixelRatio,p=this.offset[0],f=this.offset[1],g=p-u/this.scale,m=f-c/this.scale;let y=this.scale;if(s>0){const N=s*u/Math.max(t[2],300),D=s*c/Math.max(t[3],300);y=Math.min(N,D,this.max_scale)}const b=u/y,k=c/y,w=-t[0]-t[2]*.5+b*.5,T=-t[1]-t[3]*.5+k*.5,I=w-b,E=T-k,G=N=>{const D=N-l,P=Math.min(D/n,1),B=a(P),X=p+(w-p)*B,A=f+(T-f)*B;if(this.offset[0]=X,this.offset[1]=A,s>0){const L=g+(I-g)*B,j=m+(E-m)*B,Y=Math.abs(L-X),M=Math.abs(j-A);this.scale=Math.min(u/Y,c/M)}i(),P<1?R=requestAnimationFrame(G):cancelAnimationFrame(R)};let R=requestAnimationFrame(G)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}we=new WeakSet,_i=function(){const t=this.state,i=this.lastState;return t.scale!==i.scale||t.offset[0]!==i.offset[0]||t.offset[1]!==i.offset[1]};function copyState(d,t){t.scale=d.scale,t.offset[0]=d.offset[0],t.offset[1]=d.offset[1]}function getBoundaryNodes(d){const t=d==null?void 0:d.find(r=>r);if(!t)return null;let i=t,n=t,s=t,o=t;for(const r of d){if(!r)continue;const[a,l]=r.pos,[u,c]=r.size;l<i.pos[1]&&(i=r),a+u>n.pos[0]+n.size[0]&&(n=r),l+c>s.pos[1]+s.size[1]&&(s=r),a<o.pos[0]&&(o=r)}return{top:i,right:n,bottom:s,left:o}}function distributeNodes(d,t){const i=d==null?void 0:d.length;if(!(i>1))return;const n=t?0:1;let s=0,o=-1/0;for(const c of d){s+=c.size[n];const p=c.pos[n]+c.size[n];p>o&&(o=p)}const r=[...d].sort((c,p)=>c.pos[n]-p.pos[n]),a=r[0].pos[n],l=(o-a-s)/(i-1);let u=a;for(let c=0;c<i;c++){const p=r[c];p.pos[n]=u+l*c,u+=p.size[n]}}function alignNodes(d,t,i){if(!d)return;const n=i===void 0?getBoundaryNodes(d):{top:i,right:i,bottom:i,left:i};if(n!==null)for(const s of d)switch(t){case"right":s.pos[0]=n.right.pos[0]+n.right.size[0]-s.size[0];break;case"left":s.pos[0]=n.left.pos[0];break;case"top":s.pos[1]=n.top.pos[1];break;case"bottom":s.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-s.size[1];break}}const cursors={NE:"nesw-resize",SE:"nwse-resize",SW:"nesw-resize",NW:"nwse-resize"},O=class O{constructor(t,i,n){W(this,F);h(this,"state",{draggingItems:!1,draggingCanvas:!1,readOnly:!1,hoveringOver:CanvasItem.Nothing,shouldSetCursor:!0,selectionChanged:!1});W(this,Et);h(this,"_previously_dragging_canvas",null);W(this,vt,0);h(this,"options");h(this,"background_image");h(this,"ds");h(this,"pointer");h(this,"zoom_modify_alpha");h(this,"zoom_speed");h(this,"node_title_color");h(this,"default_link_color");h(this,"default_connection_color");h(this,"default_connection_color_byType");h(this,"default_connection_color_byTypeOff");h(this,"colourGetter",{getConnectedColor:t=>this.default_connection_color_byType[t]||this.default_connection_color.output_on,getDisconnectedColor:t=>this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.output_off});h(this,"highquality_render");h(this,"use_gradients");h(this,"editor_alpha");h(this,"pause_rendering");h(this,"clear_background");h(this,"clear_background_color");h(this,"render_only_selected");h(this,"show_info");h(this,"allow_dragcanvas");h(this,"allow_dragnodes");h(this,"allow_interaction");h(this,"multi_select");h(this,"allow_searchbox");h(this,"allow_reconnect_links");h(this,"align_to_grid");h(this,"drag_mode");h(this,"dragging_rectangle");h(this,"filter");h(this,"set_canvas_dirty_on_mouse_event");h(this,"always_render_background");h(this,"render_shadows");h(this,"render_canvas_border");h(this,"render_connections_shadows");h(this,"render_connections_border");h(this,"render_curved_connections");h(this,"render_connection_arrows");h(this,"render_collapsed_slots");h(this,"render_execution_order");h(this,"render_link_tooltip");h(this,"linkMarkerShape",LinkMarkerShape.Circle);h(this,"links_render_mode");h(this,"low_quality_zoom_threshold",.6);h(this,"mouse");h(this,"graph_mouse");h(this,"canvas_mouse");h(this,"onSearchBox");h(this,"onSearchBoxSelection");h(this,"onMouse");h(this,"onDrawBackground");h(this,"onDrawForeground");h(this,"connections_width");h(this,"current_node");h(this,"node_widget");h(this,"over_link_center");h(this,"last_mouse_position");h(this,"visible_area");h(this,"renderedPaths",new Set);h(this,"visible_links",[]);h(this,"connecting_links");h(this,"linkConnector",new LinkConnector(t=>this.connecting_links=t));h(this,"viewport");h(this,"autoresize");h(this,"frame",0);h(this,"last_draw_time",0);h(this,"render_time",0);h(this,"fps",0);h(this,"selected_nodes",{});h(this,"selectedItems",new Set);h(this,"resizingGroup",null);h(this,"selected_group",null);h(this,"visible_nodes",[]);W(this,ae,new Set);h(this,"node_over");h(this,"node_capturing_input");h(this,"highlighted_links",{});W(this,ct,new Set);h(this,"dirty_canvas",!0);h(this,"dirty_bgcanvas",!0);h(this,"dirty_nodes",new Map);h(this,"dirty_area");h(this,"node_in_panel");h(this,"last_mouse",[0,0]);h(this,"last_mouseclick",0);h(this,"graph");h(this,"canvas");h(this,"bgcanvas");h(this,"ctx");h(this,"_events_binded");h(this,"bgctx");h(this,"is_rendering");h(this,"block_click");h(this,"last_click_position");h(this,"resizing_node");h(this,"selected_group_resizing");h(this,"last_mouse_dragging");h(this,"onMouseDown");h(this,"_highlight_pos");h(this,"_highlight_input");h(this,"node_panel");h(this,"options_panel");h(this,"_bg_img");h(this,"_pattern");h(this,"_pattern_img");h(this,"prompt_box");h(this,"search_box");h(this,"SELECTED_NODE");h(this,"NODEPANEL_IS_OPEN");W(this,ot);W(this,le,!1);h(this,"dragZoomEnabled",!1);W(this,Nt,null);h(this,"onClear");h(this,"onNodeMoved");h(this,"onSelectionChange");h(this,"onDrawLinkTooltip");h(this,"onDrawOverlay");h(this,"onRenderBackground");h(this,"onNodeDblClicked");h(this,"onShowNodePanel");h(this,"onNodeSelected");h(this,"onNodeDeselected");h(this,"onRender");n||(n={}),this.options=n,this.background_image=O.DEFAULT_BACKGROUND_IMAGE,this.ds=new DragAndScale(t),this.pointer=new CanvasPointer(t),this.linkConnector.events.addEventListener("link-created",()=>C(this,F,dt).call(this)),this.linkConnector.events.addEventListener("reset",()=>{this.connecting_links=null,this.dirty_bgcanvas=!0}),this.linkConnector.events.addEventListener("dropped-on-canvas",s=>{var a;if(!this.connecting_links)return;const o=s.detail;this.emitEvent({subType:"empty-release",originalEvent:o,linkReleaseContext:{links:this.connecting_links}});const r=this.linkConnector.renderLinks[0];if(LiteGraph.release_link_on_empty_shows_menu){const l=this.linkConnector.state.connectingTo==="input"?{node_from:r.node,slot_from:r.fromSlot,type_filter_in:r.fromSlot.type}:{node_to:r.node,slot_to:r.fromSlot,type_filter_out:r.fromSlot.type},u=(a=r.fromReroute)==null?void 0:a.id;"shiftKey"in o&&o.shiftKey?this.allow_searchbox&&this.showSearchBox(o,l):this.linkConnector.state.connectingTo==="input"?this.showConnectionMenu({nodeFrom:r.node,slotFrom:r.fromSlot,e:o,afterRerouteId:u}):this.showConnectionMenu({nodeTo:r.node,slotTo:r.fromSlot,e:o,afterRerouteId:u})}}),this.zoom_modify_alpha=!0,this.zoom_speed=1.1,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.render_only_selected=!0,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_link_tooltip=!0,this.links_render_mode=LinkRenderType.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.connections_width=3,this.current_node=null,this.node_widget=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.connecting_links=null,this.viewport=n.viewport||null,this.graph=i,i==null||i.attachCanvas(this),this.canvas=void 0,this.bgcanvas=void 0,this.ctx=void 0,this.setCanvas(t,n.skip_events),this.clear(),O._measureText=(s,o=this.inner_text_font)=>{const{ctx:r}=this,{font:a}=r;try{return r.font=o,r.measureText(s).width}finally{r.font=a}},n.skip_render||this.startRendering(),this.autoresize=n.autoresize}get subgraph(){return S(this,Et)}set subgraph(t){t!==S(this,Et)&&(H(this,Et,t),t&&this.dispatch("litegraph:set-graph",{oldGraph:S(this,Et),newGraph:t}))}dispatch(t,i){const n=new CustomEvent(t,{detail:i,bubbles:!0});return this.canvas.dispatchEvent(n)}dispatchEvent(t,i){this.canvas.dispatchEvent(new CustomEvent(t,{detail:i}))}get read_only(){return this.state.readOnly}set read_only(t){this.state.readOnly=t,C(this,F,Pe).call(this)}get isDragging(){return this.state.draggingItems}set isDragging(t){this.state.draggingItems=t}get hoveringOver(){return this.state.hoveringOver}set hoveringOver(t){this.state.hoveringOver=t,C(this,F,Pe).call(this)}get pointer_is_down(){return this.pointer.isDown}get pointer_is_double(){return this.pointer.isDouble}get dragging_canvas(){return this.state.draggingCanvas}set dragging_canvas(t){this.state.draggingCanvas=t,C(this,F,Pe).call(this)}get title_text_font(){return`${LiteGraph.NODE_TEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get inner_text_font(){return`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px ${LiteGraph.NODE_FONT}`}get maximumFps(){return S(this,vt)>Number.EPSILON?S(this,vt)/1e3:0}set maximumFps(t){H(this,vt,t>Number.EPSILON?1e3/t:0)}get round_radius(){return LiteGraph.ROUND_RADIUS}set round_radius(t){LiteGraph.ROUND_RADIUS=t}get low_quality(){return this.ds.scale<this.low_quality_zoom_threshold}get _graph(){if(!this.graph)throw new NullGraphError;return this.graph}static onGroupAdd(t,i,n){const s=O.active_canvas,o=new LiteGraph.LGraphGroup;if(o.pos=s.convertEventToCanvasOffset(n),!s.graph)throw new NullGraphError;s.graph.add(o)}static getBoundaryNodes(t){const i=Array.isArray(t)?t:Object.values(t);return getBoundaryNodes(i)??{top:null,right:null,bottom:null,left:null}}static alignNodes(t,i,n){alignNodes(Object.values(t),i,n),O.active_canvas.setDirty(!0,!0)}static onNodeAlign(t,i,n,s,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:r,parentMenu:s});function r(a){alignNodes(Object.values(O.active_canvas.selected_nodes),a.toLowerCase(),o),O.active_canvas.setDirty(!0,!0)}}static onGroupAlign(t,i,n,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:o,parentMenu:s});function o(r){alignNodes(Object.values(O.active_canvas.selected_nodes),r.toLowerCase()),O.active_canvas.setDirty(!0,!0)}}static createDistributeMenu(t,i,n,s){new LiteGraph.ContextMenu(["Vertically","Horizontally"],{event:n,callback:o,parentMenu:s});function o(r){const a=O.active_canvas;distributeNodes(Object.values(a.selected_nodes),r==="Horizontally"),a.setDirty(!0,!0)}}static onMenuAdd(t,i,n,s,o){const r=O.active_canvas,a=r.getCanvasWindow(),{graph:l}=r;if(!l)return;return u("",s),!1;function u(c,p){if(!l)return;const f=LiteGraph.getNodeTypesCategories(r.filter||l.filter).filter(_=>_.startsWith(c)),g=[];for(const _ of f){if(!_)continue;const y=new RegExp(`^(${c})`),b=_.replace(y,"").split("/",1)[0],k=c===""?`${b}/`:`${c}${b}/`;let w=b;w.includes("::")&&(w=w.split("::",2)[1]),g.findIndex(I=>I.value===k)===-1&&g.push({value:k,content:w,has_submenu:!0,callback:function(I,E,G,R){u(I.value,R)}})}const m=LiteGraph.getNodeTypesInCategory(c.slice(0,-1),r.filter||l.filter);for(const _ of m){if(_.skip_list)continue;const y={value:_.type,content:_.title,has_submenu:!1,callback:function(b,k,w,T){if(!r.graph)throw new NullGraphError;const I=T.getFirstEvent();r.graph.beforeChange();const E=LiteGraph.createNode(b.value);if(E){if(!I)throw new TypeError("Context menu event was null. This should not occur in normal usage.");E.pos=r.convertEventToCanvasOffset(I),r.graph.add(E)}else console.warn("Failed to create node of type:",b.value);o==null||o(E),r.graph.afterChange()}};g.push(y)}new LiteGraph.ContextMenu(g,{event:n,parentMenu:p},a)}}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalOutputs(t,i,n,s,o){var c;if(!o)return;const r=O.active_canvas;let a=[];LiteGraph.do_add_triggers_slots&&o.findOutputSlot("onExecuted")==-1&&a.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"});const l=(c=o.onMenuNodeOutputs)==null?void 0:c.call(o,a);if(l&&(a=l),!a.length)return;new LiteGraph.ContextMenu(a,{event:n,callback:u,parentMenu:s,node:o});function u(p,f,g){var y;if(!o||(p.callback&&p.callback.call(this,o,p,f,g),!p.value))return;const m=p.value[1];if(m&&(typeof m=="object"||Array.isArray(m))){const b=[];for(const k in m)b.push({content:k,value:m[k]});return new LiteGraph.ContextMenu(b,{event:f,callback:u,parentMenu:s,node:o}),!1}const{graph:_}=o;if(!_)throw new NullGraphError;_.beforeChange(),o.addOutput(p.value[0],p.value[1],p.value[2]),(y=o.onNodeOutputAdd)==null||y.call(o,p.value),r.setDirty(!0,!0),_.afterChange()}return!1}static onShowMenuNodeProperties(t,i,n,s,o){if(!o||!o.properties)return;const r=O.active_canvas,a=r.getCanvasWindow(),l=[];for(const c in o.properties){t=o.properties[c]!==void 0?o.properties[c]:" ",typeof t=="object"&&(t=JSON.stringify(t));const p=o.getPropertyInfo(c);(p.type=="enum"||p.type=="combo")&&(t=O.getPropertyPrintableValue(t,p.values)),t=O.decodeHTML(stringOrEmpty(t)),l.push({content:`<span class='property_name'>${p.label||c}</span><span class='property_value'>${t}</span>`,value:c})}if(!l.length)return;new LiteGraph.ContextMenu(l,{event:n,callback:u,parentMenu:s,allow_html:!0,node:o},a);function u(c){if(!o)return;const p=this.getBoundingClientRect();r.showEditPropertyValue(o,c.value,{position:[p.left,p.top]})}return!1}static decodeHTML(t){const i=document.createElement("div");return i.textContent=t,i.innerHTML}static onMenuResizeNode(t,i,n,s,o){if(!o)return;const r=function(l){l.setSize(l.computeSize())},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);a.setDirty(!0,!0)}static onShowPropertyEditor(t,i,n,s,o){const r=t.property||"title",a=o[r],l=document.createElement("span");l.className="name",l.textContent=r;const u=document.createElement("input");Object.assign(u,{type:"text",className:"value",autofocus:!0});const c=document.createElement("button");c.textContent="OK";const p=Object.assign(document.createElement("div"),{is_modified:!1,className:"graphdialog",close:()=>p.remove()});p.append(l,u,c),u.value=String(a),u.addEventListener("blur",function(){this.focus()}),u.addEventListener("keydown",T=>{if(p.is_modified=!0,T.key=="Escape")p.close();else if(T.key=="Enter")k();else if(!T.target||!("localName"in T.target)||T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()});const f=O.active_canvas,g=f.canvas,m=g.getBoundingClientRect(),_=m?-20-m.left:-20,y=m?-20-m.top:-20;if(n?(p.style.left=`${n.clientX+_}px`,p.style.top=`${n.clientY+y}px`):(p.style.left=`${g.width*.5+_}px`,p.style.top=`${g.height*.5+y}px`),c.addEventListener("click",k),g.parentNode==null)throw new TypeError("canvasEl.parentNode was null");g.parentNode.append(p),u.focus();let b;p.addEventListener("mouseleave",function(){LiteGraph.dialog_close_on_mouse_leave&&!p.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(p.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),p.addEventListener("mouseenter",function(){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});function k(){u&&w(u.value)}function w(T){t.type=="Number"?T=Number(T):t.type=="Boolean"&&(T=!!T),o[r]=T,p.remove(),f.setDirty(!0,!0)}}static getPropertyPrintableValue(t,i){if(!i||Array.isArray(i))return String(t);if(typeof i=="object"){let n="";for(const s in i)if(i[s]==t){n=s;break}return`${String(t)} (${n})`}}static onMenuNodeCollapse(t,i,n,s,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.collapse()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuToggleAdvanced(t,i,n,s,o){if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const r=function(l){l.toggleAdvanced()},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)r(o);else for(const l in a.selected_nodes)r(a.selected_nodes[l]);o.graph.afterChange()}static onMenuNodeMode(t,i,n,s,o){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:r,parentMenu:s,node:o});function r(a){if(!o)return;const l=Object.values(LiteGraph.NODE_MODES).indexOf(a),u=function(p){l!==-1&&LiteGraph.NODE_MODES[l]?p.changeMode(l):(console.warn(`unexpected mode: ${a}`),p.changeMode(LGraphEventMode.ALWAYS))},c=O.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)u(o);else for(const p in c.selected_nodes)u(c.selected_nodes[p])}return!1}static onMenuNodeColors(t,i,n,s,o){if(!o)throw"no node for color";const r=[];r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const l in O.node_colors){const u=O.node_colors[l];t={value:l,content:`<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid ${u.color}; background-color:${u.bgcolor}'>${l}</span>`},r.push(t)}new LiteGraph.ContextMenu(r,{event:n,callback:a,parentMenu:s,node:o});function a(l){if(!o)return;const u=function(p){const f=l.value?O.node_colors[l.value]:null;p.setColorOption(f)},c=O.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)u(o);else for(const p in c.selected_nodes)u(c.selected_nodes[p]);c.setDirty(!0,!0)}return!1}static onMenuNodeShapes(t,i,n,s,o){if(!o)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:r,parentMenu:s,node:o});function r(a){if(!o)return;if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const l=function(c){c.shape=a},u=O.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)l(o);else for(const c in u.selected_nodes)l(u.selected_nodes[c]);o.graph.afterChange(),u.setDirty(!0)}return!1}static onMenuNodeRemove(){O.active_canvas.deleteSelected()}static onMenuNodeClone(t,i,n,s,o){const{graph:r}=o;if(!r)throw new NullGraphError;r.beforeChange();const a=new Set,l=function(c,p){if(c.clonable===!1)return;const f=c.clone();if(f){if(f.pos=[c.pos[0]+5,c.pos[1]+5],!c.graph)throw new NullGraphError;c.graph.add(f),p.add(f)}},u=O.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)l(o,a);else for(const c in u.selected_nodes)l(u.selected_nodes[c],a);a.size&&u.selectNodes([...a]),r.afterChange(),u.setDirty(!0,!0)}clear(){var t,i;this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.selectedItems.clear(),this.state.selectionChanged=!0,(t=this.onSelectionChange)==null||t.call(this,this.selected_nodes),this.visible_nodes=[],this.node_over=void 0,this.node_capturing_input=null,this.connecting_links=null,this.highlighted_links={},this.dragging_canvas=!1,C(this,F,dt).call(this),this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer.reset(),this.visible_area.set([0,0,0,0]),(i=this.onClear)==null||i.call(this)}setGraph(t){const{graph:i}=this;t!==i&&(this.clear(),t.attachCanvas(this),this.dispatch("litegraph:set-graph",{newGraph:t,oldGraph:i}),C(this,F,dt).call(this))}openSubgraph(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n={bubbles:!0,detail:{subgraph:t,closingGraph:i},cancelable:!0};this.canvas.dispatchEvent(new CustomEvent("subgraph-opening",n))&&(this.clear(),this.subgraph=t,this.setGraph(t),this.canvas.dispatchEvent(new CustomEvent("subgraph-opened",n)))}getCurrentGraph(){return this.graph}setCanvas(t,i){var o;const n=C(this,F,mi).call(this,t);if(n===this.canvas||(!n&&this.canvas&&!i&&this.unbindEvents(),this.canvas=n,this.ds.element=n,this.pointer.element=n,!n))return;n.className+=" lgraphcanvas",n.data=this,this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height;const s=(o=n.getContext)==null?void 0:o.call(n,"2d");if(s==null)throw n.localName!="canvas"?`Element supplied for LGraphCanvas must be a <canvas> element, you passed a ${n.localName}`:"This browser doesn't support Canvas";this.ctx=s,i||this.bindEvents()}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already bound");return}const{canvas:t}=this,{document:i}=this.getCanvasWindow();this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),this._mouseout_callback=this.processMouseOut.bind(this),this._mousecancel_callback=this.processMouseCancel.bind(this),t.addEventListener("pointerdown",this._mousedown_callback,!0),t.addEventListener("wheel",this._mousewheel_callback,!1),t.addEventListener("pointerup",this._mouseup_callback,!0),t.addEventListener("pointermove",this._mousemove_callback),t.addEventListener("pointerout",this._mouseout_callback),t.addEventListener("pointercancel",this._mousecancel_callback,!0),t.addEventListener("contextmenu",this._doNothing),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),i.addEventListener("keyup",this._key_callback,!0),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events bound");return}const{document:t}=this.getCanvasWindow(),{canvas:i}=this;i.removeEventListener("pointercancel",this._mousecancel_callback),i.removeEventListener("pointerout",this._mouseout_callback),i.removeEventListener("pointermove",this._mousemove_callback),i.removeEventListener("pointerup",this._mouseup_callback),i.removeEventListener("pointerdown",this._mousedown_callback),i.removeEventListener("wheel",this._mousewheel_callback),i.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),i.removeEventListener("contextmenu",this._doNothing),i.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=void 0,this._mousewheel_callback=void 0,this._key_callback=void 0,this._events_binded=!1}setDirty(t,i){t&&(this.dirty_canvas=!0),i&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();const i=this.getCanvasWindow();if(this.is_rendering)if(S(this,vt)>0){const n=S(this,vt)-(LiteGraph.getTime()-this.last_draw_time);setTimeout(t.bind(this),Math.max(1,n))}else i.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}getWidgetAtCursor(t){return t??(t=this.node_over),t==null?void 0:t.getWidgetOnPos(this.graph_mouse[0],this.graph_mouse[1],!0)}updateMouseOverNodes(t,i){var o,r;if(!this.graph)throw new NullGraphError;const{pointer:n}=this,s=this.graph._nodes;for(const a of s)a.mouseOver&&t!=a&&(n.eDown||(n.resizeDirection=void 0),a.mouseOver=void 0,this._highlight_input=void 0,this._highlight_pos=void 0,this.linkConnector.overWidget=void 0,a.lostFocusAt=LiteGraph.getTime(),(r=(o=this.node_over)==null?void 0:o.onMouseLeave)==null||r.call(o,i),this.node_over=void 0,this.dirty_canvas=!0)}processMouseDown(t){var u,c;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&!t.altKey&&t.buttons){H(this,Nt,{pos:[t.x,t.y],scale:this.ds.scale});return}const{graph:i,pointer:n}=this;if(this.adjustMouseEvent(t),t.isPrimary&&n.down(t),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!i)return;const s=this.getCanvasWindow();O.active_canvas=this;const o=t.clientX,r=t.clientY;if(this.ds.viewport=this.viewport,!(!this.viewport||isInRect(o,r,this.viewport)))return;const l=i.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes)??void 0;if(this.mouse[0]=o,this.mouse[1]=r,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],n.isDouble=n.isDown&&t.isPrimary,n.isDown=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(s),((u=this.onMouse)==null?void 0:u.call(this,t))!=!0){if(t.button===0&&!n.isDouble)C(this,F,bi).call(this,t,l);else if(t.button===1)C(this,F,ki).call(this,t,l);else if((t.button===2||n.isDouble)&&this.allow_interaction&&!this.read_only){const{linkConnector:p,subgraph:f}=this;if(f!=null&&f.inputNode.containsPoint(this.graph_mouse))this.processSelect(f.inputNode,t,!0),f.inputNode.onPointerDown(t,n,p);else if(f!=null&&f.outputNode.containsPoint(this.graph_mouse))this.processSelect(f.outputNode,t,!0),f.outputNode.onPointerDown(t,n,p);else{if(l)this.processSelect(l,t,!0);else if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const g=i.getRerouteOnPos(t.canvasX,t.canvasY,S(this,ct));g&&(t.altKey?n.onClick=m=>{var _;m.altKey&&(g.selected&&(this.deselect(g),(_=this.onSelectionChange)==null||_.call(this,this.selected_nodes)),g.remove())}:this.processSelect(g,t,!0))}n.onClick??(n.onClick=()=>this.processContextMenu(l,t))}}this.last_mouse=[o,r],this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,i.change(),(!s.document.activeElement||s.document.activeElement.nodeName.toLowerCase()!="input"&&s.document.activeElement.nodeName.toLowerCase()!="textarea")&&t.preventDefault(),t.stopPropagation(),(c=this.onMouseDown)==null||c.call(this,t)}}processMouseMove(t){var m,_,y,b;if(this.dragZoomEnabled&&t.ctrlKey&&t.shiftKey&&S(this,Nt)){C(this,F,Li).call(this,t);return}this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0);const{graph:i,resizingGroup:n,linkConnector:s,pointer:o,subgraph:r}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const a=[t.clientX,t.clientY];this.mouse[0]=a[0],this.mouse[1]=a[1];const l=[a[0]-this.last_mouse[0],a[1]-this.last_mouse[1]];this.last_mouse=a;const{canvasX:u,canvasY:c}=t;this.graph_mouse[0]=u,this.graph_mouse[1]=c,t.isPrimary&&o.move(t);let p=CanvasItem.Nothing;if(r&&(p|=r.inputNode.onPointerMove(t),p|=r.outputNode.onPointerMove(t)),this.block_click){t.preventDefault();return}if(t.dragging=this.last_mouse_dragging,this.node_widget){const[k,w]=this.node_widget;if(w!=null&&w.mouse){const T=u-k.pos[0],I=c-k.pos[1],E=w.mouse(t,[T,I],k);E!=null&&(this.dirty_canvas=E)}}const f=i.getNodeOnPos(u,c,this.visible_nodes),g=this.dragging_rectangle;if(g)g[2]=u-g[0],g[3]=c-g[1],this.dirty_canvas=!0;else if(n)p|=CanvasItem.Group,o.resizeDirection="SE";else if(this.dragging_canvas)this.ds.offset[0]+=l[0]/this.ds.scale,this.ds.offset[1]+=l[1]/this.ds.scale,C(this,F,dt).call(this);else if((this.allow_interaction||f!=null&&f.flags.allow_interaction)&&!this.read_only){if(s.isConnecting&&(this.dirty_canvas=!0),this.updateMouseOverNodes(f,t),f){p|=CanvasItem.Node,f.redraw_on_mouse&&(this.dirty_canvas=!0);const k=[0,0],w=isOverNodeInput(f,u,c,k),T=isOverNodeOutput(f,u,c,k),I=f.getWidgetOnPos(u,c,!0)??void 0;if(!f.mouseOver){f.mouseOver={},this.node_over=f,this.dirty_canvas=!0;for(const G of S(this,ct))G.hideSlots(),this.dirty_bgcanvas=!0;(m=f.onMouseEnter)==null||m.call(f,t)}(_=f.onMouseMove)==null||_.call(f,t,[u-f.pos[0],c-f.pos[1]],this);const{mouseOver:E}=f;if(E.inputId!==w||E.outputId!==T||E.overWidget!==I){if(E.inputId=w,E.outputId=T,E.overWidget=I,s.overWidget=void 0,s.isConnecting){const G=s.renderLinks.at(0);let R,N;if(!(!G||!s.isNodeValidDrop(f))){if(s.state.connectingTo==="input"){if(I){const D=f.getSlotFromWidget(I);D&&s.isInputValidDrop(f,D)&&(N=D,R=f.getInputSlotPos(D),s.overWidget=I)}if(!s.overWidget){if(w===-1&&T===-1){const D=f.findInputByType(G.fromSlot.type);D&&(N=D.slot,R=f.getInputSlotPos(D.slot))}else w!=-1&&f.inputs[w]&&LiteGraph.isValidConnection(G.fromSlot.type,f.inputs[w].type)&&(R=k,N=f.inputs[w]);if(N){const D=f.getWidgetFromSlot(N);D&&(s.overWidget=D)}}}else if(s.state.connectingTo==="output")if(w===-1&&T===-1){const D=f.findOutputByType(G.fromSlot.type);D&&(R=f.getOutputPos(D.index))}else T!=-1&&f.outputs[T]&&LiteGraph.isValidConnection(G.fromSlot.type,f.outputs[T].type)&&(R=k)}this._highlight_pos=R,this._highlight_input=N}this.dirty_canvas=!0}o.eDown||(w===-1&&T===-1&&!I?o.resizeDirection=f.findResizeDirection(u,c):o.resizeDirection&&(o.resizeDirection=void 0))}else{p=C(this,F,Ii).call(this,p);const k=C(this,F,Ei).call(this,t);if(this.over_link_center!==k&&(p|=CanvasItem.Link,this.over_link_center=k,this.dirty_bgcanvas=!0),this.canvas){const w=i.getGroupOnPos(u,c);w&&!t.ctrlKey&&!this.read_only&&w.isInResize(u,c)?o.resizeDirection="SE":o.resizeDirection&&(o.resizeDirection=void 0)}}if(this.node_capturing_input&&this.node_capturing_input!=f&&((b=(y=this.node_capturing_input).onMouseMove)==null||b.call(y,t,[u-this.node_capturing_input.pos[0],c-this.node_capturing_input.pos[1]],this)),this.isDragging){const k=this.selectedItems,w=t.ctrlKey?k:getAllNestedItems(k),T=l[0]/this.ds.scale,I=l[1]/this.ds.scale;for(const E of w)E.move(T,I,!0);C(this,F,dt).call(this)}}this.hoveringOver=p,t.preventDefault()}processMouseUp(t){var r,a,l,u;if(t.isPrimary===!1)return;const{graph:i,pointer:n}=this;if(!i)return;O.active_canvas=this,this.adjustMouseEvent(t);const s=LiteGraph.getTime();if(t.click_time=s-this.last_mouseclick,n.up(t)===!0){n.isDown=!1,n.isDouble=!1,this.connecting_links=null,this.dragging_canvas=!1,i.change(),t.stopPropagation(),t.preventDefault();return}if(this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),t.button===0){this.selected_group=null,this.isDragging=!1;const c=t.canvasX,p=t.canvasY;this.linkConnector.isConnecting||(this.dirty_canvas=!0,(a=(r=this.node_over)==null?void 0:r.onMouseUp)==null||a.call(r,t,[c-this.node_over.pos[0],p-this.node_over.pos[1]],this),(u=(l=this.node_capturing_input)==null?void 0:l.onMouseUp)==null||u.call(l,t,[c-this.node_capturing_input.pos[0],p-this.node_capturing_input.pos[1]]))}else t.button===1?(this.dirty_canvas=!0,this.dragging_canvas=!1):t.button===2&&(this.dirty_canvas=!0);n.isDown=!1,n.isDouble=!1,i.change(),t.stopPropagation(),t.preventDefault()}processMouseOut(t){this.adjustMouseEvent(t),this.updateMouseOverNodes(null,t)}processMouseCancel(){console.warn("Pointer cancel!"),this.pointer.reset()}processMouseWheel(t){if(!this.graph||!this.allow_dragcanvas)return;const i=t.wheelDeltaY??t.detail*-60;this.adjustMouseEvent(t);const n=[t.clientX,t.clientY];if(this.viewport&&!isPointInRect(n,this.viewport))return;let{scale:s}=this.ds;LiteGraph.canvasNavigationMode==="legacy"||LiteGraph.canvasNavigationMode==="standard"&&t.ctrlKey?(i>0?s*=this.zoom_speed:i<0&&(s*=1/this.zoom_speed),this.ds.changeScale(s,[t.clientX,t.clientY])):LiteGraph.macTrackpadGestures&&(!LiteGraph.macGesturesRequireMac||navigator.userAgent.includes("Mac"))&&(t.metaKey&&!t.ctrlKey&&!t.shiftKey&&!t.altKey?(t.deltaY>0?s*=1/this.zoom_speed:t.deltaY<0&&(s*=this.zoom_speed),this.ds.changeScale(s,[t.clientX,t.clientY])):t.ctrlKey?(s*=1+t.deltaY*(1-this.zoom_speed)*.18,this.ds.changeScale(s,[t.clientX,t.clientY],!1)):t.shiftKey?this.ds.offset[0]-=t.deltaY*1.18*(1/s):(this.ds.offset[0]-=t.deltaX*1.18*(1/s),this.ds.offset[1]-=t.deltaY*1.18*(1/s))),this.graph.change(),t.preventDefault()}processKey(t){var s,o,r,a;H(this,le,t.shiftKey);const{graph:i}=this;if(!i)return;let n=!1;if(t.target.localName!="input"){if(t.type=="keydown"){if(t.key===" ")this.read_only=!0,this._previously_dragging_canvas===null&&(this._previously_dragging_canvas=this.dragging_canvas),this.dragging_canvas=this.pointer.isDown,n=!0;else if(t.key==="Escape"){if(this.linkConnector.isConnecting){this.linkConnector.reset(),t.preventDefault();return}(s=this.node_panel)==null||s.close(),(o=this.options_panel)==null||o.close(),(this.node_panel||this.options_panel)&&(n=!0)}else if(t.keyCode===65&&t.ctrlKey)this.selectItems(),n=!0;else if(t.keyCode===67&&(t.metaKey||t.ctrlKey)&&!t.shiftKey)this.selected_nodes&&(this.copyToClipboard(),n=!0);else if(t.keyCode===86&&(t.metaKey||t.ctrlKey))this.pasteFromClipboard({connectInputs:t.shiftKey});else if((t.key==="Delete"||t.key==="Backspace")&&t.target.localName!="input"&&t.target.localName!="textarea"){if(this.selectedItems.size===0){C(this,F,Si).call(this);return}this.deleteSelected(),n=!0}for(const l of Object.values(this.selected_nodes))(r=l.onKeyDown)==null||r.call(l,t)}else if(t.type=="keyup"){t.key===" "&&(this.read_only=!1,this.dragging_canvas=(this._previously_dragging_canvas??!1)&&this.pointer.isDown,this._previously_dragging_canvas=null);for(const l of Object.values(this.selected_nodes))(a=l.onKeyUp)==null||a.call(l,t)}i.change(),n&&(t.preventDefault(),t.stopImmediatePropagation())}}copyToClipboard(t){var s,o,r;const i={nodes:[],groups:[],reroutes:[],links:[],subgraphs:[]},n=new Set;for(const a of t??this.selectedItems)if(a instanceof LGraphNode){if(a.clonable===!1)continue;const l=(s=a.clone())==null?void 0:s.serialize();if(!l)continue;if(l.id=a.id,i.nodes.push(l),a.inputs)for(const{link:u}of a.inputs){if(u==null)continue;const c=(r=(o=this.graph)==null?void 0:o._links.get(u))==null?void 0:r.asSerialisable();c&&i.links.push(c)}a instanceof SubgraphNode&&n.add(a.subgraph)}else a instanceof LGraphGroup?i.groups.push(a.serialize()):a instanceof Reroute&&i.reroutes.push(a.asSerialisable());for(const a of n){const l=a.clone(!0).asSerialisable();i.subgraphs.push(l)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(i))}emitEvent(t){this.canvas.dispatchEvent(new CustomEvent("litegraph:canvas",{bubbles:!0,detail:t}))}emitBeforeChange(){this.emitEvent({subType:"before-change"})}emitAfterChange(){this.emitEvent({subType:"after-change"})}_pasteFromClipboard(t={}){var m;const{connectInputs:i=!1,position:n=this.graph_mouse}=t;if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&i)return;const s=localStorage.getItem("litegrapheditor_clipboard");if(!s)return;const{graph:o}=this;if(!o)throw new NullGraphError;o.beforeChange();const r=JSON.parse(s);r.nodes??(r.nodes=[]),r.groups??(r.groups=[]),r.reroutes??(r.reroutes=[]),r.links??(r.links=[]),r.subgraphs??(r.subgraphs=[]);let a=1/0,l=1/0;for(const _ of[...r.nodes,...r.reroutes]){if(_.pos==null)throw new TypeError("Invalid node encounterd on paste.  `pos` was null.");_.pos[0]<a&&(a=_.pos[0]),_.pos[1]<l&&(l=_.pos[1])}if(r.groups)for(const _ of r.groups)_.bounding[0]<a&&(a=_.bounding[0]),_.bounding[1]<l&&(l=_.bounding[1]);const u={created:[],nodes:new Map,links:new Map,reroutes:new Map,subgraphs:new Map},{created:c,nodes:p,links:f,reroutes:g}=u;for(const _ of r.subgraphs){const y=_.id;_.id=createUuidv4();const b=o.createSubgraph(_);b.configure(_),u.subgraphs.set(y,b)}for(const _ of r.groups){_.id=-1;const y=new LGraphGroup;y.configure(_),o.add(y),c.push(y)}for(const _ of r.nodes){const y=u.subgraphs.get(_.type);y&&(_.type=y.id);const b=_.type==null?null:LiteGraph.createNode(_.type);b&&(p.set(_.id,b),_.id=-1,b.configure(_),o.add(b),c.push(b))}for(const _ of r.reroutes){const{id:y,...b}=_,k=o.setReroute(b);c.push(k),g.set(y,k)}for(const _ of g.values()){if(_.parentId==null)continue;const y=g.get(_.parentId);y&&(_.parentId=y.id)}for(const _ of r.links){let y=p.get(_.origin_id),b;_.parentId!=null&&(b=(m=g.get(_.parentId))==null?void 0:m.id),i&&LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&(y??(y=o.getNodeById(_.origin_id)),b??(b=_.parentId));const k=p.get(_.target_id);if(k){const w=y==null?void 0:y.connect(_.origin_slot,k,_.target_slot,b);w&&f.set(_.id,w)}}for(const _ of g.values()){const y=[..._.linkIds].map(b=>{var k;return((k=f.get(b))==null?void 0:k.id)??b});_.update(_.parentId,void 0,y,_.floating),_.validateLinks(o.links,o.floatingLinks)||o.removeReroute(_.id)}for(const _ of c)_.pos[0]+=n[0]-a,_.pos[1]+=n[1]-l;return this.selectItems(c),o.afterChange(),u}pasteFromClipboard(t={}){this.emitBeforeChange();try{this._pasteFromClipboard(t)}finally{this.emitAfterChange()}}processNodeDblClicked(t){var i,n;(i=this.onShowNodePanel)==null||i.call(this,t),(n=this.onNodeDblClicked)==null||n.call(this,t),this.setDirty(!0)}processSelect(t,i,n=!1){var l;const s=i==null?void 0:i.shiftKey,o=i!=null&&(i.metaKey||i.ctrlKey),r=s||o,a=r||this.multi_select;if(!t)(!r||this.multi_select)&&this.deselectAll();else if(!t.selected||!this.selectedItems.has(t))a||this.deselectAll(t),this.select(t);else if(a&&!n)this.deselect(t);else if(!n)this.deselectAll(t);else return;(l=this.onSelectionChange)==null||l.call(this,this.selected_nodes),this.setDirty(!0)}select(t){var i,n;if(!(t.selected&&this.selectedItems.has(t))&&(t.selected=!0,this.selectedItems.add(t),this.state.selectionChanged=!0,t instanceof LGraphNode)){if((i=t.onSelected)==null||i.call(t),this.selected_nodes[t.id]=t,(n=this.onNodeSelected)==null||n.call(this,t),t.inputs)for(const s of t.inputs)s.link!=null&&(this.highlighted_links[s.link]=!0);if(t.outputs)for(const s of t.outputs.flatMap(o=>o.links))s!=null&&(this.highlighted_links[s]=!0)}}deselect(t){var n,s;if(!t.selected&&!this.selectedItems.has(t)||(t.selected=!1,this.selectedItems.delete(t),this.state.selectionChanged=!0,!(t instanceof LGraphNode)))return;(n=t.onDeselected)==null||n.call(t),delete this.selected_nodes[t.id],(s=this.onNodeDeselected)==null||s.call(this,t);const{graph:i}=this;if(i){if(t.inputs)for(const o of t.inputs){if(o.link==null)continue;const r=LLink.getOriginNode(i,o.link);r&&this.selectedItems.has(r)||delete this.highlighted_links[o.link]}if(t.outputs)for(const o of t.outputs.flatMap(r=>r.links)){if(o==null)continue;const r=LLink.getTargetNode(i,o);r&&this.selectedItems.has(r)||delete this.highlighted_links[o]}}}processNodeSelected(t,i){this.processSelect(t,i,i&&(i.shiftKey||i.metaKey||i.ctrlKey||this.multi_select))}selectNode(t,i){t==null?this.deselectAll():this.selectNodes([t],i)}get empty(){if(!this.graph)throw new NullGraphError;return this.graph.empty}get positionableItems(){if(!this.graph)throw new NullGraphError;return this.graph.positionableItems()}selectItems(t,i){var s;const n=t??this.positionableItems;i||this.deselectAll();for(const o of n)this.select(o);(s=this.onSelectionChange)==null||s.call(this,this.selected_nodes),this.setDirty(!0)}selectNodes(t,i){this.selectItems(t,i)}deselectNode(t){this.deselect(t)}deselectAll(t){var o,r;if(!this.graph)return;const i=this.selectedItems;if(!i.size)return;let n;for(const a of i){if(a===t){n=a;continue}(o=a.onDeselected)==null||o.call(a),a.selected=!1}i.clear(),n&&i.add(n),this.setDirty(!0);const s=(t==null?void 0:t.id)==null?null:this.selected_nodes[t.id];if(this.selected_nodes={},this.current_node=null,this.highlighted_links={},t instanceof LGraphNode){if(s&&(this.selected_nodes[s.id]=s),t.inputs)for(const a of t.inputs)a.link!=null&&(this.highlighted_links[a.link]=!0);if(t.outputs)for(const a of t.outputs.flatMap(l=>l.links))a!=null&&(this.highlighted_links[a]=!0)}this.state.selectionChanged=!0,(r=this.onSelectionChange)==null||r.call(this,this.selected_nodes)}deselectAllNodes(){this.deselectAll()}deleteSelected(){var i,n;const{graph:t}=this;if(!t)throw new NullGraphError;this.emitBeforeChange(),t.beforeChange();for(const s of this.selectedItems)if(s instanceof LGraphNode){const o=s;if(o.block_delete)continue;o.connectInputToOutput(),t.remove(o),(i=this.onNodeDeselected)==null||i.call(this,o)}else s instanceof LGraphGroup?t.remove(s):s instanceof Reroute&&t.removeReroute(s.id);this.selected_nodes={},this.selectedItems.clear(),this.current_node=null,this.highlighted_links={},this.state.selectionChanged=!0,(n=this.onSelectionChange)==null||n.call(this,this.selected_nodes),this.setDirty(!0),t.afterChange(),this.emitAfterChange()}deleteSelectedNodes(){this.deleteSelected()}centerOnNode(t){const i=(window==null?void 0:window.devicePixelRatio)||1;this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/(this.ds.scale*i),this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/(this.ds.scale*i),this.setDirty(!0,!0)}adjustMouseEvent(t){let i=t.clientX,n=t.clientY;if(this.canvas){const s=this.canvas.getBoundingClientRect();i-=s.left,n-=s.top}t.safeOffsetX=i,t.safeOffsetY=n,t.deltaX===void 0&&(t.deltaX=i-this.last_mouse_position[0]),t.deltaY===void 0&&(t.deltaY=n-this.last_mouse_position[1]),this.last_mouse_position[0]=i,this.last_mouse_position[1]=n,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=n/this.ds.scale-this.ds.offset[1]}setZoom(t,i){this.ds.changeScale(t,i),C(this,F,dt).call(this)}convertOffsetToCanvas(t,i){return this.ds.convertOffsetToCanvas(t,i)}convertCanvasToOffset(t,i){return this.ds.convertCanvasToOffset(t,i)}convertEventToCanvasOffset(t){const i=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-i.left,t.clientY-i.top])}bringToFront(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n=i._nodes.indexOf(t);n!=-1&&(i._nodes.splice(n,1),i._nodes.push(t))}sendToBack(t){const{graph:i}=this;if(!i)throw new NullGraphError;const n=i._nodes.indexOf(t);n!=-1&&(i._nodes.splice(n,1),i._nodes.unshift(t))}computeVisibleNodes(t,i){const n=i||[];if(n.length=0,!this.graph)throw new NullGraphError;const s=t||this.graph._nodes;for(const o of s)o.updateArea(this.ctx),overlapBounding(this.visible_area,o.renderArea)&&n.push(o);return n}isNodeVisible(t){return S(this,ae).has(t.id)}draw(t,i){var s;if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const n=LiteGraph.getTime();if(this.render_time=(n-this.last_draw_time)*.001,this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),this.dirty_canvas||t){this.computeVisibleNodes(void 0,this.visible_nodes),H(this,ae,new Set(this.visible_nodes.map(r=>r.id)));const{subgraph:o}=this;o&&(o.inputNode.arrange(),o.outputNode.arrange())}(this.dirty_bgcanvas||i||this.always_render_background||(s=this.graph)!=null&&s._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame++}drawFrontCanvas(){var r,a,l,u,c,p,f;this.dirty_canvas=!1;const{ctx:t,canvas:i,graph:n,linkConnector:s}=this;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));const o=this.viewport||this.dirty_area;if(o&&(t.save(),t.beginPath(),t.rect(o[0],o[1],o[2],o[3]),t.clip()),H(this,ot,S(this,le)||LiteGraph.alwaysSnapToGrid?(r=this.graph)==null?void 0:r.getSnapToGridSize():void 0),this.clear_background&&(o?t.clearRect(o[0],o[1],o[2],o[3]):t.clearRect(0,0,i.width,i.height)),this.bgcanvas==this.canvas)this.drawBackCanvas();else{const g=window.devicePixelRatio;t.drawImage(this.bgcanvas,0,0,this.bgcanvas.width/g,this.bgcanvas.height/g)}if((a=this.onRender)==null||a.call(this,i,t),this.show_info&&this.renderInfo(t,o?o[0]:0,o?o[1]:0),n){t.save(),this.ds.toCanvasContext(t);const{visible_nodes:g}=this,m=S(this,ot)&&this.isDragging;for(const _ of g)t.save(),m&&this.selectedItems.has(_)&&this.drawSnapGuide(t,_),t.translate(_.pos[0],_.pos[1]),this.drawNode(_,t),t.restore();if((u=this.subgraph)==null||u.draw(t,this.colourGetter,(l=this.linkConnector.renderLinks[0])==null?void 0:l.fromSlot,this.editor_alpha),this.render_execution_order&&this.drawExecutionOrder(t),n.config.links_ontop&&this.drawConnections(t),s.isConnecting){const{renderLinks:_}=s,y=C(this,F,Ni).call(this);t.lineWidth=this.connections_width;for(const b of _){const{fromSlot:k,fromPos:w,fromDirection:T,dragDirection:I}=b,E=k.shape,G=k.type,R=G===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR;this.renderLink(t,w,y,null,!1,null,R,T,I),t.beginPath(),G===LiteGraph.EVENT||E===RenderShape.BOX?(t.rect(w[0]-6+.5,w[1]-5+.5,14,10),t.rect(y[0]-6+.5,y[1]-5+.5,14,10)):E===RenderShape.ARROW?(t.moveTo(w[0]+8,w[1]+.5),t.lineTo(w[0]-4,w[1]+6+.5),t.lineTo(w[0]-4,w[1]-6+.5),t.closePath()):(t.arc(w[0],w[1],4,0,Math.PI*2),t.arc(y[0],y[1],4,0,Math.PI*2)),t.fill()}C(this,F,Ci).call(this,t,y)}if(this.dragging_rectangle){const{eDown:_,eMove:y}=this.pointer;if(t.strokeStyle="#FFF",_&&y){const b=t.getTransform(),k=Math.max(1,window.devicePixelRatio);t.setTransform(k,0,0,k,0,0);const w=_.safeOffsetX,T=_.safeOffsetY;t.strokeRect(w,T,y.safeOffsetX-w,y.safeOffsetY-T),t.setTransform(b)}else{const[b,k,w,T]=this.dragging_rectangle;t.strokeRect(b,k,w,T)}}!this.isDragging&&this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):(c=this.onDrawLinkTooltip)==null||c.call(this,t,null),(p=this.onDrawForeground)==null||p.call(this,t,this.visible_area),t.restore()}(f=this.onDrawOverlay)==null||f.call(this,t),o&&t.restore()}renderInfo(t,i,n){i=i||10,n=n||this.canvas.offsetHeight-80,t.save(),t.translate(i,n),t.font=`10px ${LiteGraph.DEFAULT_FONT}`,t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText(`T: ${this.graph.globaltime.toFixed(2)}s`,5,13*1),t.fillText(`I: ${this.graph.iteration}`,5,13*2),t.fillText(`N: ${this.graph._nodes.length} [${this.visible_nodes.length}]`,5,13*3),t.fillText(`V: ${this.graph._version}`,5,13*4),t.fillText(`FPS:${this.fps.toFixed(2)}`,5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var o;const t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const i=this.bgctx;if(!i)throw new TypeError("Background canvas context was null.");const n=this.viewport||[0,0,i.canvas.width,i.canvas.height];this.clear_background&&i.clearRect(n[0],n[1],n[2],n[3]);const s=this.onRenderBackground?this.onRenderBackground(t,i):!1;if(!this.viewport){const r=window.devicePixelRatio;i.restore(),i.setTransform(r,0,0,r,0,0)}if(this.graph){if(i.save(),this.ds.toCanvasContext(i),this.ds.scale<1.5&&!s&&this.clear_background_color&&(i.fillStyle=this.clear_background_color,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!s){if(this.zoom_modify_alpha?i.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:i.globalAlpha=this.editor_alpha,i.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const a=this;this._bg_img.addEventListener("load",function(){a.draw(!0,!0)})}let r=this._pattern;r==null&&this._bg_img.width>0&&(r=i.createPattern(this._bg_img,"repeat")??void 0,this._pattern_img=this._bg_img,this._pattern=r),r&&(i.fillStyle=r,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),i.fillStyle="transparent"),i.globalAlpha=1,i.imageSmoothingEnabled=!0}this.graph._groups.length&&this.drawGroups(t,i),(o=this.onDrawBackground)==null||o.call(this,i,this.visible_area),this.render_canvas_border&&(i.strokeStyle="#235",i.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(i.shadowColor="#000",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=6):i.shadowColor="rgba(0,0,0,0)",this.drawConnections(i),i.shadowColor="rgba(0,0,0,0)",i.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,i){var u,c,p;this.current_node=t;const n=t.renderingColor,s=t.renderingBgColor,{low_quality:o,editor_alpha:r}=this;if(i.globalAlpha=r,this.render_shadows&&!o?(i.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,i.shadowOffsetX=2*this.ds.scale,i.shadowOffsetY=2*this.ds.scale,i.shadowBlur=3*this.ds.scale):i.shadowColor="transparent",t.flags.collapsed&&((u=t.onDrawCollapsed)==null?void 0:u.call(t,i,this))==!0)return;const a=t._shape||RenderShape.BOX,l=S(O,Le);if(l.set(t.renderingSize),t.collapsed&&(i.font=this.inner_text_font),t.clip_area&&(i.save(),i.beginPath(),a==RenderShape.BOX?i.rect(0,0,l[0],l[1]):a==RenderShape.ROUND?i.roundRect(0,0,l[0],l[1],[10]):a==RenderShape.CIRCLE&&i.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),i.clip()),this.drawNodeShape(t,i,l,n,s,!!t.selected),t.title_buttons&&!t.flags.collapsed){const f=LiteGraph.NODE_TITLE_HEIGHT;let g=l[0];for(let m=0;m<t.title_buttons.length;m++){const _=t.title_buttons[m];if(!_.visible)continue;const y=_.getWidth(i);g-=y;const b=-f+(f-_.height)/2;_.draw(i,g,b),g-=2}}o||t.drawBadges(i),i.shadowColor="transparent",i.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,(c=t.onDrawForeground)==null||c.call(t,i,this,this.canvas),i.font=this.inner_text_font,t._setConcreteSlots(),t.collapsed?this.render_collapsed_slots&&t.drawCollapsedSlots(i):(t.arrange(),t.drawSlots(i,{fromSlot:(p=this.linkConnector.renderLinks[0])==null?void 0:p.fromSlot,colorContext:this.colourGetter,editorAlpha:this.editor_alpha,lowQuality:this.low_quality}),i.textAlign="left",i.globalAlpha=1,this.drawNodeWidgets(t,null,i)),t.clip_area&&i.restore(),i.globalAlpha=1}drawLinkTooltip(t,i){var u;const n=i._pos;if(t.fillStyle="black",t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const c=t.getTransform();t.translate(n[0],n[1]),Number.isFinite(i._centreAngle)&&t.rotate(i._centreAngle),t.moveTo(-2,-3),t.lineTo(4,0),t.lineTo(-2,3),t.setTransform(c)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(n[0],n[1],3,0,Math.PI*2);t.fill();const{data:s}=i;if(s==null||((u=this.onDrawLinkTooltip)==null?void 0:u.call(this,t,i,this))==!0)return;let o=null;if(typeof s=="number"?o=s.toFixed(2):typeof s=="string"?o=`"${s}"`:typeof s=="boolean"?o=String(s):s.toToolTip?o=s.toToolTip():o=`[${s.constructor.name}]`,o==null)return;o=o.substring(0,30),t.font="14px Courier New";const a=t.measureText(o).width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-a*.5,n[1]-15-l,a,l,[3]),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(o,n[0],n[1]-15-l*.3)}drawNodeShape(t,i,n,s,o,r){var _,y;i.strokeStyle=s,i.fillStyle=o;const a=LiteGraph.NODE_TITLE_HEIGHT,{low_quality:l}=this,{collapsed:u}=t.flags,c=t.renderingShape,{title_mode:p}=t,f=!(p==TitleMode.TRANSPARENT_TITLE||p==TitleMode.NO_TITLE),g=S(O,Ie);g.set(t.boundingRect),g[0]-=t.pos[0],g[1]-=t.pos[1];const m=i.globalAlpha;i.beginPath(),c==RenderShape.BOX||l?i.rect(g[0],g[1],g[2],g[3]):c==RenderShape.ROUND||c==RenderShape.CARD?i.roundRect(g[0],g[1],g[2],g[3],c==RenderShape.CARD?[LiteGraph.ROUND_RADIUS,LiteGraph.ROUND_RADIUS,0,0]:[LiteGraph.ROUND_RADIUS]):c==RenderShape.CIRCLE&&i.arc(n[0]*.5,n[1]*.5,n[0]*.5,0,Math.PI*2),i.fill(),!u&&f&&(i.shadowColor="transparent",i.fillStyle="rgba(0,0,0,0.2)",i.fillRect(0,-1,g[2],2)),i.shadowColor="transparent",(_=t.onDrawBackground)==null||_.call(t,i),(f||p==TitleMode.TRANSPARENT_TITLE)&&(t.drawTitleBarBackground(i,{scale:this.ds.scale,low_quality:l}),t.drawTitleBox(i,{scale:this.ds.scale,low_quality:l,box_size:10}),i.globalAlpha=m,t.drawTitleText(i,{scale:this.ds.scale,default_title_color:this.node_title_color,low_quality:l}),(y=t.onDrawTitle)==null||y.call(t,i));for(const b of Object.values(t.strokeStyles)){const k=b.call(t);k&&strokeShape(i,g,{shape:c,title_height:a,title_mode:p,collapsed:u,...k})}t.drawProgressBar(i),t.execute_triggered!=null&&t.execute_triggered>0&&t.execute_triggered--,t.action_triggered!=null&&t.action_triggered>0&&t.action_triggered--}drawSnapGuide(t,i,n=RenderShape.ROUND){const s=S(O,ke);s.set(i.boundingRect);const{pos:o}=i,r=o[0]-s[0],a=o[1]-s[1];s[0]+=r,s[1]+=a,S(this,ot)&&snapPoint(s,S(this,ot)),s[0]-=r,s[1]-=a;const{globalAlpha:l}=t;t.globalAlpha=1,t.beginPath();const[u,c,p,f]=s;if(n===RenderShape.CIRCLE){const g=u+p*.5,m=c+f*.5,_=Math.min(p*.5,f*.5);t.arc(g,m,_,0,Math.PI*2)}else t.rect(u,c,p,f);t.lineWidth=.5,t.strokeStyle="#FFFFFF66",t.fillStyle="#FFFFFF22",t.fill(),t.stroke(),t.globalAlpha=l}drawConnections(t){if(this.renderedPaths.clear(),this.links_render_mode===LinkRenderType.HIDDEN_LINK)return;const{graph:i,subgraph:n}=this;if(!i)throw new NullGraphError;const s=[],o=LiteGraph.getTime(),{visible_area:r}=this;S(O,bt)[0]=r[0]-20,S(O,bt)[1]=r[1]-20,S(O,bt)[2]=r[2]+40,S(O,bt)[3]=r[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;const a=i._nodes;for(const u of a){const{inputs:c}=u;if(c!=null&&c.length)for(const[p,f]of c.entries()){if(!f||f.link==null)continue;const g=f.link,m=i._links.get(g);if(!m)continue;const _=u.getInputPos(p),y=i.getNodeById(m.origin_id);if(y==null)continue;const b=m.origin_slot,k=b===-1?[y.pos[0]+10,y.pos[1]+10]:y.getOutputPos(b),w=y.outputs[b];w&&C(this,F,Xt).call(this,t,m,k,_,s,o,w.dir,f.dir)}}if(n){for(const u of n.inputNode.slots)if(u.linkIds.length)for(const c of u.linkIds){const p=LLink.resolve(c,i);if(!p)continue;const{link:f,inputNode:g,input:m}=p;if(!g||!m)continue;const _=g.getInputPos(f.target_slot);C(this,F,Xt).call(this,t,f,u.pos,_,s,o,m.dir,m.dir)}for(const u of n.outputNode.slots){if(!u.linkIds.length)continue;const c=LLink.resolve(u.linkIds[0],i);if(!c)continue;const{link:p,outputNode:f,output:g}=c;if(!f||!g)continue;const m=f.getOutputPos(p.origin_slot);C(this,F,Xt).call(this,t,p,m,u.pos,s,o,g.dir,u.dir)}}i.floatingLinks.size>0&&C(this,F,Oi).call(this,t,i,s,o);const l=S(this,ct);l.clear(),s.sort((u,c)=>u.linkIds.size-c.linkIds.size);for(const u of s)l.add(u),S(this,ot)&&this.isDragging&&this.selectedItems.has(u)&&this.drawSnapGuide(t,u,RenderShape.CIRCLE),u.draw(t,this._pattern),this.pointer.isDown||u.drawSlots(t);t.globalAlpha=1}renderLink(t,i,n,s,o,r,a,l,u,{startControl:c,endControl:p,reroute:f,num_sublines:g=1,disabled:m=!1}={}){const _=s!=null&&this.highlighted_links[s.id]?"#FFF":a||(s==null?void 0:s.color)||(s==null?void 0:s.type)!=null&&O.link_type_colors[s.type]||this.default_link_color,y=l||LinkDirection.RIGHT,b=u||LinkDirection.LEFT,k=this.links_render_mode==LinkRenderType.SPLINE_LINK&&(!p||!c)?distance(i,n):0;this.render_connections_border&&!this.low_quality&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",g||(g=1),g>1&&(t.lineWidth=.5);const w=new Path2D,T=f??s;T&&(T.path=w);const I=S(O,Se),E=S(O,Te),G=(T==null?void 0:T._pos)??[0,0];for(let R=0;R<g;R++){const N=(R-(g-1)*.5)*5;if(I[0]=i[0],I[1]=i[1],E[0]=n[0],E[1]=n[1],this.links_render_mode==LinkRenderType.SPLINE_LINK){if(p?(E[0]=n[0]+p[0],E[1]=n[1]+p[1]):C(this,F,ye).call(this,E,b,k),c?(I[0]=i[0]+c[0],I[1]=i[1]+c[1]):C(this,F,ye).call(this,I,y,k),w.moveTo(i[0],i[1]+N),w.bezierCurveTo(I[0],I[1]+N,E[0],E[1]+N,n[0],n[1]+N),findPointOnCurve(G,i,n,I,E,.5),T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const D=S(O,Ee);findPointOnCurve(D,i,n,I,E,.51),T._centreAngle=Math.atan2(D[1]-G[1],D[0]-G[0])}}else{const D=this.links_render_mode==LinkRenderType.LINEAR_LINK?15:10;switch(y){case LinkDirection.LEFT:I[0]+=-D;break;case LinkDirection.RIGHT:I[0]+=D;break;case LinkDirection.UP:I[1]+=-D;break;case LinkDirection.DOWN:I[1]+=D;break}switch(b){case LinkDirection.LEFT:E[0]+=-D;break;case LinkDirection.RIGHT:E[0]+=D;break;case LinkDirection.UP:E[1]+=-D;break;case LinkDirection.DOWN:E[1]+=D;break}if(this.links_render_mode==LinkRenderType.LINEAR_LINK)w.moveTo(i[0],i[1]+N),w.lineTo(I[0],I[1]+N),w.lineTo(E[0],E[1]+N),w.lineTo(n[0],n[1]+N),G[0]=(I[0]+E[0])*.5,G[1]=(I[1]+E[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow&&(T._centreAngle=Math.atan2(E[1]-I[1],E[0]-I[0]));else if(this.links_render_mode==LinkRenderType.STRAIGHT_LINK){const P=(I[0]+E[0])*.5;if(w.moveTo(i[0],i[1]),w.lineTo(I[0],I[1]),w.lineTo(P,I[1]),w.lineTo(P,E[1]),w.lineTo(E[0],E[1]),w.lineTo(n[0],n[1]),G[0]=P,G[1]=(I[1]+E[1])*.5,T&&this.linkMarkerShape===LinkMarkerShape.Arrow){const B=E[1]-I[1];Math.abs(B)<4?T._centreAngle=0:B>0?T._centreAngle=Math.PI*.5:T._centreAngle=-(Math.PI*.5)}}else return}}if(this.render_connections_border&&!this.low_quality&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke(w)),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=_,t.stroke(w),this.ds.scale>=.6&&this.highquality_render&&T){if(this.render_connection_arrows){const R=this.computeConnectionPoint(i,n,.25,y,b),N=this.computeConnectionPoint(i,n,.26,y,b),D=this.computeConnectionPoint(i,n,.75,y,b),P=this.computeConnectionPoint(i,n,.76,y,b);let B=0,X=0;this.render_curved_connections?(B=-Math.atan2(N[0]-R[0],N[1]-R[1]),X=-Math.atan2(P[0]-D[0],P[1]-D[1])):X=B=n[1]>i[1]?0:Math.PI;const A=t.getTransform();t.translate(R[0],R[1]),t.rotate(B),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(A),t.translate(D[0],D[1]),t.rotate(X),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.setTransform(A)}if(t.beginPath(),this.linkMarkerShape===LinkMarkerShape.Arrow){const R=t.getTransform();t.translate(G[0],G[1]),T._centreAngle&&t.rotate(T._centreAngle),t.moveTo(-3.2,-5),t.lineTo(7,0),t.lineTo(-3.2,5),t.setTransform(R)}else(this.linkMarkerShape==null||this.linkMarkerShape===LinkMarkerShape.Circle)&&t.arc(G[0],G[1],5,0,Math.PI*2);if(m){const{fillStyle:R,globalAlpha:N}=t;t.fillStyle=this._pattern??"#797979",t.globalAlpha=.75,t.fill(),t.globalAlpha=N,t.fillStyle=R}if(t.fill(),LLink._drawDebug){const{fillStyle:R,font:N,globalAlpha:D,lineWidth:P,strokeStyle:B}=t;t.globalAlpha=1,t.lineWidth=4,t.fillStyle="white",t.strokeStyle="black",t.font="16px Arial";const X=String(T.id),{width:A,actualBoundingBoxAscent:L}=t.measureText(X),j=G[0]-A*.5,Y=G[1]+L*.5;t.strokeText(X,j,Y),t.fillText(X,j,Y),t.font=N,t.globalAlpha=D,t.lineWidth=P,t.fillStyle=R,t.strokeStyle=B}}if(r){t.fillStyle=_;for(let R=0;R<5;++R){const N=(LiteGraph.getTime()*.001+R*.2)%1,D=this.computeConnectionPoint(i,n,N,y,b);t.beginPath(),t.arc(D[0],D[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,i,n,s,o){s||(s=LinkDirection.RIGHT),o||(o=LinkDirection.LEFT);const r=distance(t,i),a=[t[0],t[1]],l=[i[0],i[1]];C(this,F,ye).call(this,a,s,r),C(this,F,ye).call(this,l,o,r);const u=(1-n)*(1-n)*(1-n),c=3*((1-n)*(1-n))*n,p=3*(1-n)*(n*n),f=n*n*n,g=u*t[0]+c*a[0]+p*l[0]+f*i[0],m=u*t[1]+c*a[1]+p*l[1]+f*i[1];return[g,m]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;const{visible_nodes:i}=this;for(const n of i)t.fillStyle="black",t.fillRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),n.order==0&&t.strokeRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(stringOrEmpty(n.order),n.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,n.pos[1]-6);t.globalAlpha=1}drawNodeWidgets(t,i,n){t.drawWidgets(n,{lowQuality:this.low_quality,editorAlpha:this.editor_alpha})}drawGroups(t,i){if(!this.graph)return;const n=this.graph._groups;i.save(),i.globalAlpha=.5*this.editor_alpha;const s=S(this,ot)&&this.isDragging;for(const o of n)overlapBounding(this.visible_area,o._bounding)&&(s&&this.selectedItems.has(o)&&this.drawSnapGuide(i,o),o.draw(this,i));i.restore()}resize(t,i){if(!t&&!i){const n=this.canvas.parentElement;if(!n)throw new TypeError("Attempted to resize canvas, but parent element was null.");t=n.offsetWidth,i=n.offsetHeight}this.canvas.width==t&&this.canvas.height==i||(this.canvas.width=t??0,this.canvas.height=i??0,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}onNodeSelectionChange(){}boundaryNodesForSelection(){return O.getBoundaryNodes(this.selected_nodes)}showLinkMenu(t,i){var f,g;const{graph:n}=this;if(!n)throw new NullGraphError;const s="data"in t&&t.data!=null?t.data.constructor.name:void 0,{origin_id:o,origin_slot:r}=t;if(o==null||r==null)return new LiteGraph.ContextMenu(["Link has no origin"],{event:i,title:s}),!1;const a=n.getNodeById(o),l=(g=(f=a==null?void 0:a.outputs)==null?void 0:f[r])==null?void 0:g.type,u=["Add Node","Add Reroute",null,"Delete",null],c=new LiteGraph.ContextMenu(u,{event:i,title:s,callback:p.bind(this)});return!1;function p(m,_,y){if(!n)throw new NullGraphError;switch(m){case"Add Node":O.onMenuAdd(null,null,y,c,b=>{var w,T;if(!((w=b==null?void 0:b.inputs)!=null&&w.length)||!((T=b==null?void 0:b.outputs)!=null&&T.length)||r==null)return;const k={afterRerouteId:t.parentId};a!=null&&a.connectByType(r,b,l??"*",k)&&(b.pos[0]-=b.size[0]*.5)});break;case"Add Reroute":{try{this.emitBeforeChange(),this.adjustMouseEvent(y),n.createReroute(t._pos,t),this.setDirty(!1,!0)}catch(b){console.error(b)}finally{this.emitAfterChange()}break}case"Delete":n.removeLink(t.id);break}}}createDefaultNodeForSlot(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[0,0],nodeType:void 0,posAdd:[0,0],posSizeFix:[0,0]},t),{afterRerouteId:n}=i,s=i.nodeFrom&&i.slotFrom!==null,o=!s&&i.nodeTo&&i.slotTo!==null;if(!s&&!o)return console.warn("No data passed to createDefaultNodeForSlot",i.nodeFrom,i.slotFrom,i.nodeTo,i.slotTo),!1;if(!i.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const r=s?i.nodeFrom:i.nodeTo;if(!r)throw new TypeError("nodeX was null when creating default node for slot.");let a=s?i.slotFrom:i.slotTo,l=!1;if(r instanceof SubgraphIONodeBase){if(typeof a!="object"||!a)return console.warn("Cant get slot information",a),!1;const{name:p}=a;if(l=r.slots.findIndex(f=>f.name===p),a=r.slots[l],!a)return console.warn("Cant get slot information",a),!1}else switch(typeof a){case"string":l=s?r.findOutputSlot(a,!1):r.findInputSlot(a,!1),a=s?r.outputs[a]:r.inputs[a];break;case"object":if(a===null)return console.warn("Cant get slot information",a),!1;l=s?r.findOutputSlot(a.name):r.findInputSlot(a.name);break;case"number":l=a,a=s?r.outputs[a]:r.inputs[a];break;case"undefined":default:return console.warn("Cant get slot information",a),!1}const u=a.type==LiteGraph.EVENT?"_event_":a.type,c=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(c!=null&&c[u]){let p=!1;if(typeof c[u]=="object"){for(const f in c[u])if(i.nodeType==c[u][f]||i.nodeType=="AUTO"){p=c[u][f];break}}else(i.nodeType==c[u]||i.nodeType=="AUTO")&&(p=c[u]);if(p){let f=!1;typeof p=="object"&&p.node&&(f=p,p=p.node);const g=LiteGraph.createNode(p);if(g){if(f){if(f.properties)for(const y in f.properties)g.addProperty(y,f.properties[y]);if(f.inputs){g.inputs=[];for(const y in f.inputs)g.addOutput(f.inputs[y][0],f.inputs[y][1])}if(f.outputs){g.outputs=[];for(const y in f.outputs)g.addOutput(f.outputs[y][0],f.outputs[y][1])}f.title&&(g.title=f.title),f.json&&g.configure(f.json)}if(!this.graph)throw new NullGraphError;this.graph.add(g),g.pos=[i.position[0]+i.posAdd[0]+(i.posSizeFix[0]?i.posSizeFix[0]*g.size[0]:0),i.position[1]+i.posAdd[1]+(i.posSizeFix[1]?i.posSizeFix[1]*g.size[1]:0)];const m={node:g,opts:i};if(!this.canvas.dispatchEvent(new CustomEvent("connect-new-default-node",{detail:m,cancelable:!0})))return!0;if(s){if(!i.nodeFrom)throw new TypeError("createDefaultNodeForSlot - nodeFrom was null");i.nodeFrom.connectByType(l,g,u,{afterRerouteId:n})}else{if(!i.nodeTo)throw new TypeError("createDefaultNodeForSlot - nodeTo was null");i.nodeTo.connectByTypeOutput(l,g,u,{afterRerouteId:n})}return!0}console.log(`failed creating ${p}`)}}return!1}showConnectionMenu(t){const i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:void 0,allow_searchbox:this.allow_searchbox,showSearchBox:this.showSearchBox},t||{}),n=()=>C(this,F,dt).call(this),s=this,{graph:o}=this,{afterRerouteId:r}=i,a=i.nodeFrom&&i.slotFrom,l=!a&&i.nodeTo&&i.slotTo;if(!a&&!l){console.warn("No data passed to showConnectionMenu");return}const u=a?i.nodeFrom:i.nodeTo;if(!u)throw new TypeError("nodeX was null when creating default node for slot.");let c=a?i.slotFrom:i.slotTo,p;if(u instanceof SubgraphIONodeBase){if(typeof c!="object"||!c){console.warn("Cant get slot information",c);return}const{name:b}=c;if(p=u.slots.findIndex(k=>k.name===b),p!==-1&&(c=u.slots[p]),!c){console.warn("Cant get slot information",c);return}}else switch(typeof c){case"string":p=a?u.findOutputSlot(c,!1):u.findInputSlot(c,!1),c=a?u.outputs[c]:u.inputs[c];break;case"object":if(c===null){console.warn("Cant get slot information",c);return}p=a?u.findOutputSlot(c.name):u.findInputSlot(c.name);break;case"number":p=c,c=a?u.outputs[c]:u.inputs[c];break;default:console.warn("Cant get slot information",c);return}const f=["Add Node","Add Reroute",null];i.allow_searchbox&&f.push("Search",null);const g=c.type==LiteGraph.EVENT?"_event_":c.type,m=a?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(m!=null&&m[g])if(typeof m[g]=="object")for(const b in m[g])f.push(m[g][b]);else f.push(m[g]);const _=new LiteGraph.ContextMenu(f,{event:i.e,extra:c,title:(c&&c.name!=""?c.name+(g?" | ":""):"")+(c&&g?g:""),callback:y});return _;function y(b,k,w){var T,I;switch(b){case"Add Node":O.onMenuAdd(null,null,w,_,function(E){if(E)if(a){if(!i.nodeFrom)throw new TypeError("Cannot add node to SubgraphInputNode: nodeFrom was null");i.nodeFrom.connectByType(p,E,g,{afterRerouteId:r})||console.warn("Failed to make new connection.")}else{if(!i.nodeTo)throw new TypeError("Cannot add node to SubgraphInputNode: nodeTo was null");i.nodeTo.connectByTypeOutput(p,E,g,{afterRerouteId:r})}});break;case"Add Reroute":{const E=a?i.nodeFrom:i.nodeTo,G=k.extra;if(!o)throw new NullGraphError;if(!E)throw new TypeError("Cannot add reroute: node was null");if(!G)throw new TypeError("Cannot add reroute: slot was null");if(!i.e)throw new TypeError("Cannot add reroute: CanvasPointerEvent was null");if(E instanceof SubgraphIONodeBase)throw new TypeError("Cannot add floating reroute to Subgraph IO Nodes");if(!E.connectFloatingReroute([i.e.canvasX,i.e.canvasY],G,r))throw new Error("Failed to create reroute");n();break}case"Search":a?i.showSearchBox(w,{node_from:i.nodeFrom,slot_from:c,type_filter_in:g}):i.showSearchBox(w,{node_to:i.nodeTo,slot_from:c,type_filter_out:g});break;default:{const E={position:[((T=i.e)==null?void 0:T.canvasX)??0,((I=i.e)==null?void 0:I.canvasY)??0],nodeType:b,afterRerouteId:r},G=Object.assign(i,E);if(!s.createDefaultNodeForSlot(G))break}}}}prompt(t,i,n,s,o){var E;const r=this;t=t||"";const a={is_modified:!1,className:"graphdialog rounded",innerHTML:o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",close(){r.prompt_box=null,u.parentNode&&u.remove()}},l=document.createElement("div"),u=Object.assign(l,a),c=O.active_canvas,{canvas:p}=c;if(!p.parentNode)throw new TypeError("canvas element parentNode was null when opening a prompt.");p.parentNode.append(u),this.ds.scale>1&&(u.style.transform=`scale(${this.ds.scale})`);let f,g=0;LiteGraph.pointerListenerAdd(u,"leave",function(){g||LiteGraph.dialog_close_on_mouse_leave&&!u.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(u.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(u,"enter",function(){LiteGraph.dialog_close_on_mouse_leave&&f&&clearTimeout(f)});const m=u.querySelectorAll("select");if(m)for(const G of m)G.addEventListener("click",function(){g++}),G.addEventListener("blur",function(){g=0}),G.addEventListener("change",function(){g=-1});(E=this.prompt_box)==null||E.close(),this.prompt_box=u;const _=u.querySelector(".name");if(!_)throw new TypeError("name_element was null");_.textContent=t;const y=u.querySelector(".value");if(!y)throw new TypeError("value_element was null");y.value=i,y.select();const b=y;b.addEventListener("keydown",function(G){if(u.is_modified=!0,G.key=="Escape")u.close();else if(G.key=="Enter"&&G.target.localName!="textarea")n&&n(this.value),u.close();else return;G.preventDefault(),G.stopPropagation()});const k=u.querySelector("button");if(!k)throw new TypeError("button was null when opening prompt");k.addEventListener("click",function(){n==null||n(b.value),r.setDirty(!0),u.close()});const w=p.getBoundingClientRect();let T=-20,I=-20;return w&&(T-=w.left,I-=w.top),s?(u.style.left=`${s.clientX+T}px`,u.style.top=`${s.clientY+I}px`):(u.style.left=`${p.width*.5+T}px`,u.style.top=`${p.height*.5+I}px`),setTimeout(function(){var N,D;b.focus();const G=Date.now();function R(P){var B,X;P.target===p&&Date.now()-G>256&&(u.close(),(B=p.parentElement)==null||B.removeEventListener("click",R),(X=p.parentElement)==null||X.removeEventListener("touchend",R))}(N=p.parentElement)==null||N.addEventListener("click",R),(D=p.parentElement)==null||D.addEventListener("touchend",R)},10),u}showSearchBox(t,i){var R;const n={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};Object.assign(n,i);const s=this,o=O.active_canvas,{canvas:r}=o,a=r.ownerDocument||document,l=document.createElement("div"),u=Object.assign(l,{close(){s.search_box=void 0,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(()=>r.focus(),20),u.remove()}});u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",n.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>");const c=document.createElement("div");c.className="helper",u.append(c),a.fullscreenElement?a.fullscreenElement.append(u):(a.body.append(u),a.body.style.overflow="hidden");let p,f;if(n.do_type_filter&&(p=u.querySelector(".slot_in_type_filter"),f=u.querySelector(".slot_out_type_filter")),this.ds.scale>1&&(u.style.transform=`scale(${this.ds.scale})`),n.hide_on_mouse_leave){let N=!1,D=null;if(LiteGraph.pointerListenerAdd(u,"enter",function(){D&&(clearTimeout(D),D=null)}),u.addEventListener("pointerleave",function(){if(N)return;const P=n.hide_on_mouse_leave,B=typeof P=="number"?P:500;D=setTimeout(u.close,B)}),n.do_type_filter){if(!p)throw new TypeError("selIn was null when showing search box");if(!f)throw new TypeError("selOut was null when showing search box");p.addEventListener("click",function(){N++}),p.addEventListener("blur",function(){N=0}),p.addEventListener("change",function(){N=-1}),f.addEventListener("click",function(){N++}),f.addEventListener("blur",function(){N=0}),f.addEventListener("change",function(){N=-1})}}(R=s.search_box)==null||R.close(),s.search_box=u;let g=null,m=null,_=null;const y=u.querySelector("input");if(!y)throw new TypeError("Could not create search input box.");const b=y;if(b&&(b.addEventListener("blur",function(){this.focus()}),b.addEventListener("keydown",function(N){if(N.key=="ArrowUp")E(!1);else if(N.key=="ArrowDown")E(!0);else if(N.key=="Escape")u.close();else if(N.key=="Enter")_ instanceof HTMLElement?I(unescape(String(_.dataset.type))):g?I(g):u.close();else{m&&clearInterval(m),m=setTimeout(G,10);return}return N.preventDefault(),N.stopPropagation(),N.stopImmediatePropagation(),!0})),n.do_type_filter){if(p){const N=LiteGraph.slot_types_in,D=N.length;(n.type_filter_in==LiteGraph.EVENT||n.type_filter_in==LiteGraph.ACTION)&&(n.type_filter_in="_event_");for(let P=0;P<D;P++){const B=document.createElement("option");B.value=N[P],B.innerHTML=N[P],p.append(B),n.type_filter_in!==!1&&String(n.type_filter_in).toLowerCase()==String(N[P]).toLowerCase()&&(B.selected=!0)}p.addEventListener("change",function(){G()})}if(f){const N=LiteGraph.slot_types_out;(n.type_filter_out==LiteGraph.EVENT||n.type_filter_out==LiteGraph.ACTION)&&(n.type_filter_out="_event_");for(const D of N){const P=document.createElement("option");P.value=D,P.innerHTML=D,f.append(P),n.type_filter_out!==!1&&String(n.type_filter_out).toLowerCase()==String(D).toLowerCase()&&(P.selected=!0)}f.addEventListener("change",function(){G()})}}const k=r.getBoundingClientRect(),w=(t?t.clientX:k.left+k.width*.5)-80,T=(t?t.clientY:k.top+k.height*.5)-20;u.style.left=`${w}px`,u.style.top=`${T}px`,t.layerY>k.height-200&&(c.style.maxHeight=`${k.height-t.layerY-20}px`),requestAnimationFrame(function(){b.focus()}),n.show_all_on_open&&G();function I(N){if(N)if(s.onSearchBoxSelection)s.onSearchBoxSelection(N,t,o);else{if(!o.graph)throw new NullGraphError;o.graph.beforeChange();const D=LiteGraph.createNode(N);if(D&&(D.pos=o.convertEventToCanvasOffset(t),o.graph.add(D,!1)),n.node_from){let P=!1;switch(typeof n.slot_from){case"string":P=n.node_from.findOutputSlot(n.slot_from);break;case"object":if(n.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");P=n.slot_from.name?n.node_from.findOutputSlot(n.slot_from.name):-1,P==-1&&n.slot_from.slot_index!==void 0&&(P=n.slot_from.slot_index);break;case"number":P=n.slot_from;break;default:P=0}if(n.node_from.outputs[P]!==void 0&&P!==!1&&P>-1){if(D==null)throw new TypeError("options.slot_from was null when showing search box");n.node_from.connectByType(P,D,n.node_from.outputs[P].type)}}if(n.node_to){let P=!1;switch(typeof n.slot_from){case"string":P=n.node_to.findInputSlot(n.slot_from);break;case"object":if(n.slot_from==null)throw new TypeError("options.slot_from was null when showing search box");P=n.slot_from.name?n.node_to.findInputSlot(n.slot_from.name):-1,P==-1&&n.slot_from.slot_index!==void 0&&(P=n.slot_from.slot_index);break;case"number":P=n.slot_from;break;default:P=0}if(n.node_to.inputs[P]!==void 0&&P!==!1&&P>-1){if(D==null)throw new TypeError("options.slot_from was null when showing search box");n.node_to.connectByTypeOutput(P,D,n.node_to.inputs[P].type)}}o.graph.afterChange()}u.close()}function E(N){const D=_;_?_ instanceof Element&&(_.classList.remove("selected"),_=N?_.nextSibling:_.previousSibling,_||(_=D)):_=N?c.childNodes[0]:c.childNodes[c.childNodes.length],_ instanceof Element&&(_.classList.add("selected"),_.scrollIntoView({block:"end",behavior:"smooth"}))}function G(){m=null;let N=b.value;if(g=null,c.innerHTML="",!N&&!n.show_all_if_empty)return;if(s.onSearchBox){const P=s.onSearchBox(c,N,o);if(P)for(const B of P)D(B)}else{let P=function(M,z){var Qe,ti;z=z||{};const q=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},z),_e=LiteGraph.registered_node_types[M];if(X&&_e.filter!=X||(!n.show_all_if_empty||N)&&!M.toLowerCase().includes(N)&&(!_e.title||!_e.title.toLowerCase().includes(N)))return!1;if(n.do_type_filter&&!q.skipFilter){const ei=M;let kt=q.inTypeOverride!==!1?q.inTypeOverride:A.value;if(A&&kt&&((Qe=LiteGraph.registered_slot_in_types[kt])!=null&&Qe.nodes)&&LiteGraph.registered_slot_in_types[kt].nodes.includes(ei)===!1||(kt=L.value,q.outTypeOverride!==!1&&(kt=q.outTypeOverride),L&&kt&&((ti=LiteGraph.registered_slot_out_types[kt])!=null&&ti.nodes)&&LiteGraph.registered_slot_out_types[kt].nodes.includes(ei)===!1))return!1}return!0},B=0;if(N=N.toLowerCase(),!o.graph)throw new NullGraphError;const X=o.filter||o.graph.filter;let A=!1,L=!1;n.do_type_filter&&s.search_box&&(A=s.search_box.querySelector(".slot_in_type_filter"),L=s.search_box.querySelector(".slot_out_type_filter"));const Y=Object.keys(LiteGraph.registered_node_types).filter(M=>P(M));for(const M of Y)if(D(M),O.search_limit!==-1&&B++>O.search_limit)break;if(n.show_general_after_typefiltered&&(A.value||L.value)){filtered_extra=[];for(const M in LiteGraph.registered_node_types)P(M,{inTypeOverride:A&&A.value?"*":!1,outTypeOverride:L&&L.value?"*":!1})&&filtered_extra.push(M);for(const M of filtered_extra)if(D(M,"generic_type"),O.search_limit!==-1&&B++>O.search_limit)break}if((A.value||L.value)&&c.childNodes.length==0&&n.show_general_if_none_on_typefilter){filtered_extra=[];for(const M in LiteGraph.registered_node_types)P(M,{skipFilter:!0})&&filtered_extra.push(M);for(const M of filtered_extra)if(D(M,"not_in_filter"),O.search_limit!==-1&&B++>O.search_limit)break}}function D(P,B){const X=document.createElement("div");g||(g=P);const A=LiteGraph.registered_node_types[P];if(A!=null&&A.title){X.textContent=A==null?void 0:A.title;const L=document.createElement("span");L.className="litegraph lite-search-item-type",L.textContent=P,X.append(L)}else X.textContent=P;X.dataset.type=escape(P),X.className="litegraph lite-search-item",B&&(X.className+=` ${B}`),X.addEventListener("click",function(){I(unescape(String(this.dataset.type)))}),c.append(X)}}return u}showEditPropertyValue(t,i,n){if(!t||t.properties[i]===void 0)return;n=n||{};const s=t.getPropertyInfo(i),{type:o}=s;let r="";if(o=="string"||o=="number"||o=="array"||o=="object")r="<input autofocus type='text' class='value'/>";else if((o=="enum"||o=="combo")&&s.values){r="<select autofocus type='text' class='value'>";for(const g in s.values){const m=Array.isArray(s.values)?s.values[g]:g,_=m==t.properties[i]?"selected":"";r+=`<option value='${m}' ${_}>${s.values[g]}</option>`}r+="</select>"}else if(o=="boolean"||o=="toggle")r=`<input autofocus type='checkbox' class='value' ${t.properties[i]?"checked":""}/>`;else{console.warn(`unknown type: ${o}`);return}const a=this.createDialog(`<span class='name'>${s.label||i}</span>${r}<button>OK</button>`,n);let l;if((o=="enum"||o=="combo")&&s.values)l=a.querySelector("select"),l==null||l.addEventListener("change",function(g){var m;a.modified(),f((m=g.target)==null?void 0:m.value)});else if(o=="boolean"||o=="toggle")l=a.querySelector("input"),l==null||l.addEventListener("click",function(){a.modified(),f(!!l.checked)});else if(l=a.querySelector("input"),l){l.addEventListener("blur",function(){this.focus()});let g=t.properties[i]!==void 0?t.properties[i]:"";o!=="string"&&(g=JSON.stringify(g)),l.value=g,l.addEventListener("keydown",function(m){if(m.key=="Escape")a.close();else if(m.key=="Enter")c();else{a.modified();return}m.preventDefault(),m.stopPropagation()})}l==null||l.focus();const u=a.querySelector("button");if(!u)throw new TypeError("Show edit property value button was null.");u.addEventListener("click",c);function c(){f(l==null?void 0:l.value)}const p=()=>C(this,F,dt).call(this);function f(g){var m,_;s!=null&&s.values&&typeof s.values=="object"&&s.values[g]!=null&&(g=s.values[g]),typeof t.properties[i]=="number"&&(g=Number(g)),(o=="array"||o=="object")&&(g=JSON.parse(g)),t.properties[i]=g,t.graph&&t.graph._version++,(m=t.onPropertyChanged)==null||m.call(t,i,g),(_=n.onclose)==null||_.call(n),a.close(),p()}return a}createDialog(t,i){i=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},i||{});const s={className:"graphdialog",innerHTML:t,is_modified:!1,modified(){this.is_modified=!0},close(){this.remove()}},o=document.createElement("div"),r=Object.assign(o,s),a=this.canvas.getBoundingClientRect();let l=-20,u=-20;if(a&&(l-=a.left,u-=a.top),i.position?(l+=i.position[0],u+=i.position[1]):i.event?(l+=i.event.clientX,u+=i.event.clientY):(l+=this.canvas.width*.5,u+=this.canvas.height*.5),r.style.left=`${l}px`,r.style.top=`${u}px`,!this.canvas.parentNode)throw new TypeError("Canvas parent element was null.");if(this.canvas.parentNode.append(r),i.checkForInput){const g=r.querySelectorAll("input");if(g)for(const m of g)m.addEventListener("keydown",function(_){if(r.modified(),_.key=="Escape")r.close();else if(_.key!="Enter")return;_.preventDefault(),_.stopPropagation()}),m.focus()}let c,p=0;r.addEventListener("mouseleave",function(){p||!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(){(i.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&c&&clearTimeout(c)});const f=r.querySelectorAll("select");if(f)for(const g of f)g.addEventListener("click",function(){p++}),g.addEventListener("blur",function(){p=0}),g.addEventListener("change",function(){p=-1});return r}createPanel(t,i){i=i||{};const n=i.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),i.width&&(s.style.width=i.width+(typeof i.width=="number"?"px":"")),i.height&&(s.style.height=i.height+(typeof i.height=="number"?"px":"")),i.closable){const o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",function(){s.close()}),s.header.append(o)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.textContent=t,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){typeof s.onClose=="function"&&s.onClose(),s.remove(),this.remove()},s.toggleAltContent=function(o){let r,a;o!==void 0?(r=o?"block":"none",a=o?"none":"block"):(r=s.alt_content.style.display!="block"?"block":"none",a=s.alt_content.style.display!="block"?"none":"block"),s.alt_content.style.display=r,s.content.style.display=a},s.toggleFooterVisibility=function(o){let r;o!==void 0?r=o?"block":"none":r=s.footer.style.display!="block"?"block":"none",s.footer.style.display=r},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(o,r,a){const l=document.createElement("div");return r&&(l.className=r),l.innerHTML=o,a?s.footer.append(l):s.content.append(l),l},s.addButton=function(o,r,a){const l=document.createElement("button");return l.textContent=o,l.options=a,l.classList.add("btn"),l.addEventListener("click",r),s.footer.append(l),l},s.addSeparator=function(){const o=document.createElement("div");o.className="separator",s.content.append(o)},s.addWidget=function(o,r,a,l,u){l=l||{};let c=String(a);o=o.toLowerCase(),o=="number"&&typeof a=="number"&&(c=a.toFixed(3));const p=document.createElement("div");p.className="property",p.innerHTML="<span class='property_name'></span><span class='property_value'></span>";const f=p.querySelector(".property_name");if(!f)throw new TypeError("Property name element was null.");f.textContent=l.label||r;const g=p.querySelector(".property_value");if(!g)throw new TypeError("Property name element was null.");if(g.textContent=c,p.dataset.property=r,p.dataset.type=l.type||o,p.options=l,p.value=a,o=="code")p.addEventListener("click",function(){s.inner_showCodePad(this.dataset.property)});else if(o=="boolean")p.classList.add("boolean"),a&&p.classList.add("bool-on"),p.addEventListener("click",()=>{const _=p.dataset.property;if(p.value=!p.value,p.classList.toggle("bool-on"),!g)throw new TypeError("Property name element was null.");g.textContent=p.value?"true":"false",m(_,p.value)});else if(o=="string"||o=="number"){if(!g)throw new TypeError("Property name element was null.");g.setAttribute("contenteditable","true"),g.addEventListener("keydown",function(_){_.code=="Enter"&&(o!="string"||!_.shiftKey)&&(_.preventDefault(),this.blur())}),g.addEventListener("blur",function(){var k,w;let _=this.textContent;const y=(k=this.parentElement)==null?void 0:k.dataset.property;((w=this.parentElement)==null?void 0:w.dataset.type)=="number"&&(_=Number(_)),m(y,_)})}else if(o=="enum"||o=="combo"){const _=O.getPropertyPrintableValue(a,l.values);if(!g)throw new TypeError("Property name element was null.");g.textContent=_??"",g.addEventListener("click",function(y){var T;const b=l.values||[],k=(T=this.parentElement)==null?void 0:T.dataset.property,w=I=>(this.textContent=I,m(k,I),!1);new LiteGraph.ContextMenu(b,{event:y,className:"dark",callback:w},n)})}s.content.append(p);function m(_,y){var b;(b=l.callback)==null||b.call(l,_,y,l),u==null||u(_,y,l)}return p},typeof s.onOpen=="function"&&s.onOpen(),s}closePanels(){var t,i,n,s;(i=(t=document.querySelector("#node-panel"))==null?void 0:t.close)==null||i.call(t),(s=(n=document.querySelector("#option-panel"))==null?void 0:n.close)==null||s.call(n)}showShowNodePanel(t){this.SELECTED_NODE=t,this.closePanels();const i=this.getCanvasWindow(),n=this.createPanel(t.title||"",{closable:!0,window:i,onOpen:()=>{this.NODEPANEL_IS_OPEN=!0},onClose:()=>{this.NODEPANEL_IS_OPEN=!1,this.node_panel=null}});this.node_panel=n,n.id="node-panel",n.node=t,n.classList.add("settings");const s=()=>{var l,u;n.content.innerHTML="",n.addHTML(`<span class='node_type'>${t.type}</span><span class='node_desc'>${t.constructor.desc||""}</span><span class='separator'></span>`),n.addHTML("<h3>Properties</h3>");const o=(c,p)=>{if(!this.graph)throw new NullGraphError;switch(this.graph.beforeChange(t),c){case"Title":if(typeof p!="string")throw new TypeError("Attempting to set title to non-string value.");t.title=p;break;case"Mode":{if(typeof p!="string")throw new TypeError("Attempting to set mode to non-string value.");const f=Object.values(LiteGraph.NODE_MODES).indexOf(p);f!==-1&&LiteGraph.NODE_MODES[f]?t.changeMode(f):console.warn(`unexpected mode: ${p}`);break}case"Color":if(typeof p!="string")throw new TypeError("Attempting to set colour to non-string value.");O.node_colors[p]?(t.color=O.node_colors[p].color,t.bgcolor=O.node_colors[p].bgcolor):console.warn(`unexpected color: ${p}`);break;default:t.setProperty(c,p);break}this.graph.afterChange(),this.dirty_canvas=!0};n.addWidget("string","Title",t.title,{},o);const r=t.mode==null?void 0:LiteGraph.NODE_MODES[t.mode];n.addWidget("combo","Mode",r,{values:LiteGraph.NODE_MODES},o);const a=t.color!==void 0?Object.keys(O.node_colors).filter(function(c){return O.node_colors[c].color==t.color}):"";n.addWidget("combo","Color",a,{values:Object.keys(O.node_colors)},o);for(const c in t.properties){const p=t.properties[c],f=t.getPropertyInfo(c);(l=t.onAddPropertyToPanel)!=null&&l.call(t,c,n)||n.addWidget(f.widget||f.type,c,p,f,o)}n.addSeparator(),(u=t.onShowCustomPanelInfo)==null||u.call(t,n),n.footer.innerHTML="",n.addButton("Delete",function(){if(!t.block_delete){if(!t.graph)throw new NullGraphError;t.graph.remove(t),n.close()}}).classList.add("delete")};if(n.inner_showCodePad=function(o){n.classList.remove("settings"),n.classList.add("centered"),n.alt_content.innerHTML="<textarea class='code'></textarea>";const r=n.alt_content.querySelector("textarea"),a=function(){n.toggleAltContent(!1),n.toggleFooterVisibility(!0),r.remove(),n.classList.add("settings"),n.classList.remove("centered"),s()};r.value=String(t.properties[o]),r.addEventListener("keydown",function(c){c.code=="Enter"&&c.ctrlKey&&(t.setProperty(o,r.value),a())}),n.toggleAltContent(!0),n.toggleFooterVisibility(!1),r.style.height="calc(100% - 40px)";const l=n.addButton("Assign",function(){t.setProperty(o,r.value),a()});n.alt_content.append(l);const u=n.addButton("Close",a);u.style.float="right",n.alt_content.append(u)},s(),!this.canvas.parentNode)throw new TypeError("showNodePanel - this.canvas.parentNode was null");this.canvas.parentNode.append(n)}checkPanels(){if(!this.canvas)return;if(!this.canvas.parentNode)throw new TypeError("checkPanels - this.canvas.parentNode was null");const t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(const i of t)i.node&&(!i.node.graph||i.graph!=this.graph)&&i.close()}getCanvasMenuOptions(){var n;let t;this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:O.onMenuAdd},{content:"Add Group",callback:O.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&t.push({content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Align",has_submenu:!0,callback:O.onGroupAlign}));const i=(n=this.getExtraMenuOptions)==null?void 0:n.call(this,this,t);return Array.isArray(i)?t.concat(i):t}getNodeMenuOptions(t){var s,o,r,a;let i;t.getMenuOptions?i=t.getMenuOptions(this):(i=[{content:"Inputs",has_submenu:!0,disabled:!0},{content:"Outputs",has_submenu:!0,disabled:!0,callback:O.showMenuNodeOptionalOutputs},null,{content:"Convert to Subgraph ðŸ†•",callback:()=>{if(!this.selectedItems.size)throw new Error("Convert to Subgraph: Nothing selected.");this._graph.convertToSubgraph(this.selectedItems)}},{content:"Properties",has_submenu:!0,callback:O.onShowMenuNodeProperties},{content:"Properties Panel",callback:function(l,u,c,p,f){O.active_canvas.showShowNodePanel(f)}},null,{content:"Title",callback:O.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:O.onMenuNodeMode}],t.resizable!==!1&&i.push({content:"Resize",callback:O.onMenuResizeNode}),t.collapsible&&i.push({content:t.collapsed?"Expand":"Collapse",callback:O.onMenuNodeCollapse}),(s=t.widgets)!=null&&s.some(l=>l.advanced)&&i.push({content:t.showAdvanced?"Hide Advanced":"Show Advanced",callback:O.onMenuToggleAdvanced}),i.push({content:t.pinned?"Unpin":"Pin",callback:()=>{for(const l in this.selected_nodes)this.selected_nodes[l].pin();this.setDirty(!0,!0)}},{content:"Colors",has_submenu:!0,callback:O.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:O.onMenuNodeShapes},null));const n=(o=t.getExtraMenuOptions)==null?void 0:o.call(t,this,i);return Array.isArray(n)&&n.length>0&&(n.push(null),i=n.concat(i)),t.clonable!==!1&&i.push({content:"Clone",callback:O.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&i.push({content:"Align Selected To",has_submenu:!0,callback:O.onNodeAlign},{content:"Distribute Nodes",has_submenu:!0,callback:O.createDistributeMenu}),i.push(null,{content:"Remove",disabled:!(t.removable!==!1&&!t.block_delete),callback:O.onMenuNodeRemove}),(a=(r=t.graph)==null?void 0:r.onGetNodeMenuOptions)==null||a.call(r,i,t),i}getGroupMenuOptions(t){return console.warn("LGraphCanvas.getGroupMenuOptions is deprecated, use LGraphGroup.getMenuOptions instead"),t.getMenuOptions()}processContextMenu(t,i){var c,p,f;const s=O.active_canvas.getCanvasWindow();let o;const r={event:i,callback:u,extra:t};if(t){r.title=t.displayType??t.type??void 0,O.active_node=t;const g=t.getSlotInPosition(i.canvasX,i.canvasY);if(g){if(o=[],t.getSlotMenuOptions)o=t.getSlotMenuOptions(g);else{((p=(c=g.output)==null?void 0:c.links)!=null&&p.length||((f=g.input)==null?void 0:f.link)!=null)&&o.push({content:"Disconnect Links",slot:g});const m=g.input||g.output;if(!m)throw new TypeError("Both in put and output slots were null when processing context menu.");m.removable&&o.push(m.locked?"Cannot remove":{content:"Remove Slot",slot:g}),!m.nameLocked&&!("link"in m&&m.widget)&&o.push({content:"Rename Slot",slot:g}),t.getExtraSlotMenuOptions&&o.push(...t.getExtraSlotMenuOptions(g))}r.title=(g.input?g.input.type:g.output.type)||"*",g.input&&g.input.type==LiteGraph.ACTION&&(r.title="Action"),g.output&&g.output.type==LiteGraph.EVENT&&(r.title="Event")}else o=this.getNodeMenuOptions(t)}else{if(o=this.getCanvasMenuOptions(),!this.graph)throw new NullGraphError;if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK){const m=this.graph.getRerouteOnPos(i.canvasX,i.canvasY,S(this,ct));m&&o.unshift({content:"Delete Reroute",callback:()=>{if(!this.graph)throw new NullGraphError;this.graph.removeReroute(m.id)}},null)}const g=this.graph.getGroupOnPos(i.canvasX,i.canvasY);g&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:g,options:g.getMenuOptions()}})}if(!o)return;new LiteGraph.ContextMenu(o,r,s);const a=g=>this.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",g),l=()=>this.setDirty(!0);function u(g,m){var _;if(g){if(g.content=="Remove Slot"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.input?t.removeInput(y.slot):y.output&&t.removeOutput(y.slot),t.graph.afterChange();return}else if(g.content=="Disconnect Links"){if(!(t!=null&&t.graph))throw new NullGraphError;const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");t.graph.beforeChange(),y.output?t.disconnectOutput(y.slot):y.input&&t.disconnectInput(y.slot,!0),t.graph.afterChange();return}else if(g.content=="Rename Slot"){if(!t)throw new TypeError("`node` was null when processing the context menu.");const y=g.slot;if(!y)throw new TypeError("Found-slot info was null when processing context menu.");const b=y.input?t.getInputInfo(y.slot):t.getOutputInfo(y.slot),k=a(m),w=k.querySelector("input");w&&b&&(w.value=b.label||"");const T=function(){if(!t.graph)throw new NullGraphError;t.graph.beforeChange(),w!=null&&w.value&&(b&&(b.label=w.value),l()),k.close(),t.graph.afterChange()};if((_=k.querySelector("button"))==null||_.addEventListener("click",T),!w)throw new TypeError("Input element was null when processing context menu.");w.addEventListener("keydown",function(I){if(k.is_modified=!0,I.key=="Escape")k.close();else if(I.key=="Enter")T();else if(I.target.localName!="textarea")return;I.preventDefault(),I.stopPropagation()}),w.focus()}}}}animateToBounds(t,i={}){const n=()=>this.setDirty(!0,!0);this.ds.animateToBounds(t,n,i)}fitViewToSelectionAnimated(t={}){const i=this.selectedItems.size?Array.from(this.selectedItems):this.positionableItems,n=createBounds(i);if(!n)throw new TypeError("Attempted to fit to view but could not calculate bounds.");const s=()=>this.setDirty(!0,!0);this.ds.animateToBounds(n,s,t)}};ke=new WeakMap,Le=new WeakMap,Ie=new WeakMap,bt=new WeakMap,gt=new WeakMap,Se=new WeakMap,Te=new WeakMap,Ee=new WeakMap,Et=new WeakMap,F=new WeakSet,Pe=function(){if(!this.state.shouldSetCursor)return;const t=CanvasItem.Node|CanvasItem.RerouteSlot|CanvasItem.SubgraphIoNode|CanvasItem.SubgraphIoSlot;let i="default";this.state.draggingCanvas?i="grabbing":this.state.readOnly?i="grab":this.pointer.resizeDirection?i=cursors[this.pointer.resizeDirection]??cursors.SE:this.state.hoveringOver&t?i="crosshair":this.state.hoveringOver&CanvasItem.Reroute&&(i="grab"),this.canvas.style.cursor=i},vt=new WeakMap,ae=new WeakMap,ct=new WeakMap,ot=new WeakMap,le=new WeakMap,Nt=new WeakMap,mi=function(t){if(typeof t=="string"){const i=document.getElementById(t);if(!(i instanceof HTMLCanvasElement))throw"Error validating LiteGraph canvas: Canvas element not found";return i}return t},dt=function(){this.dirty_canvas=!0,this.dirty_bgcanvas=!0},Dt=function(){const{graph:t,linkConnector:i,pointer:n}=this;if(!t)throw new NullGraphError;n.onDragEnd=s=>i.dropLinks(t,s),n.finally=()=>this.linkConnector.reset(!0)},yi=function(t,i){var s,o;const n=(s=this.subgraph)==null?void 0:s.getIoNodeOnPos(t,i);if(n)return n;for(const r of S(this,ct))if(r.containsPoint([t,i]))return r;return(o=this.graph)==null?void 0:o.getGroupTitlebarOnPos(t,i)},bi=function(t,i){var c;const{pointer:n,graph:s,linkConnector:o,subgraph:r}=this;if(!s)throw new NullGraphError;const a=t.canvasX,l=t.canvasY,u=t.ctrlKey||t.metaKey;if(u&&!t.altKey&&LiteGraph.canvasNavigationMode==="legacy"){C(this,F,Ke).call(this,t,n,i);return}if(this.read_only){n.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0;return}if(LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&!t.ctrlKey&&i&&this.allow_interaction){let p=i.type;if(i instanceof SubgraphNode){const g=i.subgraph.clone().asSerialisable(),m=s.createSubgraph(g);m.configure(g),p=m.id}const f=(c=i.clone())==null?void 0:c.serialize();if((f==null?void 0:f.type)!=null){const g=LiteGraph.createNode(p);if(g){g.configure(f),g.pos[0]+=5,g.pos[1]+=5,this.allow_dragnodes?(n.onDragStart=m=>{s.add(g,!1),C(this,F,Rt).call(this,g,m)},n.onDragEnd=m=>C(this,F,Gt).call(this,m)):(s.beforeChange(),s.add(g,!1),s.afterChange());return}}}if(i&&(this.allow_interaction||i.flags.allow_interaction))C(this,F,vi).call(this,t,u,i);else{if(r){let m=function(b,k){return k.containsPoint([a,l])?(k.onPointerDown(t,n,o),n.onClick??(n.onClick=()=>b.processSelect(k,t)),n.onDragStart??(n.onDragStart=()=>{var w;return C(w=b,F,Rt).call(w,k,n,!0)}),n.onDragEnd??(n.onDragEnd=w=>{var T;return C(T=b,F,Gt).call(T,w)}),!0):!1};const{inputNode:_,outputNode:y}=r;if(m(this,_)||m(this,y))return}if(this.links_render_mode!==LinkRenderType.HIDDEN_LINK)for(const m of S(this,ct)){const _=m.containsPoint([a,l]);if(!(!m.isSlotHovered&&!_)){_&&(n.onClick=()=>this.processSelect(m,t),t.shiftKey||(n.onDragStart=y=>C(this,F,Rt).call(this,m,y,!0),n.onDragEnd=y=>C(this,F,Gt).call(this,y))),(m.isOutputHovered||_&&t.shiftKey)&&(o.dragFromReroute(s,m),C(this,F,Dt).call(this)),m.isInputHovered&&(o.dragFromRerouteToOutput(s,m),C(this,F,Dt).call(this)),m.hideSlots(),this.dirty_bgcanvas=!0;return}}const{lineWidth:p}=this.ctx;this.ctx.lineWidth=this.connections_width+7;const f=(window==null?void 0:window.devicePixelRatio)||1;for(const m of this.renderedPaths){const _=m._pos;if(_){if((t.shiftKey||t.altKey)&&m.path&&this.ctx.isPointInStroke(m.path,a*f,l*f)){if(this.ctx.lineWidth=p,t.shiftKey&&!t.altKey){o.dragFromLinkSegment(s,m),C(this,F,Dt).call(this);return}else if(t.altKey&&!t.shiftKey){const y=s.createReroute([a,l],m);n.onDragStart=b=>C(this,F,Rt).call(this,y,b),n.onDragEnd=b=>C(this,F,Gt).call(this,b);return}}else if(isInRectangle(a,l,_[0]-4,_[1]-4,8,8)){this.ctx.lineWidth=p,n.onClick=()=>this.showLinkMenu(m,t),n.onDragStart=()=>this.dragging_canvas=!0,n.finally=()=>this.dragging_canvas=!1,this.over_link_center=void 0;return}}}this.ctx.lineWidth=p;const g=s.getGroupOnPos(a,l);if(this.selected_group=g??null,g){if(g.isInResize(a,l)){const m=g.boundingRect,_=a-(m[0]+m[2]),y=l-(m[1]+m[3]);n.onDragStart=()=>this.resizingGroup=g,n.onDrag=b=>{if(this.read_only)return;const k=[b.canvasX-g.pos[0]-_,b.canvasY-g.pos[1]-y];S(this,ot)&&snapPoint(k,S(this,ot)),g.resize(k[0],k[1])&&(this.dirty_bgcanvas=!0)},n.finally=()=>this.resizingGroup=null}else{const _=(g.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE)*1.4;isInRectangle(a,l,g.pos[0],g.pos[1],g.size[0],_)&&(n.onClick=()=>this.processSelect(g,t),n.onDragStart=y=>{g.recomputeInsideNodes(),C(this,F,Rt).call(this,g,y,!0)},n.onDragEnd=y=>C(this,F,Gt).call(this,y))}n.onDoubleClick=()=>{this.emitEvent({subType:"group-double-click",originalEvent:t,group:g})}}else n.onDoubleClick=()=>{this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault()),this.emitEvent({subType:"empty-double-click",originalEvent:t})}}!n.onDragStart&&!n.onClick&&!n.onDrag&&this.allow_dragcanvas&&(LiteGraph.canvasNavigationMode!=="standard"||this.read_only?(n.onClick=()=>this.processSelect(null,t),n.finally=()=>this.dragging_canvas=!1,this.dragging_canvas=!0):C(this,F,Ke).call(this,t,n))},Ke=function(t,i,n){const s=new Float32Array(4);s[0]=t.canvasX,s[1]=t.canvasY,s[2]=1,s[3]=1,i.onClick=o=>{const r=n??C(this,F,yi).call(this,o.canvasX,o.canvasY);this.processSelect(r,o)},i.onDragStart=()=>this.dragging_rectangle=s,i.onDragEnd=o=>C(this,F,Ti).call(this,o,s),i.finally=()=>this.dragging_rectangle=null},vi=function(t,i,n){var f,g,m,_;const{pointer:s,graph:o,linkConnector:r}=this;if(!o)throw new NullGraphError;const a=t.canvasX,l=t.canvasY;s.onClick=()=>this.processSelect(n,t),n.flags.pinned||this.bringToFront(n);const u=n.isPointInCollapse(a,l);if(u)s.onClick=()=>{n.collapse(),this.setDirty(!0,!0)};else if(!n.flags.collapsed){const{inputs:y,outputs:b}=n;if(b)for(const[k,w]of b.entries()){const T=n.getOutputPos(k);if(isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){if(t.shiftKey&&((f=w.links)!=null&&f.length||(g=w._floatingLinks)!=null&&g.size)){r.moveOutputLink(o,w),C(this,F,Dt).call(this);return}r.dragNewFromOutput(o,n,w),C(this,F,Dt).call(this),LiteGraph.shift_click_do_break_link_from?t.shiftKey&&n.disconnectOutput(k):LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey&&n.disconnectOutput(k),s.onDoubleClick=()=>{var I;return(I=n.onOutputDblClick)==null?void 0:I.call(n,k,t)},s.onClick=()=>{var I;return(I=n.onOutputClick)==null?void 0:I.call(n,k,t)};return}}if(y)for(const[k,w]of y.entries()){const T=n.getInputPos(k);if(w instanceof NodeInputSlot?isInRect(a,l,w.boundingRect):isInRectangle(a,l,T[0]-15,T[1]-10,30,20)){s.onDoubleClick=()=>{var G;return(G=n.onInputDblClick)==null?void 0:G.call(n,k,t)},s.onClick=()=>{var G;return(G=n.onInputClick)==null?void 0:G.call(n,k,t)};const E=LiteGraph.ctrl_alt_click_do_break_link&&i&&t.altKey&&!t.shiftKey;(w.link!==null||(m=w._floatingLinks)!=null&&m.size)&&(E||LiteGraph.click_do_break_link_to?n.disconnectInput(k,!0):(t.shiftKey||this.allow_reconnect_links)&&r.moveInputLink(o,w)),r.isConnecting||r.dragNewFromInput(o,n,w),C(this,F,Dt).call(this),this.dirty_bgcanvas=!0;return}}}const c=[a-n.pos[0],l-n.pos[1]],p=n.getWidgetOnPos(a,l);if(p)C(this,F,wi).call(this,t,n,p),this.node_widget=[n,p];else{if(s.onDoubleClick=()=>{var y,b;c[1]<0&&!u?(y=n.onNodeTitleDblClick)==null||y.call(n,t,c,this):n instanceof SubgraphNode&&this.openSubgraph(n.subgraph),(b=n.onDblClick)==null||b.call(n,t,c,this),this.emitEvent({subType:"node-double-click",originalEvent:t,node:n}),this.processNodeDblClicked(n)},(_=n.onMouseDown)!=null&&_.call(n,t,c,this)){s.onClick=()=>{};return}if(!this.allow_dragnodes)return;if(!n.flags.collapsed){const y=n.findResizeDirection(a,l);if(y){s.resizeDirection=y;const b=new Rectangle(n.pos[0],n.pos[1],n.size[0],n.size[1]);s.onDragStart=()=>{o.beforeChange(),this.resizing_node=n},s.onDrag=k=>{if(this.read_only)return;const w=k.canvasX-a,T=k.canvasY-l,I=new Rectangle(b.x,b.y,b.width,b.height);switch(y){case"NE":I.y=b.y+T,I.width=b.width+w,I.height=b.height-T;break;case"SE":I.width=b.width+w,I.height=b.height+T;break;case"SW":I.x=b.x+w,I.width=b.width-w,I.height=b.height+T;break;case"NW":I.x=b.x+w,I.y=b.y+T,I.width=b.width-w,I.height=b.height-T;break}if(S(this,ot)){if(y.includes("N")||y.includes("W")){const G=I.x,R=I.y;snapPoint(I.pos,S(this,ot)),y.includes("N")&&(I.height+=R-I.y),y.includes("W")&&(I.width+=G-I.x)}snapPoint(I.size,S(this,ot))}const E=n.computeSize();I.width<E[0]&&(y.includes("W")&&(I.x=b.x+b.width-E[0]),I.width=E[0]),I.height<E[1]&&(y.includes("N")&&(I.y=b.y+b.height-E[1]),I.height=E[1]),n.pos=I.pos,n.setSize(I.size),C(this,F,dt).call(this)},s.onDragEnd=()=>{C(this,F,dt).call(this),o.afterChange(n)},s.finally=()=>{this.resizing_node=null,s.resizeDirection=void 0},this.canvas.style.cursor=cursors[y];return}}s.onDragStart=y=>C(this,F,Rt).call(this,n,y,!0),s.onDragEnd=y=>C(this,F,Gt).call(this,y)}this.dirty_canvas=!0},wi=function(t,i,n){var c;const{pointer:s}=this;if(typeof n.onPointerDown=="function"&&n.onPointerDown(s,i,this))return;const o=n.value,r=this.graph_mouse,a=r[0]-i.pos[0],l=r[1]-i.pos[1],u=toConcreteWidget(n,i,!1);if(u)s.onClick=()=>u.onClick({e:t,node:i,canvas:this}),s.onDrag=p=>{var f;return(f=u.onDrag)==null?void 0:f.call(u,{e:p,node:i,canvas:this})};else if(n.mouse){const p=n.mouse(t,[a,l],i);p!=null&&(this.dirty_canvas=p)}if(o!=n.value){if((c=i.onWidgetChanged)==null||c.call(i,n.name,n.value,o,n),!i.graph)throw new NullGraphError;i.graph._version++}s.finally=()=>{if(n.mouse){const{eUp:p}=s;if(!p)return;const{canvasX:f,canvasY:g}=p;n.mouse(p,[f-i.pos[0],g-i.pos[1]],i)}this.node_widget=null}},ki=function(t,i){const{pointer:n}=this;if(LiteGraph.middle_click_slot_add_default_node&&i&&this.allow_interaction&&!this.read_only&&!this.connecting_links&&!i.flags.collapsed){let s=!1,o=!1,r=!1;const{inputs:a,outputs:l}=i;if(l)for(const[u,c]of l.entries()){const p=i.getOutputPos(u);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){s=c,o=u,r=!0;break}}if(a)for(const[u,c]of a.entries()){const p=i.getInputPos(u);if(isInRectangle(t.canvasX,t.canvasY,p[0]-15,p[1]-10,30,20)){s=c,o=u,r=!1;break}}if(s&&o!==!1){const u=.5-(o+1)/(r?l.length:a.length),c=i.getBounding(),p=[r?c[0]+c[2]:c[0],t.canvasY-80];n.onClick=()=>this.createDefaultNodeForSlot({nodeFrom:r?i:null,slotFrom:r?o:null,nodeTo:r?null:i,slotTo:r?null:o,position:p,nodeType:"AUTO",posAdd:[r?30:-30,-u*130],posSizeFix:[r?0:-1,0]})}}this.allow_dragcanvas&&(n.onDragStart=()=>this.dragging_canvas=!0,n.finally=()=>this.dragging_canvas=!1)},Li=function(t){if(!t.buttons){H(this,Nt,null);return}const i=S(this,Nt);if(!i)throw new TypeError("Drag-zoom state object was null");if(!this.graph)throw new NullGraphError;const n=t.y-i.pos[1],o=i.scale-n/100;this.ds.changeScale(o,i.pos),this.graph.change()},Ii=function(t){const{graph:i,pointer:n,linkConnector:s}=this;if(!i)throw new NullGraphError;if(n.isDown){if(s.isConnecting){for(const o of S(this,ct))if(o.containsPoint(this.graph_mouse))return s.isRerouteValidDrop(o)&&(s.overReroute=o,this._highlight_pos=o.pos),t|=CanvasItem.RerouteSlot}}else{let o=!1;for(const r of S(this,ct))o||(o=r.updateVisibility(this.graph_mouse)),r.isSlotHovered&&(t|=CanvasItem.RerouteSlot);o&&(this.dirty_bgcanvas=!0)}return this._highlight_pos&&(this._highlight_pos=void 0),s.overReroute&&(s.overReroute=void 0),t},Rt=function(t,i,n=!1){var s;this.emitBeforeChange(),(s=this.graph)==null||s.beforeChange(),i.finally=()=>{var o;this.isDragging=!1,(o=this.graph)==null||o.afterChange(),this.emitAfterChange()},this.processSelect(t,i.eDown,n),this.isDragging=!0},Gt=function(t){var n;const{graph:i}=this;(t.shiftKey||LiteGraph.alwaysSnapToGrid)&&(i==null||i.snapToGrid(this.selectedItems)),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,(n=this.onNodeMoved)==null||n.call(this,findFirstNode(this.selectedItems))},Si=function(){const t=new CustomEvent("litegraph:no-items-selected",{bubbles:!0});this.canvas.dispatchEvent(t)},Ti=function(t,i){var p;const{graph:n,selectedItems:s,subgraph:o}=this;if(!n)throw new NullGraphError;const r=Math.abs(i[2]),a=Math.abs(i[3]);i[2]<0&&(i[0]-=r),i[3]<0&&(i[1]-=a),i[2]=r,i[3]=a;const l=new Set,u=[];if(o){const{inputNode:f,outputNode:g}=o;overlapBounding(i,f.boundingRect)&&c(f),overlapBounding(i,g.boundingRect)&&c(g)}for(const f of n._nodes)overlapBounding(i,f.boundingRect)&&c(f);for(const f of n.groups)containsRect(i,f._bounding)&&(f.recomputeInsideNodes(),c(f));for(const f of n.reroutes.values())isPointInRect(f.pos,i)&&(s.add(f),f.selected=!0,c(f));if(t.shiftKey)for(const f of u)this.select(f);else if(t.altKey)for(const f of l)this.deselect(f);else{for(const f of s.values())l.has(f)||this.deselect(f);for(const f of u)this.select(f)}(p=this.onSelectionChange)==null||p.call(this,this.selected_nodes);function c(f){!f.selected||!s.has(f)?u.push(f):l.add(f)}},Ei=function(t){for(const i of this.renderedPaths){const n=i._pos;if(n&&isInRectangle(t.canvasX,t.canvasY,n[0]-4,n[1]-4,8,8))return i}},Ni=function(){return LiteGraph.snaps_for_comfy?this.linkConnector.state.snapLinksPos??this._highlight_pos??this.graph_mouse:this.graph_mouse},Ci=function(t,i){var N;const n=!!this.linkConnector.state.snapLinksPos;if(!this._highlight_pos&&!n)return;t.fillStyle="#ffcc00",t.beginPath(),((N=this._highlight_input)==null?void 0:N.shape)===RenderShape.ARROW?(t.moveTo(i[0]+8,i[1]+.5),t.lineTo(i[0]-4,i[1]+6+.5),t.lineTo(i[0]-4,i[1]-6+.5),t.closePath()):t.arc(i[0],i[1],6,0,Math.PI*2),t.fill();const{linkConnector:o}=this,{overReroute:r,overWidget:a}=o;if(!LiteGraph.snap_highlights_node||!o.isConnecting||n)return;r==null||r.drawHighlight(t,"#ffcc00aa");const l=this.node_over;if(!l)return;const{strokeStyle:u,lineWidth:c}=t,p=l.boundingRect,f=3,g=LiteGraph.ROUND_RADIUS+f,m=p[0]-f,_=p[1]-f,y=p[2]+f*2,b=p[3]+f*2;t.beginPath(),t.roundRect(m,_,y,b,g);const k=o.state.connectingTo==="output"?0:1,w=k?-1:1,T=i[0],I=i[1],E=y<b?y:y*Math.max(b/y,.5),G=t.createRadialGradient(T,I,0,T,I,E);G.addColorStop(1,"#00000000"),G.addColorStop(0,"#ffcc00aa");const R=t.createLinearGradient(m,_,m+y,_);if(R.addColorStop(.5,"#00000000"),R.addColorStop(k+.67*w,"#ddeeff33"),R.addColorStop(k+w,"#ffcc0055"),t.setLineDash([g,g*.001]),t.lineWidth=1,t.strokeStyle=R,t.stroke(),a){const{computedHeight:D}=a;t.beginPath();const{pos:[P,B]}=l,X=LiteGraph.NODE_WIDGET_HEIGHT;a.type.startsWith("custom")&&D!=null&&D>X*2?t.rect(P+9,B+a.y+9,(a.width??p[2])-18,D-18):t.roundRect(P+BaseWidget.margin,B+a.y,a.width??p[2],X,X*.5),t.stroke()}t.strokeStyle=G,t.stroke(),t.setLineDash([]),t.lineWidth=c,t.strokeStyle=u},Oi=function(t,i,n,s){var r,a;const{globalAlpha:o}=t;t.globalAlpha=o*.33;for(const l of i.floatingLinks.values()){const u=LLink.getReroutes(i,l),c=u[0],p=u.at(-1);if(!(!c||!(p!=null&&p.floating)))if(p.floating.slotType==="input"){const f=i.getNodeById(l.target_id);if(!f)continue;const g=c.pos,m=f.getInputPos(l.target_slot),_=(r=f.inputs[l.target_slot])==null?void 0:r.dir;c._dragging=!0,C(this,F,Xt).call(this,t,l,g,m,n,s,LinkDirection.CENTER,_,!0)}else{const f=i.getNodeById(l.origin_id);if(!f)continue;const g=f.getOutputPos(l.origin_slot),m=p.pos,_=(a=f.outputs[l.origin_slot])==null?void 0:a.dir;l._dragging=!0,C(this,F,Xt).call(this,t,l,g,m,n,s,_,LinkDirection.CENTER,!0)}}t.globalAlpha=o},Xt=function(t,i,n,s,o,r,a,l,u=!1){var k,w,T;const{graph:c,renderedPaths:p}=this;if(!c)return;const f=LLink.getReroutes(c,i),g=[n,...f.map(I=>I.pos),s],m=g.map(I=>I[0]),_=g.map(I=>I[1]);if(S(O,gt)[0]=Math.min(...m),S(O,gt)[1]=Math.min(..._),S(O,gt)[2]=Math.max(...m)-S(O,gt)[0],S(O,gt)[3]=Math.max(..._)-S(O,gt)[1],!overlapBounding(S(O,gt),S(O,bt)))return;const y=a||LinkDirection.RIGHT,b=l||LinkDirection.LEFT;if(f.length){let I;const E=f.length;for(let R=0;R<E;R++){const N=f[R];if(!p.has(N)){p.add(N),o.push(N),N._colour=i.color||O.link_type_colors[i.type]||this.default_link_color;const D=c.getReroute(N.parentId),P=(D==null?void 0:D.pos)??n;N.calculateAngle(this.last_draw_time,c,P),N._dragging||this.renderLink(t,P,N.pos,i,!1,0,null,I===void 0?y:LinkDirection.CENTER,LinkDirection.CENTER,{startControl:I,endControl:N.controlPoint,reroute:N,disabled:u})}if(!I&&((w=(k=f.at(-1))==null?void 0:k.floating)==null?void 0:w.slotType)==="input")I=[0,0];else{const D=((T=f[R+1])==null?void 0:T.pos)??s,P=Math.min(Reroute.maxSplineOffset,distance(N.pos,D)*.25);I=[P*N.cos,P*N.sin]}}if(i._dragging)return;const G=g.at(-2)??n;this.renderLink(t,G,s,i,!1,0,null,LinkDirection.CENTER,b,{startControl:I,disabled:u})}else i._dragging||this.renderLink(t,n,s,i,!1,0,null,y,b);if(p.add(i),i!=null&&i._last_time&&r-i._last_time<1e3){const I=2-(r-i._last_time)*.002,E=t.globalAlpha;t.globalAlpha=E*I,this.renderLink(t,n,s,i,!0,I,"white",y,b),t.globalAlpha=E}},ye=function(t,i,n,s=.25){switch(i){case LinkDirection.LEFT:t[0]+=n*-s;break;case LinkDirection.RIGHT:t[0]+=n*s;break;case LinkDirection.UP:t[1]+=n*-s;break;case LinkDirection.DOWN:t[1]+=n*s;break}},W(O,ke,new Float32Array(4)),W(O,Le,new Float32Array(2)),W(O,Ie,new Float32Array(4)),W(O,bt,new Float32Array(4)),W(O,gt,new Float32Array(4)),W(O,Se,new Float32Array(2)),W(O,Te,new Float32Array(2)),W(O,Ee,new Float32Array(2)),h(O,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),h(O,"DEFAULT_EVENT_LINK_COLOR","#A86"),h(O,"link_type_colors",{"-1":O.DEFAULT_EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),h(O,"gradients",{}),h(O,"search_limit",-1),h(O,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}}),h(O,"_measureText"),h(O,"active_canvas"),h(O,"active_node");let LGraphCanvas=O;class MapProxyHandler{getOwnPropertyDescriptor(t,i){const n=this.get(t,i);if(n)return{configurable:!0,enumerable:!0,value:n}}has(t,i){if(typeof i=="symbol")return!1;const n=parseInt(i,10);return t.has(isNaN(n)?i:n)}ownKeys(t){return[...t.keys()].map(String)}get(t,i){if(i in t)return Reflect.get(t,i,t);if(typeof i=="symbol")return;const n=parseInt(i,10);return t.get(isNaN(n)?i:n)}set(t,i,n){if(typeof i=="symbol")return!1;const s=parseInt(i,10);return t.set(isNaN(s)?i:s,n),!0}deleteProperty(t,i){return t.delete(i)}static bindAllMethods(t){t.clear=t.clear.bind(t),t.delete=t.delete.bind(t),t.forEach=t.forEach.bind(t),t.get=t.get.bind(t),t.has=t.has.bind(t),t.set=t.set.bind(t),t.entries=t.entries.bind(t),t.keys=t.keys.bind(t),t.values=t.values.bind(t),t[Symbol.iterator]=t[Symbol.iterator].bind(t)}}const nt=class nt{constructor(t){W(this,Ce);h(this,"id",zeroUuid);h(this,"revision",0);h(this,"_version",-1);h(this,"_links",new Map);h(this,"links");h(this,"list_of_graphcanvas");h(this,"status",nt.STATUS_STOPPED);h(this,"state",{lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0});h(this,"events",new CustomEventTarget);h(this,"_subgraphs",new Map);h(this,"_nodes",[]);h(this,"_nodes_by_id",{});h(this,"_nodes_in_order",[]);h(this,"_nodes_executable",null);h(this,"_groups",[]);h(this,"iteration",0);h(this,"globaltime",0);h(this,"runningtime",0);h(this,"fixedtime",0);h(this,"fixedtime_lapse",.01);h(this,"elapsed_time",.01);h(this,"last_update_time",0);h(this,"starttime",0);h(this,"catch_errors",!0);h(this,"execution_timer_id");h(this,"errors_in_execution");h(this,"execution_time");h(this,"_last_trigger_time");h(this,"filter");h(this,"config",{});h(this,"vars",{});h(this,"nodes_executing",[]);h(this,"nodes_actioning",[]);h(this,"nodes_executedAction",[]);h(this,"extra",{});h(this,"version");W(this,Ct,0);W(this,Ot,new Map);W(this,Ne,new Map);h(this,"_input_nodes");W(this,he);LiteGraph.debug&&console.log("Graph created");const i=this._links;MapProxyHandler.bindAllMethods(i);const n=new MapProxyHandler;this.links=new Proxy(i,n),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}get empty(){return this._nodes.length+this._groups.length+this.reroutes.size===0}*positionableItems(){for(const t of this._nodes)yield t;for(const t of this._groups)yield t;for(const t of this.reroutes.values())yield t}get floatingLinks(){return S(this,Ot)}get reroutes(){return S(this,Ne)}get rootGraph(){return this}get isRootGraph(){return this.rootGraph===this}get last_node_id(){return this.state.lastNodeId}set last_node_id(t){this.state.lastNodeId=t}get last_link_id(){return this.state.lastLinkId}set last_link_id(t){this.state.lastLinkId=t}clear(){var t;if(this.stop(),this.status=nt.STATUS_STOPPED,this.id=zeroUuid,this.revision=0,this.state={lastGroupId:0,lastNodeId:0,lastLinkId:0,lastRerouteId:0},this._version=-1,this._subgraphs.clear(),this._nodes)for(const i of this._nodes)(t=i.onRemoved)==null||t.call(i);this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._links.clear(),this.reroutes.clear(),S(this,Ot).clear(),H(this,Ct,0),this._groups=[],this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.change(),this.canvasAction(i=>i.clear())}get subgraphs(){return this.rootGraph._subgraphs}get nodes(){return this._nodes}get groups(){return this._groups}attachCanvas(t){var i;if(!(t instanceof LGraphCanvas))throw new TypeError("attachCanvas expects an LGraphCanvas instance");this.primaryCanvas=t,this.list_of_graphcanvas??(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.includes(t)||this.list_of_graphcanvas.push(t),t.graph!==this&&((i=t.graph)==null||i.detachCanvas(t),t.graph=this,t.subgraph=void 0)}detachCanvas(t){t.graph=null;const i=this.list_of_graphcanvas;if(i){const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}start(t){var i;if(this.status!=nt.STATUS_RUNNING)if(this.status=nt.STATUS_RUNNING,(i=this.onPlayEvent)==null||i.call(this),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,t||(t=0),t==0&&typeof window<"u"&&window.requestAnimationFrame){const n=()=>{var s,o;this.execution_timer_id==-1&&(window.requestAnimationFrame(n),(s=this.onBeforeStep)==null||s.call(this),this.runStep(1,!this.catch_errors),(o=this.onAfterStep)==null||o.call(this))};this.execution_timer_id=-1,n()}else this.execution_timer_id=setInterval(()=>{var n,s;(n=this.onBeforeStep)==null||n.call(this),this.runStep(1,!this.catch_errors),(s=this.onAfterStep)==null||s.call(this)},t)}stop(){var t;this.status!=nt.STATUS_STOPPED&&(this.status=nt.STATUS_STOPPED,(t=this.onStopEvent)==null||t.call(this),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t,i,n){var l,u,c,p,f,g;t=t||1;const s=LiteGraph.getTime();this.globaltime=.001*(s-this.starttime);const o=this._nodes_executable||this._nodes;if(!o)return;if(n=n||o.length,i){for(let m=0;m<t;m++){for(let _=0;_<n;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&y.onExecute&&((l=y.doExecute)==null||l.call(y))}this.fixedtime+=this.fixedtime_lapse,(u=this.onExecuteStep)==null||u.call(this)}(c=this.onAfterExecute)==null||c.call(this)}else try{for(let m=0;m<t;m++){for(let _=0;_<n;++_){const y=o[_];y.mode==LGraphEventMode.ALWAYS&&((p=y.onExecute)==null||p.call(y))}this.fixedtime+=this.fixedtime_lapse,(f=this.onExecuteStep)==null||f.call(this)}(g=this.onAfterExecute)==null||g.call(this),this.errors_in_execution=!1}catch(m){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw m;LiteGraph.debug&&console.log("Error during execution:",m),this.stop()}const r=LiteGraph.getTime();let a=r-s;a==0&&(a=1),this.execution_time=.001*a,this.globaltime+=.001*a,this.iteration+=1,this.elapsed_time=(r-this.last_update_time)*.001,this.last_update_time=r,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(const t of this._nodes_in_order)t.onExecute&&this._nodes_executable.push(t)}computeExecutionOrder(t,i){const n=[],s=[],o={},r={},a={};for(const u of this._nodes){if(t&&!u.onExecute)continue;o[u.id]=u;let c=0;if(u.inputs)for(const p of u.inputs)(p==null?void 0:p.link)!=null&&(c+=1);c==0?(s.push(u),i&&(u._level=1)):(i&&(u._level=0),a[u.id]=c)}for(;;){const u=s.shift();if(u===void 0)break;if(n.push(u),delete o[u.id],!!u.outputs){for(const c of u.outputs)if(!((c==null?void 0:c.links)==null||c.links.length==0))for(const p of c.links){const f=this._links.get(p);if(!f||r[f.id])continue;const g=this.getNodeById(f.target_id);if(g==null){r[f.id]=!0;continue}i&&(u._level??(u._level=0),(!g._level||g._level<=u._level)&&(g._level=u._level+1)),r[f.id]=!0,a[g.id]-=1,a[g.id]==0&&s.push(g)}}}for(const u in o)n.push(o[u]);n.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");function l(u){const c=u.length;for(let p=0;p<c;++p)u[p].order=p}return l(n),n.sort(function(u,c){const p=u.constructor.priority||u.priority||0,f=c.constructor.priority||c.priority||0;return p==f?u.order-c.order:p-f}),l(n),n}arrange(t,i){t=t||100;const n=this.computeExecutionOrder(!1,!0),s=[];for(const r of n){const a=r._level||1;s[a]||(s[a]=[]),s[a].push(r)}let o=t;for(const r of s){if(!r)continue;let a=100,l=t+LiteGraph.NODE_TITLE_HEIGHT;for(const u of r){u.pos[0]=i==LiteGraph.VERTICAL_LAYOUT?l:o,u.pos[1]=i==LiteGraph.VERTICAL_LAYOUT?o:l;const c=i==LiteGraph.VERTICAL_LAYOUT?1:0;u.size[c]>a&&(a=u.size[c]);const p=i==LiteGraph.VERTICAL_LAYOUT?0:1;l+=u.size[p]+t+LiteGraph.NODE_TITLE_HEIGHT}o+=a+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,i,n){n=n||LGraphEventMode.ALWAYS;const s=this._nodes_in_order||this._nodes;if(s)for(const o of s)!o[t]||o.mode!=n||(i===void 0?o[t]():i&&i.constructor===Array?o[t].apply(o,i):o[t](i))}canvasAction(t){const i=this.list_of_graphcanvas;if(i)for(const n of i)t(n)}sendActionToCanvas(t,i){var s;const{list_of_graphcanvas:n}=this;if(n)for(const o of n)(s=o[t])==null||s.apply(o,i)}add(t,i){var s,o;if(!t)return;const{state:n}=this;if(LiteGraph.alwaysSnapToGrid){const r=this.getSnapToGridSize();r&&t.snapToGrid(r)}if(t instanceof LGraphGroup){(t.id==null||t.id===-1)&&(t.id=++n.lastGroupId),t.id>n.lastGroupId&&(n.lastGroupId=t.id),this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=LiteGraph.use_uuids?LiteGraph.uuidv4():++n.lastNodeId),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++n.lastNodeId:typeof t.id=="number"&&n.lastNodeId<t.id&&(n.lastNodeId=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,(s=t.onAdded)==null||s.call(t,this),this.config.align_to_grid&&t.alignToGrid(),i||this.updateExecutionOrder(),(o=this.onNodeAdded)==null||o.call(this,t),this.setDirtyCanvas(!0),this.change(),t}remove(t){var r,a,l;if(t instanceof LGraphGroup){this.canvasAction(c=>c.deselect(t));const u=this._groups.indexOf(t);u!=-1&&this._groups.splice(u,1),t.graph=void 0,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]==null){console.warn("LiteGraph: node not found",t);return}if(t.ignore_remove){console.warn("LiteGraph: node cannot be removed",t);return}this.beforeChange();const{inputs:i,outputs:n}=t;if(i)for(const[u,c]of i.entries())c.link!=null&&t.disconnectInput(u,!0);if(n)for(const[u,c]of n.entries())(r=c.links)!=null&&r.length&&t.disconnectOutput(u);for(const u of this.floatingLinks.values())(u.origin_id===t.id||u.target_id===t.id)&&this.removeFloatingLink(u);(a=t.onRemoved)==null||a.call(t),t.graph=null,this._version++;const{list_of_graphcanvas:s}=this;if(s)for(const u of s)u.selected_nodes[t.id]&&delete u.selected_nodes[t.id],u.deselect(t);const o=this._nodes.indexOf(t);o!=-1&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],(l=this.onNodeRemoved)==null||l.call(this,t),this.canvasAction(u=>u.checkPanels()),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}getNodeById(t){return t!=null?this._nodes_by_id[t]:null}findNodesByClass(t,i){i=i||[],i.length=0;const{_nodes:n}=this;for(const s of n)s.constructor===t&&i.push(s);return i}findNodesByType(t,i){var o;const n=t.toLowerCase();i=i||[],i.length=0;const{_nodes:s}=this;for(const r of s)((o=r.type)==null?void 0:o.toLowerCase())==n&&i.push(r);return i}findNodeByTitle(t){const{_nodes:i}=this;for(const n of i)if(n.title==t)return n;return null}findNodesByTitle(t){const i=[],{_nodes:n}=this;for(const s of n)s.title==t&&i.push(s);return i}getNodeOnPos(t,i,n){const s=n||this._nodes;let o=s.length;for(;--o>=0;){const r=s[o];if(r.isPointInside(t,i))return r}return null}getGroupOnPos(t,i){return this._groups.toReversed().find(n=>n.isPointInside(t,i))}getGroupTitlebarOnPos(t,i){return this._groups.toReversed().find(n=>n.isPointInTitlebar(t,i))}getRerouteOnPos(t,i,n){for(const s of n??this.reroutes.values())if(s.containsPoint([t,i]))return s}snapToGrid(t){const i=this.getSnapToGridSize();if(i)for(const n of getAllNestedItems(t))n.pinned||n.snapToGrid(i)}getSnapToGridSize(){return LiteGraph.alwaysSnapToGrid?LiteGraph.CANVAS_GRID_SIZE||1:LiteGraph.CANVAS_GRID_SIZE}checkNodeTypes(){const{_nodes:t}=this;for(const[i,n]of t.entries()){const s=LiteGraph.registered_node_types[n.type];if(n.constructor==s)continue;console.log("node being replaced by newer version:",n.type);const o=LiteGraph.createNode(n.type);o&&(t[i]=o,o.configure(n.serialize()),o.graph=this,this._nodes_by_id[o.id]=o,n.inputs&&(o.inputs=[...n.inputs]),n.outputs&&(o.outputs=[...n.outputs]))}this.updateExecutionOrder()}trigger(t,i){var n;(n=this.onTrigger)==null||n.call(this,t,i)}triggerInput(t,i){const n=this.findNodesByTitle(t);for(const s of n)s.onTrigger(i)}setCallback(t,i){const n=this.findNodesByTitle(t);for(const s of n)s.setTrigger(i)}beforeChange(t){var i;(i=this.onBeforeChange)==null||i.call(this,this,t),this.canvasAction(n=>{var s;return(s=n.onBeforeChange)==null?void 0:s.call(n,this)})}afterChange(t){var i;(i=this.onAfterChange)==null||i.call(this,this,t),this.canvasAction(n=>{var s;return(s=n.onAfterChange)==null?void 0:s.call(n,this)})}clearTriggeredSlots(){for(const t of this._links.values())t&&t._last_time&&(t._last_time=0)}change(){var t;LiteGraph.debug&&console.log("Graph changed"),this.canvasAction(i=>i.setDirty(!0,!0)),(t=this.on_change)==null||t.call(this,this)}setDirtyCanvas(t,i){this.canvasAction(n=>n.setDirty(t,i))}addFloatingLink(t){var s,o,r,a;t.id===-1&&(t.id=++ni(this,Ct)._),S(this,Ot).set(t.id,t);const i=t.target_id!==-1?(o=(s=this.getNodeById(t.target_id))==null?void 0:s.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i?(i._floatingLinks??(i._floatingLinks=new Set),i._floatingLinks.add(t)):console.warn(`Adding invalid floating link: target/slot: [${t.target_id}/${t.target_slot}] origin/slot: [${t.origin_id}/${t.origin_slot}]`);const n=LLink.getReroutes(this,t);for(const l of n)l.floatingLinkIds.add(t.id);return t}removeFloatingLink(t){var s,o,r,a,l;S(this,Ot).delete(t.id);const i=t.target_id!==-1?(o=(s=this.getNodeById(t.target_id))==null?void 0:s.inputs)==null?void 0:o[t.target_slot]:(a=(r=this.getNodeById(t.origin_id))==null?void 0:r.outputs)==null?void 0:a[t.origin_slot];i&&((l=i._floatingLinks)==null||l.delete(t));const n=LLink.getReroutes(this,t);for(const u of n)u.floatingLinkIds.delete(t.id),u.floatingLinkIds.size===0&&delete u.floating,u.totalLinks===0&&this.removeReroute(u.id)}getLink(t){return t==null?void 0:this._links.get(t)}getReroute(t){return t==null?void 0:this.reroutes.get(t)}setReroute({id:t,parentId:i,pos:n,linkIds:s,floating:o}){t??(t=++this.state.lastRerouteId),t>this.state.lastRerouteId&&(this.state.lastRerouteId=t);const r=this.reroutes.get(t)??new Reroute(t,this);return r.update(i,n,s,o),this.reroutes.set(t,r),r}createReroute(t,i){const n=++this.state.lastRerouteId,s=i instanceof Reroute?i.linkIds:[i.id],o=i instanceof Reroute?i.floatingLinkIds:[i.id],r=new Reroute(n,this,t,i.parentId,s,o);this.reroutes.set(n,r);for(const a of s){const l=this._links.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=n);const u=LLink.getReroutes(this,l);for(const c of u.filter(p=>p.parentId===i.parentId))c.parentId=n}for(const a of o){const l=this.floatingLinks.get(a);if(!l)continue;l.parentId===i.parentId&&(l.parentId=n);const u=LLink.getReroutes(this,l);for(const c of u.filter(p=>p.parentId===i.parentId))c.parentId=n}return r}removeReroute(t){const{reroutes:i}=this,n=i.get(t);if(!n)return;this.canvasAction(a=>a.deselect(n));const{parentId:s,linkIds:o,floatingLinkIds:r}=n;for(const a of i.values())a.parentId===t&&(a.parentId=s);for(const a of o){const l=this._links.get(a);l&&l.parentId===t&&(l.parentId=s)}for(const a of r){const l=this.floatingLinks.get(a);if(!l){console.warn(`Removed reroute had floating link ID that did not exist [${a}]`);continue}const u=LLink.getReroutes(this,l),c=u.at(-1),p=u.at(-2);n===c&&((p==null?void 0:p.totalLinks)!==1?this.removeFloatingLink(l):l.parentId===t&&(l.parentId=s,p.floating=n.floating))}i.delete(t),this.setDirtyCanvas(!1,!0)}removeLink(t){const i=this._links.get(t);if(!i)return;const n=this.getNodeById(i.target_id);n==null||n.disconnectInput(i.target_slot,!1),i.disconnect(this)}createSubgraph(t){const{id:i}=t,n=new Subgraph(this.rootGraph,t);return this.subgraphs.set(i,n),this.rootGraph.events.dispatch("subgraph-created",{subgraph:n,data:t}),n}convertToSubgraph(t){var B,X;if(t.size===0)throw new Error("Cannot convert to subgraph: nothing to convert");const{state:i,revision:n,config:s}=this,{boundaryLinks:o,boundaryFloatingLinks:r,internalLinks:a,boundaryInputLinks:l,boundaryOutputLinks:u}=getBoundaryLinks(this,t),{nodes:c,reroutes:p,groups:f}=splitPositionables(t),g=createBounds(t);if(!g)throw new Error("Failed to create bounding rect for subgraph");const m=l.map(A=>A.resolve(this)),_=u.map(A=>A.resolve(this)),y=multiClone(c),b=a.map(A=>A.asSerialisable()),k=mapSubgraphInputsAndLinks(m,b),w=mapSubgraphOutputsAndLinks(_,b),T={id:createUuidv4(),name:"New Subgraph",inputNode:{id:SUBGRAPH_INPUT_ID,bounding:[0,0,75,100]},outputNode:{id:SUBGRAPH_OUTPUT_ID,bounding:[0,0,75,100]},inputs:k,outputs:w,widgets:[],version:nt.serialisedSchemaVersion,state:i,revision:n,config:s,links:b,nodes:y,reroutes:structuredClone([...p].map(A=>A.asSerialisable())),groups:structuredClone([...f].map(A=>A.serialize()))},I=this.createSubgraph(T);I.configure(T),I.inputNode.arrange(),I.outputNode.arrange();const{boundingRect:E}=I.inputNode,{boundingRect:G}=I.outputNode;alignOutsideContainer(E,Alignment.MidLeft,g,[50,0]),alignOutsideContainer(G,Alignment.MidRight,g,[50,0]);for(const A of m)(B=A.inputNode)==null||B.disconnectInput(A.inputNode.inputs.indexOf(A.input),!0);for(const A of _)(X=A.outputNode)==null||X.disconnectOutput(A.outputNode.outputs.indexOf(A.output),A.inputNode);for(const A of c)this.remove(A);for(const A of p)this.removeReroute(A.id);for(const A of f)this.remove(A);this.rootGraph.events.dispatch("convert-to-subgraph",{subgraph:I,bounds:g,exportedSubgraph:T,boundaryLinks:o,resolvedInputLinks:m,resolvedOutputLinks:_,boundaryFloatingLinks:r,internalLinks:a});const R=LiteGraph.createNode(I.id,I.name,{inputs:structuredClone(k),outputs:structuredClone(w)});if(!R)throw new Error("Failed to create subgraph node");R.setSize(R.computeSize()),alignToContainer(R._posSize,Alignment.Centre|Alignment.Middle,g),this.add(R);const N=groupResolvedByOutput(m);let D=0;for(const[,A]of N.entries()){const[L,...j]=A,{output:Y,outputNode:M,link:z,subgraphInput:Q}=L;if(D++,z.origin_id===SUBGRAPH_INPUT_ID){if(z.target_id=R.id,z.target_slot=D-1,Q instanceof SubgraphInput)Q.connect(R.findInputSlotByType(z.type,!0,!0),R,z.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");console.debug("Reconnect input links in parent graph",{...z},this.links.get(z.id),this.links.get(z.id)===z);for(const _e of j)_e.link.disconnect(this);continue}if(!Y||!M){console.warn("Convert to Subgraph reconnect: Failed to resolve input link",A[0]);continue}const q=R.findInputSlotByType(z.type,!0,!0);M.connectSlots(Y,R,q,z.parentId)}const P=groupResolvedByOutput(_);D=0;for(const[,A]of P.entries()){D++;for(const L of A){const{input:j,inputNode:Y,link:M,subgraphOutput:z}=L;if(M.target_id===SUBGRAPH_OUTPUT_ID){if(M.origin_id=R.id,M.origin_slot=D-1,this.links.set(M.id,M),z instanceof SubgraphOutput)z.connect(R.findOutputSlotByType(M.type,!0,!0),R,M.parentId);else throw new TypeError("Subgraph input node is not a SubgraphInput");continue}if(!j||!Y){console.warn("Convert to Subgraph reconnect: Failed to resolve output link",L);continue}const Q=R.outputs[D-1];R.connectSlots(Q,Y,j,M.parentId)}}return{subgraph:I,node:R}}resolveSubgraphIdPath(t){const i=[];let n=this.rootGraph;for(const s of t){const o=n.getNodeById(s);if(!o)throw new Error(`Node [${s}] not found.  ID Path: ${t.join(":")}`);if(!o.isSubgraphNode())throw new Error(`Node [${s}] is not a SubgraphNode.  ID Path: ${t.join(":")}`);i.push(o),n=o.subgraph}return i}serialize(t){const{config:i,state:n,groups:s,nodes:o,reroutes:r,extra:a,floatingLinks:l,definitions:u}=this.asSerialisable(t),c=[...this._links.values()],p=c.map(f=>f.serialize());return r!=null&&r.length&&(a.linkExtensions=c.filter(f=>f.parentId!==void 0).map(f=>({id:f.id,parentId:f.parentId}))),a.reroutes=r!=null&&r.length?r:void 0,{id:this.id,revision:this.revision,last_node_id:n.lastNodeId,last_link_id:n.lastLinkId,nodes:o,links:p,floatingLinks:l,groups:s,definitions:u,config:i,extra:a,version:LiteGraph.VERSION}}asSerialisable(t){var m;const{id:i,revision:n,config:s,state:o}=this,a=(!LiteGraph.use_uuids&&(t!=null&&t.sortNodes)?[...this._nodes].sort((_,y)=>_.id-y.id):this._nodes).map(_=>_.serialize()),l=this._groups.map(_=>_.serialize()),u=this._links.size?[...this._links.values()].map(_=>_.asSerialisable()):void 0,c=this.floatingLinks.size?[...this.floatingLinks.values()].map(_=>_.asSerialisable()):void 0,p=this.reroutes.size?[...this.reroutes.values()].map(_=>_.asSerialisable()):void 0,f={...this.extra};LiteGraph.saveViewportWithGraph&&(f.ds=C(this,Ce,Di).call(this)),f.ds||delete f.ds;const g={id:i,revision:n,version:nt.serialisedSchemaVersion,config:s,state:o,groups:l,nodes:a,links:u,floatingLinks:c,reroutes:p,extra:f};if(this.isRootGraph&&this._subgraphs.size){const _=findUsedSubgraphIds(this,this._subgraphs),y=[...this._subgraphs.values()].filter(b=>_.has(b.id)).map(b=>b.asSerialisable());y.length>0&&(g.definitions={subgraphs:y})}return(m=this.onSerialize)==null||m.call(this,g),g}_configureBase(t){const{id:i,extra:n}=t;i?this.id=i:this.id===zeroUuid&&(this.id=createUuidv4()),this.extra=n?structuredClone(n):{},delete this.extra.linkExtensions}configure(t,i){var o,r,a,l,u;const n={data:t,clearGraph:!i};if(this.events.dispatch("configuring",n))try{if(!t)return;n.clearGraph&&this.clear(),this._configureBase(t);let c;if(t.version===.4){const{extra:k}=t;if(Array.isArray(t.links))for(const w of t.links){const T=LLink.createFromArray(w);this._links.set(T.id,T)}if(Array.isArray(k==null?void 0:k.linkExtensions))for(const w of k.linkExtensions){const T=this._links.get(w.id);T&&(T.parentId=w.parentId)}c=k==null?void 0:k.reroutes}else{if(t.state){const{lastGroupId:k,lastLinkId:w,lastNodeId:T,lastRerouteId:I}=t.state,{state:E}=this;k!=null&&(E.lastGroupId=k),w!=null&&(E.lastLinkId=w),T!=null&&(E.lastNodeId=T),I!=null&&(E.lastRerouteId=I)}if(Array.isArray(t.links))for(const k of t.links){const w=LLink.create(k);this._links.set(w.id,w)}c=t.reroutes}if(Array.isArray(c))for(const k of c)this.setReroute(k);const p=t.nodes;for(const k in t)nt.ConfigureProperties.has(k)||(this[k]=t[k]);const f=(o=t.definitions)==null?void 0:o.subgraphs;if(f){for(const k of f)this.createSubgraph(k);for(const k of f)(r=this.subgraphs.get(k.id))==null||r.configure(k)}let g=!1;const m=new Map;if(this._nodes=[],p){for(const k of p){let w=LiteGraph.createNode(String(k.type),k.title);w||(LiteGraph.debug&&console.log("Node not found or has errors:",k.type),w=new LGraphNode(""),w.last_serialization=k,w.has_errors=!0,g=!0),w.id=k.id,this.add(w,!0),m.set(w.id,k)}for(const[k,w]of m)(a=this.getNodeById(k))==null||a.configure(w)}if(Array.isArray(t.floatingLinks))for(const k of t.floatingLinks){const w=LLink.create(k);this.addFloatingLink(w),w.id>S(this,Ct)&&H(this,Ct,w.id)}for(const k of this.reroutes.values())k.validateLinks(this._links,this.floatingLinks)||this.reroutes.delete(k.id);this._groups.length=0;const _=t.groups;if(_)for(const k of _){const w=new LiteGraph.LGraphGroup;w.configure(k),this.add(w)}this.updateExecutionOrder(),(l=this.onConfigure)==null||l.call(this,t),this._version++;const{primaryCanvas:y}=this,b=(u=y==null?void 0:y.subgraph)==null?void 0:u.id;if(b){const k=this.subgraphs.get(b);k?y.setGraph(k):y.setGraph(this)}return this.setDirtyCanvas(!0,!0),g}finally{this.events.dispatch("configured")}}get primaryCanvas(){return S(this.rootGraph,he)}set primaryCanvas(t){H(this.rootGraph,he,t)}load(t,i){const n=this;if(t instanceof Blob||t instanceof File){const o=new FileReader;o.addEventListener("load",function(r){var u;const a=stringOrEmpty((u=r.target)==null?void 0:u.result),l=JSON.parse(a);n.configure(l),i==null||i()}),o.readAsText(t);return}const s=new XMLHttpRequest;s.open("GET",t,!0),s.send(null),s.addEventListener("load",function(){if(s.status!==200){console.error("Error loading graph:",s.status,s.response);return}const o=JSON.parse(s.response);n.configure(o),i==null||i()}),s.addEventListener("error",o=>{console.error("Error loading graph:",o)})}};Ct=new WeakMap,Ot=new WeakMap,Ne=new WeakMap,Ce=new WeakSet,Di=function(){var i,n;const t=(n=(i=this.list_of_graphcanvas)==null?void 0:i.at(0))==null?void 0:n.ds;if(t)return{scale:t.scale,offset:t.offset}},he=new WeakMap,h(nt,"serialisedSchemaVersion",1),h(nt,"STATUS_STOPPED",1),h(nt,"STATUS_RUNNING",2),h(nt,"ConfigureProperties",new Set(["nodes","groups","links","state","reroutes","floatingLinks","id","subgraphs","definitions","inputs","outputs","widgets","inputNode","outputNode","extra"]));let LGraph=nt;const Oe=class Oe extends LGraph{constructor(i,n){if(!i)throw new Error("Root graph is required");super();W(this,ce);h(this,"name","Unnamed Subgraph");h(this,"inputNode",new SubgraphInputNode(this));h(this,"outputNode",new SubgraphOutputNode(this));h(this,"inputs",[]);h(this,"outputs",[]);h(this,"widgets",[]);W(this,ue);H(this,ue,i);const s=structuredClone(n);this._configureBase(s),C(this,ce,qe).call(this,s)}get rootGraph(){return S(this,ue)}getIoNodeOnPos(i,n){const{inputNode:s,outputNode:o}=this;if(s.containsPoint([i,n]))return s;if(o.containsPoint([i,n]))return o}configure(i,n){const s=super.configure(i,n);return C(this,ce,qe).call(this,i),s}attachCanvas(i){super.attachCanvas(i),i.subgraph=this}addInput(i,n){this.events.dispatch("adding-input",{name:i,type:n});const s=new SubgraphInput({id:createUuidv4(),name:i,type:n},this.inputNode);return this.inputs.push(s),this.events.dispatch("input-added",{input:s}),s}addOutput(i,n){this.events.dispatch("adding-output",{name:i,type:n});const s=new SubgraphOutput({id:createUuidv4(),name:i,type:n},this.outputNode);return this.outputs.push(s),this.events.dispatch("output-added",{output:s}),s}renameInput(i,n){const s=this.inputs.indexOf(i);if(s===-1)throw new Error("Input not found");const o=i.displayName;this.events.dispatch("renaming-input",{input:i,index:s,oldName:o,newName:n}),i.label=n}renameOutput(i,n){const s=this.outputs.indexOf(i);if(s===-1)throw new Error("Output not found");const o=i.displayName;this.events.dispatch("renaming-output",{output:i,index:s,oldName:o,newName:n}),i.label=n}removeInput(i){i.disconnect();const n=this.inputs.indexOf(i);if(n===-1)throw new Error("Input not found");if(!this.events.dispatch("removing-input",{input:i,index:n}))return;this.inputs.splice(n,1);const{length:o}=this.inputs;for(let r=n;r<o;r++)this.inputs[r].decrementSlots("inputs")}removeOutput(i){i.disconnect();const n=this.outputs.indexOf(i);if(n===-1)throw new Error("Output not found");if(!this.events.dispatch("removing-output",{output:i,index:n}))return;this.outputs.splice(n,1);const{length:o}=this.outputs;for(let r=n;r<o;r++)this.outputs[r].decrementSlots("outputs")}draw(i,n,s,o){this.inputNode.draw(i,n,s,o),this.outputNode.draw(i,n,s,o)}clone(i=!1){const n=this.asSerialisable();i||(n.id=createUuidv4());const s=new Oe(this.rootGraph,n);return s.configure(n),s}asSerialisable(){return{id:this.id,version:LGraph.serialisedSchemaVersion,state:this.state,revision:this.revision,config:this.config,name:this.name,inputNode:this.inputNode.asSerialisable(),outputNode:this.outputNode.asSerialisable(),inputs:this.inputs.map(i=>i.asSerialisable()),outputs:this.outputs.map(i=>i.asSerialisable()),widgets:[...this.widgets],nodes:this.nodes.map(i=>i.serialize()),groups:this.groups.map(i=>i.serialize()),links:[...this.links.values()].map(i=>i.asSerialisable()),extra:this.extra}}};ue=new WeakMap,ce=new WeakSet,qe=function(i){const{name:n,inputs:s,outputs:o,widgets:r}=i;if(this.name=n,s){this.inputs.length=0;for(const a of s){const l=new SubgraphInput(a,this.inputNode);this.inputs.push(l),this.events.dispatch("input-added",{input:l})}}if(o){this.outputs.length=0;for(const a of o)this.outputs.push(new SubgraphOutput(a,this.outputNode))}if(r){this.widgets.length=0;for(const a of r)this.widgets.push(a)}this.inputNode.configure(i.inputNode),this.outputNode.configure(i.outputNode)},h(Oe,"MAX_NESTED_SUBGRAPHS",1e3);let Subgraph=Oe;class InputIndicators{constructor(t){h(this,"radius",8);h(this,"startAngle",0);h(this,"endAngle",Math.PI*2);h(this,"inactiveColour","#ffffff10");h(this,"colour1","#ff5f00");h(this,"colour2","#00ff7c");h(this,"colour3","#dea7ff");h(this,"fontString","bold 12px Arial");h(this,"enabled",!0);h(this,"shiftDown",!1);h(this,"undoDown",!1);h(this,"redoDown",!1);h(this,"ctrlDown",!1);h(this,"altDown",!1);h(this,"mouse0Down",!1);h(this,"mouse1Down",!1);h(this,"mouse2Down",!1);h(this,"x",0);h(this,"y",0);h(this,"controller");W(this,de,this.onPointerDownOrMove.bind(this));W(this,De,this.onPointerUp.bind(this));W(this,pe,this.onKeyDownOrUp.bind(this));this.canvas=t,this.controller=new AbortController;const{signal:i}=this.controller,n=t.canvas,s={capture:!0,signal:i};n.addEventListener("pointerdown",S(this,de),s),n.addEventListener("pointermove",S(this,de),s),n.addEventListener("pointerup",S(this,De),s),n.addEventListener("keydown",S(this,pe),s),document.addEventListener("keyup",S(this,pe),s);const o=t.drawFrontCanvas.bind(t);i.addEventListener("abort",()=>{t.drawFrontCanvas=o}),t.drawFrontCanvas=()=>{o(),this.draw()}}onPointerDownOrMove(t){this.mouse0Down=(t.buttons&1)===1,this.mouse1Down=(t.buttons&4)===4,this.mouse2Down=(t.buttons&2)===2,this.x=t.clientX,this.y=t.clientY,this.canvas.setDirty(!0)}onPointerUp(){this.mouse0Down=!1,this.mouse1Down=!1,this.mouse2Down=!1}onKeyDownOrUp(t){this.ctrlDown=t.ctrlKey,this.altDown=t.altKey,this.shiftDown=t.shiftKey,this.undoDown=t.ctrlKey&&t.code==="KeyZ"&&t.type==="keydown",this.redoDown=t.ctrlKey&&t.code==="KeyY"&&t.type==="keydown"}draw(){const{canvas:{ctx:t},radius:i,startAngle:n,endAngle:s,x:o,y:r,inactiveColour:a,colour1:l,colour2:u,colour3:c,fontString:p}=this,{fillStyle:f,font:g}=t,m=o,_=r-80,y=m,b=_-15;t.font=p,I(y+0,b,"Shift",this.shiftDown?l:a),I(y+45,b+20,"Alt",this.altDown?u:a),I(y+30,b,"Control",this.ctrlDown?c:a),I(y-30,b,"â†©ï¸",this.undoDown?"#000":"transparent"),I(y+45,b,"â†ªï¸",this.redoDown?"#000":"transparent"),t.beginPath(),G(m,_),G(m+15,_),G(m+30,_),t.fillStyle=a,t.fill();const k=this.mouse0Down?l:a,w=this.mouse1Down?u:a,T=this.mouse2Down?c:a;this.mouse0Down&&E(m,_,k),this.mouse1Down&&E(m+15,_,w),this.mouse2Down&&E(m+30,_,T),t.fillStyle=f,t.font=g;function I(R,N,D,P){t.fillStyle=P,t.fillText(D,R,N)}function E(R,N,D){t.beginPath(),t.fillStyle=D,G(R,N),t.fill()}function G(R,N){t.arc(R,N,i,n,s)}}dispose(){var t;(t=this.controller)==null||t.abort(),this.controller=void 0}[Symbol.dispose](){this.dispose()}}de=new WeakMap,De=new WeakMap,pe=new WeakMap;class ContextMenu{constructor(t,i){h(this,"options");h(this,"parentMenu");h(this,"root");h(this,"current_submenu");h(this,"lock");h(this,"controller",new AbortController);var g,m,_;i||(i={}),this.options=i;const n=i.parentMenu;n&&(n instanceof ContextMenu?(this.parentMenu=n,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this):(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=void 0),((g=n.options)==null?void 0:g.className)==="dark"&&(i.className="dark"));const s=i.event?i.event.constructor.name:null;s!=="MouseEvent"&&s!=="CustomEvent"&&s!=="PointerEvent"&&(console.error(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${s})`),i.event=void 0);const o=document.createElement("div");let r="litegraph litecontextmenu litemenubar-panel";i.className&&(r+=` ${i.className}`),o.className=r,o.style.minWidth="100",o.style.minHeight="100";const{signal:a}=this.controller,l={capture:!0,signal:a};if(this.parentMenu||document.addEventListener("pointerdown",y=>{y.target instanceof Node&&!this.containsNode(y.target)&&this.close()},l),o.addEventListener("pointerup",y=>y.preventDefault(),l),o.addEventListener("contextmenu",y=>{y.button===2&&y.preventDefault()},l),o.addEventListener("pointerdown",y=>{y.button==2&&(this.close(),y.preventDefault())},l),this.root=o,i.title){const y=document.createElement("div");y.className="litemenu-title",y.innerHTML=i.title,o.append(y)}for(let y=0;y<t.length;y++){const b=t[y];let k=Array.isArray(t)?b:String(y);typeof k!="string"&&(k=k!=null?k.content===void 0?String(k):k.content:k),this.addItem(k,b,i)}const c=((_=(m=i.event)==null?void 0:m.target)==null?void 0:_.ownerDocument)||document;c.fullscreenElement?c.fullscreenElement.append(o):c.body.append(o);let p=i.left||0,f=i.top||0;if(i.event){if(p=i.event.clientX-10,f=i.event.clientY-10,i.title&&(f-=20),n){const k=n.root.getBoundingClientRect();p=k.left+k.width}const y=document.body.getBoundingClientRect(),b=o.getBoundingClientRect();y.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),y.width&&p>y.width-b.width-10&&(p=y.width-b.width-10),y.height&&f>y.height-b.height-10&&(f=y.height-b.height-10)}o.style.left=`${p}px`,o.style.top=`${f}px`,LiteGraph.context_menu_scaling&&i.scale&&(o.style.transform=`scale(${Math.round(i.scale*4)*.25})`)}containsNode(t,i=new Set){var n;return i.has(this)?!1:(i.add(this),((n=this.current_submenu)==null?void 0:n.containsNode(t,i))||this.root.contains(t))}addItem(t,i,n){n||(n={});const s=document.createElement("div");s.className="litemenu-entry submenu";let o=!1;if(i===null)s.classList.add("separator");else{const c=t===null?"":String(t);typeof i=="string"?s.innerHTML=c:(s.innerHTML=(i==null?void 0:i.title)??c,i.disabled&&(o=!0,s.classList.add("disabled"),s.setAttribute("aria-disabled","true")),(i.submenu||i.has_submenu)&&(s.classList.add("has_submenu"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false")),i.className&&(s.className+=` ${i.className}`)),s.value=i,s.setAttribute("role","menuitem"),typeof i=="function"?(s.dataset.value=String(t),s.onclick_callback=i):s.dataset.value=String(i)}this.root.append(s),o||s.addEventListener("click",u),!o&&n.autoopen&&s.addEventListener("pointerenter",a);const r=()=>{const c=this.root.querySelectorAll("div.litemenu-entry.has_submenu");if(c)for(const p of c)p.setAttribute("aria-expanded","false");s.setAttribute("aria-expanded","true")};function a(c){const p=this.value;!p||!p.has_submenu||(u.call(this,c),r())}const l=this;function u(c){var g;const p=this.value;let f=!0;if((g=l.current_submenu)==null||g.close(c),(p!=null&&p.has_submenu||p!=null&&p.submenu)&&r(),n.callback&&n.callback.call(this,p,n,c,l,n.node)===!0&&(f=!1),typeof p=="object"&&(p.callback&&!n.ignore_item_callbacks&&p.disabled!==!0&&p.callback.call(this,p,n,c,l,n.extra)===!0&&(f=!1),p.submenu)){if(!p.submenu.options)throw"ContextMenu submenu needs options";new l.constructor(p.submenu.options,{callback:p.submenu.callback,event:c,parentMenu:l,ignore_item_callbacks:p.submenu.ignore_item_callbacks,title:p.submenu.title,extra:p.submenu.extra,autoopen:n.autoopen}),f=!1}f&&!l.lock&&l.close()}return s}close(t,i){var n;this.controller.abort(),this.root.remove(),this.parentMenu&&!i&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=void 0,t===void 0?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,`${LiteGraph.pointerevents_method}leave`,t)),(n=this.current_submenu)==null||n.close(t,!0)}static trigger(t,i,n){const s=document.createEvent("CustomEvent");return s.initCustomEvent(i,!0,!0,n),t.dispatchEvent&&t.dispatchEvent(s),s}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(t,i){const n=t.clientX,s=t.clientY,o=i.getBoundingClientRect();return o?s>o.top&&s<o.top+o.height&&n>o.left&&n<o.left+o.width:!1}}class CurveEditor{constructor(t){h(this,"points");h(this,"selected");h(this,"nearest");h(this,"size");h(this,"must_update");h(this,"margin");h(this,"_nearest");this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}static sampleCurve(t,i){if(i){for(let n=0;n<i.length-1;++n){const s=i[n],o=i[n+1];if(o[0]<t)continue;const r=o[0]-s[0];if(Math.abs(r)<1e-5)return s[1];const a=(t-s[0])/r;return s[1]*(1-a)+o[1]*a}return 0}}draw(t,i,n,s,o,r=!1){const a=this.points;if(!a)return;this.size=i;const l=i[0]-this.margin*2,u=i[1]-this.margin*2;o=o||"#666",t.save(),t.translate(this.margin,this.margin),s&&(t.fillStyle="#111",t.fillRect(0,0,l,u),t.fillStyle="#222",t.fillRect(l*.5,0,1,u),t.strokeStyle="#333",t.strokeRect(0,0,l,u)),t.strokeStyle=o,r&&(t.globalAlpha=.5),t.beginPath();for(const c of a)t.lineTo(c[0]*l,(1-c[1])*u);if(t.stroke(),t.globalAlpha=1,!r)for(const[c,p]of a.entries())t.fillStyle=this.selected==c?"#FFF":this.nearest==c?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*l,(1-p[1])*u,2,0,Math.PI*2),t.fill();t.restore()}onMouseDown(t,i){const n=this.points;if(!n||t[1]<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const s=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=t[0]-this.margin,a=t[1]-this.margin,l=[r,a],u=30/i.ds.scale;if(this.selected=this.getCloserPoint(l,u),this.selected==-1){const c=[r/s,1-a/o];n.push(c),n.sort(function(p,f){return p[0]-f[0]}),this.selected=n.indexOf(c),this.must_update=!0}if(this.selected!=-1)return!0}onMouseMove(t,i){const n=this.points;if(!n)return;const s=this.selected;if(s<0)return;if(this.size==null)throw new Error("CurveEditor.size was null or undefined.");const o=(t[0]-this.margin)/(this.size[0]-this.margin*2),r=(t[1]-this.margin)/(this.size[1]-this.margin*2),a=[t[0]-this.margin,t[1]-this.margin],l=30/i.ds.scale;this._nearest=this.getCloserPoint(a,l);const u=n[s];if(u){const c=s==0||s==n.length-1;if(!c&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)){n.splice(s,1),this.selected=-1;return}c?u[0]=s==0?0:1:u[0]=clamp(o,0,1),u[1]=1-clamp(r,0,1),n.sort(function(p,f){return p[0]-f[0]}),this.selected=n.indexOf(u),this.must_update=!0}}onMouseUp(){return this.selected=-1,!1}getCloserPoint(t,i){const n=this.points;if(!n)return-1;if(i=i||30,this.size==null)throw new Error("CurveEditor.size was null or undefined.");const s=this.size[0]-this.margin*2,o=this.size[1]-this.margin*2,r=n.length,a=[0,0];let l=1e6,u=-1;for(let c=0;c<r;++c){const p=n[c];a[0]=p[0]*s,a[1]=(1-p[1])*o;const f=distance(t,a);f>l||f>i||(u=c,l=f)}return u}}class LiteGraphGlobal{constructor(){h(this,"SlotShape",SlotShape);h(this,"SlotDirection",SlotDirection);h(this,"SlotType",SlotType);h(this,"LabelPosition",LabelPosition);h(this,"VERSION",.4);h(this,"CANVAS_GRID_SIZE",10);h(this,"NODE_TITLE_HEIGHT",30);h(this,"NODE_TITLE_TEXT_Y",20);h(this,"NODE_SLOT_HEIGHT",20);h(this,"NODE_WIDGET_HEIGHT",20);h(this,"NODE_WIDTH",140);h(this,"NODE_MIN_WIDTH",50);h(this,"NODE_COLLAPSED_RADIUS",10);h(this,"NODE_COLLAPSED_WIDTH",80);h(this,"NODE_TITLE_COLOR","#999");h(this,"NODE_SELECTED_TITLE_COLOR","#FFF");h(this,"NODE_TEXT_SIZE",14);h(this,"NODE_TEXT_COLOR","#AAA");h(this,"NODE_TEXT_HIGHLIGHT_COLOR","#EEE");h(this,"NODE_SUBTEXT_SIZE",12);h(this,"NODE_DEFAULT_COLOR","#333");h(this,"NODE_DEFAULT_BGCOLOR","#353535");h(this,"NODE_DEFAULT_BOXCOLOR","#666");h(this,"NODE_DEFAULT_SHAPE",RenderShape.ROUND);h(this,"NODE_BOX_OUTLINE_COLOR","#FFF");h(this,"NODE_ERROR_COLOUR","#E00");h(this,"NODE_FONT","Arial");h(this,"DEFAULT_FONT","Arial");h(this,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)");h(this,"DEFAULT_GROUP_FONT",24);h(this,"DEFAULT_GROUP_FONT_SIZE");h(this,"GROUP_FONT","Arial");h(this,"WIDGET_BGCOLOR","#222");h(this,"WIDGET_OUTLINE_COLOR","#666");h(this,"WIDGET_ADVANCED_OUTLINE_COLOR","rgba(56, 139, 253, 0.8)");h(this,"WIDGET_TEXT_COLOR","#DDD");h(this,"WIDGET_SECONDARY_TEXT_COLOR","#999");h(this,"WIDGET_DISABLED_TEXT_COLOR","#666");h(this,"LINK_COLOR","#9A9");h(this,"EVENT_LINK_COLOR","#A86");h(this,"CONNECTING_LINK_COLOR","#AFA");h(this,"MAX_NUMBER_OF_NODES",1e4);h(this,"DEFAULT_POSITION",[100,100]);h(this,"VALID_SHAPES",["default","box","round","card"]);h(this,"ROUND_RADIUS",8);h(this,"BOX_SHAPE",RenderShape.BOX);h(this,"ROUND_SHAPE",RenderShape.ROUND);h(this,"CIRCLE_SHAPE",RenderShape.CIRCLE);h(this,"CARD_SHAPE",RenderShape.CARD);h(this,"ARROW_SHAPE",RenderShape.ARROW);h(this,"GRID_SHAPE",RenderShape.GRID);h(this,"INPUT",NodeSlotType.INPUT);h(this,"OUTPUT",NodeSlotType.OUTPUT);h(this,"EVENT",-1);h(this,"ACTION",-1);h(this,"NODE_MODES",["Always","On Event","Never","On Trigger"]);h(this,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]);h(this,"ALWAYS",LGraphEventMode.ALWAYS);h(this,"ON_EVENT",LGraphEventMode.ON_EVENT);h(this,"NEVER",LGraphEventMode.NEVER);h(this,"ON_TRIGGER",LGraphEventMode.ON_TRIGGER);h(this,"UP",LinkDirection.UP);h(this,"DOWN",LinkDirection.DOWN);h(this,"LEFT",LinkDirection.LEFT);h(this,"RIGHT",LinkDirection.RIGHT);h(this,"CENTER",LinkDirection.CENTER);h(this,"LINK_RENDER_MODES",["Straight","Linear","Spline"]);h(this,"HIDDEN_LINK",LinkRenderType.HIDDEN_LINK);h(this,"STRAIGHT_LINK",LinkRenderType.STRAIGHT_LINK);h(this,"LINEAR_LINK",LinkRenderType.LINEAR_LINK);h(this,"SPLINE_LINK",LinkRenderType.SPLINE_LINK);h(this,"NORMAL_TITLE",TitleMode.NORMAL_TITLE);h(this,"NO_TITLE",TitleMode.NO_TITLE);h(this,"TRANSPARENT_TITLE",TitleMode.TRANSPARENT_TITLE);h(this,"AUTOHIDE_TITLE",TitleMode.AUTOHIDE_TITLE);h(this,"VERTICAL_LAYOUT","vertical");h(this,"proxy",null);h(this,"node_images_path","");h(this,"debug",!1);h(this,"catch_exceptions",!0);h(this,"throw_errors",!0);h(this,"allow_scripts",!1);h(this,"registered_node_types",{});h(this,"node_types_by_file_extension",{});h(this,"Nodes",{});h(this,"Globals",{});h(this,"searchbox_extras",{});h(this,"node_box_coloured_when_on",!1);h(this,"node_box_coloured_by_mode",!1);h(this,"dialog_close_on_mouse_leave",!1);h(this,"dialog_close_on_mouse_leave_delay",500);h(this,"shift_click_do_break_link_from",!1);h(this,"click_do_break_link_to",!1);h(this,"ctrl_alt_click_do_break_link",!0);h(this,"snaps_for_comfy",!0);h(this,"snap_highlights_node",!0);h(this,"alwaysSnapToGrid");h(this,"snapToGrid");h(this,"search_hide_on_mouse_leave",!0);h(this,"search_filter_enabled",!1);h(this,"search_show_all_on_open",!0);h(this,"auto_load_slot_types",!1);h(this,"registered_slot_in_types",{});h(this,"registered_slot_out_types",{});h(this,"slot_types_in",[]);h(this,"slot_types_out",[]);h(this,"slot_types_default_in",{});h(this,"slot_types_default_out",{});h(this,"alt_drag_do_clone_nodes",!1);h(this,"do_add_triggers_slots",!1);h(this,"allow_multi_output_for_events",!0);h(this,"middle_click_slot_add_default_node",!1);h(this,"release_link_on_empty_shows_menu",!1);h(this,"pointerevents_method","pointer");h(this,"ctrl_shift_v_paste_connect_unselected_outputs",!0);h(this,"use_uuids",!1);h(this,"highlight_selected_group",!0);h(this,"context_menu_scaling",!1);h(this,"alwaysRepeatWarnings",!1);h(this,"onDeprecationWarning",[console.warn]);h(this,"macTrackpadGestures",!1);h(this,"macGesturesRequireMac",!0);h(this,"canvasNavigationMode","legacy");h(this,"truncateWidgetTextEvenly",!1);h(this,"truncateWidgetValuesFirst",!1);h(this,"saveViewportWithGraph",!0);h(this,"LGraph",LGraph);h(this,"LLink",LLink);h(this,"LGraphNode",LGraphNode);h(this,"LGraphGroup",LGraphGroup);h(this,"DragAndScale",DragAndScale);h(this,"LGraphCanvas",LGraphCanvas);h(this,"ContextMenu",ContextMenu);h(this,"CurveEditor",CurveEditor);h(this,"Reroute",Reroute);h(this,"Classes",{get SubgraphSlot(){return SubgraphSlot},get SubgraphIONodeBase(){return SubgraphIONodeBase},get Rectangle(){return Rectangle},get InputIndicators(){return InputIndicators}});h(this,"uuidv4",createUuidv4);h(this,"distance",distance);h(this,"isInsideRectangle",isInsideRectangle);h(this,"overlapBounding",overlapBounding);Object.defineProperty(this,"Classes",{writable:!1})}registerNodeType(t,i){var r,a,l;if(!i.prototype)throw"Cannot register a simple object, it must be a class with a prototype";i.type=t,this.debug&&console.log("Node registered:",t);const n=i.name,s=t.lastIndexOf("/");i.category=t.substring(0,s),i.title||(i.title=n);for(const u in LGraphNode.prototype)(r=i.prototype)[u]||(r[u]=LGraphNode.prototype[u]);const o=this.registered_node_types[t];o&&this.debug&&console.log("replacing node type:",t),this.registered_node_types[t]=i,i.constructor.name&&(this.Nodes[n]=i),(a=this.onNodeTypeRegistered)==null||a.call(this,t,i),o&&((l=this.onNodeTypeReplaced)==null||l.call(this,t,i,o)),i.prototype.onPropertyChange&&console.warn(`LiteGraph node class ${t} has onPropertyChange method, it must be called onPropertyChanged with d at the end`),this.auto_load_slot_types&&new i(i.title||"tmpnode")}unregisterNodeType(t){const i=typeof t=="string"?this.registered_node_types[t]:t;if(!i)throw`node type not found: ${String(t)}`;delete this.registered_node_types[String(i.type)];const n=i.constructor.name;n&&delete this.Nodes[n]}registerNodeAndSlotType(t,i,n){n||(n=!1);const o=(typeof t=="string"&&this.registered_node_types[t]!=="anonymous"?this.registered_node_types[t]:t).constructor.type;let r=[];typeof i=="string"?r=i.split(","):i==this.EVENT||i==this.ACTION?r=["_event_"]:r=["*"];for(let a of r){a===""&&(a="*");const l=n?this.registered_slot_out_types:this.registered_slot_in_types;l[a]??(l[a]={nodes:[]});const{nodes:u}=l[a];u.includes(o)||u.push(o);const c=n?this.slot_types_out:this.slot_types_in,p=a.toLowerCase();c.includes(p)||(c.push(p),c.sort())}}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}createNode(t,i,n){var r;const s=this.registered_node_types[t];if(!s)return this.debug&&console.log(`GraphNode type "${t}" not registered.`),null;i=i||s.title||t;let o=null;if(this.catch_exceptions)try{o=new s(i)}catch(a){return console.error(a),null}else o=new s(i);if(o.type=t,!o.title&&i&&(o.title=i),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=[this.DEFAULT_POSITION[0],this.DEFAULT_POSITION[1]]),o.mode||(o.mode=LGraphEventMode.ALWAYS),n)for(const a in n)o[a]=n[a];return(r=o.onNodeCreated)==null||r.call(o),o}getNodeType(t){return this.registered_node_types[t]}getNodeTypesInCategory(t,i){const n=[];for(const s in this.registered_node_types){const o=this.registered_node_types[s];o.filter==i&&(t==""?o.category==null&&n.push(o):o.category==t&&n.push(o))}return n}getNodeTypesCategories(t){const i={"":1};for(const s in this.registered_node_types){const o=this.registered_node_types[s];if(o.category&&!o.skip_list){if(o.filter!=t)continue;i[o.category]=1}}const n=[];for(const s in i)n.push(s);return n}reloadNodes(t){const i=document.getElementsByTagName("script"),n=[];for(const o of i)n.push(o);const s=document.getElementsByTagName("head")[0];t=document.location.href+t;for(const o of n){const r=o.src;if(!(!r||r.substr(0,t.length)!=t))try{this.debug&&console.log("Reloading:",r);const a=document.createElement("script");a.type="text/javascript",a.src=r,s.append(a),o.remove()}catch(a){if(this.throw_errors)throw a;this.debug&&console.log("Error while reloading",r)}}this.debug&&console.log("Nodes reloaded")}cloneObject(t,i){if(t==null)return null;const n=JSON.parse(JSON.stringify(t));if(!i)return n;for(const s in n)i[s]=n[s];return i}isValidConnection(t,i){if((t==""||t==="*")&&(t=0),(i==""||i==="*")&&(i=0),!t||!i||t==i||t==this.EVENT&&i==this.ACTION)return!0;if(t=String(t),i=String(i),t=t.toLowerCase(),i=i.toLowerCase(),!t.includes(",")&&!i.includes(","))return t==i;const n=t.split(","),s=i.split(",");for(const o of n)for(const r of s)if(this.isValidConnection(o,r))return!0;return!1}getParameterNames(t){return String(t).replaceAll(/\/\/.*$/gm,"").replaceAll(/\s+/g,"").replaceAll(/\/\*[^*/]*\*\//g,"").split("){",1)[0].replace(/^[^(]*\(/,"").replaceAll(/=[^,]+/g,"").split(",").filter(Boolean)}pointerListenerAdd(t,i,n,s=!1){if(!t||!t.addEventListener||!i||typeof n!="function")return;let o=this.pointerevents_method,r=i;if(o=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log(`Converting pointer[${r}] : down move up cancel enter TO touchstart touchmove touchend, etc ..`),r){case"down":{o="touch",r="start";break}case"move":{o="touch";break}case"up":{o="touch",r="end";break}case"cancel":{o="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn(`PointerEvent not available in this browser ? The event ${r} would not be called`)}switch(r){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+r,n,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(o!="mouse")return t.addEventListener(o+r,n,s);default:return t.addEventListener(r,n,s)}}pointerListenerRemove(t,i,n,s=!1){if(!(!t||!t.removeEventListener||!i||typeof n!="function"))switch(i){case"down":case"up":case"move":case"over":case"out":case"enter":(this.pointerevents_method=="pointer"||this.pointerevents_method=="mouse")&&t.removeEventListener(this.pointerevents_method+i,n,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(this.pointerevents_method=="pointer")return t.removeEventListener(this.pointerevents_method+i,n,s);default:return t.removeEventListener(i,n,s)}}getTime(){return performance.now()}colorToString(t){return`rgba(${Math.round(t[0]*255).toFixed()},${Math.round(t[1]*255).toFixed()},${Math.round(t[2]*255).toFixed()},${t.length==4?t[3].toFixed(2):"1.0"})`}growBounding(t,i,n){i<t[0]?t[0]=i:i>t[2]&&(t[2]=i),n<t[1]?t[1]=n:n>t[3]&&(t[3]=n)}isInsideBounding(t,i){return!(t[0]<i[0][0]||t[1]<i[0][1]||t[0]>i[1][0]||t[1]>i[1][1])}hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();const i="0123456789ABCDEF",n=new Array(3);let s=0,o,r;for(let a=0;a<6;a+=2)o=i.indexOf(t.charAt(a)),r=i.indexOf(t.charAt(a+1)),n[s]=o*16+r,s++;return n}num2hex(t){const i="0123456789ABCDEF";let n="#",s,o;for(let r=0;r<3;r++)s=t[r]/16,o=t[r]%16,n+=i.charAt(s)+i.charAt(o);return n}closeAllContextMenus(t=window){const i=[...t.document.querySelectorAll(".litecontextmenu")];if(i.length)for(const n of i)"close"in n&&typeof n.close=="function"?n.close():n.remove()}extendClass(t,i){for(const n in i)t.hasOwnProperty(n)||(t[n]=i[n]);if(i.prototype)for(const n in i.prototype)i.prototype.hasOwnProperty(n)&&(t.prototype.hasOwnProperty(n)||(i.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,i.prototype.__lookupGetter__(n)):t.prototype[n]=i.prototype[n],i.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,i.prototype.__lookupSetter__(n))))}}Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("Symbol.asyncDispose"));function loadPolyfills(){typeof window<"u"&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(d,t,i,n,s,o){let r=0,a=0,l=0,u=0;if(s===0){this.rect(d,t,i,n);return}if(o===void 0&&(o=s),Array.isArray(s))if(s.length==1)r=a=l=u=s[0];else if(s.length==2)r=u=s[0],a=l=s[1];else if(s.length==4)r=s[0],a=s[1],l=s[2],u=s[3];else return;else{r=s||0,a=s||0;const c=!Array.isArray(o)&&o?o:0;l=c,u=c}this.moveTo(d+r,t),this.lineTo(d+i-a,t),this.quadraticCurveTo(d+i,t,d+i,t+a),this.lineTo(d+i,t+n-u),this.quadraticCurveTo(d+i,t+n,d+i-u,t+n),this.lineTo(d+u,t+n),this.quadraticCurveTo(d,t+n,d,t+n-l),this.lineTo(d,t+l),this.quadraticCurveTo(d,t,d+r,t)}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setTimeout(d,1e3/60)})}class InvalidLinkError extends Error{constructor(t="Attempted to access a link that was invalid.",i){super(t,{cause:i}),this.name="InvalidLinkError"}}class RecursionError extends Error{constructor(t){super(t),this.name="RecursionError"}}class SlotIndexError extends Error{constructor(t="Attempted to access a slot that was out of bounds.",i){super(t,{cause:i}),this.name="SlotIndexError"}}class ExecutableNodeDTO{constructor(t,i,n,s){W(this,Re);h(this,"graph");h(this,"inputs");W(this,fe);if(this.node=t,this.subgraphNodePath=i,this.nodesByExecutionId=n,this.subgraphNode=s,!t.graph)throw new NullGraphError;H(this,fe,[...this.subgraphNodePath,this.node.id].join(":")),this.graph=t.graph,this.inputs=this.node.inputs.map(o=>({linkId:o.link,name:o.name,type:o.type})),this.node.applyToGraph&&(this.applyToGraph=(...o)=>{var r,a;return(a=(r=this.node).applyToGraph)==null?void 0:a.call(r,...o)})}get id(){return S(this,fe)}get type(){return this.node.type}get title(){return this.node.title}get mode(){return this.node.mode}get comfyClass(){return this.node.comfyClass}get isVirtualNode(){return this.node.isVirtualNode}get widgets(){return this.node.widgets}get subgraphId(){var t;return(t=this.subgraphNode)==null?void 0:t.subgraph.id}getInnerNodes(){return this.node.isSubgraphNode()?this.node.getInnerNodes(this.nodesByExecutionId,this.subgraphNodePath):[this]}resolveInput(t,i=new Set){var c;const n=`${(c=this.subgraphNode)==null?void 0:c.subgraph.id}:${this.node.id}[I]${t}`;if(i.has(n)){const p=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,f=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving input ${t} of node ${p}${f}. This creates an infinite loop in link resolution. UniqueID: [${n}]`)}i.add(n);const s=this.inputs.at(t);if(!s)throw new SlotIndexError(`No input found for flattened id [${this.id}] slot [${t}]`);if(s.linkId==null)return;const o=this.graph.getLink(s.linkId);if(!o)throw new InvalidLinkError(`No link found in parent graph for id [${this.id}] slot [${t}] ${s.name}`);const{subgraphNode:r}=this;if(r&&o.originIsIoNode){const p=r.inputs.at(o.origin_slot);if(!p)throw new SlotIndexError(`No input found for slot [${o.origin_slot}] ${s.name}`);const f=p.link;if(f==null){const y=r.getWidgetFromSlot(p);return y?{node:this,origin_id:this.id,origin_slot:-1,widgetInfo:{value:y.value}}:void 0}const g=r.graph.getLink(f);if(!g)throw new InvalidLinkError(`No outer link found for slot [${o.origin_slot}] ${s.name}`);const m=this.subgraphNodePath.join(":"),_=this.nodesByExecutionId.get(m);if(!_)throw new Error(`No subgraph node DTO found for id [${m}]`);return _.resolveInput(g.target_slot,i)}const a=this.graph.getNodeById(o.origin_id);if(!a)throw new InvalidLinkError(`No input node found for id [${this.id}] slot [${t}] ${s.name}`);const l=[...this.subgraphNodePath,a.id].join(":"),u=this.nodesByExecutionId.get(l);if(!u)throw new Error(`No output node DTO found for id [${l}]`);return u.resolveOutput(o.origin_slot,s.type,i)}resolveOutput(t,i,n){var r;const s=`${(r=this.subgraphNode)==null?void 0:r.subgraph.id}:${this.node.id}[O]${t}`;if(n.has(s)){const a=`${this.node.id}${this.node.title?` (${this.node.title})`:""}`,l=this.subgraphNodePath.length>0?` at path ${this.subgraphNodePath.join(":")}`:"";throw new RecursionError(`Circular reference detected while resolving output ${t} of node ${a}${l}. This creates an infinite loop in link resolution. UniqueID: [${s}]`)}if(n.add(s),this.mode===LGraphEventMode.BYPASS){const{inputs:a}=this,l=Object.keys(a).map(Number),c=[t,...l].find(p=>{var f;return((f=a[p])==null?void 0:f.type)===i});if(c===void 0){console.debug(`[ExecutableNodeDTO.resolveOutput] No input types match type [${i}] for id [${this.id}] slot [${t}]`,this);return}return this.resolveInput(c,n)}const{node:o}=this;if(o.isSubgraphNode())return C(this,Re,Ri).call(this,t,i,n);if(o.isVirtualNode){if(this.inputs.at(t))return this.resolveInput(t,n);const a=this.node.getInputLink(t);if(a){const l=this.graph.getNodeById(a.origin_id);if(!l)throw new InvalidLinkError(`Virtual node failed to resolve parent [${this.id}] slot [${t}]`);const u=[...this.subgraphNodePath,l.id].join(":"),c=this.nodesByExecutionId.get(u);if(!c)throw new Error(`No output node DTO found for id [${l.id}]`);return c.resolveOutput(a.origin_slot,i,n)}return}return{node:this,origin_id:this.id,origin_slot:t}}}fe=new WeakMap,Re=new WeakSet,Ri=function(t,i,n){const{node:s}=this,o=s.outputs.at(t);if(!o)throw new SlotIndexError(`No output found for flattened id [${this.id}] slot [${t}]`);if(!s.isSubgraphNode())throw new TypeError(`Node is not a subgraph node: ${s.id}`);const r=s.resolveSubgraphOutputLink(t);if(!r)return;const a=r.outputNode;if(!a)throw new Error(`No output node found for id [${this.id}] slot [${t}] ${o.name}`);const l=[...this.subgraphNodePath,s.id,a.id].join(":"),u=this.nodesByExecutionId.get(l);if(!u)throw new Error(`No inner node DTO found for id [${l}]`);return u.resolveOutput(r.link.origin_slot,i,n)};class SubgraphNode extends LGraphNode{constructor(i,n,s){super(n.name,n.id);W(this,wt);h(this,"type");h(this,"isVirtualNode",!0);h(this,"widgets",[]);W(this,ge,new AbortController);this.graph=i,this.subgraph=n;const o=this.subgraph.events,{signal:r}=S(this,ge);o.addEventListener("input-added",a=>{const l=a.detail.input,{name:u,type:c}=l;if(this.inputs.some(f=>f.name==u))return;const p=this.addInput(u,c);C(this,wt,Ze).call(this,l,p)},{signal:r}),o.addEventListener("removing-input",a=>{const l=a.detail.input._widget;l&&this.ensureWidgetRemoved(l),this.removeInput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("output-added",a=>{const{name:l,type:u}=a.detail.output;this.addOutput(l,u)},{signal:r}),o.addEventListener("removing-output",a=>{this.removeOutput(a.detail.index),this.setDirtyCanvas(!0,!0)},{signal:r}),o.addEventListener("renaming-input",a=>{const{index:l,newName:u}=a.detail,c=this.inputs.at(l);if(!c)throw new Error("Subgraph input not found");c.label=u},{signal:r}),o.addEventListener("renaming-output",a=>{const{index:l,newName:u}=a.detail,c=this.outputs.at(l);if(!c)throw new Error("Subgraph output not found");c.label=u},{signal:r}),this.type=n.id,this.configure(s),this.addTitleButton({name:"enter_subgraph",text:"î¤»",yOffset:0,xOffset:-10,fontSize:16})}get rootGraph(){return this.graph.rootGraph}get displayType(){return"Subgraph node"}isSubgraphNode(){return!0}onTitleButtonClick(i,n){i.name==="enter_subgraph"?n.openSubgraph(this.subgraph):super.onTitleButtonClick(i,n)}configure(i){var n;for(const s of this.inputs)(n=s._listenerController)==null||n.abort();this.inputs.length=0,this.inputs.push(...this.subgraph.inputNode.slots.map(s=>new NodeInputSlot({name:s.name,localized_name:s.localized_name,label:s.label,type:s.type,link:null},this))),this.outputs.length=0,this.outputs.push(...this.subgraph.outputNode.slots.map(s=>new NodeOutputSlot({name:s.name,localized_name:s.localized_name,label:s.label,type:s.type,links:null},this))),super.configure(i)}_internalConfigureAfterSlots(){this.widgets.length=0;for(const i of this.inputs){const n=this.subgraph.inputNode.slots.find(s=>s.name===i.name);if(!n)throw new Error(`[SubgraphNode.configure] No subgraph input found for input ${i.name}`);C(this,wt,Ze).call(this,n,i);for(const s of n.linkIds){const o=this.subgraph.getLink(s);if(!o){console.warn(`[SubgraphNode.configure] No link found for link ID ${s}`,this);continue}const r=o.resolve(this.subgraph);if(!r.input||!r.inputNode){console.warn("Invalid resolved link",r,this);continue}const a=r.inputNode.getWidgetFromSlot(r.input);if(a){C(this,wt,Je).call(this,n,i,a);break}}}}addInput(i,n,s={}){return super.addInput(i,n,s)}getInputLink(i){const n=this.subgraph.outputNode.slots[i].getLinks().at(0);if(!n)return console.warn(`SubgraphNode.getInputLink: no inner link found for slot ${i}`),null;const s=LLink.create(n);return s.origin_id=`${this.id}:${n.origin_id}`,s.origin_slot=n.origin_slot,s}resolveSubgraphInputLinks(i){const n=this.subgraph.inputNode.slots[i],s=n.getLinks();return s.length===0?(console.debug(`[SubgraphNode.resolveSubgraphInputLinks] No inner links found for input slot [${i}] ${n.name}`,this),[]):s.map(o=>o.resolve(this.subgraph))}resolveSubgraphOutputLink(i){const n=this.subgraph.outputNode.slots[i],s=n.getLinks().at(0);if(s)return s.resolve(this.subgraph);console.debug(`[SubgraphNode.resolveSubgraphOutputLink] No inner link found for output slot [${i}] ${n.name}`,this)}getInnerNodes(i,n=[],s=[],o=new Set){if(o.has(this)){const u=`${this.id}${this.title?` (${this.title})`:""}`,c=`'${this.subgraph.name||"Unnamed Subgraph"}'`,p=n.length;throw new RecursionError(`Circular reference detected at depth ${p} in node ${u} of subgraph ${c}. This creates an infinite loop in the subgraph hierarchy.`)}o.add(this);const r=[...n,this.id],a=this.graph.rootGraph.resolveSubgraphIdPath(n).at(-1),l=new ExecutableNodeDTO(this,n,i,a);i.set(l.id,l);for(const u of this.subgraph.nodes)if("getInnerNodes"in u)u.getInnerNodes(i,r,s,new Set(o));else{const c=new ExecutableNodeDTO(u,r,i,this);i.set(c.id,c),s.push(c)}return s}removeWidgetByName(i){const n=this.widgets.find(s=>s.name===i);n&&this.subgraph.events.dispatch("widget-demoted",{widget:n,subgraphNode:this}),super.removeWidgetByName(i)}ensureWidgetRemoved(i){this.widgets.includes(i)&&this.subgraph.events.dispatch("widget-demoted",{widget:i,subgraphNode:this}),super.ensureWidgetRemoved(i)}onRemoved(){var i;S(this,ge).abort();for(const n of this.widgets)this.subgraph.events.dispatch("widget-demoted",{widget:n,subgraphNode:this});for(const n of this.inputs)(i=n._listenerController)==null||i.abort()}}ge=new WeakMap,wt=new WeakSet,Ze=function(i,n){var o;(o=n._listenerController)==null||o.abort(),n._listenerController=new AbortController;const{signal:s}=n._listenerController;i.events.addEventListener("input-connected",()=>{if(n._widget)return;const r=i._widget;r&&C(this,wt,Je).call(this,i,n,r)},{signal:s}),i.events.addEventListener("input-disconnected",()=>{i.getConnectedWidgets().length>0||(this.removeWidgetByName(n.name),delete n.pos,delete n.widget,n._widget=void 0)},{signal:s})},Je=function(i,n,s){const o=toConcreteWidget(s,this).createCopyForNode(this);Object.assign(o,{get name(){return i.name},set name(r){console.warn("Promoted widget: setting name is not allowed",this,r)},get localized_name(){return i.localized_name},set localized_name(r){console.warn("Promoted widget: setting localized_name is not allowed",this,r)},get label(){return i.label},set label(r){console.warn("Promoted widget: setting label is not allowed",this,r)},get tooltip(){return s.tooltip},set tooltip(r){console.warn("Promoted widget: setting tooltip is not allowed",this,r)}}),this.widgets.push(o),this.subgraph.events.dispatch("widget-promoted",{widget:o,subgraphNode:this}),n.widget={name:i.name},n._widget=o};const LiteGraph=new LiteGraphGlobal;loadPolyfills();const litegraphCss=".lgraphcanvas{user-select:none;-moz-user-select:none;-webkit-user-select:none;outline:none;font-family:Tahoma,sans-serif}.lgraphcanvas *{box-sizing:border-box}.litegraph.litecontextmenu{font-family:Tahoma,sans-serif;position:fixed;top:100px;left:100px;min-width:100px;color:#aaf;padding:0;box-shadow:0 0 10px #000!important;background-color:#2e2e2e!important;z-index:10;max-height:-webkit-fill-available;overflow-y:auto}@supports not (max-height: -webkit-fill-available){.litegraph.litecontextmenu{max-height:80vh;overflow-y:scroll}}.litegraph.litecontextmenu.dark{background-color:#000!important}.litegraph.litecontextmenu .litemenu-title img{margin-top:2px;margin-left:2px;margin-right:4px}.litegraph.litecontextmenu .litemenu-entry{margin:2px;padding:2px}.litegraph.litecontextmenu .litemenu-entry.submenu{background-color:#2e2e2e!important}.litegraph.litecontextmenu.dark .litemenu-entry.submenu{background-color:#000!important}.litegraph .litemenubar ul{font-family:Tahoma,sans-serif;margin:0;padding:0}.litegraph .litemenubar li{font-size:14px;color:#999;display:inline-block;min-width:50px;padding-left:10px;padding-right:10px;user-select:none;-moz-user-select:none;-webkit-user-select:none;cursor:pointer}.litegraph .litemenubar li:hover{background-color:#777;color:#eee}.litegraph .litegraph .litemenubar-panel{position:absolute;top:5px;left:5px;min-width:100px;background-color:#444;box-shadow:0 0 3px #000;padding:4px;border-bottom:2px solid #aaf;z-index:10}.litegraph .litemenu-entry,.litemenu-title{font-size:12px;color:#aaa;margin:2px;padding:0 0 0 2px;-moz-user-select:none;-webkit-user-select:none;user-select:none;cursor:pointer}.litegraph .litemenu-entry .icon{display:inline-block;width:12px;height:12px;margin:2px;vertical-align:top}.litegraph .litemenu-entry.checked .icon{background-color:#aaf}.litegraph .litemenu-entry .more{float:right;padding-right:5px}.litegraph .litemenu-entry.disabled{opacity:.5;cursor:default}.litegraph .litemenu-entry.separator{display:block;border-top:1px solid #333;border-bottom:1px solid #666;width:100%;height:0px;margin:3px 0 2px;background-color:transparent;padding:0!important;cursor:default!important}.litegraph .litemenu-entry.has_submenu{border-right:2px solid cyan}.litegraph .litemenu-title{color:#dde;background-color:#111;margin:0;padding:2px;cursor:default}.litegraph .litemenu-entry:hover:not(.disabled):not(.separator){background-color:#444!important;color:#eee;transition:all .2s}.litegraph .litemenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.litegraph .litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.litegraph.litesearchbox{font-family:Tahoma,sans-serif;position:absolute;background-color:#00000080;padding-top:4px}.litegraph.litesearchbox input,.litegraph.litesearchbox select{margin-top:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;margin-right:5px;max-width:300px}.litegraph.litesearchbox .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.litegraph.litesearchbox .helper{overflow:auto;max-height:200px;margin-top:2px}.litegraph.lite-search-item{font-family:Tahoma,sans-serif;background-color:#00000080;color:#fff;padding-top:2px}.litegraph.lite-search-item.not_in_filter{color:#b99;font-style:italic}.litegraph.lite-search-item.generic_type{color:#999;font-style:italic}.litegraph.lite-search-item:hover,.litegraph.lite-search-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph.lite-search-item-type{display:inline-block;background:#0003;margin-left:5px;font-size:14px;padding:2px 5px;position:relative;top:-2px;opacity:.8;border-radius:4px}.litegraph .dialog{position:absolute;top:50%;left:50%;margin-top:-150px;margin-left:-200px;background-color:#2a2a2a;min-width:400px;min-height:200px;box-shadow:0 0 4px #111;border-radius:6px}.litegraph .dialog.settings{left:10px;top:10px;height:calc(100% - 20px);margin:auto;max-width:50%}.litegraph .dialog.centered{top:50px;left:50%;position:absolute;transform:translate(-50%);min-width:600px;min-height:300px;height:calc(100% - 100px);margin:auto}.litegraph .dialog .close{float:right;margin:4px 10px 4px 4px;cursor:pointer;font-size:1.4em}.litegraph .dialog .close:hover{color:#fff}.litegraph .dialog .dialog-header{color:#aaa;border-bottom:1px solid #161616}.litegraph .dialog .dialog-header{height:40px}.litegraph .dialog .dialog-footer{height:50px;padding:10px;margin:0;border-top:1px solid #1a1a1a}.litegraph .dialog .dialog-header .dialog-title{font:20px Arial;margin:4px;padding:4px 10px;display:inline-block}.litegraph .dialog .dialog-content,.litegraph .dialog .dialog-alt-content{height:calc(100% - 90px);width:100%;min-height:100px;display:inline-block;color:#aaa;overflow:auto}.litegraph .dialog .dialog-content h3{margin:10px}.litegraph .dialog .dialog-content .connections{flex-direction:row}.litegraph .dialog .dialog-content .connections .connections_side{width:calc(50% - 5px);min-height:100px;background-color:#000;display:flex}.litegraph .dialog .node_type{font-size:1.2em;display:block;margin:10px}.litegraph .dialog .node_desc{opacity:.5;display:block;margin:10px}.litegraph .dialog .separator{display:block;width:calc(100% - 4px);height:1px;border-top:1px solid #000;border-bottom:1px solid #333;margin:10px 2px;padding:0}.litegraph .dialog .property{margin-bottom:2px;padding:4px}.litegraph .dialog .property:hover{background:#545454}.litegraph .dialog .property_name{color:#737373;display:inline-block;text-align:left;vertical-align:top;width:160px;padding-left:4px;overflow:hidden;margin-right:6px}.litegraph .dialog .property:hover .property_name{color:#fff}.litegraph .dialog .property_value{display:inline-block;text-align:right;color:#aaa;background-color:#1a1a1a;max-width:calc(100% - 162px);min-width:200px;max-height:300px;min-height:20px;padding:4px 12px 4px 4px;overflow:hidden;cursor:pointer;border-radius:3px}.litegraph .dialog .property_value:hover{color:#fff}.litegraph .dialog .property.boolean .property_value{padding-right:30px;color:#a88}.litegraph .dialog .property.boolean.bool-on .property_name,.litegraph .dialog .property.boolean.bool-on .property_value{color:#8a8}.litegraph .dialog .btn{border:0;border-radius:4px;padding:4px 20px;margin-left:0;background-color:#060606;color:#8e8e8e}.litegraph .dialog .btn:hover{background-color:#111;color:#fff}.litegraph .dialog .btn.delete:hover{background-color:#f33;color:#000}.litegraph .bullet_icon{margin-left:10px;border-radius:10px;width:12px;height:12px;background-color:#666;display:inline-block;margin-top:2px;margin-right:4px;transition:background-color .1s ease 0s;-moz-transition:background-color .1s ease 0s}.litegraph .bullet_icon:hover{background-color:#698;cursor:pointer}.graphcontextmenu{padding:4px;min-width:100px}.graphcontextmenu-title{color:#dde;background-color:#222;margin:0;padding:2px;cursor:default}.graphmenu-entry{box-sizing:border-box;margin:2px;padding-left:20px;user-select:none;-moz-user-select:none;-webkit-user-select:none;transition:all linear .3s}.graphmenu-entry.event,.litemenu-entry.event{border-left:8px solid orange;padding-left:12px}.graphmenu-entry.disabled{opacity:.3}.graphmenu-entry.submenu{border-right:2px solid #eee}.graphmenu-entry:hover{background-color:#555}.graphmenu-entry.separator{background-color:#111;border-bottom:1px solid #666;height:1px;width:calc(100% - 20px);-moz-width:calc(100% - 20px);-webkit-width:calc(100% - 20px)}.graphmenu-entry .property_name{display:inline-block;text-align:left;min-width:80px;min-height:1.2em}.graphmenu-entry .property_value,.litemenu-entry .property_value{display:inline-block;background-color:#00000080;text-align:right;min-width:80px;min-height:1.2em;vertical-align:middle;padding-right:10px}.graphdialog{position:absolute;top:10px;left:10px;min-height:2em;background-color:#333;font-size:1.2em;box-shadow:0 0 10px #000!important;z-index:10}.graphdialog.rounded{border-radius:12px;padding-right:2px}.graphdialog .name{display:inline-block;min-width:60px;min-height:1.5em;padding-left:10px}.graphdialog input,.graphdialog textarea,.graphdialog select{margin:3px;min-width:60px;min-height:1.5em;background-color:#000;border:0;color:#fff;padding-left:10px;outline:none}.graphdialog textarea{min-height:150px}.graphdialog button{margin-top:3px;vertical-align:top;background-color:#999;border:0}.graphdialog button.rounded,.graphdialog input.rounded{border-radius:0 12px 12px 0}.graphdialog .helper{overflow:auto;max-height:200px}.graphdialog .help-item{padding-left:10px}.graphdialog .help-item:hover,.graphdialog .help-item.selected{cursor:pointer;background-color:#fff;color:#000}.litegraph .dialog{min-height:0}.litegraph .dialog .dialog-content{display:block}.litegraph .graphdialog{display:flex;align-items:center;border-radius:20px;padding:4px 10px;position:fixed}.litegraph .graphdialog .name{padding:0;min-height:0;font-size:16px;vertical-align:middle}.litegraph .graphdialog .value{font-size:16px;min-height:0;margin:0 10px;padding:2px 5px}.litegraph .graphdialog input[type=checkbox]{width:16px;height:16px}.litegraph .graphdialog button{padding:4px 18px;border-radius:20px;cursor:pointer}";let registered=!1,_datasetInfo={dataset_name:"",fields:[],label_fields:[],patches_fields:[],saved_views:[],label_classes:{},brain_runs:[],evaluations:[],zoo_models:[]};function setDatasetInfo(d){_datasetInfo=d}function populateNodeCombos(d){var i;if(!d.widgets)return;const t=d.type||"";for(const n of d.widgets){if(n.type!=="combo")continue;const s=n.name||"";s==="view_name"&&t.includes("Source/")?n.options.values=_datasetInfo.saved_views.length>0?_datasetInfo.saved_views:["(no saved views)"]:s==="field"&&t.includes("To Patches")?n.options.values=_datasetInfo.patches_fields.length>0?_datasetInfo.patches_fields:["(no patchable fields)"]:s==="field"&&(t.includes("Filter Labels")||t.includes("Match Labels")||t.includes("Map Labels"))?n.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:(s==="pred_field"||s==="label_field"||s==="predictions_field")&&t.includes("Brain/")?n.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:s==="model"&&t.includes("Model/")?n.options.values=_datasetInfo.zoo_models.length>0?_datasetInfo.zoo_models:["(no models available)"]:(s==="pred_field"||s==="gt_field")&&t.includes("Evaluation/")?n.options.values=_datasetInfo.label_fields.length>0?_datasetInfo.label_fields:["(no label fields)"]:s==="eval_key"&&t.includes("Manage Evaluation")?n.options.values=_datasetInfo.evaluations.length>0?_datasetInfo.evaluations:["(no evaluations)"]:s==="brain_key"&&t.includes("Manage Brain Run")?n.options.values=_datasetInfo.brain_runs.length>0?_datasetInfo.brain_runs:["(no brain runs)"]:s==="field"&&(n.options.values=_datasetInfo.fields.length>0?_datasetInfo.fields:["(no fields)"])}if(t.includes("Filter Labels")||t.includes("Match Labels")){const n=((i=d.properties)==null?void 0:i.field)||"",s=_datasetInfo.label_classes[n];s&&s.length>0&&(d.properties._available_classes=s)}}function updateAllComboWidgets(d){const t=d._nodes;if(t)for(const i of t)populateNodeCombos(i)}function hookNodeAdded(d){const t=d.onNodeAdded;d.onNodeAdded=function(i){populateNodeCombos(i),t&&t.call(this,i)}}function registerAllNodes(){if(registered)return;registered=!0;class d extends LGraphNode{constructor(){super(),this.title="Current Dataset",this.addOutput("view","FO_VIEW"),this.properties={},this.size=[240,60],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(L){var Y;if((Y=this.flags)!=null&&Y.collapsed)return;const j=_datasetInfo.dataset_name;if(j){L.font="bold 13px monospace",L.fillStyle="#FFFFFF",L.textAlign="center";const M=this.size[0]-20;let z=j;for(;L.measureText(z).width>M&&z.length>4;)z=z.slice(0,-2);z!==j&&(z+="â€¦"),L.fillText(z,this.size[0]/2,this.size[1]-12)}}}h(d,"title","Current Dataset"),h(d,"desc","Use the dataset currently loaded in the App"),LiteGraph.registerNodeType("FiftyComfy/Source/Current Dataset",d);class t extends LGraphNode{constructor(){super(),this.title="Load Saved View",this.addOutput("view","FO_VIEW"),this.addWidget("combo","view_name","",L=>{this.properties.view_name=L},{values:[]}),this.properties={view_name:""},this.size=[280,80],this.color="#FF7C1E",this.bgcolor="#994A12"}onDrawForeground(L){var Y;if((Y=this.flags)!=null&&Y.collapsed)return;const j=_datasetInfo.dataset_name;if(j){L.font="11px sans-serif",L.fillStyle="rgba(255,255,255,0.45)",L.textAlign="left";const M=this.size[0]-20,z="dataset: ";let Q=z+j;for(;L.measureText(Q).width>M&&Q.length>z.length+4;)Q=z+j.slice(0,Q.length-z.length-2);Q!==z+j&&(Q+="â€¦"),L.fillText(Q,10,this.size[1]-8)}}}h(t,"title","Load Saved View"),h(t,"desc","Load a saved view from the dataset"),LiteGraph.registerNodeType("FiftyComfy/Source/Load Saved View",t);class i extends LGraphNode{constructor(){super(),this.title="Match",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","expression","F('confidence') > 0.5",L=>{this.properties.expression=L}),this.properties={expression:"F('confidence') > 0.5"},this.size=[320,80],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(i,"title","Match"),h(i,"desc","Filter samples by a ViewExpression"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match",i);class n extends LGraphNode{constructor(){super(),this.title="Filter Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",L=>{this.properties.field=L},{values:[]}),this.addWidget("text","expression","F('label') == 'car'",L=>{this.properties.expression=L}),this.addWidget("toggle","only_matches",!0,L=>{this.properties.only_matches=L}),this.properties={field:"",expression:"F('label') == 'car'",only_matches:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(L){var M;if((M=this.flags)!=null&&M.collapsed)return;const j=this.properties.field,Y=j?_datasetInfo.label_classes[j]||[]:[];if(Y.length>0){L.font="10px sans-serif",L.fillStyle="rgba(255,255,255,0.4)",L.textAlign="left";const z=Y.slice(0,6).join(", ")+(Y.length>6?", ...":"");L.fillText("classes: "+z,8,this.size[1]-6)}}}h(n,"title","Filter Labels"),h(n,"desc","Filter detections/classifications within a label field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Filter Labels",n);class s extends LGraphNode{constructor(){super(),this.title="Match Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",L=>{this.properties.field=L},{values:[]}),this.addWidget("text","filter","F('label') == 'car'",L=>{this.properties.filter=L}),this.addWidget("toggle","bool",!0,L=>{this.properties.bool=L}),this.properties={field:"",filter:"F('label') == 'car'",bool:!0},this.size=[320,150],this.color="#5AA5F1",this.bgcolor="#365F8E"}onDrawForeground(L){var M;if((M=this.flags)!=null&&M.collapsed)return;const j=this.properties.field,Y=j?_datasetInfo.label_classes[j]||[]:[];if(Y.length>0){L.font="10px sans-serif",L.fillStyle="rgba(255,255,255,0.4)",L.textAlign="left";const z=Y.slice(0,6).join(", ")+(Y.length>6?", ...":"");L.fillText("classes: "+z,8,this.size[1]-6)}}}h(s,"title","Match Labels"),h(s,"desc","Match samples containing labels that satisfy a condition"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Labels",s);class o extends LGraphNode{constructor(){super(),this.title="Sort By",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",L=>{this.properties.field=L},{values:[]}),this.addWidget("toggle","reverse",!1,L=>{this.properties.reverse=L}),this.properties={field:"",reverse:!1},this.size=[280,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(o,"title","Sort By"),h(o,"desc","Sort samples by a field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By",o);class r extends LGraphNode{constructor(){super(),this.title="Sort By Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",L=>{this.properties.brain_key=L}),this.addWidget("number","k",25,L=>{this.properties.k=L},{min:1,max:1e5,step:1,precision:0}),this.addWidget("toggle","reverse",!1,L=>{this.properties.reverse=L}),this.properties={brain_key:"similarity",k:25,reverse:!1},this.size=[320,120],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(r,"title","Sort By Similarity"),h(r,"desc","Sort samples by similarity to a reference (requires similarity index)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Sort By Similarity",r);class a extends LGraphNode{constructor(){super(),this.title="Limit",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,L=>{this.properties.count=L},{min:1,max:1e5,step:10,precision:0}),this.properties={count:100},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(a,"title","Limit"),h(a,"desc","Limit number of samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Limit",a);class l extends LGraphNode{constructor(){super(),this.title="Match Tags",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","tags","",L=>{this.properties.tags=L}),this.properties={tags:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(l,"title","Match Tags"),h(l,"desc","Filter samples by tags (comma-separated)"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Match Tags",l);class u extends LGraphNode{constructor(){super(),this.title="Take",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","count",100,L=>{this.properties.count=L},{min:1,max:1e5,step:10,precision:0}),this.addWidget("number","seed",0,L=>{this.properties.seed=L||null},{min:0,max:99999,step:1,precision:0}),this.properties={count:100,seed:null},this.size=[240,90],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(u,"title","Take"),h(u,"desc","Randomly sample N samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Take",u);class c extends LGraphNode{constructor(){super(),this.title="Shuffle",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","seed",0,L=>{this.properties.seed=L||null},{min:0,max:99999,step:1,precision:0}),this.properties={seed:null},this.size=[220,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(c,"title","Shuffle"),h(c,"desc","Randomly shuffle samples"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Shuffle",c);class p extends LGraphNode{constructor(){super(),this.title="To Patches",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",L=>{this.properties.field=L},{values:[]}),this.properties={field:""},this.size=[280,70],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(p,"title","To Patches"),h(p,"desc","Create a patches view from a label list field"),LiteGraph.registerNodeType("FiftyComfy/View Stages/To Patches",p);class f extends LGraphNode{constructor(){super(),this.title="Map Labels",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","field","",L=>{this.properties.field=L},{values:[]}),this.addWidget("text","map",'{"old_label": "new_label"}',L=>{this.properties.map=L}),this.properties={field:"",map:'{"old_label": "new_label"}'},this.size=[340,100],this.color="#5AA5F1",this.bgcolor="#365F8E"}}h(f,"title","Map Labels"),h(f,"desc","Remap label values using a mapping dict"),LiteGraph.registerNodeType("FiftyComfy/View Stages/Map Labels",f);class g extends LGraphNode{constructor(){super(),this.title="Compute Embeddings",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","clip-vit-base32-torch",L=>{this.properties.model=L},{values:["clip-vit-base32-torch","clip-vit-large14-torch","open-clip-vit-b-32","dinov2-vits14-torch"]}),this.addWidget("text","embeddings_field","embeddings",L=>{this.properties.embeddings_field=L}),this.properties={model:"clip-vit-base32-torch",embeddings_field:"embeddings"},this.size=[340,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(g,"title","Compute Embeddings"),h(g,"desc","Compute embeddings using a zoo model"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Embeddings",g);class m extends LGraphNode{constructor(){super(),this.title="Compute Visualization",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","visualization",L=>{this.properties.brain_key=L}),this.addWidget("combo","method","umap",L=>{this.properties.method=L},{values:["umap","tsne","pca"]}),this.addWidget("combo","num_dims","2",L=>{this.properties.num_dims=parseInt(L)},{values:["2","3"]}),this.addWidget("text","embeddings","embeddings",L=>{this.properties.embeddings=L}),this.properties={brain_key:"visualization",method:"umap",num_dims:2,embeddings:"embeddings"},this.size=[340,150],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(m,"title","Compute Visualization"),h(m,"desc","Compute UMAP/t-SNE/PCA embedding visualization"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Visualization",m);class _ extends LGraphNode{constructor(){super(),this.title="Compute Similarity",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","brain_key","similarity",L=>{this.properties.brain_key=L}),this.addWidget("combo","backend","sklearn",L=>{this.properties.backend=L},{values:["sklearn","qdrant","pinecone","milvus","lancedb"]}),this.addWidget("text","embeddings","embeddings",L=>{this.properties.embeddings=L}),this.properties={brain_key:"similarity",backend:"sklearn",embeddings:"embeddings"},this.size=[340,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(_,"title","Compute Similarity"),h(_,"desc","Create a similarity index"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Similarity",_);class y extends LGraphNode{constructor(){super(),this.title="Compute Uniqueness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","uniqueness_field","uniqueness",L=>{this.properties.uniqueness_field=L}),this.addWidget("text","embeddings","embeddings",L=>{this.properties.embeddings=L}),this.properties={uniqueness_field:"uniqueness",embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(y,"title","Compute Uniqueness"),h(y,"desc","Compute uniqueness score per sample"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Uniqueness",y);class b extends LGraphNode{constructor(){super(),this.title="Find Exact Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.properties={},this.size=[280,50],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(b,"title","Find Exact Duplicates"),h(b,"desc","Find samples with identical media files"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Exact Duplicates",b);class k extends LGraphNode{constructor(){super(),this.title="Find Near Duplicates",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("number","threshold",.1,L=>{this.properties.threshold=L},{min:.001,max:1,step:.01,precision:3}),this.addWidget("text","embeddings","embeddings",L=>{this.properties.embeddings=L}),this.properties={threshold:.1,embeddings:"embeddings"},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(k,"title","Find Near Duplicates"),h(k,"desc","Find near-duplicate samples using embeddings"),LiteGraph.registerNodeType("FiftyComfy/Brain/Find Near Duplicates",k);class w extends LGraphNode{constructor(){super(),this.title="Compute Representativeness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","representativeness_field","representativeness",L=>{this.properties.representativeness_field=L}),this.addWidget("combo","method","cluster-center",L=>{this.properties.method=L},{values:["cluster-center","cluster-center-downweight"]}),this.addWidget("text","embeddings","embeddings",L=>{this.properties.embeddings=L}),this.properties={representativeness_field:"representativeness",method:"cluster-center",embeddings:"embeddings"},this.size=[360,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(w,"title","Compute Representativeness"),h(w,"desc","Score how representative each sample is of its neighborhood"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Representativeness",w);class T extends LGraphNode{constructor(){super(),this.title="Compute Mistakenness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",L=>{this.properties.pred_field=L},{values:[]}),this.addWidget("combo","label_field","",L=>{this.properties.label_field=L},{values:[]}),this.properties={pred_field:"",label_field:""},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(T,"title","Compute Mistakenness"),h(T,"desc","Estimate likelihood of annotation mistakes"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Mistakenness",T);class I extends LGraphNode{constructor(){super(),this.title="Compute Hardness",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","predictions_field","",L=>{this.properties.predictions_field=L},{values:[]}),this.properties={predictions_field:""},this.size=[320,70],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(I,"title","Compute Hardness"),h(I,"desc","Compute sample hardness (how difficult to classify)"),LiteGraph.registerNodeType("FiftyComfy/Brain/Compute Hardness",I);class E extends LGraphNode{constructor(){super(),this.title="Detect Leaky Splits",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("text","splits","train,test",L=>{this.properties.splits=L}),this.addWidget("number","threshold",.1,L=>{this.properties.threshold=L},{min:.001,max:1,step:.01,precision:3}),this.properties={splits:"train,test",threshold:.1},this.size=[320,100],this.color="#BC8CFF",this.bgcolor="#6E5299"}}h(E,"title","Detect Leaky Splits"),h(E,"desc","Find data leaks across train/test/val splits"),LiteGraph.registerNodeType("FiftyComfy/Brain/Detect Leaky Splits",E);class G extends LGraphNode{constructor(){super(),this.title="Manage Brain Run",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","brain_key","",L=>{this.properties.brain_key=L},{values:[]}),this.addWidget("combo","action","delete",L=>{this.properties.action=L},{values:["delete","rename"]}),this.addWidget("text","new_name","",L=>{this.properties.new_name=L}),this.properties={brain_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#BC8CFF",this.bgcolor="#6E5299"}onDrawForeground(L){var M;if((M=this.flags)!=null&&M.collapsed)return;const j=this.properties.action||"delete",Y=this.properties.brain_key||"";if(Y){L.font="10px sans-serif",L.fillStyle="rgba(255,255,255,0.4)",L.textAlign="left";const z=j==="rename"?`will rename "${Y}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${Y}"`,Q=this.size[0]-16;let q=z;for(;L.measureText(q).width>Q&&q.length>10;)q=q.slice(0,-2);q!==z&&(q+="â€¦"),L.fillText(q,8,this.size[1]-6)}}}h(G,"title","Manage Brain Run"),h(G,"desc","Rename or delete a brain run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Brain/Manage Brain Run",G);class R extends LGraphNode{constructor(){super(),this.title="Apply Zoo Model",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","model","",L=>{this.properties.model=L},{values:[]}),this.addWidget("text","label_field","predictions",L=>{this.properties.label_field=L}),this.addWidget("number","confidence_thresh",0,L=>{this.properties.confidence_thresh=L},{min:0,max:1,step:.05,precision:2}),this.addWidget("toggle","store_logits",!1,L=>{this.properties.store_logits=L}),this.properties={model:"",label_field:"predictions",confidence_thresh:0,store_logits:!1},this.size=[360,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(R,"title","Apply Zoo Model"),h(R,"desc","Apply a model from the FiftyOne Model Zoo"),LiteGraph.registerNodeType("FiftyComfy/Model/Apply Zoo Model",R);class N extends LGraphNode{constructor(){super(),this.title="Evaluate Detections",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",L=>{this.properties.pred_field=L},{values:[]}),this.addWidget("combo","gt_field","",L=>{this.properties.gt_field=L},{values:[]}),this.addWidget("text","eval_key","eval",L=>{this.properties.eval_key=L}),this.addWidget("combo","method","coco",L=>{this.properties.method=L},{values:["coco","open-images"]}),this.properties={pred_field:"",gt_field:"",eval_key:"eval",method:"coco"},this.size=[340,150],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(N,"title","Evaluate Detections"),h(N,"desc","Evaluate detection predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Detections",N);class D extends LGraphNode{constructor(){super(),this.title="Evaluate Classifications",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","pred_field","",L=>{this.properties.pred_field=L},{values:[]}),this.addWidget("combo","gt_field","",L=>{this.properties.gt_field=L},{values:[]}),this.addWidget("text","eval_key","eval",L=>{this.properties.eval_key=L}),this.properties={pred_field:"",gt_field:"",eval_key:"eval"},this.size=[340,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}}h(D,"title","Evaluate Classifications"),h(D,"desc","Evaluate classification predictions against ground truth"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Evaluate Classifications",D);class P extends LGraphNode{constructor(){super(),this.title="Manage Evaluation",this.addInput("view","FO_VIEW"),this.addOutput("view","FO_VIEW"),this.addWidget("combo","eval_key","",L=>{this.properties.eval_key=L},{values:[]}),this.addWidget("combo","action","delete",L=>{this.properties.action=L},{values:["delete","rename"]}),this.addWidget("text","new_name","",L=>{this.properties.new_name=L}),this.properties={eval_key:"",action:"delete",new_name:""},this.size=[320,130],this.color="#6AAF6C",this.bgcolor="#3F6840"}onDrawForeground(L){var M;if((M=this.flags)!=null&&M.collapsed)return;const j=this.properties.action||"delete",Y=this.properties.eval_key||"";if(Y){L.font="10px sans-serif",L.fillStyle="rgba(255,255,255,0.4)",L.textAlign="left";const z=j==="rename"?`will rename "${Y}" â†’ "${this.properties.new_name||"?"}"`:`will delete "${Y}"`,Q=this.size[0]-16;let q=z;for(;L.measureText(q).width>Q&&q.length>10;)q=q.slice(0,-2);q!==z&&(q+="â€¦"),L.fillText(q,8,this.size[1]-6)}}}h(P,"title","Manage Evaluation"),h(P,"desc","Rename or delete an evaluation run on the dataset"),LiteGraph.registerNodeType("FiftyComfy/Evaluation/Manage Evaluation",P);class B extends LGraphNode{constructor(){super(),this.title="Set App View",this.addInput("view","FO_VIEW"),this.properties={},this.size=[220,50],this.color="#FFED63",this.bgcolor="#998E3B"}}h(B,"title","Set App View"),h(B,"desc","Push the resulting view into the FiftyOne App"),LiteGraph.registerNodeType("FiftyComfy/Output/Set App View",B);class X extends LGraphNode{constructor(){super(),this.title="Save View",this.addInput("view","FO_VIEW"),this.addWidget("text","name","my_view",L=>{this.properties.name=L}),this.addWidget("text","description","",L=>{this.properties.description=L}),this.addWidget("toggle","overwrite",!1,L=>{this.properties.overwrite=L}),this.properties={name:"my_view",description:"",overwrite:!1},this.size=[300,120],this.color="#FFED63",this.bgcolor="#998E3B"}}h(X,"title","Save View"),h(X,"desc","Save the view as a named saved view"),LiteGraph.registerNodeType("FiftyComfy/Output/Save View",X),console.log("[FiftyComfy] Registered all node types")}const listeners={};function onEvent(d,t){return listeners[d]||(listeners[d]=[]),listeners[d].push(t),()=>{listeners[d]=listeners[d].filter(i=>i!==t)}}function emit(d,t){(listeners[d]||[]).forEach(i=>{try{i(t)}catch(n){console.error(`[FiftyComfy] Event listener error (${d}):`,n)}})}class NodeStatusUpdateOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"node_status_update",label:"Node Status Update",unlisted:!0})}async execute({params:t}){emit("node_status",t)}}class ExecutionCompleteOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"execution_complete",label:"Execution Complete",unlisted:!0})}async execute({params:t}){emit("execution_complete",t)}}class DatasetInfoLoadedOperator extends operators.Operator{get config(){return new operators.OperatorConfig({name:"dataset_info_loaded",label:"Dataset Info Loaded",unlisted:!0})}async execute({params:t}){console.log("[FiftyComfy] dataset_info_loaded received:",t),emit("dataset_info",t)}}const NS$1="@harpreetsahota/FiftyComfy",STORAGE_KEY="fiftycomfy_workflows";let _graph=null,_lgCanvas=null,_initialized=!1,_cssInjected=!1,_currentDatasetName="";function getSavedWorkflows(){try{const d=localStorage.getItem(STORAGE_KEY);return d?JSON.parse(d):{}}catch{return{}}}function saveWorkflow(d,t){const i=getSavedWorkflows();i[d]=t,localStorage.setItem(STORAGE_KEY,JSON.stringify(i))}function listWorkflowNames(){return Object.keys(getSavedWorkflows())}function loadWorkflow(d){return getSavedWorkflows()[d]||null}const TH=36,toolbarCss={position:"absolute",top:0,left:0,right:0,height:TH,zIndex:10,display:"flex",alignItems:"center",gap:6,padding:"0 8px",background:"rgba(20,20,20,0.85)",backdropFilter:"blur(4px)",borderBottom:"1px solid rgba(255,255,255,0.08)",fontFamily:"'Inter','Segoe UI',sans-serif"},btnCss={padding:"4px 10px",border:"1px solid rgba(255,255,255,0.15)",borderRadius:4,background:"rgba(255,255,255,0.08)",color:"#ccc",cursor:"pointer",fontSize:12,fontWeight:500,lineHeight:"20px"},btnRunCss={...btnCss,background:"#2d6a4f",borderColor:"#40916c",color:"#fff",fontWeight:600},sepCss={width:1,height:20,background:"rgba(255,255,255,0.1)",margin:"0 2px"};let _datasetInfoListenerSet=!1;function setupDatasetInfoListener(){_datasetInfoListenerSet||(_datasetInfoListenerSet=!0,onEvent("dataset_info",d=>{var t,i,n;if(d&&d.fields){const s=d.dataset_name||"";_currentDatasetName&&s&&s!==_currentDatasetName&&(console.log(`[FiftyComfy] Dataset changed: ${_currentDatasetName} -> ${s}, clearing canvas`),_graph&&_graph.clear()),_currentDatasetName=s,setDatasetInfo(d),_graph&&updateAllComboWidgets(_graph),console.log("[FiftyComfy] Dataset info received:",s+",",(t=d.fields)==null?void 0:t.length,"fields,",(i=d.label_fields)==null?void 0:i.length,"label fields,",(n=d.patches_fields)==null?void 0:n.length,"patches fields,",Object.keys(d.label_classes||{}).length,"label class fields")}}))}function fetchDatasetInfo(){setupDatasetInfoListener(),operators.executeOperator(`${NS$1}/get_dataset_info`,{}).catch(d=>{console.warn("[FiftyComfy] Could not fetch dataset info:",d)})}function FiftyComfyView(){const d=React.useRef(null),t=React.useRef(null),[i,n]=React.useState("Ready"),[s,o]=React.useState(!1),[r,a]=React.useState(!1),[l,u]=React.useState([]);React.useEffect(()=>{const _=d.current,y=t.current;if(!_||!y)return;if(!_cssInjected){const w=document.createElement("style");w.id="fiftycomfy-lg-css",w.textContent=litegraphCss,document.head.appendChild(w),_cssInjected=!0}if(_initialized||(registerAllNodes(),LiteGraph.allow_edit_node_title=!1,LiteGraph.NODE_TEXT_COLOR="#FFFFFF",LiteGraph.NODE_TITLE_COLOR="#FFFFFF",LiteGraph.WIDGET_TEXT_COLOR="#FFFFFF",LiteGraph.DEFAULT_LINK_COLOR="#99ccff",LiteGraph.LINK_COLOR="#99ccff",LiteGraph.EVENT_LINK_COLOR="#ff9966",LiteGraph.registered_link_types=LiteGraph.registered_link_types||{},LiteGraph.registered_link_types.FO_VIEW={color:"#4FC3F7"},_initialized=!0),_graph||(_graph=new LGraph,hookNodeAdded(_graph)),_lgCanvas){try{_lgCanvas.setGraph(null)}catch{}_lgCanvas=null}_lgCanvas=new LGraphCanvas(_,_graph),_lgCanvas.render_shadows=!1,_lgCanvas.max_zoom=4,_lgCanvas.min_zoom=.1,_lgCanvas.allow_searchbox=!0,_lgCanvas.show_searchbox_on_double_click=!0,_lgCanvas.render_curved_connections=!0,_lgCanvas.render_connection_arrows=!1,_lgCanvas.connections_width=3,_lgCanvas.default_connection_color={input_off:"#888",input_on:"#4FC3F7",output_off:"#888",output_on:"#4FC3F7"},_lgCanvas.autoresize=!0,_graph.start(),fetchDatasetInfo();const b=()=>{if(!y||!_||!_lgCanvas)return;const w=y.offsetWidth||y.clientWidth,T=y.offsetHeight||y.clientHeight;if(w===0||T===0)return;_.width=w,_.height=T;const I=_lgCanvas.bgcanvas;I&&(I.width=w,I.height=T),_lgCanvas.setDirty(!0,!0)};b(),requestAnimationFrame(b),setTimeout(b,100);const k=new ResizeObserver(b);return k.observe(y),()=>{k.disconnect()}},[]);const c=React.useCallback(async()=>{if(_graph){for(const _ of _graph._nodes||[])_.boxcolor=null,_.setDirtyCanvas(!0,!0);o(!0),n("Running...");try{await operators.executeOperator(`${NS$1}/execute_graph`,{graph_json:JSON.stringify(_graph.serialize())})}catch(_){console.error("[FiftyComfy] Execution error:",_)}o(!1),n("Done")}},[]),p=React.useCallback(()=>{if(!_graph)return;const _=prompt("Workflow name:");_&&(saveWorkflow(_,_graph.serialize()),n("Saved: "+_))},[]),f=React.useCallback(()=>{u(listWorkflowNames()),a(!0)},[]),g=React.useCallback(_=>{if(!_graph)return;const y=loadWorkflow(_);y&&(_graph.configure(y),updateAllComboWidgets(_graph),n("Loaded: "+_)),a(!1)},[]),m=React.useCallback(()=>{_graph&&_graph.clear(),n("Ready")},[]);return React__namespace.createElement("div",{ref:t,style:{width:"100%",height:"100%",position:"relative",overflow:"hidden"}},React__namespace.createElement("canvas",{ref:d,style:{position:"absolute",top:0,left:0}}),React__namespace.createElement("div",{style:toolbarCss},React__namespace.createElement("button",{style:btnRunCss,onClick:c,disabled:s},s?"Running...":"â–¶ Run Workflow"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:p},"Save"),React__namespace.createElement("button",{style:btnCss,onClick:f},"Load"),React__namespace.createElement("div",{style:sepCss}),React__namespace.createElement("button",{style:btnCss,onClick:m},"Clear"),React__namespace.createElement("span",{style:{marginLeft:"auto",fontSize:11,color:"rgba(255,255,255,0.4)"}},i)),r&&React__namespace.createElement("div",{style:{position:"absolute",top:TH+4,left:100,zIndex:20,background:"#2a2a2a",border:"1px solid #555",borderRadius:6,padding:8,minWidth:220,maxHeight:300,overflowY:"auto",boxShadow:"0 4px 16px rgba(0,0,0,0.5)"}},React__namespace.createElement("div",{style:{fontSize:11,color:"#888",marginBottom:6,display:"flex",justifyContent:"space-between"}},React__namespace.createElement("span",null,"Saved Workflows"),React__namespace.createElement("span",{style:{cursor:"pointer",color:"#aaa"},onClick:()=>a(!1)},"âœ•")),l.length===0?React__namespace.createElement("div",{style:{fontSize:12,color:"#666",padding:8}},"No saved workflows"):l.map(_=>React__namespace.createElement("div",{key:_,onClick:()=>g(_),style:{padding:"5px 8px",cursor:"pointer",borderRadius:4,fontSize:12,color:"#ddd"},onMouseOver:y=>{y.currentTarget.style.background="#3a3a3a"},onMouseOut:y=>{y.currentTarget.style.background="transparent"}},_))))}plugins.registerComponent({name:"FiftyComfyView",component:FiftyComfyView,type:plugins.PluginComponentType.Component,activator:()=>!0});const NS="@harpreetsahota/FiftyComfy";operators.registerOperator(NodeStatusUpdateOperator,NS),operators.registerOperator(ExecutionCompleteOperator,NS),operators.registerOperator(DatasetInfoLoadedOperator,NS),console.log("[FiftyComfy] Component (type=3) and operators registered")});
//# sourceMappingURL=index.umd.js.map
